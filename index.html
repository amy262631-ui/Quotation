<!DOCTYPE html>
<html lang="zh-TW">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰</title>

Â  Â  <script src="https://cdn.tailwindcss.com"></script>

Â  Â  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
Â  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

Â  Â  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

Â  Â  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

Â  Â  <style>
Â  Â  body {
Â  Â  Â  background: #f3f4f6;
Â  Â  Â  font-family: "Microsoft JhengHei", sans-serif;
Â  Â  }
Â  </style>

Â  Â  <style>
Â  Â  @media print {

Â  Â  Â  /* éš±è—éåˆ—å°å…ƒç´  */
Â  Â  Â  .no-print {
Â  Â  Â  Â  display: none !important;
Â  Â  Â  }

Â  Â  Â  /* åˆ—å°å®¹å™¨ï¼šç¢ºä¿å…§å®¹æ­£ç¢ºå‘ˆç¾ */
Â  Â  Â  body, html {
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  padding: 0;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  #root {
Â  Â  Â  Â  display: none; /* éš±è—ä¸»ç·¨è¼¯å€ */
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  #printArea {
Â  Â  Â  Â  display: block !important;
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  padding: 12mm;
Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  color: black;
Â  Â  Â  }

Â  Â  Â  /* è¡¨æ ¼æ¨£å¼ */
Â  Â  Â  table {
Â  Â  Â  Â  border-collapse: collapse;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  }

Â  Â  Â  th, td {
Â  Â  Â  Â  border: 1px solid black;
Â  Â  Â  Â  padding: 4px 6px;
Â  Â  Â  Â  vertical-align: top;
Â  Â  Â  }

Â  Â  Â  thead {
Â  Â  Â  Â  display: table-header-group; /* ç¢ºä¿è¡¨é ­åœ¨æ¯é é‡è¤‡ */
Â  Â  Â  }

Â  Â  Â  tfoot {
Â  Â  Â  Â  display: table-footer-group; /* ç¢ºä¿è¡¨å°¾åœ¨æ¯é é‡è¤‡ */
Â  Â  Â  }

Â  Â  Â  tr {
Â  Â  Â  Â  page-break-inside: avoid; /* é˜²æ­¢è¡Œè¢«æˆªæ–· */
Â  Â  Â  }

Â  Â  Â  /* å…¬å¸å°ç«  - æ¨¡æ“¬å°ç« ä½ç½® */
Â  Â  Â  .print-stamp {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: 100px;
Â  Â  Â  Â  right: 50px;
Â  Â  Â  Â  max-width: 120px;
Â  Â  Â  Â  opacity: 0.7;
Â  Â  Â  }

Â  Â  Â  /* åœ–ç‰‡åˆ—å°æ¨£å¼ */
Â  Â  Â  .print-image {
Â  Â  Â  Â  max-width: 300px; /* é™åˆ¶åˆ—å°åœ–ç‰‡å¤§å° */
Â  Â  Â  Â  height: auto;
Â  Â  Â  }

Â  Â  Â  /* é ç¢¼ (é€™è£¡éœ€JSè¼”åŠ©æˆ–ä½¿ç”¨CSSè¨ˆæ•¸å™¨ï¼Œç‚ºç°¡åŒ–ä¸å¯¦ç¾JSé ç¢¼) */
Â  Â  Â  /* #print-page-number {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  bottom: 8mm;
Â  Â  Â  Â  right: 12mm;
Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  } */
Â  Â  }
Â  </style>
</head>

<body class="text-gray-900">

Â  Â  <div id="root"></div>

Â  Â  <div id="printArea" class="hidden">
Â  Â  Â  <div id="print-page-number"></div>
Â  </div>

<script type="text/babel">
/****************************************************
Â * P1 â€” å…¬å¸è³‡æ–™ / ä»˜æ¬¾æ¢ä»¶ / å‚™è¨» / æ¨¡å¼æ¨¡æ¿
Â ****************************************************/
// è¨»ï¼šåœ–ç‰‡è·¯å¾‘ (`stamp`) åœ¨å–®ä¸€ HTML æª”æ¡ˆä¸­å¯èƒ½éœ€è¦ä½¿ç”¨ Data URL æˆ– Base64 ç·¨ç¢¼ï¼Œ
// é€™è£¡æš«æ™‚ä½¿ç”¨ç›¸å°è·¯å¾‘/ä½”ä½ç¬¦ã€‚
const COMPANY_DATA = {
Â  herhsin: {
Â  Â  name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
Â  Â  tel: "07-6517476",
Â  Â  fax: "07-6517994",
Â  Â  email: "admin@herhsin.com",
Â  Â  address: "831é«˜é›„å¸‚å¤§å¯®å€é³³æ—ä¸‰è·¯383-3è™Ÿ",
Â  Â  stamp: "herhsin_stamp_placeholder.png" // ä½”ä½ç¬¦
Â  },
Â  sinchang: {
Â  Â  name: "è–ªæ˜Œæœ‰é™å…¬å¸",
Â  Â  tel: "07-6521927",
Â  Â  fax: "07-6517994",
Â  Â  email: "affairs@herhsin.com",
Â  Â  address: "831é«˜é›„å¸‚å¤§å¯®å€é³³æ—ä¸‰è·¯383-3è™Ÿ",
Â  Â  stamp: "sinchang_stamp_placeholder.png" // ä½”ä½ç¬¦
Â  }
};

// é è¨­å‚™è¨»
const DEFAULT_NOTES = `
1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚
`;

// é è¨­ä»˜æ¬¾æ¢ä»¶
const DEFAULT_PAYMENT = `
è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%
`;

// å ±åƒ¹æ¨¡å¼æ¨¡æ¿
const QUOTE_MODES = [
Â  {
Â  Â  id: "modeA",
Â  Â  name: "æ‹Œåˆæ©Ÿæ¼æ¼¿æ›´æ›",
Â  Â  description: "é©ç”¨æ‹Œåˆæ©Ÿç¶­ä¿®ã€æ¼æ¼¿è™•ç†ç­‰ã€‚",
Â  Â  defaultItems: [],
Â  Â  defaultNotes: DEFAULT_NOTES,
Â  Â  defaultPayment: DEFAULT_PAYMENT
Â  },
Â  {
Â  Â  id: "modeB",
Â  Â  name: "è¨­å‚™éŠ·å”®",
Â  Â  description: "é©ç”¨å‚™å“ã€å–®æ©ŸéŠ·å”®èˆ‡å®‰è£ã€‚",
Â  Â  defaultItems: [],
Â  Â  defaultNotes: DEFAULT_NOTES,
Â  Â  defaultPayment: DEFAULT_PAYMENT
Â  },
Â  {
Â  Â  id: "modeC",
Â  Â  name: "è¨­å‚™æ›´æ›å·¥ç¨‹",
Â  Â  description: "é©ç”¨æ•´æ©Ÿæ›´æ–°ã€æ–™ä»¶æ›´æ›å·¥ç¨‹ã€‚",
Â  Â  defaultItems: [],
Â  Â  defaultNotes: DEFAULT_NOTES,
Â  Â  defaultPayment: DEFAULT_PAYMENT
Â  }
];

/****************************************************
Â * P2 â€” å·¥å…·å‡½å¼ï¼ˆå®Œæ•´ï¼‰
Â ****************************************************/
function uuid() {
Â  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
Â  Â  const r = (Math.random() * 16) | 0;
Â  Â  const v = c === "x" ? r : (r & 0x3) | 0x8;
Â  Â  return v.toString(16);
Â  });
}

function formatDate(dateStr = new Date()) {
Â  const d = dateStr instanceof Date ? dateStr : new Date(dateStr);
Â  const y = d.getFullYear();
Â  const m = String(d.getMonth() + 1).padStart(2, "0");
Â  const day = String(d.getDate()).padStart(2, "0");
Â  return `${y}-${m}-${day}`; // æ”¹ç‚º ISO æ ¼å¼ä»¥åˆ© input type="date"
}

function formatMoney(num) {
Â  // è™•ç†ç©ºå€¼å’Œéæ•¸å­—ï¼Œä½†å…è¨±æ•¸å­— 0
Â  if (num === "" || num === null || num === undefined || isNaN(Number(num))) return "";
Â  return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 });
}

function calcAmount(item) {
Â  // ç¢ºä¿ qty å’Œ price è½‰ç‚ºæ•¸å­—ï¼Œå¦å‰‡ç‚º 0
Â  const qty = Number(item.qty || 0);
Â  const price = Number(item.price || 0);
Â  return qty * price;
}

function calcTotal(items) {
Â  return items.reduce((sum, it) => {
Â  Â  let mainAmt = calcAmount(it);
Â  Â  let subs = 0;

Â  Â  if (it.subItems && it.subItems.length > 0) {
Â  Â  Â  subs = it.subItems.reduce((s, sub) => s + calcAmount(sub), 0);
Â  Â  }

Â  Â  return sum + mainAmt + subs;
Â  }, 0);
}

function calcNegotiated(total, discountPercent, customPrice) {
Â  const cp = Number(customPrice || 0);
Â  const dp = Number(discountPercent || 0);
Â  
Â  if (cp > 0) return cp;
Â  
Â  if (dp > 0 && dp < 100) {
Â  Â  return Math.round(total * (1 - dp / 100));
Â  }
Â  return total;
}

// å ±åƒ¹å–®ç·¨è™Ÿ
function generateQuoteNo() {
Â  // ä½¿ç”¨ YYYYMMDDHHMM + 4ä½äº‚æ•¸
Â  const d = new Date();
Â  const parts = [
Â  Â  d.getFullYear(),
Â  Â  String(d.getMonth() + 1).padStart(2, "0"),
Â  Â  String(d.getDate()).padStart(2, "0"),
Â  Â  String(d.getHours()).padStart(2, "0"),
Â  Â  String(d.getMinutes()).padStart(2, "0"),
Â  ].join('');
Â  
Â  const random = Math.floor(1000 + Math.random() * 9000);
Â  
Â  return `Q${parts}-${random}`;
}

// è¼‰å…¥ Google Sheet CSV (éåŒæ­¥å‡½å¼)
async function loadCSV(url) {
Â  try {
Â  Â  const res = await fetch(url);
Â  Â  const text = await res.text();
Â  Â  // é€™è£¡éœ€è¦ä¸€å€‹æ›´å¼·å¥çš„ CSV è§£æå™¨ï¼Œä½†ç‚ºäº†ä¿æŒå–®ä¸€æª”æ¡ˆæ¶æ§‹ï¼Œæš«æ™‚ç°¡åŒ–
Â  Â  const rows = text.split("\n").map(r => r.trim()).filter(r => r.length > 0);
Â  Â  if (rows.length === 0) return [];
Â  Â  
Â  Â  // å‡è¨­ç¬¬ä¸€è¡Œç‚ºæ¨™é ­ï¼Œä¸”ä¸åŒ…å«é€—è™Ÿ
Â  Â  const header = rows[0].split(",");

Â  Â  return rows.slice(1).map(row => {
Â  Â  Â  // ç°¡æ˜“è§£æï¼Œå¯èƒ½æœƒåœ¨æ¬„ä½ä¸­æœ‰é€—è™Ÿæ™‚å‡ºéŒ¯
Â  Â  Â  const cols = row.split(",");
Â  Â  Â  const obj = {};

Â  Â  Â  header.forEach((h, i) => {
Â  Â  Â  Â  // ä¿®å‰ªæ¨™é ­å’Œå…§å®¹
Â  Â  Â  Â  obj[h.trim()] = cols[i] ? cols[i].trim() : "";
Â  Â  Â  });
Â  Â  Â  return obj;
Â  Â  });
Â  } catch (error) {
Â  Â  console.error("è¼‰å…¥æˆ–è§£æ Google Sheet CSV å¤±æ•—:", error);
Â  Â  return [];
Â  }
}


/****************************************************
Â * P3 â€” AppContextï¼ˆæ ¸å¿ƒè³‡æ–™ä¸­å¿ƒï¼‰
Â ****************************************************/
const AppContext = React.createContext();

function AppProvider({ children }) {
Â  // å…¬å¸ herhsin / sinchang
Â  const [company, setCompany] = React.useState("herhsin");

Â  // å ±åƒ¹å–®åˆ—è¡¨
Â  const [quotes, setQuotes] = React.useState([]);

Â  // æ­£åœ¨ç·¨è¼¯çš„å ±åƒ¹å–® ID
Â  const [activeQuoteId, setActiveQuoteId] = React.useState(null);

Â  // è¦æ ¼å“ï¼ˆä¾†è‡ª Google Sheetï¼‰
Â  const [specItems, setSpecItems] = React.useState([]);

Â  // Google Sheet è·¯å¾‘ (è«‹ç¢ºä¿é€™æ˜¯å…¬é–‹çš„ CSV é€£çµ)
Â  const SPEC_CSV_URL =
Â  Â  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv";

Â  /************* åˆå§‹åŒ–ï¼šå¾ localStorage è¼‰å…¥ *************/
Â  React.useEffect(() => {
Â  Â  const saved = localStorage.getItem("HERHSIN_QUOTES");

Â  Â  if (saved) {
Â  Â  Â  try {
Â  Â  Â  Â  const parsed = JSON.parse(saved);
Â  Â  Â  Â  // ç¢ºä¿è¼‰å…¥çš„æ˜¯é™£åˆ—
Â  Â  Â  Â  if (Array.isArray(parsed)) {
Â  Â  Â  Â  Â  setQuotes(parsed);
Â  Â  Â  Â  Â  if (parsed.length > 0) setActiveQuoteId(parsed[0].id);
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("è§£æ localStorage æ•¸æ“šå¤±æ•—:", e);
Â  Â  Â  Â  setQuotes([]);
Â  Â  Â  Â  setActiveQuoteId(null);
Â  Â  Â  }
Â  Â  }
Â  }, []);

Â  /************* è‡ªå‹•å­˜å› localStorage *************/
Â  React.useEffect(() => {
Â  Â  try {
Â  Â  Â  localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
Â  Â  } catch (e) {
Â  Â  Â  console.error("å¯«å…¥ localStorage å¤±æ•—:", e);
Â  Â  }
Â  }, [quotes]);


Â  /************* è¼‰å…¥ Google Sheet è¦æ ¼å“ *************/
Â  React.useEffect(() => {
Â  Â  // ç”±æ–¼ CDN ç’°å¢ƒä¸‹ä¸æ‡‰éåº¦ä¾è³´éåŒæ­¥å¤–éƒ¨è³‡æºï¼Œåƒ…åšä¸€æ¬¡è¼‰å…¥å˜—è©¦
Â  Â  loadCSV(SPEC_CSV_URL).then(data => setSpecItems(data));
Â  }, []);


Â  /****************************************************
Â  Â * å»ºç«‹æ–°å ±åƒ¹å–®ï¼ˆå¯å¥—ç”¨æ¨¡å¼ï¼‰
Â  Â ****************************************************/
Â  const createQuote = React.useCallback((modeId = null) => {
Â  Â  const mode = QUOTE_MODES.find(m => m.id === modeId);

Â  Â  const newQuote = {
Â  Â  Â  id: uuid(),
Â  Â  Â  quoteNo: generateQuoteNo(),
Â  Â  Â  title: mode ? mode.name : "æœªå‘½åå·¥ç¨‹",
Â  Â  Â  customerName: "",
Â  Â  Â  contact: "",
Â  Â  Â  phone: "",
Â  Â  Â  location: "",
Â  Â  Â  date: formatDate(), // ä½¿ç”¨ä¿®æ­£å¾Œçš„æ ¼å¼åŒ–å‡½æ•¸
Â  Â  Â  items: mode && Array.isArray(mode.defaultItems) ? mode.defaultItems.map(item => ({...item, id: uuid(), subItems: []})) : [],
Â  Â  Â  notes: mode ? mode.defaultNotes : DEFAULT_NOTES,
Â  Â  Â  payment: mode ? mode.defaultPayment : DEFAULT_PAYMENT,
Â  Â  Â  discountPercent: 0,
Â  Â  Â  negotiatedPrice: 0
Â  Â  };

Â  Â  setQuotes(prev => {
Â  Â  Â  const newList = [newQuote, ...prev]; // æ–°å ±åƒ¹å–®æ”¾åœ¨æœ€å‰é¢
Â  Â  Â  setActiveQuoteId(newQuote.id);
Â  Â  Â  return newList;
Â  Â  });
Â  }, []);


Â  /****************************************************
Â  Â * åˆªé™¤å ±åƒ¹å–®
Â  Â ****************************************************/
Â  const deleteQuote = React.useCallback((id) => {
Â  Â  setQuotes(prev => {
Â  Â  Â  const newList = prev.filter(q => q.id !== id);
Â  Â  Â  
Â  Â  Â  if (id === activeQuoteId) {
Â  Â  Â  Â  setActiveQuoteId(newList.length > 0 ? newList[0].id : null);
Â  Â  Â  }
Â  Â  Â  return newList;
Â  Â  });
Â  }, [activeQuoteId]);


Â  /****************************************************
Â  Â * æ›´æ–°å ±åƒ¹å–®æ¬„ä½
Â  Â ****************************************************/
Â  const updateQuote = React.useCallback((id, data) => {
Â  Â  setQuotes(prev =>
Â  Â  Â  prev.map(q => (q.id === id ? { ...q, ...data } : q))
Â  Â  );
Â  }, []);


Â  /****************************************************
Â  Â * å¥—ç”¨æ¨¡å¼ï¼ˆè¦†è“‹ï¼šæ¨™é¡Œã€å‚™è¨»ã€ä»˜æ¬¾ã€é è¨­é …ç›®ï¼‰
Â  Â ****************************************************/
Â  const applyMode = React.useCallback((modeId) => {
Â  Â  const mode = QUOTE_MODES.find(m => m.id === modeId);
Â  Â  if (!mode || !activeQuoteId) return;

Â  Â  // ç¢ºä¿ defaultItems ä¸­çš„æ¯å€‹ item éƒ½æœ‰å”¯ä¸€çš„ id
Â  Â  const itemsWithIds = mode.defaultItems.map(item => ({...item, id: uuid(), subItems: []}));

Â  Â  updateQuote(activeQuoteId, {
Â  Â  Â  title: mode.name,
Â  Â  Â  items: itemsWithIds, // ä½¿ç”¨å¸¶æœ‰ ID çš„é …ç›®
Â  Â  Â  notes: mode.defaultNotes,
Â  Â  Â  payment: mode.defaultPayment,
Â  Â  });
Â  }, [activeQuoteId, updateQuote]);


Â  /****************************************************
Â  Â * Context æä¾›çµ¦å…¨ App
Â  Â ****************************************************/
Â  const activeQuote = quotes.find(q => q.id === activeQuoteId);
Â  
Â  const value = {
Â  Â  company,
Â  Â  setCompany,

Â  Â  quotes,
Â  Â  createQuote,
Â  Â  deleteQuote,
Â  Â  updateQuote,
Â  Â  activeQuote, // ç›´æ¥æä¾›ç•¶å‰å ±åƒ¹å–®ç‰©ä»¶
Â  Â  activeQuoteId,
Â  Â  setActiveQuoteId,

Â  Â  specItems,
Â  Â  applyMode
Â  };

Â  // è®“åˆ—å°å’Œ Excel åŒ¯å‡ºåŠŸèƒ½å¯ä»¥å…¨åŸŸæŠ“åˆ° Context
Â  window.__APP_CONTEXT__ = value;

Â  return (
Â  Â  <AppContext.Provider value={value}>
Â  Â  Â  {children}
Â  Â  </AppContext.Provider>
Â  );
}
/****************************************************
Â * P4-1 â€” å·¦å´å…ƒä»¶ï¼šå…¬å¸åˆ‡æ› / æ¨¡å¼é¸æ“‡ / å ±åƒ¹å–®åˆ—è¡¨
Â ****************************************************/


/* --------------------------------------------------
Â  Â å…¬å¸åˆ‡æ›ï¼ˆä½•é‘« / è–ªæ˜Œï¼‰
Â  Â -------------------------------------------------- */
function CompanySelector() {
Â  const { company, setCompany } = React.useContext(AppContext);

Â  return (
Â  Â  <div className="mb-6 no-print">
Â  Â  Â  <div className="font-bold mb-2">é¸æ“‡å…¬å¸</div>

Â  Â  Â  <div className="flex gap-2">
Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  className={`px-3 py-1 rounded ${
Â  Â  Â  Â  Â  Â  company === "herhsin"
Â  Â  Â  Â  Â  Â  Â  ? "bg-blue-600 text-white"
Â  Â  Â  Â  Â  Â  Â  : "bg-gray-300 hover:bg-gray-400"
Â  Â  Â  Â  Â  }`}
Â  Â  Â  Â  Â  onClick={() => setCompany("herhsin")}
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  ä½•é‘«å¯¦æ¥­
Â  Â  Â  Â  </button>

Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  className={`px-3 py-1 rounded ${
Â  Â  Â  Â  Â  Â  company === "sinchang"
Â  Â  Â  Â  Â  Â  Â  ? "bg-blue-600 text-white"
Â  Â  Â  Â  Â  Â  Â  : "bg-gray-300 hover:bg-gray-400"
Â  Â  Â  Â  Â  }`}
Â  Â  Â  Â  Â  onClick={() => setCompany("sinchang")}
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  è–ªæ˜Œæœ‰é™å…¬å¸
Â  Â  Â  Â  </button>
Â  Â  Â  </div>
Â  Â  </div>
Â  );
}


/* --------------------------------------------------
Â  Â å ±åƒ¹æ¨¡å¼é¸æ“‡å™¨ï¼ˆA ç¶­ä¿®ã€B æ¶ä¿®ã€C æ‹Œåˆæ©Ÿæ¼æ¼¿â€¦ï¼‰
Â  Â -------------------------------------------------- */
function ModeSelector() {
Â  const { createQuote } = React.useContext(AppContext);

Â  return (
Â  Â  <div className="mb-6 no-print">
Â  Â  Â  <div className="font-bold mb-2">å»ºç«‹å ±åƒ¹å–®ï¼ˆå¥—ç”¨æ¨¡å¼ï¼‰</div>

Â  Â  Â  <div className="flex flex-col gap-2">

Â  Â  Â  Â  {QUOTE_MODES.map(mode => (
Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  key={mode.id}
Â  Â  Â  Â  Â  Â  className="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-left"
Â  Â  Â  Â  Â  Â  onClick={() => createQuote(mode.id)}
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  â¤ {mode.name}
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  ))}

Â  Â  Â  Â  {/* ç„¡æ¨¡å¼ï¼šç©ºç™½å ±åƒ¹å–® */}
Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  className="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700"
Â  Â  Â  Â  Â  onClick={() => createQuote(null)}
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  ï¼‹ ç©ºç™½å ±åƒ¹å–®
Â  Â  Â  Â  </button>
Â  Â  Â  </div>
Â  Â  </div>
Â  );
}


/* --------------------------------------------------
Â  Â å ±åƒ¹å–®ç®¡ç†ï¼šåˆ—è¡¨ã€åˆ‡æ›ã€åˆªé™¤ (ä¿®æ­£ç‰ˆ)
Â  Â -------------------------------------------------- */
function QuoteManager() {
Â  const {
Â  Â  quotes,
Â  Â  activeQuoteId,
Â  Â  setActiveQuoteId,
Â  Â  deleteQuote,
    company, // ç‚ºäº† P3-1 çš„ä¸€è‡´æ€§ï¼ŒåŠ å…¥ company 
    addQuote // ç‚ºäº† P3-1 çš„ä¸€è‡´æ€§ï¼ŒåŠ å…¥ addQuote
Â  } = React.useContext(AppContext);

  // æ ¹æ“š ID æ’åºï¼Œè®“æœ€æ–°çš„æ’åœ¨æœ€ä¸Šé¢
  const sortedQuotes = React.useMemo(() => {
    // ç¢ºä¿ quotes æ˜¯é™£åˆ—ä¸”åŒ…å«æœ‰æ•ˆçš„ id
    return [...(quotes || [])].sort((a, b) => {
      if (!a.id || !b.id) return 0;
      return b.id.localeCompare(a.id);
    });
  }, [quotes]);


Â  return (
Â  Â  <div className="mt-4 border-t pt-4"> {/* å°‡ mb-8 no-print æ›¿æ›ç‚º mt-4 border-t pt-4 ä¿æŒèˆ‡ P3-1 ä¿®æ­£ç‰ˆä¸€è‡´ */}
Â  Â  Â  <h3 className="font-bold text-lg mb-2 text-gray-700">å ±åƒ¹å–®åˆ—è¡¨</h3>

      {/* æ–°å¢å ±åƒ¹å–®æŒ‰éˆ• (æ ¹æ“šæ¨™æº– P3-1 åŠ å…¥) */}
      <button
        className="w-full px-3 py-2 bg-purple-600 text-white rounded mb-4 hover:bg-purple-700 transition"
        onClick={() => addQuote(company)}
      >
        ï¼‹ å»ºç«‹æ–°å ±åƒ¹å–®
      </button>

      <div className="max-h-80 overflow-y-auto">
Â  Â  Â  {sortedQuotes.length === 0 && ( // ä½¿ç”¨ sortedQuotes
Â  Â  Â  Â  <div className="text-gray-500 text-sm text-center">
Â  Â  Â  Â  Â  å°šç„¡è³‡æ–™ï¼Œè«‹å…ˆå»ºç«‹å ±åƒ¹å–®
Â  Â  Â  Â  </div>
Â  Â  Â  )}

Â  Â  Â  <div className="flex flex-col gap-1">
Â  Â  Â  Â  {sortedQuotes.map(q => ( // ä½¿ç”¨ sortedQuotes
Â  Â  Â  Â  Â  <div
Â  Â  Â  Â  Â  Â  key={q.id}
Â  Â  Â  Â  Â  Â  className={`flex items-center justify-between px-3 py-2 rounded cursor-pointer transition
Â  Â  Â  Â  Â  Â  Â  ${
Â  Â  Â  Â  Â  Â  Â  Â  q.id === activeQuoteId
Â  Â  Â  Â  Â  Â  Â  Â  Â  ? "bg-blue-600 text-white shadow-md" // ä¿æŒèˆ‡ P3-2 ä¿®æ­£ç‰ˆä¸€è‡´çš„æ¨£å¼
Â  Â  Â  Â  Â  Â  Â  Â  Â  : "bg-gray-100 hover:bg-gray-200 text-gray-800"
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  `}
Â  Â  Â  Â  Â  Â  onClick={() => setActiveQuoteId(q.id)}
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  {/* æ–‡å­—å€å¡Šï¼šåŠ å…¥ min-w-0 å…è¨±å£“ç¸®/æˆªæ–· */}
Â  Â  Â  Â  Â  Â  <div className="flex flex-col flex-1 min-w-0 mr-2"> 
Â  Â  Â  Â  Â  Â  Â  {/* æ¨™é¡Œï¼šç¢ºä¿æˆªæ–· */}
Â  Â  Â  Â  Â  Â  Â  <span className="font-semibold truncate text-sm">{q.title}</span>
Â  Â  Â  Â  Â  Â  Â  {/* è³‡è¨Šï¼šè¼ƒå°çš„å­—é«”ï¼Œå…è¨±æ›è¡Œ */}
Â  Â  Â  Â  Â  Â  Â  <span className="text-xs opacity-80 whitespace-normal">
Â  Â  Â  Â  Â  Â  Â  Â  {q.date} - {q.customerName || "ç„¡å®¢æˆ¶"}
Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  {/* æŒ‰éˆ•å€å¡Šï¼šåŠ å…¥ flex-shrink-0 ç¢ºä¿å¯¬åº¦å›ºå®šï¼Œä¸æ“ å£“æ–‡å­— */}
Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  className={`text-red-600 text-xs ml-2 p-1 font-bold transition flex-shrink-0 
              ${q.id === activeQuoteId ? "bg-red-500 hover:bg-red-600 text-white" : "hover:text-red-800"}
              `}
Â  Â  Â  Â  Â  Â  Â  onClick={(e) => {
Â  Â  Â  Â  Â  Â  Â  Â  e.stopPropagation(); // é¿å…é»åˆ°çˆ¶å±¤
Â  Â  Â  Â  Â  Â  Â  Â  if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ä»½å ±åƒ¹å–®ï¼Ÿ")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteQuote(q.id);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  åˆªé™¤
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  ))}
Â  Â  Â  </div>
      </div>
Â  Â  </div>
Â  );
}
/****************************************************
Â * P4-2 â€” å ±åƒ¹å–®æŠ¬é ­ï¼šå…¬å¸è³‡è¨Š + å®¢æˆ¶è³‡è¨Šè¼¸å…¥å€
Â ****************************************************/

function QuoteEditor() {
  const {
    company,
    activeQuote, // ç›´æ¥å–ç”¨ activeQuote
    updateQuote
  } = React.useContext(AppContext);

  const quote = activeQuote;

  /* -------------------------------
   * æ›´æ–°æ¬„ä½ (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
   * ------------------------------- */
  const update = React.useCallback((field, value) => {
    // ç¢ºä¿ quote å­˜åœ¨å†å‘¼å« updateQuote
    if (quote) {
      updateQuote(quote.id, { [field]: value });
    }
  }, [quote, updateQuote]); // ä¾è³´é …æ”¹ç‚º quote ç‰©ä»¶

  // å¦‚æœ quote ä¸å­˜åœ¨ï¼Œææ—©è¿”å› (æ”¾åœ¨æ‰€æœ‰ Hooks ä¹‹å¾Œ)
  if (!quote) return null;

  // å¼•ç”¨ P1 çš„å…¨å±€æ•¸æ“š
  const info = COMPANY_DATA[company];

  return (
    <div className="bg-white p-6 shadow rounded mb-6 no-print">

      {/* ---------------- å…¬å¸åç¨± ---------------- */}
      <div className="text-2xl font-bold mb-4 text-blue-800">
        {info.name}
      </div>

      {/* ---------------- å…¬å¸è³‡æ–™ ---------------- */}
      <div className="text-sm text-gray-600 mb-6 border-b pb-4">
        <div>åœ°å€ï¼š{info.address}</div>
        <div>é›»è©±ï¼š{info.tel} | å‚³çœŸï¼š{info.fax}</div>
      </div>

      {/* ---------------- å ±åƒ¹å–®æ¨™é¡Œ & ç·¨è™Ÿ ---------------- */}
      <div className="flex items-end gap-4 mb-6">
        <div className="flex-1">
          <label className="block text-sm text-gray-600 mb-1">å·¥ç¨‹åç¨±</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            value={quote.title || ""}
            onChange={(e) => update("title", e.target.value)}
          />
        </div>

        <div className="w-48">
          <label className="block text-sm text-gray-600 mb-1">å ±åƒ¹å–®ç·¨è™Ÿ</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 bg-gray-100"
            value={quote.quoteNo || ""}
            readOnly
          />
        </div>
      </div>

      {/* ---------------- å®¢æˆ¶è³‡è¨Š ---------------- */}
      <div className="grid grid-cols-2 gap-4 mb-6">

        <div>
          <label className="block text-sm text-gray-600 mb-1">å®¢æˆ¶åç¨±</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            value={quote.customerName || ""}
            onChange={(e) => update("customerName", e.target.value)}
          />
        </div>

        <div>
          <label className="block text-sm text-gray-600 mb-1">è¯çµ¡äºº</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            value={quote.contact || ""}
            onChange={(e) => update("contact", e.target.value)}
          />
        </div>

        <div>
          <label className="block text-sm text-gray-600 mb-1">é›»è©±</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            value={quote.phone || ""}
            onChange={(e) => update("phone", e.target.value)}
          />
        </div>

        <div>
          <label className="block text-sm text-gray-600 mb-1">å ±åƒ¹æ—¥æœŸ</label>
          <input
            type="date"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            // date æ¬„ä½ä½¿ç”¨ yyyy-mm-dd æ ¼å¼
            value={quote.date || formatDate()}
            onChange={(e) => update("date", e.target.value)}
          />
        </div>

        <div className="col-span-2">
          <label className="block text-sm text-gray-600 mb-1">å·¥ç¨‹åœ°é»</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            value={quote.location || ""}
            onChange={(e) => update("location", e.target.value)}
          />
        </div>
      </div>

    </div>
  );
}

/****************************************************
 * P4-3ï¼ˆAï¼‰NoteSubItemBlock â€” æ–‡å­—è£œå……å°é …
 ****************************************************/
function NoteSubItemBlock({ sub, updateField, deleteSubItem }) {
  return (
    <div className="border rounded p-3 bg-gray-50 mb-2">

      {/* æ¨™é¡Œ + åˆªé™¤ */}
      <div className="flex justify-between items-center mb-2">
        <span className="text-sm font-bold text-gray-700">ğŸ“„ è£œå……æ–‡å­—</span>
        <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>
          åˆªé™¤
        </button>
      </div>

      <textarea
        className="w-full border rounded p-2 text-sm focus:ring focus:ring-yellow-100"
        rows="2"
        value={sub.text || ""}
        onChange={(e) => updateField("text", e.target.value)}
        placeholder="è¼¸å…¥è£œå……èªªæ˜â€¦"
      />
    </div>
  );
}


/****************************************************
 * P4-3ï¼ˆBï¼‰ItemSubItemBlock â€” å­é …ç›®ï¼ˆå«æ•¸é‡/å–®åƒ¹ï¼‰
 ****************************************************/
function ItemSubItemBlock({ sub, updateField, deleteSubItem }) {
  // è¨ˆç®—ä¸¦æ ¼å¼åŒ–å°è¨ˆ
  const subtotal = formatMoney(calcAmount(sub));

  // è™•ç†æ•¸å­—è¼¸å…¥ (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
  const handleNumberChange = React.useCallback((field, value) => {
    // åªå…è¨±æ•¸å­—æˆ–ç©ºå­—ä¸²
    if (value === "" || !isNaN(Number(value))) {
      updateField(field, value);
    }
  }, [updateField]);

  return (
    <div className="border rounded p-3 bg-gray-50 mb-2">

      {/* æ¨™é¡Œ + åˆªé™¤ */}
      <div className="flex justify-between items-center mb-2">
        <span className="text-sm font-bold text-gray-700">ğŸ“¦ å­é …ç›®</span>
        <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>
          åˆªé™¤
        </button>
      </div>

      <div className="grid grid-cols-12 gap-2 text-sm items-center">

        {/* åç¨± */}
        <input
          className="border p-1 rounded col-span-3 focus:ring focus:ring-blue-100"
          value={sub.name || ""}
          placeholder="åç¨±"
          onChange={(e) => updateField("name", e.target.value)}
        />

        {/* è¦æ ¼ */}
        <input
          className="border p-1 rounded col-span-4 focus:ring focus:ring-blue-100"
          value={sub.spec || ""}
          placeholder="è¦æ ¼"
          onChange={(e) => updateField("spec", e.target.value)}
        />

        {/* å–®ä½ */}
        <input
          className="border p-1 rounded col-span-1 text-center focus:ring focus:ring-blue-100"
          value={sub.unit || ""}
          placeholder="å–®ä½"
          onChange={(e) => updateField("unit", e.target.value)}
        />

        {/* æ•¸é‡ */}
        <input
          className="border p-1 rounded col-span-1 text-right focus:ring focus:ring-blue-100"
          value={sub.qty || ""}
          placeholder="æ•¸é‡"
          type="number"
          min="0"
          onChange={(e) => handleNumberChange("qty", e.target.value)}
        />

        {/* å–®åƒ¹ */}
        <input
          className="border p-1 rounded col-span-2 text-right focus:ring focus:ring-blue-100"
          value={sub.price || ""}
          placeholder="å–®åƒ¹"
          type="number"
          min="0"
          onChange={(e) => handleNumberChange("price", e.target.value)}
        />

        {/* å°è¨ˆ */}
        <div className="col-span-1 text-right font-bold text-blue-600">
          {subtotal}
        </div>
      </div>
    </div>
  );
}


/****************************************************
 * P4-3ï¼ˆCï¼‰ImageSubItemBlock â€” åœ–ç‰‡å°é …
 ****************************************************/
function ImageSubItemBlock({ sub, updateField, deleteSubItem }) {
  // åœ–ç‰‡ä¸Šå‚³è™•ç† (ä¸æ˜¯ Hookï¼Œä¸éœ€è¦æå‡)
  function handleUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => updateField("src", reader.result);
    reader.readAsDataURL(file);
    e.target.value = ''; // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥ï¼Œä»¥ä¾¿é‡æ–°é¸æ“‡åŒä¸€æª”æ¡ˆ
  }

  return (
    <div className="border rounded p-3 bg-gray-50 mb-2">

      <div className="flex justify-between items-center mb-2">
        <span className="text-sm font-bold text-gray-700">ğŸ“· åœ–ç‰‡è£œå……</span>
        <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>åˆªé™¤</button>
      </div>

      {/*åœ–ç‰‡é è¦½*/}
      {sub.src ? (
        <img src={sub.src} className="max-w-xs mb-2 border rounded shadow" alt="é è¦½åœ–" />
      ) : (
        <div className="text-gray-500 text-sm mb-2 p-2 border border-dashed rounded bg-white">å°šæœªä¸Šå‚³åœ–ç‰‡</div>
      )}

      {/* ä¸Šå‚³æŒ‰éˆ• */}
      <label className="cursor-pointer text-blue-700 underline text-sm hover:text-blue-900">
        {sub.src ? "æ›´æ›åœ–ç‰‡" : "ä¸Šå‚³åœ–ç‰‡"}
        <input type="file" accept="image/*" className="hidden" onChange={handleUpload} />
      </label>
    </div>
  );
}


/****************************************************
 * P4-3ï¼ˆDï¼‰UploadImageButton â€” åœ¨åº•éƒ¨æ–°å¢åœ–ç‰‡ç”¨
 ****************************************************/
function UploadImageButton({ onUpload }) {
  // åœ–ç‰‡ä¸Šå‚³è™•ç† (ä¸æ˜¯ Hookï¼Œä¸éœ€è¦æå‡)
  function handleSelect(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => onUpload(reader.result);
    reader.readAsDataURL(file);
    e.target.value = ''; // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥ï¼Œä»¥ä¾¿é‡æ–°é¸æ“‡åŒä¸€æª”æ¡ˆ
  }

  return (
    <label className="cursor-pointer text-blue-600 hover:text-blue-800 transition">
      ï¼‹è£œå……åœ–ç‰‡
      <input type="file" accept="image/*" className="hidden" onChange={handleSelect} />
    </label>
  );
}


/****************************************************
 * P4-3ï¼ˆEï¼‰SubItemWrapper â€” è‡ªå‹•åˆ†æµå°é …é¡å‹
 ****************************************************/
function SubItemWrapper({ subItem, parentItem, quote, updateQuote }) {

  // æ›´æ–°æŸå€‹ subItem çš„ç‰¹å®šæ¬„ä½ (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
  const updateField = React.useCallback((field, value) => {
    const newItems = quote.items.map(m =>
      m.id === parentItem.id
        ? {
          ...m,
          // ç¢ºä¿ subItems å­˜åœ¨
          subItems: (m.subItems || []).map(s =>
            s.id === subItem.id ? { ...s, [field]: value } : s
          )
        }
        : m
    );
    updateQuote(quote.id, { items: newItems });
  }, [quote.id, parentItem.id, subItem.id, quote.items, updateQuote]);

  // åˆªé™¤ subItem (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
  const deleteSubItem = React.useCallback(() => {
    const newItems = quote.items.map(m =>
      m.id === parentItem.id
        ? { ...m, subItems: (m.subItems || []).filter(s => s.id !== subItem.id) }
        : m
    );
    updateQuote(quote.id, { items: newItems });
  }, [quote.id, parentItem.id, subItem.id, quote.items, updateQuote]);

  const props = { sub: subItem, updateField, deleteSubItem };

  if (subItem.type === "note") return <NoteSubItemBlock {...props} />;
  if (subItem.type === "item") return <ItemSubItemBlock {...props} />;
  if (subItem.type === "image") return <ImageSubItemBlock {...props} />;

  return null;
}


/****************************************************
 * P4-3ï¼ˆFï¼‰MainItemBlock â€” å¤§é …ç·¨è¼¯
 ****************************************************/
function MainItemBlock({ item, quote, updateQuote }) {

  // 1. è™•ç†æ•¸å­—è¼¸å…¥ (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
  const handleNumberChange = React.useCallback((field, value) => {
    if (value === "" || !isNaN(Number(value))) {
      update({ [field]: value });
    }
  }, [item.id, updateQuote]);

  // 2. æ›´æ–°å¤§é …è³‡æ–™ (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
  const update = React.useCallback((data) => {
    const newItems = quote.items.map(m =>
      m.id === item.id ? { ...m, ...data } : m
    );
    updateQuote(quote.id, { items: newItems });
  }, [quote.id, item.id, quote.items, updateQuote]);

  // 3. åˆªé™¤å¤§é … (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
  const deleteMain = React.useCallback(() => {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å¤§é …ï¼Ÿ")) return;
    updateQuote(quote.id, { items: quote.items.filter(m => m.id !== item.id) });
  }, [quote.id, item.id, quote.items, updateQuote]);

  // 4. æ–°å¢å°é … (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
  const addSub = React.useCallback((type, src = "") => {
    const newSub = {
      id: uuid(),
      type,
      text: "",
      name: "",
      spec: "",
      unit: "",
      qty: "",
      price: "",
      src
    };

    const newItems = quote.items.map(m =>
      m.id === item.id ? { ...m, subItems: [...(m.subItems || []), newSub] } : m
    );

    updateQuote(quote.id, { items: newItems });
  }, [quote.id, item.id, quote.items, updateQuote]);

  // è¨ˆç®—ä¸¦æ ¼å¼åŒ–å°è¨ˆ (ä¸æ˜¯ Hookï¼Œæ”¾åœ¨ Hook ä¹‹å¾Œ)
  const mainTotal = formatMoney(calcAmount(item));

  return (
    <div className="border rounded p-4 bg-white shadow mb-4">

      {/* å¤§é …è³‡æ–™åˆ— */}
      <div className="grid grid-cols-12 gap-2 items-center">
        {/* å“å */}
        <input className="border p-1 rounded col-span-3 focus:ring focus:ring-red-100"
          value={item.name || ""} placeholder="å“å"
          onChange={(e) => update({ name: e.target.value })} />
        {/* è¦æ ¼ */}
        <input className="border p-1 rounded col-span-3 focus:ring focus:ring-red-100"
          value={item.spec || ""} placeholder="è¦æ ¼"
          onChange={(e) => update({ spec: e.target.value })} />
        {/* å–®ä½ */}
        <input className="border p-1 rounded col-span-1 text-center focus:ring focus:ring-red-100"
          value={item.unit || ""} placeholder="å–®ä½"
          onChange={(e) => update({ unit: e.target.value })} />
        {/* æ•¸é‡ */}
        <input className="border p-1 rounded col-span-1 text-right focus:ring focus:ring-red-100"
          value={item.qty || ""} placeholder="æ•¸é‡"
          type="number" min="0"
          onChange={(e) => handleNumberChange("qty", e.target.value)} />
        {/* å–®åƒ¹ */}
        <input className="border p-1 rounded col-span-2 text-right focus:ring focus:ring-red-100"
          value={item.price || ""} placeholder="å–®åƒ¹"
          type="number" min="0"
          onChange={(e) => handleNumberChange("price", e.target.value)} />

        {/* å°è¨ˆ */}
        <div className="text-right font-bold col-span-1 text-red-700">
          {mainTotal}
        </div>
        {/* åˆªé™¤æŒ‰éˆ• */}
        <button className="text-red-600 col-span-1 text-sm hover:text-red-800" onClick={deleteMain}>
          âœ•
        </button>
      </div>

      {/* å°é …åˆ—è¡¨ */}
      <div className="mt-3 border-t pt-3">
        {(item.subItems || []).map(sub => ( // ç¢ºä¿ subItems å­˜åœ¨
          <SubItemWrapper
            key={sub.id} // ä¿®æ­£ï¼šæ–°å¢ key
            subItem={sub}
            parentItem={item}
            quote={quote}
            updateQuote={updateQuote}
          />
        ))}
      </div>

      {/* æ“ä½œåˆ— */}
      <div className="flex gap-4 mt-3 text-blue-600 text-sm border-t pt-3">
        <button className="hover:text-blue-800 transition" onClick={() => addSub("item")}>ï¼‹ å­é …ç›®</button>
        <button className="hover:text-blue-800 transition" onClick={() => addSub("note")}>ï¼‹ è£œå……æ–‡å­—</button>
        <UploadImageButton onUpload={(src) => addSub("image", src)} />
      </div>
    </div>
  );
}


/****************************************************
 * P4-3ï¼ˆGï¼‰ItemsEditor â€” æ•´é«”å“é …ç®¡ç†
 ****************************************************/
function ItemsEditor({ quote, updateQuote }) {
  // 1. æ–°å¢å¤§é … (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
  const addMain = React.useCallback(() => {
    const newMain = {
      id: uuid(),
      type: "main",
      name: "æœªå‘½åå¤§é …",
      spec: "",
      unit: "",
      qty: "",
      price: "",
      subItems: []
    };
    updateQuote(quote.id, { items: [...(quote.items || []), newMain] });
  }, [quote.id, quote.items, updateQuote]);

  return (
    <div className="mb-6 no-print">
      <h2 className="font-bold text-lg mb-2">å ±åƒ¹é …ç›®åˆ—è¡¨</h2>
      
      <button
        className="px-4 py-2 bg-blue-600 text-white rounded mb-4 hover:bg-blue-700 transition"
        onClick={addMain}
      >
        ï¼‹ æ–°å¢å¤§é …
      </button>

      {(quote.items || []).map(item => ( // ç¢ºä¿ items å­˜åœ¨
        <MainItemBlock
          key={item.id}
          item={item}
          quote={quote}
          updateQuote={updateQuote}
        />
      ))}
    </div>
  );
}
/****************************************************
Â * P4-4ï¼ˆAï¼‰â€” å‚™è¨»æ¬„ NotesEditor
Â ****************************************************/
function NotesEditor({ quote, update }) {
Â  return (
Â  Â  <div className="p-4 bg-white rounded shadow mb-6 no-print">
Â  Â  Â  <h2 className="font-bold text-lg mb-2 text-gray-700">å‚™è¨»èªªæ˜</h2>

Â  Â  Â  <textarea
Â  Â  Â  Â  className="border p-2 w-full rounded h-32 focus:ring-2 focus:ring-indigo-100"
Â  Â  Â  Â  value={quote.notes || ""}
Â  Â  Â  Â  onChange={(e) => update({ notes: e.target.value })}
Â  Â  Â  />
Â  Â  </div>
Â  );
}
/****************************************************
Â * P4-4ï¼ˆBï¼‰â€” ä»˜æ¬¾æ¢ä»¶ PaymentEditor
Â ****************************************************/
function PaymentEditor({ quote, update }) {
Â  return (
Â  Â  <div className="p-4 bg-white rounded shadow mb-6 no-print">
Â  Â  Â  <h2 className="font-bold text-lg mb-2 text-gray-700">ä»˜æ¬¾æ¢ä»¶</h2>

Â  Â  Â  <textarea
Â  Â  Â  Â  className="border p-2 w-full rounded h-28 focus:ring-2 focus:ring-indigo-100"
Â  Â  Â  Â  value={quote.payment || ""}
Â  Â  Â  Â  onChange={(e) => update({ payment: e.target.value })}
Â  Â  Â  />
Â  Â  </div>
Â  );
}
/****************************************************
Â * P4-4ï¼ˆCï¼‰â€” ç¸½åƒ¹å€ PriceSummary
Â ****************************************************/
function PriceSummary({ quote, update }) {
Â  const originalTotal = calcTotal(quote.items || []);
Â  
Â  // ç¢ºä¿æ•¸å€¼è¼¸å…¥æ˜¯ä¹¾æ·¨çš„æ•¸å­—
Â  const discountPercent = Number(quote.discountPercent || 0);
Â  const negotiatedPrice = Number(quote.negotiatedPrice || 0);
Â  
Â  const finalPrice = calcNegotiated(
Â  Â  originalTotal,
Â  Â  discountPercent,
Â  Â  negotiatedPrice
Â  );

Â  // è™•ç†æ•¸å­—è¼¸å…¥
Â  const handleNumberChange = React.useCallback((field, value) => {
Â  Â  if (value === "" || !isNaN(Number(value))) {
Â  Â  Â  update({ [field]: value });
Â  Â  }
Â  }, [update]);
Â  
Â  return (
Â  Â  <div className="p-4 bg-white rounded shadow mb-6 no-print">

Â  Â  Â  <h2 className="font-bold text-lg mb-3 text-gray-700">ç¸½åƒ¹è³‡è¨Š</h2>

Â  Â  Â  {/* åŸå§‹é‡‘é¡ */}
Â  Â  Â  <div className="mb-3 border-b pb-2">
Â  Â  Â  Â  <label className="font-bold text-gray-600">åŸå§‹ç¸½åƒ¹ï¼š</label>
Â  Â  Â  Â  <span className="text-blue-700 font-extrabold ml-2 text-xl">
Â  Â  Â  Â  Â  NT$ {formatMoney(originalTotal)}
Â  Â  Â  Â  </span>
Â  Â  Â  </div>

Â  Â  Â  {/* æŠ˜æ‰£ç™¾åˆ†æ¯” */}
Â  Â  Â  <div className="mb-3 flex items-center">
Â  Â  Â  Â  <label className="font-bold text-gray-600 w-36">è­°åƒ¹æŠ˜æ‰£ï¼ˆ%ï¼‰ï¼š</label>
Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  className="border p-1 w-24 rounded ml-2 text-right focus:ring focus:ring-purple-100"
Â  Â  Â  Â  Â  type="number"
Â  Â  Â  Â  Â  min="0" max="100"
Â  Â  Â  Â  Â  value={discountPercent === 0 ? "" : discountPercent}
Â  Â  Â  Â  Â  onChange={(e) => handleNumberChange("discountPercent", e.target.value)}
Â  Â  Â  Â  Â  placeholder="0-100"
Â  Â  Â  Â  />
Â  Â  Â  Â  <span className="text-sm text-gray-500 ml-2">ï¼ˆæŠ˜æ‰£å„ªå…ˆï¼‰</span>
Â  Â  Â  </div>

Â  Â  Â  {/* è­°åƒ¹å¾Œé‡‘é¡ï¼ˆç›´æ¥è¼¸å…¥æœƒè¦†è“‹æŠ˜æ‰£ï¼‰ */}
Â  Â  Â  <div className="mb-3 flex items-center">
Â  Â  Â  Â  <label className="font-bold text-gray-600 w-36">
Â  Â  Â  Â  Â  ç›´æ¥è¼¸å…¥è­°åƒ¹å¾Œé‡‘é¡ï¼š
Â  Â  Â  Â  </label>
Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  className="border p-1 w-40 rounded ml-2 text-right focus:ring focus:ring-purple-100"
Â  Â  Â  Â  Â  type="number"
Â  Â  Â  Â  Â  min="0"
Â  Â  Â  Â  Â  placeholder="è¼¸å…¥å¾Œæœƒè¦†è“‹æŠ˜æ‰£%"
Â  Â  Â  Â  Â  value={negotiatedPrice === 0 ? "" : negotiatedPrice}
Â  Â  Â  Â  Â  onChange={(e) => handleNumberChange("negotiatedPrice", e.target.value)}
Â  Â  Â  Â  />
Â  Â  Â  </div>

Â  Â  Â  {/* æœ€çµ‚æˆäº¤åƒ¹ */}
Â  Â  Â  <div className="text-xl font-bold mt-4 pt-4 border-t">
Â  Â  Â  Â  æœ€çµ‚æˆäº¤åƒ¹ï¼š
Â  Â  Â  Â  <span className="text-green-700 ml-2 text-2xl">
Â  Â  Â  Â  Â  NT$ {formatMoney(finalPrice)}
Â  Â  Â  Â  </span>
Â  Â  Â  </div>
Â  Â  </div>
Â  );
}
/****************************************************
Â * P4-5 â€” åˆ—å°å°ˆç”¨ç‰ˆé¢ PrintView
Â ****************************************************/
function PrintView({ quote, company }) {
Â  // ç¢ºä¿ quote å’Œ items å­˜åœ¨
Â  if (!quote || !quote.items) return null;
Â  
Â  const info = COMPANY_DATA[company];

Â  const total = calcTotal(quote.items);
Â  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

Â  return (
Â  Â  <div className="print-container">

Â  Â  Â  {/* å…¬å¸æŠ¬é ­ */}
Â  Â  Â  <div className="text-center mb-6 relative">
Â  Â  Â  Â  <h1 className="text-3xl font-bold">{info.name}</h1>
Â  Â  Â  Â  <div>{info.tel} | {info.fax}</div>
Â  Â  Â  Â  <div>{info.email}</div>
Â  Â  Â  Â  <div>{info.address}</div>

Â  Â  Â  Â  <h2 className="text-3xl font-bold mt-4 tracking-widest border-b-2 border-black inline-block pb-1">
Â  Â  Â  Â  Â  å·¥ ç¨‹ å ± åƒ¹ å–®
Â  Â  Â  Â  </h2>
Â  Â  Â  </div>
Â  Â  Â  
Â  Â  Â  {/* å°ç«  - åƒ…åˆ—å°æ™‚é¡¯ç¤º */}
Â  Â  Â  <img src={info.stamp} alt="å…¬å¸å°ç« " className="print-stamp no-screen" />


Â  Â  Â  {/* åŸºæœ¬è³‡è¨Š */}
Â  Â  Â  <table className="w-full mb-6">
Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td className="font-bold w-32 bg-gray-100">é¡§å®¢åç¨±ï¼š</td>
Â  Â  Â  Â  Â  Â  <td>{quote.customerName}</td>
Â  Â  Â  Â  Â  Â  <td className="font-bold w-32 bg-gray-100">å ±åƒ¹æ—¥æœŸï¼š</td>
Â  Â  Â  Â  Â  Â  <td>{quote.date}</td>
Â  Â  Â  Â  Â  </tr>

Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td className="font-bold bg-gray-100">è¯çµ¡äººï¼š</td>
Â  Â  Â  Â  Â  Â  <td>{quote.contact}</td>
Â  Â  Â  Â  Â  Â  <td className="font-bold bg-gray-100">é›»è©±ï¼š</td>
Â  Â  Â  Â  Â  Â  <td>{quote.phone}</td>
Â  Â  Â  Â  Â  </tr>

Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td className="font-bold bg-gray-100">å·¥ç¨‹åç¨±ï¼š</td>
Â  Â  Â  Â  Â  Â  <td>{quote.title}</td>
Â  Â  Â  Â  Â  Â  <td className="font-bold bg-gray-100">å·¥ç¨‹åœ°é»ï¼š</td>
Â  Â  Â  Â  Â  Â  <td>{quote.location}</td>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </tbody>
Â  Â  Â  </table>

Â  Â  Â  {/* å“é …åˆ—è¡¨ */}
Â  Â  Â  <table className="w-full border-collapse mb-6" border="1">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr className="bg-gray-200">
Â  Â  Â  Â  Â  Â  <th className="p-1 w-[15%]">é …ç›®</th>
Â  Â  Â  Â  Â  Â  <th className="p-1 w-[35%]">è¦æ ¼ / èªªæ˜</th>
Â  Â  Â  Â  Â  Â  <th className="p-1 w-[8%]">å–®ä½</th>
Â  Â  Â  Â  Â  Â  <th className="p-1 w-[8%]">æ•¸é‡</th>
Â  Â  Â  Â  Â  Â  <th className="p-1 w-[12%]">å–®åƒ¹</th>
Â  Â  Â  Â  Â  Â  <th className="p-1 w-[12%]">é‡‘é¡</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>

Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  {quote.items.map((item) => (
Â  Â  Â  Â  Â  Â  <React.Fragment key={item.id}> {/* ä¿®æ­£ï¼šä½¿ç”¨ Fragment åŒ…è£¹å¤šå€‹ tr */}
Â  Â  Â  Â  Â  Â  Â  {/* å¤§é … */}
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td className="p-1 font-bold">{item.name || 'ï¼ˆå¤§é …ï¼‰'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td className="p-1">{item.spec}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td className="p-1 text-center">{item.unit}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td className="p-1 text-right">{item.qty}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td className="p-1 text-right">{formatMoney(item.price)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td className="p-1 text-right font-bold">
Â  Â  Â  Â  Â  Â  Â  Â  Â  {formatMoney(calcAmount(item))}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  </tr>

Â  Â  Â  Â  Â  Â  Â  {/* å°é … / è£œå…… */}
Â  Â  Â  Â  Â  Â  Â  {(item.subItems || []).map((sub) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (sub.type === "note") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  return (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr key={sub.id}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td colSpan="6" className="p-1 pl-6 text-gray-700">â— {sub.text}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (sub.type === "image") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  return (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr key={sub.id}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td colSpan="6" className="p-1 pl-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src={sub.src} className="print-image border" alt="è£œå……åœ–ç‰‡" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  return (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr key={sub.id}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td className="p-1 pl-6">ï¼ {sub.name || 'å­é …ç›®'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td className="p-1">{sub.spec}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td className="p-1 text-center">{sub.unit}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td className="p-1 text-right">{sub.qty}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td className="p-1 text-right">{formatMoney(sub.price)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td className="p-1 text-right font-bold text-gray-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {formatMoney(calcAmount(sub))}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  })}
Â  Â  Â  Â  Â  Â  </React.Fragment>
Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  </tbody>

Â  Â  Â  Â  <tfoot>
Â  Â  Â  Â  Â  <tr className="bg-gray-100 font-bold">
Â  Â  Â  Â  Â  Â  <td colSpan="5" className="text-right">ç¸½è¨ˆé‡‘é¡ï¼ˆæœªç¨…ï¼‰ï¼š</td>
Â  Â  Â  Â  Â  Â  <td colSpan="2" className="text-right text-lg">NT$ {formatMoney(negotiated)}</td>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </tfoot>
Â  Â  Â  </table>

Â  Â  Â  {/* å‚™è¨»èˆ‡ä»˜æ¬¾æ¢ä»¶ */}
Â  Â  Â  <div className="grid grid-cols-2 gap-4 mb-6">
Â  Â  Â  Â  {/* å‚™è¨» */}
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <h3 className="font-bold border-b border-black mb-1">å‚™è¨»èªªæ˜ï¼š</h3>
Â  Â  Â  Â  Â  <pre className="whitespace-pre-wrap text-sm">{quote.notes}</pre>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  Â  Â  {/* ä»˜æ¬¾æ¢ä»¶ */}
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <h3 className="font-bold border-b border-black mb-1">ä»˜æ¬¾æ¢ä»¶ï¼š</h3>
Â  Â  Â  Â  Â  <pre className="whitespace-pre-wrap text-sm">{quote.payment}</pre>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  </div>
Â  );
}
/****************************************************
Â * P6 â€” å…¨å±€åŠŸèƒ½ï¼šåˆ—å° / Excel
Â ****************************************************/

// ç²å–ç•¶å‰å ±åƒ¹å–®
function getActiveQuoteData() {
Â  const context = window.__APP_CONTEXT__;
Â  if (!context || !context.activeQuote) {
Â  Â  console.error("ç„¡æ³•å–å¾—å ±åƒ¹å–®æ•¸æ“š");
Â  Â  return null;
Â  }
Â  return { quote: context.activeQuote, company: context.company };
}

// --------------------------------------------------
// è™•ç†åˆ—å°
// --------------------------------------------------
function handlePrint() {
Â  const data = getActiveQuoteData();
Â  if (!data) return;

Â  // 1. å°‡ PrintView å…ƒä»¶æ¸²æŸ“åˆ° `div#printArea`
Â  const printArea = document.getElementById('printArea');
Â  // ç¢ºä¿ä½¿ç”¨ createRoot æ¸²æŸ“ React 18 æ ¹
Â  if (!window.__PRINT_ROOT__) {
Â  Â  window.__PRINT_ROOT__ = ReactDOM.createRoot(printArea);
Â  }
Â  
Â  // æ¸²æŸ“åˆ—å°å…§å®¹
Â  window.__PRINT_ROOT__.render(
Â  Â  <PrintView quote={data.quote} company={data.company} />
Â  );
Â  
Â  // ç­‰å¾…æ¸²æŸ“å®Œæˆ (å°å»¶é²ç¢ºä¿ DOM æº–å‚™å¥½)
Â  setTimeout(() => {
Â  Â  window.print();
Â  Â  // é€™è£¡å¯ä»¥é¸æ“‡ä¸éŠ·æ¯€ï¼Œä¿æŒæ¸²æŸ“ï¼Œæˆ–å»¶é²éŠ·æ¯€
Â  }, 100);
}


// --------------------------------------------------
// è™•ç† Excel åŒ¯å‡º (SheetJS)
// --------------------------------------------------
function exportToExcel() {
Â  const data = getActiveQuoteData();
Â  if (!data) return;
Â  const { quote } = data;
Â  
Â  const wb = XLSX.utils.book_new();
Â  
Â  // æº–å‚™å·¥ä½œè¡¨æ•¸æ“š
Â  const wsData = [
Â  Â  ["å·¥ç¨‹å ±åƒ¹å–®"],
Â  Â  ["å·¥ç¨‹åç¨±:", quote.title || ""],
Â  Â  ["å ±åƒ¹ç·¨è™Ÿ:", quote.quoteNo || ""],
Â  Â  ["å®¢æˆ¶åç¨±:", quote.customerName || ""],
Â  Â  ["å ±åƒ¹æ—¥æœŸ:", quote.date || ""],
Â  Â  [],
Â  Â  ["é …ç›®", "è¦æ ¼ / èªªæ˜", "å–®ä½", "æ•¸é‡", "å–®åƒ¹", "é‡‘é¡"],
Â  ];

Â  // æ·»åŠ å ±åƒ¹é …ç›®
Â  const items = quote.items || [];
Â  items.forEach(item => {
Â  Â  // å¤§é …
Â  Â  wsData.push([
Â  Â  Â  item.name || "", 
Â  Â  Â  item.spec || "", 
Â  Â  Â  item.unit || "", 
Â  Â  Â  Number(item.qty) || 0, 
Â  Â  Â  Number(item.price) || 0, 
Â  Â  Â  calcAmount(item)
Â  Â  ]);
Â  Â  
Â  Â  // å­é …
Â  Â  const subItems = item.subItems || [];
Â  Â  subItems.forEach(sub => {
Â  Â  Â  if (sub.type === 'item') {
Â  Â  Â  Â  wsData.push([
Â  Â  Â  Â  Â  ` - ${sub.name || ""}`, 
Â  Â  Â  Â  Â  sub.spec || "", 
Â  Â  Â  Â  Â  sub.unit || "", 
Â  Â  Â  Â  Â  Number(sub.qty) || 0, 
Â  Â  Â  Â  Â  Number(sub.price) || 0, 
Â  Â  Â  Â  Â  calcAmount(sub)
Â  Â  Â  Â  ]);
Â  Â  Â  } else if (sub.type === 'note') {
Â  Â  Â  Â  wsData.push([`å‚™è¨»: ${sub.text || ""}`]);
Â  Â  Â  }
Â  Â  });
Â  });
Â  
Â  const total = calcTotal(items);
Â  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);
Â  
Â  wsData.push([]);
Â  wsData.push(["åŸå§‹ç¸½åƒ¹(æœªç¨…):", "", "", "", "", formatMoney(total)]);
Â  wsData.push(["æœ€çµ‚æˆäº¤åƒ¹(æœªç¨…):", "", "", "", "", formatMoney(negotiated)]);
Â  wsData.push([]);
Â  wsData.push(["å‚™è¨»èªªæ˜:", quote.notes || ""]);
Â  wsData.push(["ä»˜æ¬¾æ¢ä»¶:", quote.payment || ""]);

Â  const ws = XLSX.utils.aoa_to_sheet(wsData);
Â  
Â  // è¨­ç½®å–®å…ƒæ ¼æ ¼å¼ (å¯é¸: è®“æ•¸å­—çœ‹èµ·ä¾†åƒæ•¸å­—)
Â  const range = XLSX.utils.decode_range(ws['!ref']);
Â  for(let R = range.s.r + 6; R <= range.e.r - 2; ++R) { // å¾é …ç›®æ¨™é ­è¡Œä¸‹æ–¹é–‹å§‹åˆ°ç¸½è¨ˆä¸Šæ–¹
Â  Â  if (ws[XLSX.utils.encode_cell({r:R, c:3})]) ws[XLSX.utils.encode_cell({r:R, c:3})].t = 'n'; // æ•¸é‡
Â  Â  if (ws[XLSX.utils.encode_cell({r:R, c:4})]) ws[XLSX.utils.encode_cell({r:R, c:4})].t = 'n'; // å–®åƒ¹
Â  Â  if (ws[XLSX.utils.encode_cell({r:R, c:5})]) ws[XLSX.utils.encode_cell({r:R, c:5})].t = 'n'; // é‡‘é¡
Â  }

Â  XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å–®å…§å®¹");
Â  XLSX.writeFile(wb, `${quote.quoteNo}-${quote.customerName}.xlsx`);
}

// --------------------------------------------------
// P7 â€” App æ ¹å…ƒä»¶
// --------------------------------------------------
function App() {
  const { activeQuote, updateQuote } = React.useContext(AppContext); // <-- Hook 1

  // 1. å°‡æ‰€æœ‰ Hooks æ”¾åœ¨é ‚å±¤ (åœ¨æ¢ä»¶åˆ¤æ–·ä¹‹å‰)

  // æ›´æ–° activeQuote çš„å‡½æ•¸ (Hook 2)
  // æ³¨æ„ï¼šå› ç‚º activeQuote åœ¨ Hook å…§éƒ¨è¢«ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘å€‘å¿…é ˆåœ¨é€™è£¡è™•ç†å®ƒå¯èƒ½ç‚º null çš„æƒ…æ³ã€‚
  const updateActiveQuote = React.useCallback((data) => {
    // åªæœ‰åœ¨ activeQuote å­˜åœ¨æ™‚æ‰åŸ·è¡Œæ›´æ–°
    if (activeQuote && activeQuote.id) {
      updateQuote(activeQuote.id, data);
    }
  }, [activeQuote, updateQuote]); // å°‡ä¾è³´é …å¾ activeQuote.id æ”¹ç‚º activeQuote

  // 2. æ¢ä»¶è¿”å› (æ”¾åœ¨æ‰€æœ‰ Hooks ä¹‹å¾Œ)

  // ç•¶å‰å ±åƒ¹å–®ä¸å­˜åœ¨æ™‚çš„ç•«é¢
  if (!activeQuote) {
    return (
      <div className="p-8">
        <h1 className="text-2xl font-bold mb-4">å·¥ç¨‹å ±åƒ¹ç³»çµ±</h1>
        <div className="grid grid-cols-4 gap-6">
          <div className="col-span-1">
            <CompanySelector />
            <ModeSelector />
            <QuoteManager />
          </div>
          <div className="col-span-3 p-8 bg-white rounded shadow text-center text-gray-500">
            è«‹åœ¨å·¦å´é¸å–®å»ºç«‹æˆ–é¸æ“‡ä¸€ä»½å ±åƒ¹å–®é–‹å§‹ç·¨è¼¯ã€‚
          </div>
        </div>
      </div>
    );
  }

  // 3. æ­£å¸¸æ¸²æŸ“
  
  return (
    <div className="p-8">
      <h1 className="text-2xl font-bold mb-4 no-print">å·¥ç¨‹å ±åƒ¹ç³»çµ± - ç·¨è¼¯ä¸­ï¼š{activeQuote.title}</h1>

      {/* VVVV ä¿®æ­£ä½ˆå±€ï¼šå°‡ grid-cols-4 æ›¿æ›ç‚º flex VVVV */}
      <div className="flex gap-6"> 
        {/* å·¦å´é¸å–®ï¼šä½¿ç”¨å›ºå®šçš„ w-64 å¯¬åº¦ï¼Œä¸¦ç¢ºä¿ä¸è¢«å£“ç¸® (flex-shrink-0) */}
        <div className="w-64 flex-shrink-0"> 
          <div className="p-4 bg-white rounded shadow">
            <CompanySelector />
            <ModeSelector />
            <QuoteManager />
          </div>
        </div>

        {/* å³å´ç·¨è¼¯å€ï¼šä½”ç”¨å‰©é¤˜çš„æ‰€æœ‰ç©ºé–“ (flex-grow) */}
        <div className="flex-grow"> 
          {/* å®¢æˆ¶è³‡è¨Š */}
          <QuoteEditor />
          
          {/* å“é …åˆ—è¡¨ */}
          <ItemsEditor quote={activeQuote} updateQuote={updateQuote} />

          {/* å‚™è¨»/ä»˜æ¬¾/ç¸½åƒ¹ */}
            <div className="flex flex-col gap-6">
            <div className="flex-1"> {/* ä½¿ç”¨ flex-1 ç¢ºä¿å®ƒå€‘åœ¨ flex-col ä¸­ä½”æ“šå…¨å¯¬ */}
              <NotesEditor quote={activeQuote} update={updateActiveQuote} />
            </div>
            <div className="flex-1">
              <PaymentEditor quote={activeQuote} update={updateActiveQuote} />
            </div>
            <div className="flex-1">
              <PriceSummary quote={activeQuote} update={updateActiveQuote} />
            </div>
          </div>
          
          {/* æ“ä½œæŒ‰éˆ•å€ */}
          <div className="flex justify-end gap-4 p-4 bg-white rounded shadow no-print">
            <button 
              className="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700 transition"
              onClick={exportToExcel}
            >
              ğŸ“¤ åŒ¯å‡º Excel
            </button>
            <button 
              className="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700 transition"
              onClick={handlePrint}
            >
              ğŸ–¨ï¸ åˆ—å°/PDF å ±åƒ¹å–®
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// --------------------------------------------------
// æ¸²æŸ“ React æ ¹
// --------------------------------------------------
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <AppProvider>
    <App />
  </AppProvider>
);
