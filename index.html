<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰- V13 (å¼·åŒ–åˆ—å°æ¨£å¼)</title>

    <script src="https://unpkg.com/react-dom@18/umd/react-dom-server.browser.development.js"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
    body {
        background: #f3ff6;
        font-family: "Microsoft JhengHei", sans-serif;
    }
    
    /* ä¿®æ­£åˆ—å°å•é¡Œï¼šæŒ‡å®šåˆ—å°å€åŸŸçš„ ID */
    @media print {

        /* éš±è—éåˆ—å°å…ƒç´  */
        .no-print {
            display: none !important;
        }
        
        /* éš±è—ä¸»ç·¨è¼¯å€ï¼Œåªé¡¯ç¤ºé è¦½å€ */
        #root {
            display: none !important; 
        }

        /* åˆ—å°é è¦½å€åŸŸï¼šç¢ºä¿å…§å®¹æ­£ç¢ºå‘ˆç¾ */
        #quotePreviewArea {
            /* é—œéµä¿®æ­£ 2: ç§»é™¤ hiddenï¼Œè®“åˆ—å°æ™‚ä¸€å®šé¡¯ç¤º */
            display: block !important; 
            margin: 0;
            padding: 12mm;
            font-size: 13px; /* åˆ—å°å­—é«”ç•¥å° */
            color: black;
            width: 210mm; /* A4 å¯¬åº¦ */
            box-sizing: border-box;
            background: white; /* ç¢ºä¿èƒŒæ™¯æ˜¯ç™½è‰² */
            min-height: 297mm; /* ç¢ºä¿è‡³å°‘ä¸€é é«˜åº¦ */
        }
        
        /* æ¨™é¡Œ - å…¬å¸åç¨±ç½®ä¸­ */
        .print-header h1 {
            font-size: 24px;
            font-weight: bold;
            text-align: center; 
        }

        /* ------------------------------------- */
        /* ğŸ¯ V13 ä¿®æ­£ï¼šå®¢æˆ¶/å…¬å¸è³‡è¨Šè¡¨æ ¼é‚Šæ¡†å¼·åŒ– */
        /* ------------------------------------- */
        .print-info-table {
            width: 100%;
            border-collapse: collapse;
            /* é‚Šç•Œä½¿ç”¨ç´°ç·š */
            border: 1px solid black; 
            margin-bottom: 15px;
        }
        .print-info-table td {
            /* å…§å´ç·šæ¢ä½¿ç”¨ç´°ç·š */
            border: 1px solid black; 
            padding: 4px 8px;
            vertical-align: middle;
            height: 25px; /* ç¢ºä¿è¡Œé«˜ä¸€è‡´ */
        }
        .print-info-label {
            width: 15%;
            background: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }

        /* ------------------------------------- */
        /* ğŸ¯ V13 ä¿®æ­£ï¼šå ±åƒ¹é …ç›®è¡¨æ ¼é‚Šæ¡†èˆ‡å°é½Šå¼·åŒ– */
        /* ------------------------------------- */
        table.print-items-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 13px;
            table-layout: fixed; /* å›ºå®šåˆ—å¯¬ */
            /* å¤–å´ç·šæ¢ä½¿ç”¨ç²—ç·š (ç¯„ä¾‹åœ–ç‚ºç²—ç·š) */
            border: 2px solid black; 
        }

        .print-items-table th, .print-items-table td {
            /* å…§å´ç·šæ¢ä½¿ç”¨ç´°ç·š */
            border: 1px solid black; 
            padding: 4px 6px;
            vertical-align: top;
            line-height: 1.4;
            height: auto; 
            white-space: normal; /* ç¢ºä¿æ–‡å­—æ›è¡Œ */
        }

        .print-items-table th {
            background-color: #e0e0e0;
            text-align: center;
        }
        
        /* æ•¸é‡ç½®ä¸­ */
        .print-items-table td:nth-child(4) { 
            text-align: center;
        }

        /* å–®åƒ¹é å³ */
        .print-items-table td:nth-child(5) { 
            text-align: right;
        }
        
        /* é‡‘é¡é å³å°é½Š (æ”¾å¤§å­—é«”) */
        .print-items-table td:nth-child(7) { 
            text-align: right;
            font-weight: bold; /* è®“é‡‘é¡æ›´é†’ç›® */
            font-size: 14px; /* é‡‘é¡ç•¥ç‚ºæ”¾å¤§ */
        }
        
        /* è¡¨æ ¼åˆ†é æ§åˆ¶ */
        thead {
            display: table-header-group; 
        }
        
        tr {
            page-break-inside: avoid; /* é˜²æ­¢è¡Œè¢«æˆªæ–· */
        }
        
        /* ç¸½è¨ˆå€å¡Š */
        .print-total-box {
            border: 1px solid black;
            padding: 10px;
            font-size: 14px;
            margin-top: 10px;
        }

        /* åœ–ç‰‡åˆ—å°æ¨£å¼ */
        .print-image {
            max-width: 150px; /* é™åˆ¶åˆ—å°åœ–ç‰‡å¤§å° */
            height: auto;
            margin-top: 5px;
            display: block;
        }

        /* ------------------------------------- */
        /* ğŸ¯ V13 ä¿®æ­£ï¼šå‚™è¨»/ä»˜æ¬¾æ¢ä»¶å€å¡Šé‚Šæ¡†å¼·åŒ– */
        /* ------------------------------------- */
        .print-notes-box {
            margin-top: 15px;
            border: 1px solid black; /* é‚Šæ¡† */
            padding: 10px;
            white-space: pre-wrap; /* ä¿æŒæ›è¡Œ */
        }
    }
    </style>
</head>

<body class="text-gray-900">

    <div id="root"></div>
    
    <div id="quotePreviewArea">
        {/* PrintLayout Component å°‡æœƒåœ¨é€™è£¡è¢«æ¸²æŸ“ï¼Œç„¶å¾Œåˆ—å° */}
    </div>

<script type="text/babel">
// P1 â€” å…¬å¸è³‡æ–™ / ä»˜æ¬¾æ¢ä»¶ / å‚™è¨» / æ¨¡å¼æ¨¡æ¿
const COMPANY_DATA = {
    // å…¬å¸åœ°å€
    herhsin: {
        name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
        tel: "07-6517476",
        fax: "07-6517994",
        email: "admin@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "herhsin_stamp_placeholder.png", 
        prefix: "QH" 
    },
    sinchang: {
        name: "è–ªæ˜Œæœ‰é™å…¬å¸",
        tel: "07-6521927",
        fax: "07-6517994",
        email: "affairs@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "sinchang_stamp_placeholder.png", 
        prefix: "QS" 
    }
};

// é è¨­å‚™è¨»
const DEFAULT_NOTES = `1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚`;

// é è¨­ä»˜æ¬¾æ¢ä»¶
const DEFAULT_PAYMENT = `è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%`;

// å ±åƒ¹æ¨¡å¼æ¨¡æ¿
const QUOTE_MODES = [
    {
        id: "modeA",
        name: "æ‹Œåˆæ©Ÿæ¼æ¼¿æ›´æ›",
        description: "é©ç”¨æ‹Œåˆæ©Ÿç¶­ä¿®ã€æ¼æ¼¿è™•ç†ç­‰ã€‚",
        defaultItems: [],
        defaultNotes: DEFAULT_NOTES,
        defaultPayment: DEFAULT_PAYMENT
    },
    {
        id: "modeB",
        name: "è¨­å‚™éŠ·å”®",
        description: "é©ç”¨å‚™å“ã€å–®æ©ŸéŠ·å”®èˆ‡å®‰è£ã€‚",
        defaultItems: [],
        defaultNotes: DEFAULT_NOTES,
        defaultPayment: DEFAULT_PAYMENT
    },
    {
        id: "modeC",
        name: "è¨­å‚™æ›´æ›å·¥ç¨‹",
        description: "é©ç”¨æ•´æ©Ÿæ›´æ–°ã€æ–™ä»¶æ›´æ›å·¥ç¨‹ã€‚",
        defaultItems: [],
        defaultNotes: DEFAULT_NOTES,
        defaultPayment: DEFAULT_PAYMENT
    }
];

// P2 â€” å·¥å…·å‡½å¼ï¼ˆå®Œæ•´ï¼‰
function uuid() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}

function formatDate(dateStr = new Date()) {
    const d = dateStr instanceof Date ? dateStr : new Date(dateStr);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`; // æ”¹ç‚º ISO æ ¼å¼ä»¥åˆ© input type="date"
}

function formatMoney(num) {
    // è™•ç†ç©ºå€¼å’Œéæ•¸å­—ï¼Œä½†å…è¨±æ•¸å­— 0
    if (num === "" || num === null || num === undefined || isNaN(Number(num))) return "";
    return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 });
}

function calcAmount(item) {
    // ç¢ºä¿ qty å’Œ price è½‰ç‚ºæ•¸å­—ï¼Œå¦å‰‡ç‚º 0
    const qty = Number(item.qty || 0);
    const price = Number(item.price || 0);
    return qty * price;
}

function calcTotal(items) {
    return items.reduce((sum, it) => {
        let mainAmt = calcAmount(it);
        let subs = 0;

        if (it.subItems && it.subItems.length > 0) {
            // è¨ˆç®—æ‰€æœ‰ item é¡å‹çš„ subItem çš„é‡‘é¡
            subs = it.subItems.reduce((s, sub) => (sub.type === 'item' ? s + calcAmount(sub) : s), 0);
        }

        return sum + mainAmt + subs;
    }, 0);
}

function calcNegotiated(total, discountPercent, customPrice) {
    const cp = Number(customPrice || 0);
    const dp = Number(discountPercent || 0);
    
    if (cp > 0) return cp;
    
    if (dp > 0 && dp < 100) {
        return Math.round(total * (1 - dp / 100));
    }
    return total;
}

// å ±åƒ¹å–®ç·¨è™Ÿ
function generateQuoteNo(companyKey) {
    const prefix = COMPANY_DATA[companyKey]?.prefix || "Q"; 
    
    // ä½¿ç”¨ YYYYMMDDHHMM + 4ä½äº‚æ•¸
    const d = new Date();
    const parts = [
        d.getFullYear(),
        String(d.getMonth() + 1).padStart(2, "0"),
        String(d.getDate()).padStart(2, "0"),
        String(d.getHours()).padStart(2, "0"),
        String(d.getMinutes()).padStart(2, "0"),
    ].join('');
    
    const random = Math.floor(1000 + Math.random() * 9000);
    
    return `${prefix}${parts}-${random}`; 
}

// è¼‰å…¥ Google Sheet CSV (éåŒæ­¥å‡½å¼)
async function loadCSV(url) {
    try {
        const res = await fetch(url);
        const text = await res.text();
        
        // å‡è¨­ç¬¬ä¸€è¡Œç‚ºæ¨™é ­
        const rows = text.split("\n").map(r => r.trim()).filter(r => r.length > 0);
        if (rows.length < 2) return [];
        
        // ç¢ºä¿æ¨™é ­ä¸åŒ…å«é›™å¼•è™Ÿ
        const header = rows[0].split(",").map(h => h.trim().replace(/"/g, ''));

        return rows.slice(1).map(row => {
            // ä½¿ç”¨æ­£è¦è¡¨é”å¼è™•ç† CSV å…§åµŒé€—è™Ÿå’Œå¼•è™Ÿ
            const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
            const obj = {};

            header.forEach((h, i) => {
                let value = cols[i] ? cols[i].trim() : "";
                // ç§»é™¤å‰å¾Œå¼•è™Ÿ
                if (value.startsWith('"') && value.endsWith('"')) {
                    value = value.substring(1, value.length - 1);
                }
                obj[h] = value;
            });
            return obj;
        });
    } catch (error) {
        console.error("è¼‰å…¥æˆ–è§£æ Google Sheet CSV å¤±æ•—:", error);
        return [];
    }
}


// P3 â€” AppContextï¼ˆæ ¸å¿ƒè³‡æ–™ä¸­å¿ƒï¼‰
const AppContext = React.createContext();

function AppProvider({ children }) {
    // å…¬å¸ herhsin / sinchang
    const [company, setCompany] = React.useState("herhsin");

    // å ±åƒ¹å–®åˆ—è¡¨
    const [quotes, setQuotes] = React.useState([]);

    // æ­£åœ¨ç·¨è¼¯çš„å ±åƒ¹å–® ID
    const [activeQuoteId, setActiveQuoteId] = React.useState(null);

    // è¦æ ¼å“ï¼ˆä¾†è‡ª Google Sheetï¼‰
    const [specItems, setSpecItems] = React.useState([]);

    // Google Sheet è·¯å¾‘ (è«‹å‹™å¿…å°‡æ­¤æ›¿æ›ç‚ºæ‚¨çš„å…¬é–‹ CSV é€£çµ)
    const SPEC_CSV_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv"; 
        

    //************* åˆå§‹åŒ–ï¼šå¾ localStorage è¼‰å…¥ *************/
    React.useEffect(() => {
        const saved = localStorage.getItem("HERHSIN_QUOTES");

        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                // ç¢ºä¿è¼‰å…¥çš„æ˜¯é™£åˆ—
                if (Array.isArray(parsed)) {
                    setQuotes(parsed);
                    if (parsed.length > 0) setActiveQuoteId(parsed[0].id);
                }
            } catch (e) {
                console.error("è§£æ localStorage æ•¸æ“šå¤±æ•—:", e);
                setQuotes([]);
                setActiveQuoteId(null);
            }
        }
    }, []);

    //************* è‡ªå‹•å­˜å› localStorage *************/
    React.useEffect(() => {
        try {
            localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
        } catch (e) {
            console.error("å¯«å…¥ localStorage å¤±æ•—:", e);
        }
    }, [quotes]);


    //************* è¼‰å…¥ Google Sheet è¦æ ¼å“ *************/
    const loadSpecItems = React.useCallback(() => {
        loadCSV(SPEC_CSV_URL).then(data => setSpecItems(data));
    }, [SPEC_CSV_URL]);

    React.useEffect(() => {
        // ç¶²é ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚åŸ·è¡Œ
        loadSpecItems();
    }, [loadSpecItems]);


    // å»ºç«‹æ–°å ±åƒ¹å–®ï¼ˆå¯å¥—ç”¨æ¨¡å¼ï¼‰
    const createQuote = React.useCallback((modeId = null) => {
        const mode = QUOTE_MODES.find(m => m.id === modeId);

        // åœ¨å»ºç«‹å ±åƒ¹å–®æ™‚ï¼Œæ ¹æ“šç•¶å‰é¸å®šçš„ company ç”¢ç”Ÿç·¨è™Ÿ
        const newQuote = {
            id: uuid(),
            quoteNo: generateQuoteNo(company), 
            title: mode ? mode.name : "æœªå‘½åå·¥ç¨‹",
            customerName: "",
            contact: "",
            phone: "",
            location: "",
            date: formatDate(), 
            items: mode && Array.isArray(mode.defaultItems) ? mode.defaultItems.map(item => ({
                ...item, 
                id: uuid(), 
                subItems: [],
                // é …ç›®è¦æ ¼æ¬„ä½
                specMain: "", // è¦æ ¼ (ä¸»æè¿°)
                specMaterial: "", // ç”¨æ–™æ˜ç´° (ç”¨æ–™1/2/3 åˆä½µ)
                remarks: "" // å‚™è¨»
            })) : [],
            notes: mode ? mode.defaultNotes : DEFAULT_NOTES,
            payment: mode ? mode.defaultPayment : DEFAULT_PAYMENT,
            discountPercent: 0,
            negotiatedPrice: 0
        };

        setQuotes(prev => {
            const newList = [newQuote, ...prev]; // æ–°å ±åƒ¹å–®æ”¾åœ¨æœ€å‰é¢
            setActiveQuoteId(newQuote.id);
            return newList;
        });
    }, [company]);


    // åˆªé™¤å ±åƒ¹å–®
    const deleteQuote = React.useCallback((id) => {
        setQuotes(prev => {
            const newList = prev.filter(q => q.id !== id);
            
            if (id === activeQuoteId) {
                setActiveQuoteId(newList.length > 0 ? newList[0].id : null);
            }
            return newList;
        });
    }, [activeQuoteId]);


    // æ›´æ–°å ±åƒ¹å–®æ¬„ä½
    const updateQuote = React.useCallback((id, data) => {
        setQuotes(prev =>
            prev.map(q => (q.id === id ? { ...q, ...data } : q))
        );
    }, []);


    // å¥—ç”¨æ¨¡å¼ï¼ˆè¦†è“‹ï¼šæ¨™é¡Œã€å‚™è¨»ã€ä»˜æ¬¾ã€é è¨­é …ç›®ï¼‰
    const applyMode = React.useCallback((modeId) => {
        const mode = QUOTE_MODES.find(m => m.id === modeId);
        if (!mode || !activeQuoteId) return;

        // ç¢ºä¿ defaultItems ä¸­çš„æ¯å€‹ item éƒ½æœ‰å”¯ä¸€çš„ id
        const itemsWithIds = mode.defaultItems.map(item => ({
            ...item, 
            id: uuid(), 
            subItems: [],
            // åˆå§‹åŒ–è¦æ ¼æ¬„ä½
            specMain: "", 
            specMaterial: "", 
            remarks: ""
        }));

        updateQuote(activeQuoteId, {
            title: mode.name,
            items: itemsWithIds, 
            notes: mode.defaultNotes,
            payment: mode.defaultPayment,
        });
    }, [activeQuoteId, updateQuote]);


    // Context æä¾›çµ¦å…¨ App
    const activeQuote = quotes.find(q => q.id === activeQuoteId);
    
    const value = {
        company,
        setCompany,

        quotes,
        createQuote,
        deleteQuote,
        updateQuote,
        activeQuote, 
        activeQuoteId,
        setActiveQuoteId,

        specItems,
        loadSpecItems, 
        applyMode
    };

    // è®“åˆ—å°å’Œ Excel åŒ¯å‡ºåŠŸèƒ½å¯ä»¥å…¨åŸŸæŠ“åˆ° Context
    window.__APP_CONTEXT__ = value;

    return (
        <AppContext.Provider value={value}>
            {children}
        </AppContext.Provider>
    );
}
// P4-1 â€” å·¦å´å…ƒä»¶ï¼šå…¬å¸åˆ‡æ› / æ¨¡å¼é¸æ“‡ / å ±åƒ¹å–®åˆ—è¡¨


// --------------------------------------------------
// å…¬å¸åˆ‡æ›ï¼ˆä½•é‘« / è–ªæ˜Œï¼‰
// --------------------------------------------------
function CompanySelector() {
    const { company, setCompany } = React.useContext(AppContext);

    return (
        <div className="mb-6 no-print">
            <div className="font-bold mb-2">é¸æ“‡å…¬å¸</div>

            <div className="flex gap-2">
                <button
                    className={`px-3 py-1 rounded ${
                        company === "herhsin"
                            ? "bg-blue-600 text-white"
                            : "bg-gray-300 hover:bg-gray-400"
                    }`}
                    onClick={() => setCompany("herhsin")}
                >
                    ä½•é‘«å¯¦æ¥­
                </button>

                <button
                    className={`px-3 py-1 rounded ${
                        company === "sinchang"
                            ? "bg-blue-600 text-white"
                            : "bg-gray-300 hover:bg-gray-400"
                    }`}
                    onClick={() => setCompany("sinchang")}
                >
                    è–ªæ˜Œæœ‰é™å…¬å¸
                </button>
            </div>
        </div>
    );
}


// --------------------------------------------------
// å ±åƒ¹æ¨¡å¼é¸æ“‡å™¨
// --------------------------------------------------
function ModeSelector() {
    const { createQuote } = React.useContext(AppContext);

    return (
        <div className="mb-6 no-print">
            <div className="font-bold mb-2">å»ºç«‹å ±åƒ¹å–®ï¼ˆå¥—ç”¨æ¨¡å¼ï¼‰</div>

            <div className="flex flex-col gap-2">

                {QUOTE_MODES.map(mode => (
                    <button
                        key={mode.id}
                        className="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-left"
                        onClick={() => createQuote(mode.id)}
                    >
                        â¤ {mode.name}
                    </button>
                ))}

                {/* ç„¡æ¨¡å¼ï¼šç©ºç™½å ±åƒ¹å–® */}
                <button
                    className="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                    onClick={() => createQuote(null)}
                >
                    ï¼‹ ç©ºç™½å ±åƒ¹å–®
                </button>
            </div>
        </div>
    );
}


// --------------------------------------------------
// å ±åƒ¹å–®ç®¡ç†ï¼šåˆ—è¡¨ã€åˆ‡æ›ã€åˆªé™¤
// --------------------------------------------------
function QuoteManager() {
    const {
        quotes,
        activeQuoteId,
        setActiveQuoteId,
        deleteQuote,
        createQuote, 
    } = React.useContext(AppContext);

    // æ ¹æ“šæ—¥æœŸæ’åºï¼Œè®“æœ€æ–°çš„æ’åœ¨æœ€ä¸Šé¢
    const sortedQuotes = React.useMemo(() => {
        return [...(quotes || [])].sort((a, b) => {
            if (!a.date || !b.date) return 0;
            // æ ¹æ“šæ—¥æœŸæ’åºï¼Œæœ€æ–°æ—¥æœŸæ’å‰é¢
            if (a.date > b.date) return -1;
            if (a.date < b.date) return 1;
            return b.id.localeCompare(a.id); // æ—¥æœŸç›¸åŒå‰‡ç”¨ ID
        });
    }, [quotes]);


    return (
        <div className="mt-4 border-t pt-4"> 
            <h3 className="font-bold text-lg mb-2 text-gray-700">å ±åƒ¹å–®åˆ—è¡¨</h3>

            {/* æ–°å¢å ±åƒ¹å–®æŒ‰éˆ• (å°å‘å»ºç«‹ç©ºç™½å ±åƒ¹å–®) */}
            <button
                className="w-full px-3 py-2 bg-purple-600 text-white rounded mb-4 hover:bg-purple-700 transition"
                onClick={() => createQuote(null)} 
            >
                ï¼‹ å»ºç«‹æ–°å ±åƒ¹å–®
            </button>

            <div className="max-h-80 overflow-y-auto">
            {sortedQuotes.length === 0 && ( 
                <div className="text-gray-500 text-sm text-center">
                    å°šç„¡è³‡æ–™ï¼Œè«‹å…ˆå»ºç«‹å ±åƒ¹å–®
                </div>
            )}

            <div className="flex flex-col gap-1">
                {sortedQuotes.map(q => ( 
                    <div
                        key={q.id}
                        className={`flex items-center justify-between px-3 py-2 rounded cursor-pointer transition
                            ${
                                q.id === activeQuoteId
                                    ? "bg-blue-600 text-white shadow-md"
                                    : "bg-gray-100 hover:bg-gray-200 text-gray-800"
                            }
                        `}
                        onClick={() => setActiveQuoteId(q.id)}
                    >
                        {/* æ–‡å­—å€å¡Šï¼šåŠ å…¥ min-w-0 å…è¨±å£“ç¸®/æˆªæ–· */}
                        <div className="flex flex-col flex-1 min-w-0 mr-2"> 
                            {/* æ¨™é¡Œï¼šç¢ºä¿æˆªæ–· */}
                            <span className="font-semibold truncate text-sm">{q.title || "ç„¡æ¨™é¡Œ"}</span>
                            {/* è³‡è¨Šï¼šè¼ƒå°çš„å­—é«”ï¼Œå…è¨±æ›è¡Œ */}
                            <span className="text-xs opacity-80 whitespace-normal">
                                {q.date || "N/A"} - {q.customerName || "ç„¡å®¢æˆ¶"}
                            </span>
                        </div>

                        {/* æŒ‰éˆ•å€å¡Šï¼šåŠ å…¥ flex-shrink-0 ç¢ºä¿å¯¬åº¦å›ºå®šï¼Œä¸æ“ å£“æ–‡å­— */}
                        <button
                            className={`text-red-600 text-xs ml-2 p-1 font-bold transition flex-shrink-0 
                            ${q.id === activeQuoteId ? "bg-red-500 hover:bg-red-600 text-white" : "hover:text-red-800"}
                            `}
                            onClick={(e) => {
                                e.stopPropagation(); // é¿å…é»åˆ°çˆ¶å±¤
                                if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ä»½å ±åƒ¹å–®ï¼Ÿ")) {
                                    deleteQuote(q.id);
                                }
                            }}
                        >
                            åˆªé™¤
                        </button>
                    </div>
                ))}
            </div>
            </div>
        </div>
    );
}
// P4-2 â€” å ±åƒ¹å–®æŠ¬é ­ï¼šå…¬å¸è³‡è¨Š + å®¢æˆ¶è³‡è¨Šè¼¸å…¥å€
function QuoteEditor() {
    const {
        company,
        activeQuote, 
        updateQuote
    } = React.useContext(AppContext);

    const quote = activeQuote;

    // -------------------------------
    // æ›´æ–°æ¬„ä½
    // -------------------------------
    const update = React.useCallback((field, value) => {
        if (quote) {
            updateQuote(quote.id, { [field]: value });
        }
    }, [quote, updateQuote]); 

    if (!quote) return null;

    const info = COMPANY_DATA[company];

    return (
        <div className="bg-white p-6 shadow rounded mb-6 no-print">

            {/* ---------------- å…¬å¸åç¨± ---------------- */}
            <div className="text-2xl font-bold mb-4 text-blue-800">
                {info.name}
            </div>

            {/* ---------------- å…¬å¸è³‡æ–™ ---------------- */}
            <div className="text-sm text-gray-600 mb-6 border-b pb-4">
                <div>åœ°å€ï¼š{info.address}</div>
                <div>é›»è©±ï¼š{info.tel} | å‚³çœŸï¼š{info.fax}</div>
            </div>

            {/* ---------------- å ±åƒ¹å–®æ¨™é¡Œ & ç·¨è™Ÿ ---------------- */}
            <div className="flex items-end gap-4 mb-6">
                <div className="flex-1">
                    <label className="block text-sm text-gray-600 mb-1">å·¥ç¨‹åç¨±</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.title || ""}
                        onChange={(e) => update("title", e.target.value)}
                    />
                    
                </div>

                <div className="w-48">
                    <label className="block text-sm text-gray-600 mb-1">å ±åƒ¹å–®ç·¨è™Ÿ</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 bg-gray-100"
                        value={quote.quoteNo || ""}
                        readOnly
                    />
                </div>
            </div>

            {/* ---------------- å®¢æˆ¶è³‡è¨Š ---------------- */}
            <div className="grid grid-cols-2 gap-4 mb-6">

                <div>
                    <label className="block text-sm text-gray-600 mb-1">å®¢æˆ¶åç¨±</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.customerName || ""}
                        onChange={(e) => update("customerName", e.target.value)}
                    />
                </div>

                <div>
                    <label className="block text-sm text-gray-600 mb-1">è¯çµ¡äºº</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.contact || ""}
                        onChange={(e) => update("contact", e.target.value)}
                    />
                </div>

                <div>
                    <label className="block text-sm text-gray-600 mb-1">é›»è©±</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.phone || ""}
                        onChange={(e) => update("phone", e.target.value)}
                    />
                </div>

                <div>
                    <label className="block text-sm text-gray-600 mb-1">å ±åƒ¹æ—¥æœŸ</label>
                    <input
                        type="date"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.date || formatDate()}
                        onChange={(e) => update("date", e.target.value)}
                    />
                </div>

                <div className="col-span-2">
                    <label className="block text-sm text-gray-600 mb-1">å·¥ç¨‹åœ°é»</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.location || ""}
                        onChange={(e) => update("location", e.target.value)}
                    />
                </div>
            </div>
        </div>
    );
}

// P4-3ï¼ˆAï¼‰NoteSubItemBlock â€” è£œå……æ–‡å­—
function NoteSubItemBlock({ sub, updateField, deleteSubItem }) {
  return (
    <div className="border rounded p-3 bg-gray-50 mb-2">
      {/* æ¨™é¡Œ + åˆªé™¤ */}
      <div className="flex justify-between items-center mb-2">
        <span className="text-sm font-bold text-gray-700">ğŸ“„ è£œå……æ–‡å­—</span>
        <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>
          åˆªé™¤
        </button>
      </div>

      <textarea
        className="w-full border rounded p-2 text-sm focus:ring focus:ring-yellow-100"
        rows="2"
        value={sub.text || ""}
        onChange={(e) => updateField("text", e.target.value)}
        placeholder="è¼¸å…¥è£œå……èªªæ˜..."
      />
    </div>
  );
}

// P4-3ï¼ˆXï¼‰SpecItemSuggest â€” è¦æ ¼å“è‡ªå‹•å»ºè­°å…ƒä»¶
function SpecItemSuggest({ currentInput, specItems, onSelect, onHide }) {
    
    // è¦æ ¼å“æ¬„ä½çµæ§‹ - V10 ä¿®æ­£: çµ±ä¸€ä½¿ç”¨ Google Sheet æ¬„ä½åç¨±
    const FIELD_MAIN_SPEC = 'å“é …èªªæ˜'; 
    const FIELD_MATERIAL_1 = 'è¦æ ¼1';   
    const FIELD_MATERIAL_2 = 'è¦æ ¼2';   
    const FIELD_MATERIAL_3 = 'è¦æ ¼3';   
    const FIELD_REMARKS = 'å‚™è¨»';       

    // æœå°‹çµæœ
    const filteredItems = React.useMemo(() => {
        const input = (currentInput || "").toLowerCase().trim();

        // è¼¸å…¥ 1 å€‹å­—å…ƒå³é–‹å§‹ç¯©é¸
        if (input.length < 1) return []; 

        return specItems
            .filter(item => 
                // ç¢ºä¿ 'å“å' æ¬„ä½å­˜åœ¨ï¼Œä¸”åŒ…å«è¼¸å…¥çš„é—œéµå­—
                (item['å“å'] && item['å“å'].toLowerCase().includes(input)) ||
                // æ“´å¤§ç¯©é¸ï¼š'å“é …èªªæ˜' (ä¸»æè¿°) ä¹ŸåŒ…å«é—œéµå­—
                (item[FIELD_MAIN_SPEC] && item[FIELD_MAIN_SPEC].toLowerCase().includes(input))
            );
    }, [currentInput, specItems, FIELD_MAIN_SPEC]);

    // å¦‚æœåˆ—è¡¨æ˜¯ç©ºçš„ï¼Œç›´æ¥è¿”å› null
    if (filteredItems.length === 0) return null;

    // è™•ç†é»é¸ï¼šé¸å®Œå¾Œå‘¼å« onSelect è™•ç†æ•¸æ“šï¼Œä¸¦å‘¼å« onHide éš±è—åˆ—è¡¨
    const handleSelect = (item) => {
        onSelect(item);
        onHide(); // é¸å®Œå¾Œå¼·åˆ¶éš±è—åˆ—è¡¨
    };

    return (
        <div className="absolute z-10 top-full left-0 w-full bg-white border border-gray-300 rounded shadow-lg mt-1 max-h-48 overflow-y-auto">
            {filteredItems.map((item, index) => (
                <div
                    key={index}
                    className="p-2 cursor-pointer hover:bg-blue-100 text-sm border-b last:border-b-0"
                    onMouseDown={(e) => { 
                        e.preventDefault(); // é˜²æ­¢ input å¤±å»ç„¦é»
                        handleSelect(item); 
                    }}
                >
                    {/* é¡¯ç¤º å“å, è¦æ ¼, å–®åƒ¹ï¼Œä»¥åˆ©ä½¿ç”¨è€…å€åˆ† */}
                    <div className="font-semibold text-gray-800">{item['å“å']}</div>
                    <div className="text-xs text-gray-600 truncate">
                        è¦æ ¼: {item[FIELD_MAIN_SPEC] || 'ç„¡ä¸»æè¿°'} | è¦æ ¼1: {item[FIELD_MATERIAL_1] || 'ç„¡ç”¨æ–™'} | å–®åƒ¹: {formatMoney(item['å–®åƒ¹'])}
                    </div>
                </div>
            ))}
        </div>
    );
}


// P4-3ï¼ˆBï¼‰ItemSubItemBlock â€” å­é …ç›®ï¼ˆå«æ•¸é‡/å–®åƒ¹ï¼‰
function ItemSubItemBlock({ sub, updateField, deleteSubItem }) {
    const { specItems } = React.useContext(AppContext); 
    
    // è¦æ ¼å“æ¬„ä½çµæ§‹ - V10 ä¿®æ­£: çµ±ä¸€ä½¿ç”¨ Google Sheet æ¬„ä½åç¨±
    const FIELD_MAIN_SPEC = 'å“é …èªªæ˜'; 
    const FIELD_MATERIAL_1 = 'è¦æ ¼1';   
    const FIELD_MATERIAL_2 = 'è¦æ ¼2';   
    const FIELD_MATERIAL_3 = 'è¦æ ¼3';   
    const FIELD_REMARKS = 'å‚™è¨»';       

    const [showSuggest, setShowSuggest] = React.useState(false); 

    // è¨ˆç®—ä¸¦æ ¼å¼åŒ–å°è¨ˆ
    const subtotal = formatMoney(calcAmount(sub));

    // è™•ç†æ•¸å­—è¼¸å…¥
    const handleNumberChange = React.useCallback((field, value) => {
        // åªå…è¨±æ•¸å­—æˆ–ç©ºå­—ä¸²
        if (value === "" || !isNaN(Number(value))) {
            updateField(field, value);
        }
    }, [updateField]);
    
    // è™•ç†è¦æ ¼å“é¸æ“‡ 
    const handleSelectSpecItem = React.useCallback((spec) => {
        
        // ä¿®æ­£é» 1: ç”¨æ–™æ˜ç´° - ç¢ºä¿åªåˆä½µ 'è¦æ ¼1', 'è¦æ ¼2', 'è¦æ ¼3' ä¸”æ¿¾é™¤ç©ºå€¼
        const materialParts = [
            spec[FIELD_MATERIAL_1] || '',
            spec[FIELD_MATERIAL_2] || '',
            spec[FIELD_MATERIAL_3] || ''
        ].filter(p => p.trim() !== ''); 

        const materialSpec = materialParts.join(' / ').trim(); 

        // å¾è¦æ ¼å“æ•¸æ“šè‡ªå‹•å¡«å…¥è¦æ ¼ã€å–®ä½ã€å–®åƒ¹
        updateField("name", spec['å“å'] || sub.name);
        
        // è³‡æ–™æ‹†åˆ†ç²¾ç¢ºå°æ‡‰æ¬„ä½
        updateField("specMain", spec[FIELD_MAIN_SPEC] || ""); // ä¸»è¦æ ¼ (å“é …èªªæ˜)
        updateField("specMaterial", materialSpec); // ç”¨æ–™ 1 2 3 åˆä½µ (ç”¨æ–¼é¡¯ç¤º)
        
        // ä¿®æ­£é» 2: å‚™è¨» - ç¢ºä¿ä½¿ç”¨è¦æ ¼å“è¡¨æ ¼ä¸­çš„ 'å‚™è¨»' æ¬„ä½
        updateField("remarks", spec[FIELD_REMARKS] || ""); // å‚™è¨» (å›æ­¸å ±åƒ¹å–®å‚™è¨»æ¬„)
        
        updateField("unit", spec['å–®ä½'] || sub.unit);
        updateField("price", spec['å–®åƒ¹'] || ""); 
        setShowSuggest(false); // é¸å®Œå¾Œéš±è—åˆ—è¡¨
    }, [updateField, sub.name, sub.unit, FIELD_MAIN_SPEC, FIELD_MATERIAL_1, FIELD_MATERIAL_2, FIELD_MATERIAL_3, FIELD_REMARKS]);

    return (
        <div className="border rounded p-3 bg-gray-50 mb-2">

            {/* æ¨™é¡Œ + åˆªé™¤ */}
            <div className="flex justify-between items-center mb-2">
                <span className="text-sm font-bold text-gray-700">ğŸ“¦ å­é …ç›®</span>
                <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>
                    åˆªé™¤
                </button>
                
            </div>

            {/* ç·¨è¼¯å™¨æ¬„ä½æ’ç‰ˆ */}
            <div className="grid grid-cols-12 gap-2 text-sm items-center relative">

                {/* åç¨± (col-span-3) - **ä½¿ç”¨ SpecItemSuggest** */}
                <div className="col-span-3 relative">
                    <input
                        className="border p-1 rounded w-full focus:ring focus:ring-blue-100"
                        value={sub.name || ""}
                        placeholder="åç¨±"
                        onChange={(e) => {
                            updateField("name", e.target.value);
                            setShowSuggest(true); 
                        }}
                        onBlur={() => setTimeout(() => setShowSuggest(false), 200)} 
                        onFocus={() => (sub.name || "").length >= 1 && setShowSuggest(true)} 
                    />
                    
                    {/* åªæœ‰åœ¨ showSuggest ç‚º true ä¸”è¼¸å…¥å­—æ•¸æ»¿è¶³æ¢ä»¶æ™‚æ‰æ¸²æŸ“ */}
                    {(sub.name || "").length >= 1 && showSuggest && (
                        <SpecItemSuggest 
                            currentInput={sub.name} 
                            specItems={specItems} 
                            onSelect={handleSelectSpecItem}
                            onHide={() => setShowSuggest(false)} 
                        />
                    )}
                </div>

                {/* è¦æ ¼ (col-span-2) */}
                <input
                    className="border p-1 rounded col-span-2 focus:ring focus:ring-blue-100" 
                    value={sub.specMain || ""}
                    placeholder="è¦æ ¼ (ä¸»æè¿°)"
                    onChange={(e) => updateField("specMain", e.target.value)}
                />

                {/* å–®ä½ (col-span-1) */}
                <input
                    className="border p-1 rounded col-span-1 text-center focus:ring focus:ring-blue-100"
                    value={sub.unit || ""}
                    placeholder="å–®ä½"
                    onChange={(e) => updateField("unit", e.target.value)}
                />

                {/* æ•¸é‡ (col-span-1) */}
                <input
                    className="border p-1 rounded col-span-1 text-center focus:ring focus:ring-blue-100"
                    value={sub.qty || ""}
                    placeholder="æ•¸é‡"
                    type="number"
                    min="0"
                    onChange={(e) => handleNumberChange("qty", e.target.value)}
                />

                {/* å–®åƒ¹ (col-span-1) */}
                <input
                    className="border p-1 rounded col-span-1 text-right focus:ring focus:ring-blue-100" 
                    value={sub.price || ""}
                    placeholder="å–®åƒ¹"
                    type="number"
                    min="0"
                    onChange={(e) => handleNumberChange("price", e.target.value)}
                />

                {/* å‚™è¨» (col-span-2) - NEW */}
                <input
                    className="border p-1 rounded col-span-2 focus:ring focus:ring-blue-100"
                    value={sub.remarks || ""}
                    placeholder="å‚™è¨»"
                    onChange={(e) => updateField("remarks", e.target.value)}
                />

                {/* å°è¨ˆ (col-span-1) */}
                <div className="col-span-1 text-right font-bold text-blue-600">
                    {subtotal}
                </div>
            </div>

            {/* ğŸ¯ ç”¨æ–™æ˜ç´°å°ˆå±¬é¡¯ç¤ºå€ */}
            {(sub.specMaterial || "").length > 0 && (
                <div className="mt-1 ml-4 text-xs text-gray-500 italic border-t pt-1">
                    **ç”¨æ–™æ˜ç´°**: {sub.specMaterial}
                </div>
            )}
        </div>
    );
}


// P4-3ï¼ˆCï¼‰ImageSubItemBlock â€” åœ–ç‰‡å°é …
function ImageSubItemBlock({ sub, updateField, deleteSubItem }) {
    // åœ–ç‰‡ä¸Šå‚³è™•ç†
    function handleUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => updateField("src", reader.result);
        reader.readAsDataURL(file);
        e.target.value = ''; // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥ï¼Œä»¥ä¾¿é‡æ–°é¸æ“‡åŒä¸€æª”æ¡ˆ
    }

    return (
        <div className="border rounded p-3 bg-gray-50 mb-2">

            <div className="flex justify-between items-center mb-2">
                <span className="text-sm font-bold text-gray-700">ğŸ“· åœ–ç‰‡è£œå……</span>
                <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>åˆªé™¤</button>
            </div>

            {/*åœ–ç‰‡é è¦½*/}
            {sub.src ? (
                <img src={sub.src} className="max-w-xs mb-2 border rounded shadow" alt="é è¦½åœ–" />
            ) : (
                <div className="text-gray-500 text-sm mb-2 p-2 border border-dashed rounded bg-white">å°šæœªä¸Šå‚³åœ–ç‰‡</div>
            )}

            {/* ä¸Šå‚³æŒ‰éˆ• */}
            <label className="cursor-pointer text-blue-700 underline text-sm hover:text-blue-900">
                {sub.src ? "æ›´æ›åœ–ç‰‡" : "ä¸Šå‚³åœ–ç‰‡"}
                <input type="file" accept="image/*" className="hidden" onChange={handleUpload} />
            </label>
        </div>
    );
}


// P4-3ï¼ˆDï¼‰UploadImageButton â€” åœ¨åº•éƒ¨æ–°å¢åœ–ç‰‡ç”¨
function UploadImageButton({ onUpload }) {
    // åœ–ç‰‡ä¸Šå‚³è™•ç† 
    function handleSelect(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => onUpload(reader.result);
        reader.readAsDataURL(file);
        e.target.value = ''; // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥ï¼Œä»¥ä¾¿é‡æ–°é¸æ“‡åŒä¸€æª”æ¡ˆ
    }

    return (
        <label className="cursor-pointer text-blue-600 hover:text-blue-800 transition">
            ï¼‹è£œå……åœ–ç‰‡
            <input type="file" accept="image/*" className="hidden" onChange={handleSelect} />
        </label>
    );
}


// P4-3ï¼ˆEï¼‰SubItemWrapper â€” è‡ªå‹•åˆ†æµå°é …é¡å‹
function SubItemWrapper({ subItem, parentItem, quote, updateQuote }) {

    // æ›´æ–°æŸå€‹ subItem çš„ç‰¹å®šæ¬„ä½ 
    const updateField = React.useCallback((field, value) => {
        const newItems = quote.items.map(m =>
            m.id === parentItem.id
                ? {
                    ...m,
                    // ç¢ºä¿ subItems å­˜åœ¨
                    subItems: (m.subItems || []).map(s =>
                        s.id === subItem.id ? { ...s, [field]: value } : s
                    )
                }
                : m
        );
        updateQuote(quote.id, { items: newItems });
    }, [quote.id, parentItem.id, subItem.id, quote.items, updateQuote]);

    // åˆªé™¤ subItem 
    const deleteSubItem = React.useCallback(() => {
        const newItems = quote.items.map(m =>
            m.id === parentItem.id
                ? { ...m, subItems: (m.subItems || []).filter(s => s.id !== subItem.id) }
                : m
        );
        updateQuote(quote.id, { items: newItems });
    }, [quote.id, parentItem.id, subItem.id, quote.items, updateQuote]);

    const props = { sub: subItem, updateField, deleteSubItem };

    if (subItem.type === "note") return <NoteSubItemBlock {...props} />;
    if (subItem.type === "item") return <ItemSubItemBlock {...props} />;
    if (subItem.type === "image") return <ImageSubItemBlock {...props} />;

    return null;
}


// P4-3ï¼ˆFï¼‰MainItemBlock â€” å¤§é …ç·¨è¼¯ 
function MainItemBlock({ item, quote, updateQuote, index }) { // æ¥æ”¶ index å±¬æ€§
    const { specItems } = React.useContext(AppContext);
    
    // è¦æ ¼å“æ¬„ä½çµæ§‹ - V10 ä¿®æ­£: çµ±ä¸€ä½¿ç”¨ Google Sheet æ¬„ä½åç¨±
    const FIELD_MAIN_SPEC = 'å“é …èªªæ˜'; 
    const FIELD_MATERIAL_1 = 'è¦æ ¼1';   
    const FIELD_MATERIAL_2 = 'è¦æ ¼2';   
    const FIELD_MATERIAL_3 = 'è¦æ ¼3';   
    const FIELD_REMARKS = 'å‚™è¨»';       

    const [showSuggest, setShowSuggest] = React.useState(false); 

    // 1. æ›´æ–°å¤§é …è³‡æ–™ 
    const update = React.useCallback((data) => {
        const newItems = quote.items.map(m =>
            m.id === item.id ? { ...m, ...data } : m
        );
        updateQuote(quote.id, { items: newItems });
    }, [quote.id, item.id, quote.items, updateQuote]);

    // 2. è™•ç†æ•¸å­—è¼¸å…¥ 
    const handleNumberChange = React.useCallback((field, value) => {
        if (value === "" || !isNaN(Number(value))) {
            update({ [field]: value });
        }
    }, [update]);

    // 3. åˆªé™¤å¤§é … 
    const deleteMain = React.useCallback(() => {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å¤§é …ï¼Ÿ")) return;
        updateQuote(quote.id, { items: quote.items.filter(m => m.id !== item.id) });
    }, [quote.id, item.id, quote.items, updateQuote]);

    // 4. æ–°å¢å°é … 
    const addSub = React.useCallback((type, src = "") => {
        const newSub = {
            id: uuid(),
            type,
            text: "",
            name: "",
            // å­é …ç›®è¦æ ¼æ¬„ä½
            specMain: "", 
            specMaterial: "",
            remarks: "",
            unit: "",
            qty: "",
            price: "",
            src
        };

        const newItems = quote.items.map(m =>
            m.id === item.id ? { ...m, subItems: [...(m.subItems || []), newSub] } : m
        );

        updateQuote(quote.id, { items: newItems });
    }, [quote.id, item.id, quote.items, updateQuote]);

    // è™•ç†è¦æ ¼å“é¸æ“‡ 
    const handleSelectSpecItem = React.useCallback((spec) => {
        
        // ä¿®æ­£é» 1: ç”¨æ–™æ˜ç´° - ç¢ºä¿åªåˆä½µ 'è¦æ ¼1', 'è¦æ ¼2', 'è¦æ ¼3' ä¸”æ¿¾é™¤ç©ºå€¼
        const materialParts = [
            spec[FIELD_MATERIAL_1] || '',
            spec[FIELD_MATERIAL_2] || '',
            spec[FIELD_MATERIAL_3] || ''
        ].filter(p => p.trim() !== ''); 

        const materialSpec = materialParts.join(' / ').trim(); 

        // å¾è¦æ ¼å“æ•¸æ“šè‡ªå‹•å¡«å…¥è¦æ ¼ã€å–®ä½ã€å–®åƒ¹
        update({
            name: spec['å“å'] || item.name,
            
            // è³‡æ–™æ‹†åˆ†ç²¾ç¢ºå°æ‡‰æ¬„ä½
            specMain: spec[FIELD_MAIN_SPEC] || "", // ä¸»è¦æ ¼ (å“é …èªªæ˜)
            specMaterial: materialSpec, // ç”¨æ–™ 1 2 3 åˆä½µ (ç”¨æ–¼é¡¯ç¤º)
            
            // ä¿®æ­£é» 2: å‚™è¨» - ç¢ºä¿ä½¿ç”¨è¦æ ¼å“è¡¨æ ¼ä¸­çš„ 'å‚™è¨»' æ¬„ä½
            remarks: spec[FIELD_REMARKS] || "", // å‚™è¨» (å›æ­¸å ±åƒ¹å–®å‚™è¨»æ¬„)
            
            unit: spec['å–®ä½'] || item.unit,
            price: spec['å–®åƒ¹'] || "", 
        });
        setShowSuggest(false);
    }, [update, item.name, item.unit, FIELD_MAIN_SPEC, FIELD_MATERIAL_1, FIELD_MATERIAL_2, FIELD_MATERIAL_3, FIELD_REMARKS]);

    const mainTotal = formatMoney(calcAmount(item));

    return (
        <div className="border rounded p-4 bg-white shadow mb-4">

            {/* VVVV æ¨™é¡Œè¡Œ VVVV */}
            {/* 3 (å“å) | 2 (è¦æ ¼) | 1 (å–®ä½) | 1 (æ•¸é‡) | 1 (å–®åƒ¹) | 2 (å‚™è¨») | 1 (å°è¨ˆ) | 1 (åˆªé™¤) = 12 columns */}
            <div className="grid grid-cols-12 gap-2 text-sm font-bold text-gray-600 mb-2 border-b pb-1">
                <div className="col-span-3 text-left flex items-center">
                    <span className="mr-1 text-red-500">({index})</span> å“å
                </div>
                <div className="col-span-2 text-left">è¦æ ¼ (ä¸»æè¿°)</div> 
                <div className="col-span-1 text-center">å–®ä½</div>
                <div className="col-span-1 text-center">æ•¸é‡</div> {/* ç·¨è¼¯å€ä¹Ÿç½®ä¸­ */}
                <div className="col-span-1 text-right">å–®åƒ¹</div> 
                <div className="col-span-2 text-left">å‚™è¨»</div> 
                <div className="col-span-1 text-right">å°è¨ˆ</div> 
                <div className="col-span-1"></div>
            </div>

            {/* å¤§é …è³‡æ–™åˆ— */}
            <div className="grid grid-cols-12 gap-2 items-center">
                {/* å“å (col-span-3) - **ä½¿ç”¨ SpecItemSuggest** */}
                <div className="col-span-3 relative">
                    <input className="border p-1 rounded w-full focus:ring focus:ring-red-100 text-left"
                        value={item.name || ""} placeholder="å“å"
                        onChange={(e) => {
                            update({ name: e.target.value });
                            setShowSuggest(true);
                        }} 
                        onBlur={() => {
                            // å»¶é²éš±è—ï¼Œçµ¦äºˆæ™‚é–“é»æ“Šå»ºè­°åˆ—è¡¨
                            setTimeout(() => setShowSuggest(false), 200); 
                        }}
                        onFocus={() => {
                            if ((item.name || "").length >= 1) { 
                                setShowSuggest(true);
                            }
                        }}
                    />
                    
                    {(item.name || "").length >= 1 && showSuggest && (
                        <SpecItemSuggest 
                            currentInput={item.name} 
                            specItems={specItems} 
                            onSelect={handleSelectSpecItem}
                            onHide={() => setShowSuggest(false)} 
                        />
                    )}
                </div>
                {/* è¦æ ¼ (col-span-2) - ä½¿ç”¨ item.specMain */}
                <input className="border p-1 rounded col-span-2 focus:ring focus:ring-red-100 text-left"
                    value={item.specMain || ""} placeholder="è¦æ ¼ (ä¸»æè¿°)"
                    onChange={(e) => update({ specMain: e.target.value })} />
                {/* å–®ä½ (col-span-1) */}
                <input className="border p-1 rounded col-span-1 text-center focus:ring focus:ring-red-100"
                    value={item.unit || ""} placeholder="å–®ä½"
                    onChange={(e) => update({ unit: e.target.value })} />
                {/* æ•¸é‡ (col-span-1) */}
                <input className="border p-1 rounded col-span-1 text-center focus:ring focus:ring-red-100" // ç·¨è¼¯å€æ•¸é‡ç½®ä¸­
                    value={item.qty || ""} placeholder="æ•¸é‡"
                    type="number" min="0"
                    onChange={(e) => handleNumberChange("qty", e.target.value)} />
                {/* å–®åƒ¹ (col-span-1) */}
                <input className="border p-1 rounded col-span-1 text-right focus:ring focus:ring-red-100"
                    value={item.price || ""} placeholder="å–®åƒ¹"
                    type="number" min="0"
                    onChange={(e) => handleNumberChange("price", e.target.value)} />
                
                {/* å‚™è¨» (col-span-2) - ä½¿ç”¨ item.remarks */}
                <input className="border p-1 rounded col-span-2 focus:ring focus:ring-red-100 text-left"
                    value={item.remarks || ""} placeholder="å‚™è¨»"
                    onChange={(e) => update({ remarks: e.target.value })} />

                {/* å°è¨ˆ (col-span-1) */}
                <div className="text-right font-bold col-span-1 text-red-700">
                    {mainTotal}
                </div>
                {/* åˆªé™¤æŒ‰éˆ• (col-span-1) */}
                <button className="text-red-600 col-span-1 text-sm hover:text-red-800" onClick={deleteMain}>
                    âœ•
                </button>
            </div>
            
            {/* ğŸ¯ ç”¨æ–™æ˜ç´°å°ˆå±¬é¡¯ç¤ºå€ (åƒ…ç·¨è¼¯å€) */}
            {(item.specMaterial || "").length > 0 && (
                <div className="mt-1 ml-4 text-xs text-gray-500 italic border-t pt-1">
                    **ç”¨æ–™æ˜ç´°**: {item.specMaterial}
                </div>
            )}

            {/* å°é …åˆ—è¡¨ */}
            <div className="mt-3 border-t pt-3">
                {(item.subItems || []).map(sub => (
                    <SubItemWrapper
                        key={sub.id} 
                        subItem={sub}
                        parentItem={item}
                        quote={quote}
                        updateQuote={updateQuote}
                    />
                ))}
            </div>

            {/* æ“ä½œåˆ— */}
            <div className="flex gap-4 mt-3 text-blue-600 text-sm border-t pt-3">
                <button className="hover:text-blue-800 transition" onClick={() => addSub("item")}>ï¼‹ å­é …ç›®</button>
                <button className="hover:text-blue-800 transition" onClick={() => addSub("note")}>ï¼‹ è£œå……æ–‡å­—</button>
                <UploadImageButton onUpload={(src) => addSub("image", src)} />
            </div>
        </div>
    );
}
// P4-3ï¼ˆGï¼‰Items
function ItemsEditor() {
    const { activeQuote, updateQuote } = React.useContext(AppContext);

    // 1. æ–°å¢å¤§é …
    const addItem = React.useCallback(() => {
        if (!activeQuote) return;
        
        const newItem = {
            id: uuid(),
            name: "æœªå‘½åå¤§é …",
            unit: "",
            qty: "",
            price: "",
            subItems: [],
            // é …ç›®è¦æ ¼æ¬„ä½
            specMain: "", 
            specMaterial: "",
            remarks: ""
        };

        updateQuote(activeQuote.id, { items: [...(activeQuote.items || []), newItem] });
    }, [activeQuote, updateQuote]);

    if (!activeQuote) return null;

    return (
        <div className="bg-white p-6 shadow rounded mb-6 no-print">
            <h3 className="text-xl font-bold mb-4 border-b pb-2 text-gray-700">å ±åƒ¹é …ç›®åˆ—è¡¨</h3>

            {/* æ–°å¢å¤§é …æŒ‰éˆ• */}
            <button
                className="bg-blue-600 text-white px-4 py-2 rounded mb-4 hover:bg-blue-700 transition"
                onClick={addItem}
            >
                ï¼‹ æ–°å¢å·¥ç¨‹å¤§é …
            </button>

            {/* é …ç›®åˆ—è¡¨ */}
            <div>
                {(activeQuote.items || []).map((item, index) => (
                    <MainItemBlock 
                        key={item.id} 
                        item={item} 
                        quote={activeQuote} 
                        updateQuote={updateQuote} 
                        index={index + 1} // å‚³éç·¨è™Ÿ
                    />
                ))}

                {activeQuote.items.length === 0 && (
                    <div className="text-gray-500 p-4 border rounded bg-gray-50 text-center">
                        è«‹é»é¸ä¸Šæ–¹æŒ‰éˆ•æ–°å¢å ±åƒ¹é …ç›®
                    </div>
                )}
            </div>
        </div>
    );
}
// P4-4 â€” å‚™è¨»/ä»˜æ¬¾æ¢ä»¶/æŠ˜æ‰£/ç¸½è¨ˆ

function NoteAndTotalEditor() {
    const { activeQuote, updateQuote, applyMode } = React.useContext(AppContext);

    if (!activeQuote) return null;

    // è¨ˆç®—ç¸½åƒ¹
    const total = calcTotal(activeQuote.items || []);
    
    // è¨ˆç®—è­°åƒ¹å¾Œåƒ¹æ ¼
    const negotiated = calcNegotiated(
        total, 
        activeQuote.discountPercent, 
        activeQuote.negotiatedPrice
    );

    // -------------------------------
    // æ›´æ–°æ¬„ä½
    // -------------------------------
    const update = React.useCallback((field, value) => {
        if (activeQuote) {
            updateQuote(activeQuote.id, { [field]: value });
        }
    }, [activeQuote, updateQuote]); 

    // è™•ç†æ•¸å­—è¼¸å…¥ (æŠ˜æ‰£%)
    const handleDiscountChange = React.useCallback((value) => {
        if (value === "" || (!isNaN(Number(value)) && Number(value) >= 0 && Number(value) <= 100)) {
            update("discountPercent", value);
            // æ¸…ç©ºè­°åƒ¹åƒ¹æ ¼
            update("negotiatedPrice", 0); 
        }
    }, [update]);
    
    // è™•ç†è­°åƒ¹åƒ¹æ ¼è¼¸å…¥
    const handleNegotiatedPriceChange = React.useCallback((value) => {
        if (value === "" || !isNaN(Number(value))) {
            update("negotiatedPrice", value);
            // æ¸…ç©ºæŠ˜æ‰£
            update("discountPercent", 0); 
        }
    }, [update]);


    return (
        <div className="bg-white p-6 shadow rounded mb-6 no-print">
            <h3 className="text-xl font-bold mb-4 border-b pb-2 text-gray-700">å…¶ä»–è³‡è¨Š</h3>

            {/* å‚™è¨»èˆ‡ä»˜æ¬¾æ¢ä»¶ */}
            <div className="grid grid-cols-2 gap-6 mb-6">
                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">å‚™è¨» (ä¸å«ç¨…)</label>
                    <textarea
                        className="w-full border rounded p-3 focus:ring-2 focus:ring-blue-300"
                        rows="8"
                        value={activeQuote.notes || DEFAULT_NOTES}
                        onChange={(e) => update("notes", e.target.value)}
                    />
                </div>

                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">ä»˜æ¬¾æ¢ä»¶</label>
                    <textarea
                        className="w-full border rounded p-3 focus:ring-2 focus:ring-blue-300"
                        rows="8"
                        value={activeQuote.payment || DEFAULT_PAYMENT}
                        onChange={(e) => update("payment", e.target.value)}
                    />
                </div>
            </div>

            {/* ç¸½è¨ˆèˆ‡æŠ˜æ‰£/è­°åƒ¹ */}
            <div className="border-t pt-4">
                <div className="flex justify-end items-center mb-2">
                    <span className="font-bold text-lg mr-4">ç¸½è¨ˆé‡‘é¡ (æœªç¨…):</span>
                    <span className="text-red-700 text-2xl font-extrabold">
                        NT$ {formatMoney(total)}
                    </span>
                </div>

                {/* æŠ˜æ‰£ / è­°åƒ¹æ¬„ä½ */}
                <div className="flex justify-end items-center gap-4 mt-2">
                    
                    {/* æŠ˜æ‰£ç™¾åˆ†æ¯” */}
                    <div className="flex items-center">
                        <label className="text-sm font-bold mr-2">æŠ˜æ‰£ (%):</label>
                        <input
                            type="number"
                            min="0"
                            max="100"
                            step="1"
                            className="w-20 border rounded px-2 py-1 text-right focus:ring focus:ring-yellow-300"
                            value={activeQuote.discountPercent || 0}
                            onChange={(e) => handleDiscountChange(e.target.value)}
                        />
                    </div>
                    
                    <span className="text-gray-400">æˆ–</span>

                    {/* è­°åƒ¹å¾Œåƒ¹æ ¼ (è‡ªå®šç¾©) */}
                    <div className="flex items-center">
                        <label className="text-sm font-bold mr-2">è­°åƒ¹å¾Œåƒ¹æ ¼ (è‡ªå®šç¾©):</label>
                        <input
                            type="number"
                            min="0"
                            className="w-32 border rounded px-2 py-1 text-right focus:ring focus:ring-yellow-300"
                            value={activeQuote.negotiatedPrice || 0}
                            onChange={(e) => handleNegotiatedPriceChange(e.target.value)}
                        />
                    </div>
                </div>


                {/* è­°åƒ¹å¾Œç¸½åƒ¹ */}
                <div className="flex justify-end items-center mt-4 border-t pt-4">
                    <span className="font-bold text-xl mr-4 text-blue-800">æœ€çµ‚å ±åƒ¹é‡‘é¡ (æœªç¨…):</span>
                    <span className="text-blue-700 text-3xl font-extrabold">
                        NT$ {formatMoney(negotiated)}
                    </span>
                </div>
            </div>

            {/* æ¨¡å¼å¥—ç”¨åŠŸèƒ½ (è‹¥å ±åƒ¹å–®é …ç›®ç‚ºç©º) */}
            {(activeQuote.items || []).length === 0 && (
                <div className="mt-6 border-t pt-4">
                    <h4 className="font-bold text-md mb-2">å¿«é€Ÿå¥—ç”¨å ±åƒ¹æ¨¡å¼ï¼š</h4>
                    <div className="flex flex-wrap gap-2">
                        {QUOTE_MODES.map(mode => (
                            <button
                                key={`apply-${mode.id}`}
                                className="px-3 py-1 text-sm bg-purple-100 border border-purple-300 rounded hover:bg-purple-200"
                                onClick={() => applyMode(mode.id)}
                            >
                                å¥—ç”¨ {mode.name}
                            </button>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
}

// P4-5 â€” æ“ä½œæŒ‰éˆ•ï¼šåˆ—å°/Excel åŒ¯å‡º

function PrintButton() {
    const { activeQuote, company } = React.useContext(AppContext);

    const handlePrint = React.useCallback(() => {
        if (!activeQuote) return;

        // æª¢æŸ¥ ReactDOMServer æ˜¯å¦å·²è¼‰å…¥ (V12 ä¿®æ­£ï¼šç¢ºä¿è¼‰å…¥)
        if (typeof ReactDOMServer === 'undefined' || !ReactDOMServer.renderToString) {
            alert("åˆ—å°å¤±æ•—ï¼šReactDOMServer æ¨¡çµ„å°šæœªæº–å‚™å¥½ã€‚è«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥ç¶²é æ˜¯å¦è¼‰å…¥å®Œæ•´ã€‚");
            return;
        }

        // 1. å–å¾—ç›®æ¨™å€å¡Š
        const previewArea = document.getElementById("quotePreviewArea");
        
        // 2. ä½¿ç”¨éœæ…‹æ¸²æŸ“ç”Ÿæˆ HTML å­—ä¸²
        let printHtml = '';
        try {
            // åœ¨ PrintLayout ä¸­ä½¿ç”¨ activeQuote å’Œ company æ•¸æ“š
            printHtml = ReactDOMServer.renderToString(
                <PrintLayout quote={activeQuote} company={company} />
            );
        } catch (error) {
            console.error("éœæ…‹æ¸²æŸ“ PrintLayout å¤±æ•—:", error);
            alert("åˆ—å°å¤±æ•—ï¼šå ±åƒ¹å–®é è¦½å…§å®¹ç”ŸæˆéŒ¯èª¤ã€‚");
            return;
        }

        // 3. æ³¨å…¥ç”Ÿæˆçš„ HTML
        previewArea.innerHTML = printHtml;
        
        // 4. è§¸ç™¼åˆ—å°
        window.print();
        
        // 5. æ¸…é™¤é è¦½å€å…§å®¹ (é¿å…æŒçºŒä½”ç”¨è¨˜æ†¶é«”ï¼Œæˆ–é¡¯ç¤ºåœ¨éåˆ—å°æ¨¡å¼ä¸‹)
        // è¨»ï¼šå› ç‚º CSS @media print å·²ç¶“éš±è— #rootï¼Œåªé¡¯ç¤º #quotePreviewAreaï¼Œæ‰€ä»¥ä¸æ¸…é™¤ä¹Ÿå¯ä»¥
        // previewArea.innerHTML = '/* PrintLayout Component å°‡æœƒåœ¨é€™è£¡è¢«æ¸²æŸ“ï¼Œç„¶å¾Œåˆ—å° */'; 

    }, [activeQuote, company]);

    return (
        <button
            className="w-full bg-red-600 text-white px-4 py-3 rounded text-lg font-bold hover:bg-red-700 transition shadow-lg mb-4"
            onClick={handlePrint}
        >
            ğŸ–¨ï¸ åˆ—å°å ±åƒ¹å–® (PDF)
        </button>
    );
}


function ExportExcelButton() {
    const { activeQuote } = React.useContext(AppContext);

    const handleExport = () => {
        if (!activeQuote || activeQuote.items.length === 0) {
            alert("è«‹å…ˆå»ºç«‹å ±åƒ¹é …ç›®å†åŒ¯å‡º Excelã€‚");
            return;
        }

        const data = activeQuote.items.flatMap((mainItem, index) => {
            const mainData = [
                index + 1, // ç·¨è™Ÿ
                mainItem.name,
                mainItem.specMain,
                mainItem.unit,
                mainItem.qty,
                mainItem.price,
                calcAmount(mainItem),
                mainItem.remarks,
                mainItem.specMaterial // ç”¨æ–™æ˜ç´°
            ];

            // ç¢ºä¿ subItems ä¹Ÿæ˜¯ item é¡å‹æ‰åŒ…å«é‡‘é¡
            const subData = (mainItem.subItems || [])
                .filter(sub => sub.type === 'item')
                .map(sub => ([
                    `  -`, // å­é …ç›®ä¸è¨ˆå…¥ç·¨è™Ÿ
                    sub.name,
                    sub.specMain,
                    sub.unit,
                    sub.qty,
                    sub.price,
                    calcAmount(sub),
                    sub.remarks,
                    sub.specMaterial
                ]));
            
            // è£œå……æ–‡å­—å’Œåœ–ç‰‡ä¸åŒ¯å‡ºåˆ° Excel
            
            return [mainData, ...subData];
        });
        
        // æ¨™é ­
        const header = [
            "é …æ¬¡", "å“å", "è¦æ ¼(ä¸»æè¿°)", "å–®ä½", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆé‡‘é¡", "å‚™è¨»", "ç”¨æ–™æ˜ç´°"
        ];
        
        const wsData = [
            // å ±åƒ¹å–®è³‡è¨Š
            ["å·¥ç¨‹åç¨±", activeQuote.title],
            ["å ±åƒ¹å–®è™Ÿ", activeQuote.quoteNo],
            ["å®¢æˆ¶åç¨±", activeQuote.customerName],
            ["è¯çµ¡äºº", activeQuote.contact],
            ["å ±åƒ¹æ—¥æœŸ", activeQuote.date],
            [], // ç©ºè¡Œ
            
            // é …ç›®åˆ—è¡¨
            header,
            ...data
        ];
        
        // è¨ˆç®—ç¸½è¨ˆ
        const total = calcTotal(activeQuote.items || []);
        const negotiated = calcNegotiated(total, activeQuote.discountPercent, activeQuote.negotiatedPrice);

        wsData.push([]);
        wsData.push(["ç¸½è¨ˆé‡‘é¡ (æœªç¨…)", "", "", "", "", "", total]);
        if (activeQuote.discountPercent > 0) {
            wsData.push([`æŠ˜æ‰£ (${activeQuote.discountPercent}%)`, "", "", "", "", "", total - negotiated]);
        }
        if (activeQuote.negotiatedPrice > 0) {
             wsData.push(["è­°åƒ¹å¾Œåƒ¹æ ¼ (è‡ªå®šç¾©)", "", "", "", "", "", activeQuote.negotiatedPrice]);
        }
        wsData.push(["æœ€çµ‚å ±åƒ¹é‡‘é¡ (æœªç¨…)", "", "", "", "", "", negotiated]);


        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å–®å…§å®¹");
        
        const fileName = `${activeQuote.title || "å ±åƒ¹å–®"}_${activeQuote.quoteNo}.xlsx`;
        XLSX.writeFile(wb, fileName);
    };

    return (
        <button
            className="w-full bg-green-600 text-white px-4 py-3 rounded text-lg font-bold hover:bg-green-700 transition shadow-lg"
            onClick={handleExport}
        >
            ğŸ“¥ åŒ¯å‡º Excel (XLSX)
        </button>
    );
}


// P5 â€” åˆ—å°ç‰ˆé¢å…ƒä»¶ (PrintLayout)

const PrintLayout = ({ quote, company }) => {
    if (!quote) return null;

    const companyInfo = COMPANY_DATA[company];
    const total = calcTotal(quote.items || []);
    const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);
    
    // ç¸½åƒ¹å¤§å¯«è½‰æ› (ç°¡åŒ–ï¼Œåƒ…ç‚ºç¯„ä¾‹ï¼Œå¯¦éš›éœ€æ›´å®Œæ•´çš„å‡½å¼)
    // è¨»ï¼šé€™éƒ¨åˆ†åªåœ¨ PrintLayout å…§ï¼Œä¸å½±éŸ¿å…¶ä»–åœ°æ–¹
    const chineseTotal = `NT$ ${formatMoney(negotiated)}`;


    return (
        <div className="print-page">

            {/* A. é é¦–/å…¬å¸è³‡è¨Š */}
            <div className="print-header mb-4">
                {/* å…¬å¸åç¨± */}
                <h1 className="text-3xl font-bold text-center mb-1">{companyInfo.name}</h1>
                <div className="text-center text-xs mb-4">
                    çµ±ä¸€ç·¨è™Ÿ: {company === 'herhsin' ? '81619865' : '53896738'} 
                    | é›»è©±: {companyInfo.tel} | å‚³çœŸ: {companyInfo.fax} 
                    | Email: {companyInfo.email}
                </div>
                
                <h2 className="text-2xl font-extrabold text-center mb-4 border-b-2 border-t-2 border-black py-1">
                    å·¥ç¨‹å ±åƒ¹å–®
                </h2>
            </div>

            {/* B. å®¢æˆ¶èˆ‡å ±åƒ¹è³‡è¨Šè¡¨æ ¼ (V13 æ¡†ç·šä¿®æ­£) */}
            <table className="print-info-table mb-4">
                <tbody>
                    <tr>
                        <td className="print-info-label">å®¢æˆ¶åç¨±</td>
                        <td>{quote.customerName}</td>
                        <td className="print-info-label">è¯çµ¡äºº</td>
                        <td>{quote.contact}</td>
                    </tr>
                    <tr>
                        <td className="print-info-label">å·¥ç¨‹åç¨±</td>
                        <td colSpan="3">{quote.title}</td>
                    </tr>
                    <tr>
                        <td className="print-info-label">å·¥ç¨‹åœ°é»</td>
                        <td>{quote.location}</td>
                        <td className="print-info-label">å ±åƒ¹æ—¥æœŸ</td>
                        <td>{quote.date}</td>
                    </tr>
                    <tr>
                        <td className="print-info-label">å ±åƒ¹å–®è™Ÿ</td>
                        <td>{quote.quoteNo}</td>
                        <td className="print-info-label">é›»è©±</td>
                        <td>{quote.phone}</td>
                    </tr>
                </tbody>
            </table>

            {/* C. å ±åƒ¹é …ç›®è¡¨æ ¼ (V13 æ¡†ç·šèˆ‡æ•¸é‡ç½®ä¸­ä¿®æ­£) */}
            <table className="print-items-table">
                <thead>
                    <tr>
                        <th style={{ width: '5%' }}>é …æ¬¡</th>
                        <th style={{ width: '20%' }}>å“å</th>
                        <th style={{ width: '25%' }}>è¦æ ¼ / ç”¨æ–™æ˜ç´°</th> {/* åˆä½µè¦æ ¼èˆ‡ç”¨æ–™ */}
                        <th style={{ width: '8%' }}>å–®ä½</th>
                        <th style={{ width: '8%' }}>æ•¸é‡</th>
                        <th style={{ width: '10%' }}>å–®åƒ¹</th>
                        <th style={{ width: '12%' }}>é‡‘é¡ (å°è¨ˆ)</th>
                        <th style={{ width: '12%' }}>å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody>
                    {/* ä¸»è¦é …ç›® */}
                    {(quote.items || []).map((item, index) => {
                        
                        // è¦æ ¼/ç”¨æ–™åˆä½µ
                        const specAndMaterial = [
                            (item.specMain || "").trim(),
                            (item.specMaterial || "").trim().length > 0 
                                ? `ç”¨æ–™æ˜ç´°: ${item.specMaterial.trim()}`
                                : ""
                        ].filter(s => s.length > 0).join('\n');
                        
                        // ä¸»é …è³‡æ–™åˆ—
                        const mainRow = (
                            <tr key={item.id} className="font-bold">
                                <td className="text-center">{index + 1}</td>
                                <td>{item.name}</td>
                                <td>{specAndMaterial || item.name}</td> {/* é¡¯ç¤ºåˆä½µå¾Œçš„è¦æ ¼/ç”¨æ–™ï¼Œè‹¥ç„¡å‰‡é¡¯ç¤ºå“å */}
                                <td className="text-center">{item.unit}</td>
                                <td>{formatMoney(item.qty)}</td>
                                <td>{formatMoney(item.price)}</td>
                                <td>{formatMoney(calcAmount(item))}</td>
                                <td>{item.remarks}</td>
                            </tr>
                        );
                        
                        // å­é …è³‡æ–™åˆ—
                        const subRows = (item.subItems || []).map(sub => {
                            
                            if (sub.type === 'note') {
                                return (
                                    <tr key={sub.id} className="text-gray-600 italic text-xs">
                                        <td colSpan="8" style={{ borderLeft: 'none', borderRight: 'none' }}>
                                            <span className="font-bold mr-2">è£œå……èªªæ˜ï¼š</span>
                                            {sub.text}
                                        </td>
                                    </tr>
                                );
                            }
                            
                            if (sub.type === 'item') {
                                // å­é …ç›®è¦æ ¼/ç”¨æ–™åˆä½µ
                                const subSpecAndMaterial = [
                                    (sub.specMain || "").trim(),
                                    (sub.specMaterial || "").trim().length > 0 
                                        ? `ç”¨æ–™æ˜ç´°: ${sub.specMaterial.trim()}`
                                        : ""
                                ].filter(s => s.length > 0).join('\n');

                                return (
                                    <tr key={sub.id} className="text-sm">
                                        <td className="text-center text-xs"></td>
                                        <td className="pl-4 italic">{sub.name}</td>
                                        <td>{subSpecAndMaterial}</td> 
                                        <td className="text-center">{sub.unit}</td>
                                        <td>{formatMoney(sub.qty)}</td>
                                        <td>{formatMoney(sub.price)}</td>
                                        <td>{formatMoney(calcAmount(sub))}</td>
                                        <td>{sub.remarks}</td>
                                    </tr>
                                );
                            }
                            
                            if (sub.type === 'image') {
                                return (
                                    <tr key={sub.id}>
                                        <td colSpan="8" className="text-center p-3">
                                            <img src={sub.src} alt="å·¥ç¨‹åœ–ç‰‡" className="print-image mx-auto" />
                                        </td>
                                    </tr>
                                );
                            }

                            return null;
                        });
                        
                        // è¿”å›ä¸»é …å’Œæ‰€æœ‰å­é …
                        return [mainRow, ...subRows];
                    })}

                    {/* ç¸½è¨ˆåˆ— */}
                    <tr className="border-t-2 border-black font-bold">
                        <td colSpan="6" className="text-right text-lg">ç¸½è¨ˆé‡‘é¡ (æœªç¨…):</td>
                        <td className="text-right text-lg text-blue-800">{formatMoney(total)}</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>

            {/* D. ç¸½åƒ¹èˆ‡æŠ˜æ‰£ */}
            <div className="mt-4 flex justify-between items-start">
                
                {/* å‚™è¨»èˆ‡ä»˜æ¬¾æ¢ä»¶ (V13 æ¡†ç·šä¿®æ­£) */}
                <div className="w-2/3 mr-4 print-notes-box p-3">
                    <div className="flex">
                        <div className="w-1/2 pr-2">
                            <p className="font-bold mb-1 text-sm border-b pb-1">å‚™è¨» (ä¸å«ç¨…)ï¼š</p>
                            <pre className="text-xs whitespace-pre-wrap">{quote.notes}</pre>
                        </div>
                        <div className="w-1/2 pl-2 border-l">
                            <p className="font-bold mb-1 text-sm border-b pb-1">ä»˜æ¬¾æ¢ä»¶ï¼š</p>
                            <pre className="text-xs whitespace-pre-wrap">{quote.payment}</pre>
                        </div>
                    </div>
                </div>

                {/* æœ€çµ‚ç¸½åƒ¹å€å¡Š */}
                <div className="w-1/3 border-2 border-black p-3 text-sm">
                    {/* æŠ˜æ‰£é¡¯ç¤º */}
                    {total !== negotiated && (
                        <div className="flex justify-between border-b pb-1 mb-1">
                            <span>åŸå§‹ç¸½åƒ¹:</span>
                            <span className="font-bold line-through">NT$ {formatMoney(total)}</span>
                        </div>
                    )}
                    
                    {quote.discountPercent > 0 && (
                        <div className="flex justify-between">
                            <span>æŠ˜æ‰£ (å„ªæƒ  {quote.discountPercent}%):</span>
                            <span> - {formatMoney(total - negotiated)}</span>
                        </div>
                    )}

                    {quote.negotiatedPrice > 0 && (
                         <div className="flex justify-between">
                            <span>è­°åƒ¹èª¿æ•´:</span>
                            <span> {formatMoney(quote.negotiatedPrice)}</span>
                        </div>
                    )}
                    
                    <div className="border-t pt-2 mt-2">
                        <div className="font-bold text-base mb-1">æœ€çµ‚ç¸½å ±åƒ¹é‡‘é¡ (æœªç¨…):</div>
                        <div className="text-2xl font-extrabold text-red-700 text-right">
                            {chineseTotal}
                        </div>
                    </div>
                </div>
            </div>


            {/* E. ç°½ç½²å€/åº•éƒ¨è³‡è¨Š */}
            <div className="mt-6 flex justify-between text-xs">
                {/* å ±åƒ¹å…¬å¸è³‡è¨Š */}
                <div className="w-1/2 pr-2">
                    <p className="font-bold mb-1">å ±åƒ¹å…¬å¸ï¼š{companyInfo.name}</p>
                    <p>è¯çµ¡äººï¼š[æ¥­å‹™ç°½å]</p>
                    {/* è“‹ç« ä½”ä½ç¬¦ */}
                    <div className="border border-gray-400 h-16 w-32 flex items-center justify-center mt-2 text-gray-500">
                        å…¬å¸è“‹ç« è™•
                    </div>
                </div>

                {/* å®¢æˆ¶ç°½ç½² */}
                <div className="w-1/2 pl-2 border-l border-gray-300">
                    <p className="font-bold mb-1">å®¢æˆ¶ç¢ºèªç°½ç½²ï¼š</p>
                    <p>ä»£è¡¨äººï¼š</p>
                    <p className="mt-6">æ—¥æœŸï¼š</p>
                </div>
            </div>

            <div className="text-center text-xs mt-8 text-gray-500 border-t pt-2">
                {companyInfo.address}
            </div>

        </div>
    );
};


// P6 â€” ä¸»è¦æ‡‰ç”¨ç¨‹å¼çµæ§‹
function App() {
    const { activeQuote } = React.useContext(AppContext);
    
    return (
        <div className="flex h-screen bg-gray-100">
            
            {/* å·¦å´é¸å–®/å·¥å…·å€ (300px) */}
            <div className="w-80 bg-white p-4 shadow-xl flex flex-col no-print">
                <h1 className="text-2xl font-extrabold text-blue-700 mb-6 border-b pb-2">
                    å·¥ç¨‹å ±åƒ¹ç³»çµ±
                </h1>
                
                <CompanySelector />
                <ModeSelector />
                <QuoteManager />
            </div>

            {/* å³å´å…§å®¹å€ */}
            <div className="flex-1 overflow-y-auto p-8">
                
                {/* å ±åƒ¹å–®æ“ä½œå€ */}
                <div className="grid grid-cols-2 gap-6 mb-8 no-print">
                    <PrintButton />
                    <ExportExcelButton />
                </div>
                
                {/* ç·¨è¼¯å€ */}
                {activeQuote ? (
                    <>
                        <QuoteEditor />
                        <ItemsEditor />
                        <NoteAndTotalEditor />
                    </>
                ) : (
                    <div className="text-center p-20 text-gray-500 text-lg">
                        è«‹å¾å·¦å´é¸å–®é¸æ“‡æˆ–å»ºç«‹ä¸€ä»½å ±åƒ¹å–®ã€‚
                    </div>
                )}
            </div>
            
        </div>
    );
}


// P7 â€” æ¸²æŸ“
const container = document.getElementById("root");
const root = ReactDOM.createRoot(container);
root.render(
    <AppProvider>
        <App />
    </AppProvider>
);
</script>

</body>
</html>
