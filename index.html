<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel Standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SheetJSï¼ˆExcel åŒ¯å‡ºç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- ä¸»è¦å­—é«” -->
  <style>
    body {
      background: #f3f4f6;
      font-family: "Microsoft JhengHei", sans-serif;
    }
  </style>

  <!-- ğŸ”¶ åˆ—å°å°ˆç”¨ CSSï¼ˆP5-6ï½P5-7ï¼‰ -->
  <style>
    @media print {

      .no-print {
        display: none !important;
      }

      .print-container {
        display: block !important;
        padding: 12mm;
        font-size: 14px;
        color: black;
      }

      table {
        border-collapse: collapse;
        width: 100%;
      }

      th, td {
        border: 1px solid black;
        padding: 4px 6px;
      }

      thead {
        display: table-header-group !important;
      }

      tfoot {
        display: table-footer-group !important;
      }

      tr {
        page-break-inside: avoid !important;
      }

      #print-page-number {
        position: fixed;
        bottom: 8mm;
        right: 12mm;
        font-size: 12px;
      }
    }
  </style>
</head>

<body class="text-gray-900">

  <!-- React ä¸»ç•«é¢ -->
  <div id="root"></div>

  <!-- åˆ—å°å°ˆç”¨å€åŸŸ -->
  <div id="printArea">
      <div id="print-page-number"></div>
  </div>
<!-- ğŸš€ æ‰€æœ‰ React + å ±åƒ¹ç³»çµ±ç¨‹å¼ç¢¼çµ±ä¸€æ”¾åœ¨é€™è£¡ -->
<script type="text/babel">
/****************************************************
 * P1 â€” å…¬å¸è³‡æ–™ / ä»˜æ¬¾æ¢ä»¶ / å‚™è¨» / æ¨¡å¼æ¨¡æ¿
 ****************************************************/

// å…©å®¶å…¬å¸è³‡æ–™ï¼ˆå«å°ç« ï¼‰
const COMPANY_DATA = {
  herhsin: {
    name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
    tel: "07-6517476",
    fax: "07-6517994",
    email: "admin@herhsin.com",
    address: "831é«˜é›„å¸‚å¤§å¯®å€é³³æ—ä¸‰è·¯383-3è™Ÿ",
    stamp: "stamp_herhsin.png"
  },
  sinchang: {
    name: "è–ªæ˜Œæœ‰é™å…¬å¸",
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831é«˜é›„å¸‚å¤§å¯®å€é³³æ—ä¸‰è·¯383-3è™Ÿ",
    stamp: "stamp_sinchang.png"
  }
};


// é è¨­å‚™è¨»
const DEFAULT_NOTES = `
1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚
`;


// é è¨­ä»˜æ¬¾æ¢ä»¶
const DEFAULT_PAYMENT = `
è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%
`;


// å ±åƒ¹æ¨¡å¼æ¨¡æ¿
const QUOTE_MODES = [
  {
    id: "modeA",
    name: "æ‹Œåˆæ©Ÿæ¼æ¼¿æ›´æ›",
    description: "é©ç”¨æ‹Œåˆæ©Ÿç¶­ä¿®ã€æ¼æ¼¿è™•ç†ç­‰ã€‚",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  },
  {
    id: "modeB",
    name: "è¨­å‚™éŠ·å”®",
    description: "é©ç”¨å‚™å“ã€å–®æ©ŸéŠ·å”®èˆ‡å®‰è£ã€‚",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  },
  {
    id: "modeC",
    name: "è¨­å‚™æ›´æ›å·¥ç¨‹",
    description: "é©ç”¨æ•´æ©Ÿæ›´æ–°ã€æ–™ä»¶æ›´æ›å·¥ç¨‹ã€‚",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  }
];
/****************************************************
 * P2 â€” å·¥å…·å‡½å¼ï¼ˆå®Œæ•´ï¼‰
 ****************************************************/

// ç”¢ç”Ÿ UUID
function uuid() {
  return "xxxx-4xxx-yxxx".replace(/[xy]/g, function (c) {
    const r = (Math.random() * 16) | 0;
    const v = c === "x" ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

// ä»Šæ—¥ yyyy/mm/dd
function formatDate() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}/${m}/${day}`;
}

// åƒåˆ†ä½
function formatMoney(num) {
  if (num === "" || num === null || num === undefined) return "";
  return Number(num).toLocaleString("zh-TW");
}

// å°è¨ˆ = æ•¸é‡ Ã— å–®åƒ¹
function calcAmount(item) {
  const qty = Number(item.qty || 0);
  const price = Number(item.price || 0);
  return qty * price;
}

// è¨ˆç®—æ•´ä»½å ±åƒ¹å–®ç¸½é‡‘é¡ï¼ˆå«å°é …ï¼‰
function calcTotal(items) {
  return items.reduce((sum, it) => {
    let mainAmt = calcAmount(it);
    let subs = 0;

    if (it.subItems?.length > 0) {
      subs = it.subItems.reduce((s, sub) => s + calcAmount(sub), 0);
    }

    return sum + mainAmt + subs;
  }, 0);
}

// è­°åƒ¹è¨ˆç®—ï¼ˆæŠ˜æ‰£å„ªå…ˆ â†’ ç›´æ¥è¼¸å…¥è¦†è“‹ï¼‰
function calcNegotiated(total, discountPercent, customPrice) {
  if (customPrice > 0) return customPrice;
  if (discountPercent > 0) {
    return Math.round(total * (1 - discountPercent / 100));
  }
  return total;
}

// è¼‰å…¥ Google Sheet CSV
async function loadCSV(url) {
  const res = await fetch(url);
  const text = await res.text();
  const rows = text.split("\n").map(r => r.trim());
  const header = rows[0].split(",");

  return rows.slice(1).map(row => {
    const cols = row.split(",");
    const obj = {};

    header.forEach((h, i) => {
      obj[h] = cols[i] || "";
    });

    return obj;
  });
}

// å ±åƒ¹å–®ç·¨è™Ÿ
function generateQuoteNo() {
  return "Q" + Date.now();
}

// å–å¾—é è¨­å‚™è¨»
function getDefaultNotes() {
  return DEFAULT_NOTES;
}

// å–å¾—é è¨­ä»˜æ¬¾æ¢ä»¶
function getDefaultPayment() {
  return DEFAULT_PAYMENT;
}


/****************************************************
 * P3 â€” AppContextï¼ˆæ ¸å¿ƒè³‡æ–™ä¸­å¿ƒï¼‰
 ****************************************************/

const AppContext = React.createContext();

function AppProvider({ children }) {

  // å…¬å¸ herhsin / sinchang
  const [company, setCompany] = React.useState("herhsin");

  // å ±åƒ¹å–®åˆ—è¡¨
  const [quotes, setQuotes] = React.useState([]);

  // æ­£åœ¨ç·¨è¼¯çš„å ±åƒ¹å–® ID
  const [activeQuoteId, setActiveQuoteId] = React.useState(null);

  // è¦æ ¼å“ï¼ˆä¾†è‡ª Google Sheetï¼‰
  const [specItems, setSpecItems] = React.useState([]);

  // Google Sheet è·¯å¾‘
  const SPEC_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv";

  /************* åˆå§‹åŒ–ï¼šå¾ localStorage è¼‰å…¥ *************/
  React.useEffect(() => {
    const saved = localStorage.getItem("HERHSIN_QUOTES");

    if (saved) {
      const parsed = JSON.parse(saved);
      setQuotes(parsed);
      if (parsed.length > 0) setActiveQuoteId(parsed[0].id);
    }
  }, []);

  /************* è‡ªå‹•å­˜å› localStorage *************/
  React.useEffect(() => {
    localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
  }, [quotes]);


  /************* è¼‰å…¥ Google Sheet è¦æ ¼å“ *************/
  React.useEffect(() => {
    loadCSV(SPEC_CSV_URL).then(data => setSpecItems(data));
  }, []);


  /****************************************************
   * å»ºç«‹æ–°å ±åƒ¹å–®ï¼ˆå¯å¥—ç”¨æ¨¡å¼ï¼‰
   ****************************************************/
  function createQuote(modeId = null) {
    const mode = QUOTE_MODES.find(m => m.id === modeId);

    const newQuote = {
      id: uuid(),
      quoteNo: generateQuoteNo(),
      title: mode ? mode.name : "æœªå‘½åå·¥ç¨‹",
      customerName: "",
      contact: "",
      phone: "",
      location: "",
      date: formatDate(),
      items: mode ? [...mode.defaultItems] : [],
      notes: mode ? mode.defaultNotes : getDefaultNotes(),
      payment: mode ? mode.defaultPayment : getDefaultPayment(),
      discountPercent: 0,
      negotiatedPrice: 0
    };

    setQuotes(prev => [...prev, newQuote]);
    setActiveQuoteId(newQuote.id);
  }


  /****************************************************
   * åˆªé™¤å ±åƒ¹å–®
   ****************************************************/
  function deleteQuote(id) {
    const newList = quotes.filter(q => q.id !== id);
    setQuotes(newList);

    if (newList.length > 0) {
      setActiveQuoteId(newList[0].id);
    } else {
      setActiveQuoteId(null);
    }
  }


  /****************************************************
   * æ›´æ–°å ±åƒ¹å–®æ¬„ä½
   ****************************************************/
  function updateQuote(id, data) {
    setQuotes(prev =>
      prev.map(q => (q.id === id ? { ...q, ...data } : q))
    );
  }


  /****************************************************
   * å¥—ç”¨æ¨¡å¼ï¼ˆè¦†è“‹ï¼šæ¨™é¡Œã€å‚™è¨»ã€ä»˜æ¬¾ã€é è¨­é …ç›®ï¼‰
   ****************************************************/
  function applyMode(modeId) {
    const mode = QUOTE_MODES.find(m => m.id === modeId);
    if (!mode || !activeQuoteId) return;

    updateQuote(activeQuoteId, {
      title: mode.name,
      items: [...mode.defaultItems],
      notes: mode.defaultNotes,
      payment: mode.defaultPayment,
    });
  }


  /****************************************************
   * Context æä¾›çµ¦å…¨ App
   ****************************************************/
  const value = {
    company,
    setCompany,

    quotes,
    createQuote,
    deleteQuote,
    updateQuote,

    activeQuoteId,
    setActiveQuoteId,

    specItems,
    applyMode
  };

  // è®“åˆ—å°åŠŸèƒ½æŠ“åˆ° Context
  window.__APP_CONTEXT__ = value;

  return (
    <AppContext.Provider value={value}>
      {children}
    </AppContext.Provider>
  );
}
/****************************************************
 * P4-1 â€” å·¦å´å…ƒä»¶ï¼šå…¬å¸åˆ‡æ› / æ¨¡å¼é¸æ“‡ / å ±åƒ¹å–®åˆ—è¡¨
 ****************************************************/


/* --------------------------------------------------
   å…¬å¸åˆ‡æ›ï¼ˆä½•é‘« / è–ªæ˜Œï¼‰
   -------------------------------------------------- */
function CompanySelector() {
  const { company, setCompany } = React.useContext(AppContext);

  return (
    <div className="mb-6">
      <div className="font-bold mb-2">é¸æ“‡å…¬å¸</div>

      <div className="flex gap-2">
        <button
          className={`px-3 py-1 rounded ${
            company === "herhsin"
              ? "bg-blue-600 text-white"
              : "bg-gray-300"
          }`}
          onClick={() => setCompany("herhsin")}
        >
          ä½•é‘«
        </button>

        <button
          className={`px-3 py-1 rounded ${
            company === "sinchang"
              ? "bg-blue-600 text-white"
              : "bg-gray-300"
          }`}
          onClick={() => setCompany("sinchang")}
        >
          è–ªæ˜Œ
        </button>
      </div>
    </div>
  );
}



/* --------------------------------------------------
   å ±åƒ¹æ¨¡å¼é¸æ“‡å™¨ï¼ˆA ç¶­ä¿®ã€B æ¶ä¿®ã€C æ‹Œåˆæ©Ÿæ¼æ¼¿â€¦ï¼‰
   -------------------------------------------------- */
function ModeSelector() {
  const { createQuote } = React.useContext(AppContext);

  return (
    <div className="mb-6">
      <div className="font-bold mb-2">å»ºç«‹å ±åƒ¹å–®ï¼ˆå¥—ç”¨æ¨¡å¼ï¼‰</div>

      <div className="flex flex-col gap-2">

        {QUOTE_MODES.map(mode => (
          <button
            key={mode.id}
            className="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-left"
            onClick={() => createQuote(mode.id)}
          >
            â¤ {mode.name}
          </button>
        ))}

        {/* ç„¡æ¨¡å¼ï¼šç©ºç™½å ±åƒ¹å–® */}
        <button
          className="px-3 py-2 bg-green-600 text-white rounded"
          onClick={() => createQuote(null)}
        >
          ï¼‹ ç©ºç™½å ±åƒ¹å–®
        </button>
      </div>
    </div>
  );
}



/* --------------------------------------------------
   å ±åƒ¹å–®ç®¡ç†ï¼šåˆ—è¡¨ã€åˆ‡æ›ã€åˆªé™¤
   -------------------------------------------------- */
function QuoteManager() {
  const {
    quotes,
    activeQuoteId,
    setActiveQuoteId,
    deleteQuote
  } = React.useContext(AppContext);

  return (
    <div className="mb-8">
      <div className="font-bold mb-2">å ±åƒ¹å–®åˆ—è¡¨</div>

      {quotes.length === 0 && (
        <div className="text-gray-400 text-sm">
          å°šç„¡è³‡æ–™ï¼Œè«‹å…ˆå»ºç«‹å ±åƒ¹å–®
        </div>
      )}

      <div className="flex flex-col gap-1">
        {quotes.map(q => (
          <div
            key={q.id}
            className={`flex items-center justify-between px-3 py-2 rounded cursor-pointer
              ${
                q.id === activeQuoteId
                  ? "bg-blue-100 border border-blue-400"
                  : "bg-white border"
              }
            `}
            onClick={() => setActiveQuoteId(q.id)}
          >
            <div className="flex flex-col">
              <span className="font-semibold">{q.title}</span>
              <span className="text-xs text-gray-500">
                {q.date}
              </span>
            </div>

            <button
              className="text-red-500 text-sm no-print"
              onClick={(e) => {
                e.stopPropagation(); // é¿å…é»åˆ°çˆ¶å±¤
                if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ä»½å ±åƒ¹å–®ï¼Ÿ")) {
                  deleteQuote(q.id);
                }
              }}
            >
              åˆªé™¤
            </button>
          </div>
        ))}
      </div>
    </div>
  );
}
/****************************************************
 * P4-2 â€” å ±åƒ¹å–®æŠ¬é ­ï¼šå…¬å¸è³‡è¨Š + å®¢æˆ¶è³‡è¨Šè¼¸å…¥å€
 ****************************************************/

function QuoteEditor() {
  const {
    company,
    quotes,
    activeQuoteId,
    updateQuote
  } = React.useContext(AppContext);

  const quote = quotes.find(q => q.id === activeQuoteId);
  if (!quote) return null;

  /* -------------------------------
     å…¬å¸è³‡æ–™ï¼ˆå¯æ—¥å¾Œèª¿æ•´ç‚ºç®¡ç†ä»‹é¢ï¼‰
     ------------------------------- */
  const COMPANY_INFO = {
    herhsin: {
      name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
      address: "æ¡ƒåœ’å¸‚é¾œå±±å€ â—‹â—‹ è·¯ â—‹â—‹ è™Ÿ",
      phone: "03-0000000",
      fax: "03-0000001",
      stamp: "stamp_herhsin.png"
    },
    sinchang: {
      name: "è–ªæ˜Œæ©Ÿæ¢°è‚¡ä»½æœ‰é™å…¬å¸",
      address: "æ–°åŒ—å¸‚æ¨¹æ—å€ â—‹â—‹ è·¯ â—‹â—‹ è™Ÿ",
      phone: "02-0000000",
      fax: "02-0000001",
      stamp: "stamp_sinchang.png"
    }
  };

  const info = COMPANY_INFO[company];

  /* -------------------------------
     æ›´æ–°æ¬„ä½
     ------------------------------- */
  function update(field, value) {
    updateQuote(quote.id, { [field]: value });
  }

  return (
    <div className="bg-white p-6 shadow rounded mb-6">

      {/* ---------------- å…¬å¸åç¨± ---------------- */}
      <div className="text-2xl font-bold mb-4">
        {info.name}
      </div>

      {/* ---------------- å…¬å¸è³‡æ–™ ---------------- */}
      <div className="text-sm text-gray-600 mb-6">
        <div>åœ°å€ï¼š{info.address}</div>
        <div>é›»è©±ï¼š{info.phone}</div>
        <div>å‚³çœŸï¼š{info.fax}</div>
      </div>

      {/* ---------------- å ±åƒ¹å–®æ¨™é¡Œ & ç·¨è™Ÿ ---------------- */}
      <div className="flex items-end gap-4 mb-6">
        <div className="flex-1">
          <label className="block text-sm text-gray-600 mb-1">å·¥ç¨‹åç¨±</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2"
            value={quote.title}
            onChange={(e) => update("title", e.target.value)}
          />
        </div>

        <div className="w-48">
          <label className="block text-sm text-gray-600 mb-1">å ±åƒ¹å–®ç·¨è™Ÿ</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 bg-gray-100"
            value={quote.quoteNo}
            readOnly
          />
        </div>
      </div>

      {/* ---------------- å®¢æˆ¶è³‡è¨Š ---------------- */}
      <div className="grid grid-cols-2 gap-4 mb-6">

        <div>
          <label className="block text-sm text-gray-600 mb-1">å®¢æˆ¶åç¨±</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2"
            value={quote.customerName}
            onChange={(e) => update("customerName", e.target.value)}
          />
        </div>

        <div>
          <label className="block text-sm text-gray-600 mb-1">è¯çµ¡äºº</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2"
            value={quote.contact}
            onChange={(e) => update("contact", e.target.value)}
          />
        </div>

        <div>
          <label className="block text-sm text-gray-600 mb-1">é›»è©±</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2"
            value={quote.phone}
            onChange={(e) => update("phone", e.target.value)}
          />
        </div>

        <div>
          <label className="block text-sm text-gray-600 mb-1">å ±åƒ¹æ—¥æœŸ</label>
          <input
            type="date"
            className="w-full border rounded px-3 py-2"
            value={quote.date}
            onChange={(e) => update("date", e.target.value)}
          />
        </div>

        <div className="col-span-2">
          <label className="block text-sm text-gray-600 mb-1">å·¥ç¨‹åœ°é»</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2"
            value={quote.location}
            onChange={(e) => update("location", e.target.value)}
          />
        </div>
      </div>

      {/* ---------------- å°ç« é è¦½ï¼ˆåˆ—å°æ‰æœƒé¡¯ç¤ºï¼‰ ---------------- */}
      <div className="mt-6">
        <span className="text-sm text-gray-500">â€» åˆ—å°æ™‚è‡ªå‹•å¥—ç”¨å…¬å¸å°ç« </span>
      </div>

    </div>
  );
}
/****************************************************
 * P4-3ï¼ˆBï¼‰å–®ä¸€å“é …ç·¨è¼¯å…ƒä»¶ï¼šItemBlock
 ****************************************************/

function ItemBlock({ item, updateItem, deleteItem }) {
  const [open, setOpen] = React.useState(true);

  // æ›´æ–°ä¸»è¦æ¬„ä½
  function update(field, value) {
    updateItem(item.id, { [field]: value });
  }

  // æ–°å¢å­é …ç›®ï¼ˆå°‡åœ¨ Cã€D è£¡è£œä¸Šå®Œæ•´åŠŸèƒ½ï¼‰
  function addSubItem() {
    const sub = {
      id: uuid(),
      type: "note",   // é è¨­æ–‡å­—é …
      text: "è¼¸å…¥è£œå……èªªæ˜",
      name: "",
      spec: "",
      unit: "",
      qty: "",
      price: ""
    };

    updateItem(item.id, {
      subItems: [...item.subItems, sub]
    });
  }

  // åˆªé™¤å­é …ç›®ï¼ˆC æœƒè£œå®Œæ•´ï¼‰
  function deleteSubItem(subId) {
    const newList = item.subItems.filter(s => s.id !== subId);
    updateItem(item.id, { subItems: newList });
  }

  return (
    <div className="border rounded p-4">

      {/* ------------------ é …ç›®æ¨™é¡Œåˆ— ------------------ */}
      <div className="flex justify-between items-center">
        <div className="font-bold text-lg">
          {item.name || "æœªå‘½åé …ç›®"}
        </div>

        <div className="flex gap-2">
          <button
            className="px-2 py-1 text-sm bg-yellow-500 text-white rounded"
            onClick={() => setOpen(!open)}
          >
            {open ? "æ”¶åˆ" : "å±•é–‹"}
          </button>

          <button
            className="px-2 py-1 text-sm bg-red-600 text-white rounded"
            onClick={() => deleteItem(item.id)}
          >
            åˆªé™¤
          </button>
        </div>
      </div>

      {/* ------------------ ä¸»è¦æ¬„ä½ ------------------ */}
      {open && (
        <div className="mt-4 grid grid-cols-6 gap-3">

          {/* é …ç›®åç¨± */}
          <div className="col-span-2">
            <label className="text-sm text-gray-600">é …ç›®åç¨±</label>
            <input
              className="w-full border rounded px-2 py-1"
              value={item.name}
              onChange={(e) => update("name", e.target.value)}
            />
          </div>

          {/* è¦æ ¼ */}
          <div className="col-span-2">
            <label className="text-sm text-gray-600">è¦æ ¼</label>
            <input
              className="w-full border rounded px-2 py-1"
              value={item.spec}
              onChange={(e) => update("spec", e.target.value)}
            />
          </div>

          {/* å–®ä½ */}
          <div>
            <label className="text-sm text-gray-600">å–®ä½</label>
            <input
              className="w-full border rounded px-2 py-1"
              value={item.unit}
              onChange={(e) => update("unit", e.target.value)}
            />
          </div>

          {/* å–®åƒ¹ */}
          <div>
            <label className="text-sm text-gray-600">å–®åƒ¹</label>
            <input
              type="number"
              className="w-full border rounded px-2 py-1"
              value={item.price}
              onChange={(e) => update("price", e.target.value)}
            />
          </div>

          {/* æ•¸é‡ */}
          <div>
            <label className="text-sm text-gray-600">æ•¸é‡</label>
            <input
              type="number"
              className="w-full border rounded px-2 py-1"
              value={item.qty}
              onChange={(e) => update("qty", e.target.value)}
            />
          </div>

          {/* é‡‘é¡ï¼ˆè‡ªå‹•ï¼‰ */}
          <div>
            <label className="text-sm text-gray-600">å°è¨ˆ</label>
            <div className="py-2 font-bold text-right">
              {formatMoney(calcAmount(item))} å…ƒ
            </div>
          </div>
        </div>
      )}

      {/* ------------------ å°é …åˆ—è¡¨ ------------------ */}
      {open && (
        <div className="mt-4 pl-4 border-l">

          <div className="flex justify-between mb-2">
            <div className="font-semibold">è£œå……å…§å®¹ / å­é …ç›®</div>
            <button
              className="px-3 py-1 bg-blue-500 text-white text-sm rounded"
              onClick={addSubItem}
            >
              ï¼‹ æ–°å¢è£œå……å…§å®¹
            </button>
          </div>

          {item.subItems.length === 0 && (
            <div className="text-gray-400 text-sm">
              å°šç„¡è£œå……å…§å®¹
            </div>
          )}

          <div className="flex flex-col gap-2">
            {item.subItems.map(sub => (
              <SubItemBlock
                key={sub.id}
                sub={sub}
                parent={item}
                updateItem={updateItem}
                deleteSubItem={deleteSubItem}
              />
            ))}
          </div>
        </div>
      )}

    </div>
  );
}
/****************************************************
 * P4-3ï¼ˆCï¼‰å­é …ç›® SubItemBlock
 ****************************************************/

function SubItemBlock({ sub, parent, updateItem, deleteSubItem }) {

  // æ›´æ–°å­é …ç›®æ¬„ä½
  function updateField(field, value) {
    const newList = parent.subItems.map(s =>
      s.id === sub.id ? { ...s, [field]: value } : s
    );
    updateItem(parent.id, { subItems: newList });
  }

  // å­é …ç›®é¡å‹åˆ‡æ›: note = æ–‡å­—, item = è¦æ ¼é …
  function changeType(type) {
    updateField("type", type);

    // åˆ‡æ–‡å­—æ™‚æ¸…ç©ºç‰©æ–™æ¬„ä½
    if (type === "note") {
      updateField("name", "");
      updateField("spec", "");
      updateField("unit", "");
      updateField("qty", "");
      updateField("price", "");
    }

    // åˆ‡ç‰©æ–™é …æ™‚æ¸…ç©ºæ–‡å­—æ¬„ä½
    if (type === "item") {
      updateField("text", "");
    }
  }

  return (
    <div className="border rounded p-3 bg-gray-50">

      {/* ç¬¬ä¸€è¡Œï¼šé¡å‹ / åˆªé™¤ */}
      <div className="flex justify-between items-center mb-2">
        <select
          className="border rounded px-2 py-1 text-sm"
          value={sub.type}
          onChange={(e) => changeType(e.target.value)}
        >
          <option value="note">æ–‡å­—è£œå……èªªæ˜</option>
          <option value="item">å­é …ç›®ï¼ˆå¯è¼¸å…¥æ•¸é‡å–®åƒ¹ï¼‰</option>
          <option value="image" disabled>ï¼ˆåœ–ç‰‡ç•™å¾…ä¸‹ä¸€æ®µï¼‰</option>
        </select>

        <button
          className="text-red-600 text-sm"
          onClick={() => deleteSubItem(sub.id)}
        >
          åˆªé™¤
        </button>
      </div>

      {/* ------------- é¡å‹1ï¼šæ–‡å­—è£œå……èªªæ˜ ------------- */}
      {sub.type === "note" && (
        <div>
          <textarea
            className="w-full border rounded px-2 py-1 text-sm"
            rows="2"
            value={sub.text}
            placeholder="è¼¸å…¥è£œå……èªªæ˜å…§å®¹"
            onChange={(e) => updateField("text", e.target.value)}
          />
        </div>
      )}

      {/* ------------- é¡å‹2ï¼šå­é …ç›®ï¼ˆç‰©æ–™è¦æ ¼ï¼‰ ------------- */}
      {sub.type === "item" && (
        <div className="grid grid-cols-6 gap-2">

          {/* åç¨± */}
          <div className="col-span-2">
            <label className="text-xs text-gray-600">åç¨±</label>
            <input
              className="w-full border rounded px-2 py-1 text-sm"
              value={sub.name}
              onChange={(e) => updateField("name", e.target.value)}
            />
          </div>

          {/* è¦æ ¼ */}
          <div className="col-span-2">
            <label className="text-xs text-gray-600">è¦æ ¼</label>
            <input
              className="w-full border rounded px-2 py-1 text-sm"
              value={sub.spec}
              onChange={(e) => updateField("spec", e.target.value)}
            />
          </div>

          {/* å–®ä½ */}
          <div>
            <label className="text-xs text-gray-600">å–®ä½</label>
            <input
              className="w-full border rounded px-2 py-1 text-sm"
              value={sub.unit}
              onChange={(e) => updateField("unit", e.target.value)}
            />
          </div>

          {/* æ•¸é‡ */}
          <div>
            <label className="text-xs text-gray-600">æ•¸é‡</label>
            <input
              type="number"
              className="w-full border rounded px-2 py-1 text-sm"
              value={sub.qty}
              onChange={(e) => updateField("qty", e.target.value)}
            />
          </div>

          {/* å–®åƒ¹ */}
          <div>
            <label className="text-xs text-gray-600">å–®åƒ¹</label>
            <input
              type="number"
              className="w-full border rounded px-2 py-1 text-sm"
              value={sub.price}
              onChange={(e) => updateField("price", e.target.value)}
            />
          </div>

          {/* å°è¨ˆï¼ˆè‡ªå‹•ï¼‰ */}
          <div className="col-span-6 text-right text-sm font-bold pt-1">
            å°è¨ˆï¼š{formatMoney(calcAmount(sub))} å…ƒ
          </div>
        </div>
      )}

      {/* ------------- é¡å‹3ï¼šåœ–ç‰‡ï¼ˆä¸‹ä¸€æ®µæœƒåŠ å…¥ï¼‰ ------------- */}
      {sub.type === "image" && (
        <div className="text-gray-400 text-sm">
          åœ–ç‰‡å­é …ç›®åŠŸèƒ½å°‡æ–¼ä¸‹ä¸€æ®µåŠ å…¥ï¼ˆå«ä¸Šå‚³ / é è¦½ / åˆªé™¤ï¼‰
        </div>
      )}

    </div>
  );
}
/****************************************************
 * P4-3ï¼ˆDï¼‰åœ–ç‰‡å­é …ç›® ImageSubItemBlock
 ****************************************************/
function ImageSubItemBlock({ sub, parent, updateItem, deleteSubItem }) {

  // ä¸Šå‚³åœ–ç‰‡å¾Œè½‰ Base64
  function handleUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      updateField("src", reader.result);
    };
    reader.readAsDataURL(file);
  }

  // æ›´æ–°æ¬„ä½
  function updateField(field, value) {
    const newList = parent.subItems.map(s =>
      s.id === sub.id ? { ...s, [field]: value } : s
    );
    updateItem(parent.id, { subItems: newList });
  }

  return (
    <div className="border rounded p-3 bg-gray-50">

      {/* ç¬¬ä¸€è¡Œï¼šæ¨™é¡Œ + åˆªé™¤ */}
      <div className="flex justify-between items-center mb-2">
        <span className="text-sm font-bold text-gray-700">ğŸ“· åœ–ç‰‡</span>

        <button
          className="text-red-600 text-sm"
          onClick={() => deleteSubItem(sub.id)}
        >
          åˆªé™¤
        </button>
      </div>

      {/* ç¬¬äºŒè¡Œï¼šåœ–ç‰‡é è¦½ */}
      {sub.src ? (
        <div className="flex flex-col items-start gap-2">

          <img
            src={sub.src}
            className="max-w-xs border rounded shadow"
          />

          <button
            className="text-blue-600 text-xs underline"
            onClick={() => updateField("src", "")}
          >
            é‡æ–°ä¸Šå‚³
          </button>
        </div>
      ) : (
        <div className="text-gray-500 text-sm">
          å°šæœªä¸Šå‚³åœ–ç‰‡
        </div>
      )}

      {/* ä¸Šå‚³åœ–ç‰‡æŒ‰éˆ• */}
      <label className="mt-2 inline-block cursor-pointer text-blue-700 text-sm underline">
        ä¸Šå‚³åœ–ç‰‡
        <input
          type="file"
          accept="image/*"
          className="hidden"
          onChange={handleUpload}
        />
      </label>
    </div>
  );
}
/****************************************************
 * P4-3ï¼ˆEï¼‰SubItemWrapper â€” è‡ªå‹•åˆ¤æ–·å°é …é¡å‹
 ****************************************************/
function SubItemWrapper({ subItem, parentItem, quote, updateQuote }) {

  // æ›´æ–°æŸå€‹ subItem æ¬„ä½
  function updateSubField(field, value) {
    const newSubItems = parentItem.subItems.map(s =>
      s.id === subItem.id ? { ...s, [field]: value } : s
    );

    const newItems = quote.items.map(it =>
      it.id === parentItem.id ? { ...it, subItems: newSubItems } : it
    );

    updateQuote(quote.id, { items: newItems });
  }

  // åˆªé™¤ subItem
  function deleteSub() {
    const newSubItems = parentItem.subItems.filter(s => s.id !== subItem.id);
    const newItems = quote.items.map(it =>
      it.id === parentItem.id ? { ...it, subItems: newSubItems } : it
    );
    updateQuote(quote.id, { items: newItems });
  }

  // è½‰å‹æ ¼å¼å¾Œä¸Ÿåˆ°å„å­å…ƒä»¶
  const props = {
    sub: subItem,
    parent: parentItem,
    updateField: updateSubField,
    deleteSubItem: deleteSub
  };

  if (subItem.type === "note") {
    return <NoteSubItemBlock {...props} />;
  }

  if (subItem.type === "image") {
    return <ImageSubItemBlock {...props} />;
  }

  return <ItemSubItemBlock {...props} />;
}
/****************************************************
 * P4-3ï¼ˆFï¼‰â€” MainItemBlockï¼ˆå¤§é …ç·¨è¼¯å€ï¼‰
 ****************************************************/
function MainItemBlock({ item, quote, updateQuote }) {

  /* æ›´æ–°å¤§é …è³‡æ–™ */
  function update(data) {
    const newItems = quote.items.map(m =>
      m.id === item.id ? { ...m, ...data } : m
    );
    updateQuote(quote.id, { items: newItems });
  }

  /* æ–°å¢å°é … */
  function addSubItemLine() {
    const newItems = quote.items.map(m => {
      if (m.id !== item.id) return m;
      return {
        ...m,
        subItems: [
          ...m.subItems,
          {
            id: uuid(),
            type: "sub",
            name: "æœªå‘½åå°é …",
            spec: "",
            unit: "",
            qty: "",
            price: ""
          }
        ]
      };
    });
    updateQuote(quote.id, { items: newItems });
  }

  /* æ–°å¢è£œå……æ–‡å­— */
  function addNoteLine() {
    const newItems = quote.items.map(m => {
      if (m.id !== item.id) return m;
      return {
        ...m,
        subItems: [...m.subItems, { id: uuid(), type: "note", text: "è£œå……èªªæ˜..." }]
      };
    });
    updateQuote(quote.id, { items: newItems });
  }

  /* æ–°å¢è£œå……åœ–ç‰‡ */
  function addImageLine(base64) {
    const newItems = quote.items.map(m => {
      if (m.id !== item.id) return m;
      return {
        ...m,
        subItems: [...m.subItems, { id: uuid(), type: "image", src: base64 }]
      };
    });
    updateQuote(quote.id, { items: newItems });
  }

  /* åˆªé™¤å¤§é … */
  function deleteMain() {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å¤§é …ï¼Ÿ")) return;
    const newItems = quote.items.filter(m => m.id !== item.id);
    updateQuote(quote.id, { items: newItems });
  }

  return (
    <div className="border rounded p-4 bg-white shadow mb-4">

      {/* ----------- å¤§é …è³‡æ–™åˆ— ----------- */}
      <div className="grid grid-cols-12 gap-2 items-center">

        {/* å“å */}
        <input
          className="border p-1 rounded col-span-3"
          value={item.name}
          onChange={(e) => update({ name: e.target.value })}
        />

        {/* è¦æ ¼ */}
        <input
          className="border p-1 rounded col-span-3"
          value={item.spec}
          onChange={(e) => update({ spec: e.target.value })}
        />

        {/* å–®ä½ */}
        <input
          className="border p-1 rounded col-span-1"
          value={item.unit}
          onChange={(e) => update({ unit: e.target.value })}
        />

        {/* æ•¸é‡ */}
        <input
          className="border p-1 rounded col-span-1"
          value={item.qty}
          onChange={(e) => update({ qty: e.target.value })}
        />

        {/* å–®åƒ¹ */}
        <input
          className="border p-1 rounded col-span-2"
          value={item.price}
          onChange={(e) => update({ price: e.target.value })}
        />

        {/* é‡‘é¡ï¼ˆè‡ªå‹•ï¼‰ */}
        <div className="font-bold text-right col-span-1">
          {formatMoney(calcAmount(item))}
        </div>

        {/* åˆªé™¤æŒ‰éˆ• */}
        <button
          className="text-red-600 col-span-1"
          onClick={deleteMain}
        >
          åˆªé™¤
        </button>
      </div>

      {/* ----------- å°é … / è£œå……å…§å®¹åˆ—è¡¨ ----------- */}
      <div className="mt-3">
        {item.subItems.map(sub => (
          <SubItemWrapper
            key={sub.id}
            parentItem={item}
            subItem={sub}
            quote={quote}
            updateQuote={updateQuote}
          />
        ))}
      </div>

      {/* ----------- åº•éƒ¨æ“ä½œæŒ‰éˆ•åˆ— ----------- */}
      <div className="flex gap-4 mt-3 text-sm text-blue-600">
        <button onClick={addSubItemLine}>ï¼‹æ–°å¢å°é …</button>
        <button onClick={addNoteLine}>ï¼‹è£œå……æ–‡å­—</button>
        <UploadImageButton onUpload={addImageLine} />
      </div>

    </div>
  );
}
/****************************************************
 * P4-3ï¼ˆå‰ç½®ï¼‰â€” è¦æ ¼å“ä¸‹æ‹‰æ¸…å–®ï¼ˆGoogle Sheetï¼‰
 ****************************************************/
function SpecSelector({ onSelect }) {
  const { specItems } = React.useContext(AppContext);

  const [keyword, setKeyword] = React.useState("");

  // æœå°‹çµæœ
  const filtered = specItems.filter(it =>
    (it.name || "").includes(keyword) ||
    (it.spec || "").includes(keyword)
  );

  return (
    <div className="p-4 bg-white rounded shadow mb-4">

      <div className="font-bold mb-2">ğŸ” è¦æ ¼å“å¿«é€ŸåŠ å…¥ï¼ˆä¾†è‡ª Google Sheetï¼‰</div>

      {/* æœå°‹æ¡† */}
      <input
        className="border rounded px-3 py-2 w-full mb-3"
        placeholder="è¼¸å…¥åç¨±æˆ–è¦æ ¼æœå°‹â€¦"
        value={keyword}
        onChange={(e) => setKeyword(e.target.value)}
      />

      {/* æœå°‹çµæœåˆ—è¡¨ */}
      <div className="max-h-60 overflow-y-auto border rounded">
        {filtered.length === 0 && (
          <div className="text-gray-400 text-center py-3">
            ç„¡ç¬¦åˆè³‡æ–™
          </div>
        )}

        {filtered.map((item, index) => (
          <button
            key={index}
            className="w-full text-left px-3 py-2 hover:bg-gray-100 border-b"
            onClick={() => onSelect(item)}
          >
            <div className="font-bold">{item.name}</div>
            <div className="text-sm text-gray-600">
              {item.spec}ï½œ{item.unit}ï½œ${item.price}
            </div>
          </button>
        ))}
      </div>
    </div>
  );
}
  /****************************************************
 * P4-3ï¼ˆGï¼‰â€” ItemsEditorï¼ˆå“é …ä¸»ç·¨è¼¯å™¨ï¼‰
 ****************************************************/
function ItemsEditor({ quote, updateQuote }) {

  /* æ–°å¢ä¸€å€‹å¤§é … */
  function addMain() {
    const newMain = {
      id: uuid(),
      type: "main",
      name: "æœªå‘½åå¤§é …",
      spec: "",
      unit: "",
      qty: "",
      price: "",
      subItems: []
    };

    updateQuote(quote.id, { items: [...quote.items, newMain] });
  }

  /* é¸æ“‡ Google Sheet è¦æ ¼å“ â†’ ç”Ÿæˆå¤§é … */
  function addSpecItem(spec) {
    const newMain = {
      id: uuid(),
      type: "main",
      name: spec.name || "æœªå‘½åå“é …",
      spec: spec.spec || "",
      unit: spec.unit || "",
      qty: 1,
      price: spec.price || "",
      subItems: []
    };

    updateQuote(quote.id, { items: [...quote.items, newMain] });
  }

  return (
    <div className="mb-6">

      {/* -------- è¦æ ¼å“å¿«é€ŸåŠ å…¥ï¼ˆGoogle Sheetï¼‰ -------- */}
      <SpecSelector onSelect={addSpecItem} />

      {/* -------- æ–°å¢å¤§é … æŒ‰éˆ• -------- */}
      <button
        className="px-4 py-2 bg-blue-600 text-white rounded mb-4"
        onClick={addMain}
      >
        ï¼‹ æ–°å¢å¤§é …
      </button>

      {/* -------- å¤§é …åˆ—è¡¨ -------- */}
      <div>
        {quote.items.length === 0 && (
          <div className="text-center text-gray-400 mt-4">
            å°šç„¡å“é …ï¼Œè«‹æ–°å¢ã€‚
          </div>
        )}

        {quote.items.map(item => (
          <MainItemBlock
            key={item.id}
            item={item}
            quote={quote}
            updateQuote={updateQuote}
          />
        ))}
      </div>
    </div>
  );
}
/****************************************************
 * P4-4ï¼ˆAï¼‰â€” å‚™è¨»æ¬„ NotesEditor
 ****************************************************/
function NotesEditor({ quote, update }) {
  return (
    <div className="p-4 bg-white rounded shadow mb-6">
      <h2 className="font-bold text-lg mb-2">å‚™è¨»èªªæ˜</h2>

      <textarea
        className="border p-2 w-full rounded h-32"
        value={quote.notes}
        onChange={(e) => update({ notes: e.target.value })}
      />
    </div>
  );
}
/****************************************************
 * P4-4ï¼ˆBï¼‰â€” ä»˜æ¬¾æ¢ä»¶ PaymentEditor
 ****************************************************/
function PaymentEditor({ quote, update }) {
  return (
    <div className="p-4 bg-white rounded shadow mb-6">
      <h2 className="font-bold text-lg mb-2">ä»˜æ¬¾æ¢ä»¶</h2>

      <textarea
        className="border p-2 w-full rounded h-28"
        value={quote.payment}
        onChange={(e) => update({ payment: e.target.value })}
      />
    </div>
  );
}
/****************************************************
 * P4-4ï¼ˆCï¼‰â€” ç¸½åƒ¹å€ PriceSummary
 ****************************************************/
function PriceSummary({ quote, update }) {
  const originalTotal = calcTotal(quote.items);
  const finalPrice = calcNegotiated(
    originalTotal,
    quote.discountPercent,
    quote.negotiatedPrice
  );

  return (
    <div className="p-4 bg-white rounded shadow mb-6">

      <h2 className="font-bold text-lg mb-3">ç¸½åƒ¹è³‡è¨Š</h2>

      {/* åŸå§‹é‡‘é¡ */}
      <div className="mb-3">
        <label className="font-bold">åŸå§‹ç¸½åƒ¹ï¼š</label>
        <span className="text-blue-700 font-bold ml-2">
          NT$ {formatMoney(originalTotal)}
        </span>
      </div>

      {/* æŠ˜æ‰£ç™¾åˆ†æ¯” */}
      <div className="mb-3 flex items-center">
        <label className="font-bold">è­°åƒ¹æŠ˜æ‰£ï¼ˆ%ï¼‰ï¼š</label>
        <input
          className="border p-1 w-24 rounded ml-2"
          type="number"
          value={quote.discountPercent}
          onChange={(e) => update({ discountPercent: e.target.value })}
        />
      </div>

      {/* è­°åƒ¹å¾Œé‡‘é¡ï¼ˆç›´æ¥è¼¸å…¥æœƒè¦†è“‹æŠ˜æ‰£ï¼‰ */}
      <div className="mb-3 flex items-center">
        <label className="font-bold">
          è­°åƒ¹å¾Œé‡‘é¡ï¼ˆç›´æ¥è¼¸å…¥ï¼‰ï¼š
        </label>
        <input
          className="border p-1 w-40 rounded ml-2"
          type="number"
          placeholder="è¼¸å…¥å¾Œæœƒè¦†è“‹æŠ˜æ‰£%"
          value={quote.negotiatedPrice}
          onChange={(e) => update({ negotiatedPrice: e.target.value })}
        />
      </div>

      {/* æœ€çµ‚æˆäº¤åƒ¹ */}
      <div className="text-xl font-bold mt-4">
        æœ€çµ‚æˆäº¤åƒ¹ï¼š
        <span className="text-green-700 ml-2">
          NT$ {formatMoney(finalPrice)}
        </span>
      </div>
    </div>
  );
}
/****************************************************
 * P4-5 â€” åˆ—å°å°ˆç”¨ç‰ˆé¢ PrintView
 ****************************************************/
function PrintView({ quote, company }) {
  const info = COMPANY_DATA[company];

  const total = calcTotal(quote.items);
  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

  return (
    <div className="p-8 text-black text-base">

      {/* å…¬å¸æŠ¬é ­ */}
      <div className="text-center mb-6">
        <h1 className="text-3xl font-bold">{info.name}</h1>
        <div>{info.tel}</div>
        <div>{info.fax}</div>
        <div>{info.email}</div>
        <div>{info.address}</div>

        <h2 className="text-3xl font-bold mt-4 tracking-widest">
          å·¥ ç¨‹ å ± åƒ¹ å–®
        </h2>
      </div>

      {/* åŸºæœ¬è³‡è¨Š */}
      <table className="w-full mb-6">
        <tbody>
          <tr>
            <td className="font-bold w-32">é¡§å®¢åç¨±ï¼š</td>
            <td>{quote.customerName}</td>
            <td className="font-bold w-32">è¯çµ¡äººï¼š</td>
            <td>{quote.contact}</td>
          </tr>

          <tr>
            <td className="font-bold">é›»è©±ï¼š</td>
            <td>{quote.phone}</td>
            <td className="font-bold">å ±åƒ¹æ—¥æœŸï¼š</td>
            <td>{quote.date}</td>
          </tr>

          <tr>
            <td className="font-bold">å·¥ç¨‹åç¨±ï¼š</td>
            <td>{quote.title}</td>
            <td className="font-bold">å·¥ç¨‹åœ°é»ï¼š</td>
            <td>{quote.location}</td>
          </tr>
        </tbody>
      </table>

      {/* å“é …åˆ—è¡¨ */}
      <table className="w-full border-collapse mb-6" border="1">
        <thead>
          <tr className="bg-gray-200">
            <th className="p-1">é …ç›®</th>
            <th className="p-1">è¦æ ¼ / èªªæ˜</th>
            <th className="p-1">å–®ä½</th>
            <th className="p-1">æ•¸é‡</th>
            <th className="p-1">å–®åƒ¹</th>
            <th className="p-1">é‡‘é¡</th>
          </tr>
        </thead>

        <tbody>
          {quote.items.map((item, index) => (
            <>
              {/* å¤§é … */}
              <tr key={item.id}>
                <td className="p-1 font-bold">{item.name}</td>
                <td className="p-1">{item.spec}</td>
                <td className="p-1">{item.unit}</td>
                <td className="p-1">{item.qty}</td>
                <td className="p-1 text-right">{formatMoney(item.price)}</td>
                <td className="p-1 text-right font-bold">
                  {formatMoney(calcAmount(item))}
                </td>
              </tr>

              {/* å°é … / è£œå…… */}
              {item.subItems.map((sub) => {
                if (sub.type === "note") {
                  return (
                    <tr key={sub.id}>
                      <td colSpan="6" className="p-1 pl-6 text-gray-700">â— {sub.text}</td>
                    </tr>
                  );
                }

                if (sub.type === "image") {
                  return (
                    <tr key={sub.id}>
                      <td colSpan="6" className="p-1 pl-6">
                        <img src={sub.src} className="max-w-xs border" />
                      </td>
                    </tr>
                  );
                }

                return (
                  <tr key={sub.id}>
                    <td className="p-1 pl-6">ï¼ {sub.name}</td>
                    <td className="p-1">{sub.spec}</td>
                    <td className="p-1">{sub.unit}</td>
                    <td className="p-1">{sub.qty}</td>
                    <td className="p-1 text-right">{formatMoney(sub.price)}</td>
                    <td className="p-1 text-right">{formatMoney(calcAmount(sub))}</td>
                  </tr>
                );
              })}
            </>
          ))}
        </tbody>
      </table>

      {/* å‚™è¨» */}
      <div className="mb-6">
        <h3 className="font-bold mb-1">å‚™è¨»ï¼š</h3>
        <div className="whitespace-pre-line">{quote.notes}</div>
      </div>

      {/* ä»˜æ¬¾æ¢ä»¶ */}
      <div className="mb-6">
        <h3 className="font-bold mb-1">ä»˜æ¬¾æ¢ä»¶ï¼š</h3>
        <div className="whitespace-pre-line">{quote.payment}</div>
      </div>

      {/* åˆè¨ˆ */}
      <div className="text-xl font-bold mt-6">
        æœ€çµ‚æˆäº¤åƒ¹ï¼š
        <span className="text-green-700 ml-2">
          NT$ {formatMoney(negotiated)}
        </span>
      </div>

      {/* å°ç«  */}
      <div className="mt-10 flex justify-end">
        <img
          src={company === "herhsin" ? "stamp_herhsin.png" : "stamp_sinchang.png"}
          className="w-40 opacity-90"
        />
      </div>
    </div>
  );
}
/****************************************************
 * P5-1 â€” åˆ—å°ç•«é¢æ¸²æŸ“ï¼šæŠŠ PrintView å¡åˆ° printArea
 ****************************************************/
function renderPrintView(quote, company) {
  const mountNode = document.getElementById("printArea");
  ReactDOM.render(
    <PrintView quote={quote} company={company} />,
    mountNode
  );
}
/****************************************************
 * P5-3 â€” åŒ¯å‡º Excelï¼ˆå«å¤§é …ã€å°é …ã€è£œå……ã€è­°åƒ¹ï¼‰
 ****************************************************/
function exportExcel(quote, company) {
  const info = COMPANY_DATA[company];
  const rows = [];

  /* --------------------------
     å…¬å¸æŠ¬é ­
  --------------------------- */
  rows.push([info.name]);
  rows.push([`é›»è©±ï¼š${info.tel}`]);
  rows.push([`å‚³çœŸï¼š${info.fax}`]);
  rows.push([`Emailï¼š${info.email}`]);
  rows.push([`åœ°å€ï¼š${info.address}`]);
  rows.push([]);
  rows.push(["å·¥ç¨‹å ±åƒ¹å–®"]);
  rows.push([]);

  /* --------------------------
     åŸºæœ¬è³‡æ–™
  --------------------------- */
  rows.push(["é¡§å®¢åç¨±", quote.customerName]);
  rows.push(["è¯çµ¡äºº", quote.contact]);
  rows.push(["é›»è©±", quote.phone]);
  rows.push(["å·¥ç¨‹åç¨±", quote.title]);
  rows.push(["å·¥ç¨‹åœ°é»", quote.location]);
  rows.push(["å ±åƒ¹æ—¥æœŸ", quote.date]);
  rows.push([]);
  rows.push(["å“å", "è¦æ ¼", "å–®ä½", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]);

  /* --------------------------
     å¤§é … + å°é … + è£œå……å…§å®¹
  --------------------------- */
  quote.items.forEach(main => {
    // å¤§é …
    rows.push([
      main.name,
      main.spec,
      main.unit,
      main.qty,
      main.price,
      calcAmount(main)
    ]);

    // å°é … / è£œå……å…§å®¹
    main.subItems.forEach(sub => {
      if (sub.type === "sub") {
        rows.push([
          "â†’ " + sub.name,
          sub.spec,
          sub.unit,
          sub.qty,
          sub.price,
          calcAmount(sub)
        ]);
      } else if (sub.type === "note") {
        rows.push(["â€» " + sub.text, "", "", "", "", ""]);
      }
    });
  });

  /* --------------------------
     ç¸½é‡‘é¡ + è­°åƒ¹å¾Œé‡‘é¡
  --------------------------- */
  const total = calcTotal(quote.items);
  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

  rows.push([]);
  rows.push(["æœªç¨…åˆè¨ˆ", "", "", "", "", total]);

  if (negotiated !== total) {
    rows.push(["è­°åƒ¹å¾Œé‡‘é¡", "", "", "", "", negotiated]);
  }

  /* --------------------------
     å‚™è¨»
  --------------------------- */
  rows.push([]);
  rows.push(["å‚™è¨»"]);
  quote.notes.split("\n").forEach(line => rows.push([line]));

  /* --------------------------
     ä»˜æ¬¾æ¢ä»¶
  --------------------------- */
  rows.push([]);
  rows.push(["ä»˜æ¬¾æ¢ä»¶"]);
  quote.payment.split("\n").forEach(line => rows.push([line]));

  /* --------------------------
     Excel å»ºç«‹
  --------------------------- */
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);

  // æ¬„å¯¬è¨­å®š
  ws["!cols"] = [
    { wch: 30 }, // å“å
    { wch: 30 }, // è¦æ ¼
    { wch: 10 }, // å–®ä½
    { wch: 10 }, // æ•¸é‡
    { wch: 12 }, // å–®åƒ¹
    { wch: 15 }  // å°è¨ˆ
  ];

  XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å–®");

  // ä¸‹è¼‰
  const filename = `${quote.title}_${quote.date}_å ±åƒ¹å–®.xlsx`;
  XLSX.writeFile(wb, filename);
}
/****************************************************
 * P5-4 â€” åŒ¯å‡ºè­°åƒ¹ Excelï¼ˆè­°åƒ¹å¾Œé‡‘é¡ç‰ˆæœ¬ï¼‰
 ****************************************************/
function exportExcelNegotiated(quote, company) {
  const total = calcTotal(quote.items);
  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

  // å»ºç«‹è­°åƒ¹å¾Œçš„è¤‡è£½ç‰ˆï¼ˆä¸å½±éŸ¿åŸå ±åƒ¹å–®ï¼‰
  const negotiatedQuote = {
    ...quote,
    negotiatedPrice: negotiated
  };

  // æš«æ™‚ä¿®æ”¹ writeFile è®“æª”åè‡ªå‹•è®Šæˆã€Œè­°åƒ¹ã€
  const originalWriteFile = XLSX.writeFile;
  XLSX.writeFile = function (wb, name) {
    const newName = name.replace(".xlsx", "_è­°åƒ¹.xlsx");
    return originalWriteFile(wb, newName);
  };

  // å‘¼å«åŸæœ¬çš„åŒ¯å‡ºå‡½å¼
  exportExcel(negotiatedQuote, company);

  // é‚„åŸ XLSX.writeFile
  XLSX.writeFile = originalWriteFile;
}
/****************************************************
 * P5-5 â€” å·¥å…·åˆ—ï¼ˆåˆ—å°ã€åŒ¯å‡º Excelã€åŒ¯å‡ºè­°åƒ¹ï¼‰
 ****************************************************/
function ToolBar({ quote, company }) {
  if (!quote) return null;

  return (
    <div className="no-print p-4 bg-white shadow rounded mb-6 flex gap-3">

      {/* åˆ—å° / PDF */}
      <button
        className="px-4 py-2 bg-blue-700 text-white rounded"
        onClick={() => openPrint()}
      >
        ğŸ–¨ åˆ—å° / PDF
      </button>

      {/* åŒ¯å‡º Excel */}
      <button
        className="px-4 py-2 bg-green-700 text-white rounded"
        onClick={() => exportExcel(quote, company)}
      >
        ğŸ“Š åŒ¯å‡º Excel
      </button>

      {/* åŒ¯å‡ºè­°åƒ¹ Excel */}
      <button
        className="px-4 py-2 bg-orange-600 text-white rounded"
        onClick={() => exportExcelNegotiated(quote, company)}
      >
        ğŸ§¾ åŒ¯å‡ºè­°åƒ¹ Excel
      </button>
    </div>
  );
}

/****************************************************
 * P5-9 â€” åˆ—å°æ•´åˆï¼ˆå‘¼å« renderPrintView â†’ è¨ˆç®—é ç¢¼ â†’ é–‹å•Ÿåˆ—å°ï¼‰
 ****************************************************/
function openPrint() {
  const ctx = window.__APP_CONTEXT__;
  if (!ctx) {
    alert("ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° Context");
    return;
  }

  const { quotes, activeQuoteId, company } = ctx;
  const quote = quotes.find(q => q.id === activeQuoteId);

  if (!quote) {
    alert("è«‹å…ˆé¸æ“‡å ±åƒ¹å–®");
    return;
  }

  // Step 1ï¼šæ¸²æŸ“åˆ—å°ç‰ˆç•«é¢
  renderPrintView(quote, company);

  // Step 2ï¼šè¨ˆç®—é æ•¸ï¼ˆfor é ç¢¼ï¼‰
  setTimeout(() => {
    const totalPages = Math.ceil(
      document.body.scrollHeight / window.innerHeight
    );

    const pageNumber = document.getElementById("print-page-number");
    if (pageNumber) {
      pageNumber.textContent = `é æ¬¡ï¼š1 / ${totalPages}`;
    }

    // Step 3ï¼šå‘¼å«ç€è¦½å™¨åˆ—å°
    window.print();

  }, 200);
}
/****************************************************
 * P5-10 â€” App ä¸»çµ„è£ï¼ˆå·¦å´é‚Šæ¬„ + ä¸»ç·¨è¼¯å€ï¼‰
 * ä¸¦å»ºç«‹ window.__APP_CONTEXT__ æä¾› openPrint ä½¿ç”¨
 ****************************************************/
function App() {
  const {
    company,
    setCompany,
    quotes,
    activeQuoteId,
    setActiveQuoteId,
    updateQuote
  } = React.useContext(AppContext);

  // ç›®å‰æ­£åœ¨ç·¨è¼¯çš„å ±åƒ¹å–®
  const activeQuote = quotes.find(q => q.id === activeQuoteId) || null;

  // è¨­å®šå…¨åŸŸ Contextï¼ˆçµ¦ openPrint() ä½¿ç”¨ï¼‰
  window.__APP_CONTEXT__ = {
    company,
    quotes,
    activeQuoteId
  };

  return (
    <div className="min-h-screen flex">

      {/* ------------------ å·¦å´é‚Šæ¬„ ------------------ */}
      <div className="w-72 bg-gray-100 p-4 border-r no-print overflow-y-auto">
        <CompanySelector />
        <ModeSelector />
        <QuoteManager />
      </div>

      {/* ------------------ å³å´ä¸»å…§å®¹ ------------------ */}
      <div className="flex-1 p-6 overflow-y-auto">

        {!activeQuote && (
          <div className="text-center text-gray-400 text-xl mt-20">
            â† è«‹åœ¨å·¦å´æ–°å¢æˆ–é¸æ“‡å ±åƒ¹å–®
          </div>
        )}

        {activeQuote && (
          <>
            {/* å®¢æˆ¶è³‡è¨Š + å…¬å¸æŠ¬é ­ */}
            <QuoteEditor />

            {/* å“é …ç·¨è¼¯å€ */}
            <ItemsEditor
              quote={activeQuote}
              updateQuote={updateQuote}
            />

            {/* å‚™è¨» */}
            <NotesEditor
              quote={activeQuote}
              update={(data) => updateQuote(activeQuote.id, data)}
            />

            {/* ä»˜æ¬¾æ¢ä»¶ */}
            <PaymentEditor
              quote={activeQuote}
              update={(data) => updateQuote(activeQuote.id, data)}
            />

            {/* ç¸½åƒ¹èˆ‡è­°åƒ¹ */}
            <PriceSummary
              quote={activeQuote}
              update={(data) => updateQuote(activeQuote.id, data)}
            />

            {/* åˆ—å° + åŒ¯å‡ºæŒ‰éˆ• */}
            <ToolBar quote={activeQuote} company={company} />
          </>
        )}
      </div>
    </div>
  );
}
/****************************************************
 * ReactDOM render â€” ç³»çµ±å•Ÿå‹•
 ****************************************************/
ReactDOM.createRoot(document.getElementById("root")).render(
  <AppProvider>
    <App />
  </AppProvider>
);

</script>

  
