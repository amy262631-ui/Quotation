<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰- V20 (æœ€çµ‚ä¿®å¾© - é‚è¼¯ä¿®æ­£ç‰ˆ)</title>

    <script src="https://unpkg.com/react-dom@18/umd/react-dom-server.browser.development.js"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
    body {
        background: #f3ff6;
        font-family: "Microsoft JhengHei", sans-serif;
    }
    
    /* ä¿®æ­£åˆ—å°å•é¡Œï¼šæŒ‡å®šåˆ—å°å€åŸŸçš„ ID */
    @media print {

        /* éš±è—éåˆ—å°å…ƒç´  */
        .no-print {
            display: none !important;
        }
        
        /* éš±è—ä¸»ç·¨è¼¯å€ï¼Œåªé¡¯ç¤ºé è¦½å€ */
        #root {
            display: none !important; 
        }

        /* ----------------------------------------------- */
        /* é—œéµä¿®æ­£: åˆ—å°æ™‚ï¼Œå°‡é è¦½å€è¨­ç‚ºå…¨é é¡¯ç¤º */
        /* ----------------------------------------------- */
        #quotePreviewArea {
            display: block !important; 
            margin: 0;
            padding: 12mm;
            font-size: 13px; /* åˆ—å°å­—é«”ç•¥å° */
            color: black;
            width: 210mm; /* A4 å¯¬åº¦ */
            box-sizing: border-box;
            background: white; /* ç¢ºä¿èƒŒæ™¯æ˜¯ç™½è‰² */
            min-height: 297mm; /* ç¢ºä¿è‡³å°‘ä¸€é é«˜åº¦ */
            position: fixed; /* ä¿®æ­£å®šä½ï¼Œç¢ºä¿åœ¨åˆ—å°æ™‚å¯ä»¥å®Œå…¨è¦†è“‹ */
            top: 0;
            left: 0;
            z-index: 9999;
        }
        
        /* æ¨™é¡Œ - å…¬å¸åç¨±ç½®ä¸­ */
        .print-header h1 {
            font-size: 24px;
            font-weight: bold;
            text-align: center; 
        }

        /* ------------------------------------- */
        /* ğŸ¯ V20 ä¿®æ­£é»: è¡¨æ ¼ç·šæ¢ç”±å…§è¯æ¨£å¼è™•ç†ï¼Œæ­¤è™•ä¿ç•™æœ€å°åŒ–æ¨£å¼ */
        /* ------------------------------------- */
        .print-info-table, table.print-items-table {
            width: 100%;
            border-collapse: collapse; /* è®“å…§è¯æ¨£å¼å¯ä»¥ç–ŠåŠ é‚Šæ¡† */
        }

        .print-info-label {
            width: 15%;
            background: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }
        
        /* æ•¸é‡ç½®ä¸­ */
        .print-items-table td:nth-child(5) { 
            text-align: center;
        }

        /* å–®åƒ¹é å³ */
        .print-items-table td:nth-child(6) { 
            text-align: right;
        }
        
        /* é‡‘é¡é å³å°é½Š (æ”¾å¤§å­—é«”) */
        .print-items-table td:nth-child(7) { 
            text-align: right;
            font-weight: bold; 
            font-size: 14px; 
        }
        
        /* ç¸½è¨ˆå€å¡Š */
        .print-total-box {
            border: 1px solid black !important;
            padding: 10px;
            font-size: 14px;
            margin-top: 10px;
        }

        /* åœ–ç‰‡åˆ—å°æ¨£å¼ */
        .print-image {
            max-width: 150px; 
            height: auto;
            margin-top: 5px;
            display: block;
        }

        /* å‚™è¨»/ä»˜æ¬¾æ¢ä»¶å€å¡Šé‚Šæ¡†å¼·åŒ– */
        .print-notes-box {
            margin-top: 15px;
            border: 1px solid black !important; 
            padding: 10px;
            white-space: pre-wrap; /* ç¢ºä¿æ›è¡Œè¢«ä¿ç•™ */
        }
        
        /* ä¿®æ­£ React è­¦å‘Šï¼štr å…§ä¸æ‡‰æœ‰é¡å¤–çš„ç©ºç™½ç¯€é» */
        .print-items-table tr.sub-item-note td {
            padding: 2px 6px; /* ç•¥å°é–“è· */
        }
    }
    
    /* ----------------------------------------------- */
    /* ç¢ºä¿éåˆ—å°æ™‚ï¼Œé è¦½å€åªåœ¨ App åº•éƒ¨é¡¯ç¤º */
    /* ----------------------------------------------- */
    #quotePreviewArea {
        display: none; 
    }
    
    .live-preview-box {
        background: #fdfdfd; 
        border: 2px dashed #00bfff; 
        padding: 30px;
        margin-top: 40px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .live-preview-box .print-page {
        /* é™åˆ¶é è¦½å€å¯¬åº¦ï¼Œæ¨¡æ“¬ A4 è¦–è¦ºæ•ˆæœ */
        max-width: 210mm; 
        margin: 0 auto;
        /* è®“é è¦½å€æœ‰æ˜é¡¯çš„å¯¦ç·šé‚Šæ¡† */
        border: 2px solid #ccc; 
        padding: 10px;
        box-sizing: border-box;
        transform: scale(0.85); /* ç¸®å°æ¯”ä¾‹ï¼Œè®“é è¦½æ›´ç¬¦åˆç•«é¢ */
        transform-origin: top center; 
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.15); 
    }
    </style>
</head>

<body class="text-gray-900">

    <div id="root"></div>
    
    <div id="quotePreviewArea">
        {/* PrintLayout Component å°‡æœƒåœ¨é€™è£¡è¢«æ¸²æŸ“ï¼Œç„¶å¾Œåˆ—å° */}
    </div>

<script type="text/babel">
// P1 â€” å…¬å¸è³‡æ–™ / ä»˜æ¬¾æ¢ä»¶ / å‚™è¨» / æ¨¡å¼æ¨¡æ¿
const COMPANY_DATA = {
    // å…¬å¸åœ°å€
    herhsin: {
        name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
        tel: "07-6517476",
        fax: "07-6517994",
        email: "admin@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "herhsin_stamp_placeholder.png", 
        prefix: "QH" 
    },
    sinchang: {
        name: "è–ªæ˜Œæœ‰é™å…¬å¸",
        tel: "07-6521927",
        fax: "07-6517994",
        email: "affairs@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "sinchang_stamp_placeholder.png", 
        prefix: "QS" 
    }
};

// é è¨­å‚™è¨»
const DEFAULT_NOTES = `1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚`;

// é è¨­ä»˜æ¬¾æ¢ä»¶
const DEFAULT_PAYMENT = `è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%`;

// å ±åƒ¹æ¨¡å¼æ¨¡æ¿
const QUOTE_MODES = [
    {
        id: "modeA",
        name: "æ‹Œåˆæ©Ÿæ¼æ¼¿æ›´æ›",
        description: "é©ç”¨æ‹Œåˆæ©Ÿç¶­ä¿®ã€æ¼æ¼¿è™•ç†ç­‰ã€‚",
        defaultItems: [],
        defaultNotes: DEFAULT_NOTES,
        defaultPayment: DEFAULT_PAYMENT
    },
    {
        id: "modeB",
        name: "è¨­å‚™éŠ·å”®",
        description: "é©ç”¨å‚™å“ã€å–®æ©ŸéŠ·å”®èˆ‡å®‰è£ã€‚",
        defaultItems: [],
        defaultNotes: DEFAULT_NOTES,
        defaultPayment: DEFAULT_PAYMENT
    },
    {
        id: "modeC",
        name: "è¨­å‚™æ›´æ›å·¥ç¨‹",
        description: "é©ç”¨æ•´æ©Ÿæ›´æ–°ã€æ–™ä»¶æ›´æ›å·¥ç¨‹ã€‚",
        defaultItems: [],
        defaultNotes: DEFAULT_NOTES,
        defaultPayment: DEFAULT_PAYMENT
    }
];

// P2 â€” å·¥å…·å‡½å¼ï¼ˆå®Œæ•´ï¼‰
function uuid() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}

function formatDate(dateStr = new Date()) {
    const d = dateStr instanceof Date ? dateStr : new Date(dateStr);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`; // æ”¹ç‚º ISO æ ¼å¼ä»¥åˆ© input type="date"
}

function formatMoney(num) {
    // è™•ç†ç©ºå€¼å’Œéæ•¸å­—ï¼Œä½†å…è¨±æ•¸å­— 0
    if (num === "" || num === null || num === undefined || isNaN(Number(num))) return "0"; 
    return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 });
}

function calcAmount(item) {
    // ç¢ºä¿ qty å’Œ price è½‰ç‚ºæ•¸å­—ï¼Œå¦å‰‡ç‚º 0
    const qty = Number(item.qty || 0);
    const price = Number(item.price || 0);
    return qty * price;
}

function calcTotal(items) {
    return items.reduce((sum, it) => {
        let mainAmt = calcAmount(it);
        let subs = 0;

        if (it.subItems && it.subItems.length > 0) {
            // è¨ˆç®—æ‰€æœ‰ item é¡å‹çš„ subItem çš„é‡‘é¡
            subs = it.subItems.reduce((s, sub) => (sub.type === 'item' ? s + calcAmount(sub) : s), 0);
        }

        return sum + mainAmt + subs;
    }, 0);
}

function calcNegotiated(total, discountPercent, customPrice) {
    const cp = Number(customPrice || 0);
    const dp = Number(discountPercent || 0);
    
    // è‡ªå®šç¾©åƒ¹æ ¼å„ªå…ˆ (å¦‚æœæœ‰å¡«å¯«ï¼Œå“ªæ€•æ˜¯ 0 ä¹Ÿæœƒè¢«å„ªå…ˆè™•ç†ï¼Œä½†é€šå¸¸ä½¿ç”¨è€…å¡«å¯«æ˜¯ç‚ºäº†è­°åƒ¹)
    if (cp > 0) return cp;
    
    // æŠ˜æ‰£æ¬¡ä¹‹
    if (dp > 0 && dp <= 100) { // å…è¨± 100% æŠ˜æ‰£ (è®Šæˆ 0)
        // å››æ¨äº”å…¥
        return Math.round(total * (1 - dp / 100));
    }
    
    // ç„¡æŠ˜æ‰£æˆ–è­°åƒ¹ï¼Œå‰‡å›å‚³åŸå§‹ç¸½åƒ¹
    return total;
}

// å ±åƒ¹å–®ç·¨è™Ÿ
function generateQuoteNo(companyKey) {
    const prefix = COMPANY_DATA[companyKey]?.prefix || "Q"; 
    
    // ä½¿ç”¨ YYYYMMDDHHMM + 4ä½äº‚æ•¸
    const d = new Date();
    const parts = [
        d.getFullYear(),
        String(d.getMonth() + 1).padStart(2, "0"),
        String(d.getDate()).padStart(2, "0"),
        String(d.getHours()).padStart(2, "0"),
        String(d.getMinutes()).padStart(2, "0"),
    ].join('');
    
    const random = Math.floor(1000 + Math.random() * 9000);
    
    return `${prefix}${parts}-${random}`; 
}

// è¼‰å…¥ Google Sheet CSV (éåŒæ­¥å‡½å¼)
async function loadCSV(url) {
    try {
        const res = await fetch(url);
        const text = await res.text();
        
        // å‡è¨­ç¬¬ä¸€è¡Œç‚ºæ¨™é ­
        const rows = text.split("\n").map(r => r.trim()).filter(r => r.length > 0);
        if (rows.length < 2) return [];
        
        // ç¢ºä¿æ¨™é ­ä¸åŒ…å«é›™å¼•è™Ÿ
        const header = rows[0].split(",").map(h => h.trim().replace(/"/g, ''));

        return rows.slice(1).map(row => {
            // ä½¿ç”¨æ­£è¦è¡¨é”å¼è™•ç† CSV å…§åµŒé€—è™Ÿå’Œå¼•è™Ÿ
            // é€™æ˜¯æ›´å¥å£¯çš„ CSV è§£ææ–¹å¼
            const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
            const obj = {};

            header.forEach((h, i) => {
                let value = cols[i] ? cols[i].trim() : "";
                // ç§»é™¤å‰å¾Œå¼•è™Ÿ
                if (value.startsWith('"') && value.endsWith('"')) {
                    value = value.substring(1, value.length - 1);
                }
                obj[h] = value;
            });
            return obj;
        });
    } catch (error) {
        console.error("è¼‰å…¥æˆ–è§£æ Google Sheet CSV å¤±æ•—:", error);
        return [];
    }
}


// P3 â€” AppContextï¼ˆæ ¸å¿ƒè³‡æ–™ä¸­å¿ƒï¼‰
const AppContext = React.createContext();

function AppProvider({ children }) {
    // å…¬å¸ herhsin / sinchang
    const [company, setCompany] = React.useState("herhsin");

    // å ±åƒ¹å–®åˆ—è¡¨
    const [quotes, setQuotes] = React.useState([]);

    // æ­£åœ¨ç·¨è¼¯çš„å ±åƒ¹å–® ID
    const [activeQuoteId, setActiveQuoteId] = React.useState(null);

    // è¦æ ¼å“ï¼ˆä¾†è‡ª Google Sheetï¼‰
    const [specItems, setSpecItems] = React.useState([]);

    // Google Sheet è·¯å¾‘ (è«‹å‹™å¿…å°‡æ­¤æ›¿æ›ç‚ºæ‚¨çš„å…¬é–‹ CSV é€£çµ)
    // ç¯„ä¾‹é€£çµï¼šhttps://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv
    const SPEC_CSV_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv"; 
        

    //************* åˆå§‹åŒ–ï¼šå¾ localStorage è¼‰å…¥ *************/
    React.useEffect(() => {
        const saved = localStorage.getItem("HERHSIN_QUOTES");

        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                // ç¢ºä¿è¼‰å…¥çš„æ˜¯é™£åˆ—
                if (Array.isArray(parsed)) {
                    setQuotes(parsed);
                    if (parsed.length > 0) setActiveQuoteId(parsed[0].id);
                }
            } catch (e) {
                console.error("è§£æ localStorage æ•¸æ“šå¤±æ•—:", e);
                setQuotes([]);
                setActiveQuoteId(null);
            }
        }
    }, []);

    //************* è‡ªå‹•å­˜å› localStorage *************/
    React.useEffect(() => {
        try {
            localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
        } catch (e) {
            console.error("å¯«å…¥ localStorage å¤±æ•—:", e);
        }
    }, [quotes]);


    //************* è¼‰å…¥ Google Sheet è¦æ ¼å“ *************/
    const loadSpecItems = React.useCallback(() => {
        loadCSV(SPEC_CSV_URL).then(data => setSpecItems(data));
    }, [SPEC_CSV_URL]);

    React.useEffect(() => {
        // ç¶²é ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚åŸ·è¡Œ
        loadSpecItems();
    }, [loadSpecItems]);


    // å»ºç«‹æ–°å ±åƒ¹å–®ï¼ˆå¯å¥—ç”¨æ¨¡å¼ï¼‰
    const createQuote = React.useCallback((modeId = null) => {
        const mode = QUOTE_MODES.find(m => m.id === modeId);

        // åœ¨å»ºç«‹å ±åƒ¹å–®æ™‚ï¼Œæ ¹æ“šç•¶å‰é¸å®šçš„ company ç”¢ç”Ÿç·¨è™Ÿ
        const newQuote = {
            id: uuid(),
            quoteNo: generateQuoteNo(company), 
            title: mode ? mode.name : "æœªå‘½åå·¥ç¨‹",
            customerName: "",
            contact: "",
            phone: "",
            location: "",
            date: formatDate(), 
            items: mode && Array.isArray(mode.defaultItems) ? mode.defaultItems.map(item => ({
                ...item, 
                id: uuid(), 
                subItems: [],
                // é …ç›®è¦æ ¼æ¬„ä½
                specMain: "", // è¦æ ¼ (ä¸»æè¿°)
                specMaterial: "", // ç”¨æ–™æ˜ç´° (ç”¨æ–™1/2/3 åˆä½µ)
                remarks: "" // å‚™è¨»
            })) : [],
            notes: mode ? mode.defaultNotes : DEFAULT_NOTES,
            payment: mode ? mode.defaultPayment : DEFAULT_PAYMENT,
            discountPercent: 0,
            negotiatedPrice: 0
        };

        setQuotes(prev => {
            const newList = [newQuote, ...prev]; // æ–°å ±åƒ¹å–®æ”¾åœ¨æœ€å‰é¢
            setActiveQuoteId(newQuote.id);
            return newList;
        });
    }, [company]);


    // åˆªé™¤å ±åƒ¹å–®
    const deleteQuote = React.useCallback((id) => {
        setQuotes(prev => {
            const newList = prev.filter(q => q.id !== id);
            
            if (id === activeQuoteId) {
                setActiveQuoteId(newList.length > 0 ? newList[0].id : null);
            }
            return newList;
        });
    }, [activeQuoteId]);


    // æ›´æ–°å ±åƒ¹å–®æ¬„ä½
    const updateQuote = React.useCallback((id, data) => {
        setQuotes(prev =>
            prev.map(q => (q.id === id ? { ...q, ...data } : q))
        );
    }, []);


    // å¥—ç”¨æ¨¡å¼ï¼ˆè¦†è“‹ï¼šæ¨™é¡Œã€å‚™è¨»ã€ä»˜æ¬¾ã€é è¨­é …ç›®ï¼‰
    const applyMode = React.useCallback((modeId) => {
        const mode = QUOTE_MODES.find(m => m.id === modeId);
        if (!mode || !activeQuoteId) return;

        // ç¢ºä¿ defaultItems ä¸­çš„æ¯å€‹ item éƒ½æœ‰å”¯ä¸€çš„ id
        const itemsWithIds = mode.defaultItems.map(item => ({
            ...item, 
            id: uuid(), 
            subItems: [],
            // åˆå§‹åŒ–è¦æ ¼æ¬„ä½
            specMain: "", 
            specMaterial: "", 
            remarks: ""
        }));

        updateQuote(activeQuoteId, {
            title: mode.name,
            items: itemsWithIds, 
            notes: mode.defaultNotes,
            payment: mode.defaultPayment,
        });
    }, [activeQuoteId, updateQuote]);


    // Context æä¾›çµ¦å…¨ App
    const activeQuote = quotes.find(q => q.id === activeQuoteId);
    
    const value = {
        company,
        setCompany,

        quotes,
        createQuote,
        deleteQuote,
        updateQuote,
        activeQuote, 
        activeQuoteId,
        setActiveQuoteId,

        specItems,
        loadSpecItems, 
        applyMode
    };

    // è®“åˆ—å°å’Œ Excel åŒ¯å‡ºåŠŸèƒ½å¯ä»¥å…¨åŸŸæŠ“åˆ° Context
    window.__APP_CONTEXT__ = value;

    return (
        <AppContext.Provider value={value}>
            {children}
        </AppContext.Provider>
    );
}
// P4-1 â€” å·¦å´å…ƒä»¶ï¼šå…¬å¸åˆ‡æ› / æ¨¡å¼é¸æ“‡ / å ±åƒ¹å–®åˆ—è¡¨


// --------------------------------------------------
// å…¬å¸åˆ‡æ›ï¼ˆä½•é‘« / è–ªæ˜Œï¼‰
// --------------------------------------------------
function CompanySelector() {
    const { company, setCompany } = React.useContext(AppContext);

    return (
        <div className="mb-6 no-print">
            <div className="font-bold mb-2">é¸æ“‡å…¬å¸</div>

            <div className="flex gap-2">
                <button
                    className={`px-3 py-1 rounded ${
                        company === "herhsin"
                            ? "bg-blue-600 text-white"
                            : "bg-gray-300 hover:bg-gray-400"
                    }`}
                    onClick={() => setCompany("herhsin")}
                >
                    ä½•é‘«å¯¦æ¥­
                </button>

                <button
                    className={`px-3 py-1 rounded ${
                        company === "sinchang"
                            ? "bg-blue-600 text-white"
                            : "bg-gray-300 hover:bg-gray-400"
                    }`}
                    onClick={() => setCompany("sinchang")}
                >
                    è–ªæ˜Œæœ‰é™å…¬å¸
                </button>
            </div>
        </div>
    );
}
// --------------------------------------------------
// æ¨¡å¼é¸æ“‡
// --------------------------------------------------
function ModeSelector() {
    const { createQuote, applyMode } = React.useContext(AppContext);
    
    const [selectedMode, setSelectedMode] = React.useState("");
    const [isNew, setIsNew] = React.useState(true); // æ˜¯å¦ç‚ºæ–°å»ºå ±åƒ¹å–®

    const handleApply = () => {
        if (!selectedMode) return;

        if (isNew) {
            createQuote(selectedMode); // å»ºç«‹æ–°å ±åƒ¹å–®ä¸¦å¥—ç”¨æ¨¡å¼
        } else {
            applyMode(selectedMode); // å¥—ç”¨æ¨¡å¼åˆ°ç•¶å‰å ±åƒ¹å–®
        }
        setSelectedMode(""); // æ¸…ç©ºé¸æ“‡
    };

    return (
        <div className="mb-6 border-b border-gray-300 pb-4 no-print">
            <div className="font-bold mb-2">æ¨¡å¼å¥—ç”¨ ({isNew ? 'æ–°å»º' : 'è¦†è“‹'})</div>
            
            <div className='flex gap-2 mb-3'>
                 <button
                    className={`px-3 py-1 text-sm rounded ${
                        isNew
                            ? "bg-green-600 text-white"
                            : "bg-gray-300 hover:bg-gray-400"
                    }`}
                    onClick={() => setIsNew(true)}
                >
                    æ–°å»ºå ±åƒ¹å–®
                </button>
                 <button
                    className={`px-3 py-1 text-sm rounded ${
                        !isNew
                            ? "bg-orange-600 text-white"
                            : "bg-gray-300 hover:bg-gray-400"
                    }`}
                    onClick={() => setIsNew(false)}
                >
                    å¥—ç”¨è‡³ç•¶å‰
                </button>
            </div>


            <select
                className="w-full border p-2 mb-3 rounded"
                value={selectedMode}
                onChange={e => setSelectedMode(e.target.value)}
            >
                <option value="" disabled>è«‹é¸æ“‡å ±åƒ¹æ¨¡å¼</option>
                {QUOTE_MODES.map(mode => (
                    <option key={mode.id} value={mode.id}>
                        {mode.name} - {mode.description}
                    </option>
                ))}
            </select>

            <button
                className="w-full bg-blue-500 text-white py-2 rounded disabled:opacity-50 hover:bg-blue-600"
                onClick={handleApply}
                disabled={!selectedMode}
            >
                {isNew ? 'æ–°å»ºå ±åƒ¹å–®ä¸¦å¥—ç”¨æ¨¡å¼' : 'å¥—ç”¨æ¨¡å¼è‡³ç•¶å‰å ±åƒ¹å–®'}
            </button>
        </div>
    );
}

// --------------------------------------------------
// å ±åƒ¹å–®åˆ—è¡¨
// --------------------------------------------------
function QuoteList() {
    const { quotes, activeQuoteId, setActiveQuoteId, deleteQuote } = React.useContext(AppContext);

    return (
        <div className="no-print">
            <h3 className="text-lg font-bold mb-3 border-b pb-1">å ±åƒ¹å–®åˆ—è¡¨</h3>
            
            <button 
                className="w-full bg-purple-600 text-white py-2 rounded text-sm mb-3 hover:bg-purple-700" 
                onClick={() => setActiveQuoteId(null)}>
                éš±è—ç·¨è¼¯/é¡¯ç¤ºæ‰€æœ‰å ±åƒ¹å–®
            </button>


            {quotes.map(quote => (
                <div
                    key={quote.id}
                    className={`p-3 mb-2 rounded border cursor-pointer flex justify-between items-center transition-all ${
                        quote.id === activeQuoteId
                            ? "bg-red-600 text-white border-red-600 shadow-lg"
                            : "bg-white hover:bg-gray-100"
                    }`}
                    onClick={() => setActiveQuoteId(quote.id)}
                >
                    <div>
                        <div className="font-bold text-sm truncate">
                            {quote.title || "æœªå‘½å"}
                        </div>
                        <div className="text-xs opacity-80">
                            {quote.date} - {quote.customerName || "æ–°å®¢æˆ¶"}
                        </div>
                    </div>
                    
                    <button
                        className={`text-xs ml-3 px-2 py-0.5 rounded ${
                            quote.id === activeQuoteId ? 'bg-white text-red-600' : 'bg-red-500 text-white hover:bg-red-600'
                        }`}
                        onClick={(e) => {
                            e.stopPropagation(); // é¿å…è§¸ç™¼ setActiveQuoteId
                            if (window.confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å ±åƒ¹å–®å—?")) {
                                deleteQuote(quote.id);
                            }
                        }}
                    >
                        åˆªé™¤
                    </button>
                </div>
            ))}
            
            {quotes.length === 0 && (
                <div className="text-center text-gray-500 text-sm py-4">
                    ç›®å‰æ²’æœ‰å ±åƒ¹å–®
                </div>
            )}
        </div>
    );
}


// P4-2 â€” å³å´å…ƒä»¶ï¼šå ±åƒ¹å–®ç·¨è¼¯å€


// --------------------------------------------------
// è¦æ ¼å“å»ºè­°é¸æ“‡å™¨
// --------------------------------------------------
function SpecItemSuggest({ item, updateItem, isSubItem = false }) {
    const { specItems } = React.useContext(AppContext);
    const [searchTerm, setSearchTerm] = React.useState("");
    const [suggestions, setSuggestions] = React.useState([]);

    // ä¾è³´æ–¼ item.name å’Œ item.specMain é€²è¡Œæœç´¢
    React.useEffect(() => {
        if (searchTerm.length < 1) {
            setSuggestions([]);
            return;
        }

        const filtered = specItems.filter(spec => {
            const searchLower = searchTerm.toLowerCase();
            const nameMatch = (spec['å“å'] || '').toLowerCase().includes(searchLower);
            const specMatch = (spec['è¦æ ¼'] || '').toLowerCase().includes(searchLower);
            return nameMatch || specMatch;
        });

        setSuggestions(filtered.slice(0, 10)); // åªé¡¯ç¤ºå‰ 10 ç­†
    }, [searchTerm, specItems]);

    const handleSelectSpecItem = (specItem) => {
        // ğŸ¯ V20 ä¿®æ­£é»: ç¢ºä¿è¦æ ¼å“çš„å‚™è¨»æ¬„ä½è¢«æ­£ç¢ºæŠ“å–ä¸¦è³¦å€¼
        updateItem({
            name: specItem['å“å'] || item.name,
            specMain: specItem['è¦æ ¼'] || item.specMain,
            // ç”±æ–¼ Google Sheet æ¬„ä½ç‚º 'å–®åƒ¹', éœ€è¦ç¢ºä¿è½‰æ›ç‚ºæ•¸å­—
            price: Number(specItem['å–®åƒ¹']) || item.price, 
            unit: specItem['å–®ä½'] || item.unit,
            
            // ---------------------------------------------------
            // ğŸ¯ V20 é—œéµä¿®æ­£ 1: æŠ“å– Google Sheet çš„ 'å‚™è¨»' æ¬„ä½
            // ---------------------------------------------------
            remarks: specItem['å‚™è¨»'] || "" ,
            
            // ç”¨æ–™æ˜ç´°åˆä½µ 
            specMaterial: [
                specItem['ç”¨æ–™1'], 
                specItem['ç”¨æ–™2'], 
                specItem['ç”¨æ–™3']
            ].filter(Boolean).join(' | ') 
        });
        setSearchTerm("");
        setSuggestions([]);
    };
    
    // æç¤ºæ–‡å­—ï¼ˆçµ¦ä½¿ç”¨è€…çœ‹ï¼‰
    const placeholder = isSubItem ? "å­é …ç›®" : "é¸æ“‡è¦æ ¼å“æˆ–è¼¸å…¥å“å";

    return (
        <div className="relative">
            <input
                type="text"
                value={item.name}
                onChange={(e) => {
                    const value = e.target.value;
                    updateItem({ name: value });
                    setSearchTerm(value); // åŒæ­¥åˆ°æœç´¢è©
                }}
                placeholder={placeholder}
                className="w-full border p-2 rounded focus:ring-blue-500 focus:border-blue-500 text-sm"
            />
            {suggestions.length > 0 && searchTerm.length > 0 && (
                <div className="absolute z-10 w-full bg-white border border-gray-300 rounded shadow-lg mt-1 max-h-60 overflow-y-auto">
                    {suggestions.map((spec, index) => (
                        <div
                            key={index}
                            className="p-2 border-b cursor-pointer hover:bg-blue-100 text-sm"
                            onClick={() => handleSelectSpecItem(spec)}
                        >
                            <div className="font-bold">{spec['å“å']}</div>
                            <div className="text-gray-600 text-xs">
                                è¦æ ¼: {spec['è¦æ ¼']} | å–®åƒ¹: {formatMoney(spec['å–®åƒ¹'])}
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

// --------------------------------------------------
// å ±åƒ¹é …ç›®è¼¸å…¥
// --------------------------------------------------
function QuoteItem({ item, index, updateItem, deleteItem, updateSubItem, deleteSubItem, isSubItem = false }) {
    
    // ä¸»é …ç›®çš„ç¸½é‡‘é¡ï¼ˆåŒ…å«ä¸»é …å’Œå°è¨ˆï¼‰
    const itemTotal = React.useMemo(() => {
        let total = calcAmount(item);
        if (item.subItems) {
            total += item.subItems.reduce((sum, sub) => (sub.type === 'item' ? sum + calcAmount(sub) : sum), 0);
        }
        return total;
    }, [item]);
    
    // æ›´æ–°å­é …ç›®
    const handleUpdateSubItem = (subId, data) => {
        const newSubItems = item.subItems.map(sub => 
            sub.id === subId ? { ...sub, ...data } : sub
        );
        updateItem({ subItems: newSubItems });
    };

    // åˆªé™¤å­é …ç›®
    const handleDeleteSubItem = (subId) => {
        const newSubItems = item.subItems.filter(sub => sub.id !== subId);
        updateItem({ subItems: newSubItems });
    };

    // æ–°å¢å­é …ç›®
    const handleAddSubItem = (type) => {
        const newSub = {
            id: uuid(),
            type: type, // 'item', 'text', 'image'
            name: type === 'text' ? 'è£œå……æ–‡å­—' : (type === 'image' ? 'è£œå……åœ–ç‰‡' : 'æœªå‘½åå­é …ç›®'),
            specMain: "",
            unit: "å¼",
            qty: 1,
            price: 0
        };
        updateItem({ subItems: [...(item.subItems || []), newSub] });
    };

    // åˆªé™¤æŒ‰éˆ•
    const DeleteButton = () => (
        <button
            onClick={() => deleteItem(item.id)}
            className="text-red-500 hover:text-red-700 ml-2 text-xl"
            title="åˆªé™¤æ­¤é …ç›®"
        >
            &times;
        </button>
    );
    
    // -----------------------------------------------------------
    // æ¸²æŸ“å­é …ç›®
    // -----------------------------------------------------------
    const renderSubItem = (sub, subIndex) => {
        const isItem = sub.type === 'item';
        const isText = sub.type === 'text';
        const isImage = sub.type === 'image';
        
        const subItemProps = {
            item: sub,
            index: subIndex,
            updateItem: (data) => handleUpdateSubItem(sub.id, data),
            deleteItem: handleDeleteSubItem,
            isSubItem: true
        };

        return (
            <div key={sub.id} className="ml-8 mt-2 p-2 bg-gray-50 border-l-4 border-gray-300 rounded">
                <div className="flex items-start">
                    <div className="w-full grid gap-2" style={{ gridTemplateColumns: isItem ? '2fr 1.5fr 0.8fr 0.7fr 1.2fr 1fr auto' : '1fr auto' }}>
                        
                        {isItem && (
                             <>
                                <SpecItemSuggest 
                                    item={sub} 
                                    updateItem={(data) => handleUpdateSubItem(sub.id, data)}
                                    isSubItem={true}
                                />
                                <input
                                    type="text"
                                    value={sub.specMain}
                                    onChange={(e) => handleUpdateSubItem(sub.id, { specMain: e.target.value })}
                                    placeholder="è¦æ ¼ (ä¸»æè¿°)"
                                    className="border p-1 rounded text-sm"
                                />
                                <input
                                    type="text"
                                    value={sub.unit}
                                    onChange={(e) => handleUpdateSubItem(sub.id, { unit: e.target.value })}
                                    placeholder="å–®ä½"
                                    className="border p-1 rounded text-sm text-center"
                                />
                                <input
                                    type="number"
                                    value={sub.qty}
                                    onChange={(e) => handleUpdateSubItem(sub.id, { qty: e.target.value })}
                                    placeholder="æ•¸é‡"
                                    min="0"
                                    className="border p-1 rounded text-sm text-right"
                                />
                                <input
                                    type="number"
                                    value={sub.price}
                                    onChange={(e) => handleUpdateSubItem(sub.id, { price: e.target.value })}
                                    placeholder="å–®åƒ¹"
                                    min="0"
                                    className="border p-1 rounded text-sm text-right"
                                />
                                <div className="p-1 text-right font-semibold text-red-500">
                                    {formatMoney(calcAmount(sub))}
                                </div>
                            </>
                        )}
                        
                        {/* è£œå……æ–‡å­—æˆ–åœ–ç‰‡ - å¯¬åº¦ä½”æ»¿ */}
                        {(isText || isImage) && (
                            <div className='col-span-6'>
                                <input
                                    type="text"
                                    value={sub.name}
                                    onChange={(e) => handleUpdateSubItem(sub.id, { name: e.target.value })}
                                    placeholder={isText ? "è¼¸å…¥è£œå……æ–‡å­—" : "è¼¸å…¥åœ–ç‰‡ URL"}
                                    className="w-full border p-1 rounded text-sm bg-yellow-50"
                                />
                                {isImage && sub.name && (
                                    <div className='mt-2'>
                                        <img src={sub.name} alt="Preview" className="max-w-xs max-h-32 object-contain border p-1" />
                                    </div>
                                )}
                                {isText && (
                                    <textarea
                                        value={sub.remarks} // ç”¨ remarks æ¬„ä½ä¾†æ”¾æ–‡å­—å…§å®¹
                                        onChange={(e) => handleUpdateSubItem(sub.id, { remarks: e.target.value })}
                                        placeholder="è¼¸å…¥æ–‡å­—å…§å®¹ (å°‡é¡¯ç¤ºåœ¨å ±åƒ¹å–®ä¸Š)"
                                        rows="3"
                                        className="w-full border p-1 mt-1 rounded text-sm"
                                    ></textarea>
                                )}
                            </div>
                        )}
                        
                    </div>
                    <button 
                        onClick={() => handleDeleteSubItem(sub.id)}
                        className="text-red-500 hover:text-red-700 ml-2 text-xl self-start"
                        title="åˆªé™¤æ­¤å­é …ç›®"
                    >
                        &times;
                    </button>
                </div>
                
                {/* é¡¯ç¤ºç”¨æ–™æ˜ç´° (åƒ… subItem type='item') */}
                {isItem && item.specMaterial && (
                    <div className='text-xs text-gray-500 mt-1 pl-1'>
                        **ç”¨æ–™æ˜ç´°:** {sub.specMaterial}
                    </div>
                )}
            </div>
        );
    };


    return (
        <div className={`mb-4 p-4 rounded ${isSubItem ? '' : 'bg-white shadow-md border'}`}>
            <div className="flex items-start">
                <div className="font-bold mr-2 text-red-600 w-8 flex-shrink-0 text-right">
                    {isSubItem ? '' : `(${index + 1})`}
                </div>

                <div className="w-full">
                    {/* ä¸»é …ç›®/å­é …ç›®è¼¸å…¥å€ */}
                    <div className="grid gap-2" style={{ gridTemplateColumns: '2fr 1.5fr 0.8fr 0.7fr 1.2fr 1fr auto' }}>
                        
                        {/* å“å (ä½¿ç”¨ Suggest) */}
                        <SpecItemSuggest 
                            item={item} 
                            updateItem={updateItem}
                            isSubItem={isSubItem}
                        />
                        
                        {/* è¦æ ¼ (ä¸»æè¿°) */}
                        <input
                            type="text"
                            value={item.specMain}
                            onChange={(e) => updateItem({ specMain: e.target.value })}
                            placeholder="è¦æ ¼ (ä¸»æè¿°)"
                            className="border p-2 rounded text-sm"
                        />
                        
                        {/* å–®ä½ */}
                        <input
                            type="text"
                            value={item.unit}
                            onChange={(e) => updateItem({ unit: e.target.value })}
                            placeholder="å–®ä½"
                            className="border p-2 rounded text-sm text-center"
                        />
                        
                        {/* æ•¸é‡ */}
                        <input
                            type="number"
                            value={item.qty}
                            onChange={(e) => updateItem({ qty: e.target.value })}
                            placeholder="æ•¸é‡"
                            min="0"
                            className="border p-2 rounded text-sm text-right"
                        />
                        
                        {/* å–®åƒ¹ */}
                        <input
                            type="number"
                            value={item.price}
                            onChange={(e) => updateItem({ price: e.target.value })}
                            placeholder="å–®åƒ¹"
                            min="0"
                            className="border p-2 rounded text-sm text-right"
                        />
                        
                        {/* å°è¨ˆ */}
                        <div className="p-2 text-right font-semibold text-red-600">
                            {formatMoney(calcAmount(item))}
                        </div>
                        
                        {/* åˆªé™¤æŒ‰éˆ• */}
                        <DeleteButton />
                    </div>
                    
                    {/* å‚™è¨» (ç¨ç«‹ä¸€è¡Œ) */}
                    <div className="mt-2">
                        <input
                            type="text"
                            value={item.remarks}
                            onChange={(e) => updateItem({ remarks: e.target.value })}
                            placeholder="å‚™è¨» (å°‡é¡¯ç¤ºåœ¨å ±åƒ¹å–®å‚™è¨»æ¬„)"
                            className="w-full border p-2 rounded text-sm bg-yellow-50"
                        />
                    </div>
                    
                    {/* ç”¨æ–™æ˜ç´° (åªåœ¨ä¸»é …ç›®é¡¯ç¤º) */}
                    {item.specMaterial && (
                        <div className='text-xs text-gray-500 mt-1 pl-1'>
                            **ç”¨æ–™æ˜ç´°:** {item.specMaterial}
                        </div>
                    )}
                    
                    {/* å­é …ç›®æ“ä½œæŒ‰éˆ• (åªåœ¨ä¸»é …ç›®é¡¯ç¤º) */}
                    {!isSubItem && (
                        <div className="flex gap-4 mt-3 text-sm text-blue-600 font-semibold border-t pt-2">
                            <button onClick={() => handleAddSubItem('item')}>+ å­é …ç›® (é‡‘é¡è¨ˆç®—)</button>
                            <button onClick={() => handleAddSubItem('text')}>+ è£œå……æ–‡å­— (å‚™è¨»)</button>
                            <button onClick={() => handleAddSubItem('image')}>+ è£œå……åœ–ç‰‡ (URL)</button>
                        </div>
                    )}
                    
                    {/* æ¸²æŸ“å­é …ç›®åˆ—è¡¨ */}
                    {(item.subItems || []).map(renderSubItem)}

                </div>
            </div>
        </div>
    );
}

// --------------------------------------------------
// å ±åƒ¹å–®ç·¨è¼¯ä¸»å…ƒä»¶
// --------------------------------------------------
function QuoteEditor() {
    const { activeQuote, updateQuote } = React.useContext(AppContext);

    if (!activeQuote) {
        return (
            <div className="p-8 text-center text-gray-500 text-xl">
                è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹å ±åƒ¹å–®æˆ–æ–°å»ºä¸€å€‹å ±åƒ¹å–®ã€‚
            </div>
        );
    }
    
    // æ›´æ–°å ±åƒ¹å–®åŸºç¤æ¬„ä½
    const handleChange = (field, value) => {
        updateQuote(activeQuote.id, { [field]: value });
    };

    // æ›´æ–°å ±åƒ¹é …ç›®
    const handleUpdateItem = (itemId, data) => {
        const newItems = activeQuote.items.map(item => 
            item.id === itemId ? { ...item, ...data } : item
        );
        updateQuote(activeQuote.id, { items: newItems });
    };

    // åˆªé™¤å ±åƒ¹é …ç›®
    const handleDeleteItem = (itemId) => {
        const newItems = activeQuote.items.filter(item => item.id !== itemId);
        updateQuote(activeQuote.id, { items: newItems });
    };

    // æ–°å¢å ±åƒ¹å¤§é …
    const handleAddItem = () => {
        const newItem = {
            id: uuid(),
            name: "æœªå‘½åå¤§é …",
            specMain: "",
            unit: "å¼",
            qty: 1,
            price: 0,
            subItems: [],
            remarks: "",
            specMaterial: ""
        };
        updateQuote(activeQuote.id, { items: [...activeQuote.items, newItem] });
    };
    
    // è¨ˆç®—ç¸½é‡‘é¡ (æœªç¨…)
    const totalAmount = calcTotal(activeQuote.items);
    
    // è¨ˆç®—è­°åƒ¹é‡‘é¡
    const negotiatedAmount = calcNegotiated(
        totalAmount,
        activeQuote.discountPercent,
        activeQuote.negotiatedPrice
    );

    return (
        <div className="p-6 bg-gray-100 rounded-lg shadow-xl no-print">
            <h1 className="text-2xl font-bold mb-4 border-b pb-2">
                ç·¨è¼¯å ±åƒ¹å–®: {activeQuote.title || "æœªå‘½å"}
            </h1>

            {/* å ±åƒ¹å–®è³‡è¨Š */}
            <div className="bg-white p-4 rounded mb-6 grid grid-cols-2 gap-x-4 gap-y-2 text-sm shadow-inner">
                
                {/* å ±åƒ¹å–®ç·¨è™Ÿ (ä¸å¯ç·¨è¼¯) */}
                <div className="col-span-2 flex items-center mb-2">
                    <label className="font-semibold w-1/4">å ±åƒ¹å–®ç·¨è™Ÿ:</label>
                    <div className="text-lg font-mono text-blue-600">{activeQuote.quoteNo}</div>
                </div>

                {/* æ¨™é¡Œ/å·¥ç¨‹åç¨± */}
                <div className="col-span-2">
                    <label className="font-semibold block mb-1">å·¥ç¨‹åç¨±/æ¨™é¡Œ:</label>
                    <input
                        type="text"
                        value={activeQuote.title}
                        onChange={(e) => handleChange('title', e.target.value)}
                        className="w-full border p-2 rounded"
                    />
                </div>
                
                {/* å®¢æˆ¶åç¨± */}
                <div>
                    <label className="font-semibold block mb-1">å®¢æˆ¶åç¨±:</label>
                    <input
                        type="text"
                        value={activeQuote.customerName}
                        onChange={(e) => handleChange('customerName', e.target.value)}
                        className="w-full border p-2 rounded"
                    />
                </div>

                {/* è¯çµ¡äºº */}
                <div>
                    <label className="font-semibold block mb-1">è¯çµ¡äºº:</label>
                    <input
                        type="text"
                        value={activeQuote.contact}
                        onChange={(e) => handleChange('contact', e.target.value)}
                        className="w-full border p-2 rounded"
                    />
                </div>
                
                {/* è¯çµ¡é›»è©± */}
                <div>
                    <label className="font-semibold block mb-1">è¯çµ¡é›»è©±:</label>
                    <input
                        type="text"
                        value={activeQuote.phone}
                        onChange={(e) => handleChange('phone', e.target.value)}
                        className="w-full border p-2 rounded"
                    />
                </div>
                
                {/* å ±åƒ¹æ—¥æœŸ */}
                <div>
                    <label className="font-semibold block mb-1">å ±åƒ¹æ—¥æœŸ:</label>
                    <input
                        type="date"
                        value={activeQuote.date}
                        onChange={(e) => handleChange('date', e.target.value)}
                        className="w-full border p-2 rounded"
                    />
                </div>
                
                {/* å·¥ç¨‹åœ°é» */}
                <div className="col-span-2">
                    <label className="font-semibold block mb-1">å·¥ç¨‹åœ°é»:</label>
                    <input
                        type="text"
                        value={activeQuote.location}
                        onChange={(e) => handleChange('location', e.target.value)}
                        className="w-full border p-2 rounded"
                    />
                </div>
                
                {/* ç¸½è¨ˆé‡‘é¡å€å¡Š */}
                <div className="col-span-2 mt-4 p-3 bg-blue-50 rounded">
                    <div className="text-xl font-bold text-blue-800">
                        ç¸½è¨ˆé‡‘é¡ (æœªç¨…): NT$ {formatMoney(totalAmount)}
                    </div>
                </div>
                
                {/* æŠ˜æ‰£/è­°åƒ¹è¼¸å…¥ */}
                <div className="col-span-2 grid grid-cols-2 gap-4 mt-2">
                    <div>
                        <label className="font-semibold block mb-1">æŠ˜æ‰£ç™¾åˆ†æ¯” (%):</label>
                        <input
                            type="number"
                            value={activeQuote.discountPercent}
                            onChange={(e) => handleChange('discountPercent', Number(e.target.value))}
                            placeholder="0 (ä¾‹å¦‚: 10 ä»£è¡¨ä¹æŠ˜)"
                            min="0"
                            max="100"
                            className="w-full border p-2 rounded"
                        />
                    </div>
                    <div>
                        <label className="font-semibold block mb-1">æœ€çµ‚å ±åƒ¹ (è‡ªå®šç¾©):</label>
                        <input
                            type="number"
                            value={activeQuote.negotiatedPrice}
                            onChange={(e) => handleChange('negotiatedPrice', Number(e.target.value))}
                            placeholder="ç•™ç©ºæˆ– 0, å‰‡ä½¿ç”¨æŠ˜æ‰£è¨ˆç®—"
                            min="0"
                            className="w-full border p-2 rounded"
                        />
                    </div>
                </div>
                
                {/* è­°åƒ¹å¾Œé‡‘é¡ */}
                <div className="col-span-2 mt-2 p-3 bg-red-50 rounded border-l-4 border-red-500">
                    <div className="text-xl font-bold text-red-800">
                        æœ€çµ‚å ±åƒ¹é‡‘é¡ (æœªç¨…): NT$ {formatMoney(negotiatedAmount)}
                    </div>
                </div>

            </div>

            {/* å ±åƒ¹é …ç›®åˆ—è¡¨ */}
            <h2 className="text-xl font-bold mt-8 mb-4 border-b pb-2">å ±åƒ¹é …ç›®åˆ—è¡¨</h2>
            
            <button 
                className="bg-green-600 text-white px-4 py-2 rounded mb-4 hover:bg-green-700"
                onClick={handleAddItem}
            >
                + æ–°å¢å·¥ç¨‹å¤§é …
            </button>

            <div className="quote-items-container">
                {activeQuote.items.map((item, index) => (
                    <QuoteItem 
                        key={item.id}
                        item={item}
                        index={index}
                        updateItem={(data) => handleUpdateItem(item.id, data)}
                        deleteItem={handleDeleteItem}
                    />
                ))}
            </div>

            {/* å‚™è¨»èˆ‡ä»˜æ¬¾æ¢ä»¶ */}
            <div className="mt-8 grid grid-cols-2 gap-6">
                <div>
                    <h3 className="font-bold mb-2">å‚™è¨» (ä¸å«ç¨…):</h3>
                    <textarea
                        value={activeQuote.notes}
                        onChange={(e) => handleChange('notes', e.target.value)}
                        rows="8"
                        className="w-full border p-2 rounded"
                    ></textarea>
                </div>
                <div>
                    <h3 className="font-bold mb-2">ä»˜æ¬¾æ¢ä»¶:</h3>
                    <textarea
                        value={activeQuote.payment}
                        onChange={(e) => handleChange('payment', e.target.value)}
                        rows="8"
                        className="w-full border p-2 rounded"
                    ></textarea>
                </div>
            </div>
            
            {/* åŒ¯å‡º/åˆ—å°æŒ‰éˆ• */}
            <div className='mt-8 pt-4 border-t flex gap-4 justify-between'>
                <ExportButton />
                <PrintButton quote={activeQuote} totalAmount={totalAmount} negotiatedAmount={negotiatedAmount} />
            </div>

            {/* é è¦½å€ (ç·¨è¼¯æ¨¡å¼ä¸‹çš„å¯¦æ™‚é è¦½) */}
            <div className='live-preview-box'>
                <h3 className="text-center font-bold text-xl text-blue-700 mb-6">å¯¦æ™‚é è¦½å€ (éåˆ—å°å°ºå¯¸)</h3>
                <div className='print-page'>
                    <PrintLayout quote={activeQuote} totalAmount={totalAmount} negotiatedAmount={negotiatedAmount} isPreview={true} />
                </div>
            </div>

        </div>
    );
}


// P4-3 â€” åŒ¯å‡º / åˆ—å°å…ƒä»¶


// --------------------------------------------------
// Excel åŒ¯å‡ºæŒ‰éˆ•
// --------------------------------------------------
function ExportButton() {
    const { activeQuote } = React.useContext(AppContext);

    const handleExport = () => {
        if (!activeQuote || activeQuote.items.length === 0) {
            alert("è«‹å…ˆæ–°å¢å ±åƒ¹é …ç›®ã€‚");
            return;
        }

        const quoteData = COMPANY_DATA[activeQuote.company];

        // æ•´ç†è¡¨æ ¼æ•¸æ“š
        const tableData = [];
        let index = 1;
        
        activeQuote.items.forEach(item => {
            // ä¸»é …
            tableData.push([
                index++,
                item.name,
                item.specMain,
                item.unit,
                item.qty,
                item.price,
                calcAmount(item),
                item.remarks,
                item.specMaterial 
            ]);

            // å­é …
            (item.subItems || []).forEach(sub => {
                // åªå°å‡ºé‡‘é¡è¨ˆç®—çš„å­é …ç›®
                if (sub.type === 'item') {
                    tableData.push([
                        "", // ç•™ç©ºç´¢å¼•
                        `--- ${sub.name}`, 
                        sub.specMain,
                        sub.unit,
                        sub.qty,
                        sub.price,
                        calcAmount(sub),
                        sub.remarks,
                        sub.specMaterial
                    ]);
                }
            });
        });
        
        // è¨ˆç®—ç¸½é‡‘é¡
        const total = calcTotal(activeQuote.items);
        const negotiated = calcNegotiated(total, activeQuote.discountPercent, activeQuote.negotiatedPrice);
        
        // æ•´ç†å·¥ä½œè¡¨å…§å®¹
        const header = [
            [quoteData.name],
            ['å·¥ç¨‹å ±åƒ¹å–®'],
            [],
            ['å ±åƒ¹å–®è™Ÿ:', activeQuote.quoteNo, 'å ±åƒ¹æ—¥æœŸ:', activeQuote.date],
            ['å·¥ç¨‹åç¨±:', activeQuote.title],
            ['å®¢æˆ¶åç¨±:', activeQuote.customerName, 'è¯çµ¡äºº:', activeQuote.contact, 'é›»è©±:', activeQuote.phone],
            ['å·¥ç¨‹åœ°é»:', activeQuote.location],
            [],
            ['é …æ¬¡', 'å“å', 'è¦æ ¼/ä¸»æè¿°', 'å–®ä½', 'æ•¸é‡', 'å–®åƒ¹', 'é‡‘é¡(å°è¨ˆ)', 'å‚™è¨»', 'ç”¨æ–™æ˜ç´°'],
        ];

        const footer = [
            [],
            ['ç¸½è¨ˆé‡‘é¡ (æœªç¨…):', '', '', '', '', '', formatMoney(total)],
            ['æŠ˜æ‰£ (%):', activeQuote.discountPercent, 'æœ€çµ‚å ±åƒ¹ (è‡ªå®šç¾©):', activeQuote.negotiatedPrice],
            ['æœ€çµ‚å ±åƒ¹é‡‘é¡ (æœªç¨…):', '', '', '', '', '', formatMoney(negotiated)],
            [],
            ['å‚™è¨» (ä¸å«ç¨…):', ''],
            [activeQuote.notes],
            [],
            ['ä»˜æ¬¾æ¢ä»¶:', ''],
            [activeQuote.payment],
            
        ];
        
        // çµ„åˆæœ€çµ‚æ•¸æ“š
        const wsData = header.concat(tableData).concat(footer);
        
        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // ç°¡å–®æ¨£å¼ - å¯¬åº¦èª¿æ•´
        const wscols = [
            { wch: 6 }, // é …æ¬¡
            { wch: 30 }, // å“å
            { wch: 25 }, // è¦æ ¼/ä¸»æè¿°
            { wch: 6 }, // å–®ä½
            { wch: 8 }, // æ•¸é‡
            { wch: 15 }, // å–®åƒ¹
            { wch: 15 }, // é‡‘é¡(å°è¨ˆ)
            { wch: 25 }, // å‚™è¨»
            { wch: 30 }, // ç”¨æ–™æ˜ç´°
        ];
        ws['!cols'] = wscols;

        // ç¸½è¨ˆé‡‘é¡æ•¸å­—æ ¼å¼
        const totalRowIndex = header.length + tableData.length + 1;
        const totalCellRef = 'G' + totalRowIndex;
        ws[totalCellRef].z = '#,##0';
        
        const negotiatedRowIndex = totalRowIndex + 3;
        const negotiatedCellRef = 'G' + negotiatedRowIndex;
        ws[negotiatedCellRef].z = '#,##0';


        // å‰µå»ºå·¥ä½œç°¿
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, activeQuote.title.substring(0, 30));
        
        // åŒ¯å‡ºæª”æ¡ˆ
        const filename = `${activeQuote.quoteNo}_${activeQuote.customerName}_${activeQuote.title}.xlsx`.replace(/[\\/:*?"<>|]/g, '');
        XLSX.writeFile(wb, filename);
    };

    return (
        <button
            className="bg-gray-500 text-white px-4 py-2 rounded disabled:opacity-50 hover:bg-gray-600"
            onClick={handleExport}
            disabled={!activeQuote}
        >
            å°å‡º Excel (XLSX)
        </button>
    );
}

// --------------------------------------------------
// åˆ—å°æŒ‰éˆ•
// --------------------------------------------------
function PrintButton({ quote, totalAmount, negotiatedAmount }) {
    
    // ğŸ¯ V20 é—œéµä¿®æ­£ 2: é‡æ–°æª¢æŸ¥ ReactDOMServer çš„å¯ç”¨æ€§
    const handlePrint = () => {
        
        // æª¢æŸ¥ ReactDOMServer æ˜¯å¦å·²è¼‰å…¥
        if (typeof ReactDOMServer === 'undefined' || !ReactDOMServer.renderToStaticMarkup) {
            alert('åˆ—å°å¤±æ•—ï¼šReactDOMServer æ¨¡çµ„å°šæœªæº–å‚™å¥½ã€‚è«‹ç¨å€™å†è©¦æˆ–æª¢æŸ¥ç¶²é æ˜¯å¦è¼‰å…¥å®Œæ•´ã€‚');
            return;
        }
        
        const printArea = document.getElementById('quotePreviewArea');
        
        // ç¢ºä¿é è¦½å€å¡Šå­˜åœ¨
        if (!printArea) {
            alert('åˆ—å°å¤±æ•—ï¼šå ±åƒ¹å–®é è¦½å°šæœªè¼‰å…¥ã€‚è«‹ç¨å€™å¹¾ç§’å†è©¦ä¸€æ¬¡ã€‚');
            return;
        }

        // æ¸²æŸ“ PrintLayout
        const printComponent = React.createElement(PrintLayout, { 
            quote, 
            totalAmount, 
            negotiatedAmount,
            isPreview: false
        });
        
        // ä½¿ç”¨éœæ…‹æ¸²æŸ“ç”Ÿæˆ HTML å­—ä¸²
        const htmlContent = ReactDOMServer.renderToStaticMarkup(printComponent);

        // å°‡ HTML å…§å®¹æ³¨å…¥åˆ°é è¦½å€
        printArea.innerHTML = htmlContent;

        // è§¸ç™¼ç€è¦½å™¨åˆ—å°å°è©±æ¡†
        window.print();
        
        // æ¸…ç©ºé è¦½å€çš„å…§å®¹ï¼Œé¿å…æ±¡æŸ“ç•«é¢
        // å»¶é²æ¸…ç©ºä»¥ç¢ºä¿åˆ—å°å°è©±æ¡†æœ‰æ™‚é–“è®€å–å…§å®¹
        setTimeout(() => {
            printArea.innerHTML = '';
        }, 100); 
    };

    return (
        <button
            className="bg-red-600 text-white px-4 py-2 rounded disabled:opacity-50 hover:bg-red-700"
            onClick={handlePrint}
            disabled={!quote}
        >
            åˆ—å°å ±åƒ¹å–®
        </button>
    );
}


// --------------------------------------------------
// åˆ—å°æ’ç‰ˆçµ„ä»¶
// --------------------------------------------------
function PrintLayout({ quote, totalAmount, negotiatedAmount, isPreview }) {
    const companyInfo = COMPANY_DATA[quote.company];
    
    // å…§è¯æ¨£å¼ï¼šç¢ºä¿è¡¨æ ¼ç·šæ¢ (ç”¨æ–¼è¦†è“‹ç€è¦½å™¨é è¨­æ¨£å¼)
    const TH_TD_STYLE = { 
        border: '1px solid black', 
        padding: '5px', 
        verticalAlign: 'top',
        textAlign: 'left'
    };
    const TH_STYLE = { 
        ...TH_TD_STYLE, 
        backgroundColor: '#f0f0f0', 
        fontWeight: 'bold', 
        textAlign: 'center' 
    };
    const TD_ALIGN_RIGHT_STYLE = { 
        ...TH_TD_STYLE, 
        textAlign: 'right' 
    };

    // --------------------------------------------------
    // å°è¨ˆé‡‘é¡/æœ€çµ‚å ±åƒ¹ç¸½çµ
    // --------------------------------------------------
    const TotalSummary = () => {
        // åˆ¤æ–·æ˜¯å¦æœ‰æŠ˜æ‰£æˆ–è‡ªå®šç¾©åƒ¹æ ¼
        const hasDiscount = quote.discountPercent > 0 || quote.negotiatedPrice > 0;
        
        // ç¸½è¨ˆé‡‘é¡ (åŸå§‹ç¸½åƒ¹)
        const totalDisplay = `NT$ ${formatMoney(totalAmount)}`;
        
        // æœ€çµ‚å ±åƒ¹é‡‘é¡
        const negotiatedDisplay = `NT$ ${formatMoney(negotiatedAmount)}`;

        return (
            <div className="print-total-box flex justify-end">
                <table style={{ width: '400px', borderCollapse: 'collapse' }}>
                    <tbody>
                        {/* ç¸½è¨ˆé‡‘é¡ (ä¸€å®šé¡¯ç¤º) */}
                        <tr style={{ borderTop: '1px solid black' }}>
                            <td style={{ ...TH_TD_STYLE, width: '60%', textAlign: 'right', fontWeight: 'bold', border: 'none' }}>
                                ç¸½è¨ˆé‡‘é¡ (æœªç¨…):
                            </td>
                            <td style={{ ...TD_ALIGN_RIGHT_STYLE, fontWeight: 'bold', border: 'none', color: '#0000FF' }}>
                                {totalDisplay}
                            </td>
                        </tr>
                        
                        {/* æœ€çµ‚å ±åƒ¹é‡‘é¡ (ğŸ¯ V20 é—œéµä¿®æ­£ 2: æœ‰æŠ˜æ‰£æˆ–è­°åƒ¹æ™‚æ‰é¡¯ç¤º) */}
                        {hasDiscount && (
                            <tr>
                                <td style={{ ...TH_TD_STYLE, width: '60%', textAlign: 'right', fontWeight: 'bold', border: 'none' }}>
                                    æœ€çµ‚å ±åƒ¹é‡‘é¡ (æœªç¨…):
                                </td>
                                <td style={{ ...TD_ALIGN_RIGHT_STYLE, fontWeight: 'bold', border: 'none', color: '#FF0000', fontSize: '18px' }}>
                                    {negotiatedDisplay}
                                </td>
                            </tr>
                        )}

                    </tbody>
                </table>
            </div>
        );
    };

    // --------------------------------------------------
    // æ¸²æŸ“å–®å€‹å ±åƒ¹é …ç›®
    // --------------------------------------------------
    const renderPrintItem = (item, index) => {
        const rows = [];
        const isMainItem = !item.isSubItem; 
        
        // è™•ç†è¦æ ¼æè¿°
        const specDescription = item.specMain || "";
        const materialDescription = item.specMaterial ? 
            `${specDescription}${specDescription ? ' | ' : ''}ç”¨æ–™æ˜ç´°: ${item.specMaterial}` : specDescription;
        
        // 1. ä¸»é …ç›®è¡Œ/å­é …ç›®è¡Œ
        rows.push(
            <tr key={item.id} className={isMainItem ? 'main-item-row' : 'sub-item-row'}>
                {/* é …æ¬¡ */}
                <td style={{ ...TH_TD_STYLE, textAlign: 'center' }}>
                    {isMainItem ? index : ''}
                </td>
                
                {/* å“å */}
                <td style={TH_TD_STYLE}>
                    {item.name}
                </td>
                
                {/* è¦æ ¼/ç”¨æ–™æ˜ç´° */}
                <td style={TH_TD_STYLE}>
                    {materialDescription}
                </td>
                
                {/* å–®ä½ */}
                <td style={{ ...TH_TD_STYLE, textAlign: 'center' }}>
                    {item.unit}
                </td>
                
                {/* æ•¸é‡ */}
                <td style={{ ...TH_TD_STYLE, textAlign: 'center' }}>
                    {item.qty}
                </td>
                
                {/* å–®åƒ¹ */}
                <td style={TD_ALIGN_RIGHT_STYLE}>
                    {formatMoney(item.price)}
                </td>
                
                {/* é‡‘é¡ (å°è¨ˆ) */}
                <td style={{ ...TD_ALIGN_RIGHT_STYLE, fontWeight: 'bold' }}>
                    {formatMoney(calcAmount(item))}
                </td>
                
                {/* å‚™è¨» (åªé¡¯ç¤ºæœ‰å…§å®¹çš„) */}
                <td style={TH_TD_STYLE}>
                    {item.remarks}
                </td>
            </tr>
        );
        
        // 2. è™•ç†å­é …ç›®/è£œå……æ–‡å­—/åœ–ç‰‡
        if (item.subItems && item.subItems.length > 0) {
            item.subItems.forEach(sub => {
                if (sub.type === 'item') {
                    // é€’å½’æ¸²æŸ“å­é …ç›® (è¦–ç‚ºæ–°çš„å ±åƒ¹è¡Œï¼Œä½†ç´¢å¼•ç‚ºç©º)
                    rows.push(...renderPrintItem({ ...sub, isSubItem: true }, null));
                } else if (sub.type === 'text') {
                    // è£œå……æ–‡å­—
                    rows.push(
                        <tr key={sub.id + '-text'} className="sub-item-note">
                            <td colSpan="8" style={{ ...TH_TD_STYLE, padding: '2px 6px', borderLeft: 'none', borderRight: 'none', fontStyle: 'italic', color: '#333' }}>
                                <strong>{sub.name}:</strong> <pre style={{ display: 'inline', whiteSpace: 'pre-wrap' }}>{sub.remarks}</pre>
                            </td>
                        </tr>
                    );
                } else if (sub.type === 'image') {
                    // è£œå……åœ–ç‰‡
                    rows.push(
                        <tr key={sub.id + '-image'} className="sub-item-note">
                             <td colSpan="8" style={{ ...TH_TD_STYLE, padding: '2px 6px', borderLeft: 'none', borderRight: 'none', textAlign: 'center' }}>
                                <strong>{sub.name}:</strong>
                                <img 
                                    src={sub.name} 
                                    alt="è£œå……åœ–ç‰‡" 
                                    className="print-image" 
                                    style={{ maxWidth: '400px', height: 'auto', margin: '5px auto', display: 'block' }}
                                />
                            </td>
                        </tr>
                    );
                }
            });
        }
        
        return rows;
    };
    
    // --------------------------------------------------
    // ä¸»è¦æ¸²æŸ“
    // --------------------------------------------------
    return (
        <div className="print-page">
            
            {/* æ¨™é ­ï¼šå…¬å¸è³‡è¨Š */}
            <div className="print-header mb-4 text-sm">
                <h1 style={{ textAlign: 'center', fontSize: '20px', fontWeight: 'bold', margin: '0' }}>
                    {companyInfo.name}
                </h1>
                <div style={{ textAlign: 'center', fontSize: '12px' }}>
                    çµ±ä¸€ç·¨è™Ÿ: XXX | é›»è©±: {companyInfo.tel} | å‚³çœŸ: {companyInfo.fax} | Email: {companyInfo.email}
                </div>
                <div style={{ textAlign: 'center', fontSize: '12px', marginBottom: '10px' }}>
                    åœ°å€: {companyInfo.address}
                </div>
                <h2 style={{ textAlign: 'center', fontSize: '24px', fontWeight: 'bold', margin: '0' }}>
                    å·¥ç¨‹å ±åƒ¹å–®
                </h2>
            </div>

            {/* å®¢æˆ¶/å·¥ç¨‹è³‡è¨Šè¡¨æ ¼ */}
            <table className="print-info-table mb-4" style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
                <tbody>
                    <tr>
                        <td style={TH_STYLE} className="print-info-label">å®¢æˆ¶åç¨±:</td>
                        <td style={TH_TD_STYLE}>{quote.customerName}</td>
                        <td style={TH_STYLE} className="print-info-label">è¯çµ¡äºº:</td>
                        <td style={TH_TD_STYLE}>{quote.contact}</td>
                    </tr>
                    <tr>
                        <td style={TH_STYLE} className="print-info-label">å·¥ç¨‹åç¨±:</td>
                        <td style={TH_TD_STYLE}>{quote.title}</td>
                        <td style={TH_STYLE} className="print-info-label">å ±åƒ¹æ—¥æœŸ:</td>
                        <td style={TH_TD_STYLE}>{quote.date}</td>
                    </tr>
                    <tr>
                        <td style={TH_STYLE} className="print-info-label">å ±åƒ¹å–®è™Ÿ:</td>
                        <td style={TH_TD_STYLE}>{quote.quoteNo}</td>
                        <td style={TH_STYLE} className="print-info-label">é›»è©±:</td>
                        <td style={TH_TD_STYLE}>{quote.phone}</td>
                    </tr>
                    <tr>
                        <td style={TH_STYLE} className="print-info-label">å·¥ç¨‹åœ°é»:</td>
                        <td colSpan="3" style={TH_TD_STYLE}>{quote.location}</td>
                    </tr>
                </tbody>
            </table>

            {/* å ±åƒ¹é …ç›®è¡¨æ ¼ */}
            <table className="print-items-table" style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
                <thead>
                    <tr>
                        <th style={{ ...TH_STYLE, width: '5%' }}>é …æ¬¡</th>
                        <th style={{ ...TH_STYLE, width: '20%' }}>å“å</th>
                        <th style={{ ...TH_STYLE, width: '30%' }}>è¦æ ¼ / ç”¨æ–™æ˜ç´°</th>
                        <th style={{ ...TH_STYLE, width: '5%' }}>å–®ä½</th>
                        <th style={{ ...TH_STYLE, width: '5%' }}>æ•¸é‡</th>
                        <th style={{ ...TH_STYLE, width: '10%' }}>å–®åƒ¹</th>
                        <th style={{ ...TH_STYLE, width: '10%' }}>é‡‘é¡ (å°è¨ˆ)</th>
                        <th style={{ ...TH_STYLE, width: '15%' }}>å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody>
                    {quote.items.map((item, index) => renderPrintItem(item, index + 1))}
                    
                    {/* ç¸½è¨ˆè¡Œ */}
                    <tr className="total-row">
                        <td colSpan="6" style={{ ...TH_TD_STYLE, textAlign: 'right', fontWeight: 'bold' }}>
                            ç¸½è¨ˆé‡‘é¡ (æœªç¨…):
                        </td>
                        <td style={{ ...TD_ALIGN_RIGHT_STYLE, fontWeight: 'bold', fontSize: '14px', color: 'blue' }}>
                            {formatMoney(totalAmount)}
                        </td>
                        <td style={TH_TD_STYLE}></td> {/* å‚™è¨»åˆ—ç•™ç©º */}
                    </tr>
                    
                </tbody>
            </table>
            
            {/* ç¸½è¨ˆæ‘˜è¦ (åªåœ¨éé è¦½æ¨¡å¼ä¸‹ä½¿ç”¨ TotalSummary, é è¦½æ™‚ä½¿ç”¨è¡¨æ ¼å…§ç¸½è¨ˆ) */}
            {!isPreview && <TotalSummary />}


            {/* å‚™è¨» / ä»˜æ¬¾æ¢ä»¶ / ç°½ç« å€ */}
            <div className='mt-8 flex'>
                
                {/* å‚™è¨»èˆ‡ä»˜æ¬¾æ¢ä»¶ */}
                <div style={{ flex: '2' }}>
                    <div className="print-notes-box" style={{ width: '100%', border: '1px solid black', padding: '10px' }}>
                        <div style={{ float: 'left', width: '48%', marginRight: '4%' }}>
                            <h3 style={{ fontSize: '14px', fontWeight: 'bold' }}>å‚™è¨» (ä¸å«ç¨…):</h3>
                            <pre style={{ whiteSpace: 'pre-wrap', margin: '0', fontSize: '12px' }}>{quote.notes}</pre>
                        </div>
                        <div style={{ float: 'left', width: '48%' }}>
                            <h3 style={{ fontSize: '14px', fontWeight: 'bold' }}>ä»˜æ¬¾æ¢ä»¶:</h3>
                            <pre style={{ whiteSpace: 'pre-wrap', margin: '0', fontSize: '12px' }}>{quote.payment}</pre>
                        </div>
                        <div style={{ clear: 'both' }}></div>
                    </div>
                </div>

                {/* ç°½ç« å€ (å³å´ 1/3) */}
                <div style={{ flex: '1', marginLeft: '20px' }}>
                    
                    {/* ç¸½çµé‡‘é¡ (åªåœ¨åˆ—å°æ™‚é¡¯ç¤ºåœ¨å³å´ï¼Œè¦†è“‹è¡¨æ ¼ç¸½è¨ˆ) */}
                    <div style={{ border: '1px solid black', padding: '10px', marginTop: '10px', marginBottom: '10px', textAlign: 'center' }}>
                         <TotalSummary />
                    </div>

                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px', marginTop: '10px' }}>
                        <tbody>
                            <tr>
                                <td style={{ ...TH_TD_STYLE, width: '50%', fontWeight: 'bold' }}>å ±åƒ¹å…¬å¸ç°½ç« :</td>
                                <td style={{ ...TH_TD_STYLE, width: '50%', fontWeight: 'bold' }}>å®¢æˆ¶ç¢ºèªç°½ç« :</td>
                            </tr>
                            <tr style={{ height: '70px' }}>
                                <td style={TH_TD_STYLE}>
                                    {/* å‡è¨­å…¬å¸å°ç« åœ–ç‰‡URL */}
                                    <img 
                                        src={companyInfo.stamp} 
                                        alt="å…¬å¸å°ç« " 
                                        style={{ maxWidth: '80px', height: 'auto', display: 'block', margin: '10px auto' }} 
                                    />
                                    ä»£è¡¨äºº: __________________
                                </td>
                                <td style={TH_TD_STYLE}>
                                    ä»£è¡¨äºº: __________________
                                </td>
                            </tr>
                            <tr>
                                <td style={TH_TD_STYLE}>
                                    æ—¥æœŸ: __________________
                                </td>
                                <td style={TH_TD_STYLE}>
                                    æ—¥æœŸ: __________________
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div style={{ textAlign: 'center', marginTop: '20px', fontSize: '10px', color: '#666' }}>
                {companyInfo.address}
            </div>

        </div>
    );
}



// P5 â€” æ‡‰ç”¨ç¨‹å¼æ ¹éƒ¨
function App() {
    return (
        <div className="min-h-screen bg-gray-50 flex">
            <div className="w-64 bg-white p-4 shadow-lg flex-shrink-0 sticky top-0 h-screen overflow-y-auto">
                <h1 className="text-xl font-extrabold mb-6 text-center text-blue-700">å·¥ç¨‹å ±åƒ¹ç³»çµ±</h1>
                <CompanySelector />
                <ModeSelector />
                <QuoteList />
            </div>
            
            <div className="flex-grow p-8">
                <QuoteEditor />
            </div>
        </div>
    );
}

// P6 â€” å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
ReactDOM.render(
    <AppProvider>
        <App />
    </AppProvider>,
    document.getElementById("root")
);
</script>

</body>
</html>
