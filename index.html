<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel Standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SheetJSï¼ˆExcel åŒ¯å‡ºç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      background: #f3f4f6;
      font-family: "Microsoft JhengHei", sans-serif;
    }

    /* æœ€åŸºæœ¬åˆ—å°æ¨¡å¼ï¼ˆè©³ç´°ç‰ˆåœ¨ Part 5 æ‰åŠ å…¥ï¼‰ */
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; }
    }
  </style>
</head>

<body class="text-gray-900">

  <!-- React ä¸»ç•«é¢ -->
  <div id="root"></div>

  <!-- åˆ—å°å°ˆç”¨å€ï¼ˆå…§å®¹ç”± openPrint() å‹•æ…‹æ³¨å…¥ï¼‰ -->
  <div id="printArea" class="print-container"></div>

  <!-- Main Application Script -->
  <script type="text/babel">

    /****************************************************
     * P0 â€” ç©ºç™½åˆå§‹åŒ–ï¼ˆç­‰å¾… Part 1ï½Part 5 ç¨‹å¼ç¢¼åŠ å…¥ï¼‰
     ****************************************************/

    function App() {
      return (
        <div className="p-6 text-center text-xl">
          <div className="text-gray-600">
            ğŸš§ å·¥ç¨‹å ±åƒ¹ç³»çµ±åˆå§‹åŒ–æˆåŠŸ  
          </div>
          <div className="mt-2 text-sm text-gray-400">
            ï¼ˆè«‹é–‹å§‹è²¼ä¸Š Part 1ã€Part 2ã€Part 3â€¦ï¼‰
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);

  </script>

</body>
</html>

/****************************************************
 * Part 1 â€” è³‡æ–™çµæ§‹ï¼ˆå…¬å¸è³‡æ–™ + æ¨¡å¼æ¨¡æ¿ï¼‰
 ****************************************************/

// å…©å®¶å…¬å¸è³‡æ–™ï¼ˆå¯æ“´å……ï¼‰
const COMPANY_DATA = {
  herhsin: {
    name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
    tel: "07-6517476",
    fax: "07-6517994",
    email: "admin@herhsin.com",
    address: "831é«˜é›„å¸‚å¤§å¯®å€é³³æ—ä¸‰è·¯383-3è™Ÿ",
    stamp: "stamp_herhsin.jpg"
  },
  sinchang: {
    name: "è–ªæ˜Œæœ‰é™å…¬å¸",
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831é«˜é›„å¸‚å¤§å¯®å€é³³æ—ä¸‰è·¯383-3è™Ÿ",
    stamp: "stamp_sinchang.jpg"
  }
};



// ğŸ“Œ å ±åƒ¹å–®é è¨­å‚™è¨»ï¼ˆä½ åœ–ç‰‡ä¸­çš„ 6 å¤§é …ï¼‰
const DEFAULT_NOTES = `
1. æœ¬ä¼°åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚ï¼Œè«‹å…ˆè¡Œç¢ºèªç¾å ´ä½œæ¥­ç’°å¢ƒï¼Œä»¥å…å½±éŸ¿é€²åº¦ã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. æ–½å·¥æœŸé–“å¦‚é‡ä¸å¯æŠ—åŠ›ä¹‹å¤©ç½å› ç´ ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œè‹¥ç”±å®¢æˆ¶è‡ªè¡Œæä¾›ï¼Œä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚
`;


// ğŸ“Œ é è¨­ä»˜æ¬¾æ¢ä»¶ï¼ˆä½ åœ–ç‰‡ä¸­çš„ 40 / 30 / 20 / 10ï¼‰
const DEFAULT_PAYMENT = `
è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%
`;


// ğŸ“Œ å ±åƒ¹æ¨¡å¼æ¨¡æ¿è³‡æ–™ï¼ˆå¯æ–°å¢ / å¯ç·¨è¼¯ï¼‰
const QUOTE_MODES = [
  {
    id: "modeA",
    name: "æ‹Œåˆæ©Ÿæ¼æ¼¿æ›´æ›",
    description: "é©ç”¨æ‹Œåˆæ©Ÿç¶­ä¿®ã€æ¼æ¼¿è™•ç†ã€æ–™ä»¶æ±°æ›å·¥ç¨‹ã€‚",
    defaultItems: [],  // ç­‰ä½ ç¢ºèªå¾Œå¯è£œå…¥é è¨­é …ç›®
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT,
  },

  {
    id: "modeB",
    name: "è¨­å‚™éŠ·å”®",
    description: "é©ç”¨è¨­å‚™éŠ·å”®ã€å‚™å“ä¾›æ‡‰ã€å–®æ©Ÿè¨­å‚™å®‰è£ã€‚",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT,
  },

  {
    id: "modeC",
    name: "è¨­å‚™æ›´æ›å·¥ç¨‹",
    description: "é©ç”¨æ•´æ©Ÿæ›´æ›ã€æ–™ä»¶æ›´æ–°ã€å«åŠè£æ–½å·¥å·¥ç¨‹ã€‚",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT,
  }
];


// ğŸ“Œ é è¨­å‚™è¨»ï¼ˆå¯ä»¥åœ¨ UI è‡ªè¡Œä¿®æ”¹ï¼‰
const getDefaultNotes = () => DEFAULT_NOTES;

// ğŸ“Œ é è¨­ä»˜æ¬¾æ¢ä»¶ï¼ˆå¯èª¿æ•´ï¼‰
const getDefaultPayment = () => DEFAULT_PAYMENT;
/****************************************************
 * Part 2 â€” å·¥å…·å‡½å¼ï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰
 ****************************************************/

// å»ºç«‹ UUIDï¼ˆå ±åƒ¹å–® IDï¼‰
function uuid() {
  return "xxxx-4xxx-yxxx".replace(/[xy]/g, function (c) {
    const r = (Math.random() * 16) | 0;
    const v = c === "x" ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

// å–å¾—ä»Šæ—¥ yyyy/mm/dd
function formatDate() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}/${m}/${day}`;
}

// åƒåˆ†ä½
function formatMoney(num) {
  if (!num && num !== 0) return "";
  return num.toLocaleString("zh-TW");
}

// è¨ˆç®—å–®ç­†é‡‘é¡ï¼ˆquantity * priceï¼‰
function calcAmount(item) {
  const qty = Number(item.qty || 0);
  const price = Number(item.price || 0);
  return qty * price;
}

// è¨ˆç®—å“é …ç¸½é¡
function calcTotal(items) {
  return items.reduce((sum, it) => {
    let a = calcAmount(it);
    let subA = 0;
    if (it.subItems && it.subItems.length > 0) {
      subA = it.subItems.reduce((s, sub) => s + calcAmount(sub), 0);
    }
    return sum + a + subA;
  }, 0);
}

// è¨ˆç®—è­°åƒ¹å¾Œé‡‘é¡
function calcNegotiated(total, discountPercent, customPrice) {
  if (customPrice > 0) return customPrice;
  if (discountPercent > 0) {
    return Math.round(total * (1 - discountPercent / 100));
  }
  return total;
}

// è¼‰å…¥ Google Sheet CSV
async function loadCSV(url) {
  const res = await fetch(url);
  const text = await res.text();
  const rows = text.split("\n").map(r => r.trim());
  const header = rows[0].split(",");

  return rows.slice(1).map(row => {
    const items = row.split(",");
    const obj = {};
    header.forEach((h, i) => {
      obj[h] = items[i] || "";
    });
    return obj;
  });
}

/****************************************************
 * é è¨­å‚™è¨»
 ****************************************************/
function getDefaultNotes() {
  return (
`1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚  
2. å®‰è£æ–½ä½œæ™‚ï¼Œéœ€å”åŠ©æ¥­è€…ç¢ºå¯¦é…åˆæ–½å·¥éœ€æ±‚ã€‚  
3. å ±åƒ¹æœŸé–“ï¼šä½¿ç”¨åŸææ–™ï¼Œè®Šå‹•å¦è­°ã€‚  
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚`
  );
}

/****************************************************
 * é è¨­ä»˜æ¬¾æ¢ä»¶
 ****************************************************/
function getDefaultPayment() {
  return (
`è¨‚é‡‘ï¼š40%ï¼ˆç™¼åŒ…å¾Œ 10 å¤©å…§ï¼‰  
è£½ä½œå®Œæˆï¼š30%ï¼ˆä¾å®Œå·¥æ—¥ 30 å¤©å…§ï¼‰  
å®‰è£å®Œæˆï¼š20%ï¼ˆä¾å®Œå·¥æ—¥ 30 å¤©å…§ï¼‰  
é©—æ”¶å®Œæˆï¼š10%ï¼ˆä¾å®Œå·¥æ—¥ 30 å¤©å…§ï¼‰`
  );
}

/****************************************************
 * å ±åƒ¹å–®ç·¨è™Ÿï¼ˆ20250103-382ï¼‰
 ****************************************************/
function generateQuoteNo() {
  const y = new Date().getFullYear();
  const m = String(new Date().getMonth() + 1).padStart(2, "0");
  const d = String(new Date().getDate()).padStart(2, "0");
  const r = Math.floor(Math.random() * 900 + 100);
  return `${y}${m}${d}-${r}`;
}

/****************************************************
 * Part 3 â€” AppContextï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰
 * - ç®¡ç†å…¬å¸åˆ‡æ›
 * - ç®¡ç†å ±åƒ¹å–®åˆ—è¡¨
 * - å¥—ç”¨æ¨¡å¼
 * - Google Sheet è¦æ ¼å“è¼‰å…¥
 ****************************************************/

const AppContext = React.createContext();

function AppProvider({ children }) {
  /***********************
   * ç›®å‰å…¬å¸ï¼ˆherhsin / sinchangï¼‰
   ***********************/
  const [company, setCompany] = React.useState("herhsin");

  /***********************
   * å ±åƒ¹å–®åˆ—è¡¨
   ***********************/
  const [quotes, setQuotes] = React.useState([]);

  /***********************
   * ç•¶å‰å ±åƒ¹å–® ID
   ***********************/
  const [activeQuoteId, setActiveQuoteId] = React.useState(null);

  /***********************
   * Google Sheet è¦æ ¼å“è³‡æ–™
   ***********************/
  const [specItems, setSpecItems] = React.useState([]);

  /***********************
   * Google Sheet URL
   ***********************/
  const SPEC_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv";


  /****************************************************
   * åˆå§‹åŒ–ï¼šè¼‰å…¥ localStorage å ±åƒ¹å–®
   ****************************************************/
  React.useEffect(() => {
    const saved = localStorage.getItem("HERHSIN_QUOTES");
    if (saved) {
      const parsed = JSON.parse(saved);
      setQuotes(parsed);
      if (parsed.length > 0) setActiveQuoteId(parsed[0].id);
    }
  }, []);

  /****************************************************
   * è‡ªå‹•å„²å­˜
   ****************************************************/
  React.useEffect(() => {
    localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
  }, [quotes]);

  /****************************************************
   * è¼‰å…¥ Google Sheet CSV
   ****************************************************/
  React.useEffect(() => {
    loadCSV(SPEC_CSV_URL).then(data => setSpecItems(data));
  }, []);


  /****************************************************
   * å»ºç«‹å ±åƒ¹å–®ï¼ˆå«ç·¨è™Ÿï¼‰
   ****************************************************/
  function createQuote(modeId = null) {
    const id = uuid();
    const today = formatDate();
    const mode = QUOTE_MODES.find(m => m.id === modeId);

    const newQuote = {
      id,
      quoteNo: generateQuoteNo(),
      title: mode ? mode.name : "æœªå‘½åå·¥ç¨‹",
      customerName: "",
      contact: "",
      phone: "",
      location: "",
      date: today,
      items: mode ? [...mode.defaultItems] : [],
      notes: mode ? mode.defaultNotes : getDefaultNotes(),
      payment: mode ? mode.defaultPayment : getDefaultPayment(),
      discountPercent: 0,
      negotiatedPrice: 0
    };

    setQuotes(prev => [...prev, newQuote]);
    setActiveQuoteId(id);
  }


  /****************************************************
   * åˆªé™¤å ±åƒ¹å–®
   ****************************************************/
  function deleteQuote(id) {
    const newList = quotes.filter(q => q.id !== id);
    setQuotes(newList);
    setActiveQuoteId(newList.length > 0 ? newList[0].id : null);
  }


  /****************************************************
   * æ›´æ–°å ±åƒ¹å–®
   ****************************************************/
  function updateQuote(id, data) {
    setQuotes(prev => prev.map(q => (q.id === id ? { ...q, ...data } : q)));
  }


  /****************************************************
   * å¥—ç”¨æ¨¡å¼
   ****************************************************/
  function applyMode(modeId) {
    const mode = QUOTE_MODES.find(m => m.id === modeId);
    if (!mode || !activeQuoteId) return;

    updateQuote(activeQuoteId, {
      title: mode.name,
      items: [...mode.defaultItems],
      notes: mode.defaultNotes,
      payment: mode.defaultPayment
    });
  }


  /****************************************************
   * Context æä¾›çš„æ‰€æœ‰å…§å®¹
   ****************************************************/
  const value = {
    company,
    setCompany,

    quotes,
    createQuote,
    deleteQuote,
    updateQuote,

    activeQuoteId,
    setActiveQuoteId,

    specItems,
    applyMode
  };

  return (
    <AppContext.Provider value={value}>
      {children}
    </AppContext.Provider>
  );
}


/****************************************************
 * Part 4-1 â€” åŸºç¤ UI å…ƒä»¶
 * - å…¬å¸åˆ‡æ›
 * - å ±åƒ¹å–®ç®¡ç†ï¼ˆæ–°å¢ / åˆ‡æ› / åˆªé™¤ï¼‰
 * - æ¨¡å¼å¥—ç”¨
 ****************************************************/

// ---------------------------
// 1. åˆ‡æ›å…¬å¸ CompanySelector
// ---------------------------
function CompanySelector() {
  const { company, setCompany } = React.useContext(AppContext);

  return (
    <div className="p-3 bg-white shadow mb-4 rounded no-print">
      <div className="flex items-center gap-4">
        <span className="font-bold text-lg">é¸æ“‡å…¬å¸ï¼š</span>

        <select
          className="border rounded p-2"
          value={company}
          onChange={(e) => setCompany(e.target.value)}
        >
          <option value="herhsin">ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸</option>
          <option value="sinchang">è–ªæ˜Œæœ‰é™å…¬å¸</option>
        </select>
      </div>
    </div>
  );
}


// ---------------------------
// 2. å ±åƒ¹å–®ç®¡ç† QuoteManager
// ---------------------------
function QuoteManager() {
  const {
    quotes, createQuote, deleteQuote,
    activeQuoteId, setActiveQuoteId
  } = React.useContext(AppContext);

  return (
    <div className="p-3 mb-4 bg-white shadow rounded no-print">
      <div className="flex justify-between items-center mb-3">
        <h2 className="font-bold text-xl">å ±åƒ¹å–®ç®¡ç†</h2>
        <button
          className="px-3 py-2 bg-blue-600 text-white rounded"
          onClick={() => createQuote(null)}
        >
          ï¼‹æ–°å¢ç©ºç™½å ±åƒ¹å–®
        </button>
      </div>

      {/* å ±åƒ¹å–®åˆ—è¡¨ */}
      <div className="space-y-2">
        {quotes.map(q => (
          <div
            key={q.id}
            className={`flex items-center justify-between p-2 border rounded cursor-pointer
              ${activeQuoteId === q.id ? 'bg-blue-100' : 'bg-gray-50'}`}
            onClick={() => setActiveQuoteId(q.id)}
          >
            <span>{q.title}</span>

            <button
              className="text-red-500 text-sm"
              onClick={(e) => {
                e.stopPropagation();
                if (confirm("ç¢ºå®šåˆªé™¤æ­¤å ±åƒ¹å–®ï¼Ÿ")) deleteQuote(q.id);
              }}
            >
              åˆªé™¤
            </button>
          </div>
        ))}

        {quotes.length === 0 && (
          <div className="text-gray-500">å°šç„¡å ±åƒ¹å–®ï¼Œè«‹æ–°å¢ã€‚</div>
        )}
      </div>
    </div>
  );
}


// ---------------------------
// 3. æ¨¡å¼é¸æ“‡ ModeSelector
// ---------------------------
function ModeSelector() {
  const { applyMode, createQuote } = React.useContext(AppContext);

  return (
    <div className="p-3 bg-white shadow rounded mb-4 no-print">
      <h2 className="font-bold text-xl mb-2">å¿«é€Ÿå¥—ç”¨å ±åƒ¹æ¨¡å¼</h2>

      <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
        {QUOTE_MODES.map(mode => (
          <div
            key={mode.id}
            className="border rounded p-3 cursor-pointer hover:bg-blue-100"
            onClick={() => createQuote(mode.id)}
          >
            <div className="font-bold">{mode.name}</div>
            <div className="text-sm text-gray-600">{mode.description}</div>
          </div>
        ))}
      </div>
    </div>
  );
}
/****************************************************
 * Part 4-2 â€” å ±åƒ¹å–®ä¸»å…§å®¹ç·¨è¼¯
 ****************************************************/

// --------------------------------------------------
// 4-2-1. å ±åƒ¹å–®æŠ¬é ­ â€” å…¬å¸è³‡è¨Š
// --------------------------------------------------
function QuoteCompanyHeader() {
  const { company } = React.useContext(AppContext);
  const info = COMPANY_DATA[company];

  return (
    <div className="text-center mb-6">
      <h1 className="text-2xl font-bold">{info.name}</h1>
      <div>{info.tel}</div>
      <div>{info.fax}</div>
      <div>{info.email}</div>
      <div>{info.address}</div>

      <h2 className="text-3xl font-bold mt-4 tracking-widest">
        {info.title}
      </h2>
    </div>
  );
}


// --------------------------------------------------
// 4-2-2. å ±åƒ¹å–®æŠ¬é ­ â€” å®¢æˆ¶è³‡è¨Šè¡¨å–®
// --------------------------------------------------
function QuoteHeaderForm({ quote, update }) {

  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 p-4 bg-white rounded shadow mb-4">

      {/* é¡§å®¢åç¨± */}
      <div>
        <label className="font-bold">é¡§å®¢åç¨±ï¼š</label>
        <input
          className="border p-2 w-full rounded"
          value={quote.customerName}
          onChange={(e) => update({ customerName: e.target.value })}
        />
      </div>

      {/* è¯çµ¡äºº */}
      <div>
        <label className="font-bold">è¯çµ¡äººï¼š</label>
        <input
          className="border p-2 w-full rounded"
          value={quote.contact}
          onChange={(e) => update({ contact: e.target.value })}
        />
      </div>

      {/* é›»è©± */}
      <div>
        <label className="font-bold">é›»è©±ï¼š</label>
        <input
          className="border p-2 w-full rounded"
          value={quote.phone}
          onChange={(e) => update({ phone: e.target.value })}
        />
      </div>

      {/* å ±åƒ¹æ—¥æœŸ */}
      <div>
        <label className="font-bold">å ±åƒ¹æ—¥æœŸï¼š</label>
        <input
          type="date"
          className="border p-2 w-full rounded"
          value={quote.date}
          onChange={(e) => update({ date: e.target.value })}
        />
      </div>

      {/* å·¥ç¨‹åç¨± */}
      <div>
        <label className="font-bold">å·¥ç¨‹åç¨±ï¼š</label>
        <input
          className="border p-2 w-full rounded"
          value={quote.title}
          onChange={(e) => update({ title: e.target.value })}
        />
      </div>

      {/* å·¥ç¨‹åœ°é» */}
      <div>
        <label className="font-bold">å·¥ç¨‹åœ°é»ï¼š</label>
        <input
          className="border p-2 w-full rounded"
          value={quote.location}
          onChange={(e) => update({ location: e.target.value })}
        />
      </div>
    </div>
  );
}


// --------------------------------------------------
// 4-2-3. ä¸»ç·¨è¼¯å™¨ï¼ˆQuoteEditorï¼‰
// --------------------------------------------------
function QuoteEditor() {
  const {
    activeQuoteId,
    quotes,
    updateQuote
  } = React.useContext(AppContext);

  if (!activeQuoteId) {
    return <div className="text-gray-500">è«‹å…ˆé¸æ“‡æˆ–æ–°å¢å ±åƒ¹å–®</div>;
  }

  const quote = quotes.find(q => q.id === activeQuoteId);
  if (!quote) return <div>è³‡æ–™éŒ¯èª¤ã€‚</div>;

  const update = (data) => updateQuote(activeQuoteId, data);

  return (
    <div className="p-4">

      {/* å…¬å¸æŠ¬é ­ */}
      <QuoteCompanyHeader />

      {/* å®¢æˆ¶è³‡æ–™è¡¨å–® */}
      <QuoteHeaderForm quote={quote} update={update} />

      {/* ----------------------------- */}
      {/* å¾ŒçºŒæœƒåŠ å…¥å“é …ã€å‚™è¨»ã€ä»˜æ¬¾ã€ç¸½åƒ¹ç­‰ */}
      {/* ----------------------------- */}
      <div className="text-gray-400 text-center mt-8">
        ï¼ˆä»¥ä¸‹å°‡åœ¨ Part 4-3 åŠ ä¸Šå“é …ç·¨è¼¯å™¨ï¼‰
      </div>
    </div>
  );
}
/****************************************************
 * Part 4-3-1 â€” å“é …æ“ä½œå·¥å…·ï¼ˆå¢åˆªæ”¹æŸ¥ï¼‰
 ****************************************************/

// å»ºç«‹ä¸€å€‹æ–°å¤§é …ï¼ˆä¾‹å¦‚ï¼šä¸€ã€æ‹Œåˆæ©Ÿæ›´æ›å·¥ç¨‹ï¼‰
function createMainItem() {
  return {
    id: uuid(),
    type: "main",   // å¤§é …
    name: "æœªå‘½åå¤§é …",
    spec: "",
    unit: "",
    qty: "",
    price: "",
    subItems: []    // è£œå……å…§å®¹
  };
}

// å»ºç«‹ä¸€å€‹æ–°å°é …ï¼ˆè¦æ ¼ç´°é …ï¼‰
function createSubItem() {
  return {
    id: uuid(),
    type: "sub",     // å°é …
    name: "æœªå‘½åå°é …",
    spec: "",
    unit: "",
    qty: "",
    price: "",
    note: "",        // å–®è¡Œè£œå……æ–‡å­—
    images: []       // è£œå……ç…§ç‰‡
  };
}

// å»ºç«‹è£œå……æ–‡å­—è¡Œ
function createNoteLine() {
  return {
    id: uuid(),
    type: "note",
    text: "è£œå……èªªæ˜..."
  };
}

// å»ºç«‹è£œå……åœ–ç‰‡è¡Œ
function createImageLine(base64) {
  return {
    id: uuid(),
    type: "image",
    src: base64
  };
}


// --------------------------------------------------
// åœ¨å ±åƒ¹å–® items ä¸­æ–°å¢å¤§é …
// --------------------------------------------------
function addMainItem(quote, updateQuote) {
  const newItem = createMainItem();
  updateQuote(quote.id, { items: [...quote.items, newItem] });
}


// --------------------------------------------------
// åœ¨å¤§é …åº•ä¸‹æ–°å¢å°é …ï¼ˆå¦‚ï¼š"1. æ›´æ›è‘‰ç‰‡"ï¼‰
// --------------------------------------------------
function addSubItem(parentItemId, quote, updateQuote) {
  const newItems = quote.items.map(item => {
    if (item.id === parentItemId) {
      return {
        ...item,
        subItems: [...item.subItems, createSubItem()]
      };
    }
    return item;
  });

  updateQuote(quote.id, { items: newItems });
}


// --------------------------------------------------
// åœ¨å°é …åº•ä¸‹åŠ å…¥è£œå……æ–‡å­—
// --------------------------------------------------
function addNoteLine(parentItemId, quote, updateQuote) {
  const newItems = quote.items.map(item => {
    if (item.id !== parentItemId) return item;

    return {
      ...item,
      subItems: [...item.subItems, createNoteLine()]
    };
  });

  updateQuote(quote.id, { items: newItems });
}


// --------------------------------------------------
// åœ¨å°é …åº•ä¸‹åŠ å…¥è£œå……åœ–ç‰‡
// --------------------------------------------------
function addImageLine(parentItemId, base64, quote, updateQuote) {
  const newItems = quote.items.map(item => {
    if (item.id !== parentItemId) return item;

    return {
      ...item,
      subItems: [...item.subItems, createImageLine(base64)]
    };
  });

  updateQuote(quote.id, { items: newItems });
}


// --------------------------------------------------
// åˆªé™¤å¤§é …ã€å°é …æˆ–è£œå……å…§å®¹
// --------------------------------------------------
function deleteItem(targetId, quote, updateQuote) {
  let newItems = [];

  // éæ­·å¤§é …
  quote.items.forEach(main => {
    if (main.id === targetId) return; // åˆªé™¤å¤§é …

    const filteredSub = main.subItems.filter(sub => sub.id !== targetId);

    newItems.push({ ...main, subItems: filteredSub });
  });

  updateQuote(quote.id, { items: newItems });
}


// --------------------------------------------------
// æ›´æ–°å“é …å…§å®¹
// --------------------------------------------------
function updateItem(targetId, data, quote, updateQuote) {
  const newItems = quote.items.map(main => {
    if (main.id === targetId) {
      return { ...main, ...data };
    }

    const newSubs = main.subItems.map(sub => {
      if (sub.id === targetId) {
        return { ...sub, ...data };
      }
      return sub;
    });

    return { ...main, subItems: newSubs };
  });

  updateQuote(quote.id, { items: newItems });
}
/****************************************************
 * Part 4-3-2 â€” è¦æ ¼å“é¸æ“‡å™¨ï¼ˆGoogle Sheet â†’ å ±åƒ¹é …ç›®ï¼‰
 ****************************************************/

function SpecItemSelector({ quote, update }) {
  const { specItems } = React.useContext(AppContext);
  const [keyword, setKeyword] = React.useState("");

  if (!specItems || specItems.length === 0) {
    return (
      <div className="p-3 bg-white shadow rounded mb-4">
        æ­£åœ¨è¼‰å…¥è¦æ ¼å“è³‡æ–™...
      </div>
    );
  }

  // æœå°‹éæ¿¾
  const filtered = specItems.filter(item => {
    const text = (item["å“å"] + item["å“é …èªªæ˜"] + item["è¦æ ¼1"] + item["è¦æ ¼2"]).toLowerCase();
    return text.includes(keyword.toLowerCase());
  });

  // åŠ å…¥å“é …åˆ°å ±åƒ¹å–®
  function addSpec(item) {
    // è‡ªå‹•å±•é–‹è£œå……å…§å®¹
    const subs = [];

    if (item["å“é …èªªæ˜"]) {
      subs.push({ id: uuid(), type: "note", text: item["å“é …èªªæ˜"] });
    }
    if (item["è¦æ ¼1"]) {
      subs.push({ id: uuid(), type: "note", text: item["è¦æ ¼1"] });
    }
    if (item["è¦æ ¼2"]) {
      subs.push({ id: uuid(), type: "note", text: item["è¦æ ¼2"] });
    }
    if (item["å‚™è¨»"]) {
      subs.push({ id: uuid(), type: "note", text: item["å‚™è¨»"] });
    }

    const newMain = {
      id: uuid(),
      type: "main",
      name: item["å“å"] || "æœªå‘½åå“é …",
      spec: "",
      unit: item["å–®ä½"] || "",
      qty: 1,
      price: item["å–®åƒ¹"] || "",
      subItems: subs
    };

    update({
      items: [...quote.items, newMain]
    });
  }

  return (
    <div className="p-4 bg-white rounded shadow mb-6 no-print">
      <h2 className="font-bold text-xl mb-3">è¦æ ¼å“åŠ å…¥</h2>

      {/* æœå°‹æ¡† */}
      <input
        className="w-full border p-2 rounded mb-3"
        placeholder="æœå°‹å“å / è¦æ ¼ / èªªæ˜..."
        value={keyword}
        onChange={(e) => setKeyword(e.target.value)}
      />

      {/* è¦æ ¼å“åˆ—è¡¨ */}
      <div className="max-h-72 overflow-y-auto border rounded p-2 bg-gray-50">
        {filtered.map((item, index) => (
          <div
            key={index}
            className="p-2 mb-2 bg-white border rounded hover:bg-blue-100 cursor-pointer"
            onClick={() => addSpec(item)}
          >
            <div className="font-bold">{item["å“å"]}</div>
            <div className="text-sm text-gray-600">
              å–®ä½ï¼š{item["å–®ä½"]}ã€€å–®åƒ¹ï¼š{item["å–®åƒ¹"]}
            </div>

            {item["å“é …èªªæ˜"] && (
              <div className="text-xs text-gray-700">{item["å“é …èªªæ˜"]}</div>
            )}
          </div>
        ))}

        {filtered.length === 0 && (
          <div className="text-gray-500 text-center p-4">
            æ‰¾ä¸åˆ°ç›¸é—œå“é …
          </div>
        )}
      </div>
    </div>
  );
}
/****************************************************
 * Part 4-3-3-A â€” å ±åƒ¹å“é …åˆ—è¡¨ + å¤§é … / å°é …ç·¨è¼¯
 ****************************************************/

// ------------------------------
// 1. å¤§é …è³‡æ–™åˆ—ï¼ˆMain Item Rowï¼‰
// ------------------------------
function ItemRow({ item, quote, update }) {
  return (
    <div className="border-b py-2 pl-2 bg-gray-100">

      {/* å¤§é …æ¨™é¡Œ */}
      <div className="font-bold text-lg mb-2 flex justify-between items-center">
        <span>{item.name}</span>

        <button
          className="text-red-600 text-sm"
          onClick={() => deleteItem(item.id, quote, update)}
        >
          åˆªé™¤å¤§é …
        </button>
      </div>

      {/* å¯ç·¨è¼¯å€ */}
      <div className="grid grid-cols-5 gap-2 mb-2">
        <input
          className="border p-2 rounded"
          placeholder="å“å"
          value={item.name}
          onChange={(e) => updateItem(item.id, { name: e.target.value }, quote, update)}
        />

        <input
          className="border p-2 rounded"
          placeholder="è¦æ ¼"
          value={item.spec}
          onChange={(e) => updateItem(item.id, { spec: e.target.value }, quote, update)}
        />

        <input
          className="border p-2 rounded"
          placeholder="å–®ä½"
          value={item.unit}
          onChange={(e) => updateItem(item.id, { unit: e.target.value }, quote, update)}
        />

        <input
          type="number"
          className="border p-2 rounded"
          placeholder="æ•¸é‡"
          value={item.qty}
          onChange={(e) => updateItem(item.id, { qty: e.target.value }, quote, update)}
        />

        <input
          type="number"
          className="border p-2 rounded"
          placeholder="å–®åƒ¹"
          value={item.price}
          onChange={(e) => updateItem(item.id, { price: e.target.value }, quote, update)}
        />
      </div>

      {/* å°è¨ˆ */}
      <div className="text-right font-bold text-blue-700 pr-4">
        å°è¨ˆï¼š{formatMoney(calcAmount(item))} å…ƒ
      </div>

      {/* æ–°å¢å°é … */}
      <div className="mt-2">
        <button
          className="px-3 py-1 bg-green-600 text-white rounded text-sm"
          onClick={() => addSubItem(item.id, quote, update)}
        >
          ï¼‹æ–°å¢å°é …
        </button>
      </div>
    </div>
  );
}


// ------------------------------
// 2. å°é …è³‡æ–™åˆ—ï¼ˆSub Item Rowï¼‰
// ------------------------------
function SubItemRow({ parentId, sub, quote, update }) {
  return (
    <div className="border-b py-2 pl-6 bg-white">

      <div className="flex justify-between items-center mb-2">
        <span className="font-bold text-gray-700">{sub.name}</span>

        <button
          className="text-red-500 text-sm"
          onClick={() => deleteItem(sub.id, quote, update)}
        >
          åˆªé™¤å°é …
        </button>
      </div>

      <div className="grid grid-cols-5 gap-2 mb-2">
        <input
          className="border p-2 rounded"
          placeholder="åç¨±"
          value={sub.name}
          onChange={(e) => updateItem(sub.id, { name: e.target.value }, quote, update)}
        />

        <input
          className="border p-2 rounded"
          placeholder="è¦æ ¼"
          value={sub.spec}
          onChange={(e) => updateItem(sub.id, { spec: e.target.value }, quote, update)}
        />

        <input
          className="border p-2 rounded"
          placeholder="å–®ä½"
          value={sub.unit}
          onChange={(e) => updateItem(sub.id, { unit: e.target.value }, quote, update)}
        />

        <input
          className="border p-2 rounded"
          type="number"
          placeholder="æ•¸é‡"
          value={sub.qty}
          onChange={(e) => updateItem(sub.id, { qty: e.target.value }, quote, update)}
        />

        <input
          className="border p-2 rounded"
          type="number"
          placeholder="å–®åƒ¹"
          value={sub.price}
          onChange={(e) => updateItem(sub.id, { price: e.target.value }, quote, update)}
        />
      </div>

      <div className="text-right text-blue-700 font-bold pr-4">
        å°è¨ˆï¼š{formatMoney(calcAmount(sub))} å…ƒ
      </div>

      {/* è£œå……å…§å®¹æŒ‰éˆ• */}
      <div className="flex gap-2 mt-2">
        <button
          className="px-3 py-1 bg-gray-600 text-white rounded text-sm"
          onClick={() => addNoteLine(parentId, quote, update)}
        >
          ï¼‹è£œå……èªªæ˜
        </button>

        <button
          className="px-3 py-1 bg-gray-700 text-white rounded text-sm"
          onClick={() => document.getElementById(`img-${sub.id}`).click()}
        >
          ï¼‹è£œå……åœ–ç‰‡
        </button>

        {/* éš±è—ä¸Šå‚³åœ–æª” */}
        <input
          id={`img-${sub.id}`}
          type="file"
          accept="image/*"
          style={{ display: "none" }}
          onChange={(e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(evt) {
              addImageLine(parentId, evt.target.result, quote, update);
            };
            reader.readAsDataURL(file);
          }}
        />
      </div>
    </div>
  );
}


// ------------------------------
// 3. æ•´é«”å“é …åˆ—è¡¨ï¼ˆItemListï¼‰
// ------------------------------
function ItemList({ quote, update }) {
  return (
    <div className="bg-white rounded shadow mb-8">

      {/* å¤§é …æ–°å¢æŒ‰éˆ• */}
      <div className="p-3 border-b no-print">
        <button
          className="px-4 py-2 bg-blue-600 text-white rounded"
          onClick={() => addMainItem(quote, update)}
        >
          ï¼‹æ–°å¢å¤§é …
        </button>
      </div>

      {/* é¡¯ç¤ºæ‰€æœ‰é …ç›® */}
      {quote.items.length === 0 && (
        <div className="p-4 text-gray-500">å°šç„¡å“é …ï¼Œè«‹æ–°å¢æˆ–å¾è¦æ ¼å“åŠ å…¥ã€‚</div>
      )}

      {quote.items.map(item => (
        <div key={item.id}>
          <ItemRow item={item} quote={quote} update={update} />

          {/* å°é … */}
          {item.subItems.map(sub => (
            <SubItemRow
              key={sub.id}
              parentId={item.id}
              sub={sub}
              quote={quote}
              update={update}
            />
          ))}
        </div>
      ))}

    </div>
  );
}
/****************************************************
 * Part 4-3-3-B â€” è£œå……å…§å®¹ï¼ˆæ–‡å­— / åœ–ç‰‡ï¼‰
 ****************************************************/

// ------------------------------
// 4. è£œå……æ–‡å­—åˆ—ï¼ˆNoteRowï¼‰
// ------------------------------
function NoteRow({ parentId, note, quote, update }) {
  return (
    <div className="pl-10 py-2 bg-gray-50 flex justify-between items-start border-b">

      {/* å·¦å´æ–‡å­— */}
      <textarea
        className="w-full border p-2 rounded text-sm"
        value(note.text}
        onChange={(e) =>
          updateItem(note.id, { text: e.target.value }, quote, update)
        }
      />

      {/* åˆªé™¤è£œå……è¡Œ */}
      <button
        className="text-red-600 text-xs ml-2"
        onClick={() => deleteItem(note.id, quote, update)}
      >
        åˆªé™¤
      </button>
    </div>
  );
}


// ------------------------------
// 5. è£œå……åœ–ç‰‡åˆ—ï¼ˆImageRowï¼‰
// ------------------------------
function ImageRow({ parentId, img, quote, update }) {
  return (
    <div className="pl-10 py-3 bg-gray-100 border-b flex items-center justify-between">

      {/* é¡¯ç¤ºåœ–ç‰‡ */}
      <img
        src={img.src}
        alt="è£œå……åœ–ç‰‡"
        className="max-h-32 rounded border shadow"
      />

      {/* åˆªé™¤æŒ‰éˆ• */}
      <button
        className="text-red-600 text-xs ml-3"
        onClick={() => deleteItem(img.id, quote, update)}
      >
        åˆªé™¤
      </button>
    </div>
  );
}


// ------------------------------
// 6. æ•´åˆå¾Œçš„å°é …ä¸‹æ–¹è£œå……å…§å®¹é¡¯ç¤ºå€
// ------------------------------
function SubItemExtraContent({ parentId, sub, quote, update }) {
  return (
    <div>
      {sub.subItems?.map(row => {
        if (row.type === "note") {
          return (
            <NoteRow
              key={row.id}
              parentId={parentId}
              note={row}
              quote={quote}
              update={update}
            />
          );
        }

        if (row.type === "image") {
          return (
            <ImageRow
              key={row.id}
              parentId={parentId}
              img={row}
              quote={quote}
              update={update}
            />
          );
        }

        return null;
      })}
    </div>
  );
}


// ğŸ”„ ä¿®æ”¹ SubItemRowï¼šåŠ å…¥è£œå……å…§å®¹é¡¯ç¤º
const OriginalSubItemRow = SubItemRow;

SubItemRow = function ({ parentId, sub, quote, update }) {
  return (
    <div className="border-b bg-white">

      {/* å°é …è³‡è¨Š */}
      <OriginalSubItemRow
        parentId={parentId}
        sub={sub}
        quote={quote}
        update={update}
      />

      {/* è£œå……å…§å®¹å€ */}
      <SubItemExtraContent
        parentId={parentId}
        sub={sub}
        quote={quote}
        update={update}
      />
    </div>
  );
};
/****************************************************
 * Part 4-4 â€” å‚™è¨» Notesã€ä»˜æ¬¾æ¢ä»¶ã€ç¸½åƒ¹ / è­°åƒ¹ Summary
 ****************************************************/

// -----------------------------
// 1. å‚™è¨»ç·¨è¼¯å€ NotesEditor
// -----------------------------
function NotesEditor({ quote, update }) {
  return (
    <div className="bg-white shadow p-4 rounded mb-6">
      <h2 className="font-bold text-xl mb-2">å‚™è¨»</h2>

      <textarea
        className="w-full h-40 border p-3 rounded"
        value={quote.notes}
        onChange={(e) => update({ notes: e.target.value })}
      />
    </div>
  );
}


// -----------------------------
// 2. ä»˜æ¬¾æ¢ä»¶ PaymentEditor
// -----------------------------
function PaymentEditor({ quote, update }) {
  return (
    <div className="bg-white shadow p-4 rounded mb-6">
      <h2 className="font-bold text-xl mb-2">ä»˜æ¬¾æ¢ä»¶</h2>

      <textarea
        className="w-full h-32 border p-3 rounded"
        value={quote.payment}
        onChange={(e) => update({ payment: e.target.value })}
      />
    </div>
  );
}


// -----------------------------
// 3. ç¸½åƒ¹èˆ‡è­°åƒ¹ SummaryBox
// -----------------------------
function SummaryBox({ quote, update }) {

  // è¨ˆç®—æœªç¨…åˆè¨ˆ
  const total = calcTotal(quote.items);
  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

  return (
    <div className="bg-white shadow p-4 rounded mb-6">

      <h2 className="font-bold text-xl mb-3">é‡‘é¡ç¸½çµ</h2>

      {/* æœªç¨…ç¸½é¡ */}
      <div className="text-lg mb-3">
        <span className="font-bold">æœªç¨…åˆè¨ˆï¼š</span>
        <span className="text-blue-700 font-bold">{formatMoney(total)} å…ƒ</span>
      </div>

      <hr className="my-4" />

      {/* è­°åƒ¹ç™¾åˆ†æ¯” */}
      <div className="mb-3">
        <label className="font-bold block mb-1">è­°åƒ¹æŠ˜æ‰£ï¼ˆ%ï¼‰ï¼š</label>
        <input
          type="number"
          className="border p-2 rounded w-40"
          placeholder="å¦‚ï¼š5"
          value={quote.discountPercent}
          onChange={(e) => update({ discountPercent: e.target.value })}
        />
      </div>

      {/* æˆ–ç›´æ¥è¼¸å…¥è­°åƒ¹å¾Œé‡‘é¡ */}
      <div className="mb-3">
        <label className="font-bold block mb-1">è­°åƒ¹å¾Œé‡‘é¡ï¼ˆç›´æ¥è¼¸å…¥ï¼‰ï¼š</label>
        <input
          type="number"
          className="border p-2 rounded w-60"
          placeholder="è‡ªè¨‚è­°åƒ¹é‡‘é¡"
          value={quote.negotiatedPrice}
          onChange={(e) => update({ negotiatedPrice: e.target.value })}
        />
      </div>

      <div className="mt-4 text-lg">
        <span className="font-bold">è­°åƒ¹å¾Œé‡‘é¡ï¼š</span>
        <span className="text-red-600 font-bold">
          {formatMoney(negotiated)} å…ƒ
        </span>
      </div>

      {/* é¡¯ç¤ºè­°åƒ¹æ–‡å­— */}
      {negotiated !== total && (
        <div className="mt-4 p-3 bg-yellow-100 border-l-4 border-yellow-500">
          {formatDate()} ç¶“è­°åƒ¹å¾Œé‡‘é¡ç‚ºï¼š{formatMoney(negotiated)} å…ƒ
        </div>
      )}
    </div>
  );
}
/****************************************************
 * Part 4-5 â€” å®Œæ•´æ•´åˆæ‰€æœ‰å ±åƒ¹å–®åŠŸèƒ½
 ****************************************************/

// ----------------------
// 1. QuoteEditorï¼ˆå®Œæ•´ç‰ˆï¼‰
// ----------------------
function QuoteEditor() {
  const {
    activeQuoteId,
    quotes,
    updateQuote
  } = React.useContext(AppContext);

  if (!activeQuoteId) {
    return (
      <div className="text-gray-500 text-center p-6">
        è«‹å¾å·¦å´é¸æ“‡æˆ–æ–°å¢å ±åƒ¹å–®
      </div>
    );
  }

  const quote = quotes.find(q => q.id === activeQuoteId);
  if (!quote) return <div>æ‰¾ä¸åˆ°å ±åƒ¹å–®è³‡æ–™ã€‚</div>;

  const update = (data) => updateQuote(quote.id, data);

  return (
    <div className="p-4">

      {/* å…¬å¸æŠ¬é ­ */}
      <QuoteCompanyHeader />

      {/* å®¢æˆ¶è³‡è¨Š */}
      <QuoteHeaderForm quote={quote} update={update} />

      {/* è¦æ ¼å“åŠ å…¥ */}
      <SpecItemSelector quote={quote} update={update} />

      {/* å“é …åˆ—è¡¨ */}
      <ItemList quote={quote} update={update} />

      {/* å‚™è¨» */}
      <NotesEditor quote={quote} update={update} />

      {/* ä»˜æ¬¾ */}
      <PaymentEditor quote={quote} update={update} />

      {/* ç¸½åƒ¹ + è­°åƒ¹ */}
      <SummaryBox quote={quote} update={update} />
    </div>
  );
}


/****************************************************
 * App ä¸»ç•«é¢ï¼ˆåŠ å…¥å·¥å…·åˆ—ï¼‰
 ****************************************************/
function App() {
  return (
    <AppProvider>
      <div className="min-h-screen bg-gray-200">

        {/* æ¨™é¡Œåˆ— */}
        <div className="bg-blue-700 text-white p-4 text-xl font-bold">
          å·¥ç¨‹å ±åƒ¹å–®ç³»çµ±ï¼ˆHerhsinï¼‰
        </div>

        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 p-4">

          {/* å·¦æ¬„ */}
          <div className="space-y-4 md:col-span-1 no-print">
            <CompanySelector />
            <ModeSelector />
            <QuoteManager />
          </div>

          {/* å³æ¬„ï¼šä¸»ç·¨è¼¯å€ + å·¥å…·åˆ— */}
          <div className="md:col-span-3 bg-white rounded shadow">

            {/* å·¥å…·åˆ—ï¼ˆåˆ—å° / Excelï¼‰ */}
            <AppContext.Consumer>
              {({ activeQuoteId, quotes, company }) => {
                const quote = quotes.find(q => q.id === activeQuoteId);
                return (
                  <ToolBar quote={quote} company={company} />
                );
              }}
            </AppContext.Consumer>

            {/* ä¸»ç·¨è¼¯å™¨ */}
            <QuoteEditor />
          </div>
        </div>

      </div>
    </AppProvider>
  );
}

/****************************************************
 * Part 5-1 â€” åˆ—å°æ¨¡å¼ï¼ˆPrint Viewï¼‰
 ****************************************************/

// ç”¢ç”Ÿåˆ—å°æ¨¡å¼çš„å…§å®¹
function PrintView({ quote, company }) {
  const info = COMPANY_DATA[company];
  const total = calcTotal(quote.items);
  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

  return (
    <div className="print-container">

      {/* å…¬å¸æ¨™é¡Œ */}
      <div style={{ fontSize: "26px", fontWeight: "bold", textAlign: "center" }}>
        {info.name}
      </div>

      {/* å…¬å¸è³‡æ–™ */}
      <div style={{ textAlign: "center", fontSize: "14px", marginBottom: "12px" }}>
        é›»è©±ï¼š{info.tel}ã€€å‚³çœŸï¼š{info.fax}ã€€Emailï¼š{info.email}<br />
        åœ°å€ï¼š{info.address}
      </div>

      {/* æ¨™é¡Œ + ç·¨è™Ÿ */}
      <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "6px" }}>
        <div style={{ fontSize: "22px", fontWeight: "bold" }}>å·¥ ç¨‹ å ± åƒ¹ å–®</div>
        <div style={{ fontSize: "14px", marginTop: "6px" }}>
          å ±åƒ¹å–®ç·¨è™Ÿï¼š{quote.quoteNo}
        </div>
      </div>

      {/* å®¢æˆ¶è³‡è¨Š */}
      <table className="print-table" style={{ marginBottom: "12px" }}>
        <tbody>
          <tr>
            <td style={{ width: "20%" }}>é¡§å®¢åç¨±</td>
            <td style={{ width: "30%" }}>{quote.customerName}</td>
            <td style={{ width: "20%" }}>è¯çµ¡äºº</td>
            <td style={{ width: "30%" }}>{quote.contact}</td>
          </tr>
          <tr>
            <td>é›»è©±</td>
            <td>{quote.phone}</td>
            <td>å ±åƒ¹æ—¥æœŸ</td>
            <td>{quote.date}</td>
          </tr>
          <tr>
            <td>å·¥ç¨‹åç¨±</td>
            <td>{quote.title}</td>
            <td>å·¥ç¨‹åœ°é»</td>
            <td>{quote.location}</td>
          </tr>
        </tbody>
      </table>

      {/* å“é …è¡¨æ ¼ */}
      <table className="print-table">
        <thead>
          <tr>
            <th className="w-seq">åº</th>
            <th className="w-name">å“å</th>
            <th className="w-spec">è¦æ ¼ / èªªæ˜</th>
            <th className="w-unit">å–®ä½</th>
            <th className="w-qty">æ•¸é‡</th>
            <th className="w-price">å–®åƒ¹</th>
            <th className="w-amt">é‡‘é¡</th>
          </tr>
        </thead>

        <tbody>
          {quote.items.map((item, index) => (
            <>
              <tr>
                <td>{index + 1}</td>
                <td>{item.name}</td>
                <td>{item.spec}</td>
                <td>{item.unit}</td>
                <td>{item.qty}</td>
                <td>{formatMoney(item.price)}</td>
                <td>{formatMoney(calcAmount(item))}</td>
              </tr>

              {item.subItems.map((sub, i) => (
                <tr key={`${index}-${i}`}>
                  <td></td>
                  <td>{sub.type === "sub" ? "â†’ " + sub.name : ""}</td>
                  <td>{sub.type === "sub" ? sub.spec : sub.text}</td>
                  <td>{sub.unit || ""}</td>
                  <td>{sub.qty || ""}</td>
                  <td>{sub.price ? formatMoney(sub.price) : ""}</td>
                  <td>{sub.qty ? formatMoney(calcAmount(sub)) : ""}</td>
                </tr>
              ))}
            </>
          ))}
        </tbody>
      </table>

      {/* åˆè¨ˆ */}
      <table className="print-table" style={{ marginTop: "10px" }}>
        <tbody>
          <tr>
            <td style={{ width: "80%", textAlign: "right", fontWeight: "bold" }}>æœªç¨…åˆè¨ˆï¼š</td>
            <td style={{ fontWeight: "bold" }}>{formatMoney(total)}</td>
          </tr>

          {negotiated !== total && (
            <tr>
              <td style={{ textAlign: "right", fontWeight: "bold" }}>è­°åƒ¹å¾Œé‡‘é¡ï¼š</td>
              <td style={{ fontWeight: "bold" }}>{formatMoney(negotiated)}</td>
            </tr>
          )}
        </tbody>
      </table>

      {/* å‚™è¨» */}
      <div style={{ marginTop: "16px" }}>
        <b>å‚™è¨»ï¼š</b><br />
        <div style={{ whiteSpace: "pre-line" }}>{quote.notes}</div>
      </div>

      {/* ä»˜æ¬¾æ¢ä»¶ */}
      <div style={{ marginTop: "16px" }}>
        <b>ä»˜æ¬¾æ¢ä»¶ï¼š</b><br />
        <div style={{ whiteSpace: "pre-line" }}>{quote.payment}</div>
      </div>

      {/* å°ç«  + ç°½å */}
      <div style={{ marginTop: "26px", display: "flex", justifyContent: "space-between" }}>
        <div>
          å®¢æˆ¶å›ç°½æ¬„ï¼š<br /><br /><br />
          ___________________________
        </div>

        <div style={{ textAlign: "center" }}>
          {info.name}<br />
          <span style={{ fontSize: "12px" }}>ï¼ˆæœ¬å…¬å¸è“‹ç« å€ï¼‰</span>
          <div style={{ marginTop: "6px" }}>
            <img src={info.stamp} style={{ width: "120px", height: "120px", objectFit: "contain" }} />
          </div>
        </div>
      </div>

      {/* é ç¢¼ */}
      <div id="print-page-number"></div>
    </div>
  );
}


// ----------------------
// é–‹å•Ÿåˆ—å°
// ----------------------
function openPrint() {
  window.print();
}
/****************************************************
 * Part 5-2 â€” Excel åŒ¯å‡ºåŠŸèƒ½ (XLSX)
 ****************************************************/

function exportExcel(quote, company) {
  const info = COMPANY_DATA[company];

  // å»ºç«‹ Excel å·¥ä½œè¡¨è³‡æ–™ï¼ˆæŒ‰åˆ—ï¼‰
  let rows = [];

  // ---------------------------
  // å…¬å¸è³‡æ–™ + æ¨™é¡Œ
  // ---------------------------
  rows.push([info.name]);
  rows.push([info.tel]);
  rows.push([info.fax]);
  rows.push([info.email]);
  rows.push([info.address]);
  rows.push([]);
  rows.push([info.title]);
  rows.push([]);

  // ---------------------------
  // å®¢æˆ¶è³‡è¨Š
  // ---------------------------
  rows.push(["é¡§å®¢åç¨±", quote.customerName]);
  rows.push(["è¯çµ¡äºº", quote.contact]);
  rows.push(["é›»è©±", quote.phone]);
  rows.push(["å·¥ç¨‹åç¨±", quote.title]);
  rows.push(["å·¥ç¨‹åœ°é»", quote.location]);
  rows.push(["å ±åƒ¹æ—¥æœŸ", quote.date]);
  rows.push([]);

  // ---------------------------
  // è¡¨æ ¼æ¨™é¡Œåˆ—
  // ---------------------------
  rows.push([
    "å“å",
    "è¦æ ¼",
    "å–®ä½",
    "æ•¸é‡",
    "å–®åƒ¹",
    "å°è¨ˆ"
  ]);

  // ---------------------------
  // å“é …è³‡æ–™
  // ---------------------------
  quote.items.forEach(main => {
    // å¤§é …åˆ—
    rows.push([
      main.name,
      main.spec,
      main.unit,
      main.qty,
      main.price,
      calcAmount(main)
    ]);

    // å°é … + è£œå……
    main.subItems.forEach(sub => {
      if (sub.type === "sub") {
        rows.push([
          "ã€€â†’ " + sub.name,
          sub.spec,
          sub.unit,
          sub.qty,
          sub.price,
          calcAmount(sub)
        ]);
      }

      if (sub.type === "note") {
        rows.push([
          "ã€€ã€€â€»" + sub.text,
          "",
          "",
          "",
          "",
          ""
        ]);
      }
    });
  });

  rows.push([]);

  // ---------------------------
  // é‡‘é¡ç¸½çµ
  // ---------------------------
  const total = calcTotal(quote.items);
  rows.push(["æœªç¨…åˆè¨ˆ", "", "", "", "", total]);

  // è­°åƒ¹ï¼ˆå¦‚æœ‰ï¼‰
  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);
  if (negotiated !== total) {
    rows.push(["è­°åƒ¹å¾Œé‡‘é¡", "", "", "", "", negotiated]);
  }

  rows.push([]);

  // ---------------------------
  // å‚™è¨»
  // ---------------------------
  rows.push(["å‚™è¨»"]);
  quote.notes.split("\n").forEach(line => rows.push([line]));
  rows.push([]);

  // ---------------------------
  // ä»˜æ¬¾æ¢ä»¶
  // ---------------------------
  rows.push(["ä»˜æ¬¾æ¢ä»¶"]);
  quote.payment.split("\n").forEach(line => rows.push([line]));

  // ---------------------------
  // å»ºç«‹ Workbook
  // ---------------------------
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);

  // è‡ªå‹•èª¿æ•´æ¬„å¯¬
  ws["!cols"] = [
    { wch: 30 }, // å“å
    { wch: 30 },
    { wch: 10 },
    { wch: 10 },
    { wch: 12 },
    { wch: 15 }
  ];

  // åŠ å…¥å·¥ä½œè¡¨
  XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å–®");

  // ä¸‹è¼‰
  const filename = `${quote.title}_å ±åƒ¹å–®.xlsx`;
  XLSX.writeFile(wb, filename);
}
/****************************************************
 * Part 5-3 â€” å·¥å…·åˆ—ï¼ˆåˆ—å° / Excelï¼‰
 ****************************************************/

function ToolBar({ quote, company }) {
  if (!quote) return null;

  return (
    <div className="flex gap-3 p-3 bg-white border-b no-print">

      {/* åˆ—å°è§¸ç™¼ */}
      <button
        className="px-4 py-2 bg-blue-700 text-white rounded shadow"
        onClick={() => openPrint()}
      >
        ğŸ“„ åˆ—å° / è½‰ PDF
      </button>

      {/* åŒ¯å‡º Excel */}
      <button
        className="px-4 py-2 bg-green-700 text-white rounded shadow"
        onClick={() => exportExcel(quote, company)}
      >
        ğŸ“Š åŒ¯å‡º Excel
      </button>

      {/* åŒ¯å‡ºè­°åƒ¹ Excelï¼ˆè‡ªå‹•ç”¨è­°åƒ¹å¾Œé‡‘é¡ï¼‰ */}
      <button
        className="px-4 py-2 bg-orange-600 text-white rounded shadow"
        onClick={() => exportExcelNegotiated(quote, company)}
      >
        ğŸ“ åŒ¯å‡ºè­°åƒ¹ Excel
      </button>
    </div>
  );
}


/****************************************************
 * è­°åƒ¹ Excel åŒ¯å‡ºï¼ˆå¥—ç”¨è­°åƒ¹å¾Œé‡‘é¡ï¼‰
 ****************************************************/
function exportExcelNegotiated(quote, company) {
  const total = calcTotal(quote.items);
  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

  // ç›´æ¥è¤‡è£½ quoteï¼ˆæ·ºè¤‡è£½ï¼‰
  const q2 = { ...quote };

  // å¯«å…¥è­°åƒ¹å¾Œé‡‘é¡ï¼Œå¼·åˆ¶è¦†è“‹ negotiatedPrice
  q2.negotiatedPrice = negotiated;

  // æª”ååŠ è¨»è­°åƒ¹
  const originalExport = XLSX.writeFile;
  XLSX.writeFile = function (wb, name) {
    return originalExport(wb, name.replace(".xlsx", "_è­°åƒ¹ç‰ˆ.xlsx"));
  };

  exportExcel(q2, company);

  XLSX.writeFile = originalExport;
}
/****************************************************
 * Part 5-4 â€” åˆ—å°æ¨¡å¼ CSS ç¾åŒ–
 ****************************************************/

/* ğŸ”¹ éåˆ—å°æ¨¡å¼ï¼ˆè¢å¹•ï¼‰ */
@media screen {
  .print-container {
    display: none;
  }
}

/* ğŸ”¹ åˆ—å°æ¨¡å¼ */
@media print {

  /* éš±è—æ‰€æœ‰åŠ äº† no-print çš„ UI */
  .no-print,
  .no-print * {
    display: none !important;
  }

  /* ä½¿ print-container æˆç‚ºä¸»è¦è¼¸å‡ºå…§å®¹ */
  .print-container {
    display: block !important;
    width: 100%;
    padding: 20px 30px;
    font-size: 14px;
    line-height: 1.4;
  }

  /* A4 ç‰ˆé¢ï¼ˆé•·åº¦ç”±ç€è¦½å™¨æ§åˆ¶ï¼‰ */
  @page {
    size: A4 portrait;
    margin: 12mm;
  }

  /* è¡¨æ ¼å„ªåŒ– */
  table {
    border-collapse: collapse !important;
    width: 100% !important;
    font-size: 13px;
  }

  table th,
  table td {
    border: 1px solid #000 !important;
    padding: 6px 8px !important;
  }

  /* æ¨™é¡Œç½®ä¸­ */
  .print-title {
    text-align: center;
    font-size: 22px;
    font-weight: bold;
    margin: 10px 0 20px;
  }

  /* å…¬å¸è³‡è¨Š */
  .print-company-header {
    text-align: center;
    margin-bottom: 15px;
    font-size: 14px;
    line-height: 1.5;
  }

  /* åœ–ç‰‡ç¸®æ”¾ï¼Œé¿å…çˆ†ç‰ˆ */
  img {
    max-width: 95% !important;
    max-height: 260px !important;
    display: block;
    margin: 6px auto;
  }

  /* é¿å…é¡¯ç¤º React DevTools ç­‰è¨Šæ¯ */
  body {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  /* é¿å…é é¢è¢«åˆ‡é–‹ï¼ˆè¡¨æ ¼æ®µè½å‰é¿å…åˆ†é ï¼‰ */
  tr, img, .print-section {
    page-break-inside: avoid !important;
  }
}
/****************************************************
 * Part 5-5 â€” åˆ—å°æ¸²æŸ“ï¼šå°‡ PrintView å‹•æ…‹æ³¨å…¥ printArea
 ****************************************************/

function renderPrintView(quote, company) {
  const printRoot = document.getElementById("printArea");
  if (!printRoot) return;

  const printElement = (
    <PrintView quote={quote} company={company} />
  );

  ReactDOM.render(printElement, printRoot);
}

function openPrint() {
  const app = window.__APP_CONTEXT__;
  if (!app) return alert("ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° APP Context");

  const { quotes, activeQuoteId, company } = app;
  const quote = quotes.find(q => q.id === activeQuoteId);

  if (!quote) {
    alert("è«‹å…ˆé¸æ“‡å ±åƒ¹å–®");
    return;
  }

  // ğŸ”¹ 1. æ¸²æŸ“åˆ—å°ç‰ˆ
  renderPrintView(quote, company);

  // ğŸ”¹ 2. å»¶é²ä¸€ä¸‹è®“ç•«é¢å®Œæˆæ¸²æŸ“
  setTimeout(() => {
    window.print();
  }, 150);
}
/****************************************************
 * Part 5-6 â€” PrintViewï¼ˆå°ˆæ¥­æ­£å¼å ±åƒ¹å–®ï¼‰
 ****************************************************/
function PrintView({ quote, company }) {
  const info = COMPANY_DATA[company];
  const total = calcTotal(quote.items);
  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

  return (
    <div className="print-container">

      {/* å…¬å¸æ¨™é¡Œ */}
      <div className="print-company-header" style={{ fontSize: "26px", fontWeight: "bold" }}>
        {info.name}
      </div>

      {/* è¯çµ¡è³‡æ–™ */}
      <div className="print-company-header" style={{ fontSize: "14px" }}>
        é›»è©±ï¼š{info.tel}ã€€ã€€å‚³çœŸï¼š{info.fax}ã€€ã€€Emailï¼š{info.email} <br />
        åœ°å€ï¼š{info.address}
      </div>

      {/* å ±åƒ¹å–®æ¨™é¡Œ */}
      <div className="print-title">å·¥ã€€ç¨‹ã€€å ±ã€€åƒ¹ã€€å–®</div>

      {/* å®¢æˆ¶è³‡è¨Šå€å¡Š */}
      <table style={{ width: "100%", marginBottom: "10px" }}>
        <tbody>
          <tr>
            <td style={{ width: "20%" }}>é¡§å®¢åç¨±</td>
            <td style={{ width: "30%" }}>{quote.customerName}</td>
            <td style={{ width: "20%" }}>è¯çµ¡äºº</td>
            <td style={{ width: "30%" }}>{quote.contact}</td>
          </tr>

          <tr>
            <td>é›»è©±</td>
            <td>{quote.phone}</td>
            <td>å ±åƒ¹æ—¥æœŸ</td>
            <td>{quote.date}</td>
          </tr>

          <tr>
            <td>å·¥ç¨‹åç¨±</td>
            <td>{quote.title}</td>
            <td>å·¥ç¨‹åœ°é»</td>
            <td>{quote.location}</td>
          </tr>
        </tbody>
      </table>

      {/* å“é …è¡¨æ ¼ */}
      <table style={{ width: "100%", marginTop: "10px" }}>
        <thead>
          <tr>
            <th style={{ width: "5%" }}>åºè™Ÿ</th>
            <th style={{ width: "25%" }}>å“å</th>
            <th style={{ width: "30%" }}>è¦æ ¼ / èªªæ˜</th>
            <th style={{ width: "10%" }}>å–®ä½</th>
            <th style={{ width: "10%" }}>æ•¸é‡</th>
            <th style={{ width: "10%" }}>å–®åƒ¹</th>
            <th style={{ width: "10%" }}>é‡‘é¡</th>
          </tr>
        </thead>

        <tbody>
          {quote.items.map((item, index) => (
            <>
              {/* ä¸»é …ç›® */}
              <tr>
                <td>{index + 1}</td>
                <td>{item.name}</td>
                <td>{item.spec}</td>
                <td>{item.unit}</td>
                <td>{item.qty}</td>
                <td>{formatMoney(item.price)}</td>
                <td>{formatMoney(calcAmount(item))}</td>
              </tr>

              {/* å­é …ç›® + è£œå…… */}
              {item.subItems.map((sub, i) => (
                <tr key={`${index}-${i}`}>
                  <td></td>
                  <td>{sub.type === "sub" ? "â†’ " + sub.name : ""}</td>
                  <td>{sub.type === "sub" ? sub.spec : sub.text}</td>
                  <td>{sub.unit || ""}</td>
                  <td>{sub.qty || ""}</td>
                  <td>{sub.price ? formatMoney(sub.price) : ""}</td>
                  <td>{sub.qty ? formatMoney(calcAmount(sub)) : ""}</td>
                </tr>
              ))}
            </>
          ))}
        </tbody>
      </table>

      {/* åˆè¨ˆå€å¡Š */}
      <table style={{ width: "100%", marginTop: "10px" }}>
        <tbody>
          <tr>
            <td style={{ width: "80%", textAlign: "right", fontWeight: "bold" }}>æœªç¨…åˆè¨ˆï¼š</td>
            <td style={{ width: "20%", fontWeight: "bold" }}>
              {formatMoney(total)}
            </td>
          </tr>

          {negotiated !== total && (
            <tr>
              <td style={{ textAlign: "right", fontWeight: "bold" }}>è­°åƒ¹å¾Œé‡‘é¡ï¼š</td>
              <td style={{ fontWeight: "bold" }}>{formatMoney(negotiated)}</td>
            </tr>
          )}
        </tbody>
      </table>

      {/* å‚™è¨» */}
      <div className="print-section" style={{ marginTop: "18px" }}>
        <div style={{ fontWeight: "bold", marginBottom: "6px" }}>å‚™è¨»ï¼š</div>
        <div style={{ whiteSpace: "pre-line" }}>
          {quote.notes}
        </div>
      </div>

      {/* ä»˜æ¬¾æ¢ä»¶ */}
      <div className="print-section" style={{ marginTop: "18px" }}>
        <div style={{ fontWeight: "bold", marginBottom: "6px" }}>ä»˜æ¬¾æ¢ä»¶ï¼š</div>
        <div style={{ whiteSpace: "pre-line" }}>
          {quote.payment}
        </div>
      </div>

{/* ç°½åèˆ‡è“‹ç« æ¬„ */}
<div style={{ marginTop: "30px", display: "flex", justifyContent: "space-between" }}>
  
  {/* å®¢æˆ¶ç°½åæ¬„ */}
  <div>
    å®¢æˆ¶å›ç°½æ¬„ï¼š<br /><br /><br />
    ________________________
  </div>

  {/* å…¬å¸å°ç«  */}
  <div style={{ textAlign: "center" }}>
    {info.name}<br />
    <span style={{ fontSize: "12px" }}>ï¼ˆæœ¬å…¬å¸è“‹ç« å°ˆç”¨å€ï¼‰</span>

    <div style={{ marginTop: "6px" }}>
      <img
        src={info.stamp}
        alt="å…¬å¸å°ç« "
        style={{
          width: "120px",
          height: "120px",
          objectFit: "contain",
          opacity: 0.95
        }}
      />
    </div>
  </div>
</div>
  );
}
/****************************************************
 * Part 5-7 â€” å°ˆæ¥­åˆ—å°ç‰ˆï¼ˆå«å°ç«  + ç·¨è™Ÿï¼‰å®Œæ•´ç‰ˆæœ¬
 ****************************************************/
function PrintView({ quote, company }) {
  const info = COMPANY_DATA[company];
  const total = calcTotal(quote.items);
  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

  return (
    <div className="print-container">

      {/* å…¬å¸åç¨± */}
      <div className="print-company-header" style={{ fontSize: "26px", fontWeight: "bold" }}>
        {info.name}
      </div>

      {/* å…¬å¸è¯çµ¡è³‡è¨Š */}
      <div className="print-company-header" style={{ fontSize: "14px" }}>
        é›»è©±ï¼š{info.tel}ã€€ã€€å‚³çœŸï¼š{info.fax}ã€€ã€€Emailï¼š{info.email} <br />
        åœ°å€ï¼š{info.address}
      </div>

      {/* å ±åƒ¹å–®æ¨™é¡Œ + ç·¨è™Ÿ */}
      <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "10px" }}>
        <div className="print-title" style={{ marginBottom: "0" }}>
          å·¥ã€€ç¨‹ã€€å ±ã€€åƒ¹ã€€å–®
        </div>
        <div style={{ fontSize: "14px", textAlign: "right", marginTop: "5px" }}>
          å ±åƒ¹å–®ç·¨è™Ÿï¼š{quote.quoteNo}
        </div>
      </div>

      {/* å®¢æˆ¶è³‡è¨Šå€ */}
      <table style={{ width: "100%", marginBottom: "10px" }}>
        <tbody>
          <tr>
            <td style={{ width: "20%" }}>é¡§å®¢åç¨±</td>
            <td style={{ width: "30%" }}>{quote.customerName}</td>
            <td style={{ width: "20%" }}>è¯çµ¡äºº</td>
            <td style={{ width: "30%" }}>{quote.contact}</td>
          </tr>
          <tr>
            <td>é›»è©±</td>
            <td>{quote.phone}</td>
            <td>å ±åƒ¹æ—¥æœŸ</td>
            <td>{quote.date}</td>
          </tr>
          <tr>
            <td>å·¥ç¨‹åç¨±</td>
            <td>{quote.title}</td>
            <td>å·¥ç¨‹åœ°é»</td>
            <td>{quote.location}</td>
          </tr>
        </tbody>
      </table>

      {/* å“é …æ˜ç´° */}
      <table style={{ width: "100%", marginTop: "10px" }}>
        <thead>
          <tr>
            <th style={{ width: "5%" }}>åºè™Ÿ</th>
            <th style={{ width: "25%" }}>å“å</th>
            <th style={{ width: "30%" }}>è¦æ ¼ / èªªæ˜</th>
            <th style={{ width: "10%" }}>å–®ä½</th>
            <th style={{ width: "10%" }}>æ•¸é‡</th>
            <th style={{ width: "10%" }}>å–®åƒ¹</th>
            <th style={{ width: "10%" }}>é‡‘é¡</th>
          </tr>
        </thead>

        <tbody>
          {quote.items.map((item, index) => (
            <>
              <tr>
                <td>{index + 1}</td>
                <td>{item.name}</td>
                <td>{item.spec}</td>
                <td>{item.unit}</td>
                <td>{item.qty}</td>
                <td>{formatMoney(item.price)}</td>
                <td>{formatMoney(calcAmount(item))}</td>
              </tr>

              {item.subItems.map((sub, i) => (
                <tr key={`${index}-${i}`}>
                  <td></td>
                  <td>{sub.type === "sub" ? "â†’ " + sub.name : ""}</td>
                  <td>{sub.type === "sub" ? sub.spec : sub.text}</td>
                  <td>{sub.unit || ""}</td>
                  <td>{sub.qty || ""}</td>
                  <td>{sub.price ? formatMoney(sub.price) : ""}</td>
                  <td>{sub.qty ? formatMoney(calcAmount(sub)) : ""}</td>
                </tr>
              ))}
            </>
          ))}
        </tbody>
      </table>

      {/* åˆè¨ˆ */}
      <table style={{ width: "100%", marginTop: "12px" }}>
        <tbody>
          <tr>
            <td style={{ width: "80%", textAlign: "right", fontWeight: "bold" }}>æœªç¨…åˆè¨ˆï¼š</td>
            <td style={{ width: "20%", fontWeight: "bold" }}>{formatMoney(total)}</td>
          </tr>

          {negotiated !== total && (
            <tr>
              <td style={{ textAlign: "right", fontWeight: "bold" }}>è­°åƒ¹å¾Œé‡‘é¡ï¼š</td>
              <td style={{ fontWeight: "bold" }}>{formatMoney(negotiated)}</td>
            </tr>
          )}
        </tbody>
      </table>

      {/* å‚™è¨» */}
      <div className="print-section" style={{ marginTop: "18px" }}>
        <div style={{ fontWeight: "bold" }}>å‚™è¨»ï¼š</div>
        <div style={{ whiteSpace: "pre-line" }}>{quote.notes}</div>
      </div>

      {/* ä»˜æ¬¾æ¢ä»¶ */}
      <div className="print-section" style={{ marginTop: "18px" }}>
        <div style={{ fontWeight: "bold" }}>ä»˜æ¬¾æ¢ä»¶ï¼š</div>
        <div style={{ whiteSpace: "pre-line" }}>{quote.payment}</div>
      </div>

      {/* ç°½åèˆ‡è“‹ç« æ¬„ */}
      <div style={{ marginTop: "30px", display: "flex", justifyContent: "space-between" }}>
        
        {/* å®¢æˆ¶ç°½åæ¬„ */}
        <div>
          å®¢æˆ¶å›ç°½æ¬„ï¼š<br /><br /><br />
          ________________________
        </div>

        {/* å…¬å¸å°ç«  */}
        <div style={{ textAlign: "center" }}>
          {info.name}<br />
          <span style={{ fontSize: "12px" }}>ï¼ˆæœ¬å…¬å¸è“‹ç« å°ˆç”¨å€ï¼‰</span>
          <div style={{ marginTop: "6px" }}>
            <img
              src={info.stamp}
              alt="å…¬å¸å°ç« "
              style={{
                width: "120px",
                height: "120px",
                objectFit: "contain",
                opacity: 0.95
              }}
            />
          </div>
        </div>
      </div>

    </div>
  );
}
/* ===========================
   P5-8 å°ˆæ¥­åˆ—å°æ ¼å¼å¼·åŒ– CSS
   =========================== */

/* åˆ—å°æ™‚ç™½åº• + ç§»é™¤ Tailwind ç°èƒŒæ™¯ */
@media print {
  body {
    background: white !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  .no-print {
    display: none !important;
  }

  /* è‡ªå‹•åˆ†é  */
  .page-break {
    page-break-after: always;
  }

  /* åˆ—å°å®¹å™¨æœ€å¤§åŒ– */
  .print-container {
    width: 100%;
    padding: 6mm;
    font-size: 14px;
  }

  /* è¡¨æ ¼å¤–æ¡†ç²—ç·š */
  table.print-table {
    width: 100%;
    border-collapse: collapse;
    border: 2px solid black;
  }

  table.print-table th,
  table.print-table td {
    border: 1px solid black;
    padding: 3px 4px;
  }

  /* è¡¨æ ¼æ¬„ä½å›ºå®šå¯¬åº¦ï¼ˆä¸è·‘ç‰ˆï¼‰ */
  .w-seq   { width: 40px; }
  .w-name  { width: 140px; }
  .w-spec  { width: 240px; }
  .w-unit  { width: 60px; }
  .w-qty   { width: 60px; }
  .w-price { width: 80px; }
  .w-amt   { width: 100px; }

  /* æ¯é ã€Œè¡¨é ­é‡è¤‡ã€ */
  thead { display: table-header-group; }
  tfoot { display: table-footer-group; }

  /* é ç¢¼ä½ç½® */
  #print-page-number {
    position: fixed;
    bottom: 2mm;
    right: 10mm;
    font-size: 12px;
  }
}



  </script>
</body>
</html>
