<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>工程報價系統（Herhsin & SinChang）</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
    body {
      background: #f3f4f6;
      font-family: "Microsoft JhengHei", sans-serif;
    }
  </style>

    <style>
    @media print {

      /* 隱藏非列印元素 */
      .no-print {
        display: none !important;
      }

      /* 列印容器：確保內容正確呈現 */
      body, html {
        margin: 0;
        padding: 0;
      }
      
      #root {
        display: none; /* 隱藏主編輯區 */
      }
      
      #printArea {
        display: block !important;
        margin: 0;
        padding: 12mm;
        font-size: 14px;
        color: black;
      }

      /* 表格樣式 */
      table {
        border-collapse: collapse;
        width: 100%;
      }

      th, td {
        border: 1px solid black;
        padding: 4px 6px;
        vertical-align: top;
      }

      thead {
        display: table-header-group; /* 確保表頭在每頁重複 */
      }

      tfoot {
        display: table-footer-group; /* 確保表尾在每頁重複 */
      }

      tr {
        page-break-inside: avoid; /* 防止行被截斷 */
      }

      /* 公司印章 - 模擬印章位置 */
      .print-stamp {
        position: absolute;
        top: 100px;
        right: 50px;
        max-width: 120px;
        opacity: 0.7;
      }

      /* 圖片列印樣式 */
      .print-image {
        max-width: 300px; /* 限制列印圖片大小 */
        height: auto;
      }
    }
  </style>
</head>

<body class="text-gray-900">

    <div id="root"></div>

    <div id="printArea" class="hidden">
      <div id="print-page-number"></div>
  </div>

<script type="text/babel">
// P1 — 公司資料 / 付款條件 / 備註 / 模式模板
// 註：圖片路徑 (`stamp`) 在單一 HTML 檔案中可能需要使用 Data URL 或 Base64 編碼，
// 這裡暫時使用相對路徑/佔位符。
const COMPANY_DATA = {
  herhsin: {
    name: "何鑫實業股份有限公司",
    tel: "07-6517476",
    fax: "07-6517994",
    email: "admin@herhsin.com",
    address: "831高雄市大寮區鳳林三路383-3號",
    stamp: "herhsin_stamp_placeholder.png" // 佔位符
  },
  sinchang: {
    name: "薪昌有限公司",
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831高雄市大寮區鳳林三路383-3號",
    stamp: "sinchang_stamp_placeholder.png" // 佔位符
  }
};

// 預設備註
const DEFAULT_NOTES = `
1. 本報價未含加值稅。
2. 安裝施作時需注意現場作業環境。
3. 報價單有效期限為 15 天。
4. 若遇不可抗力因素造成延誤，工期順延。
5. 料件須由本公司提供與安裝，否則不在保固範圍內。
6. 付款條件依雙方合約內容為準。
`;

// 預設付款條件
const DEFAULT_PAYMENT = `
訂金：40%
製作完成：30%
安裝完成：20%
完工驗收：10%
`;

// 報價模式模板
const QUOTE_MODES = [
  {
    id: "modeA",
    name: "拌合機漏漿更換",
    description: "適用拌合機維修、漏漿處理等。",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  },
  {
    id: "modeB",
    name: "設備銷售",
    description: "適用備品、單機銷售與安裝。",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  },
  {
    id: "modeC",
    name: "設備更換工程",
    description: "適用整機更新、料件更換工程。",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  }
];

// P2 — 工具函式（完整）
function uuid() {
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
    const r = (Math.random() * 16) | 0;
    const v = c === "x" ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

function formatDate(dateStr = new Date()) {
  const d = dateStr instanceof Date ? dateStr : new Date(dateStr);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`; // 改為 ISO 格式以利 input type="date"
}

function formatMoney(num) {
  // 處理空值和非數字，但允許數字 0
  if (num === "" || num === null || num === undefined || isNaN(Number(num))) return "";
  return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 });
}

function calcAmount(item) {
  // 確保 qty 和 price 轉為數字，否則為 0
  const qty = Number(item.qty || 0);
  const price = Number(item.price || 0);
  return qty * price;
}

function calcTotal(items) {
  return items.reduce((sum, it) => {
    let mainAmt = calcAmount(it);
    let subs = 0;

    if (it.subItems && it.subItems.length > 0) {
      subs = it.subItems.reduce((s, sub) => s + calcAmount(sub), 0);
    }

    return sum + mainAmt + subs;
  }, 0);
}

function calcNegotiated(total, discountPercent, customPrice) {
  const cp = Number(customPrice || 0);
  const dp = Number(discountPercent || 0);
  
  if (cp > 0) return cp;
  
  if (dp > 0 && dp < 100) {
    return Math.round(total * (1 - dp / 100));
  }
  return total;
}

// 報價單編號
function generateQuoteNo() {
  // 使用 YYYYMMDDHHMM + 4位亂數
  const d = new Date();
  const parts = [
    d.getFullYear(),
    String(d.getMonth() + 1).padStart(2, "0"),
    String(d.getDate()).padStart(2, "0"),
    String(d.getHours()).padStart(2, "0"),
    String(d.getMinutes()).padStart(2, "0"),
  ].join('');
  
  const random = Math.floor(1000 + Math.random() * 9000);
  
  return `Q${parts}-${random}`;
}

// 載入 Google Sheet CSV (非同步函式)
async function loadCSV(url) {
  try {
    const res = await fetch(url);
    const text = await res.text();
    // 這裡需要一個更強健的 CSV 解析器，但為了保持單一檔案架構，暫時簡化
    const rows = text.split("\n").map(r => r.trim()).filter(r => r.length > 0);
    if (rows.length === 0) return [];
    
    // 假設第一行為標頭，且不包含逗號
    const header = rows[0].split(",");

    return rows.slice(1).map(row => {
      // 簡易解析，可能會在欄位中有逗號時出錯
      const cols = row.split(",");
      const obj = {};

      header.forEach((h, i) => {
        // 修剪標頭和內容
        obj[h.trim()] = cols[i] ? cols[i].trim() : "";
      });
      return obj;
    });
  } catch (error) {
    console.error("載入或解析 Google Sheet CSV 失敗:", error);
    return [];
  }
}


// P3 — AppContext（核心資料中心）
const AppContext = React.createContext();

function AppProvider({ children }) {
  // 公司 herhsin / sinchang
  const [company, setCompany] = React.useState("herhsin");

  // 報價單列表
  const [quotes, setQuotes] = React.useState([]);

  // 正在編輯的報價單 ID
  const [activeQuoteId, setActiveQuoteId] = React.useState(null);

  // 規格品（來自 Google Sheet）
  const [specItems, setSpecItems] = React.useState([]);

  // Google Sheet 路徑 (請確保這是公開的 CSV 連結)
  const SPEC_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv";

  //************* 初始化：從 localStorage 載入 *************/
  React.useEffect(() => {
    const saved = localStorage.getItem("HERHSIN_QUOTES");

    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        // 確保載入的是陣列
        if (Array.isArray(parsed)) {
          setQuotes(parsed);
          if (parsed.length > 0) setActiveQuoteId(parsed[0].id);
        }
      } catch (e) {
        console.error("解析 localStorage 數據失敗:", e);
        setQuotes([]);
        setActiveQuoteId(null);
      }
    }
  }, []);

  //************* 自動存回 localStorage *************/
  React.useEffect(() => {
    try {
      localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
    } catch (e) {
      console.error("寫入 localStorage 失敗:", e);
    }
  }, [quotes]);


  //************* 載入 Google Sheet 規格品 *************/
  React.useEffect(() => {
    // 由於 CDN 環境下不應過度依賴非同步外部資源，僅做一次載入嘗試
    loadCSV(SPEC_CSV_URL).then(data => setSpecItems(data));
  }, []);


  // 建立新報價單（可套用模式）
  const createQuote = React.useCallback((modeId = null) => {
    const mode = QUOTE_MODES.find(m => m.id === modeId);

    const newQuote = {
      id: uuid(),
      quoteNo: generateQuoteNo(),
      title: mode ? mode.name : "未命名工程",
      customerName: "",
      contact: "",
      phone: "",
      location: "",
      date: formatDate(), // 使用修正後的格式化函數
      items: mode && Array.isArray(mode.defaultItems) ? mode.defaultItems.map(item => ({...item, id: uuid(), subItems: []})) : [],
      notes: mode ? mode.defaultNotes : DEFAULT_NOTES,
      payment: mode ? mode.defaultPayment : DEFAULT_PAYMENT,
      discountPercent: 0,
      negotiatedPrice: 0
    };

    setQuotes(prev => {
      const newList = [newQuote, ...prev]; // 新報價單放在最前面
      setActiveQuoteId(newQuote.id);
      return newList;
    });
  }, []);


  // 刪除報價單
  const deleteQuote = React.useCallback((id) => {
    setQuotes(prev => {
      const newList = prev.filter(q => q.id !== id);
      
      if (id === activeQuoteId) {
        setActiveQuoteId(newList.length > 0 ? newList[0].id : null);
      }
      return newList;
    });
  }, [activeQuoteId]);


  // 更新報價單欄位
  const updateQuote = React.useCallback((id, data) => {
    setQuotes(prev =>
      prev.map(q => (q.id === id ? { ...q, ...data } : q))
    );
  }, []);


  // 套用模式（覆蓋：標題、備註、付款、預設項目）
  const applyMode = React.useCallback((modeId) => {
    const mode = QUOTE_MODES.find(m => m.id === modeId);
    if (!mode || !activeQuoteId) return;

    // 確保 defaultItems 中的每個 item 都有唯一的 id
    const itemsWithIds = mode.defaultItems.map(item => ({...item, id: uuid(), subItems: []}));

    updateQuote(activeQuoteId, {
      title: mode.name,
      items: itemsWithIds, // 使用帶有 ID 的項目
      notes: mode.defaultNotes,
      payment: mode.defaultPayment,
    });
  }, [activeQuoteId, updateQuote]);


  // Context 提供給全 App
  const activeQuote = quotes.find(q => q.id === activeQuoteId);
  
  const value = {
    company,
    setCompany,

    quotes,
    createQuote,
    deleteQuote,
    updateQuote,
    activeQuote, // 直接提供當前報價單物件
    activeQuoteId,
    setActiveQuoteId,

    specItems,
    applyMode
  };

  // 讓列印和 Excel 匯出功能可以全域抓到 Context
  window.__APP_CONTEXT__ = value;

  return (
    <AppContext.Provider value={value}>
      {children}
    </AppContext.Provider>
  );
}
// P4-1 — 左側元件：公司切換 / 模式選擇 / 報價單列表


// --------------------------------------------------
// 公司切換（何鑫 / 薪昌）
// --------------------------------------------------
function CompanySelector() {
  const { company, setCompany } = React.useContext(AppContext);

  return (
    <div className="mb-6 no-print">
      <div className="font-bold mb-2">選擇公司</div>

      <div className="flex gap-2">
        <button
          className={`px-3 py-1 rounded ${
            company === "herhsin"
              ? "bg-blue-600 text-white"
              : "bg-gray-300 hover:bg-gray-400"
          }`}
          onClick={() => setCompany("herhsin")}
        >
          何鑫實業
        </button>

        <button
          className={`px-3 py-1 rounded ${
            company === "sinchang"
              ? "bg-blue-600 text-white"
              : "bg-gray-300 hover:bg-gray-400"
          }`}
          onClick={() => setCompany("sinchang")}
        >
          薪昌有限公司
        </button>
      </div>
    </div>
  );
}


// --------------------------------------------------
// 報價模式選擇器（A 維修、B 搶修、C 拌合機漏漿…）
// --------------------------------------------------
function ModeSelector() {
  const { createQuote } = React.useContext(AppContext);

  return (
    <div className="mb-6 no-print">
      <div className="font-bold mb-2">建立報價單（套用模式）</div>

      <div className="flex flex-col gap-2">

        {QUOTE_MODES.map(mode => (
          <button
            key={mode.id}
            className="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-left"
            onClick={() => createQuote(mode.id)}
          >
            ➤ {mode.name}
          </button>
        ))}

        {/* 無模式：空白報價單 */}
        <button
          className="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700"
          onClick={() => createQuote(null)}
        >
          ＋ 空白報價單
        </button>
      </div>
    </div>
  );
}


// --------------------------------------------------
// 報價單管理：列表、切換、刪除 (修正版)
// --------------------------------------------------
function QuoteManager() {
  const {
    quotes,
    activeQuoteId,
    setActiveQuoteId,
    deleteQuote,
    createQuote, // 使用 createQuote 替換 addQuote
  } = React.useContext(AppContext);

  // 根據 ID 排序，讓最新的排在最上面
  const sortedQuotes = React.useMemo(() => {
    // 確保 quotes 是陣列且包含有效的 id
    return [...(quotes || [])].sort((a, b) => {
      if (!a.id || !b.id) return 0;
      // 這裡使用 ID 進行比較 (假設 ID 包含時間信息，或者您需要根據日期字段排序)
      return b.id.localeCompare(a.id); 
    });
  }, [quotes]);


  return (
    <div className="mt-4 border-t pt-4"> 
      <h3 className="font-bold text-lg mb-2 text-gray-700">報價單列表</h3>

      {/* 新增報價單按鈕 (導向建立空白報價單) */}
      <button
        className="w-full px-3 py-2 bg-purple-600 text-white rounded mb-4 hover:bg-purple-700 transition"
        onClick={() => createQuote(null)} // 建立空白報價單
      >
        ＋ 建立新報價單
      </button>

      <div className="max-h-80 overflow-y-auto">
      {sortedQuotes.length === 0 && ( // 使用 sortedQuotes
        <div className="text-gray-500 text-sm text-center">
          尚無資料，請先建立報價單
        </div>
      )}

      <div className="flex flex-col gap-1">
        {sortedQuotes.map(q => ( // 使用 sortedQuotes
          <div
            key={q.id}
            className={`flex items-center justify-between px-3 py-2 rounded cursor-pointer transition
              ${
                q.id === activeQuoteId
                  ? "bg-blue-600 text-white shadow-md"
                  : "bg-gray-100 hover:bg-gray-200 text-gray-800"
              }
            `}
            onClick={() => setActiveQuoteId(q.id)}
          >
            {/* 文字區塊：加入 min-w-0 允許壓縮/截斷 */}
            <div className="flex flex-col flex-1 min-w-0 mr-2"> 
              {/* 標題：確保截斷 */}
              <span className="font-semibold truncate text-sm">{q.title}</span>
              {/* 資訊：較小的字體，允許換行 */}
              <span className="text-xs opacity-80 whitespace-normal">
                {q.date} - {q.customerName || "無客戶"}
              </span>
            </div>

            {/* 按鈕區塊：加入 flex-shrink-0 確保寬度固定，不擠壓文字 */}
            <button
              className={`text-red-600 text-xs ml-2 p-1 font-bold transition flex-shrink-0 
              ${q.id === activeQuoteId ? "bg-red-500 hover:bg-red-600 text-white" : "hover:text-red-800"}
              `}
              onClick={(e) => {
                e.stopPropagation(); // 避免點到父層
                if (confirm("確定要刪除這份報價單？")) {
                  deleteQuote(q.id);
                }
              }}
            >
              刪除
            </button>
          </div>
        ))}
      </div>
      </div>
    </div>
  );
}
// P4-2 — 報價單抬頭：公司資訊 + 客戶資訊輸入區
function QuoteEditor() {
  const {
    company,
    activeQuote, // 直接取用 activeQuote
    updateQuote
  } = React.useContext(AppContext);

  const quote = activeQuote;

  // -------------------------------
  // 更新欄位 (Hooks 必須放在頂層)
  // -------------------------------
  const update = React.useCallback((field, value) => {
    // 確保 quote 存在再呼叫 updateQuote
    if (quote) {
      updateQuote(quote.id, { [field]: value });
    }
  }, [quote, updateQuote]); // 依賴項改為 quote 物件

  // 如果 quote 不存在，提早返回 (放在所有 Hooks 之後)
  if (!quote) return null;

  // 引用 P1 的全局數據
  const info = COMPANY_DATA[company];

  return (
    <div className="bg-white p-6 shadow rounded mb-6 no-print">

      {/* ---------------- 公司名稱 ---------------- */}
      <div className="text-2xl font-bold mb-4 text-blue-800">
        {info.name}
      </div>

      {/* ---------------- 公司資料 ---------------- */}
      <div className="text-sm text-gray-600 mb-6 border-b pb-4">
        <div>地址：{info.address}</div>
        <div>電話：{info.tel} | 傳真：{info.fax}</div>
      </div>

      {/* ---------------- 報價單標題 & 編號 ---------------- */}
      <div className="flex items-end gap-4 mb-6">
        <div className="flex-1">
          <label className="block text-sm text-gray-600 mb-1">工程名稱</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            value={quote.title || ""}
            onChange={(e) => update("title", e.target.value)}
          />
        </div>

        <div className="w-48">
          <label className="block text-sm text-gray-600 mb-1">報價單編號</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 bg-gray-100"
            value={quote.quoteNo || ""}
            readOnly
          />
        </div>
      </div>

      {/* ---------------- 客戶資訊 ---------------- */}
      <div className="grid grid-cols-2 gap-4 mb-6">

        <div>
          <label className="block text-sm text-gray-600 mb-1">客戶名稱</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            value={quote.customerName || ""}
            onChange={(e) => update("customerName", e.target.value)}
          />
        </div>

        <div>
          <label className="block text-sm text-gray-600 mb-1">聯絡人</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            value={quote.contact || ""}
            onChange={(e) => update("contact", e.target.value)}
          />
        </div>

        <div>
          <label className="block text-sm text-gray-600 mb-1">電話</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            value={quote.phone || ""}
            onChange={(e) => update("phone", e.target.value)}
          />
        </div>

        <div>
          <label className="block text-sm text-gray-600 mb-1">報價日期</label>
          <input
            type="date"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            // date 欄位使用 yyyy-mm-dd 格式
            value={quote.date || formatDate()}
            onChange={(e) => update("date", e.target.value)}
          />
        </div>

        <div className="col-span-2">
          <label className="block text-sm text-gray-600 mb-1">工程地點</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            value={quote.location || ""}
            onChange={(e) => update("location", e.target.value)}
          />
        </div>
      </div>
    </div>
  );
}
// P4-3（A）NoteSubItemBlock — 補充文字 (修復位置)
function NoteSubItemBlock({ sub, updateField, deleteSubItem }) {
  return (
    <div className="border rounded p-3 bg-gray-50 mb-2">
      {/* 標題 + 刪除 */}
      <div className="flex justify-between items-center mb-2">
        <span className="text-sm font-bold text-gray-700">📄 補充文字</span>
        <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>
          刪除
        </button>
      </div>

      <textarea
        className="w-full border rounded p-2 text-sm focus:ring focus:ring-yellow-100"
        rows="2"
        value={sub.text || ""}
        onChange={(e) => updateField("text", e.target.value)}
        placeholder="輸入補充說明…"
      />
    </div>
  );
}


// P4-3（B）ItemSubItemBlock — 子項目（含數量/單價）
function ItemSubItemBlock({ sub, updateField, deleteSubItem }) {
  // 計算並格式化小計
  const subtotal = formatMoney(calcAmount(sub));

  // 處理數字輸入 (Hooks 必須放在頂層)
  const handleNumberChange = React.useCallback((field, value) => {
    // 只允許數字或空字串
    if (value === "" || !isNaN(Number(value))) {
      updateField(field, value);
    }
  }, [updateField]);

  return (
    <div className="border rounded p-3 bg-gray-50 mb-2">

      {/* 標題 + 刪除 */}
      <div className="flex justify-between items-center mb-2">
        <span className="text-sm font-bold text-gray-700">📦 子項目</span>
        <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>
          刪除
        </button>
        
      </div>

      <div className="grid grid-cols-12 gap-2 text-sm items-center">

        {/* 名稱 */}
        <input
          className="border p-1 rounded col-span-3 focus:ring focus:ring-blue-100"
          value={sub.name || ""}
          placeholder="名稱"
          onChange={(e) => updateField("name", e.target.value)}
        />

        {/* 規格 */}
        <input
          className="border p-1 rounded col-span-4 focus:ring focus:ring-blue-100"
          value={sub.spec || ""}
          placeholder="規格"
          onChange={(e) => updateField("spec", e.target.value)}
        />

        {/* 單位 */}
        <input
          className="border p-1 rounded col-span-1 text-center focus:ring focus:ring-blue-100"
          value={sub.unit || ""}
          placeholder="單位"
          onChange={(e) => updateField("unit", e.target.value)}
        />

        {/* 數量 */}
        <input
          className="border p-1 rounded col-span-1 text-right focus:ring focus:ring-blue-100"
          value={sub.qty || ""}
          placeholder="數量"
          type="number"
          min="0"
          onChange={(e) => handleNumberChange("qty", e.target.value)}
        />

        {/* 單價 */}
        <input
          className="border p-1 rounded col-span-2 text-right focus:ring focus:ring-blue-100"
          value={sub.price || ""}
          placeholder="單價"
          type="number"
          min="0"
          onChange={(e) => handleNumberChange("price", e.target.value)}
        />

        {/* 小計 */}
        <div className="col-span-1 text-right font-bold text-blue-600">
          {subtotal}
        </div>
      </div>
    </div>
  );
}


// P4-3（C）ImageSubItemBlock — 圖片小項
function ImageSubItemBlock({ sub, updateField, deleteSubItem }) {
  // 圖片上傳處理 (不是 Hook，不需要提升)
  function handleUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => updateField("src", reader.result);
    reader.readAsDataURL(file);
    e.target.value = ''; // 清空檔案輸入，以便重新選擇同一檔案
  }

  return (
    <div className="border rounded p-3 bg-gray-50 mb-2">

      <div className="flex justify-between items-center mb-2">
        <span className="text-sm font-bold text-gray-700">📷 圖片補充</span>
        <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>刪除</button>
      </div>

      {/*圖片預覽*/}
      {sub.src ? (
        <img src={sub.src} className="max-w-xs mb-2 border rounded shadow" alt="預覽圖" />
      ) : (
        <div className="text-gray-500 text-sm mb-2 p-2 border border-dashed rounded bg-white">尚未上傳圖片</div>
      )}

      {/* 上傳按鈕 */}
      <label className="cursor-pointer text-blue-700 underline text-sm hover:text-blue-900">
        {sub.src ? "更換圖片" : "上傳圖片"}
        <input type="file" accept="image/*" className="hidden" onChange={handleUpload} />
      </label>
    </div>
  );
}


// P4-3（D）UploadImageButton — 在底部新增圖片用
function UploadImageButton({ onUpload }) {
  // 圖片上傳處理 (不是 Hook，不需要提升)
  function handleSelect(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => onUpload(reader.result);
    reader.readAsDataURL(file);
    e.target.value = ''; // 清空檔案輸入，以便重新選擇同一檔案
  }

  return (
    <label className="cursor-pointer text-blue-600 hover:text-blue-800 transition">
      ＋補充圖片
      <input type="file" accept="image/*" className="hidden" onChange={handleSelect} />
    </label>
  );
}


// P4-3（E）SubItemWrapper — 自動分流小項類型
function SubItemWrapper({ subItem, parentItem, quote, updateQuote }) {

  // 更新某個 subItem 的特定欄位 (Hooks 必須放在頂層)
  const updateField = React.useCallback((field, value) => {
    const newItems = quote.items.map(m =>
      m.id === parentItem.id
        ? {
          ...m,
          // 確保 subItems 存在
          subItems: (m.subItems || []).map(s =>
            s.id === subItem.id ? { ...s, [field]: value } : s
          )
        }
        : m
    );
    updateQuote(quote.id, { items: newItems });
  }, [quote.id, parentItem.id, subItem.id, quote.items, updateQuote]);

  // 刪除 subItem (Hooks 必須放在頂層)
  const deleteSubItem = React.useCallback(() => {
    const newItems = quote.items.map(m =>
      m.id === parentItem.id
        ? { ...m, subItems: (m.subItems || []).filter(s => s.id !== subItem.id) }
        : m
    );
    updateQuote(quote.id, { items: newItems });
  }, [quote.id, parentItem.id, subItem.id, quote.items, updateQuote]);

  const props = { sub: subItem, updateField, deleteSubItem };

  if (subItem.type === "note") return <NoteSubItemBlock {...props} />;
  if (subItem.type === "item") return <ItemSubItemBlock {...props} />;
  if (subItem.type === "image") return <ImageSubItemBlock {...props} />;

  return null;
}


// P4-3（F）MainItemBlock — 大項編輯 (修正版，包含標題和 bug 修正)
function MainItemBlock({ item, quote, updateQuote }) {

  // 1. 更新大項資料 (Hooks 必須放在頂層)
  const update = React.useCallback((data) => {
    // 確保只更新當前項目
    const newItems = quote.items.map(m =>
      m.id === item.id ? { ...m, ...data } : m
    );
    updateQuote(quote.id, { items: newItems });
  }, [quote.id, item.id, quote.items, updateQuote]);

  // 2. 處理數字輸入 (Hooks 必須放在頂層)
  const handleNumberChange = React.useCallback((field, value) => {
    // 允許空字串或數字
    if (value === "" || !isNaN(Number(value))) {
      // 確保將變更傳遞給 update
      update({ [field]: value });
    }
  }, [update]); // <--- 確保依賴項是 update 

  // 3. 刪除大項 (Hooks 必須放在頂層)
  const deleteMain = React.useCallback(() => {
    if (!confirm("確定要刪除此大項？")) return;
    updateQuote(quote.id, { items: quote.items.filter(m => m.id !== item.id) });
  }, [quote.id, item.id, quote.items, updateQuote]);

  // 4. 新增小項 (Hooks 必須放在頂層)
  const addSub = React.useCallback((type, src = "") => {
    const newSub = {
      id: uuid(),
      type,
      text: "",
      name: "",
      spec: "",
      unit: "",
      qty: "",
      price: "",
      src
    };

    const newItems = quote.items.map(m =>
      m.id === item.id ? { ...m, subItems: [...(m.subItems || []), newSub] } : m
    );

    updateQuote(quote.id, { items: newItems });
  }, [quote.id, item.id, quote.items, updateQuote]);

  // 計算並格式化小計 (不是 Hook，放在 Hook 之後)
  const mainTotal = formatMoney(calcAmount(item));

  return (
    <div className="border rounded p-4 bg-white shadow mb-4">

      {/* VVVV 標題行：新增標籤 VVVV */}
      <div className="grid grid-cols-12 gap-2 text-sm font-bold text-gray-600 mb-2 border-b pb-1">
          <div className="col-span-3">品名</div>
          <div className="col-span-3">規格</div>
          <div className="col-span-1 text-center">單位</div>
          <div className="col-span-1 text-right">數量</div>
          <div className="col-span-2 text-right">單價</div>
          <div className="col-span-1 text-right">小計</div>
          <div className="col-span-1"></div> {/* 刪除按鈕欄位 */}
      </div>

      {/* 大項資料列 */}
      <div className="grid grid-cols-12 gap-2 items-center">
        {/* 品名 */}
        <input className="border p-1 rounded col-span-3 focus:ring focus:ring-red-100"
          value={item.name || ""} placeholder="品名"
          onChange={(e) => update({ name: e.target.value })} />
        {/* 規格 */}
        <input className="border p-1 rounded col-span-3 focus:ring focus:ring-red-100"
          value={item.spec || ""} placeholder="規格"
          onChange={(e) => update({ spec: e.target.value })} />
        {/* 單位 */}
        <input className="border p-1 rounded col-span-1 text-center focus:ring focus:ring-red-100"
          value={item.unit || ""} placeholder="單位"
          onChange={(e) => update({ unit: e.target.value })} />
        {/* 數量 */}
        <input className="border p-1 rounded col-span-1 text-right focus:ring focus:ring-red-100"
          value={item.qty || ""} placeholder="數量"
          type="number" min="0"
          onChange={(e) => handleNumberChange("qty", e.target.value)} />
        {/* 單價 */}
        <input className="border p-1 rounded col-span-2 text-right focus:ring focus:ring-red-100"
          value={item.price || ""} placeholder="單價"
          type="number" min="0"
          onChange={(e) => handleNumberChange("price", e.target.value)} />

        {/* 小計 */}
        <div className="text-right font-bold col-span-1 text-red-700">
          {mainTotal}
        </div>
        {/* 刪除按鈕 */}
        <button className="text-red-600 col-span-1 text-sm hover:text-red-800" onClick={deleteMain}>
          ✕
        </button>
      </div>

      {/* 小項列表 */}
      <div className="mt-3 border-t pt-3">
        {(item.subItems || []).map(sub => ( // 確保 subItems 存在
          <SubItemWrapper
            key={sub.id} 
            subItem={sub}
            parentItem={item}
            quote={quote}
            updateQuote={updateQuote}
          />
        ))}
      </div>

      {/* 操作列 */}
      <div className="flex gap-4 mt-3 text-blue-600 text-sm border-t pt-3">
        <button className="hover:text-blue-800 transition" onClick={() => addSub("item")}>＋ 子項目</button>
        <button className="hover:text-blue-800 transition" onClick={() => addSub("note")}>＋ 補充文字</button>
        <UploadImageButton onUpload={(src) => addSub("image", src)} />
      </div>
    </div>
  );
}
// P4-3（G）ItemsEditor — 整體品項管理
function ItemsEditor({ quote, updateQuote }) {
  // 1. 新增大項 (Hooks 必須放在頂層)
  const addMain = React.useCallback(() => {
    const newMain = {
      id: uuid(),
      type: "main",
      name: "未命名大項",
      spec: "",
      unit: "",
      qty: "",
      price: "",
      subItems: []
    };
    updateQuote(quote.id, { items: [...(quote.items || []), newMain] });
  }, [quote.id, quote.items, updateQuote]);

  return (
    <div className="mb-6 no-print">
      <h2 className="font-bold text-lg mb-2">報價項目列表</h2>
      
      <button
        className="px-4 py-2 bg-blue-600 text-white rounded mb-4 hover:bg-blue-700 transition"
        onClick={addMain}
      >
        ＋ 新增工程大項
      </button>
      
      {/* 渲染所有大項 */}
      {(quote.items || []).map(item => (
        <MainItemBlock
          key={item.id}
          item={item}
          quote={quote}
          updateQuote={updateQuote}
        />
      ))}

      {quote.items.length === 0 && (
        <div className="text-gray-500 text-sm text-center p-4 border border-dashed rounded">
          點擊上方按鈕開始新增報價項目
        </div>
      )}
    </div>
  );
}

// P5-1 — NotesEditor（備註說明）
function NotesEditor({ quote, update }) {
  return (
    <div className="bg-white p-4 shadow rounded h-full flex flex-col">
      <h3 className="font-bold mb-2">備註說明 (不含稅)</h3>
      <textarea
        className="w-full border rounded p-2 text-sm flex-1"
        rows="10"
        value={quote.notes || ""}
        onChange={(e) => update("notes", e.target.value)}
        placeholder="輸入備註說明..."
      />
    </div>
  );
}

// P5-2 — PaymentEditor（付款條件）
function PaymentEditor({ quote, update }) {
  return (
    <div className="bg-white p-4 shadow rounded h-full flex flex-col">
      <h3 className="font-bold mb-2">付款條件 (未含稅)</h3>
      <textarea
        className="w-full border rounded p-2 text-sm flex-1"
        rows="10"
        value={quote.payment || ""}
        onChange={(e) => update("payment", e.target.value)}
        placeholder="輸入付款條件..."
      />
    </div>
  );
}

// P5-3 — PriceSummary（總價摘要）
function PriceSummary({ quote, update }) {
  // 計算總金額
  const total = calcTotal(quote.items || []);
  // 計算議定後價格
  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

  // 處理數字輸入 (Hooks 必須放在頂層)
  const handleNumberChange = React.useCallback((field, value) => {
    if (value === "" || !isNaN(Number(value))) {
      update(field, value);
    }
  }, [update]);

  return (
    <div className="bg-white p-4 shadow rounded">
      <h3 className="font-bold mb-3">總價摘要</h3>

      {/* 總額 (未稅) */}
      <div className="flex justify-between items-center mb-2 p-2 border-b">
        <span className="text-gray-600">總金額 (未稅)</span>
        <span className="font-bold text-lg text-green-700">
          {formatMoney(total)}
        </span>
      </div>

      {/* 折扣百分比 */}
      <div className="flex items-center mb-2">
        <label className="text-gray-600 w-24">折扣 (%)</label>
        <input
          type="number"
          className="w-20 border rounded px-2 py-1 text-right focus:ring-2 focus:ring-blue-300"
          min="0"
          max="100"
          value={quote.discountPercent || ""}
          onChange={(e) => handleNumberChange("discountPercent", e.target.value)}
        />
        <span className="ml-2 text-sm text-gray-500"> (輸入 10 即打九折)</span>
      </div>
      
      {/* 議定價格 (可覆蓋折扣) */}
      <div className="flex items-center mb-4">
        <label className="text-gray-600 w-24">議定價格</label>
        <input
          type="number"
          className="flex-1 border rounded px-2 py-1 text-right focus:ring-2 focus:ring-blue-300"
          min="0"
          value={quote.negotiatedPrice || ""}
          onChange={(e) => handleNumberChange("negotiatedPrice", e.target.value)}
        />
      </div>

      {/* 最終價格 (未稅) */}
      <div className="flex justify-between items-center p-3 rounded bg-blue-50 border border-blue-200">
        <span className="text-blue-800 font-semibold">最終報價 (未稅)</span>
        <span className="font-extrabold text-xl text-blue-800">
          {formatMoney(negotiated)}
        </span>
      </div>
    </div>
  );
}


// P6 — App（主要佈局）
function App() {
  const { activeQuote, updateQuote, activeQuoteId } = React.useContext(AppContext);

  // 如果沒有報價單，顯示提示
  if (!activeQuoteId) {
    return (
      <div className="flex p-8 max-w-7xl mx-auto">
        <div className="w-72 pr-6">
          <CompanySelector />
          <ModeSelector />
          <QuoteManager />
        </div>
        <div className="flex-1 bg-white p-6 shadow rounded text-center text-gray-500">
          請先在左側建立或選擇一份報價單。
        </div>
      </div>
    );
  }

  return (
    <div className="flex p-8 max-w-7xl mx-auto min-h-screen">
      
      {/* 1. 左側欄：報價單管理 (寬度已增加) */}
      <div className="w-80 pr-8 no-print flex-shrink-0">
        <CompanySelector />
        <ModeSelector />
        <QuoteManager />
      </div>

      {/* 2. 右側欄：編輯區 */}
      <div className="flex-1">
        <QuoteEditor />
        <ItemsEditor quote={activeQuote} updateQuote={updateQuote} />

        {/* 備註/付款/總價 - 修正為由上往下堆疊 */}
        <div className="flex flex-col gap-6 no-print">
          <div className="flex-1">
            <NotesEditor quote={activeQuote} update={updateQuote} />
          </div>
          <div className="flex-1">
            <PaymentEditor quote={activeQuote} update={updateQuote} />
          </div>
          <div className="flex-1">
            <PriceSummary quote={activeQuote} update={updateQuote} />
          </div>
        </div>
      </div>
    </div>
  );
}

// P7 — Root Render
ReactDOM.createRoot(document.getElementById("root")).render(
  <AppProvider>
    <App />
  </AppProvider>
);
</script>

</body>
</html>
