<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰- æœ€çµ‚æ•´åˆç‰ˆ</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- ReactDOMServerï¼ˆPDF/åˆ—å°ç”¨ï¼‰-->
    <script src="https://unpkg.com/react-dom@18/umd/react-dom-server.browser.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- XLSX for Excel exportï¼ˆå¦‚æœªä½¿ç”¨å¯ç§»é™¤ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- FileSaverï¼ˆPDF ä¸‹è¼‰ç”¨ï¼‰-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- html2canvasï¼ˆPDF æˆªåœ–ç”¨ï¼‰-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body {
        font-family: "Microsoft JhengHei", sans-serif;
        background: #f4f4f4;
    }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
/***************************************************
 * D1 â€” å…¨åŸŸå·¥å…·å‡½å¼ï¼ˆuuid, formatMoney, calcAmountï¼‰
 ***************************************************/
function uuid() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}

function formatMoney(num) {
    if (!num || isNaN(num)) return "0";
    return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 });
}

function calcAmount(item) {
    return Number(item.qty || 0) * Number(item.price || 0);
}

function calcTotal(items) {
    let sum = 0;
    items.forEach(i => {
        sum += calcAmount(i);
        if (i.subItems) {
            i.subItems.forEach(s => {
                if (s.type === "item") sum += calcAmount(s);
            });
        }
    });
    return sum;
}

function calcNegotiated(total, percent, customPrice) {
    if (Number(customPrice) > 0) return Number(customPrice);
    if (percent > 0) return Math.round(total * (1 - percent / 100));
    return total;
}

/***************************************************
 * D2 â€” AppContextï¼ˆå…¬å¸è³‡æ–™ / å ±åƒ¹å–®è³‡æ–™ä¸­å¿ƒï¼‰
 ***************************************************/
const AppContext = React.createContext();

/* å…¬å¸è³‡æ–™ï¼ˆå«å°ç« ï¼‰ */
const COMPANY_DATA = {
    herhsin: {
        name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
        tel: "07-6521927",
        fax: "07-6517994",
        email: "affairs@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "https://amy262631-ui.github.io/Quotation/herhsin_stamp.JPG",
        prefix: "QH"
    },
    sinchang: {
        name: "è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸",
        tel: "07-6521927",
        fax: "07-6517994",
        email: "affairs@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "https://amy262631-ui.github.io/Quotation/sinchang_stamp.JPG",
        prefix: "QS"
    }
};

/* é è¨­å‚™è¨» */
const DEFAULT_NOTES = `1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚`;

/* é è¨­ä»˜æ¬¾æ¢ä»¶ */
const DEFAULT_PAYMENT = `è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%`;
/* å ±åƒ¹å–®ç·¨è™Ÿç”¢ç”Ÿå™¨ï¼ˆcreateQuote ç”¨ï¼‰ */
function generateQuoteNo(companyKey) {
    const prefix = COMPANY_DATA[companyKey]?.prefix || "Q";

    const d = new Date();
    const datePart =
        d.getFullYear().toString() +
        String(d.getMonth() + 1).padStart(2, "0") +
        String(d.getDate()).padStart(2, "0") +
        String(d.getHours()).padStart(2, "0") +
        String(d.getMinutes()).padStart(2, "0");

    const random = Math.floor(1000 + Math.random() * 9000);

    return `${prefix}${datePart}-${random}`;
}    
/***************************************************
 * D2 â€” AppProviderï¼ˆå®Œæ•´ç‹€æ…‹ç®¡ç†ï¼šquotes + å…¬å¸åˆ‡æ› + specItemsï¼‰
 ***************************************************/
function AppProvider({ children }) {

    const [company, setCompany] = React.useState("herhsin");
    const [quotes, setQuotes] = React.useState([]);
    const [activeQuoteId, setActiveQuoteId] = React.useState(null);

    /* Google Sheet ææ–™ï¼ˆAutocomplete ç”¨ï¼‰ */
    const [specItems, setSpecItems] = React.useState([]);

    const SPEC_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv";

    /***************************************************
     * è¼‰å…¥ localStorage
     ***************************************************/
    React.useEffect(() => {
        const saved = localStorage.getItem("HERHSIN_QUOTES");
        if (saved) {
            try {
                const arr = JSON.parse(saved);
                if (Array.isArray(arr)) {
                    setQuotes(arr);
                    if (arr.length > 0) setActiveQuoteId(arr[0].id);
                }
            } catch (err) {
                console.error("localStorage load error:", err);
            }
        }
    }, []);

    /***************************************************
     * è‡ªå‹•å­˜å› localStorage
     ***************************************************/
    React.useEffect(() => {
        localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
    }, [quotes]);

    /***************************************************
     * è¼‰å…¥ Google Sheetï¼ˆè¦æ ¼å“è³‡æ–™ â†’ specItemsï¼‰
     ***************************************************/
    React.useEffect(() => {
        async function loadSpec() {
            try {
                const res = await fetch(SPEC_URL);
                const text = await res.text();

                const rows = text.split("\n").map(r => r.trim()).filter(r => r.length);
                const header = rows[0].split(",");

                const list = rows.slice(1).map(row => {
                    const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                    const obj = {};
                    header.forEach((h, i) => {
                        let val = cols[i] || "";
                        val = val.replace(/^"|"$/g, "");
                        obj[h.trim()] = val.trim();
                    });
                    return obj;
                });

                console.log("ğŸ“Œ è¦æ ¼å“å·²è¼‰å…¥ï¼š", list);

                setSpecItems(list);
            } catch (err) {
                console.error("Google Sheet è¼‰å…¥éŒ¯èª¤ï¼š", err);
            }
        }

        loadSpec();
    }, []);

    /***************************************************
     * æ–°å¢å ±åƒ¹å–®
     ***************************************************/
    const createQuote = () => {
        const newQuote = {
            id: uuid(),
            company,
            quoteNo: generateQuoteNo(company),
            title: "æœªå‘½åå·¥ç¨‹",
            customerName: "",
            contact: "",
            phone: "",
            location: "",
            date: new Date().toISOString().substring(0, 10),
            items: [],
            notes: DEFAULT_NOTES,
            payment: DEFAULT_PAYMENT,
            discountPercent: 0,
            negotiatedPrice: 0
        };

        setQuotes(prev => [newQuote, ...prev]);
        setActiveQuoteId(newQuote.id);
    };

    /***************************************************
     * åˆªé™¤å ±åƒ¹å–®
     ***************************************************/
    const deleteQuote = (id) => {
        const newList = quotes.filter(q => q.id !== id);
        setQuotes(newList);

        if (activeQuoteId === id) {
            setActiveQuoteId(newList.length ? newList[0].id : null);
        }
    };

    /***************************************************
     * æ›´æ–°å ±åƒ¹å–®
     ***************************************************/
    const updateQuote = (id, update) => {
        setQuotes(prev =>
            prev.map(q => (q.id === id ? { ...q, ...update } : q))
        );
    };

    const activeQuote = quotes.find(q => q.id === activeQuoteId) || null;

    return (
        <AppContext.Provider
            value={{
                company,
                setCompany,
                quotes,
                activeQuote,
                activeQuoteId,
                setActiveQuoteId,
                createQuote,
                deleteQuote,
                updateQuote,
                specItems
            }}
        >
            {children}
        </AppContext.Provider>
    );
}

/***************************************************
 * D3 â€” å·¦å´ UIï¼šå…¬å¸åˆ‡æ› + å ±åƒ¹å–®åˆ—è¡¨
 ***************************************************/

/* â‘  å…¬å¸åˆ‡æ› */
function CompanySelector() {
    const { company, setCompany } = React.useContext(AppContext);

    return (
        <div className="mb-6 bg-white p-3 rounded shadow">
            <h3 className="text-sm font-bold mb-2">é¸æ“‡å…¬å¸ï¼ˆç·¨ç¢¼ï¼‹å°ç« ï¼‰</h3>

            <select
                className="w-full border rounded p-2"
                value={company}
                onChange={(e) => setCompany(e.target.value)}
            >
                <option value="herhsin">ä½•é‘«å¯¦æ¥­</option>
                <option value="sinchang">è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸</option>
            </select>
        </div>
    );
}

/***************************************************
 * â‘¡ å ±åƒ¹å–®åˆ—è¡¨
 ***************************************************/
function QuoteList() {
    const {
        quotes,
        activeQuoteId,
        setActiveQuoteId,
        deleteQuote,
        createQuote,
    } = React.useContext(AppContext);

    return (
        <div className="bg-white p-3 rounded shadow">
            <div className="flex justify-between items-center mb-3">
                <h3 className="text-sm font-bold">å ±åƒ¹å–®åˆ—è¡¨</h3>

                <button
                    className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700"
                    onClick={createQuote}
                >
                    ï¼‹ æ–°å¢
                </button>
            </div>

            <div className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                {quotes.length === 0 && (
                    <div className="text-xs text-gray-500 text-center py-4">
                        å°šç„¡å ±åƒ¹å–®ï¼Œè«‹æ–°å¢ã€‚
                    </div>
                )}

                {quotes.map((q) => (
                    <div
                        key={q.id}
                        className={`p-2 rounded border cursor-pointer ${
                            q.id === activeQuoteId
                                ? "bg-blue-100 border-blue-500"
                                : "bg-gray-50 hover:bg-gray-100"
                        }`}
                        onClick={() => setActiveQuoteId(q.id)}
                    >
                        <div className="flex justify-between items-center">
                            <div>
                                <div className="font-bold text-sm">{q.title}</div>
                                <div className="text-xs text-gray-500">{q.quoteNo}</div>
                                <div className="text-xs text-gray-500">{q.date}</div>
                            </div>

                            <button
                                className="text-red-600 text-xs hover:underline"
                                onClick={(e) => {
                                    e.stopPropagation();
                                    if (confirm("ç¢ºå®šåˆªé™¤æ­¤å ±åƒ¹å–®ï¼Ÿ")) {
                                        deleteQuote(q.id);
                                    }
                                }}
                            >
                                åˆªé™¤
                            </button>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
}
/***************************************************
 * D4 â€” Autocompleteï¼ˆä½¿ç”¨ specItemsï¼‰
 ***************************************************/
function Autocomplete({ value, onChange, onSelect, list }) {
    const [show, setShow] = React.useState(false);

    return (
        <div className="relative">
            <input
                value={value}
                onChange={(e) => {
                    onChange(e.target.value);
                    setShow(true);
                }}
                placeholder="è¼¸å…¥å“åé—œéµå­—â€¦"
                className="border p-2 rounded w-full"
            />

            {show && list.length > 0 && (
                <div className="absolute bg-white border rounded w-full max-h-48 overflow-y-auto z-50">
                    {list.map((row, idx) => (
                        <div
                            key={idx}
                            className="p-2 hover:bg-blue-100 cursor-pointer text-sm"
                            onClick={() => {
                                onSelect(row);
                                setShow(false);
                            }}
                        >
                            <div className="font-bold">{row["åç¨±"] || row["å“å"]}</div>
                            <div className="text-gray-500 text-xs">{row["è¦æ ¼"]}</div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

/***************************************************
 * æœå°‹ææ–™ï¼ˆä¾å“åæ¨¡ç³Šæœå°‹ï¼‰
 ***************************************************/
function searchSpecItems(keyword, specItems) {
    if (!keyword) return [];
    const key = keyword.trim();
    return specItems.filter(row =>
        (row["åç¨±"] || row["å“å"] || "").includes(key)
    );
}
/***************************************************
 * D8 â€” QuoteItemï¼ˆæœ€çµ‚ä¿ç•™ç‰ˆæœ¬ï¼‰
 ***************************************************/
function QuoteItem({ item, index, updateItem, deleteItem }) {

    const { specItems } = React.useContext(AppContext);

    const [nameInput, setNameInput] = React.useState(item.name || "");
    const [showList, setShowList] = React.useState(false);

    /* éæ¿¾å‡ºç¬¦åˆçš„ææ–™ */
    const matchList = React.useMemo(() => {
        return searchSpecItems(nameInput, specItems);
    }, [nameInput, specItems]);

    /* é¸æ“‡ autocomplete ææ–™ â†’ è‡ªå‹•å¸¶å…¥æ‰€æœ‰æ¬„ä½ */
    const selectSpec = (row) => {
        updateItem(item.id, {
            name: row["åç¨±"] || row["å“å"] || "",
            specMain: row["è¦æ ¼"] || "",
            unit: row["å–®ä½"] || "",
            price: Number(row["å”®åƒ¹"] || row["å–®åƒ¹"] || 0),
            specMaterial: row["ç”¨æ–™1"] || "",
            specMaterial2: row["ç”¨æ–™2"] || "",
            specMaterial3: row["ç”¨æ–™3"] || "",
        });

        setNameInput(row["åç¨±"] || row["å“å"] || "");
        setShowList(false);
    };

    /* æ–°å¢å­é … */
    const addSubItem = (type) => {
        const newSub = {
            id: uuid(),
            type,
            text: "",
            url: "",
        };

        updateItem(item.id, {
            subItems: [...(item.subItems || []), newSub]
        });
    };

    /* æ›´æ–°å­é … */
    const updateSubItem = (subId, value) => {
        const newList = (item.subItems || []).map(s =>
            s.id === subId ? { ...s, ...value } : s
        );

        updateItem(item.id, { subItems: newList });
    };

    /* åˆªé™¤å­é … */
    const deleteSubItem = (subId) => {
        const list = (item.subItems || []).filter(s => s.id !== subId);
        updateItem(item.id, { subItems: list });
    };

    return (
        <div className="p-4 bg-white rounded shadow border mb-4">

            {/* ===== æ¨™é¡Œåˆ— ===== */}
            <div className="flex justify-between items-center mb-3">
                <h3 className="text-lg font-bold">é …ç›® {index}</h3>

                <button
                    className="text-red-600 font-bold"
                    onClick={() => deleteItem(item.id)}
                >
                    âœ• åˆªé™¤æ­¤é …
                </button>
            </div>

            {/* ===== å“å + Autocomplete ===== */}
            <div className="relative mb-3">
                <label className="font-semibold">å“åï¼š</label>

                <input
                    value={nameInput}
                    onChange={(e) => {
                        setNameInput(e.target.value);
                        updateItem(item.id, { name: e.target.value });
                        setShowList(true);
                    }}
                    className="border w-full p-2 rounded"
                    placeholder="è¼¸å…¥å“åé—œéµå­—â€¦"
                />

                {showList && matchList.length > 0 && (
                    <div className="absolute bg-white border rounded w-full max-h-48 overflow-y-auto z-50">
                        {matchList.map((row, idx) => (
                            <div
                                key={idx}
                                className="p-2 hover:bg-blue-100 cursor-pointer"
                                onClick={() => selectSpec(row)}
                            >
                                <div className="font-bold">
                                    {row["åç¨±"] || row["å“å"]}
                                </div>
                                <div className="text-gray-500 text-xs">
                                    {row["è¦æ ¼"]}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>

            {/* ===== è¦æ ¼ ===== */}
            <div className="mb-3">
                <label className="font-semibold">è¦æ ¼ï¼š</label>
                <input
                    className="border p-2 rounded w-full"
                    value={item.specMain}
                    onChange={(e) => updateItem(item.id, { specMain: e.target.value })}
                />
            </div>

            {/* ===== ç”¨æ–™ 1~3 ===== */}
            <div className="grid grid-cols-3 gap-3 mb-4">
                <div>
                    <label className="font-semibold">ç”¨æ–™ 1ï¼š</label>
                    <input
                        className="border p-2 rounded w-full"
                        value={item.specMaterial}
                        onChange={(e) => updateItem(item.id, { specMaterial: e.target.value })}
                    />
                </div>

                <div>
                    <label className="font-semibold">ç”¨æ–™ 2ï¼š</label>
                    <input
                        className="border p-2 rounded w-full"
                        value={item.specMaterial2}
                        onChange={(e) => updateItem(item.id, { specMaterial2: e.target.value })}
                    />
                </div>

                <div>
                    <label className="font-semibold">ç”¨æ–™ 3ï¼š</label>
                    <input
                        className="border p-2 rounded w-full"
                        value={item.specMaterial3}
                        onChange={(e) => updateItem(item.id, { specMaterial3: e.target.value })}
                    />
                </div>
            </div>

            {/* ===== å–®ä½ / æ•¸é‡ / å–®åƒ¹ ===== */}
            <div className="grid grid-cols-3 gap-3 mb-4">
                <div>
                    <label className="font-semibold">å–®ä½ï¼š</label>
                    <input
                        className="border p-2 rounded w-full"
                        value={item.unit}
                        onChange={(e) => updateItem(item.id, { unit: e.target.value })}
                    />
                </div>

                <div>
                    <label className="font-semibold">æ•¸é‡ï¼š</label>
                    <input
                        type="number"
                        className="border p-2 rounded w-full"
                        value={item.qty}
                        onChange={(e) => updateItem(item.id, { qty: Number(e.target.value) })}
                    />
                </div>

                <div>
                    <label className="font-semibold">å–®åƒ¹ï¼š</label>
                    <input
                        type="number"
                        className="border p-2 rounded w-full"
                        value={item.price}
                        onChange={(e) => updateItem(item.id, { price: Number(e.target.value) })}
                    />
                </div>
            </div>

            {/* ===== å‚™è¨» ===== */}
            <div className="mb-4">
                <label className="font-semibold">å‚™è¨»ï¼š</label>
                <textarea
                    className="border p-2 rounded w-full"
                    value={item.remarks}
                    onChange={(e) => updateItem(item.id, { remarks: e.target.value })}
                ></textarea>
            </div>

            {/* ===== å­é …ç›®åˆ—è¡¨ ===== */}
            <div className="space-y-3 mb-4">
                {(item.subItems || []).map((sub) => (
                    <div key={sub.id} className="p-3 border rounded bg-gray-50">

                        {/* è£œå……æ–‡å­— */}
                        {sub.type === "note" && (
                            <>
                                <label className="font-semibold">è£œå……æ–‡å­—ï¼š</label>
                                <textarea
                                    className="border p-2 rounded w-full"
                                    value={sub.text}
                                    onChange={(e) =>
                                        updateSubItem(sub.id, { text: e.target.value })
                                    }
                                ></textarea>
                            </>
                        )}

                        {/* è£œå……åœ–ç‰‡ */}
                        {sub.type === "image" && (
                            <>
                                <label className="font-semibold">è£œå……åœ–ç‰‡ï¼š</label>
                                <input
                                    type="file"
                                    accept="image/*"
                                    onChange={(e) => {
                                        const file = e.target.files[0];
                                        if (file) {
                                            const url = URL.createObjectURL(file);
                                            updateSubItem(sub.id, { url });
                                        }
                                    }}
                                />

                                {sub.url && (
                                    <img
                                        src={sub.url}
                                        className="mt-2 rounded border"
                                        style={{ maxWidth: "260px" }}
                                    />
                                )}
                            </>
                        )}

                        <button
                            className="text-red-600 mt-2"
                            onClick={() => deleteSubItem(sub.id)}
                        >
                            åˆªé™¤å­é …
                        </button>
                    </div>
                ))}
            </div>

            {/* ===== æ–°å¢å­é …æŒ‰éˆ• ===== */}
            <div className="flex gap-3">
                <button
                    className="px-3 py-1 bg-blue-600 text-white rounded"
                    onClick={() => addSubItem("note")}
                >
                    ï¼‹ è£œå……æ–‡å­—
                </button>

                <button
                    className="px-3 py-1 bg-green-600 text-white rounded"
                    onClick={() => addSubItem("image")}
                >
                    ï¼‹ è£œå……åœ–ç‰‡
                </button>
            </div>

            {/* ===== å°è¨ˆ ===== */}
            <div className="text-right font-bold text-blue-700 mt-4">
                å°è¨ˆï¼šNT$ {formatMoney(item.qty * item.price)}
            </div>
        </div>
    );
}
/***************************************************
 * D6 â€” åˆ—å° PrintButtonï¼ˆä½¿ç”¨ ReactDOMServerï¼‰
 ***************************************************/
function PrintButton({ quote }) {

    const handlePrint = () => {
        if (!quote) {
            alert("å°šæœªé¸æ“‡å ±åƒ¹å–®");
            return;
        }

        const html = ReactDOMServer.renderToString(
            <PrintLayout
                quote={quote}
                totalAmount={calcTotal(quote.items)}
                negotiatedAmount={calcNegotiated(
                    calcTotal(quote.items),
                    quote.discountPercent,
                    quote.negotiatedPrice
                )}
            />
        );

        const win = window.open("", "_blank");

        win.document.write(`
            <html>
            <head>
                <title>åˆ—å°å ±åƒ¹å–®</title>
                <style>
                    body { font-family: "Microsoft JhengHei"; padding: 20px; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid black; padding: 6px; }
                    .stamp { width: 160px; }
                </style>
            </head>
            <body>${html}</body>
            </html>
        `);

        win.document.close();
        win.focus();
        win.print();
    };

    return (
        <button
            onClick={handlePrint}
            className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        >
            ğŸ–¨ åˆ—å°å ±åƒ¹å–®
        </button>
    );
}

/***************************************************
 * D6 â€” ç”¢ç”Ÿ PDFï¼ˆä½¿ç”¨ html2canvas + jsPDFï¼‰
 ***************************************************/
function ExportPDFButton({ quote }) {

    const generatePDF = async () => {
        if (!quote) {
            alert("å°šæœªé¸æ“‡å ±åƒ¹å–®");
            return;
        }

        const container = document.createElement("div");

        const html = ReactDOMServer.renderToString(
            <PrintLayout
                quote={quote}
                totalAmount={calcTotal(quote.items)}
                negotiatedAmount={calcNegotiated(
                    calcTotal(quote.items),
                    quote.discountPercent,
                    quote.negotiatedPrice
                )}
            />
        );

        container.innerHTML = html;
        document.body.appendChild(container);

        const canvas = await html2canvas(container, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL("image/png");

        const pdf = new jspdf.jsPDF("p", "mm", "a4");
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

        pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
        pdf.save(`å ±åƒ¹å–®_${quote.quoteNo}.pdf`);

        document.body.removeChild(container);
    };

    return (
        <button
            onClick={generatePDF}
            className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 ml-3"
        >
            ğŸ“„ è½‰ PDF
        </button>
    );
}

/***************************************************
 * D7 â€” PrintLayoutï¼ˆA4 åˆ—å°æ¨¡æ¿ï¼‰
 ***************************************************/
function PrintLayout({ quote, totalAmount, negotiatedAmount }) {
    if (!quote) return null;

    const company = COMPANY_DATA[quote.company] || COMPANY_DATA.herhsin;

    return (
        <div style={{
            width: "760px",
            fontFamily: "Microsoft JhengHei",
            padding: "20px",
            color: "#000"
        }}>

            {/* ===== å…¬å¸æŠ¬é ­ ===== */}
            <h1 style={{ fontSize: "26px", fontWeight: "bold", textAlign: "center" }}>
                {company.name}
            </h1>

            <div style={{ textAlign: "center", marginBottom: "12px" }}>
                é›»è©±ï¼š{company.tel}ã€€åœ°å€ï¼š{company.address}
            </div>

            <h2 style={{
                fontSize: "22px",
                textAlign: "center",
                margin: "15px 0",
                fontWeight: "bold"
            }}>
                å ±ã€€åƒ¹ã€€å–®
            </h2>

            {/* ===== å®¢æˆ¶è³‡æ–™ ===== */}
            <table style={{ width: "100%", marginBottom: "16px" }}>
                <tbody>
                    <tr>
                        <td>å®¢æˆ¶åç¨±ï¼š</td>
                        <td>{quote.customerName}</td>
                        <td>è¯çµ¡äººï¼š</td>
                        <td>{quote.contact}</td>
                    </tr>
                    <tr>
                        <td>é›»è©±ï¼š</td>
                        <td>{quote.phone}</td>
                        <td>å ±åƒ¹æ—¥æœŸï¼š</td>
                        <td>{quote.date}</td>
                    </tr>
                    <tr>
                        <td>å·¥ç¨‹åœ°é»ï¼š</td>
                        <td colSpan="3">{quote.location}</td>
                    </tr>
                    <tr>
                        <td>å ±åƒ¹å–®ç·¨è™Ÿï¼š</td>
                        <td colSpan="3">{quote.quoteNo}</td>
                    </tr>
                </tbody>
            </table>

            {/* ===== å ±åƒ¹æ˜ç´° ===== */}
            <table style={{ width: "100%", borderCollapse: "collapse" }}>
                <thead>
                    <tr>
                        <th style={th}>é …æ¬¡</th>
                        <th style={th}>å“å</th>
                        <th style={th}>è¦æ ¼ / ç”¨æ–™</th>
                        <th style={th}>å–®ä½</th>
                        <th style={th}>æ•¸é‡</th>
                        <th style={th}>å–®åƒ¹</th>
                        <th style={th}>å°è¨ˆ</th>
                    </tr>
                </thead>

                <tbody>
                    {quote.items.map((item, idx) => {
                        const subtotal = item.qty * item.price;

                        return (
                            <React.Fragment key={item.id}>

                                {/* === ä¸»é … === */}
                                <tr>
                                    <td style={tdCenter}>{idx + 1}</td>
                                    <td style={tdLeft}>{item.name}</td>

                                    <td style={tdLeft}>
                                        {item.specMain}

                                        {item.specMaterial && (
                                            <div style={{ fontSize: "12px" }}>
                                                ç”¨æ–™1ï¼š{item.specMaterial}
                                            </div>
                                        )}
                                        {item.specMaterial2 && (
                                            <div style={{ fontSize: "12px" }}>
                                                ç”¨æ–™2ï¼š{item.specMaterial2}
                                            </div>
                                        )}
                                        {item.specMaterial3 && (
                                            <div style={{ fontSize: "12px" }}>
                                                ç”¨æ–™3ï¼š{item.specMaterial3}
                                            </div>
                                        )}
                                    </td>

                                    <td style={tdCenter}>{item.unit}</td>
                                    <td style={tdRight}>{item.qty}</td>
                                    <td style={tdRight}>{formatMoney(item.price)}</td>
                                    <td style={tdRight}>{formatMoney(subtotal)}</td>
                                </tr>

                                {/* === å­é …ï¼šå‚™è¨» === */}
                                {(item.subItems || []).map((sub) => {
                                    if (sub.type === "note") {
                                        return (
                                            <tr key={sub.id + "-note"}>
                                                <td colSpan="7" style={tdNote}>
                                                    å‚™è¨»ï¼š{sub.text}
                                                </td>
                                            </tr>
                                        );
                                    }

                                    if (sub.type === "image" && sub.url) {
                                        return (
                                            <tr key={sub.id + "-img"}>
                                                <td colSpan="7" style={tdNote}>
                                                    <div>è£œå……åœ–ç‰‡ï¼š</div>
                                                    <img
                                                        src={sub.url}
                                                        style={{
                                                            maxWidth: "300px",
                                                            marginTop: "8px",
                                                            border: "1px solid #999"
                                                        }}
                                                    />
                                                </td>
                                            </tr>
                                        );
                                    }
                                    return null;
                                })}

                            </React.Fragment>
                        );
                    })}

                    {/* ç¸½è¨ˆ */}
                    <tr>
                        <td colSpan="6" style={tdRightBold}>ç¸½è¨ˆï¼ˆæœªç¨…ï¼‰</td>
                        <td style={tdRightBold}>{formatMoney(totalAmount)}</td>
                    </tr>

                    {/* è­°åƒ¹å¾Œç¸½åƒ¹ */}
                    <tr>
                        <td colSpan="6" style={tdRightBold}>è­°åƒ¹å¾Œç¸½åƒ¹ï¼ˆæœªç¨…ï¼‰</td>
                        <td style={tdRightBold}>{formatMoney(negotiatedAmount)}</td>
                    </tr>
                </tbody>
            </table>

            {/* ===== å‚™è¨» ===== */}
            <div style={{ marginTop: "20px", fontSize: "14px" }}>
                <strong>å‚™è¨»ï¼š</strong>
                <pre style={{ whiteSpace: "pre-wrap" }}>{quote.notes}</pre>
            </div>

            {/* ===== ç« æˆ³ ===== */}
            <div style={{ marginTop: "20px", textAlign: "right" }}>
                <img src={company.stamp} className="stamp" />
            </div>
        </div>
    );
}

/***************************************************
 * è¡¨æ ¼æ¨£å¼ï¼ˆåˆ—å°å°ˆç”¨ï¼‰
 ***************************************************/
const th = {
    border: "1px solid black",
    padding: "6px",
    background: "#eee",
    textAlign: "center"
};

const tdLeft = {
    border: "1px solid black",
    padding: "6px",
    textAlign: "left"
};

const tdCenter = {
    border: "1px solid black",
    padding: "6px",
    textAlign: "center"
};

const tdRight = {
    border: "1px solid black",
    padding: "6px",
    textAlign: "right"
};

const tdRightBold = {
    border: "1px solid black",
    padding: "6px",
    fontWeight: "bold",
    textAlign: "right"
};

const tdNote = {
    border: "1px solid black",
    padding: "6px",
    background: "#fafafa",
    fontSize: "13px"
};
/***************************************************
 * D9 â€” ä¸» App ç•«é¢ï¼ˆå³å´ç·¨è¼¯å€ï¼‰
 ***************************************************/
function App() {
    const {
        activeQuote,
        activeQuoteId,
        updateQuote,
    } = React.useContext(AppContext);

    /* æ–°å¢ä¸€å€‹é …ç›® */
    const addItem = () => {
        if (!activeQuote) return;

        const newItem = {
            id: uuid(),
            name: "",
            specMain: "",
            specMaterial: "",
            specMaterial2: "",
            specMaterial3: "",
            unit: "",
            qty: 1,
            price: 0,
            remarks: "",
            subItems: []
        };

        updateQuote(activeQuoteId, {
            items: [...activeQuote.items, newItem]
        });
    };

    /* æ›´æ–°å–®ä¸€ item */
    const updateItem = (id, value) => {
        const list = activeQuote.items.map(i =>
            i.id === id ? { ...i, ...value } : i
        );
        updateQuote(activeQuoteId, { items: list });
    };

    /* åˆªé™¤ item */
    const deleteItem = (id) => {
        const list = activeQuote.items.filter(i => i.id !== id);
        updateQuote(activeQuoteId, { items: list });
    };

    if (!activeQuote) {
        return (
            <div className="p-6 text-gray-600">
                å°šæœªé¸æ“‡å ±åƒ¹å–®ï¼Œè«‹ç”±å·¦å´åˆ—è¡¨æ–°å¢æˆ–é¸å–ã€‚
            </div>
        );
    }

    return (
        <div className="p-6 space-y-6">

            {/* ===== å·¥ç¨‹åç¨± ===== */}
            <div>
                <label className="font-semibold">å·¥ç¨‹åç¨±ï¼š</label>
                <input
                    className="border p-2 rounded w-full"
                    value={activeQuote.title}
                    onChange={(e) =>
                        updateQuote(activeQuoteId, { title: e.target.value })
                    }
                />
            </div>

            {/* ===== å®¢æˆ¶æ¬„ä½ ===== */}
            <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="font-semibold">å®¢æˆ¶åç¨±ï¼š</label>
                    <input
                        className="border p-2 rounded w-full"
                        value={activeQuote.customerName}
                        onChange={(e) =>
                            updateQuote(activeQuoteId, { customerName: e.target.value })
                        }
                    />
                </div>

                <div>
                    <label className="font-semibold">è¯çµ¡äººï¼š</label>
                    <input
                        className="border p-2 rounded w-full"
                        value={activeQuote.contact}
                        onChange={(e) =>
                            updateQuote(activeQuoteId, { contact: e.target.value })
                        }
                    />
                </div>

                <div>
                    <label className="font-semibold">é›»è©±ï¼š</label>
                    <input
                        className="border p-2 rounded w-full"
                        value={activeQuote.phone}
                        onChange={(e) =>
                            updateQuote(activeQuoteId, { phone: e.target.value })
                        }
                    />
                </div>

                <div>
                    <label className="font-semibold">æ—¥æœŸï¼š</label>
                    <input
                        type="date"
                        className="border p-2 rounded w-full"
                        value={activeQuote.date}
                        onChange={(e) =>
                            updateQuote(activeQuoteId, { date: e.target.value })
                        }
                    />
                </div>
            </div>

            {/* ===== å·¥ç¨‹åœ°é» ===== */}
            <div>
                <label className="font-semibold">å·¥ç¨‹åœ°é»ï¼š</label>
                <input
                    className="border p-2 rounded w-full"
                    value={activeQuote.location}
                    onChange={(e) =>
                        updateQuote(activeQuoteId, { location: e.target.value })
                    }
                />
            </div>

            {/* ===== æ–°å¢é …ç›®æŒ‰éˆ• ===== */}
            <button
                className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                onClick={addItem}
            >
                ï¼‹ æ–°å¢é …ç›®
            </button>

            {/* ===== æ‰€æœ‰é …ç›® ===== */}
            <div className="space-y-4">
                {activeQuote.items.map((item, i) => (
                    <QuoteItem
                        key={item.id}
                        item={item}
                        index={i + 1}
                        updateItem={updateItem}
                        deleteItem={deleteItem}
                    />
                ))}
            </div>

            {/* ===== è­°åƒ¹ç›¸é—œ ===== */}
            <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="font-semibold">æŠ˜æ‰£ï¼ˆ%ï¼‰ï¼š</label>
                    <input
                        type="number"
                        className="border p-2 rounded w-full"
                        value={activeQuote.discountPercent}
                        onChange={(e) =>
                            updateQuote(activeQuoteId, {
                                discountPercent: Number(e.target.value),
                            })
                        }
                    />
                </div>

                <div>
                    <label className="font-semibold">è­°åƒ¹å¾Œç¸½åƒ¹ï¼ˆç›´æ¥è¼¸å…¥é‡‘é¡ï¼‰ï¼š</label>
                    <input
                        type="number"
                        className="border p-2 rounded w-full"
                        value={activeQuote.negotiatedPrice}
                        onChange={(e) =>
                            updateQuote(activeQuoteId, {
                                negotiatedPrice: Number(e.target.value),
                            })
                        }
                    />
                </div>
            </div>

            {/* ===== å‚™è¨» ===== */}
            <div>
                <label className="font-semibold">å‚™è¨»ï¼š</label>
                <textarea
                    className="border p-2 rounded w-full"
                    rows="4"
                    value={activeQuote.notes}
                    onChange={(e) =>
                        updateQuote(activeQuoteId, { notes: e.target.value })
                    }
                ></textarea>
            </div>

            {/* ===== ä»˜æ¬¾æ¢ä»¶ ===== */}
            <div>
                <label className="font-semibold">ä»˜æ¬¾æ¢ä»¶ï¼š</label>
                <textarea
                    className="border p-2 rounded w-full"
                    rows="4"
                    value={activeQuote.payment}
                    onChange={(e) =>
                        updateQuote(activeQuoteId, { payment: e.target.value })
                    }
                ></textarea>
            </div>

            {/* ===== åˆ—å° / PDF ===== */}
            <div className="flex gap-4 pt-4">
                <PrintButton quote={activeQuote} />
                <ExportPDFButton quote={activeQuote} />
            </div>
        </div>
    );
}

/***************************************************
 * ReactDOM â€” æ¸²æŸ“ AppProvider + App
 ***************************************************/
ReactDOM.createRoot(document.getElementById("root")).render(
    <AppProvider>
        <div className="flex">
            {/* å·¦å´ Sidebar */}
            <div className="w-72 p-4 bg-gray-100 border-r min-h-screen">
                <CompanySelector />
                <QuoteList />
            </div>

            {/* å³å´å…§å®¹ */}
            <div className="flex-1">
                <App />
            </div>
        </div>
    </AppProvider>
);
</script>

</body>
</html>
