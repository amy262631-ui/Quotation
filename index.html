<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰- æœ€çµ‚æ•´åˆç‰ˆ</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom-server.browser.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body {
        font-family: "Microsoft JhengHei", sans-serif;
        background: #f4f4f4;
    }
    /* ç¢ºä¿åˆ—å°æ’ç‰ˆæ­£ç¢º */
    @media print {
        @page { size: A4; margin: 15mm; } 
        body { margin: 0; padding: 0; }
        .no-print { display: none; }
    }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

// =======================================================
// D1 â€” å…±ç”¨å·¥å…·å‡½å¼ (ä¿æŒä¸è®Š)
// =======================================================
function uuid() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}

function formatMoney(num) {
    if (!num || isNaN(num)) return "0";
    // æ”¾å¤§å­—é«”å¾Œï¼Œä½¿ç”¨ .toLocaleString ç¢ºä¿åƒä½åˆ†éš”ç¬¦ä¿æŒ
    return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 }); 
}

function calcAmount(item) {
    return Number(item?.qty || 0) * Number(item?.price || 0);
}

function calcTotal(items) {
    let sum = 0;
    items.forEach(i => {
        sum += calcAmount(i);
        if (i.subItems) {
            i.subItems.forEach(s => {
                if (s.type === "item") sum += calcAmount(s);
            });
        }
    });
    return sum;
}

function calcNegotiated(total, percent, customPrice) {
    const totalNum = Number(total) || 0;
    const customPriceNum = Number(customPrice) || 0;
    const percentNum = Number(percent) || 0;

    if (customPriceNum > 0) return customPriceNum;
    if (percentNum > 0) return Math.round(totalNum * (1 - percentNum / 100));
    return totalNum;
}


// =======================================================
// D2 â€” AppContextï¼ˆå…¬å¸è³‡æ–™ï¼‹å…¨åŸŸç‹€æ…‹ï¼‰
// =======================================================
const AppContext = React.createContext();

/* ä½ çš„å…¬å¸è³‡æ–™ */
const COMPANY_DATA = {
    herhsin: {
        name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
        tel: "07-6521927",
        fax: "07-6517994",
        email: "affairs@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "https://amy262631-ui.github.io/Quotation/herhsin_stamp.JPG",
        prefix: "QH"
    },
    sinchang: {
        name: "è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸",
        tel: "07-6521927",
        fax: "07-6517994",
        email: "affairs@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "https://amy262631-ui.github.io/Quotation/sinchang_stamp.JPG",
        prefix: "QS"
    }
};

/* é è¨­å‚™è¨» */
const DEFAULT_NOTES = `1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚`;

/* é è¨­ä»˜æ¬¾æ¢ä»¶ */
const DEFAULT_PAYMENT = `è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%`;

/* å ±åƒ¹å–®ç·¨è™Ÿç”¢ç”Ÿå™¨ */
function generateQuoteNo(companyKey) {
    const prefix = COMPANY_DATA[companyKey]?.prefix || "Q";
    const d = new Date();
    const datePart =
        d.getFullYear().toString() +
        String(d.getMonth() + 1).padStart(2, "0") +
        String(d.getDate()).padStart(2, "0") +
        String(d.getHours()).padStart(2, "0") +
        String(d.getMinutes()).padStart(2, "0");
    const random = Math.floor(1000 + Math.random() * 9000);

    return `${prefix}${datePart}-${random}`;
}

// =======================================================
// D2 â€” AppProviderï¼ˆå« GoogleSheet è¼‰å…¥ï¼‰
// =======================================================
function AppProvider({ children }) {

    const [company, setCompany] = React.useState("herhsin"); 
    const [quotes, setQuotes] = React.useState([]);
    const [activeQuoteId, setActiveQuoteId] = React.useState(null);

    /* Google Sheet â€” ææ–™è¦æ ¼å“ */
    const [specItems, setSpecItems] = React.useState([]);

    const SPEC_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv";

    /* è®€å– localStorage */
    React.useEffect(() => {
        const saved = localStorage.getItem("HERHSIN_QUOTES");
        if (saved) {
            try {
                const arr = JSON.parse(saved);
                if (Array.isArray(arr)) {
                    setQuotes(arr);
                    // æ¢å¾©ä¸Šæ¬¡ä½¿ç”¨çš„ activeQuoteIdï¼Œå¦‚æœå­˜åœ¨
                    const lastActiveId = localStorage.getItem("HERHSIN_ACTIVE_QUOTE_ID");
                    const initialActiveId = arr.some(q => q.id === lastActiveId) ? lastActiveId : (arr.length > 0 ? arr[0].id : null);
                    setActiveQuoteId(initialActiveId);
                }
            } catch (err) {
                console.error("localStorage load error:", err);
            }
        }
    }, []);

    /* è‡ªå‹•å­˜å› localStorage */
    React.useEffect(() => {
        localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
        localStorage.setItem("HERHSIN_ACTIVE_QUOTE_ID", activeQuoteId);
    }, [quotes, activeQuoteId]);

    /* è¼‰å…¥ Google Sheet */
    React.useEffect(() => {
        async function loadSpec() {
            try {
                const res = await fetch(SPEC_URL);
                const text = await res.text();

                const rows = text.split("\n").map(r => r.trim()).filter(r => r.length);
                const header = rows[0].split(",").map(h => h.trim());

                const headerMap = {
                    "å“å": "name",
                    "å–®ä½": "unit",
                    "å–®åƒ¹": "price",
                    "è¦æ ¼": "specMain",
                    "ç”¨æ–™1": "specMaterial",
                    "ç”¨æ–™2": "specMaterial2",
                    "ç”¨æ–™3": "specMaterial3",
                };

                const list = rows.slice(1).map(row => {
                    // ä¿®æ­£ CSV è§£æé‚è¼¯
                    const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g); 
                    if (!cols || cols.length !== header.length) return null; 

                    const obj = {};
                    header.forEach((h, i) => {
                        let val = cols[i] || "";
                        val = val.replace(/^"|"$/g, "");
                        
                        const propName = headerMap[h] || h; 
                        obj[propName] = val.trim();
                    });
                    
                    obj.price = Number(obj.price) || 0;
                    return obj;
                }).filter(Boolean);

                setSpecItems(list);
            } catch (err) {
                console.error("Google Sheet è¼‰å…¥éŒ¯èª¤ï¼š", err);
            }
        }

        loadSpec();
    }, []);

    /* æ–°å¢å ±åƒ¹å–® */
    const createQuote = () => {
        const newQuote = {
            id: uuid(),
            company, 
            quoteNo: generateQuoteNo(company),
            title: "æœªå‘½åå·¥ç¨‹",
            customerName: "",
            contact: "",
            phone: "",
            location: "",
            date: new Date().toISOString().substring(0, 10),
            items: [{
                id: uuid(),
                name: '',
                specMain: '',
                unit: 'å¼',
                qty: 1,
                price: 0,
                remarks: '',
                specMaterial: '',
                specMaterial2: '',
                specMaterial3: '',
                subItems: []
            }],
            notes: DEFAULT_NOTES,
            payment: DEFAULT_PAYMENT,
            discountPercent: 0,
            negotiatedPrice: 0
        };

        setQuotes(prev => [newQuote, ...prev]);
        setActiveQuoteId(newQuote.id);
    };

    /* åˆªé™¤å ±åƒ¹å–® */
    const deleteQuote = (id) => {
        const newList = quotes.filter(q => q.id !== id);
        setQuotes(newList);

        if (activeQuoteId === id) {
            setActiveQuoteId(newList.length ? newList[0].id : null);
        }
    };

    /* æ›´æ–°å ±åƒ¹å–® */
    const updateQuote = (id, update) =>
        setQuotes(prev =>
            prev.map(q => (q.id === id ? { ...q, ...update } : q))
        );
    
    /* æ›´æ–°å ±åƒ¹å–®å“é … (Item) */
    const updateItem = (itemId, updates) => {
        if (!activeQuote) return;

        const newItems = activeQuote.items.map(item => 
            item.id === itemId ? { ...item, ...updates } : item
        );
        updateQuote(activeQuote.id, { items: newItems });
    };

    const activeQuote = quotes.find(q => q.id === activeQuoteId) || null;

    return (
        <AppContext.Provider
            value={{
                company,
                setCompany, 
                quotes,
                activeQuote,
                activeQuoteId,
                setActiveQuoteId,
                createQuote,
                deleteQuote,
                updateQuote,
                updateItem, 
                specItems, 
                COMPANY_DATA
            }}
        >
            {children}
        </AppContext.Provider>
    );
}

// =======================================================
// C3 â€” å ±åƒ¹é …ç›®ç·¨è¼¯çµ„ä»¶ (å·²åŠ å…¥ Autocomplete/åœ–ç‰‡ä¸Šå‚³/ç”¨æ–™é¡¯ç¤ºå„ªåŒ–)
// =======================================================
function QuoteItemEditor({ item, updateItem, index, activeQuote, updateQuote }) {
    const { specItems } = React.useContext(AppContext);

    // ç‹€æ…‹ç”¨æ–¼æ§åˆ¶è‡ªå‹•å®Œæˆ
    const [searchTerm, setSearchTerm] = React.useState(item.name || '');
    const [suggestions, setSuggestions] = React.useState([]);

    const itemAmount = calcAmount(item); 

    React.useEffect(() => {
        // ç•¶ item.name å¾å¤–éƒ¨ (å¦‚æ–°å¢å“é …) æ”¹è®Šæ™‚ï¼Œæ›´æ–° searchTerm
        if (item.name !== searchTerm) {
            setSearchTerm(item.name || '');
        }
    }, [item.name]);

    const handleChange = (e) => {
        const { name, value, type } = e.target;
        
        if (name === 'name') {
            setSearchTerm(value);
            updateItem(item.id, { [name]: value });
            
            // è‡ªå‹•å®Œæˆç¯©é¸é‚è¼¯ï¼šåªåŒ¹é…ç¬¬ä¸€å€‹å­—
            if (value.length > 0) {
                const firstChar = value.trim().charAt(0);
                const filtered = specItems.filter(spec => 
                    spec.name && spec.name.startsWith(firstChar)
                );
                setSuggestions(filtered);
            } else {
                setSuggestions([]);
            }

        } else {
            // è™•ç†éå“åæ¬„ä½
            const finalValue = type === 'number' ? Number(value) : value; 
            updateItem(item.id, { [name]: finalValue });
        }
    };

    // è™•ç†é¸æ“‡å»ºè­°
    const handleSelectSuggestion = (suggestion) => {
        setSuggestions([]); 
        setSearchTerm(suggestion.name);

        // è‡ªå‹•ä»£å…¥æ‰€æœ‰æ¬„ä½
        updateItem(item.id, {
            name: suggestion.name,
            unit: suggestion.unit || 'å¼',
            price: Number(suggestion.price) || 0, 
            specMain: suggestion.specMain || '',
            specMaterial: suggestion.specMaterial || '',
            specMaterial2: suggestion.specMaterial2 || '',
            specMaterial3: suggestion.specMaterial3 || '',
        });
    };
    
    // è™•ç†åœ–ç‰‡ä¸Šå‚³ (æ–°å¢åŠŸèƒ½)
    const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onloadend = () => {
                const newImageSubItem = {
                    id: uuid(),
                    type: 'image',
                    url: reader.result, // Base64 URL
                    text: file.name
                };

                const newSubItems = [...(item.subItems || []), newImageSubItem];
                updateItem(item.id, { subItems: newSubItems });
            };
            reader.readAsDataURL(file);
        } else if (file) {
            alert("è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆã€‚");
        }
        // æ¸…é™¤ input å€¼ä»¥å…è¨±å†æ¬¡é¸æ“‡åŒä¸€å€‹æª”æ¡ˆ
        e.target.value = null; 
    };
    
    // åˆªé™¤åœ–ç‰‡
    const handleDeleteImage = (imgId) => {
        const newSubItems = (item.subItems || []).filter(s => s.id !== imgId);
        updateItem(item.id, { subItems: newSubItems });
    };

    // åˆ¤æ–·æ˜¯å¦æœ‰åœ–ç‰‡
    const existingImages = (item.subItems || []).filter(s => s.type === 'image');


    return (
        <div className="bg-gray-50 p-5 mb-4 border rounded relative"> {/* å¢åŠ  padding, margin */}
            <h4 className="font-semibold mb-3 text-lg text-gray-700"> {/* æ”¾å¤§å­—é«” */}
                å“é … {index + 1} (å°è¨ˆ: {formatMoney(itemAmount)} å…ƒ)
            </h4>
            
            {/* 1. ä¸»è¦ç·¨è¼¯æ¬„ä½ */}
            <div className="grid grid-cols-6 gap-4 text-base"> {/* æ”¾å¤§å­—é«”, å¢åŠ  gap */}
                
                {/* å“åè¼¸å…¥æ¡† - å…·å‚™è‡ªå‹•å®ŒæˆåŠŸèƒ½ */}
                <div className="relative">
                    <label className="block text-gray-600 mb-1">å“å</label>
                    <input 
                        type="text" 
                        name="name" 
                        value={searchTerm} 
                        onChange={handleChange}
                        onBlur={() => {
                            // å»¶é²éš±è—ï¼Œä»¥ä¾¿é»æ“Š suggestion
                            setTimeout(() => setSuggestions([]), 200);
                        }}
                        onFocus={() => {
                            // é‡æ–°ç¯©é¸å»ºè­°
                            if (searchTerm.length > 0) {
                                const firstChar = searchTerm.trim().charAt(0);
                                const filtered = specItems.filter(spec => 
                                    spec.name && spec.name.startsWith(firstChar)
                                );
                                setSuggestions(filtered);
                            }
                        }}
                        className="w-full border px-3 py-2 rounded focus:ring-blue-500 focus:border-blue-500" 
                        autoComplete="off"
                    />

                    {/* è‡ªå‹•å®Œæˆä¸‹æ‹‰é¸å–® */}
                    {suggestions.length > 0 && (
                        <div className="absolute z-10 w-80 mt-1 bg-white border border-gray-300 rounded shadow-lg max-h-60 overflow-y-auto">
                            {suggestions.map((suggestion, idx) => (
                                <div 
                                    key={idx} 
                                    onMouseDown={(e) => { 
                                        e.preventDefault(); 
                                        handleSelectSuggestion(suggestion);
                                    }}
                                    className="p-3 cursor-pointer hover:bg-blue-100 text-gray-800"
                                >
                                    <div className="font-bold">{suggestion.name}</div>
                                    <div className="text-gray-500 text-sm">
                                        è¦æ ¼: {suggestion.specMain || 'N/A'} | å–®åƒ¹: {formatMoney(suggestion.price)}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                {/* å…¶ä»–æ¬„ä½ */}
                <div>
                    <label className="block text-gray-600 mb-1">è¦æ ¼</label>
                    <input type="text" name="specMain" value={item.specMain || ''} onChange={handleChange}
                        className="w-full border px-3 py-2 rounded" />
                </div>
                <div>
                    <label className="block text-gray-600 mb-1">å–®ä½</label>
                    <input type="text" name="unit" value={item.unit || ''} onChange={handleChange}
                        className="w-full border px-3 py-2 rounded" />
                </div>
                <div>
                    <label className="block text-gray-600 mb-1">æ•¸é‡</label>
                    <input type="number" name="qty" value={item.qty || 0} onChange={handleChange}
                        className="w-full border px-3 py-2 rounded" />
                </div>
                <div>
                    <label className="block text-gray-600 mb-1">å–®åƒ¹</label>
                    <input type="number" name="price" value={item.price || 0} onChange={handleChange}
                        className="w-full border px-3 py-2 rounded" />
                </div>
                <div>
                    <label className="block text-gray-600 mb-1">å‚™è¨»</label>
                    <input type="text" name="remarks" value={item.remarks || ''} onChange={handleChange}
                        className="w-full border px-3 py-2 rounded" />
                </div>
            </div>
            
            {/* 2. ç”¨æ–™ 1-3 é¡¯ç¤ºå€ (æ–°å¢åŠŸèƒ½) */}
             <div className="col-span-6 mt-4 pt-3 border-t text-sm text-gray-700">
                <span className="mr-6 font-semibold">ç”¨æ–™ 1:</span> {item.specMaterial || 'N/A'}
                <span className="ml-6 mr-6 font-semibold">ç”¨æ–™ 2:</span> {item.specMaterial2 || 'N/A'}
                <span className="ml-6 mr-6 font-semibold">ç”¨æ–™ 3:</span> {item.specMaterial3 || 'N/A'}
            </div>
            
            {/* 3. åœ–ç‰‡ä¸Šå‚³èˆ‡ç®¡ç†å€ (æ–°å¢åŠŸèƒ½) */}
            <div className="mt-4 pt-3 border-t">
                <h5 className="font-semibold text-base mb-2 text-gray-700">è£œå……åœ–ç‰‡ (å°‡é¡¯ç¤ºåœ¨åˆ—å°é é¢):</h5>
                <div className="flex flex-wrap items-center space-x-3">
                    {/* åœ–ç‰‡ä¸Šå‚³æŒ‰éˆ• */}
                    <label className="cursor-pointer bg-blue-100 text-blue-700 px-4 py-2 rounded hover:bg-blue-200 text-sm transition duration-150">
                        + æ–°å¢åœ–ç‰‡ (å¾é›»è…¦)
                        <input 
                            type="file" 
                            accept="image/*" 
                            onChange={handleImageUpload} 
                            className="hidden"
                        />
                    </label>
                    
                    {/* é¡¯ç¤ºå’Œåˆªé™¤ç¾æœ‰åœ–ç‰‡ */}
                    {existingImages
                        .map(img => (
                            <div key={img.id} className="relative group mt-2">
                                <img 
                                    src={img.url} 
                                    alt={img.text} 
                                    className="w-20 h-20 object-cover border rounded shadow cursor-pointer" // æ”¾å¤§é è¦½
                                    title={`é»æ“Šåˆªé™¤: ${img.text}`}
                                    onClick={() => handleDeleteImage(img.id)}
                                />
                                <button 
                                    onClick={(e) => { e.stopPropagation(); handleDeleteImage(img.id); }}
                                    className="absolute top-[-5px] right-[-5px] bg-red-600 text-white rounded-full w-5 h-5 text-sm flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-150 shadow-md"
                                    title="åˆªé™¤åœ–ç‰‡"
                                >
                                    &times;
                                </button>
                            </div>
                        ))}
                </div>
            </div>

            {/* åˆªé™¤å“é …æŒ‰éˆ• */}
            <button 
                onClick={() => {
                    const newItems = activeQuote.items.filter(i => i.id !== item.id);
                    updateQuote(activeQuote.id, { items: newItems });
                }}
                className="mt-4 text-red-500 hover:text-red-700 text-sm"
            >
                ğŸ—‘ åˆªé™¤æ­¤å“é …
            </button>
        </div>
    );
}

// =======================================================
// D3 â€” å ±åƒ¹å–®é è¦½çµ„ä»¶ (æ–°å¢åŠŸèƒ½)
// =======================================================
function QuotePreview({ quote, companyData }) {
    if (!quote) return null;
    return (
        <div className="mt-12 pt-8 border-t-4 border-gray-300">
            <h2 className="text-3xl font-bold mb-8 text-center text-gray-800">å ±åƒ¹å–®é è¦½ (åˆ—å°ç‰ˆé¢)</h2>
            {/* åˆ—å°ç‰ˆé¢å®¹å™¨ï¼Œé™åˆ¶å¯¬åº¦ä»¥æ¨¡æ“¬ A4 ç´™å¼µ */}
            <div className="bg-white p-6 shadow-2xl mx-auto max-w-4xl border border-gray-200"> 
                <PrintLayout quote={quote} companyData={companyData} />
            </div>
        </div>
    );
}


// =======================================================
// D7 â€” PrintLayout (åˆ—å°/é è¦½ç‰ˆé¢)
// =======================================================
function PrintLayout({ quote, companyData }) {
    
    if (!quote || !companyData) return <div style={{padding: '20px', fontSize: '16px'}}>âš ï¸ å ±åƒ¹å–®æˆ–å…¬å¸è³‡æ–™ä¸å®Œæ•´</div>;

    // èª¿æ•´æ¨£å¼ä»¥é©æ‡‰è¼ƒå¤§çš„å­—é«”å’Œæ›´å¥½çš„åˆ—å°æ•ˆæœ
    const td = {
        border: "1px solid #000",
        padding: "8px", // å¢åŠ  padding
        fontSize: "14px", // ç•¥å¾®æ”¾å¤§å­—é«”
        verticalAlign: "top",
        lineHeight: "1.5"
    };

    const tdCenter = { ...td, textAlign: "center" };
    const tdRight = { ...td, textAlign: "right" };
    const tdRightBold = { ...tdRight, fontWeight: "bold" };

    const totalAmount = calcTotal(quote.items);
    const negotiatedAmount = calcNegotiated(
        totalAmount,
        quote.discountPercent,
        quote.negotiatedPrice
    );

    return (
        <div style={{ padding: "10px", fontFamily: "Microsoft JhengHei, sans-serif" }}>

            <h2
                style={{
                    fontSize: "26px", // æ”¾å¤§æ¨™é¡Œ
                    fontWeight: "bold",
                    textAlign: "center",
                    marginBottom: "25px" // å¢åŠ é–“è·
                }}
            >
                å·¥ç¨‹å ±åƒ¹å–®
            </h2>

            <table style={{ width: "100%", marginBottom: "20px" }}>
                <tbody>
                    <tr>
                        <td style={{ width: "50%", fontSize: "15px", padding: '5px 0' }}> {/* æ”¾å¤§å­—é«” */}
                            <div><b>å·¥ç¨‹åç¨±ï¼š</b>{quote.title || 'N/A'}</div>
                            <div><b>å®¢æˆ¶åç¨±ï¼š</b>{quote.customerName || 'N/A'}</div>
                            <div><b>è¯çµ¡äººï¼š</b>{quote.contact || 'N/A'}</div>
                            <div><b>é€£çµ¡é›»è©±ï¼š</b>{quote.phone || 'N/A'}</div>
                            <div><b>å®‰è£åœ°é»ï¼š</b>{quote.location || 'N/A'}</div>
                        </td>

                        <td style={{ width: "50%", fontSize: "15px", padding: '5px 0' }}> {/* æ”¾å¤§å­—é«” */}
                            <div><b>å ±åƒ¹å–®è™Ÿï¼š</b>{quote.quoteNo || 'N/A'}</div>
                            <div><b>æ—¥æœŸï¼š</b>{quote.date || 'N/A'}</div>
                            <div><b>å…¬å¸åç¨±ï¼š</b>{companyData.name}</div>
                            <div><b>å…¬å¸é›»è©±ï¼š</b>{companyData.tel}</div>
                            <div><b>åœ°å€ï¼š</b>{companyData.address}</div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <table style={{ width: "100%", borderCollapse: "collapse" }}>
                <thead>
                    <tr>
                        <th style={tdCenter}>é …æ¬¡</th>
                        <th style={tdCenter}>å“å</th>
                        <th style={tdCenter}>è¦æ ¼</th>
                        <th style={tdCenter}>å–®ä½</th>
                        <th style={tdCenter}>æ•¸é‡</th>
                        <th style={tdCenter}>å–®åƒ¹</th>
                        <th style={tdCenter}>å°è¨ˆ</th>
                        <th style={tdCenter}>å‚™è¨»</th>
                    </tr>
                </thead>

                <tbody>

                    {(quote.items || []).map((item, idx) => {
                        const amount = calcAmount(item);
                        return (
                            <React.Fragment key={item.id}>
                                {/* ===== 1. ä¸»é … (Main Item) ===== */}
                                <tr>
                                    <td style={tdCenter}>{idx + 1}</td>
                                    <td style={td}>{item.name || ''}</td>
                                    <td style={td}>{item.specMain || ''}</td>
                                    <td style={tdCenter}>{item.unit || ''}</td>
                                    <td style={tdRight}>{item.qty || 0}</td>
                                    <td style={tdRight}>{formatMoney(item.price)}</td>
                                    <td style={tdRightBold}>{formatMoney(amount)}</td>
                                    <td style={td}>{item.remarks || ""}</td>
                                </tr>

                                {/* ===== 2. ç”¨æ–™ç´°é … (Materials) - æœ€å¤š 3 é … (å„ªåŒ–é¡¯ç¤º) ===== */}
                                {([
                                    item.specMaterial,
                                    item.specMaterial2,
                                    item.specMaterial3
                                ]).filter(Boolean).map((mat, i) =>
                                    mat ? (
                                        <tr key={`${item.id}_mat_${i}`}>
                                            <td colSpan="8" style={{ ...td, background: "#f9f9f9", fontSize: '13px', padding: '4px 8px' }}>
                                                **ç”¨æ–™ {i+1}ï¼š** {mat}
                                            </td>
                                        </tr>
                                    ) : null
                                )}

                                {/* ===== 3. è£œå……åœ–ç‰‡ (SubItems - type: image) - (æ–°å¢åŠŸèƒ½) ===== */}
                                {(item.subItems || [])
                                    .filter(s => s.type === "image" && s.url)
                                    .map((s, imgIdx) => (
                                        <tr key={s.id + "_img"}>
                                            <td colSpan="8" style={{ ...td, textAlign: "center", padding: '15px' }}>
                                                <div style={{ fontWeight: 'bold', marginBottom: '10px', fontSize: '13px'}}>
                                                    åœ–ç‰‡ {imgIdx + 1}: {s.text}
                                                </div>
                                                <img
                                                    src={s.url}
                                                    style={{
                                                        maxWidth: "400px", // åœ–ç‰‡æœ€å¤§å¯¬åº¦
                                                        maxHeight: "300px",
                                                        height: 'auto',
                                                        width: 'auto',
                                                        border: "1px solid #ccc",
                                                        objectFit: 'contain'
                                                    }}
                                                    alt="è£œå……åœ–ç‰‡"
                                                />
                                            </td>
                                        </tr>
                                    ))}

                                {/* ===== 4. è£œå……èªªæ˜ (SubItems - type: note) ===== */}
                                {(item.subItems || [])
                                    .filter(s => s.type === "note" && s.text)
                                    .map((s) => (
                                        <tr key={s.id + "_note"}>
                                            <td colSpan="8" style={{ ...td, background: "#f0f0f0", fontSize: '13px' }}>
                                                **è£œå……èªªæ˜ï¼š** {s.text}
                                            </td>
                                        </tr>
                                    ))}
                            </React.Fragment>
                        );
                    })}

                    {/* ===== ç¸½è¨ˆè¡Œ ===== */}
                    <tr>
                        <td colSpan="7" style={tdRightBold}>ç¸½è¨ˆï¼ˆæœªç¨…ï¼‰</td>
                        <td style={tdRightBold}>{formatMoney(totalAmount)}</td>
                    </tr>

                    {/* ===== è­°åƒ¹å¾Œç¸½åƒ¹è¡Œ ===== */}
                   <tr>
                        <td colSpan="7" style={tdRightBold}>è­°åƒ¹å¾Œç¸½åƒ¹ï¼ˆæœªç¨…ï¼‰</td>
                        {/*  éŒ¯èª¤ä¿®æ­£ï¼šä½¿ç”¨ { ...tdRightBold, color: '#d92c2c' } */}
                        <td style={{ ...tdRightBold, color: '#d92c2c' }}>{formatMoney(negotiatedAmount)}</td>
                    </tr>>

                </tbody>
            </table>

            {/* ===== å‚™è¨» + ä»˜æ¬¾æ¢ä»¶å€å¡Š ===== */}
            <table style={{ width: "100%", marginTop: "30px" }}>
                <tbody>
                    <tr>
                        <td style={{ width: "50%", fontSize: "15px", verticalAlign: "top", paddingRight: '15px' }}>
                            <b style={{fontSize: '16px'}}>å‚™è¨»ï¼š</b><br />
                            <pre style={{ whiteSpace: "pre-wrap", fontSize: "14px", margin: '5px 0' }}>
                                {quote.notes}
                            </pre>
                        </td>

                        <td style={{ width: "50%", fontSize: "15px", verticalAlign: "top", paddingLeft: '15px' }}>
                            <b style={{fontSize: '16px'}}>ä»˜æ¬¾æ¢ä»¶ï¼š</b><br />
                            <pre style={{ whiteSpace: "pre-wrap", fontSize: "14px", margin: '5px 0' }}>
                                {quote.payment}
                            </pre>
                        </td>
                    </tr>
                </tbody>
            </table>

            {/* ===== å°ç«  + å®¢æˆ¶ç°½åå€å¡Š ===== */}
            <table style={{
                width: "100%",
                marginTop: "50px", // å¢åŠ é–“è·
                borderCollapse: "collapse"
            }}>
                <tbody>
                    <tr>
                        {/* å…¬å¸å°ç«  */}
                        <td style={{
                            border: "1px solid #000",
                            width: "50%", 
                            height: "160px", // å¢åŠ é«˜åº¦
                            textAlign: "center",
                            fontSize: "15px"
                        }}>
                            <div style={{ fontWeight: "bold", marginBottom: "10px" }}>
                                æœ¬å…¬å¸è“‹ç« 
                            </div>
                            {companyData.stamp && (
                                <img
                                    src={companyData.stamp}
                                    style={{ width: "130px", marginTop: "10px" }}
                                    alt="å…¬å¸å°ç« "
                                />
                            )}
                        </td>

                        {/* å®¢æˆ¶å›ç°½ */}
                        <td style={{ 
                            border: "1px solid #000",
                            width: "50%", 
                            height: "160px", 
                            fontSize: "15px",
                            padding: '20px'
                        }}>
                            å®¢æˆ¶ç°½åï¼š<span style={{borderBottom: '1px solid #000', padding: '0 50px'}}>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br /><br /><br />
                            æ—¥æœŸï¼š<span style={{borderBottom: '1px solid #000', padding: '0 50px'}}>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                        </td>
                    </tr>
                </tbody>
            </table>

        </div>
    );
}

// =======================================================
// D6 â€” åˆ—å° PrintButton
// =======================================================
function PrintButton() {
    const { activeQuote, COMPANY_DATA } = React.useContext(AppContext);
    
    const handlePrint = () => {
        if (!activeQuote) {
            alert("å°šæœªé¸æ“‡å ±åƒ¹å–®");
            return;
        }

        const companyData = COMPANY_DATA[activeQuote.company];
        if (!companyData) {
             alert("å…¬å¸è³‡æ–™éŒ¯èª¤ï¼Œç„¡æ³•åˆ—å°");
             return;
        }

        const win = window.open("", "_blank");
        if (!win) {
             alert("è«‹å…è¨±å½ˆå‡ºè¦–çª—ä»¥ä¾¿åˆ—å°");
             return;
        }
        
        win.document.write(`
            <html>
            <head>
                <title>å ±åƒ¹å–® ${activeQuote.quoteNo}</title>
                <style>
                    @page { size: A4; margin: 15mm; } 
                    body { 
                        margin: 0; 
                        padding: 0; 
                        font-family: "Microsoft JhengHei", "PingFang TC", sans-serif; 
                        color: #000;
                    }
                    table { page-break-inside: auto; }
                    tr    { page-break-inside: avoid; page-break-after: auto; }
                    
                    /* ç¢ºä¿ PrintLayout çš„æ¨£å¼èƒ½æ­£ç¢ºæ‡‰ç”¨ */
                    .print-container {
                        max-width: 100%;
                        margin: 0;
                        padding: 0;
                    }
                </style>
            </head>
            <body><div class="print-container"></div></body>
            </html>
        `);
        win.document.close();

        const container = win.document.querySelector(".print-container");
        const printRoot = ReactDOM.createRoot(container); 
        printRoot.render(<AppProvider><PrintLayout quote={activeQuote} companyData={companyData} /></AppProvider>);

        setTimeout(() => {
            win.print();
        }, 500);
    };

    return (
        <button
            className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-base"
            onClick={handlePrint}
        >
            ğŸ–¨ åˆ—å°å ±åƒ¹å–®
        </button>
    );
}


// =======================================================
// D6 â€” PDF ç”¢ç”Ÿ ExportPDFButton
// =======================================================
function ExportPDFButton() {
    const { activeQuote, COMPANY_DATA } = React.useContext(AppContext);
    
    const generatePDF = async () => {
        if (!activeQuote) {
            alert("è«‹å…ˆé¸æ“‡å ±åƒ¹å–®");
            return;
        }
        const companyData = COMPANY_DATA[activeQuote.company];
        const { jsPDF } = window.jspdf || {}; 
        
        if (typeof html2canvas === 'undefined' || typeof jsPDF === 'undefined') {
            alert("ç¼ºå°‘ html2canvas æˆ– jspdf åº«ï¼Œç„¡æ³•ç”Ÿæˆ PDF");
            return;
        }

        // 1. éš±è—æ¸²æŸ“å®¹å™¨
        const hidden = document.createElement("div");
        hidden.style.position = "fixed";
        hidden.style.top = "-9999px";
        hidden.style.left = "-9999px";
        hidden.style.width = "794px"; // æ¨¡æ“¬ A4 å¯¬åº¦ (794px for A4 landscape)
        hidden.style.fontFamily = "Microsoft JhengHei, sans-serif"; 
        hidden.style.padding = "20px";
        document.body.appendChild(hidden);

        // 2. æ¸²æŸ“åˆ—å°ç‰ˆ
        const hiddenRoot = ReactDOM.createRoot(hidden);
        hiddenRoot.render(<PrintLayout quote={activeQuote} companyData={companyData} />);

        // 3. ç­‰å¾…æ¸²æŸ“å®Œæˆ
        await new Promise(res => setTimeout(res, 500));

        try {
             // 4. è½‰æ›ç‚º Canvas
            const canvas = await html2canvas(hidden, { 
                scale: 3,
                logging: false,
                useCORS: true
            }); 
            const img = canvas.toDataURL("image/png");

            // 5. å»ºç«‹ jsPDF å¯¦ä¾‹
            const pdf = new jsPDF("p", "mm", "a4");
            const pdfWidth = pdf.internal.pageSize.getWidth(); 
            const canvasWidth = canvas.width / 3; 
            const canvasHeight = canvas.height / 3;
            
            const pdfHeight = (canvasHeight * pdfWidth) / canvasWidth; 

            // 6. å°‡åœ–ç‰‡æ·»åŠ åˆ° PDF
            pdf.addImage(img, "PNG", 0, 0, pdfWidth, pdfHeight);
            pdf.save(`å ±åƒ¹å–®_${activeQuote.quoteNo}.pdf`);

        } catch (error) {
            console.error("ç”Ÿæˆ PDF å¤±æ•—:", error);
            alert("ç”Ÿæˆ PDF éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚");
        } finally {
            // 7. æ¸…ç†
            hiddenRoot.unmount(); 
            document.body.removeChild(hidden);
        }
    };

    return (
        <button
            className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 text-base"
            onClick={generatePDF}
        >
            ğŸ“„ è½‰ PDF
        </button>
    );
}


// =======================================================
// D0 â€” Appï¼ˆä¸»è¦æ¸²æŸ“å…¥å£ï¼‰
// =======================================================
function App() {
    const { 
        company, 
        setCompany, 
        quotes,
        activeQuote, 
        activeQuoteId,
        setActiveQuoteId,
        createQuote, 
        updateQuote, 
        updateItem,
        deleteQuote,
        COMPANY_DATA
    } = React.useContext(AppContext);

    const companyKeys = Object.keys(COMPANY_DATA);

    const handleFieldChange = (e) => {
        const { name, value } = e.target;
        if (activeQuote) {
            updateQuote(activeQuote.id, { [name]: value });
        }
    };
    
    // ç¸½é‡‘é¡
    const totalAmount = activeQuote ? calcTotal(activeQuote.items) : 0;
    const negotiatedAmount = activeQuote ? calcNegotiated(
        totalAmount,
        activeQuote.discountPercent,
        activeQuote.negotiatedPrice
    ) : 0;
    
    // åˆªé™¤ç•¶å‰å ±åƒ¹å–®
    const handleDeleteCurrent = () => {
        if(confirm(`ç¢ºå®šè¦åˆªé™¤å ±åƒ¹å–® ${activeQuote.quoteNo} å—ï¼Ÿ`)) {
            deleteQuote(activeQuote.id);
        }
    }
    
    // è¤‡è£½å ±åƒ¹å–® (æ–°å¢åŠŸèƒ½)
    const handleDuplicateQuote = () => {
        if (!activeQuote) return;

        // æ·±å±¤è¤‡è£½
        const newQuote = JSON.parse(JSON.stringify(activeQuote));

        // é‡è¨­è­˜åˆ¥ç¢¼å’Œç´°ç¯€
        newQuote.id = uuid();
        newQuote.quoteNo = generateQuoteNo(activeQuote.company);
        newQuote.title = `(è¤‡è£½) ${newQuote.title}`;

        // æ›´æ–°å“é … ID å’Œå­é … ID
        newQuote.items = newQuote.items.map(item => {
            item.id = uuid();
            item.subItems = (item.subItems || []).map(sub => ({ ...sub, id: uuid() }));
            return item;
        });

        setQuotes(prev => [newQuote, ...prev]);
        setActiveQuoteId(newQuote.id);
        alert(`å ±åƒ¹å–® ${activeQuote.quoteNo} å·²è¤‡è£½ç‚º ${newQuote.quoteNo}`);
    };

    return (
        <div className="p-8">
            <h1 className="text-3xl font-bold mb-6 text-gray-800">å·¥ç¨‹å ±åƒ¹ç³»çµ±</h1>

            {/* ===== é ‚éƒ¨åŠŸèƒ½å€ (å…¬å¸åˆ‡æ›, æ–°å¢, åˆ—å°, PDF) ===== */}
            <div className="no-print flex items-center justify-between bg-white p-5 rounded-lg shadow-lg mb-8"> {/* æ”¾å¤§ padding/margin */}
                <div className="flex space-x-6 items-center">
                    <label className="font-medium text-xl text-gray-700">é¸æ“‡å ±åƒ¹å–®:</label>
                    <select 
                        value={activeQuoteId || ''} 
                        onChange={(e) => setActiveQuoteId(e.target.value)}
                        className="border border-gray-300 rounded p-2 text-base w-64"
                    >
                        <option value="" disabled>--- è«‹é¸æ“‡æˆ–æ–°å¢å ±åƒ¹å–® ---</option>
                        {quotes.map(q => (
                            <option key={q.id} value={q.id}>
                                {q.quoteNo} - {q.title}
                            </option>
                        ))}
                    </select>
                </div>
                <div className="flex space-x-3">
                     <label className="font-medium text-lg flex items-center">å…¬å¸:</label>
                    <select 
                        value={company} 
                        onChange={(e) => setCompany(e.target.value)}
                        className="border border-gray-300 rounded p-2 text-base"
                    >
                        {companyKeys.map(key => (
                            <option key={key} value={key}>{COMPANY_DATA[key].name}</option>
                        ))}
                    </select>
                    <button
                        className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-base"
                        onClick={createQuote}
                    >
                        + æ–°å¢å ±åƒ¹å–®
                    </button>
                    <PrintButton />
                    <ExportPDFButton />
                </div>
            </div>

            {activeQuote ? (
                <div className="bg-white p-8 rounded-lg shadow-xl"> {/* æ”¾å¤§ padding, å¢å¼·é™°å½± */}
                    {/* ===== å ±åƒ¹å–®åŸºæœ¬è³‡è¨Šç·¨è¼¯å€ ===== */}
                    <div className="mb-8 pb-4 border-b-2">
                        <div className="grid grid-cols-2 gap-6"> {/* å¢åŠ  gap */}
                            <input 
                                type="text" 
                                name="title" 
                                placeholder="å·¥ç¨‹åç¨±"
                                value={activeQuote.title}
                                onChange={handleFieldChange}
                                className="text-3xl font-bold border-b-2 p-1 col-span-2 focus:border-blue-500"
                            />
                            
                            <div className="grid grid-cols-2 gap-4 text-base"> {/* æ”¾å¤§å­—é«” */}
                                <label className="flex items-center">å®¢æˆ¶åç¨±ï¼š
                                    <input type="text" name="customerName" value={activeQuote.customerName} onChange={handleFieldChange} className="border p-2 w-full ml-2 rounded"/>
                                </label>
                                <label className="flex items-center">è¯çµ¡äººï¼š
                                    <input type="text" name="contact" value={activeQuote.contact} onChange={handleFieldChange} className="border p-2 w-full ml-2 rounded"/>
                                </label>
                                <label className="flex items-center">é€£çµ¡é›»è©±ï¼š
                                    <input type="text" name="phone" value={activeQuote.phone} onChange={handleFieldChange} className="border p-2 w-full ml-2 rounded"/>
                                </label>
                                <label className="flex items-center">å®‰è£åœ°é»ï¼š
                                    <input type="text" name="location" value={activeQuote.location} onChange={handleFieldChange} className="border p-2 w-full ml-2 rounded"/>
                                </label>
                            </div>
                            
                            <div className="text-right text-base"> {/* æ”¾å¤§å­—é«” */}
                                <p className="mb-2">å ±åƒ¹å–®è™Ÿï¼š<span className="font-bold">{activeQuote.quoteNo}</span></p>
                                <p className="flex justify-end items-center">æ—¥æœŸï¼š
                                    <input type="date" name="date" value={activeQuote.date} onChange={handleFieldChange} className="border p-2 ml-2 rounded"/>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    {/* ===== å ±åƒ¹å“é …åˆ—è¡¨ ===== */}
                    <h3 className="text-2xl font-semibold mb-4 border-b pb-2 text-gray-700">å ±åƒ¹å“é … (å…± {activeQuote.items.length} é …)</h3>
                    {activeQuote.items.map((item, index) => (
                        <QuoteItemEditor 
                            key={item.id} 
                            item={item} 
                            updateItem={updateItem} 
                            index={index}
                            activeQuote={activeQuote} 
                            updateQuote={updateQuote}
                        />
                    ))}

                    {/* æ–°å¢å“é …æŒ‰éˆ• */}
                    <button 
                        onClick={() => {
                            const newItem = {
                                id: uuid(),
                                name: '',
                                specMain: '',
                                unit: 'å¼',
                                qty: 1,
                                price: 0,
                                remarks: '',
                                specMaterial: '',
                                specMaterial2: '',
                                specMaterial3: '',
                                subItems: []
                            };
                            updateQuote(activeQuote.id, { items: [...activeQuote.items, newItem] });
                        }}
                        className="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 text-base mt-4"
                    >
                        + æ–°å¢å“é …
                    </button>
                    
                    {/* ===== ç¸½çµå€ ===== */}
                    <div className="mt-8 pt-4 border-t-2 border-red-500 text-right">
                        <div className="text-xl font-medium">ç¸½è¨ˆï¼ˆæœªç¨…ï¼‰ï¼š<span className="text-red-600 font-bold">{formatMoney(totalAmount)}</span> å…ƒ</div>
                        <div className="flex justify-end items-center mt-3 space-x-3 text-base">
                            <label>æŠ˜æ‰£ (%)ï¼š</label>
                            <input 
                                type="number" 
                                name="discountPercent"
                                value={activeQuote.discountPercent || 0}
                                onChange={handleFieldChange}
                                className="border p-2 w-24 text-right rounded"
                            />
                            <label>è­°åƒ¹å¾Œç¸½åƒ¹ï¼š</label>
                            <input 
                                type="number" 
                                name="negotiatedPrice"
                                value={activeQuote.negotiatedPrice || 0}
                                onChange={handleFieldChange}
                                className="border p-2 w-40 text-right font-bold text-red-700 rounded"
                            />
                            <span className="text-xl font-bold text-red-700">({formatMoney(negotiatedAmount)}) å…ƒ</span>
                        </div>
                    </div>

                    {/* ===== å‚™è¨»/ä»˜æ¬¾æ¢ä»¶ç·¨è¼¯ ===== */}
                    <div className="grid grid-cols-2 gap-8 mt-6 text-base">
                        <div>
                            <h4 className="font-semibold mb-2 text-xl">å‚™è¨»ï¼š</h4>
                            <textarea 
                                name="notes" 
                                value={activeQuote.notes} 
                                onChange={handleFieldChange} 
                                rows="6" 
                                className="w-full border p-3 rounded"
                            ></textarea>
                        </div>
                         <div>
                            <h4 className="font-semibold mb-2 text-xl">ä»˜æ¬¾æ¢ä»¶ï¼š</h4>
                            <textarea 
                                name="payment" 
                                value={activeQuote.payment} 
                                onChange={handleFieldChange} 
                                rows="6" 
                                className="w-full border p-3 rounded"
                            ></textarea>
                        </div>
                    </div>
                    
                    <div className="flex justify-start items-center mt-6">
                        <button 
                            onClick={handleDeleteCurrent}
                            className="bg-red-100 text-red-600 px-4 py-2 rounded hover:bg-red-200 text-base"
                        >
                            ğŸ—‘ åˆªé™¤æ­¤å ±åƒ¹å–®
                        </button>
                         <button 
                            onClick={handleDuplicateQuote}
                            className="ml-4 bg-yellow-100 text-yellow-700 px-4 py-2 rounded hover:bg-yellow-200 text-base"
                        >
                            ğŸ“‹ è¤‡è£½å ±åƒ¹å–®
                        </button>
                    </div>

                </div>
            ) : (
                <p className="p-8 text-center text-xl text-gray-500 bg-white rounded-lg shadow-lg">
                    è«‹é»æ“Šé ‚éƒ¨ç¶ è‰²çš„ã€Œ+ æ–°å¢å ±åƒ¹å–®ã€é–‹å§‹è£½ä½œï¼Œæˆ–å¾ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡ä¸€ä»½ç¾æœ‰çš„å ±åƒ¹å–®ã€‚
                </p>
            )}
            
            {/* ===== å ±åƒ¹å–®é è¦½å€ (æ–°å¢åŠŸèƒ½) ===== */}
            {activeQuote && (
                <QuotePreview 
                    quote={activeQuote} 
                    companyData={COMPANY_DATA[company]} 
                />
            )}
            
        </div>
    );
}

// =======================================================
// Main Render
// =======================================================
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(
    <AppProvider>
        <App />
    </AppProvider>
);

</script>
