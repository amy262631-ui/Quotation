<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰- æœ€çµ‚æ•´åˆç‰ˆ</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom-server.browser.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body {
        font-family: "Microsoft JhengHei", sans-serif;
        background: #f4f4f4;
    }
    /* ç¢ºä¿åˆ—å°æ’ç‰ˆæ­£ç¢º */
    @media print {
        @page { size: A4; margin: 15mm; } 
        body { margin: 0; padding: 0; }
        .no-print { display: none; }
    }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

// =======================================================
// D1 â€” å…±ç”¨å·¥å…·å‡½å¼
// =======================================================
function uuid() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}

function formatMoney(num) {
    if (!num || isNaN(num)) return "0";
    return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 });
}

function calcAmount(item) {
    return Number(item.qty || 0) * Number(item.price || 0);
}

function calcTotal(items) {
    let sum = 0;
    items.forEach(i => {
        sum += calcAmount(i);
        if (i.subItems) {
            i.subItems.forEach(s => {
                if (s.type === "item") sum += calcAmount(s);
            });
        }
    });
    return sum;
}

function calcNegotiated(total, percent, customPrice) {
    const totalNum = Number(total) || 0;
    const customPriceNum = Number(customPrice) || 0;
    const percentNum = Number(percent) || 0;

    if (customPriceNum > 0) return customPriceNum;
    if (percentNum > 0) return Math.round(totalNum * (1 - percentNum / 100));
    return totalNum;
}


// =======================================================
// D2 â€” AppContextï¼ˆå…¬å¸è³‡æ–™ï¼‹å…¨åŸŸç‹€æ…‹ï¼‰
// =======================================================
const AppContext = React.createContext();

/* ä½ çš„å…¬å¸è³‡æ–™ï¼ˆå·²ä¿ç•™ä¸¦ä½¿ç”¨ä½ çš„è³‡æ–™ï¼‰*/
const COMPANY_DATA = {
    herhsin: {
        name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
        tel: "07-6521927",
        fax: "07-6517994",
        email: "affairs@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "https://amy262631-ui.github.io/Quotation/herhsin_stamp.JPG",
        prefix: "QH"
    },
    sinchang: {
        name: "è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸",
        tel: "07-6521927",
        fax: "07-6517994",
        email: "affairs@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "https://amy262631-ui.github.io/Quotation/sinchang_stamp.JPG",
        prefix: "QS"
    }
};

/* é è¨­å‚™è¨» */
const DEFAULT_NOTES = `1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚`;

/* é è¨­ä»˜æ¬¾æ¢ä»¶ */
const DEFAULT_PAYMENT = `è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%`;

/* å ±åƒ¹å–®ç·¨è™Ÿç”¢ç”Ÿå™¨ */
function generateQuoteNo(companyKey) {
    const prefix = COMPANY_DATA[companyKey]?.prefix || "Q";
    const d = new Date();
    const datePart =
        d.getFullYear().toString() +
        String(d.getMonth() + 1).padStart(2, "0") +
        String(d.getDate()).padStart(2, "0") +
        String(d.getHours()).padStart(2, "0") +
        String(d.getMinutes()).padStart(2, "0");
    const random = Math.floor(1000 + Math.random() * 9000);

    return `${prefix}${datePart}-${random}`;
}

// =======================================================
// D2 â€” AppProviderï¼ˆå« GoogleSheet è¼‰å…¥ï¼‰
// =======================================================
function AppProvider({ children }) {

    // é è¨­å…¬å¸ç‚º herhsin
    const [company, setCompany] = React.useState("herhsin"); 
    const [quotes, setQuotes] = React.useState([]);
    const [activeQuoteId, setActiveQuoteId] = React.useState(null);

    /* Google Sheet â€” ææ–™è¦æ ¼å“ */
    const [specItems, setSpecItems] = React.useState([]);

    const SPEC_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv";

    /* è®€å– localStorage */
    React.useEffect(() => {
        const saved = localStorage.getItem("HERHSIN_QUOTES");
        if (saved) {
            try {
                const arr = JSON.parse(saved);
                if (Array.isArray(arr)) {
                    setQuotes(arr);
                    if (arr.length > 0) setActiveQuoteId(arr[0].id);
                }
            } catch (err) {
                console.error("localStorage load error:", err);
            }
        }
    }, []);

    /* è‡ªå‹•å­˜å› localStorage */
    React.useEffect(() => {
        localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
    }, [quotes]);

    /* è¼‰å…¥ Google Sheet */
    React.useEffect(() => {
        async function loadSpec() {
            try {
                const res = await fetch(SPEC_URL);
                const text = await res.text();

                const rows = text.split("\n").map(r => r.trim()).filter(r => r.length);
                const header = rows[0].split(",").map(h => h.trim());

                const list = rows.slice(1).map(row => {
                    const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g); 
                    if (!cols) return null; 

                    const obj = {};
                    header.forEach((h, i) => {
                        let val = cols[i] || "";
                        val = val.replace(/^"|"$/g, "");
                        obj[h] = val.trim();
                    });
                    return obj;
                }).filter(Boolean);

                setSpecItems(list);
            } catch (err) {
                console.error("Google Sheet è¼‰å…¥éŒ¯èª¤ï¼š", err);
            }
        }

        loadSpec();
    }, []);

    /* æ–°å¢å ±åƒ¹å–® */
    const createQuote = () => {
        const newQuote = {
            id: uuid(),
            company, // ä½¿ç”¨ç•¶å‰é¸ä¸­çš„å…¬å¸
            quoteNo: generateQuoteNo(company),
            title: "æœªå‘½åå·¥ç¨‹",
            customerName: "",
            contact: "",
            phone: "",
            location: "",
            date: new Date().toISOString().substring(0, 10),
            items: [{
                id: uuid(),
                name: 'ç¤ºç¯„é …ç›®',
                specMain: 'ä¸»è¦æ ¼èªªæ˜',
                unit: 'å¼',
                qty: 1,
                price: 1000,
                remarks: '',
                specMaterial: '',
                specMaterial2: '',
                specMaterial3: '',
                subItems: []
            }],
            notes: DEFAULT_NOTES,
            payment: DEFAULT_PAYMENT,
            discountPercent: 0,
            negotiatedPrice: 0
        };

        setQuotes(prev => [newQuote, ...prev]);
        setActiveQuoteId(newQuote.id);
    };

    /* åˆªé™¤å ±åƒ¹å–® */
    const deleteQuote = (id) => {
        const newList = quotes.filter(q => q.id !== id);
        setQuotes(newList);

        if (activeQuoteId === id) {
            setActiveQuoteId(newList.length ? newList[0].id : null);
        }
    };

    /* æ›´æ–°å ±åƒ¹å–® */
    const updateQuote = (id, update) =>
        setQuotes(prev =>
            prev.map(q => (q.id === id ? { ...q, ...update } : q))
        );
    
    /* æ›´æ–°å ±åƒ¹å–®å“é … (Item) */
    const updateItem = (itemId, updates) => {
        if (!activeQuote) return;

        const newItems = activeQuote.items.map(item => 
            item.id === itemId ? { ...item, ...updates } : item
        );
        updateQuote(activeQuote.id, { items: newItems });
    };

    const activeQuote = quotes.find(q => q.id === activeQuoteId) || null;

    return (
        <AppContext.Provider
            value={{
                company,
                setCompany, // å°å‡º setCompany ä¾›åˆ‡æ›å™¨ä½¿ç”¨
                quotes,
                activeQuote,
                activeQuoteId,
                setActiveQuoteId,
                createQuote,
                deleteQuote,
                updateQuote,
                updateItem, // å°å‡ºæ›´æ–°å“é …å‡½æ•¸
                specItems,
                COMPANY_DATA
            }}
        >
            {children}
        </AppContext.Provider>
    );
}

// =======================================================
// C3 â€” å ±åƒ¹é …ç›®ç·¨è¼¯çµ„ä»¶ (æ–°å¢)
// =======================================================
function QuoteItemEditor({ item, updateItem, index }) {
    const { calcAmount } = React.useContext(AppContext);
    const itemAmount = calcAmount(item);

    const handleChange = (e) => {
        const { name, value, type } = e.target;
        const finalValue = type === 'number' ? Number(value) : value;
        updateItem(item.id, { [name]: finalValue });
    };

    return (
        <div className="bg-gray-50 p-3 mb-2 border rounded">
            <h4 className="font-semibold mb-2 text-sm text-gray-700">
                å“é … {index + 1} ({formatMoney(itemAmount)})
            </h4>
            <div className="grid grid-cols-6 gap-3 text-xs">
                <div>
                    <label className="block text-gray-500">å“å</label>
                    <input type="text" name="name" value={item.name || ''} onChange={handleChange}
                        className="w-full border px-2 py-1 rounded" />
                </div>
                <div>
                    <label className="block text-gray-500">è¦æ ¼</label>
                    <input type="text" name="specMain" value={item.specMain || ''} onChange={handleChange}
                        className="w-full border px-2 py-1 rounded" />
                </div>
                <div>
                    <label className="block text-gray-500">å–®ä½</label>
                    <input type="text" name="unit" value={item.unit || ''} onChange={handleChange}
                        className="w-full border px-2 py-1 rounded" />
                </div>
                <div>
                    <label className="block text-gray-500">æ•¸é‡</label>
                    <input type="number" name="qty" value={item.qty || 0} onChange={handleChange}
                        className="w-full border px-2 py-1 rounded" />
                </div>
                <div>
                    <label className="block text-gray-500">å–®åƒ¹</label>
                    <input type="number" name="price" value={item.price || 0} onChange={handleChange}
                        className="w-full border px-2 py-1 rounded" />
                </div>
                <div>
                    <label className="block text-gray-500">å‚™è¨»</label>
                    <input type="text" name="remarks" value={item.remarks || ''} onChange={handleChange}
                        className="w-full border px-2 py-1 rounded" />
                </div>
            </div>
            {/* ç°¡å–®åŠ å…¥åˆªé™¤æŒ‰éˆ• */}
            <button 
                onClick={() => {
                    const newItems = activeQuote.items.filter(i => i.id !== item.id);
                    updateQuote(activeQuote.id, { items: newItems });
                }}
                className="mt-2 text-red-500 hover:text-red-700 text-xs"
            >
                åˆªé™¤å“é …
            </button>
        </div>
    );
}

// =======================================================
// D7 â€” PrintLayoutï¼ˆåˆ—å° / PDF å°ˆç”¨ç‰ˆé¢çµ„ä»¶ï¼‰
// =======================================================
function PrintLayout({ quote, companyData }) {
    // å¼•å…¥ jspdf æ‰èƒ½ä½¿ç”¨ window.jspdf
    const jspdf = window.jspdf;
    
    if (!quote || !companyData) return <div style={{padding: '20px'}}>âš ï¸ å ±åƒ¹å–®æˆ–å…¬å¸è³‡æ–™ä¸å®Œæ•´</div>;

    // CSS å…§è¯æ¨£å¼å®šç¾©
    const td = {
        border: "1px solid #000",
        padding: "6px",
        fontSize: "13px",
        verticalAlign: "top",
        lineHeight: "1.4"
    };

    const tdCenter = { ...td, textAlign: "center" };
    const tdRight = { ...td, textAlign: "right" };
    const tdRightBold = { ...tdRight, fontWeight: "bold" };

    // è¨ˆç®—é‡‘é¡
    const totalAmount = calcTotal(quote.items);
    const negotiatedAmount = calcNegotiated(
        totalAmount,
        quote.discountPercent,
        quote.negotiatedPrice
    );

    return (
        <div style={{ padding: "20px", fontFamily: "Microsoft JhengHei, sans-serif" }}>

            {/* ===== æ¨™é¡Œ ===== */}
            <h2
                style={{
                    fontSize: "24px",
                    fontWeight: "bold",
                    textAlign: "center",
                    marginBottom: "20px"
                }}
            >
                å·¥ç¨‹å ±åƒ¹å–®
            </h2>

            {/* ===== åŸºæœ¬è³‡æ–™ ===== */}
            <table style={{ width: "100%", marginBottom: "15px" }}>
                <tbody>
                    <tr>
                        <td style={{ width: "50%", fontSize: "14px" }}>
                            <div><b>å·¥ç¨‹åç¨±ï¼š</b>{quote.title || 'N/A'}</div>
                            <div><b>å®¢æˆ¶åç¨±ï¼š</b>{quote.customerName || 'N/A'}</div>
                            <div><b>è¯çµ¡äººï¼š</b>{quote.contact || 'N/A'}</div>
                            <div><b>é€£çµ¡é›»è©±ï¼š</b>{quote.phone || 'N/A'}</div>
                            <div><b>å®‰è£åœ°é»ï¼š</b>{quote.location || 'N/A'}</div>
                        </td>

                        <td style={{ width: "50%", fontSize: "14px" }}>
                            <div><b>å ±åƒ¹å–®è™Ÿï¼š</b>{quote.quoteNo || 'N/A'}</div>
                            <div><b>æ—¥æœŸï¼š</b>{quote.date || 'N/A'}</div>
                            <div><b>å…¬å¸åç¨±ï¼š</b>{companyData.name}</div>
                            <div><b>å…¬å¸é›»è©±ï¼š</b>{companyData.tel}</div>
                            <div><b>åœ°å€ï¼š</b>{companyData.address}</div>
                        </td>
                    </tr>
                </tbody>
            </table>

            {/* ===== ä¸»è¡¨æ ¼ - å ±åƒ¹é …ç›®åˆ—è¡¨ ===== */}
            <table style={{ width: "100%", borderCollapse: "collapse" }}>
                <thead>
                    <tr>
                        <th style={tdCenter}>é …æ¬¡</th>
                        <th style={tdCenter}>å“å</th>
                        <th style={tdCenter}>è¦æ ¼</th>
                        <th style={tdCenter}>å–®ä½</th>
                        <th style={tdCenter}>æ•¸é‡</th>
                        <th style={tdCenter}>å–®åƒ¹</th>
                        <th style={tdCenter}>å°è¨ˆ</th>
                        <th style={tdCenter}>å‚™è¨»</th>
                    </tr>
                </thead>

                <tbody>

                    {(quote.items || []).map((item, idx) => {
                        const amount = calcAmount(item);
                        return (
                            <React.Fragment key={item.id}>
                                {/* ===== 1. ä¸»é … (Main Item) ===== */}
                                <tr>
                                    <td style={tdCenter}>{idx + 1}</td>
                                    <td style={td}>{item.name || ''}</td>
                                    <td style={td}>{item.specMain || ''}</td>
                                    <td style={tdCenter}>{item.unit || ''}</td>
                                    <td style={tdRight}>{item.qty || 0}</td>
                                    <td style={tdRight}>{formatMoney(item.price)}</td>
                                    <td style={tdRightBold}>{formatMoney(amount)}</td>
                                    <td style={td}>{item.remarks || ""}</td>
                                </tr>

                                {/* ===== 2. ç”¨æ–™ç´°é … (Materials) - æœ€å¤š 3 é … ===== */}
                                {[
                                    item.specMaterial,
                                    item.specMaterial2,
                                    item.specMaterial3
                                ].map((mat, i) =>
                                    mat ? (
                                        <tr key={`${item.id}_mat_${i}`}>
                                            <td style={tdCenter}>{`${idx + 1}-${i + 1}`}</td>
                                            <td colSpan="7" style={td}>
                                                <b>ç”¨æ–™ï¼š</b> {mat}
                                            </td>
                                        </tr>
                                    ) : null
                                )}

                                {/* ===== 3. è£œå……èªªæ˜ (SubItems - type: note) ===== */}
                                {(item.subItems || [])
                                    .filter(s => s.type === "note" && s.text)
                                    .map((s) => (
                                        <tr key={s.id + "_note"}>
                                            <td colSpan="8" style={{ ...td, background: "#f0f0f0" }}>
                                                <b>è£œå……èªªæ˜ï¼š</b> {s.text}
                                            </td>
                                        </tr>
                                    ))}

                                {/* ===== 4. è£œå……åœ–ç‰‡ (SubItems - type: image) ===== */}
                                {(item.subItems || [])
                                    .filter(s => s.type === "image" && s.url)
                                    .map((s) => (
                                        <tr key={s.id + "_img"}>
                                            <td colSpan="8" style={{ ...td, textAlign: "center", padding: '10px' }}>
                                                <img
                                                    src={s.url}
                                                    style={{
                                                        maxWidth: "320px",
                                                        height: 'auto',
                                                        border: "1px solid #ccc"
                                                    }}
                                                    alt="è£œå……åœ–ç‰‡"
                                                />
                                            </td>
                                        </tr>
                                    ))}

                            </React.Fragment>
                        );
                    })}

                    {/* ===== ç¸½è¨ˆè¡Œ ===== */}
                    <tr>
                        <td colSpan="7" style={tdRightBold}>ç¸½è¨ˆï¼ˆæœªç¨…ï¼‰</td>
                        <td style={tdRightBold}>{formatMoney(totalAmount)}</td>
                    </tr>

                    {/* ===== è­°åƒ¹å¾Œç¸½åƒ¹è¡Œ ===== */}
                    <tr>
                        <td colSpan="7" style={tdRightBold}>è­°åƒ¹å¾Œç¸½åƒ¹ï¼ˆæœªç¨…ï¼‰</td>
                        <td style={tdRightBold}>{formatMoney(negotiatedAmount)}</td>
                    </tr>

                </tbody>
            </table>

            {/* ===== å‚™è¨» + ä»˜æ¬¾æ¢ä»¶å€å¡Š ===== */}
            <table style={{ width: "100%", marginTop: "20px" }}>
                <tbody>
                    <tr>
                        <td style={{ width: "50%", fontSize: "14px", verticalAlign: "top" }}>
                            <b>å‚™è¨»ï¼š</b><br />
                            <pre style={{ whiteSpace: "pre-wrap", fontSize: "13px", margin: 0 }}>
                                {quote.notes}
                            </pre>
                        </td>

                        <td style={{ width: "50%", fontSize: "14px", verticalAlign: "top" }}>
                            <b>ä»˜æ¬¾æ¢ä»¶ï¼š</b><br />
                            <pre style={{ whiteSpace: "pre-wrap", fontSize: "13px", margin: 0 }}>
                                {quote.payment}
                            </pre>
                        </td>
                    </tr>
                </tbody>
            </table>

            {/* ===== å°ç«  + å®¢æˆ¶ç°½åå€å¡Š ===== */}
            <table style={{
                width: "100%",
                marginTop: "30px",
                borderCollapse: "collapse"
            }}>
                <tbody>
                    <tr>
                        {/* å…¬å¸å°ç«  */}
                        <td style={{
                            ...td,
                            width: "50%", 
                            height: "150px",
                            textAlign: "center"
                        }}>
                            <div style={{ fontWeight: "bold", marginBottom: "6px" }}>
                                æœ¬å…¬å¸è“‹ç« 
                            </div>
                            {companyData.stamp && (
                                <img
                                    src={companyData.stamp}
                                    style={{ width: "130px", marginTop: "10px" }}
                                    alt="å…¬å¸å°ç« "
                                />
                            )}
                        </td>

                        {/* å®¢æˆ¶å›ç°½ */}
                        <td style={{ 
                            ...td, 
                            width: "50%", 
                            height: "150px", 
                            fontSize: "14px" 
                        }}>
                            å®¢æˆ¶ç°½åï¼š__________________________<br /><br />
                            æ—¥æœŸï¼š______________________________
                        </td>
                    </tr>
                </tbody>
            </table>

        </div>
    );
}

// =======================================================
// D6 â€” åˆ—å° PrintButton
// =======================================================
function PrintButton() {
    const { activeQuote, COMPANY_DATA } = React.useContext(AppContext);
    
    const handlePrint = () => {
        if (!activeQuote) {
            alert("å°šæœªé¸æ“‡å ±åƒ¹å–®");
            return;
        }

        const companyData = COMPANY_DATA[activeQuote.company];
        if (!companyData) {
             alert("å…¬å¸è³‡æ–™éŒ¯èª¤ï¼Œç„¡æ³•åˆ—å°");
             return;
        }

        const win = window.open("", "_blank");
        if (!win) {
             alert("è«‹å…è¨±å½ˆå‡ºè¦–çª—ä»¥ä¾¿åˆ—å°");
             return;
        }
        
        win.document.write(`
            <html>
            <head>
                <title>å ±åƒ¹å–® ${activeQuote.quoteNo}</title>
                <style>
                    @page { size: A4; margin: 15mm; } 
                    body { 
                        margin: 0; 
                        padding: 0; 
                        font-family: "Microsoft JhengHei", "PingFang TC", sans-serif; 
                        color: #000;
                    }
                    table { page-break-inside: auto; }
                    tr    { page-break-inside: avoid; page-break-after: auto; }
                </style>
            </head>
            <body></body>
            </html>
        `);
        win.document.close();

        const container = win.document.createElement("div");
        win.document.body.appendChild(container);

        ReactDOM.render(<PrintLayout quote={activeQuote} companyData={companyData} />, container);

        setTimeout(() => {
            win.print();
        }, 500);
    };

    return (
        <button
            className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
            onClick={handlePrint}
        >
            ğŸ–¨ åˆ—å°å ±åƒ¹å–®
        </button>
    );
}


// =======================================================
// D6 â€” PDF ç”¢ç”Ÿ ExportPDFButton
// =======================================================
function ExportPDFButton() {
    const { activeQuote, COMPANY_DATA } = React.useContext(AppContext);
    
    const generatePDF = async () => {
        if (!activeQuote) {
            alert("è«‹å…ˆé¸æ“‡å ±åƒ¹å–®");
            return;
        }
        const companyData = COMPANY_DATA[activeQuote.company];
        // ç¢ºä¿ jspdf å’Œ html2canvas è¼‰å…¥
        const { jsPDF } = window.jspdf || {}; 
        
        if (typeof html2canvas === 'undefined' || typeof jsPDF === 'undefined') {
            alert("ç¼ºå°‘ html2canvas æˆ– jspdf åº«ï¼Œç„¡æ³•ç”Ÿæˆ PDF");
            return;
        }

        // 1. éš±è—æ¸²æŸ“å®¹å™¨
        const hidden = document.createElement("div");
        hidden.style.position = "fixed";
        hidden.style.top = "-9999px";
        hidden.style.left = "-9999px";
        hidden.style.width = "794px";
        hidden.style.fontFamily = "Microsoft JhengHei, sans-serif"; 
        document.body.appendChild(hidden);

        // 2. æ¸²æŸ“åˆ—å°ç‰ˆ
        ReactDOM.render(<PrintLayout quote={activeQuote} companyData={companyData} />, hidden);

        // 3. ç­‰å¾…æ¸²æŸ“å®Œæˆ
        await new Promise(res => setTimeout(res, 500));

        try {
             // 4. è½‰æ›ç‚º Canvas
            const canvas = await html2canvas(hidden, { 
                scale: 3,
                logging: false,
                useCORS: true
            }); 
            const img = canvas.toDataURL("image/png");

            // 5. å»ºç«‹ jsPDF å¯¦ä¾‹
            const pdf = new jsPDF("p", "mm", "a4");
            const pdfWidth = pdf.internal.pageSize.getWidth(); 
            const canvasWidth = canvas.width / 3; 
            const canvasHeight = canvas.height / 3;
            
            const pdfHeight = (canvasHeight * pdfWidth) / canvasWidth; 

            // 6. å°‡åœ–ç‰‡æ·»åŠ åˆ° PDF
            pdf.addImage(img, "PNG", 0, 0, pdfWidth, pdfHeight);
            pdf.save(`å ±åƒ¹å–®_${activeQuote.quoteNo}.pdf`);

        } catch (error) {
            console.error("ç”Ÿæˆ PDF å¤±æ•—:", error);
            alert("ç”Ÿæˆ PDF éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚");
        } finally {
            // 7. æ¸…ç†
            ReactDOM.unmountComponentAtNode(hidden);
            document.body.removeChild(hidden);
        }
    };

    return (
        <button
            className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
            onClick={generatePDF}
        >
            ğŸ“„ è½‰ PDF
        </button>
    );
}


// =======================================================
// D0 â€” Appï¼ˆä¸»è¦æ¸²æŸ“å…¥å£ï¼Œå·²æ¢å¾©å…¬å¸åˆ‡æ›å’Œç·¨è¼¯å€ï¼‰
// =======================================================
function App() {
    const { 
        company, 
        setCompany, 
        activeQuote, 
        createQuote, 
        updateQuote, 
        updateItem,
        deleteQuote,
        COMPANY_DATA
    } = React.useContext(AppContext);

    const companyKeys = Object.keys(COMPANY_DATA);

    const handleFieldChange = (e) => {
        const { name, value } = e.target;
        if (activeQuote) {
            updateQuote(activeQuote.id, { [name]: value });
        }
    };
    
    // ç¸½é‡‘é¡
    const totalAmount = activeQuote ? calcTotal(activeQuote.items) : 0;
    const negotiatedAmount = activeQuote ? calcNegotiated(
        totalAmount,
        activeQuote.discountPercent,
        activeQuote.negotiatedPrice
    ) : 0;
    
    // åˆªé™¤ç•¶å‰å ±åƒ¹å–®
    const handleDeleteCurrent = () => {
        if(confirm(`ç¢ºå®šè¦åˆªé™¤å ±åƒ¹å–® ${activeQuote.quoteNo} å—ï¼Ÿ`)) {
            deleteQuote(activeQuote.id);
        }
    }

    return (
        <div className="p-8">
            <h1 className="text-3xl font-bold mb-6">å·¥ç¨‹å ±åƒ¹ç³»çµ±</h1>

            {/* ===== é ‚éƒ¨åŠŸèƒ½å€ (å…¬å¸åˆ‡æ›, æ–°å¢, åˆ—å°, PDF) ===== */}
            <div className="no-print flex items-center justify-between bg-white p-4 rounded shadow mb-6">
                <div className="flex space-x-4 items-center">
                    <label className="font-medium text-lg">åˆ‡æ›å…¬å¸:</label>
                    <select 
                        value={company} 
                        onChange={(e) => setCompany(e.target.value)}
                        className="border border-gray-300 rounded p-2 text-lg"
                    >
                        {companyKeys.map(key => (
                            <option key={key} value={key}>{COMPANY_DATA[key].name}</option>
                        ))}
                    </select>
                </div>
                <div className="flex space-x-2">
                    <button
                        className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
                        onClick={createQuote}
                    >
                        + æ–°å¢å ±åƒ¹å–®
                    </button>
                    <PrintButton />
                    <ExportPDFButton />
                </div>
            </div>

            {activeQuote ? (
                <div className="bg-white p-6 rounded shadow">
                    {/* ===== å ±åƒ¹å–®åŸºæœ¬è³‡è¨Šç·¨è¼¯å€ ===== */}
                    <div className="mb-6 pb-4 border-b">
                        <div className="grid grid-cols-2 gap-4">
                            <input 
                                type="text" 
                                name="title" 
                                placeholder="å·¥ç¨‹åç¨±"
                                value={activeQuote.title}
                                onChange={handleFieldChange}
                                className="text-2xl font-bold border-b-2 p-1 col-span-2"
                            />
                            
                            <div className="grid grid-cols-2 gap-4">
                                <label className="flex items-center">å®¢æˆ¶åç¨±ï¼š
                                    <input type="text" name="customerName" value={activeQuote.customerName} onChange={handleFieldChange} className="border p-1 w-full ml-2"/>
                                </label>
                                <label className="flex items-center">è¯çµ¡äººï¼š
                                    <input type="text" name="contact" value={activeQuote.contact} onChange={handleFieldChange} className="border p-1 w-full ml-2"/>
                                </label>
                                <label className="flex items-center">é€£çµ¡é›»è©±ï¼š
                                    <input type="text" name="phone" value={activeQuote.phone} onChange={handleFieldChange} className="border p-1 w-full ml-2"/>
                                </label>
                                <label className="flex items-center">å®‰è£åœ°é»ï¼š
                                    <input type="text" name="location" value={activeQuote.location} onChange={handleFieldChange} className="border p-1 w-full ml-2"/>
                                </label>
                            </div>
                            
                            <div className="text-right">
                                <p>å ±åƒ¹å–®è™Ÿï¼š{activeQuote.quoteNo}</p>
                                <p>æ—¥æœŸï¼š
                                    <input type="date" name="date" value={activeQuote.date} onChange={handleFieldChange} className="border p-1"/>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    {/* ===== å ±åƒ¹å“é …åˆ—è¡¨ (å·²æ¢å¾©) ===== */}
                    <h3 className="text-xl font-semibold mb-3 border-b pb-2">å ±åƒ¹å“é … (å…± {activeQuote.items.length} é …)</h3>
                    {activeQuote.items.map((item, index) => (
                        <QuoteItemEditor 
                            key={item.id} 
                            item={item} 
                            updateItem={updateItem} 
                            index={index}
                        />
                    ))}

                    {/* æ–°å¢å“é …æŒ‰éˆ• */}
                    <button 
                        onClick={() => {
                            const newItem = {
                                id: uuid(),
                                name: '',
                                specMain: '',
                                unit: 'å¼',
                                qty: 1,
                                price: 0,
                                remarks: '',
                                specMaterial: '',
                                specMaterial2: '',
                                specMaterial3: '',
                                subItems: []
                            };
                            updateQuote(activeQuote.id, { items: [...activeQuote.items, newItem] });
                        }}
                        className="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 text-sm mt-3"
                    >
                        + æ–°å¢å“é …
                    </button>
                    
                    {/* ===== ç¸½çµå€ ===== */}
                    <div className="mt-8 pt-4 border-t-2 border-red-500 text-right">
                        <div className="text-lg font-medium">ç¸½è¨ˆï¼ˆæœªç¨…ï¼‰ï¼š<span className="text-red-600">{formatMoney(totalAmount)}</span> å…ƒ</div>
                        <div className="flex justify-end items-center mt-2 space-x-2">
                            <label>æŠ˜æ‰£ (%)ï¼š</label>
                            <input 
                                type="number" 
                                name="discountPercent"
                                value={activeQuote.discountPercent || 0}
                                onChange={handleFieldChange}
                                className="border p-1 w-20 text-right"
                            />
                            <label>è­°åƒ¹å¾Œç¸½åƒ¹ï¼š</label>
                            <input 
                                type="number" 
                                name="negotiatedPrice"
                                value={activeQuote.negotiatedPrice || 0}
                                onChange={handleFieldChange}
                                className="border p-1 w-32 text-right font-bold text-red-700"
                            />
                            <span className="text-lg font-bold">({formatMoney(negotiatedAmount)}) å…ƒ</span>
                        </div>
                    </div>

                    {/* ===== å‚™è¨»/ä»˜æ¬¾æ¢ä»¶ç·¨è¼¯ ===== */}
                    <div className="grid grid-cols-2 gap-6 mt-6">
                        <div>
                            <h4 className="font-semibold mb-2">å‚™è¨»ï¼š</h4>
                            <textarea 
                                name="notes" 
                                value={activeQuote.notes} 
                                onChange={handleFieldChange} 
                                rows="6" 
                                className="w-full border p-2"
                            ></textarea>
                        </div>
                         <div>
                            <h4 className="font-semibold mb-2">ä»˜æ¬¾æ¢ä»¶ï¼š</h4>
                            <textarea 
                                name="payment" 
                                value={activeQuote.payment} 
                                onChange={handleFieldChange} 
                                rows="6" 
                                className="w-full border p-2"
                            ></textarea>
                        </div>
                    </div>
                    
                    <button 
                        onClick={handleDeleteCurrent}
                        className="mt-6 bg-red-100 text-red-600 px-4 py-2 rounded hover:bg-red-200"
                    >
                        ğŸ—‘ åˆªé™¤æ­¤å ±åƒ¹å–®
                    </button>

                </div>
            ) : (
                <p className="p-6 text-center text-gray-500 bg-white rounded shadow">
                    è«‹é»æ“Šé ‚éƒ¨ç¶ è‰²çš„ã€Œ+ æ–°å¢å ±åƒ¹å–®ã€é–‹å§‹è£½ä½œï¼Œæˆ–å¾å·¦å´é¸å–®é¸æ“‡ä¸€ä»½ç¾æœ‰çš„å ±åƒ¹å–®ã€‚
                </p>
            )}
            
        </div>
    );
}

// =======================================================
// Main Render
// =======================================================
ReactDOM.render(
    <AppProvider>
        <App />
    </AppProvider>,
    document.getElementById("root")
);

</script>
</body>
</html>
