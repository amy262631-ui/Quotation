<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰- æœ€çµ‚å®Œæ•´ç‰ˆ</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
    body {
        font-family: "Microsoft JhengHei", sans-serif;
        background: #f4f4f4;
    }
    /* ç¢ºä¿åˆ—å°æ’ç‰ˆæ­£ç¢º */
    @media print {
        @page { size: A4; margin: 15mm; } 
        body { margin: 0; padding: 0; }
        .no-print { display: none; }
    }
</style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">

// =======================================================
// D1 â€” å…±ç”¨å·¥å…·å‡½å¼
// =======================================================
function uuid() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}

function formatMoney(num) {
    if (!num || isNaN(num)) return "0";
    // ç¢ºä¿åªé¡¯ç¤ºæ•´æ•¸
    return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 }); 
}

function calcAmount(item) {
    return Number(item?.qty || 0) * Number(item?.price || 0);
}

function calcTotal(items) {
    let sum = 0;
    items.forEach(i => {
        sum += calcAmount(i);
        // ä¸è¨ˆç®— subItems çš„é‡‘é¡ï¼Œåªè¨ˆç®—ä¸»é …ç›®
    });
    return sum;
}

function calcNegotiated(total, percent, customPrice) {
    const totalNum = Number(total) || 0;
    const customPriceNum = Number(customPrice) || 0;
    const percentNum = Number(percent) || 0;

    if (customPriceNum > 0) return customPriceNum;
    if (percentNum > 0) return Math.round(totalNum * (1 - percentNum / 100));
    return totalNum;
}


// =======================================================
// D2 â€” AppContextï¼ˆå…¬å¸è³‡æ–™ï¼‹å…¨åŸŸç‹€æ…‹ï¼‰
// =======================================================
const AppContext = React.createContext();

/* ä½ çš„å…¬å¸è³‡æ–™ */
const COMPANY_DATA = {
    herhsin: {
        name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
        tel: "07-6521927",
        fax: "07-6517994",
        email: "affairs@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "https://amy262631-ui.github.io/Quotation/herhsin_stamp.JPG",
        prefix: "QH"
    },
    sinchang: {
        name: "è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸",
        tel: "07-6521927",
        fax: "07-6517994",
        email: "affairs@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "https://amy262631-ui.github.io/Quotation/sinchang_stamp.JPG",
        prefix: "QS"
    }
};

/* é è¨­å‚™è¨» */
const DEFAULT_NOTES = `1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚`;

/* é è¨­ä»˜æ¬¾æ¢ä»¶ */
const DEFAULT_PAYMENT = `è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%`;

/* å ±åƒ¹å–®ç·¨è™Ÿç”¢ç”Ÿå™¨ */
function generateQuoteNo(companyKey) {
    const prefix = COMPANY_DATA[companyKey]?.prefix || "Q";
    const d = new Date();
    const datePart =
        d.getFullYear().toString() +
        String(d.getMonth() + 1).padStart(2, "0") +
        String(d.getDate()).padStart(2, "0") +
        String(d.getHours()).padStart(2, "0") +
        String(d.getMinutes()).padStart(2, "0");
    const random = Math.floor(1000 + Math.random() * 9000);

    return `${prefix}${datePart}-${random}`;
}

// =======================================================
// D2 â€” AppProviderï¼ˆå« GoogleSheet è¼‰å…¥ - æœ€çµ‚å¼·åŒ–è§£æï¼‰
// =======================================================
function AppProvider({ children }) {

    const [company, setCompany] = React.useState("herhsin"); 
    const [quotes, setQuotes] = React.useState([]);
    const [activeQuoteId, setActiveQuoteId] = React.useState(null);

    /* Google Sheet â€” ææ–™è¦æ ¼å“ */
    const [specItems, setSpecItems] = React.useState([]);
    const [isLoadingSpecs, setIsLoadingSpecs] = React.useState(true); 

    // æ‚¨çš„ Google Sheet å…¬é–‹ CSV é€£çµ
    const SPEC_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv";

    // ... (localStorage è®€å–å’Œå¯«å…¥é‚è¼¯ä¿æŒä¸è®Š) ...
    /* è®€å– localStorage */
    React.useEffect(() => {
        const saved = localStorage.getItem("HERHSIN_QUOTES");
        if (saved) {
            try {
                const arr = JSON.parse(saved);
                if (Array.isArray(arr)) {
                    setQuotes(arr);
                    const lastActiveId = localStorage.getItem("HERHSIN_ACTIVE_QUOTE_ID");
                    const initialActiveId = arr.some(q => q.id === lastActiveId) ? lastActiveId : (arr.length > 0 ? arr[0].id : null);
                    setActiveQuoteId(initialActiveId);
                }
            } catch (err) {
                console.error("localStorage load error:", err);
            }
        }
    }, []);

    /* è‡ªå‹•å­˜å› localStorage */
    React.useEffect(() => {
        localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
        localStorage.setItem("HERHSIN_ACTIVE_QUOTE_ID", activeQuoteId);
    }, [quotes, activeQuoteId]);


    /* è¼‰å…¥ Google Sheet (ä½¿ç”¨æ›´ç©©å®šçš„è§£ææ–¹æ³•) */
    React.useEffect(() => {
        async function loadSpec() {
            setIsLoadingSpecs(true);
            try {
                // 1. å–å¾— CSV æ–‡æœ¬
                // ä¿®æ­£ï¼šæ˜ç¢ºè¨­å®š redirect ç‚º 'follow'ï¼Œç¢ºä¿èƒ½æ­£ç¢ºè·Ÿéš¨ 307 è·³è½‰
                const res = await fetch(SPEC_URL, { redirect: 'follow' }); 

                if (!res.ok) {
                    // å¦‚æœ Status ä»ç„¶ä¸æ˜¯ 200ï¼Œä¸”ä¸æ˜¯ 307ï¼Œå‰‡æ‹‹å‡ºéŒ¯èª¤
                    throw new Error(`HTTP éŒ¯èª¤! Status: ${res.status}`);
                }
                const text = await res.text();

                // 2. å¼·åŒ–è™•ç†ï¼šæ›¿æ›æ‰€æœ‰æ›è¡Œç¬¦ï¼Œç¢ºä¿è³‡æ–™è¡Œä¸æœƒè¢«éŒ¯èª¤åˆ†å‰²
                // ç”±æ–¼ Google Sheet CSV æœƒç”¨é›™å¼•è™ŸåŒ…è£¹åŒ…å«æ›è¡Œçš„å…§å®¹ï¼Œ
                // æˆ‘å€‘å¿…é ˆå…ˆè™•ç†é€™ç¨®æƒ…æ³ï¼Œé¿å…å–®ç¨æ›¿æ›æ‰€æœ‰ \n 
                
                // 3. æ¬„ä½æ˜ å°„
                const headerMap = {
                    "å“å": "name",
                    "å–®ä½": "unit",
                    "å–®åƒ¹": "price",
                    "è¦æ ¼": "specMain",
                    "ç”¨æ–™1": "specMaterial",
                    "ç”¨æ–™2": "specMaterial2",
                    "ç”¨æ–™3": "specMaterial3",
                };
                const expectedColNames = Object.keys(headerMap);


                // 4. ä½¿ç”¨ä¸€å€‹æ›´å¼·å¥çš„ CSV è§£æç®—æ³• (é€™æ˜¯æœ¬æ¬¡ä¿®æ­£çš„æ ¸å¿ƒ)
                function parseCSV(csvText, expectedHeaders) {
                    const list = [];
                    // ç§»é™¤æ‰€æœ‰ Windows æ›è¡Œç¬¦ \r ä»¥ç°¡åŒ–è™•ç†
                    const cleanText = csvText.replace(/\r/g, ''); 
                    
                    // æ­£å‰‡è¡¨é”å¼ï¼šåŒ¹é… CSV æ¬„ä½ï¼Œè™•ç†é›™å¼•è™Ÿå…§åŒ…å«é€—è™Ÿæˆ–æ›è¡Œ
                    const regex = /(?:"([^"]*(?:""[^"]*)*)"|([^,]*))(?:,|$)/g;

                    const rows = cleanText.split('\n').filter(r => r.trim().length > 0);
                    if (rows.length < 1) return [];

                    // å–å¾—ä¸¦æ¸…æ´—æ¨™é¡Œ
                    const headerRow = rows[0];
                    let headers = [];
                    let match;
                    let tempRow = headerRow;

                    while ((match = regex.exec(tempRow)) !== null) {
                        // match[1] æ˜¯å¼•è™Ÿå…§çš„å…§å®¹ (å·²è™•ç†å¼•è™Ÿ)
                        // match[2] æ˜¯éå¼•è™Ÿçš„å…§å®¹
                        let field = match[1] !== undefined ? match[1].replace(/""/g, '"') : match[2];
                        headers.push(field ? field.trim().replace(/"/g, '') : '');
                    }
                    
                    const expectedColCount = expectedHeaders.length;
                    
                    if (headers.length < expectedColCount || !expectedHeaders.every(h => headers.includes(h))) {
                        console.error("âŒ CSV æ¨™é¡ŒéŒ¯èª¤æˆ–æ¬„ä½æ•¸ä¸åŒ¹é…ï¼è«‹ç¢ºä¿ç¬¬ä¸€è¡Œç‚ºï¼š", expectedHeaders.join(', '));
                        console.error("å¯¦éš›è®€å–åˆ°çš„æ¨™é¡Œï¼š", headers.join(', '));
                        return [];
                    }

                    // é–‹å§‹è§£æè³‡æ–™è¡Œ
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row.trim()) continue;

                        const fields = [];
                        let cursor = 0;
                        while ((match = regex.exec(row.substring(cursor))) !== null) {
                            cursor += match[0].length;
                            // ç²å–æ¬„ä½å€¼
                            let field = match[1] !== undefined ? match[1].replace(/""/g, '"') : match[2];
                            fields.push(field ? field.trim().replace(/"/g, '') : '');
                            
                            // æª¢æŸ¥æ˜¯å¦åˆ°é”è¡Œå°¾ï¼Œå¦‚æœåŒ¹é…é•·åº¦ç‚º 0 ä¸”ä»æœªåˆ°è¡Œå°¾ï¼Œå‰‡è·³å‡ºé¿å…ç„¡é™å¾ªç’° (æˆ–è™•ç†ç©ºæ¬„ä½)
                            if (match[0].length === 0 && cursor < row.length) {
                                cursor++; 
                            }
                        }
                        
                        // ä¿®æ­£ï¼šè£œé½Šè¡Œå°¾ç©ºæ¬„ä½
                        while (fields.length < headers.length) {
                            fields.push('');
                        }


                        if (fields.length !== headers.length) {
                            console.warn(`è­¦å‘Š: ç¬¬ ${i + 1} è¡Œæ¬„ä½æ•¸é‡ä¸åŒ¹é… (é æœŸ:${headers.length}, å¯¦éš›:${fields.length})ï¼Œå·²è·³éã€‚åŸå§‹è¡Œï¼š${row.substring(0, 50)}...`);
                            continue;
                        }

                        const obj = {};
                        headers.forEach((h, j) => {
                            const propName = headerMap[h] || h; 
                            obj[propName] = fields[j];
                        });
                        
                        // è½‰æ›å–®åƒ¹ç‚ºæ•¸å­—
                        obj.price = Number(obj.price) || 0;
                        if (obj.name) {
                            list.push(obj);
                        }
                    }

                    return list;
                }

                const list = parseCSV(text, expectedColNames);
                
                if (list.length === 0 && !isLoadingSpecs) {
                     // å¦‚æœè§£æå¾Œåˆ—è¡¨ç‚ºç©ºï¼Œä¸”ä¸æ˜¯å› ç‚ºè¼‰å…¥éŒ¯èª¤ï¼Œå‰‡å¯èƒ½æ˜¯æ ¼å¼å•é¡Œ
                     alert("Google Sheet è¼‰å…¥æˆåŠŸï¼Œä½†è§£æå¾Œæ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å“é …è³‡æ–™ï¼Œè«‹æª¢æŸ¥è¡¨æ ¼å…§å®¹å’Œæ ¼å¼ã€‚");
                }

                setSpecItems(list);
                console.log(`âœ… Google Sheet è³‡æ–™è¼‰å…¥æˆåŠŸï¼å…± ${list.length} ç­†é …ç›®ã€‚`);

            } catch (err) {
                console.error("âŒ Google Sheet è¼‰å…¥æˆ–è§£æéŒ¯èª¤ï¼š", err);
                alert("ç„¡æ³•è¼‰å…¥ Google Sheet è³‡æ–™ï¼Œè«‹æª¢æŸ¥ï¼š1. æ‚¨çš„ç¶²è·¯é€£ç·šï¼› 2. Google Sheet é€£çµæ˜¯å¦æ­£ç¢ºä¸”å·²å…¬é–‹ 'ç™¼å¸ƒåˆ°ç¶²è·¯'ã€‚");
            } finally {
                setIsLoadingSpecs(false);
            }
        }

        loadSpec();
    }, []);

    // ... (å…¶é¤˜å‡½æ•¸ createQuote, deleteQuote, updateQuote, updateItem, activeQuote ä¿æŒä¸è®Š) ...
    /* æ–°å¢å ±åƒ¹å–® */
    const createQuote = () => {
        const newQuote = {
            id: uuid(),
            company, 
            quoteNo: generateQuoteNo(company),
            title: "æœªå‘½åå·¥ç¨‹",
            customerName: "",
            contact: "",
            phone: "",
            location: "",
            date: new Date().toISOString().substring(0, 10),
            items: [{
                id: uuid(),
                name: '',
                specMain: '',
                unit: 'å¼',
                qty: 1,
                price: 0,
                remarks: '',
                specMaterial: '',
                specMaterial2: '',
                specMaterial3: '',
                subItems: []
            }],
            notes: DEFAULT_NOTES,
            payment: DEFAULT_PAYMENT,
            discountPercent: 0,
            negotiatedPrice: 0
        };

        setQuotes(prev => [newQuote, ...prev]);
        setActiveQuoteId(newQuote.id);
    };

    /* åˆªé™¤å ±åƒ¹å–® */
    const deleteQuote = (id) => {
        const newList = quotes.filter(q => q.id !== id);
        setQuotes(newList);

        if (activeQuoteId === id) {
            setActiveQuoteId(newList.length ? newList[0].id : null);
        }
    };

    /* æ›´æ–°å ±åƒ¹å–® */
    const updateQuote = (id, update) =>
        setQuotes(prev =>
            prev.map(q => (q.id === id ? { ...q, ...update } : q))
        );
    
    /* æ›´æ–°å ±åƒ¹å–®å“é … (Item) */
    const updateItem = (itemId, updates) => {
        if (!activeQuote) return;

        const newItems = activeQuote.items.map(item => 
            item.id === itemId ? { ...item, ...updates } : item
        );
        updateQuote(activeQuote.id, { items: newItems });
    };

    const activeQuote = quotes.find(q => q.id === activeQuoteId) || null;


    return (
        <AppContext.Provider
            value={{
                company,
                setCompany, 
                quotes,
                activeQuote,
                activeQuoteId,
                setActiveQuoteId,
                createQuote,
                deleteQuote,
                updateQuote,
                updateItem, 
                specItems, 
                isLoadingSpecs, 
                COMPANY_DATA
            }}
        >
            {children}
        </AppContext.Provider>
    );
}

// =======================================================
// C3 â€” å ±åƒ¹é …ç›®ç·¨è¼¯çµ„ä»¶ (Autocomplete/åœ–ç‰‡ä¸Šå‚³/ç”¨æ–™é¡¯ç¤ºå„ªåŒ–)
// =======================================================
function QuoteItemEditor({ item, updateItem, index, activeQuote, updateQuote }) {
    const { specItems } = React.useContext(AppContext);

    const [searchTerm, setSearchTerm] = React.useState(item.name || '');
    const [suggestions, setSuggestions] = React.useState([]);

    const itemAmount = calcAmount(item); 

    React.useEffect(() => {
        if (item.name !== searchTerm) {
            setSearchTerm(item.name || '');
        }
    }, [item.name]);

    const inputRef = React.useRef(null);

    // ç¯©é¸é‚è¼¯ï¼šåªè¦å“ååŒ…å«è¼¸å…¥æ–‡å­—ï¼Œå³é¡¯ç¤ºå»ºè­°æ¸…å–®
    const handleFilterSuggestions = (value) => {
        if (!value.trim()) {
            setSuggestions([]);
            return;
        }

        const lowerValue = value.toLowerCase();

        // ç¯©é¸ï¼šåŒ¹é…å“ååŒ…å«è¼¸å…¥æ–‡å­—çš„æ‰€æœ‰é …ç›®
        const filtered = specItems.filter(spec => 
            spec.name && spec.name.toLowerCase().includes(lowerValue)
        );

        // æ’åºï¼šè®“ä»¥è¼¸å…¥æ–‡å­—é–‹é ­çš„é …ç›®å„ªå…ˆé¡¯ç¤º
        const sorted = filtered.sort((a, b) => {
            const aStarts = a.name.toLowerCase().startsWith(lowerValue);
            const bStarts = b.name.toLowerCase().startsWith(lowerValue);
            if (aStarts && !bStarts) return -1;
            if (!aStarts && bStarts) return 1;
            return a.name.localeCompare(b.name);
        });

        setSuggestions(sorted.slice(0, 10)); // åªé¡¯ç¤ºå‰ 10 ç­†
    }

    const handleChange = (e) => {
        const { name, value, type } = e.target;
        
        if (name === 'name') {
            setSearchTerm(value);
            updateItem(item.id, { [name]: value });
            handleFilterSuggestions(value); // æ¯æ¬¡è¼¸å…¥éƒ½ç¯©é¸
        } else {
            const finalValue = type === 'number' ? Number(value) : value; 
            updateItem(item.id, { [name]: finalValue });
        }
    };

    // è™•ç†é¸æ“‡å»ºè­° (é‡é»ï¼šè‡ªå‹•å¸¶å…¥è¦æ ¼ã€å–®ä½ã€å–®åƒ¹ã€ç”¨æ–™)
    const handleSelectSuggestion = (suggestion) => {
        // 1. æ›´æ–°è¼¸å…¥æ¡†
        setSearchTerm(suggestion.name);
        setSuggestions([]); 

        // 2. è‡ªå‹•ä»£å…¥æ‰€æœ‰æ¬„ä½
        updateItem(item.id, {
            name: suggestion.name,
            unit: suggestion.unit || 'å¼',
            price: Number(suggestion.price) || 0, 
            specMain: suggestion.specMain || '',
            specMaterial: suggestion.specMaterial || '',
            specMaterial2: suggestion.specMaterial2 || '',
            specMaterial3: suggestion.specMaterial3 || '',
        });
        
        // ç¢ºä¿è¼¸å…¥æ¡†å¤±å»ç„¦é»
        if (inputRef.current) {
             inputRef.current.blur();
             setTimeout(() => setSuggestions([]), 10);
        }
    };
    
    // è™•ç†åœ–ç‰‡ä¸Šå‚³
    const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onloadend = () => {
                const newImageSubItem = {
                    id: uuid(),
                    type: 'image',
                    url: reader.result, 
                    text: file.name
                };

                const newSubItems = [...(item.subItems || []), newImageSubItem];
                updateItem(item.id, { subItems: newSubItems });
            };
            reader.readAsDataURL(file);
        } else if (file) {
            alert("è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆã€‚");
        }
        e.target.value = null; 
    };
    
    // åˆªé™¤åœ–ç‰‡
    const handleDeleteImage = (imgId) => {
        const newSubItems = (item.subItems || []).filter(s => s.id !== imgId);
        updateItem(item.id, { subItems: newSubItems });
    };

    const existingImages = (item.subItems || []).filter(s => s.type === 'image');


    return (
        <div className="bg-gray-50 p-5 mb-4 border rounded relative">
            <h4 className="font-semibold mb-3 text-lg text-gray-700">
                å“é … {index + 1} (å°è¨ˆ: {formatMoney(itemAmount)} å…ƒ)
            </h4>
            
            {/* 1. ä¸»è¦ç·¨è¼¯æ¬„ä½ */}
            <div className="grid grid-cols-6 gap-4 text-base">
                
                {/* å“åè¼¸å…¥æ¡† - å…·å‚™è‡ªå‹•å®ŒæˆåŠŸèƒ½ */}
                <div className="relative">
                    <label className="block text-gray-600 mb-1">å“å</label>
                    <input 
                        ref={inputRef}
                        type="text" 
                        name="name" 
                        value={searchTerm} 
                        onChange={handleChange}
                        onBlur={() => {
                            // å»¶é²éš±è—ï¼Œçµ¦äºˆæ™‚é–“é»æ“Šå»ºè­°
                            setTimeout(() => setSuggestions([]), 200);
                        }}
                        onFocus={() => handleFilterSuggestions(searchTerm)} // èšç„¦æ™‚ä¹Ÿè§¸ç™¼ä¸€æ¬¡ç¯©é¸
                        className="w-full border px-3 py-2 rounded focus:ring-blue-500 focus:border-blue-500" 
                        autoComplete="off"
                    />

                    {/* è‡ªå‹•å®Œæˆä¸‹æ‹‰é¸å–® */}
                    {suggestions.length > 0 && (
                        <div 
                            className="absolute z-10 w-96 mt-1 bg-white border border-gray-300 rounded shadow-lg max-h-60 overflow-y-auto"
                        >
                            {suggestions.map((suggestion, idx) => (
                                <div 
                                    key={idx} 
                                    onMouseDown={(e) => { // ä½¿ç”¨ onMouseDown é¿å… onBlur è§¸ç™¼å°è‡´ç„¡æ³•é»æ“Š
                                        e.preventDefault(); 
                                        handleSelectSuggestion(suggestion);
                                    }}
                                    className="p-3 cursor-pointer hover:bg-blue-100 text-gray-800"
                                >
                                    {/* é¡¯ç¤ºå“åã€è¦æ ¼ã€å–®ä½ã€å–®åƒ¹ */}
                                    <div className="font-bold">{suggestion.name}</div>
                                    <div className="text-gray-500 text-sm">
                                        è¦æ ¼: {suggestion.specMain || 'N/A'} | å–®ä½: {suggestion.unit || 'å¼'} | å–®åƒ¹: {formatMoney(suggestion.price)}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                {/* å…¶ä»–æ¬„ä½ */}
                <div>
                    <label className="block text-gray-600 mb-1">è¦æ ¼</label>
                    <input type="text" name="specMain" value={item.specMain || ''} onChange={handleChange}
                        className="w-full border px-3 py-2 rounded" />
                </div>
                <div>
                    <label className="block text-gray-600 mb-1">å–®ä½</label>
                    <input type="text" name="unit" value={item.unit || ''} onChange={handleChange}
                        className="w-full border px-3 py-2 rounded" />
                </div>
                <div>
                    <label className="block text-gray-600 mb-1">æ•¸é‡</label>
                    <input type="number" name="qty" value={item.qty || 0} onChange={handleChange}
                        className="w-full border px-3 py-2 rounded" />
                </div>
                <div>
                    <label className="block text-gray-600 mb-1">å–®åƒ¹</label>
                    <input type="number" name="price" value={item.price || 0} onChange={handleChange}
                        className="w-full border px-3 py-2 rounded" />
                </div>
                <div>
                    <label className="block text-gray-600 mb-1">å‚™è¨»</label>
                    <input type="text" name="remarks" value={item.remarks || ''} onChange={handleChange}
                        className="w-full border px-3 py-2 rounded" />
                </div>
            </div>
            
            {/* 2. ç”¨æ–™ 1-3 é¡¯ç¤ºå€ */}
             <div className="col-span-6 mt-4 pt-3 border-t text-sm text-gray-700">
                <span className="mr-6 font-semibold">ç”¨æ–™ 1:</span> {item.specMaterial || 'N/A'}
                <span className="ml-6 mr-6 font-semibold">ç”¨æ–™ 2:</span> {item.specMaterial2 || 'N/A'}
                <span className="ml-6 mr-6 font-semibold">ç”¨æ–™ 3:</span> {item.specMaterial3 || 'N/A'}
            </div>
            
            {/* 3. åœ–ç‰‡ä¸Šå‚³èˆ‡ç®¡ç†å€ */}
            <div className="mt-4 pt-3 border-t">
                <h5 className="font-semibold text-base mb-2 text-gray-700">è£œå……åœ–ç‰‡ (å°‡é¡¯ç¤ºåœ¨åˆ—å°é é¢):</h5>
                <div className="flex flex-wrap items-center space-x-3">
                    {/* åœ–ç‰‡ä¸Šå‚³æŒ‰éˆ• */}
                    <label className="cursor-pointer bg-blue-100 text-blue-700 px-4 py-2 rounded hover:bg-blue-200 text-base transition duration-150">
                        + æ–°å¢åœ–ç‰‡ (å¾é›»è…¦)
                        <input 
                            type="file" 
                            accept="image/*" 
                            onChange={handleImageUpload} 
                            className="hidden"
                        />
                    </label>
                    
                    {/* é¡¯ç¤ºå’Œåˆªé™¤ç¾æœ‰åœ–ç‰‡ */}
                    {existingImages
                        .map(img => (
                            <div key={img.id} className="relative group mt-2">
                                <img 
                                    src={img.url} 
                                    alt={img.text} 
                                    className="w-20 h-20 object-cover border rounded shadow cursor-pointer"
                                    title={`é»æ“Šåˆªé™¤: ${img.text}`}
                                    onClick={() => handleDeleteImage(img.id)}
                                />
                                <button 
                                    onClick={(e) => { e.stopPropagation(); handleDeleteImage(img.id); }}
                                    className="absolute top-[-5px] right-[-5px] bg-red-600 text-white rounded-full w-5 h-5 text-sm flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-150 shadow-md"
                                    title="åˆªé™¤åœ–ç‰‡"
                                >
                                    &times;
                                </button>
                            </div>
                        ))}
                </div>
            </div>

            {/* åˆªé™¤å“é …æŒ‰éˆ• */}
            <button 
                onClick={() => {
                    const newItems = activeQuote.items.filter(i => i.id !== item.id);
                    updateQuote(activeQuote.id, { items: newItems });
                }}
                className="mt-4 text-red-500 hover:text-red-700 text-sm"
            >
                ğŸ—‘ åˆªé™¤æ­¤å“é …
            </button>
        </div>
    );
}

// =======================================================
// D3 â€” å ±åƒ¹å–®é è¦½çµ„ä»¶
// =======================================================
function QuotePreview({ quote, companyData }) {
    if (!quote) return null;
    return (
        <div className="mt-12 pt-8 border-t-4 border-gray-300">
            <h2 className="text-3xl font-bold mb-8 text-center text-gray-800">å ±åƒ¹å–®é è¦½ (åˆ—å°ç‰ˆé¢)</h2>
            {/* åˆ—å°ç‰ˆé¢å®¹å™¨ï¼Œé™åˆ¶å¯¬åº¦ä»¥æ¨¡æ“¬ A4 ç´™å¼µ */}
            <div className="bg-white p-6 shadow-2xl mx-auto max-w-4xl border border-gray-200"> 
                <PrintLayout quote={quote} companyData={companyData} />
            </div>
        </div>
    );
}


// =======================================================
// D7 â€” PrintLayout (åˆ—å°/é è¦½ç‰ˆé¢ - åœ–ç‰‡ç½®ä¸­ä¿®æ­£æ–¼æ­¤)
// =======================================================
function PrintLayout({ quote, companyData }) {
    
    if (!quote || !companyData) return <div style={{padding: '20px', fontSize: '16px'}}>âš ï¸ å ±åƒ¹å–®æˆ–å…¬å¸è³‡æ–™ä¸å®Œæ•´</div>;

    const td = {
        border: "1px solid #000",
        padding: "8px", 
        fontSize: "14px", 
        verticalAlign: "top",
        lineHeight: "1.5"
    };

    const tdCenter = { ...td, textAlign: "center" };
    const tdRight = { ...td, textAlign: "right" };
    const tdRightBold = { ...tdRight, fontWeight: "bold" };

    const totalAmount = calcTotal(quote.items);
    const negotiatedAmount = calcNegotiated(
        totalAmount,
        quote.discountPercent,
        quote.negotiatedPrice
    );
    
    // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºè­°åƒ¹å¾Œç¸½åƒ¹æ¬„ä½ (å¤§æ–¼ 0 æ‰é¡¯ç¤º)
    const showNegotiatedRow = Number(quote.discountPercent) > 0 || Number(quote.negotiatedPrice) > 0;

    return (
        <div style={{ padding: "10px", fontFamily: "Microsoft JhengHei, sans-serif" }}>

            {/* ğŸŒŸ 1. å…¬å¸å…¨åç¨±ç½®ä¸­é¡¯ç¤º */}
            <h1 
                style={{
                    fontSize: "28px", 
                    fontWeight: "bold",
                    textAlign: "center",
                    marginBottom: "5px" 
                }}
            >
                {companyData.name}
            </h1>
            
            <h2
                style={{
                    fontSize: "26px", 
                    fontWeight: "bold",
                    textAlign: "center",
                    marginBottom: "25px" 
                }}
            >
                å·¥ç¨‹å ±åƒ¹å–®
            </h2>

            <table style={{ width: "100%", marginBottom: "20px" }}>
                <tbody>
                    <tr>
                        <td style={{ width: "50%", fontSize: "15px", padding: '5px 0' }}>
                            <div><b>å·¥ç¨‹åç¨±ï¼š</b>{quote.title || 'N/A'}</div>
                            <div><b>å®¢æˆ¶åç¨±ï¼š</b>{quote.customerName || 'N/A'}</div>
                            <div><b>è¯çµ¡äººï¼š</b>{quote.contact || 'N/A'}</div>
                            <div><b>é€£çµ¡é›»è©±ï¼š</b>{quote.phone || 'N/A'}</div>
                            <div><b>å®‰è£åœ°é»ï¼š</b>{quote.location || 'N/A'}</div>
                        </td>

                        <td style={{ width: "50%", fontSize: "15px", padding: '5px 0' }}>
                            <div><b>å ±åƒ¹å–®è™Ÿï¼š</b>{quote.quoteNo || 'N/A'}</div>
                            <div><b>æ—¥æœŸï¼š</b>{quote.date || 'N/A'}</div>
                            <div><b>å…¬å¸åç¨±ï¼š</b>{companyData.name}</div>
                            <div><b>å…¬å¸é›»è©±ï¼š</b>{companyData.tel}</div>
                            <div><b>åœ°å€ï¼š</b>{companyData.address}</div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <table style={{ width: "100%", borderCollapse: "collapse" }}>
                <thead>
                    <tr>
                        <th style={tdCenter}>é …æ¬¡</th>
                        <th style={tdCenter}>å“å</th>
                        <th style={tdCenter}>è¦æ ¼</th>
                        <th style={tdCenter}>å–®ä½</th>
                        <th style={tdCenter}>æ•¸é‡</th>
                        <th style={tdCenter}>å–®åƒ¹</th>
                        <th style={tdCenter}>å°è¨ˆ</th>
                        <th style={tdCenter}>å‚™è¨»</th>
                    </tr>
                </thead>

                <tbody>

                    {(quote.items || []).map((item, idx) => {
                        const amount = calcAmount(item);
                        return (
                            <React.Fragment key={item.id}>
                                {/* ===== 1. ä¸»é … (Main Item) ===== */}
                                <tr>
                                    <td style={tdCenter}>{idx + 1}</td>
                                    <td style={td}>{item.name || ''}</td>
                                    <td style={td}>{item.specMain || ''}</td>
                                    <td style={tdCenter}>{item.unit || ''}</td>
                                    <td style={tdRight}>{item.qty || 0}</td>
                                    <td style={tdRight}>{formatMoney(item.price)}</td>
                                    <td style={tdRightBold}>{formatMoney(amount)}</td>
                                    <td style={td}>{item.remarks || ""}</td>
                                </tr>

                                {/* ===== 2. ç”¨æ–™ç´°é … (Materials) ===== */}
                                {([
                                    item.specMaterial,
                                    item.specMaterial2,
                                    item.specMaterial3
                                ]).filter(Boolean).map((mat, i) =>
                                    mat ? (
                                        <tr key={`${item.id}_mat_${i}`}>
                                            <td colSpan="8" style={{ ...td, background: "#f9f9f9", fontSize: '13px', padding: '4px 8px' }}>
                                                **ç”¨æ–™ {i+1}ï¼š** {mat}
                                            </td>
                                        </tr>
                                    ) : null
                                )}

                                {/* ===== 3. è£œå……åœ–ç‰‡ (ä¿®æ­£ï¼šåœ–ç‰‡ç½®ä¸­) ===== */}
                                {(item.subItems || [])
                                    .filter(s => s.type === "image" && s.url)
                                    .map((s) => (
                                        <tr key={s.id + "_img"}>
                                            <td colSpan="8" style={{ ...td, textAlign: "center", padding: '15px' }}>
                                                <img
                                                    src={s.url}
                                                    style={{
                                                        maxWidth: "400px", 
                                                        maxHeight: "300px",
                                                        height: 'auto',
                                                        width: 'auto',
                                                        border: "1px solid #ccc",
                                                        objectFit: 'contain',
                                                        display: 'block', // é—œéµï¼šè®“ margin: auto ç”Ÿæ•ˆ
                                                        margin: '0 auto'  // é—œéµï¼šæ°´å¹³ç½®ä¸­
                                                    }}
                                                    alt="è£œå……åœ–ç‰‡"
                                                />
                                            </td>
                                        </tr>
                                    ))}

                                {/* ===== 4. è£œå……èªªæ˜ (SubItems - type: note) ===== */}
                                {(item.subItems || [])
                                    .filter(s => s.type === "note" && s.text)
                                    .map((s) => (
                                        <tr key={s.id + "_note"}>
                                            <td colSpan="8" style={{ ...td, background: "#f0f0f0", fontSize: '13px' }}>
                                                **è£œå……èªªæ˜ï¼š** {s.text}
                                            </td>
                                        </tr>
                                    ))}
                            </React.Fragment>
                        );
                    })}

                    {/* ===== ç¸½è¨ˆè¡Œ ===== */}
                    <tr>
                        <td colSpan="7" style={tdRightBold}>ç¸½è¨ˆï¼ˆæœªç¨…ï¼‰</td>
                        <td style={tdRightBold}>{formatMoney(totalAmount)}</td>
                    </tr>

                    {/* ===== è­°åƒ¹å¾Œç¸½åƒ¹è¡Œ (æ¢ä»¶é¡¯ç¤º) ===== */}
                    {showNegotiatedRow && (
                        <tr>
                            <td colSpan="7" style={tdRightBold}>è­°åƒ¹å¾Œç¸½åƒ¹ï¼ˆæœªç¨…ï¼‰</td>
                            <td style={{ ...tdRightBold, color: '#d92c2c' }}>{formatMoney(negotiatedAmount)}</td>
                        </tr>
                    )}

                </tbody>
            </table>

            {/* ===== å‚™è¨» + ä»˜æ¬¾æ¢ä»¶å€å¡Š ===== */}
            <table style={{ width: "100%", marginTop: "30px" }}>
                <tbody>
                    <tr>
                        <td style={{ width: "50%", fontSize: "15px", verticalAlign: "top", paddingRight: '15px' }}>
                            <b style={{fontSize: '16px'}}>å‚™è¨»ï¼š</b><br />
                            <pre style={{ whiteSpace: "pre-wrap", fontSize: "14px", margin: '5px 0' }}>
                                {quote.notes}
                            </pre>
                        </td>

                        <td style={{ width: "50%", fontSize: "15px", verticalAlign: "top", paddingLeft: '15px' }}>
                            <b style={{fontSize: '16px'}}>ä»˜æ¬¾æ¢ä»¶ï¼š</b><br />
                            <pre style={{ whiteSpace: "pre-wrap", fontSize: "14px", margin: '5px 0' }}>
                                {quote.payment}
                            </pre>
                        </td>
                    </tr>
                </tbody>
            </table>

            {/* ===== å°ç«  + å®¢æˆ¶ç°½åå€å¡Š ===== */}
            <table style={{
                width: "100%",
                marginTop: "50px", 
                borderCollapse: "collapse"
            }}>
                <tbody>
                    <tr>
                        {/* å…¬å¸å°ç«  */}
                        <td style={{
                            border: "1px solid #000",
                            width: "50%", 
                            height: "160px", 
                            textAlign: "center",
                            fontSize: "15px"
                        }}>
                            <div style={{ fontWeight: "bold", marginBottom: "10px" }}>
                                æœ¬å…¬å¸è“‹ç« 
                            </div>
                            {companyData.stamp && (
                                <img
                                    src={companyData.stamp}
                                    style={{ width: "130px", marginTop: "10px" }}
                                    alt="å…¬å¸å°ç« "
                                />
                            )}
                        </td>

                        {/* å®¢æˆ¶å›ç°½ */}
                        <td style={{ 
                            border: "1px solid #000",
                            width: "50%", 
                            height: "160px", 
                            fontSize: "15px",
                            padding: '20px'
                        }}>
                            å®¢æˆ¶ç°½åï¼š<span style={{borderBottom: '1px solid #000', padding: '0 50px'}}>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br /><br /><br />
                            æ—¥æœŸï¼š<span style={{borderBottom: '1px solid #000', padding: '0 50px'}}>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                        </td>
                    </tr>
                </tbody>
            </table>

        </div>
    );
}


// =======================================================
// D6 â€” åˆ—å° PrintButton (ä¿®æ­£ï¼šä½¿ç”¨ renderToString é¿å…æ–°çª—å£çš„ React éŒ¯èª¤)
// =======================================================
function PrintButton() {
    const { activeQuote, COMPANY_DATA } = React.useContext(AppContext);

    // å–å¾— renderToString å‡½å¼
    const ReactDOMServer = window.ReactDOMServer;
    
    const handlePrint = () => {
        if (!activeQuote) {
            alert("å°šæœªé¸æ“‡å ±åƒ¹å–®");
            return;
        }

        const companyData = COMPANY_DATA[activeQuote.company];
        if (!companyData) {
             alert("å…¬å¸è³‡æ–™éŒ¯èª¤ï¼Œç„¡æ³•åˆ—å°");
             return;
        }

        if (!ReactDOMServer) {
            alert("ç¼ºå°‘ ReactDOMServer åº«ï¼Œç„¡æ³•é€²è¡Œåˆ—å°ã€‚è«‹æª¢æŸ¥ CDN å¼•å…¥ã€‚");
            return;
        }

        // 1. å°‡ PrintLayout çµ„ä»¶è½‰æ›ç‚ºéœæ…‹ HTML å­—ä¸²
        // ç”±æ–¼æˆ‘å€‘åœ¨ AppProvider ä¹‹å¤–ï¼Œå¿…é ˆæ‰‹å‹•å‚³é props
        const printHtmlString = ReactDOMServer.renderToString(
             <PrintLayout quote={activeQuote} companyData={companyData} />
        );

        const win = window.open("", "_blank");
        if (!win) {
             alert("è«‹å…è¨±å½ˆå‡ºè¦–çª—ä»¥ä¾¿åˆ—å°");
             return;
        }
        
        // 2. å¯«å…¥åŸºç¤ HTMLã€æ¨£å¼å’Œéœæ…‹å…§å®¹åˆ°æ–°çš„åˆ—å°çª—å£
        win.document.write(`
            <html>
            <head>
                <title>å ±åƒ¹å–® ${activeQuote.quoteNo}</title>
                <style>
                    @page { size: A4; margin: 15mm; } 
                    body { 
                        margin: 0; 
                        padding: 0; 
                        font-family: "Microsoft JhengHei", "PingFang TC", sans-serif; 
                        color: #000;
                    }
                    /* ç¢ºä¿è¡¨æ ¼åœ¨åˆ†é æ™‚ä¸æœƒè¢«åˆ‡æ–· */
                    table { page-break-inside: auto; }
                    tr    { page-break-inside: avoid; page-break-after: auto; }
                </style>
            </head>
            <body>
                <div class="print-container" style="max-width: 794px; margin: 0 auto; padding: 0;">
                    ${printHtmlString}
                </div>
            </body>
            </html>
        `);
        win.document.close();

        // 3. åŸ·è¡Œåˆ—å° (çµ¦ç€è¦½å™¨ä¸€é»æ™‚é–“åŠ è¼‰æ¨£å¼)
        setTimeout(() => {
            win.print();
        }, 50); // é€™è£¡çš„æ™‚é–“å¯ä»¥ç¸®çŸ­å¾ˆå¤šï¼Œå› ç‚ºä¸éœ€è¦ç­‰å¾… React æ¸²æŸ“

        // 4. é—œé–‰çª—å£ (å¯é¸)
        setTimeout(() => {
             win.close();
        }, 3000); // å»¶é²é—œé–‰ï¼Œçµ¦äºˆä½¿ç”¨è€…åˆ—å°æ“ä½œæ™‚é–“
    };

    return (
        <button
            className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-base"
            onClick={handlePrint}
        >
            ğŸ–¨ åˆ—å°å ±åƒ¹å–®
        </button>
    );
}

// =======================================================
// D6 â€” PDF ç”¢ç”Ÿ ExportPDFButton
// =======================================================
function ExportPDFButton() {
    const { activeQuote, COMPANY_DATA } = React.useContext(AppContext);
    
    const generatePDF = async () => {
        if (!activeQuote) {
            alert("è«‹å…ˆé¸æ“‡å ±åƒ¹å–®");
            return;
        }
        const companyData = COMPANY_DATA[activeQuote.company];
        const { jsPDF } = window.jspdf || {}; 
        
        if (typeof html2canvas === 'undefined' || typeof jsPDF === 'undefined') {
            alert("ç¼ºå°‘ html2canvas æˆ– jspdf åº«ï¼Œç„¡æ³•ç”Ÿæˆ PDF");
            return;
        }

        // 1. éš±è—æ¸²æŸ“å®¹å™¨
        const hidden = document.createElement("div");
        hidden.style.position = "fixed";
        hidden.style.top = "-9999px";
        hidden.style.left = "-9999px";
        hidden.style.width = "794px"; // æ¨¡æ“¬ A4 å¯¬åº¦
        hidden.style.fontFamily = "Microsoft JhengHei, sans-serif"; 
        hidden.style.padding = "20px";
        document.body.appendChild(hidden);

        // 2. æ¸²æŸ“åˆ—å°ç‰ˆ
        const hiddenRoot = ReactDOM.createRoot(hidden);
        hiddenRoot.render(<PrintLayout quote={activeQuote} companyData={companyData} />);

        // 3. ç­‰å¾…æ¸²æŸ“å®Œæˆ
        await new Promise(res => setTimeout(res, 500));

        try {
             // 4. è½‰æ›ç‚º Canvas
            const canvas = await html2canvas(hidden, { 
                scale: 3,
                logging: false,
                useCORS: true
            }); 
            const img = canvas.toDataURL("image/png");

            // 5. å»ºç«‹ jsPDF å¯¦ä¾‹
            const pdf = new jsPDF("p", "mm", "a4");
            const pdfWidth = pdf.internal.pageSize.getWidth(); 
            const canvasWidth = canvas.width / 3; 
            const canvasHeight = canvas.height / 3;
            
            const pdfHeight = (canvasHeight * pdfWidth) / canvasWidth; 

            // 6. å°‡åœ–ç‰‡æ·»åŠ åˆ° PDF
            pdf.addImage(img, "PNG", 0, 0, pdfWidth, pdfHeight);
            pdf.save(`å ±åƒ¹å–®_${activeQuote.quoteNo}.pdf`);

        } catch (error) {
            console.error("ç”Ÿæˆ PDF å¤±æ•—:", error);
            alert("ç”Ÿæˆ PDF éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚");
        } finally {
            // 7. æ¸…ç†
            hiddenRoot.unmount(); 
            document.body.removeChild(hidden);
        }
    };

    return (
        <button
            className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 text-base"
            onClick={generatePDF}
        >
            ğŸ“„ è½‰ PDF
        </button>
    );
}


// =======================================================
// D0 â€” Appï¼ˆä¸»è¦æ¸²æŸ“å…¥å£ï¼‰
// =======================================================
function App() {
    const { 
        company, 
        setCompany, 
        quotes,
        activeQuote, 
        activeQuoteId,
        setActiveQuoteId,
        createQuote, 
        updateQuote, 
        updateItem,
        deleteQuote,
        COMPANY_DATA
    } = React.useContext(AppContext);

    const companyKeys = Object.keys(COMPANY_DATA);

    const handleFieldChange = (e) => {
        const { name, value } = e.target;
        if (activeQuote) {
            updateQuote(activeQuote.id, { [name]: value });
        }
    };
    
    // ç¸½é‡‘é¡
    const totalAmount = activeQuote ? calcTotal(activeQuote.items) : 0;
    const negotiatedAmount = activeQuote ? calcNegotiated(
        totalAmount,
        activeQuote.discountPercent,
        activeQuote.negotiatedPrice
    ) : 0;
    
    // åˆªé™¤ç•¶å‰å ±åƒ¹å–®
    const handleDeleteCurrent = () => {
        if(confirm(`ç¢ºå®šè¦åˆªé™¤å ±åƒ¹å–® ${activeQuote.quoteNo} å—ï¼Ÿ`)) {
            deleteQuote(activeQuote.id);
        }
    }
    
    // è¤‡è£½å ±åƒ¹å–®
    const handleDuplicateQuote = () => {
        if (!activeQuote) return;

        const newQuote = JSON.parse(JSON.stringify(activeQuote));

        newQuote.id = uuid();
        newQuote.quoteNo = generateQuoteNo(activeQuote.company);
        newQuote.title = `(è¤‡è£½) ${newQuote.title}`;

        newQuote.items = newQuote.items.map(item => {
            item.id = uuid();
            item.subItems = (item.subItems || []).map(sub => ({ ...sub, id: uuid() }));
            return item;
        });

        // å°‡æ–°å ±åƒ¹å–®åŠ å…¥åˆ—è¡¨ï¼Œä¸¦è¨­ç‚ºç•¶å‰æ´»å‹•
        setQuotes(prev => [newQuote, ...prev]);
        setActiveQuoteId(newQuote.id);
        alert(`å ±åƒ¹å–® ${activeQuote.quoteNo} å·²è¤‡è£½ç‚º ${newQuote.quoteNo}`);
    };

    return (
        <div className="p-8">
            <h1 className="text-3xl font-bold mb-6 text-gray-800">å·¥ç¨‹å ±åƒ¹ç³»çµ±</h1>

            {/* ===== é ‚éƒ¨åŠŸèƒ½å€ (å…¬å¸åˆ‡æ›, æ–°å¢, åˆ—å°, PDF) ===== */}
            <div className="no-print flex items-center justify-between bg-white p-5 rounded-lg shadow-lg mb-8">
                <div className="flex space-x-6 items-center">
                    <label className="font-medium text-xl text-gray-700">é¸æ“‡å ±åƒ¹å–®:</label>
                    <select 
                        value={activeQuoteId || ''} 
                        onChange={(e) => setActiveQuoteId(e.target.value)}
                        className="border border-gray-300 rounded p-2 text-base w-64"
                    >
                        <option value="" disabled>--- è«‹é¸æ“‡æˆ–æ–°å¢å ±åƒ¹å–® ---</option>
                        {quotes.map(q => (
                            <option key={q.id} value={q.id}>
                                {q.quoteNo} - {q.title}
                            </option>
                        ))}
                    </select>
                </div>
                <div className="flex space-x-3">
                     <label className="font-medium text-lg flex items-center">å…¬å¸:</label>
                    <select 
                        value={company} 
                        onChange={(e) => setCompany(e.target.value)}
                        className="border border-gray-300 rounded p-2 text-base"
                    >
                        {companyKeys.map(key => (
                            <option key={key} value={key}>{COMPANY_DATA[key].name}</option>
                        ))}
                    </select>
                    <button
                        className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-base"
                        onClick={createQuote}
                    >
                        + æ–°å¢å ±åƒ¹å–®
                    </button>
                    <PrintButton />
                    <ExportPDFButton />
                </div>
            </div>

            {activeQuote ? (
                <div className="bg-white p-8 rounded-lg shadow-xl">
                    {/* ===== å ±åƒ¹å–®åŸºæœ¬è³‡è¨Šç·¨è¼¯å€ ===== */}
                    <div className="mb-8 pb-4 border-b-2">
                        <div className="grid grid-cols-2 gap-6">
                            <input 
                                type="text" 
                                name="title" 
                                placeholder="å·¥ç¨‹åç¨±"
                                value={activeQuote.title}
                                onChange={handleFieldChange}
                                className="text-3xl font-bold border-b-2 p-1 col-span-2 focus:border-blue-500"
                            />
                            
                            <div className="grid grid-cols-2 gap-4 text-base">
                                <label className="flex items-center">å®¢æˆ¶åç¨±ï¼š
                                    <input type="text" name="customerName" value={activeQuote.customerName} onChange={handleFieldChange} className="border p-2 w-full ml-2 rounded"/>
                                </label>
                                <label className="flex items-center">è¯çµ¡äººï¼š
                                    <input type="text" name="contact" value={activeQuote.contact} onChange={handleFieldChange} className="border p-2 w-full ml-2 rounded"/>
                                </label>
                                <label className="flex items-center">é€£çµ¡é›»è©±ï¼š
                                    <input type="text" name="phone" value={activeQuote.phone} onChange={handleFieldChange} className="border p-2 w-full ml-2 rounded"/>
                                </label>
                                <label className="flex items-center">å®‰è£åœ°é»ï¼š
                                    <input type="text" name="location" value={activeQuote.location} onChange={handleFieldChange} className="border p-2 w-full ml-2 rounded"/>
                                </label>
                            </div>
                            
                            <div className="text-right text-base">
                                <p className="mb-2">å ±åƒ¹å–®è™Ÿï¼š<span className="font-bold">{activeQuote.quoteNo}</span></p>
                                <p className="flex justify-end items-center">æ—¥æœŸï¼š
                                    <input type="date" name="date" value={activeQuote.date} onChange={handleFieldChange} className="border p-2 ml-2 rounded"/>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    {/* ===== å ±åƒ¹å“é …åˆ—è¡¨ ===== */}
                    <h3 className="text-2xl font-semibold mb-4 border-b pb-2 text-gray-700">å ±åƒ¹å“é … (å…± {activeQuote.items.length} é …)</h3>
                    {activeQuote.items.map((item, index) => (
                        <QuoteItemEditor 
                            key={item.id} 
                            item={item} 
                            updateItem={updateItem} 
                            index={index}
                            activeQuote={activeQuote} 
                            updateQuote={updateQuote}
                        />
                    ))}

                    {/* æ–°å¢å“é …æŒ‰éˆ• */}
                    <button 
                        onClick={() => {
                            const newItem = {
                                id: uuid(),
                                name: '',
                                specMain: '',
                                unit: 'å¼',
                                qty: 1,
                                price: 0,
                                remarks: '',
                                specMaterial: '',
                                specMaterial2: '',
                                specMaterial3: '',
                                subItems: []
                            };
                            updateQuote(activeQuote.id, { items: [...activeQuote.items, newItem] });
                        }}
                        className="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 text-base mt-4"
                    >
                        + æ–°å¢å“é …
                    </button>
                    
                    {/* ===== ç¸½çµå€ ===== */}
                    <div className="mt-8 pt-4 border-t-2 border-red-500 text-right">
                        <div className="text-xl font-medium">ç¸½è¨ˆï¼ˆæœªç¨…ï¼‰ï¼š<span className="text-red-600 font-bold">{formatMoney(totalAmount)}</span> å…ƒ</div>
                        <div className="flex justify-end items-center mt-3 space-x-3 text-base">
                            <label>æŠ˜æ‰£ (%)ï¼š</label>
                            <input 
                                type="number" 
                                name="discountPercent"
                                value={activeQuote.discountPercent || 0}
                                onChange={handleFieldChange}
                                className="border p-2 w-24 text-right rounded"
                            />
                            <label>è­°åƒ¹å¾Œç¸½åƒ¹ï¼š</label>
                            <input 
                                type="number" 
                                name="negotiatedPrice"
                                value={activeQuote.negotiatedPrice || 0}
                                onChange={handleFieldChange}
                                className="border p-2 w-40 text-right font-bold text-red-700 rounded"
                            />
                            <span className="text-xl font-bold text-red-700">({formatMoney(negotiatedAmount)}) å…ƒ</span>
                        </div>
                    </div>

                    {/* ===== å‚™è¨»/ä»˜æ¬¾æ¢ä»¶ç·¨è¼¯ ===== */}
                    <div className="grid grid-cols-2 gap-8 mt-6 text-base">
                        <div>
                            <h4 className="font-semibold mb-2 text-xl">å‚™è¨»ï¼š</h4>
                            <textarea 
                                name="notes" 
                                value={activeQuote.notes} 
                                onChange={handleFieldChange} 
                                rows="6" 
                                className="w-full border p-3 rounded"
                            ></textarea>
                        </div>
                         <div>
                            <h4 className="font-semibold mb-2 text-xl">ä»˜æ¬¾æ¢ä»¶ï¼š</h4>
                            <textarea 
                                name="payment" 
                                value={activeQuote.payment} 
                                onChange={handleFieldChange} 
                                rows="6" 
                                className="w-full border p-3 rounded"
                            ></textarea>
                        </div>
                    </div>
                    
                    <div className="flex justify-start items-center mt-6">
                        <button 
                            onClick={handleDeleteCurrent}
                            className="bg-red-100 text-red-600 px-4 py-2 rounded hover:bg-red-200 text-base"
                        >
                            ğŸ—‘ åˆªé™¤æ­¤å ±åƒ¹å–®
                        </button>
                         <button 
                            onClick={handleDuplicateQuote}
                            className="ml-4 bg-yellow-100 text-yellow-700 px-4 py-2 rounded hover:bg-yellow-200 text-base"
                        >
                            ğŸ“‹ è¤‡è£½å ±åƒ¹å–®
                        </button>
                    </div>

                </div>
            ) : (
                <p className="p-8 text-center text-xl text-gray-500 bg-white rounded-lg shadow-lg">
                    è«‹é»æ“Šé ‚éƒ¨ç¶ è‰²çš„ã€Œ+ æ–°å¢å ±åƒ¹å–®ã€é–‹å§‹è£½ä½œï¼Œæˆ–å¾ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡ä¸€ä»½ç¾æœ‰çš„å ±åƒ¹å–®ã€‚
                </p>
            )}
            
            {/* ===== å ±åƒ¹å–®é è¦½å€ (æ–°éœ€æ±‚) ===== */}
            {activeQuote && (
                <QuotePreview 
                    quote={activeQuote} 
                    companyData={COMPANY_DATA[company]} 
                />
            )}
            
        </div>
    );
}

// =======================================================
// Main Render
// =======================================================
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(
    <AppProvider>
        <App />
    </AppProvider>
);

</script>
</body>
</html>
