<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel Standaloneï¼ˆå…è¨± JSX åœ¨ç€è¦½å™¨ä¸­ç›´æ¥åŸ·è¡Œï¼‰ -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SheetJSï¼ˆåŒ¯å‡º Excel ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      background: #f3f4f6;
      font-family: "Microsoft JhengHei", sans-serif;
    }

    @media print {
      .no-print { display: none !important; }
      body { background: white !important; }
    }
  </style>
</head>

<body class="text-gray-900">

  <!-- React ä¸»ç•«é¢ -->
  <div id="root"></div>

  <!-- åˆ—å°å°ˆç”¨ DOM -->
  <div id="printArea" class="print-container"></div>

  <!-- ä¸»ç¨‹å¼é–‹å§‹ -->
  <script type="text/babel">

/****************************************************
 * P0 â€” åˆå§‹åŒ–å ä½ç•«é¢ï¼ˆå°šæœªè¼‰å…¥å…¶ä»–çµ„ä»¶æ™‚é¡¯ç¤ºï¼‰
 ****************************************************/
function App() {
  return (
    <div className="p-6 text-center text-xl">
      <div className="text-gray-600 font-bold">
        ğŸš§ å·¥ç¨‹å ±åƒ¹ç³»çµ±åˆå§‹åŒ–æˆåŠŸ
      </div>
      <div className="mt-2 text-sm text-gray-400">
        ï¼ˆè«‹é–‹å§‹è²¼ä¸Š P1ã€P2ã€P3... ç­‰ä¸»ç¨‹å¼ï¼‰
      </div>
    </div>
  );
}

// æ¸²æŸ“ P0ï¼ˆå¾ŒçºŒæœƒè¢«çœŸæ­£çš„ App è¦†è“‹ï¼‰
ReactDOM.createRoot(document.getElementById("root")).render(<App />);

/****************************************************
 * P1 â€” è³‡æ–™çµæ§‹ï¼ˆå…¬å¸è³‡æ–™ + æ¨¡å¼æ¨¡æ¿ï¼‰
 ****************************************************/

// å…©å®¶å…¬å¸è³‡æ–™
const COMPANY_DATA = {
  herhsin: {
    name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
    tel: "07-6517476",
    fax: "07-6517994",
    email: "admin@herhsin.com",
    address: "831é«˜é›„å¸‚å¤§å¯®å€é³³æ—ä¸‰è·¯383-3è™Ÿ",
    stamp: "stamp_herhsin.jpg"   // ä¹‹å¾Œå¯æ›¿æ›
  },
  sinchang: {
    name: "è–ªæ˜Œæœ‰é™å…¬å¸",
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831é«˜é›„å¸‚å¤§å¯®å€é³³æ—ä¸‰è·¯383-3è™Ÿ",
    stamp: "stamp_sinchang.jpg" // ä¹‹å¾Œå¯æ›¿æ›
  }
};


// ğŸ“Œ é è¨­å‚™è¨»ï¼ˆå¯è‡ªè¡Œç·¨è¼¯ï¼‰
const DEFAULT_NOTES = `
1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚
`;


// ğŸ“Œ é è¨­ä»˜æ¬¾æ¢ä»¶
const DEFAULT_PAYMENT = `
è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%
`;


// ğŸ“Œ å ±åƒ¹æ¨¡å¼æ¨¡æ¿ï¼ˆå¯æŒçºŒæ–°å¢ï¼‰
const QUOTE_MODES = [
  {
    id: "modeA",
    name: "æ‹Œåˆæ©Ÿæ¼æ¼¿æ›´æ›",
    description: "é©ç”¨æ‹Œåˆæ©Ÿç¶­ä¿®ã€æ¼æ¼¿è™•ç†ç­‰ã€‚",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  },
  {
    id: "modeB",
    name: "è¨­å‚™éŠ·å”®",
    description: "é©ç”¨å‚™å“ã€å–®æ©ŸéŠ·å”®èˆ‡å®‰è£ã€‚",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  },
  {
    id: "modeC",
    name: "è¨­å‚™æ›´æ›å·¥ç¨‹",
    description: "é©ç”¨æ•´æ©Ÿæ›´æ–°ã€æ–™ä»¶æ›´æ›å·¥ç¨‹ã€‚",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  }
];
/****************************************************
 * P2 â€” å·¥å…·å‡½å¼ï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰
 ****************************************************/

// ç”¢ç”Ÿ UUID
function uuid() {
  return "xxxx-4xxx-yxxx".replace(/[xy]/g, c => {
    const r = (Math.random() * 16) | 0;
    const v = c === "x" ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

// ä»Šæ—¥ yyyy/mm/dd
function formatDate() {
  const d = new Date();
  return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, "0")}/${String(
    d.getDate()
  ).padStart(2, "0")}`;
}

// åƒåˆ†ä½
function formatMoney(num) {
  if (!num && num !== 0) return "";
  return Number(num).toLocaleString("zh-TW");
}

// å–®ç­†é‡‘é¡
function calcAmount(item) {
  return Number(item.qty || 0) * Number(item.price || 0);
}

// è¨ˆç®—æ•´ä»½å ±åƒ¹å–®ç¸½é¡
function calcTotal(items) {
  return items.reduce((sum, it) => {
    const main = calcAmount(it);
    let sub = 0;

    if (it.subItems?.length) {
      sub = it.subItems.reduce((s, sub) => s + calcAmount(sub), 0);
    }

    return sum + main + sub;
  }, 0);
}

// è­°åƒ¹å¾Œé‡‘é¡
function calcNegotiated(total, percent, custom) {
  if (custom > 0) return Number(custom);
  if (percent > 0) return Math.round(total * (1 - percent / 100));
  return total;
}

// è®€å– Google Sheet CSV
async function loadCSV(url) {
  const text = await (await fetch(url)).text();
  const rows = text.split("\n").map(r => r.trim());
  const header = rows[0].split(",");

  return rows.slice(1).map(r => {
    const cols = r.split(",");
    const obj = {};
    header.forEach((h, i) => (obj[h] = cols[i] || ""));
    return obj;
  });
}

/****************************************************
 * P3 â€” AppContextï¼ˆæ ¸å¿ƒè³‡æ–™ç®¡ç†ï¼‰
 ****************************************************/

const AppContext = React.createContext();

function AppProvider({ children }) {
  const [company, setCompany] = React.useState("herhsin");
  const [quotes, setQuotes] = React.useState([]);
  const [activeQuoteId, setActiveQuoteId] = React.useState(null);

  const [specItems, setSpecItems] = React.useState([]);

  const SPEC_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv";

  // åˆå§‹åŒ– localStorage
  React.useEffect(() => {
    const saved = localStorage.getItem("HERHSIN_QUOTES");
    if (saved) {
      const parsed = JSON.parse(saved);
      setQuotes(parsed);
      if (parsed.length > 0) setActiveQuoteId(parsed[0].id);
    }
  }, []);

  // è‡ªå‹•ä¿å­˜
  React.useEffect(() => {
    localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
  }, [quotes]);

  // è¼‰å…¥è¦æ ¼å“ï¼ˆGoogle Sheetï¼‰
  React.useEffect(() => {
    loadCSV(SPEC_CSV_URL).then(setSpecItems);
  }, []);

  // å»ºç«‹å ±åƒ¹å–®
  function createQuote(modeId = null) {
    const id = uuid();
    const today = formatDate();
    const mode = QUOTE_MODES.find(m => m.id === modeId);

    const newQuote = {
      id,
      quoteNo: generateQuoteNo?.() || id.substring(0, 6),
      title: mode?.name || "æœªå‘½åå·¥ç¨‹",
      customerName: "",
      contact: "",
      phone: "",
      location: "",
      date: today,
      items: mode?.defaultItems || [],
      notes: mode?.defaultNotes || DEFAULT_NOTES,
      payment: mode?.defaultPayment || DEFAULT_PAYMENT,
      discountPercent: 0,
      negotiatedPrice: 0
    };

    setQuotes(prev => [...prev, newQuote]);
    setActiveQuoteId(id);
  }

  // åˆªé™¤
  function deleteQuote(id) {
    const newList = quotes.filter(q => q.id !== id);
    setQuotes(newList);
    if (newList.length) setActiveQuoteId(newList[0].id);
    else setActiveQuoteId(null);
  }

  // æ›´æ–°
  function updateQuote(id, data) {
    setQuotes(prev => prev.map(q => (q.id === id ? { ...q, ...data } : q)));
  }

  // å¥—ç”¨æ¨¡å¼
  function applyMode(modeId) {
    const mode = QUOTE_MODES.find(m => m.id === modeId);
    if (!mode || !activeQuoteId) return;

    updateQuote(activeQuoteId, {
      title: mode.name,
      items: [...mode.defaultItems],
      notes: mode.defaultNotes,
      payment: mode.defaultPayment
    });
  }

  window.__APP_CONTEXT__ = {
    quotes,
    activeQuoteId,
    company
  };

  return (
    <AppContext.Provider
      value={{
        company,
        setCompany,
        quotes,
        createQuote,
        deleteQuote,
        updateQuote,
        activeQuoteId,
        setActiveQuoteId,
        specItems,
        applyMode
      }}
    >
      {children}
    </AppContext.Provider>
  );
}
/****************************************************
 * P4-1 â€” åŸºç¤ UI å…ƒä»¶
 * - å…¬å¸åˆ‡æ›ï¼ˆCompanySelectorï¼‰
 * - å ±åƒ¹å–®ç®¡ç†ï¼ˆQuoteManagerï¼‰
 * - å¥—ç”¨æ¨¡å¼ï¼ˆModeSelectorï¼‰
 ****************************************************/


/* ---------------------------
   1. å…¬å¸åˆ‡æ› CompanySelector
   --------------------------- */
function CompanySelector() {
  const { company, setCompany } = React.useContext(AppContext);

  return (
    <div className="p-3 bg-white shadow mb-4 rounded no-print">
      <div className="flex items-center gap-4">
        <span className="font-bold text-lg">é¸æ“‡å…¬å¸ï¼š</span>

        <select
          className="border rounded p-2"
          value={company}
          onChange={(e) => setCompany(e.target.value)}
        >
          <option value="herhsin">ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸</option>
          <option value="sinchang">è–ªæ˜Œæœ‰é™å…¬å¸</option>
        </select>
      </div>
    </div>
  );
}


/* ---------------------------
   2. å ±åƒ¹å–®ç®¡ç† QuoteManager
   --------------------------- */
function QuoteManager() {
  const {
    quotes, createQuote, deleteQuote,
    activeQuoteId, setActiveQuoteId
  } = React.useContext(AppContext);

  return (
    <div className="p-3 mb-4 bg-white shadow rounded no-print">

      <div className="flex justify-between items-center mb-3">
        <h2 className="font-bold text-xl">å ±åƒ¹å–®ç®¡ç†</h2>

        <button
          className="px-3 py-2 bg-blue-600 text-white rounded"
          onClick={() => createQuote(null)}
        >
          ï¼‹æ–°å¢ç©ºç™½å ±åƒ¹å–®
        </button>
      </div>

      {/* å ±åƒ¹å–®åˆ—è¡¨ */}
      <div className="space-y-2">
        {quotes.map(q => (
          <div
            key={q.id}
            className={`flex items-center justify-between p-2 border rounded cursor-pointer
              ${activeQuoteId === q.id ? 'bg-blue-100' : 'bg-gray-50'}`}
            onClick={() => setActiveQuoteId(q.id)}
          >
            <span>{q.title}</span>

            <button
              className="text-red-500 text-sm"
              onClick={(e) => {
                e.stopPropagation();
                if (confirm("ç¢ºå®šåˆªé™¤æ­¤å ±åƒ¹å–®ï¼Ÿ")) deleteQuote(q.id);
              }}
            >
              åˆªé™¤
            </button>
          </div>
        ))}

        {quotes.length === 0 && (
          <div className="text-gray-500 text-center p-2">å°šç„¡å ±åƒ¹å–®ï¼Œè«‹æ–°å¢ã€‚</div>
        )}
      </div>
    </div>
  );
}


/* ---------------------------
   3. å¥—ç”¨æ¨¡å¼ ModeSelector
   --------------------------- */
function ModeSelector() {
  const { createQuote } = React.useContext(AppContext);

  return (
    <div className="p-3 bg-white shadow rounded mb-4 no-print">
      <h2 className="font-bold text-xl mb-2">å¿«é€Ÿå¥—ç”¨å ±åƒ¹æ¨¡å¼</h2>

      <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
        {QUOTE_MODES.map(mode => (
          <div
            key={mode.id}
            className="border rounded p-3 cursor-pointer hover:bg-blue-100"
            onClick={() => createQuote(mode.id)}
          >
            <div className="font-bold">{mode.name}</div>
            <div className="text-sm text-gray-600">{mode.description}</div>
          </div>
        ))}
      </div>
    </div>
  );
}
/****************************************************
 * P4-2 â€” å ±åƒ¹å–®ä¸»å…§å®¹ï¼ˆæŠ¬é ­ + å®¢æˆ¶è³‡æ–™è¡¨å–®ï¼‰
 ****************************************************/


/* --------------------------------------------------
   4-2-1. å…¬å¸æŠ¬é ­ï¼ˆå°åœ¨å ±åƒ¹å–®ä¸Šæ–¹ï¼‰
   -------------------------------------------------- */
function QuoteCompanyHeader() {
  const { company } = React.useContext(AppContext);
  const info = COMPANY_DATA[company];

  return (
    <div className="text-center mb-6">
      <h1 className="text-2xl font-bold">{info.name}</h1>
      <div>{info.tel}</div>
      <div>{info.fax}</div>
      <div>{info.email}</div>
      <div>{info.address}</div>

      <h2 className="text-3xl font-bold mt-4 tracking-widest">
        å·¥ ç¨‹ å ± åƒ¹ å–®
      </h2>
    </div>
  );
}


/* --------------------------------------------------
   4-2-2. å®¢æˆ¶è³‡æ–™ç·¨è¼¯è¡¨å–®
   -------------------------------------------------- */
function QuoteHeaderForm({ quote, update }) {
  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 p-4 bg-white rounded shadow mb-4">

      {/* é¡§å®¢åç¨± */}
      <div>
        <label className="font-bold">é¡§å®¢åç¨±ï¼š</label>
        <input
          className="border p-2 w-full rounded"
          value={quote.customerName}
          onChange={(e) => update({ customerName: e.target.value })}
        />
      </div>

      {/* è¯çµ¡äºº */}
      <div>
        <label className="font-bold">è¯çµ¡äººï¼š</label>
        <input
          className="border p-2 w-full rounded"
          value={quote.contact}
          onChange={(e) => update({ contact: e.target.value })}
        />
      </div>

      {/* é›»è©± */}
      <div>
        <label className="font-bold">é›»è©±ï¼š</label>
        <input
          className="border p-2 w-full rounded"
          value={quote.phone}
          onChange={(e) => update({ phone: e.target.value })}
        />
      </div>

      {/* å ±åƒ¹æ—¥æœŸ */}
      <div>
        <label className="font-bold">å ±åƒ¹æ—¥æœŸï¼š</label>
        <input
          type="date"
          className="border p-2 w-full rounded"
          value={quote.date}
          onChange={(e) => update({ date: e.target.value })}
        />
      </div>

      {/* å·¥ç¨‹åç¨± */}
      <div>
        <label className="font-bold">å·¥ç¨‹åç¨±ï¼š</label>
        <input
          className="border p-2 w-full rounded"
          value={quote.title}
          onChange={(e) => update({ title: e.target.value })}
        />
      </div>

      {/* å·¥ç¨‹åœ°é» */}
      <div>
        <label className="font-bold">å·¥ç¨‹åœ°é»ï¼š</label>
        <input
          className="border p-2 w-full rounded"
          value={quote.location}
          onChange={(e) => update({ location: e.target.value })}
        />
      </div>

    </div>
  );
}


/* --------------------------------------------------
   4-2-3. å ±åƒ¹å–®ä¸»ç·¨è¼¯å™¨éª¨æ¶ï¼ˆå¾ŒçºŒæœƒåŠ å…¥å“é …/å‚™è¨»ï¼‰
   -------------------------------------------------- */
function QuoteEditor() {
  const {
    activeQuoteId,
    quotes,
    updateQuote
  } = React.useContext(AppContext);

  if (!activeQuoteId) {
    return (
      <div className="text-gray-500 text-center p-6">
        è«‹å…ˆé¸æ“‡æˆ–æ–°å¢å ±åƒ¹å–®
      </div>
    );
  }

  const quote = quotes.find(q => q.id === activeQuoteId);
  if (!quote) return <div>æ‰¾ä¸åˆ°å ±åƒ¹å–®ã€‚</div>;

  const update = (data) => updateQuote(quote.id, data);

  return (
    <div className="p-4">

      {/* å…¬å¸è³‡è¨ŠæŠ¬é ­ */}
      <QuoteCompanyHeader />

      {/* å®¢æˆ¶è³‡æ–™è¡¨å–® */}
      <QuoteHeaderForm quote={quote} update={update} />

      {/* ä¸‹é¢çš„å“é …/å‚™è¨»/ä»˜æ¬¾/ç¸½åƒ¹ç¨å¾ŒåŠ å…¥ */}
      <div className="text-gray-400 text-center mt-8">
        ï¼ˆæ¥ä¸‹ä¾†æœƒåœ¨ P4-3 åŠ å…¥å“é …ç·¨è¼¯å™¨â€¦ï¼‰
      </div>
    </div>
  );
}
/****************************************************
 * P4-3-1 â€” å“é …æ“ä½œå·¥å…·ï¼ˆå¢åˆªæ”¹æŸ¥ï¼‰
 ****************************************************/

// ------------------------------
// å»ºç«‹ã€Œå¤§é …ã€ä¸»å“é …
// ------------------------------
function createMainItem() {
  return {
    id: uuid(),
    type: "main",   // å¤§é …
    name: "æœªå‘½åå¤§é …",
    spec: "",
    unit: "",
    qty: "",
    price: "",
    subItems: []    // å°é … / è£œå……å…§å®¹
  };
}


// ------------------------------
// å»ºç«‹ã€Œå°é …ã€å­å“é …ï¼ˆå¯å«è£œå……æ–‡å­—/åœ–ç‰‡ï¼‰
// ------------------------------
function createSubItem() {
  return {
    id: uuid(),
    type: "sub",
    name: "æœªå‘½åå°é …",
    spec: "",
    unit: "",
    qty: "",
    price: "",
    note: "",
    images: []
  };
}


// ------------------------------
// å»ºç«‹ä¸€æ¢ã€Œè£œå……æ–‡å­—ã€
// ------------------------------
function createNoteLine() {
  return {
    id: uuid(),
    type: "note",
    text: "è£œå……èªªæ˜..."
  };
}


// ------------------------------
// å»ºç«‹ä¸€æ¢ã€Œè£œå……åœ–ç‰‡ã€
// ------------------------------
function createImageLine(base64) {
  return {
    id: uuid(),
    type: "image",
    src: base64
  };
}


/* --------------------------------------------------
   åœ¨å ±åƒ¹å–® items ä¸­åŠ å…¥å¤§é …
   -------------------------------------------------- */
function addMainItem(quote, updateQuote) {
  const newItem = createMainItem();
  updateQuote(quote.id, { items: [...quote.items, newItem] });
}


/* --------------------------------------------------
   åœ¨å¤§é …åº•ä¸‹æ–°å¢å°é …
   -------------------------------------------------- */
function addSubItem(parentItemId, quote, updateQuote) {
  const newItems = quote.items.map(item => {
    if (item.id === parentItemId) {
      return {
        ...item,
        subItems: [...item.subItems, createSubItem()]
      };
    }
    return item;
  });

  updateQuote(quote.id, { items: newItems });
}


/* --------------------------------------------------
   åœ¨å°é …åº•ä¸‹æ–°å¢è£œå……æ–‡å­—
   -------------------------------------------------- */
function addNoteLine(parentItemId, quote, updateQuote) {
  const newItems = quote.items.map(item => {
    if (item.id !== parentItemId) return item;

    return {
      ...item,
      subItems: [...item.subItems, createNoteLine()]
    };
  });

  updateQuote(quote.id, { items: newItems });
}


/* --------------------------------------------------
   åœ¨å°é …åº•ä¸‹æ–°å¢è£œå……åœ–ç‰‡
   -------------------------------------------------- */
function addImageLine(parentItemId, base64, quote, updateQuote) {
  const newItems = quote.items.map(item => {
    if (item.id !== parentItemId) return item;

    return {
      ...item,
      subItems: [...item.subItems, createImageLine(base64)]
    };
  });

  updateQuote(quote.id, { items: newItems });
}


/* --------------------------------------------------
   åˆªé™¤å¤§é …ã€å°é …æˆ–è£œå……å…§å®¹
   -------------------------------------------------- */
function deleteItem(targetId, quote, updateQuote) {
  let newItems = [];

  quote.items.forEach(main => {
    // åˆªé™¤å¤§é …
    if (main.id === targetId) return;

    // éæ¿¾å°é …ã€è£œå……å…§å®¹
    const filteredSub = main.subItems.filter(sub => sub.id !== targetId);

    newItems.push({ ...main, subItems: filteredSub });
  });

  updateQuote(quote.id, { items: newItems });
}


/* --------------------------------------------------
   æ›´æ–°å¤§é … / å°é … / è£œå……å…§å®¹è³‡æ–™
   -------------------------------------------------- */
function updateItem(targetId, data, quote, updateQuote) {
  const newItems = quote.items.map(main => {
    // æ›´æ–°å¤§é …
    if (main.id === targetId) {
      return { ...main, ...data };
    }

    // æ›´æ–°å°é …æˆ–è£œå……å…§å®¹
    const newSubs = main.subItems.map(sub => {
      if (sub.id === targetId) {
        return { ...sub, ...data };
      }
      return sub;
    });

    return { ...main, subItems: newSubs };
  });

  updateQuote(quote.id, { items: newItems });
}
/****************************************************
 * P4-3-2 â€” è¦æ ¼å“åŠ å…¥å™¨ï¼ˆå¾ Google Sheet é¸æ“‡å“é …ï¼‰
 ****************************************************/

function SpecSelector({ onSelect }) {
  const { specItems } = React.useContext(AppContext);
  const [keyword, setKeyword] = React.useState("");

  // æœå°‹éæ¿¾
  const filtered = specItems.filter(item =>
    item.name?.includes(keyword) || item.spec?.includes(keyword)
  );

  return (
    <div className="p-3 bg-white rounded shadow mb-4 no-print">
      <h2 className="font-bold text-lg mb-2">å¿«é€ŸåŠ å…¥è¦æ ¼å“</h2>

      <input
        className="border p-2 w-full rounded mb-2"
        placeholder="æœå°‹å“å / è¦æ ¼"
        value={keyword}
        onChange={(e) => setKeyword(e.target.value)}
      />

      <div className="max-h-64 overflow-y-auto border rounded">
        {filtered.map((item, idx) => (
          <div
            key={idx}
            className="p-2 hover:bg-blue-100 cursor-pointer flex justify-between"
            onClick={() => onSelect(item)}
          >
            <div>
              <div className="font-bold">{item.name}</div>
              <div className="text-sm text-gray-600">{item.spec}</div>
            </div>
            <div className="text-right text-sm">
              <div>{item.unit}</div>
              <div className="font-bold text-blue-600">$ {item.price}</div>
            </div>
          </div>
        ))}

        {filtered.length === 0 && (
          <div className="p-4 text-center text-gray-400">æŸ¥ç„¡è³‡æ–™</div>
        )}
      </div>
    </div>
  );
}
/****************************************************
 * P4-3-3 â€” å“é …æ¸…å–®ï¼ˆå¤§é …ã€å°é …ã€è£œå……å…§å®¹ï¼‰UI
 ****************************************************/


/* --------------------------------------------------
   è£œå……åœ–ç‰‡ä¸Šå‚³ï¼ˆè½‰ Base64ï¼‰
   -------------------------------------------------- */
function UploadImageButton({ onUpload }) {
  function handleFile(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      onUpload(reader.result);
    };
    reader.readAsDataURL(file);
  }

  return (
    <label className="cursor-pointer text-blue-600 hover:underline">
      ï¼‹åœ–ç‰‡
      <input type="file" accept="image/*" className="hidden" onChange={handleFile} />
    </label>
  );
}


/* --------------------------------------------------
   å°é … / è£œå…… è¡Œ UI
   -------------------------------------------------- */
function SubItemRow({ sub, onUpdate, onDelete }) {
  // è£œå……æ–‡å­—
  if (sub.type === "note") {
    return (
      <div className="pl-6 flex items-center gap-2 py-1">
        <textarea
          className="border p-1 rounded flex-1"
          value={sub.text}
          onChange={(e) => onUpdate({ text: e.target.value })}
        />
        <button className="text-red-600" onClick={onDelete}>åˆªé™¤</button>
      </div>
    );
  }

  // è£œå……åœ–ç‰‡
  if (sub.type === "image") {
    return (
      <div className="pl-6 py-2 flex items-center gap-4">
        <img src={sub.src} className="w-32 h-auto border rounded" />
        <button className="text-red-600" onClick={onDelete}>åˆªé™¤</button>
      </div>
    );
  }

  // å°é …è³‡æ–™åˆ—
  return (
    <div className="pl-6 grid grid-cols-12 gap-2 items-center py-1">

      {/* å°é …åç¨± */}
      <input
        className="border p-1 rounded col-span-3"
        value={sub.name}
        onChange={(e) => onUpdate({ name: e.target.value })}
      />

      {/* è¦æ ¼ */}
      <input
        className="border p-1 rounded col-span-3"
        value={sub.spec}
        onChange={(e) => onUpdate({ spec: e.target.value })}
      />

      {/* å–®ä½ */}
      <input
        className="border p-1 rounded col-span-1"
        value={sub.unit}
        onChange={(e) => onUpdate({ unit: e.target.value })}
      />

      {/* æ•¸é‡ */}
      <input
        className="border p-1 rounded col-span-1"
        value={sub.qty}
        onChange={(e) => onUpdate({ qty: e.target.value })}
      />

      {/* å–®åƒ¹ */}
      <input
        className="border p-1 rounded col-span-2"
        value={sub.price}
        onChange={(e) => onUpdate({ price: e.target.value })}
      />

      {/* é‡‘é¡ */}
      <div className="col-span-1 font-bold text-right">
        {formatMoney(calcAmount(sub))}
      </div>

      {/* åˆªé™¤ */}
      <button className="col-span-1 text-red-600" onClick={onDelete}>
        åˆªé™¤
      </button>
    </div>
  );
}


/* --------------------------------------------------
   å¤§é … Row UI
   -------------------------------------------------- */
function MainItemRow({ item, quote, updateQuote }) {

  function update(data) {
    updateItem(item.id, data, quote, updateQuote);
  }

  function addSub() {
    addSubItem(item.id, quote, updateQuote);
  }

  function addNoteLineToItem() {
    addNoteLine(item.id, quote, updateQuote);
  }

  function addImageToItem(base64) {
    addImageLine(item.id, base64, quote, updateQuote);
  }

  function removeItem() {
    deleteItem(item.id, quote, updateQuote);
  }

  return (
    <div className="border rounded p-3 mb-4 bg-white shadow">

      {/* å¤§é …è³‡æ–™å€ */}
      <div className="grid grid-cols-12 gap-2 items-center">

        {/* åç¨± */}
        <input
          className="border p-1 rounded col-span-3"
          value={item.name}
          onChange={(e) => update({ name: e.target.value })}
        />

        {/* è¦æ ¼ */}
        <input
          className="border p-1 rounded col-span-3"
          value={item.spec}
          onChange={(e) => update({ spec: e.target.value })}
        />

        {/* å–®ä½ */}
        <input
          className="border p-1 rounded col-span-1"
          value={item.unit}
          onChange={(e) => update({ unit: e.target.value })}
        />

        {/* æ•¸é‡ */}
        <input
          className="border p-1 rounded col-span-1"
          value={item.qty}
          onChange={(e) => update({ qty: e.target.value })}
        />

        {/* å–®åƒ¹ */}
        <input
          className="border p-1 rounded col-span-2"
          value={item.price}
          onChange={(e) => update({ price: e.target.value })}
        />

        {/* é‡‘é¡ */}
        <div className="font-bold col-span-1 text-right">
          {formatMoney(calcAmount(item))}
        </div>

        {/* åˆªé™¤ */}
        <button className="col-span-1 text-red-600" onClick={removeItem}>
          åˆªé™¤
        </button>
      </div>

      {/* å°é … / è£œå……å…§å®¹æ¸…å–® */}
      <div className="mt-2">
        {item.subItems.map(sub => (
          <SubItemRow
            key={sub.id}
            sub={sub}
            onUpdate={(data) => updateItem(sub.id, data, quote, updateQuote)}
            onDelete={() => deleteItem(sub.id, quote, updateQuote)}
          />
        ))}
      </div>

      {/* æ“ä½œæŒ‰éˆ•åˆ— */}
      <div className="flex gap-4 mt-3 text-sm text-blue-600">
        <button onClick={addSub}>ï¼‹å°é …</button>
        <button onClick={addNoteLineToItem}>ï¼‹è£œå……æ–‡å­—</button>
        <UploadImageButton onUpload={addImageToItem} />
      </div>
    </div>
  );
}


/* --------------------------------------------------
   æ•´ä»½å“é …æ¸…å–®æ¸²æŸ“å€ ItemsEditor
   -------------------------------------------------- */
function ItemsEditor({ quote, updateQuote }) {
  return (
    <div className="mb-4">

      {/* è¦æ ¼å“å¿«é€ŸåŠ å…¥å™¨ï¼ˆGoogle Sheetï¼‰ */}
      <SpecSelector
        onSelect={(spec) => {
          const newMain = createMainItem();
          newMain.name = spec.name;
          newMain.spec = spec.spec;
          newMain.unit = spec.unit;
          newMain.qty = 1;
          newMain.price = spec.price;

          updateQuote(quote.id, { items: [...quote.items, newMain] });
        }}
      />

      {/* æ–°å¢å¤§é …æŒ‰éˆ• */}
      <button
        className="px-4 py-2 bg-blue-600 text-white rounded mb-3"
        onClick={() => addMainItem(quote, updateQuote)}
      >
        ï¼‹æ–°å¢å¤§é …
      </button>

      {/* å„å¤§é … */}
      <div>
        {quote.items.map(item => (
          <MainItemRow
            key={item.id}
            item={item}
            quote={quote}
            updateQuote={updateQuote}
          />
        ))}
      </div>

      {quote.items.length === 0 && (
        <div className="text-center text-gray-400 mt-4">
          å°šç„¡å“é …ï¼Œè«‹æ–°å¢ã€‚
        </div>
      )}
    </div>
  );
}
/****************************************************
 * P4-4 â€” å‚™è¨»æ¬„ã€ä»˜æ¬¾æ¢ä»¶ã€ç¸½åƒ¹è¨ˆç®—å€å¡Š
 ****************************************************/


/* --------------------------------------------------
   å‚™è¨»æ¬„ä½
   -------------------------------------------------- */
function NotesEditor({ quote, update }) {
  return (
    <div className="p-4 bg-white rounded shadow mb-4">

      <h2 className="font-bold mb-2">å‚™è¨»èªªæ˜</h2>

      <textarea
        className="border p-2 w-full rounded h-32"
        value={quote.notes}
        onChange={(e) => update({ notes: e.target.value })}
      />
    </div>
  );
}


/* --------------------------------------------------
   ä»˜æ¬¾æ¢ä»¶æ¬„ä½
   -------------------------------------------------- */
function PaymentEditor({ quote, update }) {
  return (
    <div className="p-4 bg-white rounded shadow mb-4">

      <h2 className="font-bold mb-2">ä»˜æ¬¾æ¢ä»¶</h2>

      <textarea
        className="border p-2 w-full rounded h-24"
        value={quote.payment}
        onChange={(e) => update({ payment: e.target.value })}
      />
    </div>
  );
}


/* --------------------------------------------------
   ç¸½åƒ¹å€å¡Šï¼ˆåŸåƒ¹ + è­°åƒ¹ï¼‰
   -------------------------------------------------- */
function PriceSummary({ quote, update }) {
  const originalTotal = calcTotal(quote.items);
  const finalPrice = calcNegotiated(
    originalTotal,
    quote.discountPercent,
    quote.negotiatedPrice
  );

  return (
    <div className="p-4 bg-white rounded shadow mb-4">

      <h2 className="font-bold mb-2">ç¸½åƒ¹è³‡è¨Š</h2>

      {/* åŸå§‹é‡‘é¡ */}
      <div className="mb-3">
        <label className="font-bold">åŸå§‹ç¸½åƒ¹ï¼š</label>
        <span className="text-blue-700 font-bold ml-2">
          NT$ {formatMoney(originalTotal)}
        </span>
      </div>

      {/* æŠ˜æ‰£ç™¾åˆ†æ¯” */}
      <div className="mb-3">
        <label className="font-bold">è­°åƒ¹æŠ˜æ‰£ï¼ˆ%ï¼‰ï¼š</label>
        <input
          className="border p-1 w-20 rounded ml-2"
          value={quote.discountPercent}
          onChange={(e) => update({ discountPercent: e.target.value })}
          type="number"
        />
      </div>

      {/* è­°åƒ¹å¾Œé‡‘é¡ï¼ˆè¼¸å…¥ = è¦†è“‹æŠ˜æ‰£%) */}
      <div className="mb-3">
        <label className="font-bold">è­°åƒ¹å¾Œé‡‘é¡ï¼ˆç›´æ¥è¼¸å…¥ï¼‰ï¼š</label>
        <input
          className="border p-1 w-40 rounded ml-2"
          value={quote.negotiatedPrice}
          onChange={(e) => update({ negotiatedPrice: e.target.value })}
          type="number"
          placeholder="è¼¸å…¥å¾Œæœƒè¦†è“‹æŠ˜æ‰£%"
        />
      </div>

      {/* æœ€çµ‚æˆäº¤åƒ¹ */}
      <div className="mt-4 text-xl">
        <span className="font-bold">æœ€çµ‚æˆäº¤åƒ¹ï¼š</span>
        <span className="font-bold text-green-700 ml-2">
          NT$ {formatMoney(finalPrice)}
        </span>
      </div>
    </div>
  );
}
/****************************************************
 * Part 5-1 â€” åˆ—å°æ¨¡å¼ï¼šç”¢ç”Ÿåˆ—å°å°ˆç”¨é é¢å…§å®¹
 ****************************************************/
function PrintView({ quote, company }) {
  const info = COMPANY_DATA[company];
  const total = calcTotal(quote.items);
  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

  return (
    <div className="print-container">

      {/* å…¬å¸åç¨± */}
      <div className="print-company-header" style={{ fontSize: "26px", fontWeight: "bold" }}>
        {info.name}
      </div>

      {/* å…¬å¸è¯çµ¡è³‡è¨Š */}
      <div className="print-company-header" style={{ fontSize: "14px" }}>
        é›»è©±ï¼š{info.tel}ã€€å‚³çœŸï¼š{info.fax}ã€€Emailï¼š{info.email} <br />
        åœ°å€ï¼š{info.address}
      </div>

      {/* æ¨™é¡Œ + å ±åƒ¹å–®ç·¨è™Ÿ */}
      <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "10px" }}>
        <div className="print-title" style={{ marginBottom: "0" }}>
          å·¥ã€€ç¨‹ã€€å ±ã€€åƒ¹ã€€å–®
        </div>
        <div style={{ fontSize: "14px", textAlign: "right", marginTop: "5px" }}>
          å ±åƒ¹å–®ç·¨è™Ÿï¼š{quote.quoteNo}
        </div>
      </div>

      {/* å®¢æˆ¶è³‡è¨Š */}
      <table style={{ width: "100%", marginBottom: "10px" }}>
        <tbody>
          <tr>
            <td style={{ width: "20%" }}>é¡§å®¢åç¨±</td>
            <td style={{ width: "30%" }}>{quote.customerName}</td>
            <td style={{ width: "20%" }}>è¯çµ¡äºº</td>
            <td style={{ width: "30%" }}>{quote.contact}</td>
          </tr>
          <tr>
            <td>é›»è©±</td>
            <td>{quote.phone}</td>
            <td>å ±åƒ¹æ—¥æœŸ</td>
            <td>{quote.date}</td>
          </tr>
          <tr>
            <td>å·¥ç¨‹åç¨±</td>
            <td>{quote.title}</td>
            <td>å·¥ç¨‹åœ°é»</td>
            <td>{quote.location}</td>
          </tr>
        </tbody>
      </table>

      {/* å“é …åˆ—è¡¨ */}
      <table className="print-table">
        <thead>
          <tr>
            <th className="w-seq">åºè™Ÿ</th>
            <th className="w-name">å“å</th>
            <th className="w-spec">è¦æ ¼ / èªªæ˜</th>
            <th className="w-unit">å–®ä½</th>
            <th className="w-qty">æ•¸é‡</th>
            <th className="w-price">å–®åƒ¹</th>
            <th className="w-amt">é‡‘é¡</th>
          </tr>
        </thead>

        <tbody>
          {quote.items.map((item, index) => (
            <>
              <tr>
                <td>{index + 1}</td>
                <td>{item.name}</td>
                <td>{item.spec}</td>
                <td>{item.unit}</td>
                <td>{item.qty}</td>
                <td>{formatMoney(item.price)}</td>
                <td>{formatMoney(calcAmount(item))}</td>
              </tr>

              {item.subItems.map((sub, i) => (
                <tr key={`${index}-${i}`}>
                  <td></td>
                  <td>{sub.type === "sub" ? "â†’ " + sub.name : ""}</td>
                  <td>{sub.type === "sub" ? sub.spec : sub.text}</td>
                  <td>{sub.unit || ""}</td>
                  <td>{sub.qty || ""}</td>
                  <td>{sub.price ? formatMoney(sub.price) : ""}</td>
                  <td>{sub.qty ? formatMoney(calcAmount(sub)) : ""}</td>
                </tr>
              ))}
            </>
          ))}
        </tbody>
      </table>

      {/* åˆè¨ˆ */}
      <table style={{ width: "100%", marginTop: "12px" }}>
        <tbody>
          <tr>
            <td style={{ width: "80%", textAlign: "right", fontWeight: "bold" }}>æœªç¨…åˆè¨ˆï¼š</td>
            <td style={{ width: "20%", fontWeight: "bold" }}>{formatMoney(total)}</td>
          </tr>

          {negotiated !== total && (
            <tr>
              <td style={{ textAlign: "right", fontWeight: "bold" }}>è­°åƒ¹å¾Œé‡‘é¡ï¼š</td>
              <td style={{ fontWeight: "bold" }}>{formatMoney(negotiated)}</td>
            </tr>
          )}
        </tbody>
      </table>

      {/* å‚™è¨» */}
      <div style={{ marginTop: "16px" }}>
        <b>å‚™è¨»ï¼š</b><br />
        <div style={{ whiteSpace: "pre-line" }}>{quote.notes}</div>
      </div>

      {/* ä»˜æ¬¾æ¢ä»¶ */}
      <div style={{ marginTop: "16px" }}>
        <b>ä»˜æ¬¾æ¢ä»¶ï¼š</b><br />
        <div style={{ whiteSpace: "pre-line" }}>{quote.payment}</div>
      </div>

      {/* å°ç«  + å®¢æˆ¶ç°½å */}
      <div style={{ marginTop: "26px", display: "flex", justifyContent: "space-between" }}>
        <div>
          å®¢æˆ¶å›ç°½æ¬„ï¼š<br /><br /><br />
          ___________________________
        </div>

        <div style={{ textAlign: "center" }}>
          {info.name}<br />
          <span style={{ fontSize: "12px" }}>ï¼ˆæœ¬å…¬å¸è“‹ç« å°ˆç”¨å€ï¼‰</span>
          <div style={{ marginTop: "6px" }}>
            <img
              src={info.stamp}
              style={{ width: "120px", height: "120px", objectFit: "contain" }}
            />
          </div>
        </div>
      </div>

      <div id="print-page-number"></div>
    </div>
  );
}

/****************************************************
 * Part 5-2 â€” åŒ¯å‡º Excelï¼ˆå«å°é …ã€è£œå……ã€è­°åƒ¹ï¼‰
 ****************************************************/
function exportExcel(quote, company) {
  const info = COMPANY_DATA[company];
  const rows = [];

  rows.push([info.name]);
  rows.push([info.tel]);
  rows.push([info.fax]);
  rows.push([info.email]);
  rows.push([info.address]);
  rows.push([]);
  rows.push(["å·¥ç¨‹å ±åƒ¹å–®"]);
  rows.push([]);

  rows.push(["é¡§å®¢åç¨±", quote.customerName]);
  rows.push(["è¯çµ¡äºº", quote.contact]);
  rows.push(["é›»è©±", quote.phone]);
  rows.push(["å·¥ç¨‹åç¨±", quote.title]);
  rows.push(["å·¥ç¨‹åœ°é»", quote.location]);
  rows.push(["å ±åƒ¹æ—¥æœŸ", quote.date]);
  rows.push([]);

  rows.push(["å“å", "è¦æ ¼", "å–®ä½", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]);

  quote.items.forEach(main => {
    rows.push([
      main.name,
      main.spec,
      main.unit,
      main.qty,
      main.price,
      calcAmount(main)
    ]);

    main.subItems.forEach(sub => {
      if (sub.type === "sub") {
        rows.push([
          "â†’ " + sub.name,
          sub.spec,
          sub.unit,
          sub.qty,
          sub.price,
          calcAmount(sub)
        ]);
      } else if (sub.type === "note") {
        rows.push(["â€»" + sub.text, "", "", "", "", ""]);
      }
    });
  });

  const total = calcTotal(quote.items);
  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

  rows.push([]);
  rows.push(["æœªç¨…åˆè¨ˆ", "", "", "", "", total]);
  if (negotiated !== total) {
    rows.push(["è­°åƒ¹å¾Œé‡‘é¡", "", "", "", "", negotiated]);
  }

  rows.push([]);
  rows.push(["å‚™è¨»"]);
  quote.notes.split("\n").forEach(line => rows.push([line]));
  rows.push([]);
  rows.push(["ä»˜æ¬¾æ¢ä»¶"]);
  quote.payment.split("\n").forEach(line => rows.push([line]));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);

  ws["!cols"] = [
    { wch: 30 },
    { wch: 30 },
    { wch: 8 },
    { wch: 8 },
    { wch: 12 },
    { wch: 15 }
  ];

  XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å–®");

  XLSX.writeFile(wb, `${quote.title}_å ±åƒ¹å–®.xlsx`);
}

/****************************************************
 * Part 5-3 â€” åŒ¯å‡ºè­°åƒ¹ Excel
 ****************************************************/
function exportExcelNegotiated(quote, company) {
  const total = calcTotal(quote.items);
  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

  const clone = { ...quote, negotiatedPrice: negotiated };

  const original = XLSX.writeFile;
  XLSX.writeFile = function(workbook, name) {
    return original(workbook, name.replace(".xlsx", "_è­°åƒ¹.xlsx"));
  };

  exportExcel(clone, company);
  XLSX.writeFile = original;
}

/****************************************************
 * Part 5-4 â€” å·¥å…·åˆ— UIï¼ˆåˆ—å° / åŒ¯å‡ºï¼‰
 ****************************************************/
function ToolBar({ quote, company }) {
  if (!quote) return null;

  return (
    <div className="no-print p-3 flex gap-3 border-b bg-white">
      <button className="px-4 py-2 bg-blue-700 text-white rounded"
        onClick={() => openPrint()}>
        ğŸ–¨ åˆ—å° / PDF
      </button>

      <button className="px-4 py-2 bg-green-700 text-white rounded"
        onClick={() => exportExcel(quote, company)}>
        ğŸ“Š åŒ¯å‡º Excel
      </button>

      <button className="px-4 py-2 bg-orange-600 text-white rounded"
        onClick={() => exportExcelNegotiated(quote, company)}>
        ğŸ§¾ åŒ¯å‡ºè­°åƒ¹ Excel
      </button>
    </div>
  );
}

/****************************************************
 * Part 5-5 â€” åˆ—å°æ¸²æŸ“ & æ‰“å°è§¸ç™¼
 ****************************************************/
function renderPrintView(quote, company) {
  const root = document.getElementById("printArea");
  ReactDOM.render(<PrintView quote={quote} company={company} />, root);
}

/****************************************************
 * Part 5-6 ï½ 5-10 â€” åˆ—å°åŠŸèƒ½æœ€çµ‚æ•´åˆï¼ˆå«é ç¢¼ï¼‰
 ****************************************************/
function openPrint() {
  const app = window.__APP_CONTEXT__;
  if (!app) return alert("ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° Context");

  const { quotes, activeQuoteId, company } = app;
  const quote = quotes.find(q => q.id === activeQuoteId);

  if (!quote) return alert("è«‹å…ˆé¸æ“‡å ±åƒ¹å–®");

  renderPrintView(quote, company);

  /* P5-10ï¼šè¨ˆç®—é ç¢¼ */
  function updatePageNumber() {
    const totalPages = Math.ceil(
      document.body.scrollHeight / window.innerHeight
    );
    const el = document.getElementById("print-page-number");
    if (el) el.textContent = `Page 1 of ${totalPages}`;
  }
  updatePageNumber();

  setTimeout(() => {
    window.print();
  }, 150);
}

/****************************************************
 * P5-9 + P5-10 â€” åˆ—å° CSSï¼ˆè¡¨é ­é‡è¤‡ + é ç¢¼ï¼‰
 ****************************************************/
@media print {
  .no-print { display: none !important; }

  .print-container {
    display: block !important;
    padding: 10mm;
    font-size: 14px;
  }

  table { border-collapse: collapse; width: 100%; }
  table th, table td { border: 1px solid black; padding: 3px 4px; }

  thead { display: table-header-group !important; }
  tfoot { display: table-footer-group !important; }

  tr { page-break-inside: avoid !important; }

  #print-page-number {
    position: fixed;
    bottom: 10mm;
    right: 10mm;
    font-size: 12px;
  }
}

/****************************************************
 * P5 â€” App ä¸»çµ„è£ï¼ˆå·¦å´ç®¡ç† / å³å´ç·¨è¼¯ï¼‰
 ****************************************************/

function App() {
  const {
    quotes,
    activeQuoteId,
    updateQuote,
    company
  } = React.useContext(AppContext);

  const activeQuote = quotes.find(q => q.id === activeQuoteId);

  return (
    <div className="min-h-screen flex">

      {/* ---------------- å·¦å´é‚Šæ¬„ ---------------- */}
      <div className="w-72 bg-gray-100 p-4 border-r no-print overflow-y-auto">
        <CompanySelector />
        <ModeSelector />
        <QuoteManager />
      </div>

      {/* ---------------- ä¸»å…§å®¹ ---------------- */}
      <div className="flex-1 p-6 overflow-y-auto">

        {!activeQuote && (
          <div className="text-center text-gray-400 text-xl mt-20">
            â† è«‹å…ˆåœ¨å·¦å´æ–°å¢æˆ–é¸æ“‡å ±åƒ¹å–®
          </div>
        )}

        {activeQuote && (
          <>
            {/* å®¢æˆ¶è³‡æ–™ + å…¬å¸æŠ¬é ­ */}
            <QuoteEditor />

            {/* å“é …ç·¨è¼¯å€ */}
            <ItemsEditor
              quote={activeQuote}
              updateQuote={updateQuote}
            />

            {/* å‚™è¨» */}
            <NotesEditor
              quote={activeQuote}
              update={(data) => updateQuote(activeQuote.id, data)}
            />

            {/* ä»˜æ¬¾æ¢ä»¶ */}
            <PaymentEditor
              quote={activeQuote}
              update={(data) => updateQuote(activeQuote.id, data)}
            />

            {/* ç¸½åƒ¹å€åŸŸ */}
            <PriceSummary
              quote={activeQuote}
              update={(data) => updateQuote(activeQuote.id, data)}
            />

            {/* åˆ—å° / åŒ¯å‡ºï¼ˆæ–°ç‰ˆ ToolBarï¼‰ */}
            <ToolBar quote={activeQuote} company={company} />
          </>
        )}
      </div>
    </div>
  );
}


/****************************************************
 * React DOM æ¸²æŸ“
 ****************************************************/
ReactDOM.createRoot(document.getElementById("root")).render(
  <AppProvider>
    <App />
  </AppProvider>
);

