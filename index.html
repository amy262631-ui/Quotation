<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/react-dom@18/umd/react-dom-server.browser.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
    body {
        background: #f3ff6;
        font-family: "Microsoft JhengHei", sans-serif;
    }
    </style>

    <style>
    /* åˆ—å°å°ˆå±¬æ¨£å¼ (ä¿æŒä¸è®Š) */
    @media print {

        /* éš±è—éåˆ—å°å…ƒç´  */
        .no-print {
            display: none !important;
        }

        /* åˆ—å°å®¹å™¨ï¼šç¢ºä¿å…§å®¹æ­£ç¢ºå‘ˆç¾ */
        body, html {
            margin: 0;
            padding: 0;
        }
        
        #root {
            display: none; /* éš±è—ä¸»ç·¨è¼¯å€ */
        }
        
        #printArea {
            display: block !important;
            margin: 0;
            padding: 12mm;
            font-size: 13px; /* åˆ—å°å­—é«”ç•¥å° */
            color: black;
            width: 210mm; /* A4 å¯¬åº¦ */
            box-sizing: border-box;
        }

        /* æ¨™é¡Œ */
        .print-header h1 {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
        }

        /* å®¢æˆ¶/å…¬å¸è³‡è¨Šè¡¨æ ¼ */
        .print-info-table {
            width: 100%;
            border: 2px solid black;
            margin-bottom: 10px;
        }
        .print-info-table td {
            border: 1px solid black;
            padding: 4px 8px;
            vertical-align: middle;
        }
        .print-info-label {
            width: 15%;
            background: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }

        /* å ±åƒ¹é …ç›®è¡¨æ ¼ */
        table.print-items-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 13px;
            table-layout: fixed; /* å›ºå®šåˆ—å¯¬ */
        }

        .print-items-table th, .print-items-table td {
            border: 1px solid black;
            padding: 4px 6px;
            vertical-align: top;
            line-height: 1.4;
            height: auto; /* ç¢ºä¿å…§å®¹èƒ½æ’é–‹é«˜åº¦ */
        }

        .print-items-table th {
            background-color: #e0e0e0;
            text-align: center;
        }
        
        .print-items-table td:nth-child(5), /* æ•¸é‡ */
        .print-items-table td:nth-child(6), /* å–®åƒ¹ */
        .print-items-table td:nth-child(7) { /* é‡‘é¡ */
            text-align: right;
        }

        /* è¡¨æ ¼åˆ†é æ§åˆ¶ */
        thead {
            display: table-header-group; 
        }
        
        tr {
            page-break-inside: avoid; /* é˜²æ­¢è¡Œè¢«æˆªæ–· */
        }
        
        /* ç¸½è¨ˆå€å¡Š */
        .print-total-box {
            border: 1px solid black;
            padding: 10px;
            font-size: 14px;
            margin-top: 10px;
        }

        /* åœ–ç‰‡åˆ—å°æ¨£å¼ */
        .print-image {
            max-width: 150px; /* é™åˆ¶åˆ—å°åœ–ç‰‡å¤§å° */
            height: auto;
            margin-top: 5px;
            display: block;
        }

        /* å‚™è¨»/ä»˜æ¬¾æ¢ä»¶å€å¡Š */
        .print-notes-box {
            margin-top: 15px;
            border: 1px solid black;
            padding: 10px;
            white-space: pre-wrap; /* ä¿æŒæ›è¡Œ */
        }
    }
    </style>
</head>

<body class="text-gray-900">

    <div id="root"></div>

    <div id="printArea" class="hidden">
        <div id="print-page-number"></div>
        {/* åˆ—å°å…§å®¹å°‡åœ¨é€™è£¡ç”Ÿæˆ */}
    </div>

<script type="text/babel">
// P1 â€” å…¬å¸è³‡æ–™ / ä»˜æ¬¾æ¢ä»¶ / å‚™è¨» / æ¨¡å¼æ¨¡æ¿
const COMPANY_DATA = {
    herhsin: {
        name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
        tel: "07-6517476",
        fax: "07-6517994",
        email: "admin@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³æ—ä¸‰è·¯383-3è™Ÿ",
        stamp: "herhsin_stamp_placeholder.png" // ä½”ä½ç¬¦
    },
    sinchang: {
        name: "è–ªæ˜Œæœ‰é™å…¬å¸",
        tel: "07-6521927",
        fax: "07-6517994",
        email: "affairs@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³æ—ä¸‰è·¯383-3è™Ÿ",
        stamp: "sinchang_stamp_placeholder.png" // ä½”ä½ç¬¦
    }
};

// é è¨­å‚™è¨»
const DEFAULT_NOTES = `1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚`;

// é è¨­ä»˜æ¬¾æ¢ä»¶
const DEFAULT_PAYMENT = `è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%`;

// å ±åƒ¹æ¨¡å¼æ¨¡æ¿
const QUOTE_MODES = [
    {
        id: "modeA",
        name: "æ‹Œåˆæ©Ÿæ¼æ¼¿æ›´æ›",
        description: "é©ç”¨æ‹Œåˆæ©Ÿç¶­ä¿®ã€æ¼æ¼¿è™•ç†ç­‰ã€‚",
        defaultItems: [],
        defaultNotes: DEFAULT_NOTES,
        defaultPayment: DEFAULT_PAYMENT
    },
    {
        id: "modeB",
        name: "è¨­å‚™éŠ·å”®",
        description: "é©ç”¨å‚™å“ã€å–®æ©ŸéŠ·å”®èˆ‡å®‰è£ã€‚",
        defaultItems: [],
        defaultNotes: DEFAULT_NOTES,
        defaultPayment: DEFAULT_PAYMENT
    },
    {
        id: "modeC",
        name: "è¨­å‚™æ›´æ›å·¥ç¨‹",
        description: "é©ç”¨æ•´æ©Ÿæ›´æ–°ã€æ–™ä»¶æ›´æ›å·¥ç¨‹ã€‚",
        defaultItems: [],
        defaultNotes: DEFAULT_NOTES,
        defaultPayment: DEFAULT_PAYMENT
    }
];

// P2 â€” å·¥å…·å‡½å¼ï¼ˆå®Œæ•´ï¼‰
function uuid() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}

function formatDate(dateStr = new Date()) {
    const d = dateStr instanceof Date ? dateStr : new Date(dateStr);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`; // æ”¹ç‚º ISO æ ¼å¼ä»¥åˆ© input type="date"
}

function formatMoney(num) {
    // è™•ç†ç©ºå€¼å’Œéæ•¸å­—ï¼Œä½†å…è¨±æ•¸å­— 0
    if (num === "" || num === null || num === undefined || isNaN(Number(num))) return "";
    return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 });
}

function calcAmount(item) {
    // ç¢ºä¿ qty å’Œ price è½‰ç‚ºæ•¸å­—ï¼Œå¦å‰‡ç‚º 0
    const qty = Number(item.qty || 0);
    const price = Number(item.price || 0);
    return qty * price;
}

function calcTotal(items) {
    return items.reduce((sum, it) => {
        let mainAmt = calcAmount(it);
        let subs = 0;

        if (it.subItems && it.subItems.length > 0) {
            subs = it.subItems.reduce((s, sub) => s + calcAmount(sub), 0);
        }

        return sum + mainAmt + subs;
    }, 0);
}

function calcNegotiated(total, discountPercent, customPrice) {
    const cp = Number(customPrice || 0);
    const dp = Number(discountPercent || 0);
    
    if (cp > 0) return cp;
    
    if (dp > 0 && dp < 100) {
        return Math.round(total * (1 - dp / 100));
    }
    return total;
}

// å ±åƒ¹å–®ç·¨è™Ÿ
function generateQuoteNo() {
    // ä½¿ç”¨ YYYYMMDDHHMM + 4ä½äº‚æ•¸
    const d = new Date();
    const parts = [
        d.getFullYear(),
        String(d.getMonth() + 1).padStart(2, "0"),
        String(d.getDate()).padStart(2, "0"),
        String(d.getHours()).padStart(2, "0"),
        String(d.getMinutes()).padStart(2, "0"),
    ].join('');
    
    const random = Math.floor(1000 + Math.random() * 9000);
    
    return `Q${parts}-${random}`;
}

// è¼‰å…¥ Google Sheet CSV (éåŒæ­¥å‡½å¼)
async function loadCSV(url) {
    try {
        const res = await fetch(url);
        const text = await res.text();
        // é€™è£¡éœ€è¦ä¸€å€‹æ›´å¼·å¥çš„ CSV è§£æå™¨ï¼Œä½†ç‚ºäº†ä¿æŒå–®ä¸€æª”æ¡ˆæ¶æ§‹ï¼Œæš«æ™‚ç°¡åŒ–
        const rows = text.split("\n").map(r => r.trim()).filter(r => r.length > 0);
        if (rows.length === 0) return [];
        
        // å‡è¨­ç¬¬ä¸€è¡Œç‚ºæ¨™é ­ï¼Œä¸”ä¸åŒ…å«é€—è™Ÿ
        const header = rows[0].split(",").map(h => h.trim());

        return rows.slice(1).map(row => {
            // ç°¡æ˜“è§£æï¼Œå¯èƒ½æœƒåœ¨æ¬„ä½ä¸­æœ‰é€—è™Ÿæ™‚å‡ºéŒ¯
            const cols = row.split(",");
            const obj = {};

            header.forEach((h, i) => {
                // ä¿®å‰ªæ¨™é ­å’Œå…§å®¹
                obj[h] = cols[i] ? cols[i].trim() : "";
            });
            return obj;
        });
    } catch (error) {
        console.error("è¼‰å…¥æˆ–è§£æ Google Sheet CSV å¤±æ•—:", error);
        return [];
    }
}


// P3 â€” AppContextï¼ˆæ ¸å¿ƒè³‡æ–™ä¸­å¿ƒï¼‰
const AppContext = React.createContext();

function AppProvider({ children }) {
    // å…¬å¸ herhsin / sinchang
    const [company, setCompany] = React.useState("herhsin");

    // å ±åƒ¹å–®åˆ—è¡¨
    const [quotes, setQuotes] = React.useState([]);

    // æ­£åœ¨ç·¨è¼¯çš„å ±åƒ¹å–® ID
    const [activeQuoteId, setActiveQuoteId] = React.useState(null);

    // è¦æ ¼å“ï¼ˆä¾†è‡ª Google Sheetï¼‰
    const [specItems, setSpecItems] = React.useState([]);

    // Google Sheet è·¯å¾‘ (è«‹å‹™å¿…å°‡æ­¤æ›¿æ›ç‚ºæ‚¨çš„å…¬é–‹ CSV é€£çµ)
    const SPEC_CSV_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv"; 
        // ^^^^^^ è«‹ç¢ºä¿é€™æ˜¯æ‚¨æœ€æ–°çš„å…¬é–‹ CSV é€£çµ ^^^^^^

    //************* åˆå§‹åŒ–ï¼šå¾ localStorage è¼‰å…¥ *************/
    React.useEffect(() => {
        const saved = localStorage.getItem("HERHSIN_QUOTES");

        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                // ç¢ºä¿è¼‰å…¥çš„æ˜¯é™£åˆ—
                if (Array.isArray(parsed)) {
                    setQuotes(parsed);
                    if (parsed.length > 0) setActiveQuoteId(parsed[0].id);
                }
            } catch (e) {
                console.error("è§£æ localStorage æ•¸æ“šå¤±æ•—:", e);
                setQuotes([]);
                setActiveQuoteId(null);
            }
        }
    }, []);

    //************* è‡ªå‹•å­˜å› localStorage *************/
    React.useEffect(() => {
        try {
            localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
        } catch (e) {
            console.error("å¯«å…¥ localStorage å¤±æ•—:", e);
        }
    }, [quotes]);


    //************* è¼‰å…¥ Google Sheet è¦æ ¼å“ *************/
    React.useEffect(() => {
        // ç”±æ–¼ CDN ç’°å¢ƒä¸‹ä¸æ‡‰éåº¦ä¾è³´éåŒæ­¥å¤–éƒ¨è³‡æºï¼Œåƒ…åšä¸€æ¬¡è¼‰å…¥å˜—è©¦
        loadCSV(SPEC_CSV_URL).then(data => setSpecItems(data));
    }, [SPEC_CSV_URL]); // ä¾è³´é …åŠ å…¥ URLï¼Œå¦‚æœ URL æ”¹è®Šæœƒé‡æ–°è¼‰å…¥


    // å»ºç«‹æ–°å ±åƒ¹å–®ï¼ˆå¯å¥—ç”¨æ¨¡å¼ï¼‰
    const createQuote = React.useCallback((modeId = null) => {
        const mode = QUOTE_MODES.find(m => m.id === modeId);

        const newQuote = {
            id: uuid(),
            quoteNo: generateQuoteNo(),
            title: mode ? mode.name : "æœªå‘½åå·¥ç¨‹",
            customerName: "",
            contact: "",
            phone: "",
            location: "",
            date: formatDate(), // ä½¿ç”¨ä¿®æ­£å¾Œçš„æ ¼å¼åŒ–å‡½æ•¸
            items: mode && Array.isArray(mode.defaultItems) ? mode.defaultItems.map(item => ({...item, id: uuid(), subItems: []})) : [],
            notes: mode ? mode.defaultNotes : DEFAULT_NOTES,
            payment: mode ? mode.defaultPayment : DEFAULT_PAYMENT,
            discountPercent: 0,
            negotiatedPrice: 0
        };

        setQuotes(prev => {
            const newList = [newQuote, ...prev]; // æ–°å ±åƒ¹å–®æ”¾åœ¨æœ€å‰é¢
            setActiveQuoteId(newQuote.id);
            return newList;
        });
    }, []);


    // åˆªé™¤å ±åƒ¹å–®
    const deleteQuote = React.useCallback((id) => {
        setQuotes(prev => {
            const newList = prev.filter(q => q.id !== id);
            
            if (id === activeQuoteId) {
                setActiveQuoteId(newList.length > 0 ? newList[0].id : null);
            }
            return newList;
        });
    }, [activeQuoteId]);


    // æ›´æ–°å ±åƒ¹å–®æ¬„ä½
    const updateQuote = React.useCallback((id, data) => {
        setQuotes(prev =>
            prev.map(q => (q.id === id ? { ...q, ...data } : q))
        );
    }, []);


    // å¥—ç”¨æ¨¡å¼ï¼ˆè¦†è“‹ï¼šæ¨™é¡Œã€å‚™è¨»ã€ä»˜æ¬¾ã€é è¨­é …ç›®ï¼‰
    const applyMode = React.useCallback((modeId) => {
        const mode = QUOTE_MODES.find(m => m.id === modeId);
        if (!mode || !activeQuoteId) return;

        // ç¢ºä¿ defaultItems ä¸­çš„æ¯å€‹ item éƒ½æœ‰å”¯ä¸€çš„ id
        const itemsWithIds = mode.defaultItems.map(item => ({...item, id: uuid(), subItems: []}));

        updateQuote(activeQuoteId, {
            title: mode.name,
            items: itemsWithIds, // ä½¿ç”¨å¸¶æœ‰ ID çš„é …ç›®
            notes: mode.defaultNotes,
            payment: mode.defaultPayment,
        });
    }, [activeQuoteId, updateQuote]);


    // Context æä¾›çµ¦å…¨ App
    const activeQuote = quotes.find(q => q.id === activeQuoteId);
    
    const value = {
        company,
        setCompany,

        quotes,
        createQuote,
        deleteQuote,
        updateQuote,
        activeQuote, // ç›´æ¥æä¾›ç•¶å‰å ±åƒ¹å–®ç‰©ä»¶
        activeQuoteId,
        setActiveQuoteId,

        specItems,
        applyMode
    };

    // è®“åˆ—å°å’Œ Excel åŒ¯å‡ºåŠŸèƒ½å¯ä»¥å…¨åŸŸæŠ“åˆ° Context
    window.__APP_CONTEXT__ = value;

    return (
        <AppContext.Provider value={value}>
            {children}
        </AppContext.Provider>
    );
}
// P4-1 â€” å·¦å´å…ƒä»¶ï¼šå…¬å¸åˆ‡æ› / æ¨¡å¼é¸æ“‡ / å ±åƒ¹å–®åˆ—è¡¨


// --------------------------------------------------
// å…¬å¸åˆ‡æ›ï¼ˆä½•é‘« / è–ªæ˜Œï¼‰
// --------------------------------------------------
function CompanySelector() {
    const { company, setCompany } = React.useContext(AppContext);

    return (
        <div className="mb-6 no-print">
            <div className="font-bold mb-2">é¸æ“‡å…¬å¸</div>

            <div className="flex gap-2">
                <button
                    className={`px-3 py-1 rounded ${
                        company === "herhsin"
                            ? "bg-blue-600 text-white"
                            : "bg-gray-300 hover:bg-gray-400"
                    }`}
                    onClick={() => setCompany("herhsin")}
                >
                    ä½•é‘«å¯¦æ¥­
                </button>

                <button
                    className={`px-3 py-1 rounded ${
                        company === "sinchang"
                            ? "bg-blue-600 text-white"
                            : "bg-gray-300 hover:bg-gray-400"
                    }`}
                    onClick={() => setCompany("sinchang")}
                >
                    è–ªæ˜Œæœ‰é™å…¬å¸
                </button>
            </div>
        </div>
    );
}


// --------------------------------------------------
// å ±åƒ¹æ¨¡å¼é¸æ“‡å™¨ï¼ˆA ç¶­ä¿®ã€B æ¶ä¿®ã€C æ‹Œåˆæ©Ÿæ¼æ¼¿â€¦ï¼‰
// --------------------------------------------------
function ModeSelector() {
    const { createQuote } = React.useContext(AppContext);

    return (
        <div className="mb-6 no-print">
            <div className="font-bold mb-2">å»ºç«‹å ±åƒ¹å–®ï¼ˆå¥—ç”¨æ¨¡å¼ï¼‰</div>

            <div className="flex flex-col gap-2">

                {QUOTE_MODES.map(mode => (
                    <button
                        key={mode.id}
                        className="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-left"
                        onClick={() => createQuote(mode.id)}
                    >
                        â¤ {mode.name}
                    </button>
                ))}

                {/* ç„¡æ¨¡å¼ï¼šç©ºç™½å ±åƒ¹å–® */}
                <button
                    className="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                    onClick={() => createQuote(null)}
                >
                    ï¼‹ ç©ºç™½å ±åƒ¹å–®
                </button>
            </div>
        </div>
    );
}


// --------------------------------------------------
// å ±åƒ¹å–®ç®¡ç†ï¼šåˆ—è¡¨ã€åˆ‡æ›ã€åˆªé™¤ (ä¿®æ­£ç‰ˆ)
// --------------------------------------------------
function QuoteManager() {
    const {
        quotes,
        activeQuoteId,
        setActiveQuoteId,
        deleteQuote,
        createQuote, // ä½¿ç”¨ createQuote æ›¿æ› addQuote
    } = React.useContext(AppContext);

    // æ ¹æ“š ID æ’åºï¼Œè®“æœ€æ–°çš„æ’åœ¨æœ€ä¸Šé¢
    const sortedQuotes = React.useMemo(() => {
        // ç¢ºä¿ quotes æ˜¯é™£åˆ—ä¸”åŒ…å«æœ‰æ•ˆçš„ id
        return [...(quotes || [])].sort((a, b) => {
            if (!a.id || !b.id) return 0;
            // æ ¹æ“šæ—¥æœŸæ’åºï¼Œæœ€æ–°æ—¥æœŸæ’å‰é¢
            if (a.date > b.date) return -1;
            if (a.date < b.date) return 1;
            return b.id.localeCompare(a.id); // æ—¥æœŸç›¸åŒå‰‡ç”¨ ID
        });
    }, [quotes]);


    return (
        <div className="mt-4 border-t pt-4"> 
            <h3 className="font-bold text-lg mb-2 text-gray-700">å ±åƒ¹å–®åˆ—è¡¨</h3>

            {/* æ–°å¢å ±åƒ¹å–®æŒ‰éˆ• (å°å‘å»ºç«‹ç©ºç™½å ±åƒ¹å–®) */}
            <button
                className="w-full px-3 py-2 bg-purple-600 text-white rounded mb-4 hover:bg-purple-700 transition"
                onClick={() => createQuote(null)} // å»ºç«‹ç©ºç™½å ±åƒ¹å–®
            >
                ï¼‹ å»ºç«‹æ–°å ±åƒ¹å–®
            </button>

            <div className="max-h-80 overflow-y-auto">
            {sortedQuotes.length === 0 && ( // ä½¿ç”¨ sortedQuotes
                <div className="text-gray-500 text-sm text-center">
                    å°šç„¡è³‡æ–™ï¼Œè«‹å…ˆå»ºç«‹å ±åƒ¹å–®
                </div>
            )}

            <div className="flex flex-col gap-1">
                {sortedQuotes.map(q => ( // ä½¿ç”¨ sortedQuotes
                    <div
                        key={q.id}
                        className={`flex items-center justify-between px-3 py-2 rounded cursor-pointer transition
                            ${
                                q.id === activeQuoteId
                                    ? "bg-blue-600 text-white shadow-md"
                                    : "bg-gray-100 hover:bg-gray-200 text-gray-800"
                            }
                        `}
                        onClick={() => setActiveQuoteId(q.id)}
                    >
                        {/* æ–‡å­—å€å¡Šï¼šåŠ å…¥ min-w-0 å…è¨±å£“ç¸®/æˆªæ–· */}
                        <div className="flex flex-col flex-1 min-w-0 mr-2"> 
                            {/* æ¨™é¡Œï¼šç¢ºä¿æˆªæ–· */}
                            <span className="font-semibold truncate text-sm">{q.title || "ç„¡æ¨™é¡Œ"}</span>
                            {/* è³‡è¨Šï¼šè¼ƒå°çš„å­—é«”ï¼Œå…è¨±æ›è¡Œ */}
                            <span className="text-xs opacity-80 whitespace-normal">
                                {q.date || "N/A"} - {q.customerName || "ç„¡å®¢æˆ¶"}
                            </span>
                        </div>

                        {/* æŒ‰éˆ•å€å¡Šï¼šåŠ å…¥ flex-shrink-0 ç¢ºä¿å¯¬åº¦å›ºå®šï¼Œä¸æ“ å£“æ–‡å­— */}
                        <button
                            className={`text-red-600 text-xs ml-2 p-1 font-bold transition flex-shrink-0 
                            ${q.id === activeQuoteId ? "bg-red-500 hover:bg-red-600 text-white" : "hover:text-red-800"}
                            `}
                            onClick={(e) => {
                                e.stopPropagation(); // é¿å…é»åˆ°çˆ¶å±¤
                                if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ä»½å ±åƒ¹å–®ï¼Ÿ")) {
                                    deleteQuote(q.id);
                                }
                            }}
                        >
                            åˆªé™¤
                        </button>
                    </div>
                ))}
            </div>
            </div>
        </div>
    );
}
// P4-2 â€” å ±åƒ¹å–®æŠ¬é ­ï¼šå…¬å¸è³‡è¨Š + å®¢æˆ¶è³‡è¨Šè¼¸å…¥å€
function QuoteEditor() {
    const {
        company,
        activeQuote, // ç›´æ¥å–ç”¨ activeQuote
        updateQuote
    } = React.useContext(AppContext);

    const quote = activeQuote;

    // -------------------------------
    // æ›´æ–°æ¬„ä½ (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
    // -------------------------------
    const update = React.useCallback((field, value) => {
        // ç¢ºä¿ quote å­˜åœ¨å†å‘¼å« updateQuote
        if (quote) {
            updateQuote(quote.id, { [field]: value });
        }
    }, [quote, updateQuote]); // ä¾è³´é …æ”¹ç‚º quote ç‰©ä»¶

    // å¦‚æœ quote ä¸å­˜åœ¨ï¼Œææ—©è¿”å› (æ”¾åœ¨æ‰€æœ‰ Hooks ä¹‹å¾Œ)
    if (!quote) return null;

    // å¼•ç”¨ P1 çš„å…¨å±€æ•¸æ“š
    const info = COMPANY_DATA[company];

    return (
        <div className="bg-white p-6 shadow rounded mb-6 no-print">

            {/* ---------------- å…¬å¸åç¨± ---------------- */}
            <div className="text-2xl font-bold mb-4 text-blue-800">
                {info.name}
            </div>

            {/* ---------------- å…¬å¸è³‡æ–™ ---------------- */}
            <div className="text-sm text-gray-600 mb-6 border-b pb-4">
                <div>åœ°å€ï¼š{info.address}</div>
                <div>é›»è©±ï¼š{info.tel} | å‚³çœŸï¼š{info.fax}</div>
            </div>

            {/* ---------------- å ±åƒ¹å–®æ¨™é¡Œ & ç·¨è™Ÿ ---------------- */}
            <div className="flex items-end gap-4 mb-6">
                <div className="flex-1">
                    <label className="block text-sm text-gray-600 mb-1">å·¥ç¨‹åç¨±</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.title || ""}
                        onChange={(e) => update("title", e.target.value)}
                    />
                    
                </div>

                <div className="w-48">
                    <label className="block text-sm text-gray-600 mb-1">å ±åƒ¹å–®ç·¨è™Ÿ</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 bg-gray-100"
                        value={quote.quoteNo || ""}
                        readOnly
                    />
                </div>
            </div>

            {/* ---------------- å®¢æˆ¶è³‡è¨Š ---------------- */}
            <div className="grid grid-cols-2 gap-4 mb-6">

                <div>
                    <label className="block text-sm text-gray-600 mb-1">å®¢æˆ¶åç¨±</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.customerName || ""}
                        onChange={(e) => update("customerName", e.target.value)}
                    />
                </div>

                <div>
                    <label className="block text-sm text-gray-600 mb-1">è¯çµ¡äºº</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.contact || ""}
                        onChange={(e) => update("contact", e.target.value)}
                    />
                </div>

                <div>
                    <label className="block text-sm text-gray-600 mb-1">é›»è©±</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.phone || ""}
                        onChange={(e) => update("phone", e.target.value)}
                    />
                </div>

                <div>
                    <label className="block text-sm text-gray-600 mb-1">å ±åƒ¹æ—¥æœŸ</label>
                    <input
                        type="date"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        // date æ¬„ä½ä½¿ç”¨ yyyy-mm-dd æ ¼å¼
                        value={quote.date || formatDate()}
                        onChange={(e) => update("date", e.target.value)}
                    />
                </div>

                <div className="col-span-2">
                    <label className="block text-sm text-gray-600 mb-1">å·¥ç¨‹åœ°é»</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.location || ""}
                        onChange={(e) => update("location", e.target.value)}
                    />
                </div>
            </div>
        </div>
    );
}

// P4-3ï¼ˆAï¼‰NoteSubItemBlock â€” è£œå……æ–‡å­— (ä¿®å¾©ä½ç½®)
function NoteSubItemBlock({ sub, updateField, deleteSubItem }) {
  return (
    <div className="border rounded p-3 bg-gray-50 mb-2">
      {/* æ¨™é¡Œ + åˆªé™¤ */}
      <div className="flex justify-between items-center mb-2">
        <span className="text-sm font-bold text-gray-700">ğŸ“„ è£œå……æ–‡å­—</span>
        <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>
          åˆªé™¤
        </button>
      </div>

      <textarea
        className="w-full border rounded p-2 text-sm focus:ring focus:ring-yellow-100"
        rows="2"
        value={sub.text || ""}
        onChange={(e) => updateField("text", e.target.value)}
        placeholder="è¼¸å…¥è£œå……èªªæ˜â€¦"
      />
    </div>
  );
}

// P4-3ï¼ˆXï¼‰SpecItemSuggest â€” è¦æ ¼å“è‡ªå‹•å»ºè­°å…ƒä»¶
function SpecItemSuggest({ currentInput, specItems, onSelect }) {
    
    // æœå°‹çµæœï¼Œæœ€å¤šé¡¯ç¤º 5 å€‹
    const filteredItems = React.useMemo(() => {
        const input = (currentInput || "").toLowerCase().trim();

        if (input.length < 2) return [];

        return specItems
            .filter(item => 
                // ç¢ºä¿ 'å“å' æ¬„ä½å­˜åœ¨
                item['å“å'] && item['å“å'].toLowerCase().includes(input)
            )
            .slice(0, 5); // æœ€å¤š 5 å€‹
    }, [currentInput, specItems]);

    if (filteredItems.length === 0) return null;

    return (
        <div className="absolute z-10 top-full left-0 w-full bg-white border border-gray-300 rounded shadow-lg mt-1 max-h-48 overflow-y-auto">
            {filteredItems.map((item, index) => (
                <div
                    key={index}
                    className="p-2 cursor-pointer hover:bg-blue-100 text-sm border-b last:border-b-0"
                    onClick={() => onSelect(item)}
                >
                    {/* ä½¿ç”¨å¯¦éš›æ¬„ä½ï¼šå“å, è¦æ ¼1, å–®åƒ¹ */}
                    <div className="font-semibold text-gray-800">{item['å“å']}</div>
                    <div className="text-xs text-gray-600 truncate">è¦æ ¼: {item['è¦æ ¼1']} | å–®åƒ¹: {formatMoney(item['å–®åƒ¹'])}</div>
                </div>
            ))}
        </div>
    );
}


// P4-3ï¼ˆBï¼‰ItemSubItemBlock â€” å­é …ç›®ï¼ˆå«æ•¸é‡/å–®åƒ¹ï¼‰ (æ–°å¢è‡ªå‹•å»ºè­° - ä½¿ç”¨å¯¦éš›æ¬„ä½)
function ItemSubItemBlock({ sub, updateField, deleteSubItem }) {
    const { specItems } = React.useContext(AppContext); // å–å¾—è¦æ ¼å“åˆ—è¡¨
    
    // è¨ˆç®—ä¸¦æ ¼å¼åŒ–å°è¨ˆ
    const subtotal = formatMoney(calcAmount(sub));

    // è™•ç†æ•¸å­—è¼¸å…¥ (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
    const handleNumberChange = React.useCallback((field, value) => {
        // åªå…è¨±æ•¸å­—æˆ–ç©ºå­—ä¸²
        if (value === "" || !isNaN(Number(value))) {
            updateField(field, value);
        }
    }, [updateField]);
    
    // è™•ç†è¦æ ¼å“é¸æ“‡ (ä½¿ç”¨å¯¦éš›æ¬„ä½ï¼šè¦æ ¼1, å–®ä½, å–®åƒ¹)
    const handleSelectSpecItem = React.useCallback((spec) => {
        // å¾è¦æ ¼å“æ•¸æ“šè‡ªå‹•å¡«å…¥è¦æ ¼ã€å–®ä½ã€å–®åƒ¹
        updateField("name", spec['å“å'] || sub.name);
        updateField("spec", spec['è¦æ ¼1'] || sub.spec); // <-- ä½¿ç”¨ 'è¦æ ¼1'
        updateField("unit", spec['å–®ä½'] || sub.unit);
        updateField("price", spec['å–®åƒ¹'] || sub.price);
    }, [updateField, sub.name, sub.spec, sub.unit, sub.price]);

    return (
        <div className="border rounded p-3 bg-gray-50 mb-2">

            {/* æ¨™é¡Œ + åˆªé™¤ */}
            <div className="flex justify-between items-center mb-2">
                <span className="text-sm font-bold text-gray-700">ğŸ“¦ å­é …ç›®</span>
                <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>
                    åˆªé™¤
                </button>
                
            </div>

            <div className="grid grid-cols-12 gap-2 text-sm items-center relative">

                {/* åç¨± (col-span-3) - **ä½¿ç”¨ SpecItemSuggest** */}
                <div className="col-span-3 relative">
                    <input
                        className="border p-1 rounded w-full focus:ring focus:ring-blue-100"
                        value={sub.name || ""}
                        placeholder="åç¨±"
                        onChange={(e) => updateField("name", e.target.value)}
                    />
                    <SpecItemSuggest 
                        currentInput={sub.name} 
                        specItems={specItems} 
                        onSelect={handleSelectSpecItem}
                    />
                </div>

                {/* è¦æ ¼ (col-span-4) */}
                <input
                    className="border p-1 rounded col-span-4 focus:ring focus:ring-blue-100"
                    value={sub.spec || ""}
                    placeholder="è¦æ ¼"
                    onChange={(e) => updateField("spec", e.target.value)}
                />

                {/* å–®ä½ (col-span-1) */}
                <input
                    className="border p-1 rounded col-span-1 text-center focus:ring focus:ring-blue-100"
                    value={sub.unit || ""}
                    placeholder="å–®ä½"
                    onChange={(e) => updateField("unit", e.target.value)}
                />

                {/* æ•¸é‡ (col-span-1) */}
                <input
                    className="border p-1 rounded col-span-1 text-right focus:ring focus:ring-blue-100"
                    value={sub.qty || ""}
                    placeholder="æ•¸é‡"
                    type="number"
                    min="0"
                    onChange={(e) => handleNumberChange("qty", e.target.value)}
                />

                {/* å–®åƒ¹ (col-span-2) */}
                <input
                    className="border p-1 rounded col-span-2 text-right focus:ring focus:ring-blue-100"
                    value={sub.price || ""}
                    placeholder="å–®åƒ¹"
                    type="number"
                    min="0"
                    onChange={(e) => handleNumberChange("price", e.target.value)}
                />

                {/* å°è¨ˆ (col-span-1) */}
                <div className="col-span-1 text-right font-bold text-blue-600">
                    {subtotal}
                </div>
            </div>
        </div>
    );
}


// P4-3ï¼ˆCï¼‰ImageSubItemBlock â€” åœ–ç‰‡å°é …
function ImageSubItemBlock({ sub, updateField, deleteSubItem }) {
    // åœ–ç‰‡ä¸Šå‚³è™•ç† (ä¸æ˜¯ Hookï¼Œä¸éœ€è¦æå‡)
    function handleUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => updateField("src", reader.result);
        reader.readAsDataURL(file);
        e.target.value = ''; // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥ï¼Œä»¥ä¾¿é‡æ–°é¸æ“‡åŒä¸€æª”æ¡ˆ
    }

    return (
        <div className="border rounded p-3 bg-gray-50 mb-2">

            <div className="flex justify-between items-center mb-2">
                <span className="text-sm font-bold text-gray-700">ğŸ“· åœ–ç‰‡è£œå……</span>
                <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>åˆªé™¤</button>
            </div>

            {/*åœ–ç‰‡é è¦½*/}
            {sub.src ? (
                <img src={sub.src} className="max-w-xs mb-2 border rounded shadow" alt="é è¦½åœ–" />
            ) : (
                <div className="text-gray-500 text-sm mb-2 p-2 border border-dashed rounded bg-white">å°šæœªä¸Šå‚³åœ–ç‰‡</div>
            )}

            {/* ä¸Šå‚³æŒ‰éˆ• */}
            <label className="cursor-pointer text-blue-700 underline text-sm hover:text-blue-900">
                {sub.src ? "æ›´æ›åœ–ç‰‡" : "ä¸Šå‚³åœ–ç‰‡"}
                <input type="file" accept="image/*" className="hidden" onChange={handleUpload} />
            </label>
        </div>
    );
}


// P4-3ï¼ˆDï¼‰UploadImageButton â€” åœ¨åº•éƒ¨æ–°å¢åœ–ç‰‡ç”¨
function UploadImageButton({ onUpload }) {
    // åœ–ç‰‡ä¸Šå‚³è™•ç† (ä¸æ˜¯ Hookï¼Œä¸éœ€è¦æå‡)
    function handleSelect(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => onUpload(reader.result);
        reader.readAsDataURL(file);
        e.target.value = ''; // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥ï¼Œä»¥ä¾¿é‡æ–°é¸æ“‡åŒä¸€æª”æ¡ˆ
    }

    return (
        <label className="cursor-pointer text-blue-600 hover:text-blue-800 transition">
            ï¼‹è£œå……åœ–ç‰‡
            <input type="file" accept="image/*" className="hidden" onChange={handleSelect} />
        </label>
    );
}


// P4-3ï¼ˆEï¼‰SubItemWrapper â€” è‡ªå‹•åˆ†æµå°é …é¡å‹
function SubItemWrapper({ subItem, parentItem, quote, updateQuote }) {

    // æ›´æ–°æŸå€‹ subItem çš„ç‰¹å®šæ¬„ä½ (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
    const updateField = React.useCallback((field, value) => {
        const newItems = quote.items.map(m =>
            m.id === parentItem.id
                ? {
                    ...m,
                    // ç¢ºä¿ subItems å­˜åœ¨
                    subItems: (m.subItems || []).map(s =>
                        s.id === subItem.id ? { ...s, [field]: value } : s
                    )
                }
                : m
        );
        updateQuote(quote.id, { items: newItems });
    }, [quote.id, parentItem.id, subItem.id, quote.items, updateQuote]);

    // åˆªé™¤ subItem (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
    const deleteSubItem = React.useCallback(() => {
        const newItems = quote.items.map(m =>
            m.id === parentItem.id
                ? { ...m, subItems: (m.subItems || []).filter(s => s.id !== subItem.id) }
                : m
        );
        updateQuote(quote.id, { items: newItems });
    }, [quote.id, parentItem.id, subItem.id, quote.items, updateQuote]);

    const props = { sub: subItem, updateField, deleteSubItem };

    if (subItem.type === "note") return <NoteSubItemBlock {...props} />;
    if (subItem.type === "item") return <ItemSubItemBlock {...props} />;
    if (subItem.type === "image") return <ImageSubItemBlock {...props} />;

    return null;
}


// P4-3ï¼ˆFï¼‰MainItemBlock â€” å¤§é …ç·¨è¼¯ (ä¿®æ­£æ’ç‰ˆ + è‡ªå‹•å»ºè­°åŠŸèƒ½ - ä½¿ç”¨å¯¦éš›æ¬„ä½)
function MainItemBlock({ item, quote, updateQuote }) {
    const { specItems } = React.useContext(AppContext);

    // 1. æ›´æ–°å¤§é …è³‡æ–™ (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
    const update = React.useCallback((data) => {
        // ç¢ºä¿åªæ›´æ–°ç•¶å‰é …ç›®
        const newItems = quote.items.map(m =>
            m.id === item.id ? { ...m, ...data } : m
        );
        updateQuote(quote.id, { items: newItems });
    }, [quote.id, item.id, quote.items, updateQuote]);

    // 2. è™•ç†æ•¸å­—è¼¸å…¥ (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
    const handleNumberChange = React.useCallback((field, value) => {
        // å…è¨±ç©ºå­—ä¸²æˆ–æ•¸å­—
        if (value === "" || !isNaN(Number(value))) {
            update({ [field]: value });
        }
    }, [update]);

    // 3. åˆªé™¤å¤§é … (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
    const deleteMain = React.useCallback(() => {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å¤§é …ï¼Ÿ")) return;
        updateQuote(quote.id, { items: quote.items.filter(m => m.id !== item.id) });
    }, [quote.id, item.id, quote.items, updateQuote]);

    // 4. æ–°å¢å°é … (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
    const addSub = React.useCallback((type, src = "") => {
        const newSub = {
            id: uuid(),
            type,
            text: "",
            name: "",
            spec: "",
            unit: "",
            qty: "",
            price: "",
            src
        };

        const newItems = quote.items.map(m =>
            m.id === item.id ? { ...m, subItems: [...(m.subItems || []), newSub] } : m
        );

        updateQuote(quote.id, { items: newItems });
    }, [quote.id, item.id, quote.items, updateQuote]);

    // 5. è™•ç†è¦æ ¼å“é¸æ“‡ (ä½¿ç”¨å¯¦éš›æ¬„ä½ï¼šè¦æ ¼1, å–®ä½, å–®åƒ¹)
    const handleSelectSpecItem = React.useCallback((spec) => {
        // å¾è¦æ ¼å“æ•¸æ“šè‡ªå‹•å¡«å…¥è¦æ ¼ã€å–®ä½ã€å–®åƒ¹
        update({
            name: spec['å“å'] || item.name,
            spec: spec['è¦æ ¼1'] || item.spec, // <-- ä½¿ç”¨ 'è¦æ ¼1'
            unit: spec['å–®ä½'] || item.unit,
            price: spec['å–®åƒ¹'] || item.price,
        });
    }, [update, item.name, item.spec, item.unit, item.price]);

    // è¨ˆç®—ä¸¦æ ¼å¼åŒ–å°è¨ˆ (ä¸æ˜¯ Hookï¼Œæ”¾åœ¨ Hook ä¹‹å¾Œ)
    const mainTotal = formatMoney(calcAmount(item));

    return (
        <div className="border rounded p-4 bg-white shadow mb-4">

            {/* VVVV æ¨™é¡Œè¡Œ VVVV */}
            <div className="grid grid-cols-12 gap-2 text-sm font-bold text-gray-600 mb-2 border-b pb-1">
                <div className="col-span-3 text-left">å“å</div>
                <div className="col-span-3 text-left">è¦æ ¼</div>
                <div className="col-span-1 text-center">å–®ä½</div>
                <div className="col-span-1 text-right">æ•¸é‡</div>
                <div className="col-span-2 text-right">å–®åƒ¹</div>
                <div className="col-span-1 text-right">å°è¨ˆ</div>
                <div className="col-span-1"></div> {/* åˆªé™¤æŒ‰éˆ•æ¬„ä½ */}
            </div>

            {/* å¤§é …è³‡æ–™åˆ— */}
            <div className="grid grid-cols-12 gap-2 items-center">
                {/* å“å (col-span-3) - **ä½¿ç”¨ SpecItemSuggest** */}
                <div className="col-span-3 relative">
                    <input className="border p-1 rounded w-full focus:ring focus:ring-red-100 text-left"
                        value={item.name || ""} placeholder="å“å"
                        onChange={(e) => update({ name: e.target.value })} 
                    />
                    <SpecItemSuggest 
                        currentInput={item.name} 
                        specItems={specItems} 
                        onSelect={handleSelectSpecItem}
                    />
                </div>
                {/* è¦æ ¼ (col-span-3) */}
                <input className="border p-1 rounded col-span-3 focus:ring focus:ring-red-100 text-left"
                    value={item.spec || ""} placeholder="è¦æ ¼"
                    onChange={(e) => update({ spec: e.target.value })} />
                {/* å–®ä½ (col-span-1) */}
                <input className="border p-1 rounded col-span-1 text-center focus:ring focus:ring-red-100"
                    value={item.unit || ""} placeholder="å–®ä½"
                    onChange={(e) => update({ unit: e.target.value })} />
                {/* æ•¸é‡ (col-span-1) */}
                <input className="border p-1 rounded col-span-1 text-right focus:ring focus:ring-red-100"
                    value={item.qty || ""} placeholder="æ•¸é‡"
                    type="number" min="0"
                    onChange={(e) => handleNumberChange("qty", e.target.value)} />
                {/* å–®åƒ¹ (col-span-2) */}
                <input className="border p-1 rounded col-span-2 text-right focus:ring focus:ring-red-100"
                    value={item.price || ""} placeholder="å–®åƒ¹"
                    type="number" min="0"
                    onChange={(e) => handleNumberChange("price", e.target.value)} />

                {/* å°è¨ˆ (col-span-1) */}
                <div className="text-right font-bold col-span-1 text-red-700">
                    {mainTotal}
                </div>
                {/* åˆªé™¤æŒ‰éˆ• (col-span-1) */}
                <button className="text-red-600 col-span-1 text-sm hover:text-red-800" onClick={deleteMain}>
                    âœ•
                </button>
            </div>

            {/* å°é …åˆ—è¡¨ */}
            <div className="mt-3 border-t pt-3">
                {(item.subItems || []).map(sub => ( // ç¢ºä¿ subItems å­˜åœ¨
                    <SubItemWrapper
                        key={sub.id} 
                        subItem={sub}
                        parentItem={item}
                        quote={quote}
                        updateQuote={updateQuote}
                    />
                ))}
            </div>

            {/* æ“ä½œåˆ— */}
            <div className="flex gap-4 mt-3 text-blue-600 text-sm border-t pt-3">
                <button className="hover:text-blue-800 transition" onClick={() => addSub("item")}>ï¼‹ å­é …ç›®</button>
                <button className="hover:text-blue-800 transition" onClick={() => addSub("note")}>ï¼‹ è£œå……æ–‡å­—</button>
                <UploadImageButton onUpload={(src) => addSub("image", src)} />
            </div>
        </div>
    );
}
// P4-3ï¼ˆGï¼‰ItemsEditor â€” æ•´é«”å“é …ç®¡ç†
function ItemsEditor({ quote, updateQuote }) {
    // 1. æ–°å¢å¤§é … (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
    const addMain = React.useCallback(() => {
        const newMain = {
            id: uuid(),
            type: "main",
            name: "æœªå‘½åå¤§é …",
            spec: "",
            unit: "",
            qty: "",
            price: "",
            subItems: []
        };
        updateQuote(quote.id, { items: [...(quote.items || []), newMain] });
    }, [quote.id, quote.items, updateQuote]);

    return (
        <div className="mb-6 no-print">
            <h2 className="font-bold text-lg mb-2">å ±åƒ¹é …ç›®åˆ—è¡¨</h2>
            
            <button
                className="px-4 py-2 bg-blue-600 text-white rounded mb-4 hover:bg-blue-700 transition"
                onClick={addMain}
            >
                ï¼‹ æ–°å¢å·¥ç¨‹å¤§é …
            </button>
            
            {/* æ¸²æŸ“æ‰€æœ‰å¤§é … */}
            {(quote.items || []).map(item => (
                <MainItemBlock
                    key={item.id}
                    item={item}
                    quote={quote}
                    updateQuote={updateQuote}
                />
            ))}

            {quote.items.length === 0 && (
                <div className="text-gray-500 text-sm text-center p-4 border border-dashed rounded">
                    é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ–°å¢å ±åƒ¹é …ç›®
                    
                </div>
            )}
        </div>
    );
}

// P5-1 â€” NotesEditorï¼ˆå‚™è¨»èªªæ˜ï¼‰
function NotesEditor({ quote, update }) {
    return (
        <div className="bg-white p-4 shadow rounded h-full flex flex-col">
            <h3 className="font-bold mb-2">å‚™è¨»èªªæ˜ (ä¸å«ç¨…)</h3>
            <textarea
                className="w-full border rounded p-2 text-sm flex-1 whitespace-pre-wrap"
                rows="10"
                value={quote.notes || ""}
                onChange={(e) => update("notes", e.target.value)}
                placeholder="è¼¸å…¥å‚™è¨»èªªæ˜..."
            />
        </div>
    );
}

// P5-2 â€” PaymentEditorï¼ˆä»˜æ¬¾æ¢ä»¶ï¼‰
function PaymentEditor({ quote, update }) {
    return (
        <div className="bg-white p-4 shadow rounded h-full flex flex-col">
            <h3 className="font-bold mb-2">ä»˜æ¬¾æ¢ä»¶ (æœªå«ç¨…)</h3>
            <textarea
                className="w-full border rounded p-2 text-sm flex-1 whitespace-pre-wrap"
                rows="10"
                value={quote.payment || ""}
                onChange={(e) => update("payment", e.target.value)}
                placeholder="è¼¸å…¥ä»˜æ¬¾æ¢ä»¶..."
            />
        </div>
    );
}

// P5-3 â€” PriceSummaryï¼ˆç¸½åƒ¹æ‘˜è¦ï¼‰
function PriceSummary({ quote, update }) {
    // è¨ˆç®—ç¸½é‡‘é¡
    const total = calcTotal(quote.items || []);
    // è¨ˆç®—è­°å®šå¾Œåƒ¹æ ¼
    const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

    // è™•ç†æ•¸å­—è¼¸å…¥ (Hooks å¿…é ˆæ”¾åœ¨é ‚å±¤)
    const handleNumberChange = React.useCallback((field, value) => {
        if (value === "" || !isNaN(Number(value))) {
            update(field, value);
        }
    }, [update]);

    return (
        <div className="bg-white p-4 shadow rounded">
            <h3 className="font-bold mb-3">ç¸½åƒ¹æ‘˜è¦</h3>

            {/* ç¸½é¡ (æœªç¨…) */}
            <div className="flex justify-between items-center mb-2 p-2 border-b">
                <span className="text-gray-600">ç¸½é‡‘é¡ (æœªç¨…)</span>
                <span className="font-bold text-lg text-green-700">
                    {formatMoney(total)}
                </span>
                
            </div>

            {/* æŠ˜æ‰£ç™¾åˆ†æ¯” */}
            <div className="flex items-center mb-2">
                <label className="text-gray-600 w-24">æŠ˜æ‰£ (%)</label>
                <input
                    type="number"
                    className="w-20 border rounded px-2 py-1 text-right focus:ring-2 focus:ring-blue-300"
                    min="0"
                    max="100"
                    value={quote.discountPercent || ""}
                    onChange={(e) => handleNumberChange("discountPercent", e.target.value)}
                />
                <span className="ml-2 text-sm text-gray-500"> (è¼¸å…¥ 10 å³æ‰“ä¹æŠ˜)</span>
            </div>
            
            {/* è­°å®šåƒ¹æ ¼ (å¯è¦†è“‹æŠ˜æ‰£) */}
            <div className="flex items-center mb-4">
                <label className="text-gray-600 w-24">è­°å®šåƒ¹æ ¼</label>
                <input
                    type="number"
                    className="flex-1 border rounded px-2 py-1 text-right focus:ring-2 focus:ring-blue-300"
                    min="0"
                    value={quote.negotiatedPrice || ""}
                    onChange={(e) => handleNumberChange("negotiatedPrice", e.target.value)}
                />
            </div>

            {/* æœ€çµ‚åƒ¹æ ¼ (æœªç¨…) */}
            <div className="flex justify-between items-center p-3 rounded bg-blue-50 border border-blue-200">
                <span className="text-blue-800 font-semibold">æœ€çµ‚å ±åƒ¹ (æœªç¨…)</span>
                <span className="font-extrabold text-xl text-blue-800">
                    {formatMoney(negotiated)}
                </span>
            </div>
        </div>
    );
}

// P6 â€” Excel åŒ¯å‡ºåŠŸèƒ½
function exportToExcel(quote, companyInfo) {
    
    if (!quote) {
        alert("è«‹å…ˆé¸æ“‡æˆ–å»ºç«‹ä¸€ä»½å ±åƒ¹å–®ã€‚");
        return;
    }

    // è¨ˆç®—ç¸½é¡
    const total = calcTotal(quote.items || []);
    const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

    // Excel è¡¨é ­
    const header = [
        "é …æ¬¡", "å“å", "è¦æ ¼", "å–®ä½", "æ•¸é‡", "å–®åƒ¹", "é‡‘é¡", "å‚™è¨»"
    ];

    // å ±åƒ¹å–®å…§å®¹è¡¨æ ¼æ•¸æ“š
    const data = [];

    let itemIndex = 1;

    // è¿­ä»£æ‰€æœ‰å¤§é …å’Œå…¶å­é …
    (quote.items || []).forEach(item => {
        // è™•ç†å¤§é … (MainItemBlock)
        data.push([
            itemIndex++,
            item.name || "",
            item.spec || "",
            item.unit || "",
            Number(item.qty) || "",
            Number(item.price) || "",
            calcAmount(item),
            "" // å‚™è¨»æ¬„ä½
        ]);

        // è™•ç†å°é … (SubItems)
        (item.subItems || []).forEach(sub => {
            if (sub.type === 'item') {
                // æ¨™æº–å­é …ç›® (ItemSubItemBlock)
                data.push([
                    "", // å­é …ç›®ä¸å¯«é …æ¬¡
                    ` â†³ ${sub.name || ""}`, // ä½¿ç”¨ç¸®æ’ç¬¦è™Ÿ
                    sub.spec || "",
                    sub.unit || "",
                    Number(sub.qty) || "",
                    Number(sub.price) || "",
                    calcAmount(sub),
                    ""
                ]);
            } else if (sub.type === 'note' && sub.text) {
                // å‚™è¨»å°é … (NoteSubItemBlock)
                // å‚™è¨»å…§å®¹æ”¾åœ¨å‚™è¨»æ¬„ä½
                data.push([
                    "",
                    `å‚™è¨»ï¼š${sub.text}`, 
                    "", "", "", "", "", // å…¶å®ƒæ¬„ä½ç•™ç©º
                    ""
                ]);
            }
            // åœ–ç‰‡ (image) é¡å‹åœ¨ Excel ä¸­ä¸è™•ç†
        });
    });


    // æ§‹é€ æœ€çµ‚å·¥ä½œè¡¨æ•¸æ“š (åŒ…å«æŠ¬é ­è³‡è¨Š)
    const sheetData = [
        [companyInfo.name, "å·¥ç¨‹å ±åƒ¹å–®"],
        ["å·¥ç¨‹åç¨±:", quote.title || ""],
        ["å®¢æˆ¶åç¨±:", quote.customerName || ""],
        ["è¯çµ¡äºº:", quote.contact || ""],
        ["é›»è©±:", quote.phone || ""],
        ["å ±åƒ¹æ—¥æœŸ:", quote.date || ""],
        ["å·¥ç¨‹åœ°é»:", quote.location || ""],
        [],
        header, // é …ç›®è¡¨æ ¼è¡¨é ­
        ...data, // é …ç›®è¡¨æ ¼å…§å®¹
        [],
        ["ç¸½é‡‘é¡ (æœªç¨…)", "", "", "", "", "", total],
        ["æŠ˜æ‰£ (%)", quote.discountPercent || 0, "", "è­°å®šåƒ¹æ ¼ (æœªç¨…)", negotiated],
        ["æœ€çµ‚å ±åƒ¹ (æœªç¨…)", negotiated],
        [],
        ["å‚™è¨»èªªæ˜", quote.notes || ""],
        ["ä»˜æ¬¾æ¢ä»¶", quote.payment || ""]
    ];

    // å°‡æ•¸æ“šè½‰æ›ç‚ºå·¥ä½œç°¿
    const ws = XLSX.utils.aoa_to_sheet(sheetData);

    // --- è¨­ç½®æ¬„ä½å¯¬åº¦ (å¯é¸) ---
    const wscols = [
        { wch: 6 }, // é …æ¬¡
        { wch: 30 }, // å“å
        { wch: 35 }, // è¦æ ¼
        { wch: 8 },  // å–®ä½
        { wch: 8 },  // æ•¸é‡ (æ•¸å­—)
        { wch: 12 }, // å–®åƒ¹ (æ•¸å­—)
        { wch: 15 }, // é‡‘é¡ (æ•¸å­—)
        { wch: 20 }  // å‚™è¨»
    ];
    ws['!cols'] = wscols;


    // --- è¨­ç½®å–®å…ƒæ ¼æ ¼å¼ (å¯é¸) ---
    // é‡‘é¡æ¬„ä½è‡ªå‹•è¨­ç‚ºæ•¸å­—æ ¼å¼
    for (let i = 0; i < data.length; i++) {
        const rowIndex = i + 10; // æ•¸æ“šå¾ç¬¬ 10 è¡Œé–‹å§‹ (0-based: 9)
        const cellAddress = 'G' + rowIndex; // é‡‘é¡æ¬„ä½æ˜¯ G æ¬„
        const cell = ws[cellAddress];
        
        if (cell && cell.v !== "") {
            // è¨­ç‚ºæ•¸å­—æ ¼å¼ï¼Œæ–¹ä¾¿ Excel è‡ªå‹•è¨ˆç®—
            cell.t = 'n'; 
            cell.z = "#,##0"; // è¨­å®šåƒä½åˆ†éš”ç¬¦
        }
    }

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å–®å…§å®¹");

    // åŒ¯å‡ºæª”æ¡ˆ
    const fileName = `${quote.quoteNo}_${quote.customerName || 'å®¢æˆ¶'}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    console.log(`Excel åŒ¯å‡ºæˆåŠŸ: ${fileName}`);
}

// Excel åŒ¯å‡ºæŒ‰éˆ•å…ƒä»¶
function ExcelExporter() {
    const { activeQuote, company } = React.useContext(AppContext);
    const companyInfo = COMPANY_DATA[company];
    
    // è™•ç†é»æ“ŠåŒ¯å‡º
    const handleExport = React.useCallback(() => {
        exportToExcel(activeQuote, companyInfo);
    }, [activeQuote, companyInfo]);


    return (
        <button 
            className="w-full px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition shadow-md no-print"
            onClick={handleExport}
            disabled={!activeQuote} // å¦‚æœæ²’æœ‰å ±åƒ¹å–®å‰‡ç¦ç”¨
        >
            â¬‡ï¸ åŒ¯å‡º Excel (XLSX)
        </button>
    );
}

// P7 â€” åˆ—å°åŠŸèƒ½ (æ–°å¢)
function PrintButton() {
    const { activeQuote } = React.useContext(AppContext);

    const handlePrint = React.useCallback(() => {
        if (!activeQuote) {
            alert("è«‹å…ˆé¸æ“‡æˆ–å»ºç«‹ä¸€ä»½å ±åƒ¹å–®ã€‚");
            return;
        }

        // 1. éš±è—ç·¨è¼¯å€ï¼Œé¡¯ç¤ºåˆ—å°å€
        const root = document.getElementById("root");
        const printArea = document.getElementById("printArea");
        
        // ç¢ºä¿ ReactDOMServer å·²ç¶“è¼‰å…¥
        // é€™æ˜¯æœ€å¾Œçš„æª¢æŸ¥ï¼Œç¢ºèªå‡½å¼åº«æ˜¯å¦å·²å®šç¾©
        if (typeof ReactDOMServer === 'undefined' || typeof ReactDOMServer.renderToString !== 'function') {
            console.error("ReactDOMServer å°šæœªè¼‰å…¥æˆ–è¼‰å…¥å¤±æ•—ã€‚è«‹æª¢æŸ¥ HTML æª”æ¡ˆé ‚éƒ¨çš„ <script> æ¨™ç±¤æ˜¯å¦æ­£ç¢ºã€‚");
            alert("åˆ—å°åŠŸèƒ½è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨éŒ¯èª¤è¨Šæ¯ï¼š(ReactDOMServer is undefined)ã€‚");
            return;
        }
        
        // 2. åœ¨ printArea ä¸­ç”Ÿæˆéœæ…‹ HTML
        const printHtml = ReactDOMServer.renderToString(<PrintLayout quote={activeQuote} />);
        
        if (printArea) {
            printArea.innerHTML = printHtml;
            printArea.classList.remove('hidden'); // é¡¯ç¤ºåˆ—å°å€åŸŸ
        }
        
        if (root) root.classList.add('hidden'); // éš±è—ç·¨è¼¯å€åŸŸ (å¯é¸ï¼ŒCSS media print ä¹Ÿèƒ½è™•ç†)

        // 3. è§¸ç™¼ç€è¦½å™¨åˆ—å°å°è©±æ¡†
        window.print();

        // 4. åˆ—å°çµæŸå¾Œæ¢å¾©ç·¨è¼¯å€
        // ä½¿ç”¨ setTimeout ç¢ºä¿åˆ—å°è¦–çª—é—œé–‰å¾Œæ¢å¾©é é¢
        setTimeout(() => {
            if (root) root.classList.remove('hidden');
            if (printArea) {
                printArea.innerHTML = '';
                printArea.classList.add('hidden');
            }
        }, 100);

    }, [activeQuote]);


    return (
        <button 
            className="w-full px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition shadow-md no-print mb-4"
            onClick={handlePrint}
            disabled={!activeQuote}
        >
            ğŸ–¨ï¸ åˆ—å°å ±åƒ¹å–®
        </button>
    );
}

// å ±åƒ¹å–®é …ç›®åˆ—å°å…ƒä»¶ (ç”¨æ–¼ PrintLayout)
function PrintItemRow({ item, index, isSub = false }) {
    
    const amount = calcAmount(item);
    
    let nameContent;
    
    if (item.type === 'note' && item.text) {
        // è£œå……æ–‡å­—
        return (
            <tr className="page-break-inside-avoid">
                <td colSpan="7" style={{ borderTop: 'none', padding: '0 6px 4px 6px' }}>
                    **è£œå……èªªæ˜:** <span style={{ whiteSpace: 'pre-wrap' }}>{item.text}</span>
                </td>
            </tr>
        );
    } else if (item.type === 'image' && item.src) {
        // åœ–ç‰‡
        return (
            <tr className="page-break-inside-avoid">
                <td colSpan="7" style={{ borderTop: 'none', padding: '4px 6px 0 6px' }}>
                    <img src={item.src} alt="å·¥ç¨‹åœ–ç‰‡" className="print-image" />
                </td>
            </tr>
        );
    }
    
    // æ¨™æº–å¤§é …æˆ–å­é …ç›®
    const namePrefix = isSub ? ' â†³ ' : '';
    
    return (
        <React.Fragment>
            <tr className={!isSub ? "font-bold page-break-inside-avoid" : "page-break-inside-avoid"}>
                <td style={{ width: '5%', textAlign: 'center' }}>{isSub ? '' : index}</td>
                <td style={{ width: '25%' }}>{namePrefix}{item.name || ''}</td>
                <td style={{ width: '30%' }}>{item.spec || ''}</td>
                <td style={{ width: '8%', textAlign: 'center' }}>{item.unit || ''}</td>
                <td style={{ width: '8%', textAlign: 'right' }}>{item.qty || ''}</td>
                <td style={{ width: '12%', textAlign: 'right' }}>{formatMoney(item.price)}</td>
                <td style={{ width: '12%', textAlign: 'right' }}>{formatMoney(amount)}</td>
            </tr>
            
            {/* éæ­¸è™•ç†å­é …ç›® */}
            {!isSub && (item.subItems || []).map((sub, subIndex) => (
                <PrintItemRow key={sub.id} item={sub} index={subIndex} isSub={true} />
            ))}
        </React.Fragment>
    );
}

// å®Œæ•´åˆ—å°ç‰ˆé¢ (React Component)
const PrintLayout = ({ quote }) => {
    // ç¢ºä¿ window.__APP_CONTEXT__ å­˜åœ¨ï¼Œç”¨æ–¼åˆ—å°æ™‚ç²å– company
    const context = window.__APP_CONTEXT__ || {};
    const company = context.company || 'herhsin';
    const info = COMPANY_DATA[company]; 

    const total = calcTotal(quote.items || []);
    const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

    let mainItemIndex = 1;

    return (
        <div className="print-page">
            {/* æ¨™é¡Œå€ */}
            <div className="print-header mb-4">
                <h1 className="mb-2">{info.name} - å·¥ç¨‹å ±åƒ¹å–®</h1>
            </div>

            {/* å…¬å¸/å®¢æˆ¶è³‡è¨Šè¡¨æ ¼ */}
            <table className="print-info-table">
                <tbody>
                    <tr>
                        <td className="print-info-label">å®¢æˆ¶åç¨±</td>
                        <td>{quote.customerName || 'N/A'}</td>
                        <td className="print-info-label">è¯çµ¡äºº</td>
                        <td>{quote.contact || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td className="print-info-label">å·¥ç¨‹åç¨±</td>
                        <td colSpan="3">{quote.title || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td className="print-info-label">å·¥ç¨‹åœ°é»</td>
                        <td colSpan="3">{quote.location || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td className="print-info-label">å ±åƒ¹æ—¥æœŸ</td>
                        <td>{quote.date || formatDate()}</td>
                        <td className="print-info-label">å ±åƒ¹ç·¨è™Ÿ</td>
                        <td>{quote.quoteNo || 'N/A'}</td>
                    </tr>
                </tbody>
            </table>

            {/* å ±åƒ¹é …ç›®è¡¨æ ¼ */}
            <table className="print-items-table">
                <thead>
                    <tr>
                        <th style={{ width: '5%' }}>é …æ¬¡</th>
                        <th style={{ width: '25%' }}>å“å</th>
                        <th style={{ width: '30%' }}>è¦æ ¼/èªªæ˜</th>
                        <th style={{ width: '8%' }}>å–®ä½</th>
                        <th style={{ width: '8%' }}>æ•¸é‡</th>
                        <th style={{ width: '12%' }}>å–®åƒ¹</th>
                        <th style={{ width: '12%' }}>é‡‘é¡</th>
                    </tr>
                </thead>
                <tbody>
                    {/* æ¸²æŸ“æ‰€æœ‰å¤§é …å’Œå­é … */}
                    {(quote.items || []).map(item => (
                        <PrintItemRow key={item.id} item={item} index={mainItemIndex++} isSub={false} />
                    ))}
                </tbody>
            </table>

            {/* ç¸½è¨ˆå€å¡Š */}
            <div className="print-total-box flex justify-between">
                <div style={{ width: '40%' }}>
                    <p className="font-bold mb-1">ç¸½è¨ˆï¼š(æ­¤å ±åƒ¹æœªå«ç¨…)</p>
                    <p>è¨ˆç®—ç¸½é¡: ${formatMoney(total)}</p>
                    {quote.discountPercent > 0 && <p>æŠ˜æ‰£: {quote.discountPercent}%</p>}
                </div>
                <div style={{ width: '60%', textAlign: 'right', borderLeft: '1px solid black', paddingLeft: '10px' }}>
                    <h2 style={{ fontSize: '18px', fontWeight: 'bold', color: '#0056b3' }}>
                        æœ€çµ‚å ±åƒ¹ (æœªç¨…)ï¼šNT$ {formatMoney(negotiated)}
                    </h2>
                </div>
            </div>
            
            {/* å‚™è¨»åŠä»˜æ¬¾æ¢ä»¶ */}
            <div style={{ display: 'flex', marginTop: '15px' }}>
                <div className="print-notes-box" style={{ flex: '1 1 50%', marginRight: '10px' }}>
                    <p className="font-bold mb-1 border-b pb-1">å‚™è¨»èªªæ˜</p>
                    <pre style={{ whiteSpace: 'pre-wrap', fontFamily: 'inherit', margin: 0 }}>
                        {quote.notes || 'ç„¡å‚™è¨»'}
                    </pre>
                </div>
                <div className="print-notes-box" style={{ flex: '1 1 50%' }}>
                    <p className="font-bold mb-1 border-b pb-1">ä»˜æ¬¾æ¢ä»¶</p>
                    <pre style={{ whiteSpace: 'pre-wrap', fontFamily: 'inherit', margin: 0 }}>
                        {quote.payment || 'ç„¡ä»˜æ¬¾æ¢ä»¶'}
                    </pre>
                </div>
            </div>

            {/* ç°½ç« å€ */}
            <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '30px', borderTop: '1px dashed #ccc', paddingTop: '10px', fontSize: '12px' }}>
                <div style={{ width: '45%' }}>
                    **å ±åƒ¹å…¬å¸ (è“‹ç« å€)**
                    <p>{info.name}</p>
                </div>
                <div style={{ width: '45%', borderLeft: '1px dashed #ccc', paddingLeft: '10px' }}>
                    **å®¢æˆ¶ç¢ºèªç°½ç« **
                    <p>æ—¥æœŸ: ________</p>
                </div>
            </div>
        </div>
    );
};


// P8 â€” Appï¼ˆä¸»è¦ä½ˆå±€ï¼‰ (æ–°å¢åˆ—å°æŒ‰éˆ•)
function App() {
    const { activeQuote, updateQuote, activeQuoteId } = React.useContext(AppContext);

    // å¦‚æœæ²’æœ‰å ±åƒ¹å–®ï¼Œé¡¯ç¤ºæç¤º
    if (!activeQuoteId) {
        return (
            <div className="flex p-8 max-w-7xl mx-auto">
                <div className="w-80 pr-8">
                    <CompanySelector />
                    <ModeSelector />
                    <QuoteManager />
                </div>
                <div className="flex-1 bg-white p-6 shadow rounded text-center text-gray-500">
                    è«‹å…ˆåœ¨å·¦å´å»ºç«‹æˆ–é¸æ“‡ä¸€ä»½å ±åƒ¹å–®ã€‚
                </div>
            </div>
        );
    }

    return (
        <div className="flex p-8 max-w-7xl mx-auto min-h-screen">
            
            {/* 1. å·¦å´æ¬„ï¼šå ±åƒ¹å–®ç®¡ç† + å·¥å…·æŒ‰éˆ• */}
            <div className="w-80 pr-8 no-print flex-shrink-0">
                <CompanySelector />
                <ModeSelector />

                {/* æ–°å¢ åˆ—å° æŒ‰éˆ• */}
                <PrintButton /> 

                {/* æ–°å¢ Excel åŒ¯å‡ºæŒ‰éˆ• */}
                <div className="mb-4">
                    <ExcelExporter />
                </div>
                
                <QuoteManager />
            </div>

            {/* 2. å³å´æ¬„ï¼šç·¨è¼¯å€ */}
            <div className="flex-1">
                <QuoteEditor />
                <ItemsEditor quote={activeQuote} updateQuote={updateQuote} />

                {/* å‚™è¨»/ä»˜æ¬¾/ç¸½åƒ¹ - ä¿®æ­£ç‚ºç”±ä¸Šå¾€ä¸‹å †ç–Š */}
                <div className="flex flex-col gap-6 no-print">
                    <div className="flex-1">
                        <NotesEditor quote={activeQuote} update={updateQuote} />
                    </div>
                    <div className="flex-1">
                        <PaymentEditor quote={activeQuote} update={updateQuote} />
                    </div>
                    <div className="flex-1">
                        <PriceSummary quote={activeQuote} update={updateQuote} />
                    </div>
                </div>
            </div>
        </div>
    );
}

// P9 â€” Root Render
ReactDOM.createRoot(document.getElementById("root")).render(
    <AppProvider>
        <App />
    </AppProvider>
);
</script>

</body>
</html>
