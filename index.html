<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>工程報價系統（Herhsin & SinChang）</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
    body {
      background: #f3f4f6;
      font-family: "Microsoft JhengHei", sans-serif;
    }
  </style>

    <style>
    @media print {

      /* 隱藏非列印元素 */
      .no-print {
        display: none !important;
      }

      /* 列印容器：確保內容正確呈現 */
      body, html {
        margin: 0;
        padding: 0;
      }
      
      #root {
        display: none; /* 隱藏主編輯區 */
      }
      
      #printArea {
        display: block !important;
        margin: 0;
        padding: 12mm;
        font-size: 14px;
        color: black;
      }

      /* 表格樣式 */
      table {
        border-collapse: collapse;
        width: 100%;
      }

      th, td {
        border: 1px solid black;
        padding: 4px 6px;
        vertical-align: top;
      }

      thead {
        display: table-header-group; /* 確保表頭在每頁重複 */
      }

      tfoot {
        display: table-footer-group; /* 確保表尾在每頁重複 */
      }

      tr {
        page-break-inside: avoid; /* 防止行被截斷 */
      }

      /* 公司印章 - 模擬印章位置 */
      .print-stamp {
        position: absolute;
        top: 100px;
        right: 50px;
        max-width: 120px;
        opacity: 0.7;
      }

      /* 圖片列印樣式 */
      .print-image {
        max-width: 300px; /* 限制列印圖片大小 */
        height: auto;
      }

      /* 頁碼 (這裡需JS輔助或使用CSS計數器，為簡化不實現JS頁碼) */
      /* #print-page-number {
        position: fixed;
        bottom: 8mm;
        right: 12mm;
        font-size: 12px;
      } */
    }
  </style>
</head>

<body class="text-gray-900">

    <div id="root"></div>

    <div id="printArea" class="hidden">
      <div id="print-page-number"></div>
  </div>

<script type="text/babel">
/****************************************************
 * P1 — 公司資料 / 付款條件 / 備註 / 模式模板
 ****************************************************/
// 註：圖片路徑 (`stamp`) 在單一 HTML 檔案中可能需要使用 Data URL 或 Base64 編碼，
// 這裡暫時使用相對路徑/佔位符。
const COMPANY_DATA = {
  herhsin: {
    name: "何鑫實業股份有限公司",
    tel: "07-6517476",
    fax: "07-6517994",
    email: "admin@herhsin.com",
    address: "831高雄市大寮區鳳林三路383-3號",
    stamp: "herhsin_stamp_placeholder.png" // 佔位符
  },
  sinchang: {
    name: "薪昌有限公司",
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831高雄市大寮區鳳林三路383-3號",
    stamp: "sinchang_stamp_placeholder.png" // 佔位符
  }
};

// 預設備註
const DEFAULT_NOTES = `
1. 本報價未含加值稅。
2. 安裝施作時需注意現場作業環境。
3. 報價單有效期限為 15 天。
4. 若遇不可抗力因素造成延誤，工期順延。
5. 料件須由本公司提供與安裝，否則不在保固範圍內。
6. 付款條件依雙方合約內容為準。
`;

// 預設付款條件
const DEFAULT_PAYMENT = `
訂金：40%
製作完成：30%
安裝完成：20%
完工驗收：10%
`;

// 報價模式模板
const QUOTE_MODES = [
  {
    id: "modeA",
    name: "拌合機漏漿更換",
    description: "適用拌合機維修、漏漿處理等。",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  },
  {
    id: "modeB",
    name: "設備銷售",
    description: "適用備品、單機銷售與安裝。",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  },
  {
    id: "modeC",
    name: "設備更換工程",
    description: "適用整機更新、料件更換工程。",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  }
];

/****************************************************
 * P2 — 工具函式（完整）
 ****************************************************/
function uuid() {
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
    const r = (Math.random() * 16) | 0;
    const v = c === "x" ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

function formatDate(dateStr = new Date()) {
  const d = dateStr instanceof Date ? dateStr : new Date(dateStr);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`; // 改為 ISO 格式以利 input type="date"
}

function formatMoney(num) {
  // 處理空值和非數字，但允許數字 0
  if (num === "" || num === null || num === undefined || isNaN(Number(num))) return "";
  return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 });
}

function calcAmount(item) {
  // 確保 qty 和 price 轉為數字，否則為 0
  const qty = Number(item.qty || 0);
  const price = Number(item.price || 0);
  return qty * price;
}

function calcTotal(items) {
  return items.reduce((sum, it) => {
    let mainAmt = calcAmount(it);
    let subs = 0;

    if (it.subItems && it.subItems.length > 0) {
      subs = it.subItems.reduce((s, sub) => s + calcAmount(sub), 0);
    }

    return sum + mainAmt + subs;
  }, 0);
}

function calcNegotiated(total, discountPercent, customPrice) {
  const cp = Number(customPrice || 0);
  const dp = Number(discountPercent || 0);
  
  if (cp > 0) return cp;
  
  if (dp > 0 && dp < 100) {
    return Math.round(total * (1 - dp / 100));
  }
  return total;
}

// 報價單編號
function generateQuoteNo() {
  // 使用 YYYYMMDDHHMM + 4位亂數
  const d = new Date();
  const parts = [
    d.getFullYear(),
    String(d.getMonth() + 1).padStart(2, "0"),
    String(d.getDate()).padStart(2, "0"),
    String(d.getHours()).padStart(2, "0"),
    String(d.getMinutes()).padStart(2, "0"),
  ].join('');
  
  const random = Math.floor(1000 + Math.random() * 9000);
  
  return `Q${parts}-${random}`;
}

// 載入 Google Sheet CSV (非同步函式)
async function loadCSV(url) {
  try {
    const res = await fetch(url);
    const text = await res.text();
    // 這裡需要一個更強健的 CSV 解析器，但為了保持單一檔案架構，暫時簡化
    const rows = text.split("\n").map(r => r.trim()).filter(r => r.length > 0);
    if (rows.length === 0) return [];
    
    // 假設第一行為標頭，且不包含逗號
    const header = rows[0].split(",");

    return rows.slice(1).map(row => {
      // 簡易解析，可能會在欄位中有逗號時出錯
      const cols = row.split(",");
      const obj = {};

      header.forEach((h, i) => {
        // 修剪標頭和內容
        obj[h.trim()] = cols[i] ? cols[i].trim() : "";
      });
      return obj;
    });
  } catch (error) {
    console.error("載入或解析 Google Sheet CSV 失敗:", error);
    return [];
  }
}


/****************************************************
 * P3 — AppContext（核心資料中心）
 ****************************************************/
const AppContext = React.createContext();

function AppProvider({ children }) {
  // 公司 herhsin / sinchang
  const [company, setCompany] = React.useState("herhsin");

  // 報價單列表
  const [quotes, setQuotes] = React.useState([]);

  // 正在編輯的報價單 ID
  const [activeQuoteId, setActiveQuoteId] = React.useState(null);

  // 規格品（來自 Google Sheet）
  const [specItems, setSpecItems] = React.useState([]);

  // Google Sheet 路徑 (請確保這是公開的 CSV 連結)
  const SPEC_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv";

  /************* 初始化：從 localStorage 載入 *************/
  React.useEffect(() => {
    const saved = localStorage.getItem("HERHSIN_QUOTES");

    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        // 確保載入的是陣列
        if (Array.isArray(parsed)) {
          setQuotes(parsed);
          if (parsed.length > 0) setActiveQuoteId(parsed[0].id);
        }
      } catch (e) {
        console.error("解析 localStorage 數據失敗:", e);
        setQuotes([]);
        setActiveQuoteId(null);
      }
    }
  }, []);

  /************* 自動存回 localStorage *************/
  React.useEffect(() => {
    try {
      localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
    } catch (e) {
      console.error("寫入 localStorage 失敗:", e);
    }
  }, [quotes]);


  /************* 載入 Google Sheet 規格品 *************/
  React.useEffect(() => {
    // 由於 CDN 環境下不應過度依賴非同步外部資源，僅做一次載入嘗試
    loadCSV(SPEC_CSV_URL).then(data => setSpecItems(data));
  }, []);


  /****************************************************
   * 建立新報價單（可套用模式）
   ****************************************************/
  const createQuote = React.useCallback((modeId = null) => {
    const mode = QUOTE_MODES.find(m => m.id === modeId);

    const newQuote = {
      id: uuid(),
      quoteNo: generateQuoteNo(),
      title: mode ? mode.name : "未命名工程",
      customerName: "",
      contact: "",
      phone: "",
      location: "",
      date: formatDate(), // 使用修正後的格式化函數
      items: mode && Array.isArray(mode.defaultItems) ? mode.defaultItems.map(item => ({...item, id: uuid(), subItems: []})) : [],
      notes: mode ? mode.defaultNotes : DEFAULT_NOTES,
      payment: mode ? mode.defaultPayment : DEFAULT_PAYMENT,
      discountPercent: 0,
      negotiatedPrice: 0
    };

    setQuotes(prev => {
      const newList = [newQuote, ...prev]; // 新報價單放在最前面
      setActiveQuoteId(newQuote.id);
      return newList;
    });
  }, []);


  /****************************************************
   * 刪除報價單
   ****************************************************/
  const deleteQuote = React.useCallback((id) => {
    setQuotes(prev => {
      const newList = prev.filter(q => q.id !== id);
      
      if (id === activeQuoteId) {
        setActiveQuoteId(newList.length > 0 ? newList[0].id : null);
      }
      return newList;
    });
  }, [activeQuoteId]);


  /****************************************************
   * 更新報價單欄位
   ****************************************************/
  const updateQuote = React.useCallback((id, data) => {
    setQuotes(prev =>
      prev.map(q => (q.id === id ? { ...q, ...data } : q))
    );
  }, []);


  /****************************************************
   * 套用模式（覆蓋：標題、備註、付款、預設項目）
   ****************************************************/
  const applyMode = React.useCallback((modeId) => {
    const mode = QUOTE_MODES.find(m => m.id === modeId);
    if (!mode || !activeQuoteId) return;

    // 確保 defaultItems 中的每個 item 都有唯一的 id
    const itemsWithIds = mode.defaultItems.map(item => ({...item, id: uuid(), subItems: []}));

    updateQuote(activeQuoteId, {
      title: mode.name,
      items: itemsWithIds, // 使用帶有 ID 的項目
      notes: mode.defaultNotes,
      payment: mode.defaultPayment,
    });
  }, [activeQuoteId, updateQuote]);


  /****************************************************
   * Context 提供給全 App
   ****************************************************/
  const activeQuote = quotes.find(q => q.id === activeQuoteId);
  
  const value = {
    company,
    setCompany,

    quotes,
    createQuote,
    deleteQuote,
    updateQuote,
    activeQuote, // 直接提供當前報價單物件
    activeQuoteId,
    setActiveQuoteId,

    specItems,
    applyMode
  };

  // 讓列印和 Excel 匯出功能可以全域抓到 Context
  window.__APP_CONTEXT__ = value;

  return (
    <AppContext.Provider value={value}>
      {children}
    </AppContext.Provider>
  );
}
/****************************************************
 * P4-1 — 左側元件：公司切換 / 模式選擇 / 報價單列表
 ****************************************************/


/* --------------------------------------------------
   公司切換（何鑫 / 薪昌）
   -------------------------------------------------- */
function CompanySelector() {
  const { company, setCompany } = React.useContext(AppContext);

  return (
    <div className="mb-6 no-print">
      <div className="font-bold mb-2">選擇公司</div>

      <div className="flex gap-2">
        <button
          className={`px-3 py-1 rounded ${
            company === "herhsin"
              ? "bg-blue-600 text-white"
              : "bg-gray-300 hover:bg-gray-400"
          }`}
          onClick={() => setCompany("herhsin")}
        >
          何鑫實業
        </button>

        <button
          className={`px-3 py-1 rounded ${
            company === "sinchang"
              ? "bg-blue-600 text-white"
              : "bg-gray-300 hover:bg-gray-400"
          }`}
          onClick={() => setCompany("sinchang")}
        >
          薪昌有限公司
        </button>
      </div>
    </div>
  );
}


/* --------------------------------------------------
   報價模式選擇器（A 維修、B 搶修、C 拌合機漏漿…）
   -------------------------------------------------- */
function ModeSelector() {
  const { createQuote } = React.useContext(AppContext);

  return (
    <div className="mb-6 no-print">
      <div className="font-bold mb-2">建立報價單（套用模式）</div>

      <div className="flex flex-col gap-2">

        {QUOTE_MODES.map(mode => (
          <button
            key={mode.id}
            className="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-left"
            onClick={() => createQuote(mode.id)}
          >
            ➤ {mode.name}
          </button>
        ))}

        {/* 無模式：空白報價單 */}
        <button
          className="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700"
          onClick={() => createQuote(null)}
        >
          ＋ 空白報價單
        </button>
      </div>
    </div>
  );
}


/* --------------------------------------------------
   報價單管理：列表、切換、刪除
   -------------------------------------------------- */
function QuoteManager() {
  const {
    quotes,
    activeQuoteId,
    setActiveQuoteId,
    deleteQuote
  } = React.useContext(AppContext);

  return (
    <div className="mb-8 no-print">
      <div className="font-bold mb-2">報價單列表</div>

      {quotes.length === 0 && (
        <div className="text-gray-400 text-sm">
          尚無資料，請先建立報價單
        </div>
      )}

      <div className="flex flex-col gap-1">
        {quotes.map(q => (
          <div
            key={q.id}
            className={`flex items-center justify-between px-3 py-2 rounded cursor-pointer transition
              ${
                q.id === activeQuoteId
                  ? "bg-blue-100 border border-blue-400"
                  : "bg-white border hover:bg-gray-50"
              }
            `}
            onClick={() => setActiveQuoteId(q.id)}
          >
            <div className="flex flex-col flex-1 overflow-hidden">
              <span className="font-semibold truncate">{q.title}</span>
              <span className="text-xs text-gray-500">
                {q.date} - {q.customerName || "無客戶"}
              </span>
            </div>

            <button
              className="text-red-500 text-sm ml-2 p-1 hover:text-red-700 transition"
              onClick={(e) => {
                e.stopPropagation(); // 避免點到父層
                if (confirm("確定要刪除這份報價單？")) {
                  deleteQuote(q.id);
                }
              }}
            >
              刪除
            </button>
          </div>
        ))}
      </div>
    </div>
  );
}
/****************************************************
 * P4-2 — 報價單抬頭：公司資訊 + 客戶資訊輸入區
 ****************************************************/

function QuoteEditor() {
  const {
    company,
    activeQuote, // 直接取用 activeQuote
    updateQuote
  } = React.useContext(AppContext);

  const quote = activeQuote;
  if (!quote) return null;

  // 引用 P1 的全局數據
  const info = COMPANY_DATA[company];

  /* -------------------------------
     更新欄位
     ------------------------------- */
  const update = React.useCallback((field, value) => {
    updateQuote(quote.id, { [field]: value });
  }, [quote.id, updateQuote]);

  return (
    <div className="bg-white p-6 shadow rounded mb-6 no-print">

      {/* ---------------- 公司名稱 ---------------- */}
      <div className="text-2xl font-bold mb-4 text-blue-800">
        {info.name}
      </div>

      {/* ---------------- 公司資料 ---------------- */}
      <div className="text-sm text-gray-600 mb-6 border-b pb-4">
        <div>地址：{info.address}</div>
        <div>電話：{info.tel} | 傳真：{info.fax}</div>
      </div>

      {/* ---------------- 報價單標題 & 編號 ---------------- */}
      <div className="flex items-end gap-4 mb-6">
        <div className="flex-1">
          <label className="block text-sm text-gray-600 mb-1">工程名稱</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            value={quote.title || ""}
            onChange={(e) => update("title", e.target.value)}
          />
        </div>

        <div className="w-48">
          <label className="block text-sm text-gray-600 mb-1">報價單編號</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 bg-gray-100"
            value={quote.quoteNo || ""}
            readOnly
          />
        </div>
      </div>

      {/* ---------------- 客戶資訊 ---------------- */}
      <div className="grid grid-cols-2 gap-4 mb-6">

        <div>
          <label className="block text-sm text-gray-600 mb-1">客戶名稱</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            value={quote.customerName || ""}
            onChange={(e) => update("customerName", e.target.value)}
          />
        </div>

        <div>
          <label className="block text-sm text-gray-600 mb-1">聯絡人</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            value={quote.contact || ""}
            onChange={(e) => update("contact", e.target.value)}
          />
        </div>

        <div>
          <label className="block text-sm text-gray-600 mb-1">電話</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            value={quote.phone || ""}
            onChange={(e) => update("phone", e.target.value)}
          />
        </div>

        <div>
          <label className="block text-sm text-gray-600 mb-1">報價日期</label>
          <input
            type="date"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            // date 欄位使用 yyyy-mm-dd 格式
            value={quote.date || formatDate()}
            onChange={(e) => update("date", e.target.value)}
          />
        </div>

        <div className="col-span-2">
          <label className="block text-sm text-gray-600 mb-1">工程地點</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
            value={quote.location || ""}
            onChange={(e) => update("location", e.target.value)}
          />
        </div>
      </div>

    </div>
  );
}

/****************************************************
 * P4-3（A）NoteSubItemBlock — 文字補充小項
 ****************************************************/
function NoteSubItemBlock({ sub, updateField, deleteSubItem }) {
  return (
    <div className="border rounded p-3 bg-gray-50 mb-2">

      {/* 標題 + 刪除 */}
      <div className="flex justify-between items-center mb-2">
        <span className="text-sm font-bold text-gray-700">📄 補充文字</span>
        <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>
          刪除
        </button>
      </div>

      <textarea
        className="w-full border rounded p-2 text-sm focus:ring focus:ring-yellow-100"
        rows="2"
        value={sub.text || ""}
        onChange={(e) => updateField("text", e.target.value)}
        placeholder="輸入補充說明…"
      />
    </div>
  );
}


/****************************************************
 * P4-3（B）ItemSubItemBlock — 子項目（含數量/單價）
 ****************************************************/
function ItemSubItemBlock({ sub, updateField, deleteSubItem }) {
  // 計算並格式化小計
  const subtotal = formatMoney(calcAmount(sub));
  
  // 處理數字輸入
  const handleNumberChange = React.useCallback((field, value) => {
    // 只允許數字或空字串
    if (value === "" || !isNaN(Number(value))) {
      updateField(field, value);
    }
  }, [updateField]);

  return (
    <div className="border rounded p-3 bg-gray-50 mb-2">

      {/* 標題 + 刪除 */}
      <div className="flex justify-between items-center mb-2">
        <span className="text-sm font-bold text-gray-700">📦 子項目</span>
        <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>
          刪除
        </button>
      </div>

      <div className="grid grid-cols-12 gap-2 text-sm items-center">

        {/* 名稱 */}
        <input
          className="border p-1 rounded col-span-3 focus:ring focus:ring-blue-100"
          value={sub.name || ""}
          placeholder="名稱"
          onChange={(e) => updateField("name", e.target.value)}
        />

        {/* 規格 */}
        <input
          className="border p-1 rounded col-span-4 focus:ring focus:ring-blue-100"
          value={sub.spec || ""}
          placeholder="規格"
          onChange={(e) => updateField("spec", e.target.value)}
        />

        {/* 單位 */}
        <input
          className="border p-1 rounded col-span-1 text-center focus:ring focus:ring-blue-100"
          value={sub.unit || ""}
          placeholder="單位"
          onChange={(e) => updateField("unit", e.target.value)}
        />

        {/* 數量 */}
        <input
          className="border p-1 rounded col-span-1 text-right focus:ring focus:ring-blue-100"
          value={sub.qty || ""}
          placeholder="數量"
          type="number"
          min="0"
          onChange={(e) => handleNumberChange("qty", e.target.value)}
        />

        {/* 單價 */}
        <input
          className="border p-1 rounded col-span-2 text-right focus:ring focus:ring-blue-100"
          value={sub.price || ""}
          placeholder="單價"
          type="number"
          min="0"
          onChange={(e) => handleNumberChange("price", e.target.value)}
        />

        {/* 小計 */}
        <div className="col-span-1 text-right font-bold text-blue-600">
          {subtotal}
        </div>
      </div>
    </div>
  );
}


/****************************************************
 * P4-3（C）ImageSubItemBlock — 圖片小項
 ****************************************************/
function ImageSubItemBlock({ sub, updateField, deleteSubItem }) {

  function handleUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => updateField("src", reader.result);
    reader.readAsDataURL(file);
    e.target.value = ''; // 清空檔案輸入，以便重新選擇同一檔案
  }

  return (
    <div className="border rounded p-3 bg-gray-50 mb-2">

      <div className="flex justify-between items-center mb-2">
        <span className="text-sm font-bold text-gray-700">📷 圖片補充</span>
        <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>刪除</button>
      </div>

      {/*圖片預覽*/}
      {sub.src ? (
        <img src={sub.src} className="max-w-xs mb-2 border rounded shadow" alt="預覽圖" />
      ) : (
        <div className="text-gray-500 text-sm mb-2 p-2 border border-dashed rounded bg-white">尚未上傳圖片</div>
      )}

      {/* 上傳按鈕 */}
      <label className="cursor-pointer text-blue-700 underline text-sm hover:text-blue-900">
        {sub.src ? "更換圖片" : "上傳圖片"}
        <input type="file" accept="image/*" className="hidden" onChange={handleUpload} />
      </label>
    </div>
  );
}


/****************************************************
 * P4-3（D）UploadImageButton — 在底部新增圖片用
 ****************************************************/
function UploadImageButton({ onUpload }) {

  function handleSelect(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => onUpload(reader.result);
    reader.readAsDataURL(file);
    e.target.value = ''; // 清空檔案輸入，以便重新選擇同一檔案
  }

  return (
    <label className="cursor-pointer text-blue-600 hover:text-blue-800 transition">
      ＋補充圖片
      <input type="file" accept="image/*" className="hidden" onChange={handleSelect} />
    </label>
  );
}


/****************************************************
 * P4-3（E）SubItemWrapper — 自動分流小項類型
 ****************************************************/
// parentItem/quote/updateQuote 這些 props 其實可以從 AppContext 取得，
// 但為了維持您原有的傳遞方式，這裡保留。
function SubItemWrapper({ subItem, parentItem, quote, updateQuote }) {

  // 更新某個 subItem 的特定欄位
  const updateField = React.useCallback((field, value) => {
    const newItems = quote.items.map(m =>
      m.id === parentItem.id
        ? {
            ...m,
            // 確保 subItems 存在
            subItems: (m.subItems || []).map(s =>
              s.id === subItem.id ? { ...s, [field]: value } : s
            )
          }
        : m
    );
    updateQuote(quote.id, { items: newItems });
  }, [quote.id, parentItem.id, subItem.id, quote.items, updateQuote]);

  // 刪除 subItem
  const deleteSubItem = React.useCallback(() => {
    const newItems = quote.items.map(m =>
      m.id === parentItem.id
        ? { ...m, subItems: (m.subItems || []).filter(s => s.id !== subItem.id) }
        : m
    );
    updateQuote(quote.id, { items: newItems });
  }, [quote.id, parentItem.id, subItem.id, quote.items, updateQuote]);

  const props = { sub: subItem, updateField, deleteSubItem };

  if (subItem.type === "note") return <NoteSubItemBlock {...props} />;
  if (subItem.type === "item") return <ItemSubItemBlock {...props} />;
  if (subItem.type === "image") return <ImageSubItemBlock {...props} />;

  return null;
}


/****************************************************
 * P4-3（F）MainItemBlock — 大項編輯
 ****************************************************/
function MainItemBlock({ item, quote, updateQuote }) {

  // 處理數字輸入
  const handleNumberChange = React.useCallback((field, value) => {
    if (value === "" || !isNaN(Number(value))) {
      update({ [field]: value });
    }
  }, [item.id, updateQuote]);

  const update = React.useCallback((data) => {
    const newItems = quote.items.map(m =>
      m.id === item.id ? { ...m, ...data } : m
    );
    updateQuote(quote.id, { items: newItems });
  }, [quote.id, item.id, quote.items, updateQuote]);

  const deleteMain = React.useCallback(() => {
    if (!confirm("確定要刪除此大項？")) return;
    updateQuote(quote.id, { items: quote.items.filter(m => m.id !== item.id) });
  }, [quote.id, item.id, quote.items, updateQuote]);

  // 新增小項（含圖片）
  const addSub = React.useCallback((type, src = "") => {
    const newSub = {
      id: uuid(),
      type,
      text: "",
      name: "",
      spec: "",
      unit: "",
      qty: "",
      price: "",
      src
    };

    const newItems = quote.items.map(m =>
      m.id === item.id ? { ...m, subItems: [...(m.subItems || []), newSub] } : m
    );

    updateQuote(quote.id, { items: newItems });
  }, [quote.id, item.id, quote.items, updateQuote]);

  // 計算並格式化小計
  const mainTotal = formatMoney(calcAmount(item));
  
  return (
    <div className="border rounded p-4 bg-white shadow mb-4">

      {/* 大項資料列 */}
      <div className="grid grid-cols-12 gap-2 items-center">
        {/* 品名 */}
        <input className="border p-1 rounded col-span-3 focus:ring focus:ring-red-100"
          value={item.name || ""} placeholder="品名"
          onChange={(e) => update({ name: e.target.value })} />
        {/* 規格 */}
        <input className="border p-1 rounded col-span-3 focus:ring focus:ring-red-100"
          value={item.spec || ""} placeholder="規格"
          onChange={(e) => update({ spec: e.target.value })} />
        {/* 單位 */}
        <input className="border p-1 rounded col-span-1 text-center focus:ring focus:ring-red-100"
          value={item.unit || ""} placeholder="單位"
          onChange={(e) => update({ unit: e.target.value })} />
        {/* 數量 */}
        <input className="border p-1 rounded col-span-1 text-right focus:ring focus:ring-red-100"
          value={item.qty || ""} placeholder="數量"
          type="number" min="0"
          onChange={(e) => handleNumberChange("qty", e.target.value)} />
        {/* 單價 */}
        <input className="border p-1 rounded col-span-2 text-right focus:ring focus:ring-red-100"
          value={item.price || ""} placeholder="單價"
          type="number" min="0"
          onChange={(e) => handleNumberChange("price", e.target.value)} />

        {/* 小計 */}
        <div className="text-right font-bold col-span-1 text-red-700">
          {mainTotal}
        </div>
        {/* 刪除按鈕 */}
        <button className="text-red-600 col-span-1 text-sm hover:text-red-800" onClick={deleteMain}>
          ✕
        </button>
      </div>

      {/* 小項列表 */}
      <div className="mt-3 border-t pt-3">
        {(item.subItems || []).map(sub => ( // 確保 subItems 存在
          <SubItemWrapper
            key={sub.id} // 修正：新增 key
            subItem={sub}
            parentItem={item}
            quote={quote}
            updateQuote={updateQuote}
          />
        ))}
      </div>

      {/* 操作列 */}
      <div className="flex gap-4 mt-3 text-blue-600 text-sm border-t pt-3">
        <button className="hover:text-blue-800 transition" onClick={() => addSub("item")}>＋ 子項目</button>
        <button className="hover:text-blue-800 transition" onClick={() => addSub("note")}>＋ 補充文字</button>
        <UploadImageButton onUpload={(src) => addSub("image", src)} />
      </div>
    </div>
  );
}


/****************************************************
 * P4-3（G）ItemsEditor — 整體品項管理
 ****************************************************/
function ItemsEditor({ quote, updateQuote }) {
  const addMain = React.useCallback(() => {
    const newMain = {
      id: uuid(),
      type: "main",
      name: "未命名大項",
      spec: "",
      unit: "",
      qty: "",
      price: "",
      subItems: []
    };
    updateQuote(quote.id, { items: [...(quote.items || []), newMain] });
  }, [quote.id, quote.items, updateQuote]);

  return (
    <div className="mb-6 no-print">
      <h2 className="font-bold text-lg mb-2">報價項目列表</h2>
      
      <button
        className="px-4 py-2 bg-blue-600 text-white rounded mb-4 hover:bg-blue-700 transition"
        onClick={addMain}
      >
        ＋ 新增大項
      </button>

      {(quote.items || []).map(item => ( // 確保 items 存在
        <MainItemBlock
          key={item.id}
          item={item}
          quote={quote}
          updateQuote={updateQuote}
        />
      ))}
    </div>
  );
}

/****************************************************
 * P4-4（A）— 備註欄 NotesEditor
 ****************************************************/
function NotesEditor({ quote, update }) {
  return (
    <div className="p-4 bg-white rounded shadow mb-6 no-print">
      <h2 className="font-bold text-lg mb-2 text-gray-700">備註說明</h2>

      <textarea
        className="border p-2 w-full rounded h-32 focus:ring-2 focus:ring-indigo-100"
        value={quote.notes || ""}
        onChange={(e) => update({ notes: e.target.value })}
      />
    </div>
  );
}
/****************************************************
 * P4-4（B）— 付款條件 PaymentEditor
 ****************************************************/
function PaymentEditor({ quote, update }) {
  return (
    <div className="p-4 bg-white rounded shadow mb-6 no-print">
      <h2 className="font-bold text-lg mb-2 text-gray-700">付款條件</h2>

      <textarea
        className="border p-2 w-full rounded h-28 focus:ring-2 focus:ring-indigo-100"
        value={quote.payment || ""}
        onChange={(e) => update({ payment: e.target.value })}
      />
    </div>
  );
}
/****************************************************
 * P4-4（C）— 總價區 PriceSummary
 ****************************************************/
function PriceSummary({ quote, update }) {
  const originalTotal = calcTotal(quote.items || []);
  
  // 確保數值輸入是乾淨的數字
  const discountPercent = Number(quote.discountPercent || 0);
  const negotiatedPrice = Number(quote.negotiatedPrice || 0);
  
  const finalPrice = calcNegotiated(
    originalTotal,
    discountPercent,
    negotiatedPrice
  );

  // 處理數字輸入
  const handleNumberChange = React.useCallback((field, value) => {
    if (value === "" || !isNaN(Number(value))) {
      update({ [field]: value });
    }
  }, [update]);
  
  return (
    <div className="p-4 bg-white rounded shadow mb-6 no-print">

      <h2 className="font-bold text-lg mb-3 text-gray-700">總價資訊</h2>

      {/* 原始金額 */}
      <div className="mb-3 border-b pb-2">
        <label className="font-bold text-gray-600">原始總價：</label>
        <span className="text-blue-700 font-extrabold ml-2 text-xl">
          NT$ {formatMoney(originalTotal)}
        </span>
      </div>

      {/* 折扣百分比 */}
      <div className="mb-3 flex items-center">
        <label className="font-bold text-gray-600 w-36">議價折扣（%）：</label>
        <input
          className="border p-1 w-24 rounded ml-2 text-right focus:ring focus:ring-purple-100"
          type="number"
          min="0" max="100"
          value={discountPercent === 0 ? "" : discountPercent}
          onChange={(e) => handleNumberChange("discountPercent", e.target.value)}
          placeholder="0-100"
        />
        <span className="text-sm text-gray-500 ml-2">（折扣優先）</span>
      </div>

      {/* 議價後金額（直接輸入會覆蓋折扣） */}
      <div className="mb-3 flex items-center">
        <label className="font-bold text-gray-600 w-36">
          直接輸入議價後金額：
        </label>
        <input
          className="border p-1 w-40 rounded ml-2 text-right focus:ring focus:ring-purple-100"
          type="number"
          min="0"
          placeholder="輸入後會覆蓋折扣%"
          value={negotiatedPrice === 0 ? "" : negotiatedPrice}
          onChange={(e) => handleNumberChange("negotiatedPrice", e.target.value)}
        />
      </div>

      {/* 最終成交價 */}
      <div className="text-xl font-bold mt-4 pt-4 border-t">
        最終成交價：
        <span className="text-green-700 ml-2 text-2xl">
          NT$ {formatMoney(finalPrice)}
        </span>
      </div>
    </div>
  );
}
/****************************************************
 * P4-5 — 列印專用版面 PrintView
 ****************************************************/
function PrintView({ quote, company }) {
  // 確保 quote 和 items 存在
  if (!quote || !quote.items) return null;
  
  const info = COMPANY_DATA[company];

  const total = calcTotal(quote.items);
  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

  return (
    <div className="print-container">

      {/* 公司抬頭 */}
      <div className="text-center mb-6 relative">
        <h1 className="text-3xl font-bold">{info.name}</h1>
        <div>{info.tel} | {info.fax}</div>
        <div>{info.email}</div>
        <div>{info.address}</div>

        <h2 className="text-3xl font-bold mt-4 tracking-widest border-b-2 border-black inline-block pb-1">
          工 程 報 價 單
        </h2>
      </div>
      
      {/* 印章 - 僅列印時顯示 */}
      <img src={info.stamp} alt="公司印章" className="print-stamp no-screen" />


      {/* 基本資訊 */}
      <table className="w-full mb-6">
        <tbody>
          <tr>
            <td className="font-bold w-32 bg-gray-100">顧客名稱：</td>
            <td>{quote.customerName}</td>
            <td className="font-bold w-32 bg-gray-100">報價日期：</td>
            <td>{quote.date}</td>
          </tr>

          <tr>
            <td className="font-bold bg-gray-100">聯絡人：</td>
            <td>{quote.contact}</td>
            <td className="font-bold bg-gray-100">電話：</td>
            <td>{quote.phone}</td>
          </tr>

          <tr>
            <td className="font-bold bg-gray-100">工程名稱：</td>
            <td>{quote.title}</td>
            <td className="font-bold bg-gray-100">工程地點：</td>
            <td>{quote.location}</td>
          </tr>
        </tbody>
      </table>

      {/* 品項列表 */}
      <table className="w-full border-collapse mb-6" border="1">
        <thead>
          <tr className="bg-gray-200">
            <th className="p-1 w-[15%]">項目</th>
            <th className="p-1 w-[35%]">規格 / 說明</th>
            <th className="p-1 w-[8%]">單位</th>
            <th className="p-1 w-[8%]">數量</th>
            <th className="p-1 w-[12%]">單價</th>
            <th className="p-1 w-[12%]">金額</th>
          </tr>
        </thead>

        <tbody>
          {quote.items.map((item) => (
            <React.Fragment key={item.id}> {/* 修正：使用 Fragment 包裹多個 tr */}
              {/* 大項 */}
              <tr>
                <td className="p-1 font-bold">{item.name || '（大項）'}</td>
                <td className="p-1">{item.spec}</td>
                <td className="p-1 text-center">{item.unit}</td>
                <td className="p-1 text-right">{item.qty}</td>
                <td className="p-1 text-right">{formatMoney(item.price)}</td>
                <td className="p-1 text-right font-bold">
                  {formatMoney(calcAmount(item))}
                </td>
              </tr>

              {/* 小項 / 補充 */}
              {(item.subItems || []).map((sub) => {
                if (sub.type === "note") {
                  return (
                    <tr key={sub.id}>
                      <td colSpan="6" className="p-1 pl-6 text-gray-700">● {sub.text}</td>
                    </tr>
                  );
                }

                if (sub.type === "image") {
                  return (
                    <tr key={sub.id}>
                      <td colSpan="6" className="p-1 pl-6">
                        <img src={sub.src} className="print-image border" alt="補充圖片" />
                      </td>
                    </tr>
                  );
                }

                return (
                  <tr key={sub.id}>
                    <td className="p-1 pl-6">－ {sub.name || '子項目'}</td>
                    <td className="p-1">{sub.spec}</td>
                    <td className="p-1 text-center">{sub.unit}</td>
                    <td className="p-1 text-right">{sub.qty}</td>
                    <td className="p-1 text-right">{formatMoney(sub.price)}</td>
                    <td className="p-1 text-right font-bold text-gray-600">
                      {formatMoney(calcAmount(sub))}
                    </td>
                  </tr>
                );
              })}
            </React.Fragment>
          ))}
        </tbody>

        <tfoot>
          <tr className="bg-gray-100 font-bold">
            <td colSpan="5" className="text-right">總計金額（未稅）：</td>
            <td colSpan="2" className="text-right text-lg">NT$ {formatMoney(negotiated)}</td>
          </tr>
        </tfoot>
      </table>

      {/* 備註與付款條件 */}
      <div className="grid grid-cols-2 gap-4 mb-6">
        {/* 備註 */}
        <div>
          <h3 className="font-bold border-b border-black mb-1">備註說明：</h3>
          <pre className="whitespace-pre-wrap text-sm">{quote.notes}</pre>
        </div>
        
        {/* 付款條件 */}
        <div>
          <h3 className="font-bold border-b border-black mb-1">付款條件：</h3>
          <pre className="whitespace-pre-wrap text-sm">{quote.payment}</pre>
        </div>
      </div>

    </div>
  );
}
/****************************************************
 * P6 — 全局功能：列印 / Excel
 ****************************************************/

// 獲取當前報價單
function getActiveQuoteData() {
  const context = window.__APP_CONTEXT__;
  if (!context || !context.activeQuote) {
    console.error("無法取得報價單數據");
    return null;
  }
  return { quote: context.activeQuote, company: context.company };
}

// --------------------------------------------------
// 處理列印
// --------------------------------------------------
function handlePrint() {
  const data = getActiveQuoteData();
  if (!data) return;

  // 1. 將 PrintView 元件渲染到 `div#printArea`
  const printArea = document.getElementById('printArea');
  // 確保使用 createRoot 渲染 React 18 根
  if (!window.__PRINT_ROOT__) {
    window.__PRINT_ROOT__ = ReactDOM.createRoot(printArea);
  }
  
  // 渲染列印內容
  window.__PRINT_ROOT__.render(
    <PrintView quote={data.quote} company={data.company} />
  );
  
  // 等待渲染完成 (小延遲確保 DOM 準備好)
  setTimeout(() => {
    window.print();
    // 這裡可以選擇不銷毀，保持渲染，或延遲銷毀
  }, 100);
}


// --------------------------------------------------
// 處理 Excel 匯出 (SheetJS)
// --------------------------------------------------
function exportToExcel() {
  const data = getActiveQuoteData();
  if (!data) return;
  const { quote } = data;
  
  const wb = XLSX.utils.book_new();
  
  // 準備工作表數據
  const wsData = [
    ["工程報價單"],
    ["工程名稱:", quote.title || ""],
    ["報價編號:", quote.quoteNo || ""],
    ["客戶名稱:", quote.customerName || ""],
    ["報價日期:", quote.date || ""],
    [],
    ["項目", "規格 / 說明", "單位", "數量", "單價", "金額"],
  ];

  // 添加報價項目
  const items = quote.items || [];
  items.forEach(item => {
    // 大項
    wsData.push([
      item.name || "", 
      item.spec || "", 
      item.unit || "", 
      Number(item.qty) || 0, 
      Number(item.price) || 0, 
      calcAmount(item)
    ]);
    
    // 子項
    const subItems = item.subItems || [];
    subItems.forEach(sub => {
      if (sub.type === 'item') {
        wsData.push([
          ` - ${sub.name || ""}`, 
          sub.spec || "", 
          sub.unit || "", 
          Number(sub.qty) || 0, 
          Number(sub.price) || 0, 
          calcAmount(sub)
        ]);
      } else if (sub.type === 'note') {
        wsData.push([`備註: ${sub.text || ""}`]);
      }
    });
  });
  
  const total = calcTotal(items);
  const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);
  
  wsData.push([]);
  wsData.push(["原始總價(未稅):", "", "", "", "", formatMoney(total)]);
  wsData.push(["最終成交價(未稅):", "", "", "", "", formatMoney(negotiated)]);
  wsData.push([]);
  wsData.push(["備註說明:", quote.notes || ""]);
  wsData.push(["付款條件:", quote.payment || ""]);

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  
  // 設置單元格格式 (可選: 讓數字看起來像數字)
  const range = XLSX.utils.decode_range(ws['!ref']);
  for(let R = range.s.r + 6; R <= range.e.r - 2; ++R) { // 從項目標頭行下方開始到總計上方
    if (ws[XLSX.utils.encode_cell({r:R, c:3})]) ws[XLSX.utils.encode_cell({r:R, c:3})].t = 'n'; // 數量
    if (ws[XLSX.utils.encode_cell({r:R, c:4})]) ws[XLSX.utils.encode_cell({r:R, c:4})].t = 'n'; // 單價
    if (ws[XLSX.utils.encode_cell({r:R, c:5})]) ws[XLSX.utils.encode_cell({r:R, c:5})].t = 'n'; // 金額
  }

  XLSX.utils.book_append_sheet(wb, ws, "報價單內容");
  XLSX.writeFile(wb, `${quote.quoteNo}-${quote.customerName}.xlsx`);
}

// --------------------------------------------------
// P7 — App 根元件
// --------------------------------------------------
function App() {
  const { activeQuote, updateQuote } = React.useContext(AppContext);

  // 當前報價單不存在時的畫面
  if (!activeQuote) {
    return (
      <div className="p-8">
        <h1 className="text-2xl font-bold mb-4">工程報價系統</h1>
        <div className="grid grid-cols-4 gap-6">
          <div className="col-span-1">
            <CompanySelector />
            <ModeSelector />
            <QuoteManager />
          </div>
          <div className="col-span-3 p-8 bg-white rounded shadow text-center text-gray-500">
            請在左側選單建立或選擇一份報價單開始編輯。
          </div>
        </div>
      </div>
    );
  }

  // 更新 activeQuote 的函數
  const updateActiveQuote = React.useCallback((data) => {
    updateQuote(activeQuote.id, data);
  }, [activeQuote.id, updateQuote]);
  
  return (
    <div className="p-8">
      <h1 className="text-2xl font-bold mb-4 no-print">工程報價系統 - 編輯中：{activeQuote.title}</h1>

      <div className="grid grid-cols-4 gap-6">
        {/* 左側選單 */}
        <div className="col-span-1">
          <div className="p-4 bg-white rounded shadow">
            <CompanySelector />
            <ModeSelector />
            <QuoteManager />
          </div>
        </div>

        {/* 右側編輯區 */}
        <div className="col-span-3">
          {/* 客戶資訊 */}
          <QuoteEditor />
          
          {/* 品項列表 */}
          <ItemsEditor quote={activeQuote} updateQuote={updateQuote} />

          {/* 備註/付款/總價 */}
          <div className="grid grid-cols-3 gap-6">
            <div className="col-span-1">
              <NotesEditor quote={activeQuote} update={updateActiveQuote} />
            </div>
            <div className="col-span-1">
              <PaymentEditor quote={activeQuote} update={updateActiveQuote} />
            </div>
            <div className="col-span-1">
              <PriceSummary quote={activeQuote} update={updateActiveQuote} />
            </div>
          </div>
          
          {/* 操作按鈕區 */}
          <div className="flex justify-end gap-4 p-4 bg-white rounded shadow no-print">
            <button 
              className="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700 transition"
              onClick={exportToExcel}
            >
              📤 匯出 Excel
            </button>
            <button 
              className="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700 transition"
              onClick={handlePrint}
            >
              🖨️ 列印/PDF 報價單
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// --------------------------------------------------
// 渲染 React 根
// --------------------------------------------------
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <AppProvider>
    <App />
  </AppProvider>
);
</script>
</body>
</html>
