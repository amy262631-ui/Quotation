<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰- æœ€çµ‚æ•´åˆç‰ˆ</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- ReactDOMServerï¼ˆçµ¦åˆ—å°ç”¨ï¼‰ -->
    <script src="https://unpkg.com/react-dom@18/umd/react-dom-server.browser.production.min.js"></script>

    <!-- XLSXï¼ˆåŒ¯å‡º Excelï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            background: #f4f4f4;
            font-family: "Microsoft JhengHei", sans-serif;
        }

        /* ä¸åˆ—å°çš„å…ƒç´  */
        .no-print {
            display: none !important;
        }

        @media print {

            /* éš±è—ç·¨è¼¯å™¨æœ¬é«” */
            #root {
                display: none !important;
            }

            /* é¡¯ç¤ºåˆ—å°å°ˆç”¨å€åŸŸ */
            #printArea {
                display: block !important;
                width: 210mm;
                min-height: 297mm;
                padding: 10mm;
                position: fixed;
                top: 0;
                left: 0;
                color: black;
                background: white;
                font-size: 12px;
            }

            table {
                border-collapse: collapse;
                width: 100%;
            }

            th,
            td {
                border: 1px solid black;
                padding: 4px;
            }

            .print-image {
                max-width: 90%;
                margin-top: 4px;
            }
        }
    </style>
</head>

<body>
    <!-- React mount point -->
    <div id="root"></div>

    <!-- åˆ—å°å°ˆç”¨å€åŸŸ -->
    <div id="printArea" style="display:none;"></div>

    <script type="text/babel">
/****************************************************
 *  A2 â€” å…¬å¸è³‡æ–™ã€ä»˜æ¬¾æ¢ä»¶ã€æ¨¡å¼æ¨¡æ¿ã€å·¥å…·å‡½å¼
 ****************************************************/

// ------------------------------
// å…¬å¸è³‡æ–™ï¼ˆä¿ç•™åŸæœ¬è¨­å®š + ä½ çš„å°ç« è·¯å¾‘ï¼‰
// ------------------------------
const COMPANY_DATA = {
  herhsin: {
    name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
    stamp: "https://amy262631-ui.github.io/Quotation/herhsin_stamp.JPG",
    prefix: "QH"
  },
  sinchang: {
    name: "è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸",
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
    stamp: "https://amy262631-ui.github.io/Quotation/sinchang_stamp.JPG",
    prefix: "QS"
  }
};

// ------------------------------
// é è¨­å‚™è¨»ï¼ˆå®Œå…¨ä¿ç•™ï¼‰
// ------------------------------
const DEFAULT_NOTES = `1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚`;

// ------------------------------
// é è¨­ä»˜æ¬¾æ¢ä»¶ï¼ˆå®Œå…¨ä¿ç•™ï¼‰
// ------------------------------
const DEFAULT_PAYMENT = `è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%`;

// ------------------------------
// å ±åƒ¹æ¨¡å¼æ¨¡æ¿ï¼ˆå®Œå…¨ä¿ç•™ï¼‰
// ------------------------------
const QUOTE_MODES = [
  {
    id: "modeA",
    name: "æ‹Œåˆæ©Ÿæ¼æ¼¿æ›´æ›",
    description: "é©ç”¨æ‹Œåˆæ©Ÿç¶­ä¿®ã€æ¼æ¼¿è™•ç†ç­‰ã€‚",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  },
  {
    id: "modeB",
    name: "è¨­å‚™éŠ·å”®",
    description: "é©ç”¨å‚™å“ã€å–®æ©ŸéŠ·å”®èˆ‡å®‰è£ã€‚",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  },
  {
    id: "modeC",
    name: "è¨­å‚™æ›´æ›å·¥ç¨‹",
    description: "é©ç”¨æ•´æ©Ÿæ›´æ–°ã€æ–™ä»¶æ›´æ›å·¥ç¨‹ã€‚",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  }
];


// --------------------------------------------------
// å·¥å…·å‡½å¼
// --------------------------------------------------

// UUIDï¼ˆä¿ç•™ä½ çš„å¯«æ³•ï¼‰
function uuid() {
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
    const r = (Math.random() * 16) | 0;
    const v = c === "x" ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

// æ—¥æœŸæ ¼å¼ï¼ˆä¿ç•™ï¼‰
function formatDate(dateStr = new Date()) {
  const d = dateStr instanceof Date ? dateStr : new Date(dateStr);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

// é‡‘é¡æ ¼å¼
function formatMoney(num) {
  if (num === "" || num === null || num === undefined || isNaN(Number(num))) return "0";
  return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 });
}

// å–®é …å°è¨ˆ
function calcAmount(item) {
  return Number(item.qty || 0) * Number(item.price || 0);
}

// å…¨éƒ¨ç¸½è¨ˆï¼ˆå«å­é …ç›®ï¼‰
function calcTotal(items) {
  return items.reduce((sum, it) => {
    const main = calcAmount(it);

    const subs = (it.subItems || [])
      .filter(sub => sub.type === "item")
      .reduce((s, sub) => s + calcAmount(sub), 0);

    return sum + main + subs;
  }, 0);
}

// è­°åƒ¹å¾Œé‡‘é¡ï¼ˆæŠ˜æ‰£ or è‡ªå®šç¾©ï¼‰
function calcNegotiated(total, discountPercent, customPrice) {
  const cp = Number(customPrice || 0);
  const dp = Number(discountPercent || 0);

  if (cp > 0) return cp;
  if (dp > 0 && dp <= 100) return Math.round(total * (1 - dp / 100));

  return total;
}

// å ±åƒ¹å–®ç·¨è™Ÿ
function generateQuoteNo(companyKey) {
  const prefix = COMPANY_DATA[companyKey]?.prefix || "Q";
  const d = new Date();

  const datetime =
    d.getFullYear() +
    String(d.getMonth() + 1).padStart(2, "0") +
    String(d.getDate()).padStart(2, "0") +
    String(d.getHours()).padStart(2, "0") +
    String(d.getMinutes()).padStart(2, "0");

  const rand = Math.floor(1000 + Math.random() * 9000);

  return `${prefix}${datetime}-${rand}`;
}

// è¼‰å…¥ Google Sheet CSV
async function loadCSV(url) {
  try {
    const r = await fetch(url);
    const text = await r.text();

    const rows = text.split("\n").map(r => r.trim()).filter(r => r.length > 0);

    const header = rows[0].split(",").map(h => h.trim().replace(/"/g, ""));

    return rows.slice(1).map(row => {
      const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
      const obj = {};

      header.forEach((h, i) => {
        let v = cols[i] ? cols[i].trim() : "";
        if (v.startsWith('"') && v.endsWith('"')) v = v.slice(1, -1);
        obj[h] = v;
      });

      return obj;
    });
  } catch (err) {
    console.error("Google Sheet è¼‰å…¥å¤±æ•—ï¼š", err);
    return [];
  }
}
/****************************************************
 *  A3 â€” App Contextï¼ˆå« Google Sheet è¦æ ¼å“è®€å–ï¼‰
 ****************************************************/

const AppContext = React.createContext();

function AppProvider({ children }) {

  /**********************
   * 1ï¸âƒ£ ä¸»è¦ç‹€æ…‹
   **********************/
  const [company, setCompany] = React.useState("herhsin");

  const [quotes, setQuotes] = React.useState([]);

  const [activeQuoteId, setActiveQuoteId] = React.useState(null);

  // ğŸ”¥ Google Sheet è¦æ ¼å“è³‡æ–™
  const [specItems, setSpecItems] = React.useState([]);


  /**********************
   * 2ï¸âƒ£ Google Sheet é€£çµ
   *    ï¼ˆä½¿ç”¨ä½ æä¾›çš„ CSVï¼‰
   **********************/
  const SPEC_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv";


  /**********************
   * 3ï¸âƒ£ è¼‰å…¥ LocalStorage
   **********************/
  React.useEffect(() => {
    const saved = localStorage.getItem("HERHSIN_QUOTES");

    if (!saved) return;

    try {
      const parsed = JSON.parse(saved);
      if (Array.isArray(parsed)) {
        setQuotes(parsed);
        if (parsed.length > 0) setActiveQuoteId(parsed[0].id);
      }
    } catch (e) {
      console.error("âš ï¸ ç„¡æ³•è§£æ localStorage:", e);
    }
  }, []);


  /**********************
   * 4ï¸âƒ£ è‡ªå‹•å„²å­˜ LocalStorage
   **********************/
  React.useEffect(() => {
    try {
      localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
    } catch (e) {
      console.error("âš ï¸ ç„¡æ³•å¯«å…¥ localStorage:", e);
    }
  }, [quotes]);


  /**********************
   * 5ï¸âƒ£ è¼‰å…¥ Google Sheet â†’ specItems
   **********************/
  const loadSpecItems = React.useCallback(() => {
    loadCSV(SPEC_CSV_URL).then((data) => {
      console.log("âœ” Google Sheet è¦æ ¼å“è³‡æ–™è¼‰å…¥:", data);
      setSpecItems(data);
    });
  }, []);

  // ç¬¬ä¸€æ¬¡è¼‰å…¥ç¶²é  â†’ è¼‰å…¥è¦æ ¼å“
  React.useEffect(() => {
    loadSpecItems();
  }, [loadSpecItems]);


  /**********************
   * 6ï¸âƒ£ å»ºç«‹æ–°å ±åƒ¹å–®
   **********************/
  const createQuote = React.useCallback(
    (modeId = null) => {
      const mode = QUOTE_MODES.find((m) => m.id === modeId);

      const newQuote = {
        id: uuid(),
        company: company,
        quoteNo: generateQuoteNo(company),
        title: mode ? mode.name : "æœªå‘½åå·¥ç¨‹",
        customerName: "",
        contact: "",
        phone: "",
        location: "",
        date: formatDate(),
        items: [],
        notes: mode ? mode.defaultNotes : DEFAULT_NOTES,
        payment: mode ? mode.defaultPayment : DEFAULT_PAYMENT,
        discountPercent: 0,
        negotiatedPrice: 0
      };

      setQuotes((prev) => {
        const newList = [newQuote, ...prev];
        setActiveQuoteId(newQuote.id);
        return newList;
      });
    },
    [company]
  );


  /**********************
   * 7ï¸âƒ£ åˆªé™¤å ±åƒ¹å–®
   **********************/
  const deleteQuote = React.useCallback(
    (id) => {
      setQuotes((prev) => {
        const newList = prev.filter((q) => q.id !== id);
        if (id === activeQuoteId) {
          setActiveQuoteId(newList.length > 0 ? newList[0].id : null);
        }
        return newList;
      });
    },
    [activeQuoteId]
  );


  /**********************
   * 8ï¸âƒ£ æ›´æ–°å ±åƒ¹å–®
   **********************/
  const updateQuote = React.useCallback((id, data) => {
    setQuotes((prev) => prev.map((q) => (q.id === id ? { ...q, ...data } : q)));
  }, []);


  /**********************
   * 9ï¸âƒ£ å¥—ç”¨æ¨¡å¼ï¼ˆä¸å‹•ä½ çš„é‚è¼¯ï¼‰
   **********************/
  const applyMode = React.useCallback(
    (modeId) => {
      const mode = QUOTE_MODES.find((m) => m.id === modeId);
      if (!mode || !activeQuoteId) return;

      updateQuote(activeQuoteId, {
        title: mode.name,
        notes: mode.defaultNotes,
        payment: mode.defaultPayment,
        items: []
      });
    },
    [activeQuoteId, updateQuote]
  );


  /**********************
   * ğŸ”Ÿ è¨­å®š activeQuote
   **********************/
  const activeQuote = quotes.find((q) => q.id === activeQuoteId);


  /**********************
   * 1ï¸âƒ£1ï¸âƒ£ Context æœ€çµ‚è¼¸å‡º
   **********************/
  const value = {
    company,
    setCompany,
    quotes,
    createQuote,
    deleteQuote,
    updateQuote,
    activeQuote,
    activeQuoteId,
    setActiveQuoteId,

    // â­ Google Sheet è¦æ ¼å“è³‡æ–™
    specItems,
    loadSpecItems,

    applyMode
  };

  // ä¾›å¤–éƒ¨åŒ¯å‡º Excel æˆ–åˆ—å°ä½¿ç”¨
  window.__APP_CONTEXT__ = value;

  return (
    <AppContext.Provider value={value}>{children}</AppContext.Provider>
  );
}
/****************************************************
 *  A4 â€” QuoteItemï¼ˆå–®ä¸€å¤§é … + Google Sheet æœå°‹ï¼‰
 ****************************************************/
function QuoteItem({ item, index, updateItem, deleteItem }) {
    const { specItems } = React.useContext(AppContext);

    // æœå°‹æ¡†ç‹€æ…‹
    const [query, setQuery] = React.useState("");
    const [showDropdown, setShowDropdown] = React.useState(false);
    const [highlightIndex, setHighlightIndex] = React.useState(0);

    /****************************************************
     * ğŸ” è‡ªå‹•æœå°‹ï¼šä¾æ“šã€Œå“å / è¦æ ¼ / ç”¨æ–™ã€æ¨¡ç³Šæ¯”å°
     ****************************************************/
    const filteredItems = React.useMemo(() => {
        if (!query.trim()) return [];

        const q = query.trim();

        return specItems.filter(row =>
            (row["å“å"] && row["å“å"].includes(q)) ||
            (row["è¦æ ¼"] && row["è¦æ ¼"].includes(q)) ||
            (row["ç”¨æ–™1"] && row["ç”¨æ–™1"].includes(q)) ||
            (row["ç”¨æ–™2"] && row["ç”¨æ–™2"].includes(q)) ||
            (row["ç”¨æ–™3"] && row["ç”¨æ–™3"].includes(q))
        );
    }, [query, specItems]);


    /****************************************************
     * ğŸŸ¦ ç•¶é¸æ“‡æœå°‹çµæœæ™‚
     ****************************************************/
    const applySelected = (row) => {
        const mat1 = row["ç”¨æ–™1"] || "";
        const mat2 = row["ç”¨æ–™2"] || "";
        const mat3 = row["ç”¨æ–™3"] || "";

        const materialText = [mat1, mat2, mat3].filter(x => x.trim() !== "").join("ã€");

        updateItem({
            name: row["å“å"] || "",
            specMain: row["è¦æ ¼"] || "",
            unit: row["å–®ä½"] || "",
            price: Number(row["å–®åƒ¹"] || 0),
            specMaterial: materialText
        });

        setQuery("");
        setShowDropdown(false);
    };


    /****************************************************
     * ğŸŸ¦ è™•ç†éµç›¤äº‹ä»¶ï¼ˆä¸Šä¸‹é¸å–® + Enter é¸å–ï¼‰
     ****************************************************/
    const handleKeyDown = (e) => {
        if (!showDropdown) return;

        if (e.key === "ArrowDown") {
            setHighlightIndex(prev => Math.min(prev + 1, filteredItems.length - 1));
        } else if (e.key === "ArrowUp") {
            setHighlightIndex(prev => Math.max(prev - 1, 0));
        } else if (e.key === "Enter") {
            const row = filteredItems[highlightIndex];
            if (row) applySelected(row);
        }
    };


    /****************************************************
     * ğŸŸ¦ è¼¸å‡º UIï¼šå–®ä¸€å¤§é …
     ****************************************************/
    return (
        <div className="p-4 bg-white rounded shadow mb-4">

            <div className="flex justify-between items-center mb-2">
                <h3 className="font-bold text-lg">é …æ¬¡ {index + 1}</h3>

                <button
                    className="text-red-600 hover:text-red-800"
                    onClick={deleteItem}
                >
                    åˆªé™¤
                </button>
            </div>

            {/**********************
             * ğŸ”µ å“åï¼ˆæœå°‹ + è‡ªå‹•å¸¶å…¥ï¼‰
             **********************/}
            <div className="mb-3 relative">
                <label className="font-semibold">å“åï¼ˆå¯æœå°‹ï¼‰ï¼š</label>

                <input
                    type="text"
                    className="w-full border p-2 rounded mt-1"
                    value={query || item.name}
                    placeholder="è¼¸å…¥é—œéµå­—æœå°‹å“å"
                    onChange={(e) => {
                        setQuery(e.target.value);
                        setShowDropdown(true);
                    }}
                    onKeyDown={handleKeyDown}
                    onFocus={() => setShowDropdown(true)}
                />

                {/* æœå°‹çµæœä¸‹æ‹‰ */}
                {showDropdown && filteredItems.length > 0 && (
                    <div className="absolute bg-white border w-full max-h-60 overflow-auto z-50 shadow-lg rounded mt-1">
                        {filteredItems.map((row, i) => (
                            <div
                                key={i}
                                className={`p-2 cursor-pointer ${
                                    highlightIndex === i ? "bg-blue-100" : ""
                                }`}
                                onClick={() => applySelected(row)}
                            >
                                <div className="font-bold">{row["å“å"]}</div>
                                <div className="text-sm text-gray-600">
                                    {row["è¦æ ¼"]}
                                </div>

                                {/* ç”¨æ–™ç°¡çŸ­é è¦½ */}
                                <div className="text-xs text-gray-500">
                                    {[row["ç”¨æ–™1"], row["ç”¨æ–™2"], row["ç”¨æ–™3"]]
                                        .filter(Boolean)
                                        .join(" / ")}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>

            {/**********************
             * ğŸ”µ è¦æ ¼
             **********************/}
            <div className="mb-3">
                <label className="font-semibold">è¦æ ¼ï¼š</label>
                <input
                    type="text"
                    className="w-full border p-2 rounded mt-1"
                    value={item.specMain}
                    onChange={(e) => updateItem({ specMain: e.target.value })}
                />
            </div>

            {/**********************
             * ğŸ”µ ç”¨æ–™ï¼ˆè‡ªå‹•åˆä½µå¾Œå¯æ‰‹å‹•èª¿æ•´ï¼‰
             **********************/}
            <div className="mb-3">
                <label className="font-semibold">ç”¨æ–™æ˜ç´°ï¼š</label>
                <textarea
                    className="w-full border p-2 rounded mt-1"
                    value={item.specMaterial}
                    rows={2}
                    onChange={(e) => updateItem({ specMaterial: e.target.value })}
                ></textarea>
            </div>

            {/**********************
             * å–®ä½ + æ•¸é‡
             **********************/}
            <div className="grid grid-cols-2 gap-4 mb-3">
                <div>
                    <label className="font-semibold">å–®ä½ï¼š</label>
                    <input
                        type="text"
                        className="w-full border p-2 rounded mt-1"
                        value={item.unit}
                        onChange={(e) => updateItem({ unit: e.target.value })}
                    />
                </div>

                <div>
                    <label className="font-semibold">æ•¸é‡ï¼š</label>
                    <input
                        type="number"
                        className="w-full border p-2 rounded mt-1"
                        value={item.qty}
                        onChange={(e) => updateItem({ qty: Number(e.target.value) })}
                    />
                </div>
            </div>

            {/**********************
             * å–®åƒ¹
             **********************/}
            <div className="mb-3">
                <label className="font-semibold">å–®åƒ¹ï¼š</label>
                <input
                    type="number"
                    className="w-full border p-2 rounded mt-1"
                    value={item.price}
                    onChange={(e) => updateItem({ price: Number(e.target.value) })}
                />
            </div>

            {/**********************
             * å‚™è¨»
             **********************/}
            <div className="mb-3">
                <label className="font-semibold">å‚™è¨»ï¼š</label>
                <textarea
                    className="w-full border p-2 rounded mt-1"
                    value={item.remarks}
                    onChange={(e) => updateItem({ remarks: e.target.value })}
                ></textarea>
            </div>
        </div>
    );
}
/****************************************************
 * A5-1 â€” åœ–ç‰‡ä¸Šå‚³å€ï¼ˆåŠ å…¥ QuoteItem å…§ï¼‰
 ****************************************************/
function QuoteItem({ item, index, updateItem, deleteItem }) {
    const { specItems } = React.useContext(AppContext);

    // ğŸ‘‰ ç¢ºä¿ item.subItems å­˜åœ¨
    const subItems = item.subItems || [];

    const handleAddImage = (file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const newImage = {
                id: uuid(),
                type: "image",
                url: e.target.result
            };

            updateItem({
                subItems: [...subItems, newImage]
            });
        };
        reader.readAsDataURL(file);
    };

    const handleDeleteImage = (imgId) => {
        updateItem({
            subItems: subItems.filter(sub => sub.id !== imgId)
        });
    };

    // ---ï¼ˆå‰é¢éƒ½æ˜¯ A4 çš„å…§å®¹ï¼Œä¿æŒä¸è®Šï¼‰---

    return (
        <div className="p-4 bg-white rounded shadow mb-4">
            {/* A4 çš„æ¬„ä½å…¨éƒ¨ä¿ç•™... */}

            {/**********************
             * ğŸ”µ å‚™è¨»
             **********************/}
            <div className="mb-3">
                <label className="font-semibold">å‚™è¨»ï¼š</label>
                <textarea
                    className="w-full border p-2 rounded mt-1"
                    value={item.remarks}
                    onChange={(e) => updateItem({ remarks: e.target.value })}
                ></textarea>
            </div>

            {/**********************
             * ğŸ–¼ è£œå……åœ–ç‰‡ä¸Šå‚³å€
             **********************/}
            <div className="mb-3">
                <label className="font-semibold block mb-1">è£œå……åœ–ç‰‡ï¼š</label>

                <input
                    type="file"
                    accept="image/*"
                    onChange={(e) => {
                        if (e.target.files && e.target.files.length > 0) {
                            handleAddImage(e.target.files[0]);
                        }
                    }}
                    className="mb-2"
                />

                {/* åœ–ç‰‡é è¦½åˆ—è¡¨ */}
                <div>
                    {subItems
                        .filter(s => s.type === "image")
                        .map(img => (
                            <SubImageItem
                                key={img.id}
                                image={img}
                                onDelete={() => handleDeleteImage(img.id)}
                            />
                        ))}
                </div>
            </div>

        </div>
    );
}
// --- è£œå……åœ–ç‰‡ ---
} else if (sub.type === 'image' && sub.url) {
    rows.push(
        <tr key={sub.id + '-img'} className="sub-item-note">
            <td colSpan="8"
                style={{
                    border: '1px solid black',
                    padding: '4px',
                    textAlign: 'center'
                }}>
                <strong>è£œå……åœ–ç‰‡ï¼š</strong>
                <img
                    src={sub.url}
                    className="print-image"
                    style={{
                        maxWidth: "400px",
                        marginTop: "6px"
                    }}
                />
            </td>
        </tr>
    );
}
// --- è£œå……æ–‡å­— ---
} else if (sub.type === 'text' && sub.text) {
    rows.push(
        <tr key={sub.id + '-text'} className="sub-item-note">
            <td colSpan="8"
                style={{
                    border: '1px solid black',
                    padding: '6px',
                    fontSize: "13px",
                    whiteSpace: "pre-wrap"
                }}>
                <strong>è£œå……èªªæ˜ï¼š</strong>
                <div style={{ marginTop: "4px" }}>
                    {sub.text}
                </div>
            </td>
        </tr>
    );
}
{/* â­ A5-2 â€” æ–‡å­—è£œå……å€å¡Šï¼ˆè²¼åœ¨ A5-1 å¾Œæ–¹ï¼‰ */}
    <div className="mb-3">
        <label className="font-semibold block mb-1">è£œå……æ–‡å­—ï¼š</label>

        <textarea
            className="w-full border p-2 rounded mb-2"
            placeholder="è¼¸å…¥è£œå……èªªæ˜ï¼Œä¾‹å¦‚æ–½å·¥æ–¹å¼ã€åŠ å·¥èªªæ˜â€¦"
            value={item._tempText || ""}
            onChange={(e) => updateItem({ _tempText: e.target.value })}
        ></textarea>

        <button
            className="px-3 py-1 bg-green-600 text-white rounded mb-3"
            onClick={() => {
                if (!item._tempText || item._tempText.trim() === "") return;

                const newText = {
                    id: uuid(),
                    type: "text",
                    text: item._tempText.trim()
                };

                updateItem({
                    subItems: [...(item.subItems || []), newText],
                    _tempText: ""
                });
            }}
        >
            â• æ–°å¢è£œå……æ–‡å­—
        </button>

        {(item.subItems || [])
            .filter(s => s.type === "text")
            .map(sub => (
                <SubTextItem
                    key={sub.id}
                    sub={sub}
                    onDelete={() =>
                        updateItem({
                            subItems: item.subItems.filter(s => s.id !== sub.id)
                        })
                    }
                />
            ))}
    </div>

}
 /****************************************************
 * A5-2 â€” è£œå……æ–‡å­—å­é …ç›®ï¼ˆå¯åˆªé™¤ï¼‰
 ****************************************************/
function SubTextItem({ sub, onDelete }) {
    return (
        <div className="flex items-start space-x-3 bg-gray-50 p-2 rounded border mb-2">
            <div className="flex-1 whitespace-pre-wrap">
                {sub.text}
            </div>

            <button
                className="text-red-600 hover:text-red-800"
                onClick={onDelete}
            >
                åˆªé™¤
            </button>
        </div>
    );
}
// --------------------------------------------------
// PrintLayout ä¸»æ¸²æŸ“ï¼ˆA6ï¼‰
// --------------------------------------------------
return (
    <div className="print-page" style={{ fontSize: "13px", color: "black" }}>
        
        {/* --------- æ¨™é ­ï¼šå…¬å¸è³‡è¨Š --------- */}
        <div className="print-header mb-4 text-sm">
            <h1 style={{ textAlign: "center", fontSize: "22px", fontWeight: "bold" }}>
                {companyInfo.name}
            </h1>
            <div style={{ textAlign: "center", fontSize: "12px" }}>
                çµ±ä¸€ç·¨è™Ÿï¼šâ€” | é›»è©±ï¼š{companyInfo.tel} | å‚³çœŸï¼š{companyInfo.fax}
            </div>
            <div style={{ textAlign: "center", fontSize: "12px" }}>
                Email: {companyInfo.email}
            </div>
            <div style={{ textAlign: "center", fontSize: "12px", marginBottom: "10px" }}>
                åœ°å€: {companyInfo.address}
            </div>

            <h2 style={{ textAlign: "center", fontSize: "24px", fontWeight: "bold" }}>
                å·¥ç¨‹å ±åƒ¹å–®
            </h2>
        </div>

        {/* --------- å®¢æˆ¶è³‡è¨Šè¡¨ --------- */}
        <table
            className="print-info-table mb-4"
            style={{ width: "100%", borderCollapse: "collapse" }}
        >
            <tbody>
                <tr>
                    <td style={TH_STYLE}>å®¢æˆ¶åç¨±</td>
                    <td style={TH_TD_STYLE}>{quote.customerName}</td>
                    <td style={TH_STYLE}>è¯çµ¡äºº</td>
                    <td style={TH_TD_STYLE}>{quote.contact}</td>
                </tr>
                <tr>
                    <td style={TH_STYLE}>å·¥ç¨‹åç¨±</td>
                    <td style={TH_TD_STYLE}>{quote.title}</td>
                    <td style={TH_STYLE}>å ±åƒ¹æ—¥æœŸ</td>
                    <td style={TH_TD_STYLE}>{quote.date}</td>
                </tr>
                <tr>
                    <td style={TH_STYLE}>å ±åƒ¹å–®è™Ÿ</td>
                    <td style={TH_TD_STYLE}>{quote.quoteNo}</td>
                    <td style={TH_STYLE}>é›»è©±</td>
                    <td style={TH_TD_STYLE}>{quote.phone}</td>
                </tr>
                <tr>
                    <td style={TH_STYLE}>å·¥ç¨‹åœ°é»</td>
                    <td colSpan="3" style={TH_TD_STYLE}>{quote.location}</td>
                </tr>
            </tbody>
        </table>

        {/* --------- å ±åƒ¹é …ç›®è¡¨æ ¼ --------- */}
        <table
            className="print-items-table"
            style={{ width: "100%", borderCollapse: "collapse" }}
        >
            <thead>
                <tr>
                    <th style={{ ...TH_STYLE, width: "5%" }}>é …æ¬¡</th>
                    <th style={{ ...TH_STYLE, width: "18%" }}>å“å</th>
                    <th style={{ ...TH_STYLE, width: "32%" }}>è¦æ ¼ / ç”¨æ–™æ˜ç´°</th>
                    <th style={{ ...TH_STYLE, width: "7%" }}>å–®ä½</th>
                    <th style={{ ...TH_STYLE, width: "7%" }}>æ•¸é‡</th>
                    <th style={{ ...TH_STYLE, width: "10%" }}>å–®åƒ¹</th>
                    <th style={{ ...TH_STYLE, width: "11%" }}>é‡‘é¡ (å°è¨ˆ)</th>
                    <th style={{ ...TH_STYLE, width: "10%" }}>å‚™è¨»</th>
                </tr>
            </thead>

            <tbody>
                {quote.items.map((item, index) =>
                    renderPrintItem(item, index + 1)
                )}

                {/* --- è¡¨æ ¼å…§ç¸½è¨ˆè¡Œ --- */}
                <tr>
                    <td colSpan="6"
                        style={{
                            ...TH_TD_STYLE,
                            textAlign: "right",
                            fontWeight: "bold",
                            background: "#f0f0f0"
                        }}>
                        ç¸½è¨ˆé‡‘é¡ï¼ˆæœªç¨…ï¼‰ï¼š
                    </td>
                    <td style={{ ...TD_ALIGN_RIGHT_STYLE, fontWeight: "bold", color: "blue" }}>
                        {formatMoney(totalAmount)}
                    </td>
                    <td style={TH_TD_STYLE}></td>
                </tr>
            </tbody>
        </table>

        {/* --------- åƒ…åˆ—å°æ™‚é¡¯ç¤ºæœ€çµ‚é‡‘é¡å€å¡Š --------- */}
        {!isPreview && <TotalSummary />}

        {/* --------- å‚™è¨» / ä»˜æ¬¾æ¢ä»¶ / ç°½ç«  --------- */}
        <div style={{ marginTop: "20px", display: "flex", gap: "20px" }}>
            
            {/* å‚™è¨» + ä»˜æ¬¾æ¢ä»¶ */}
            <div style={{ flex: 2 }}>
                <div
                    className="print-notes-box"
                    style={{
                        border: "1px solid black",
                        padding: "10px",
                        fontSize: "13px"
                    }}
                >
                    <h3 style={{ fontWeight: "bold" }}>å‚™è¨»ï¼ˆæœªç¨…ï¼‰ï¼š</h3>
                    <div style={{ whiteSpace: "pre-wrap" }}>{quote.notes}</div>

                    <h3 style={{ fontWeight: "bold", marginTop: "15px" }}>ä»˜æ¬¾æ¢ä»¶ï¼š</h3>
                    <div style={{ whiteSpace: "pre-wrap" }}>{quote.payment}</div>
                </div>
            </div>

            {/* ç°½ç«  + é‡‘é¡ç¸½çµ */}
            <div style={{ flex: 1 }}>
                {/* æœ€çµ‚é‡‘é¡é¡¯ç¤º */}
                <div
                    style={{
                        border: "1px solid black",
                        padding: "10px",
                        textAlign: "center",
                        marginBottom: "20px"
                    }}
                >
                    <TotalSummary />
                </div>

                {/* ç°½ç« è¡¨æ ¼ */}
                <table
                    style={{ width: "100%", borderCollapse: "collapse", fontSize: "13px" }}
                >
                    <tbody>
                        <tr>
                            <td style={TH_TD_STYLE}>å ±åƒ¹å…¬å¸ç°½ç« ï¼š</td>
                            <td style={TH_TD_STYLE}>å®¢æˆ¶ç¢ºèªç°½ç« ï¼š</td>
                        </tr>

                        {/* å°ç« æ”¾ç½®å€ */}
                        <tr style={{ height: "70px" }}>
                            <td style={TH_TD_STYLE}>
                                <img
                                    src={companyInfo.stamp}
                                    alt="å…¬å¸å°ç« "
                                    style={{
                                        maxWidth: "90px",
                                        margin: "8px auto",
                                        display: "block"
                                    }}
                                />
                                ä»£è¡¨äººï¼š________________
                            </td>
                            <td style={TH_TD_STYLE}>
                                ä»£è¡¨äººï¼š________________
                            </td>
                        </tr>

                        <tr>
                            <td style={TH_TD_STYLE}>æ—¥æœŸï¼š________________</td>
                            <td style={TH_TD_STYLE}>æ—¥æœŸï¼š________________</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {/* åœ°å€ */}
        <div
            style={{
                textAlign: "center",
                marginTop: "20px",
                fontSize: "12px",
                color: "#666"
            }}
        >
            {companyInfo.address}
        </div>

    </div>
);
// --------------------------------------------------
// A7 â€” æ‡‰ç”¨ç¨‹å¼ä¸»ç•«é¢ App()
// --------------------------------------------------
function App() {

    return (
        <div className="min-h-screen bg-gray-100 flex">

            {/* å·¦å´åŠŸèƒ½æ¬„ */}
            <div className="w-72 bg-white shadow-lg p-4 no-print overflow-y-auto">
                <h1 className="text-xl font-extrabold mb-6 text-center text-blue-700">
                    å·¥ç¨‹å ±åƒ¹ç³»çµ±
                </h1>

                {/* å…¬å¸åˆ‡æ› */}
                <CompanySelector />

                {/* æ¨¡å¼å¥—ç”¨ */}
                <ModeSelector />

                {/* å ±åƒ¹å–®åˆ—è¡¨ */}
                <QuoteList />
            </div>

            {/* å³å´ç·¨è¼¯å€ */}
            <div className="flex-grow p-8">
                <QuoteEditor />
            </div>

        </div>
    );
}
/***********************************************************
 * A8 â€” ReactDOM å•Ÿå‹• + åˆ—å°æ¸²æŸ“æ§åˆ¶
 ***********************************************************/
function renderPrintPreview(quote, totalAmount, negotiatedAmount) {
    const container = document.getElementById("quotePreviewArea");
    if (!container) return;

    // ä½¿ç”¨ ReactDOMServer å°‡ PrintLayout è½‰æˆ HTML å­—ä¸²
    const html = ReactDOMServer.renderToStaticMarkup(
        <PrintLayout
            quote={quote}
            totalAmount={totalAmount}
            negotiatedAmount={negotiatedAmount}
            isPreview={false}
        />
    );

    // è¦†è“‹å…§å®¹
    container.innerHTML = html;
}

function setupPrintHook() {
    // å…¨åŸŸ Hookï¼šPrintButton é»æ“Šæ™‚æœƒå‘¼å«é€™å€‹
    window.__PRINT_QUOTE__ = (quote, totalAmount, negotiatedAmount) => {
        renderPrintPreview(quote, totalAmount, negotiatedAmount);

        // ç­‰å…§å®¹æ¸²æŸ“å®Œæˆå¾Œåˆ—å°
        setTimeout(() => {
            window.print();
        }, 150);
    };
}

// åˆå§‹åŒ– Print Hook
setupPrintHook();

// å•Ÿå‹• React
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(
    <AppProvider>
        <App />
    </AppProvider>
);
</script>
</body>
</html>       
