<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰- æœ€çµ‚æ•´åˆç‰ˆ</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- ReactDOMServerï¼ˆpdf ç”¨ï¼‰-->
    <script src="https://unpkg.com/react-dom@18/umd/react-dom-server.browser.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- XLSX for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- FileSaverï¼ˆPDF ä¸‹è¼‰ç”¨ï¼‰-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
    body {
        font-family: "Microsoft JhengHei", sans-serif;
        background: #f4f4f4;
    }

    .live-preview-box {
        border: 2px dashed #4aa3f0;
        background: #fff;
        padding: 20px;
        margin-top: 30px;
    }

    .print-page {
        max-width: 210mm;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border: 1px solid #ccc;
        transform: scale(0.9);
        transform-origin: top center;
    }

    @media print {
        .no-print { display: none !important; }
    }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
/***************************************************
 * D1 â€” å…¨åŸŸå·¥å…·å‡½å¼ï¼ˆuuid, formatMoney, calcAmountï¼‰
 ***************************************************/
function uuid() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}

function formatMoney(num) {
    if (!num || isNaN(num)) return "0";
    return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 });
}

function calcAmount(item) {
    return Number(item.qty || 0) * Number(item.price || 0);
}

function calcTotal(items) {
    let sum = 0;
    items.forEach(i => {
        sum += calcAmount(i);
        if (i.subItems) {
            i.subItems.forEach(s => {
                if (s.type === "item") sum += calcAmount(s);
            });
        }
    });
    return sum;
}

function calcNegotiated(total, percent, customPrice) {
    if (Number(customPrice) > 0) return Number(customPrice);
    if (percent > 0) return Math.round(total * (1 - percent / 100));
    return total;
}

/***************************************************
 * D1 â€” Google Sheet Loader (è®€å–ä½ çš„ CSV)
 ***************************************************/
async function loadCSV(url) {
    const res = await fetch(url);
    const text = await res.text();

    const rows = text.split("\n").map(r => r.trim()).filter(r => r.length);
    const header = rows[0].split(",");

    return rows.slice(1).map(row => {
        const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
        const obj = {};
        header.forEach((h, i) => {
            let val = cols[i] || "";
            val = val.replace(/^"|"$/g, "");
            obj[h.trim()] = val.trim();
        });
        return obj;
    });
}
/***************************************************
 * D2 â€” AppContextï¼ˆå…¬å¸è³‡æ–™ / å ±åƒ¹å–®è³‡æ–™ä¸­å¿ƒï¼‰
 ***************************************************/

const AppContext = React.createContext();

/* å…¬å¸è³‡æ–™ï¼ˆå«å°ç« ï¼‰ */
const COMPANY_DATA = {
    herhsin: {
        name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
        tel: "07-6521927",
        fax: "07-6517994",
        email: "affairs@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "https://amy262631-ui.github.io/Quotation/herhsin_stamp.JPG",
        prefix: "QH"
    },
    sinchang: {
        name: "è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸",
        tel: "07-6521927",
        fax: "07-6517994",
        email: "affairs@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "https://amy262631-ui.github.io/Quotation/sinchang_stamp.JPG",
        prefix: "QS"
    }
};

/* é è¨­å‚™è¨» */
const DEFAULT_NOTES = `1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚`;

/* é è¨­ä»˜æ¬¾æ¢ä»¶ */
const DEFAULT_PAYMENT = `è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%`;

/* å ±åƒ¹å–®ç·¨è™Ÿç”¢ç”Ÿ */
function generateQuoteNo(companyKey) {
    const prefix = COMPANY_DATA[companyKey]?.prefix || "Q";
    const d = new Date();
    const datePart = [
        d.getFullYear(),
        String(d.getMonth() + 1).padStart(2, "0"),
        String(d.getDate()).padStart(2, "0"),
        String(d.getHours()).padStart(2, "0"),
        String(d.getMinutes()).padStart(2, "0")
    ].join("");

    const random = Math.floor(1000 + Math.random() * 9000);
    return `${prefix}${datePart}-${random}`;
}

/***************************************************
 * â–¶ AppProviderï¼ˆæ‰€æœ‰è³‡æ–™ç‹€æ…‹ç®¡ç†ï¼‰
 ***************************************************/
function AppProvider({ children }) {

    const [company, setCompany] = React.useState("herhsin");
    const [quotes, setQuotes] = React.useState([]);
    const [activeQuoteId, setActiveQuoteId] = React.useState(null);

    /* è¦æ ¼å“åˆ—è¡¨ï¼ˆä¾†è‡ª Google Sheetï¼‰ */
    const [specItems, setSpecItems] = React.useState([]);

    const SPEC_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv";

    /***************************************************
     * è¼‰å…¥ localStorage
     ***************************************************/
    React.useEffect(() => {
        const saved = localStorage.getItem("HERHSIN_QUOTES");
        if (saved) {
            try {
                const arr = JSON.parse(saved);
                if (Array.isArray(arr)) {
                    setQuotes(arr);
                    if (arr.length > 0) setActiveQuoteId(arr[0].id);
                }
            } catch (err) {
                console.error("localStorage load error:", err);
            }
        }
    }, []);

    /***************************************************
     * è‡ªå‹•å­˜å› localStorage
     ***************************************************/
    React.useEffect(() => {
        localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
    }, [quotes]);

    /***************************************************
     * è¼‰å…¥ Google Sheetï¼ˆè¦æ ¼å“è³‡æ–™ï¼‰
     ***************************************************/
    React.useEffect(() => {
        loadCSV(SPEC_URL).then(list => {
            console.log("ğŸ“Œ Google Sheet å·²è¼‰å…¥ï¼š", list);
            setSpecItems(list);
        });
    }, []);

    /***************************************************
     * å»ºç«‹æ–°å ±åƒ¹å–®
     ***************************************************/
    const createQuote = () => {
        const newQuote = {
            id: uuid(),
            company,
            quoteNo: generateQuoteNo(company),
            title: "æœªå‘½åå·¥ç¨‹",
            customerName: "",
            contact: "",
            phone: "",
            location: "",
            date: new Date().toISOString().substring(0, 10),
            items: [],
            notes: DEFAULT_NOTES,
            payment: DEFAULT_PAYMENT,
            discountPercent: 0,
            negotiatedPrice: 0
        };

        setQuotes(prev => [newQuote, ...prev]);
        setActiveQuoteId(newQuote.id);
    };

    /***************************************************
     * åˆªé™¤å ±åƒ¹å–®
     ***************************************************/
    const deleteQuote = (id) => {
        const newList = quotes.filter(q => q.id !== id);
        setQuotes(newList);

        if (activeQuoteId === id) {
            setActiveQuoteId(newList.length ? newList[0].id : null);
        }
    };

    /***************************************************
     * æ›´æ–°å ±åƒ¹å–®
     ***************************************************/
    const updateQuote = (id, update) => {
        setQuotes(prev =>
            prev.map(q => (q.id === id ? { ...q, ...update } : q))
        );
    };

    const activeQuote = quotes.find(q => q.id === activeQuoteId) || null;

    return (
        <AppContext.Provider
            value={{
                company,
                setCompany,
                quotes,
                activeQuote,
                activeQuoteId,
                setActiveQuoteId,
                createQuote,
                deleteQuote,
                updateQuote,
                specItems
            }}
        >
            {children}
        </AppContext.Provider>
    );
}
/***************************************************
 * D3 â€” å·¦å´ UIï¼šå…¬å¸åˆ‡æ› + å ±åƒ¹å–®åˆ—è¡¨
 ***************************************************/

/* â‘  å…¬å¸åˆ‡æ›é¸å–® */
function CompanySelector() {
    const { company, setCompany } = React.useContext(AppContext);

    return (
        <div className="mb-6 bg-white p-3 rounded shadow">
            <h3 className="text-sm font-bold mb-2">é¸æ“‡å…¬å¸ï¼ˆå½±éŸ¿å°ç« ï¼‹ç·¨ç¢¼ï¼‰</h3>

            <select
                className="w-full border rounded p-2"
                value={company}
                onChange={(e) => setCompany(e.target.value)}
            >
                <option value="herhsin">ä½•é‘«å¯¦æ¥­</option>
                <option value="sinchang">è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸</option>
            </select>
        </div>
    );
}

/***************************************************
 * â‘¡ å ±åƒ¹å–®åˆ—è¡¨
 ***************************************************/
function QuoteList() {
    const {
        quotes,
        activeQuoteId,
        setActiveQuoteId,
        deleteQuote,
        createQuote,
    } = React.useContext(AppContext);

    return (
        <div className="bg-white p-3 rounded shadow">
            <div className="flex justify-between items-center mb-3">
                <h3 className="text-sm font-bold">å ±åƒ¹å–®åˆ—è¡¨</h3>

                <button
                    className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700"
                    onClick={createQuote}
                >
                    ï¼‹ æ–°å¢
                </button>
            </div>

            <div className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                {quotes.length === 0 && (
                    <div className="text-xs text-gray-500 text-center py-4">
                        å°šç„¡å ±åƒ¹å–®ï¼Œè«‹æ–°å¢ã€‚
                    </div>
                )}

                {quotes.map((q) => (
                    <div
                        key={q.id}
                        className={`p-2 rounded border cursor-pointer ${
                            q.id === activeQuoteId
                                ? "bg-blue-100 border-blue-500"
                                : "bg-gray-50 hover:bg-gray-100"
                        }`}
                        onClick={() => setActiveQuoteId(q.id)}
                    >
                        <div className="flex justify-between items-center">
                            <div>
                                <div className="font-bold text-sm">{q.title}</div>
                                <div className="text-xs text-gray-500">
                                    {q.quoteNo}
                                </div>
                                <div className="text-xs text-gray-500">
                                    {q.date}
                                </div>
                            </div>

                            {/* åˆªé™¤æŒ‰éˆ• */}
                            <button
                                className="text-red-600 text-xs hover:underline"
                                onClick={(e) => {
                                    e.stopPropagation();
                                    if (confirm("ç¢ºå®šåˆªé™¤æ­¤å ±åƒ¹å–®ï¼Ÿ")) {
                                        deleteQuote(q.id);
                                    }
                                }}
                            >
                                åˆªé™¤
                            </button>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
}
/***************************************************
 * D4 â€” Google Sheet è‡ªå‹•è¼‰å…¥ææ–™è³‡æ–™ + Autocomplete
 * ä½ çš„æ¬„ä½ï¼ˆå®Œå…¨ä¾ä½ æä¾›çš„ä¸­æ–‡æ¬„ä½åç¨±ï¼‰ï¼š
 * åç¨±ã€è¦æ ¼ã€å–®ä½ã€å”®åƒ¹ã€ç”¨æ–™1ã€ç”¨æ–™2ã€ç”¨æ–™3
 ***************************************************/

// ğŸ”§ Google Sheet ä¾†æºï¼ˆä½ çš„ CSV é€£çµï¼‰
const SHEET_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv";


// ========= å…¨åŸŸè³‡æ–™å­˜æ”¾ =========
let SHEET_DATA = []; // å…¨éƒ¨å“åè³‡æ–™ï¼ˆ23 ç­†ï¼‰


// ========= Step 1ï¼šè¼‰å…¥ Google Sheet è³‡æ–™ =========
async function loadSheet() {
    try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const rows = text.split("\n").map(r => r.split(","));

        const header = rows[0];
        const body = rows.slice(1);

        SHEET_DATA = body.map(r => {
            const obj = {};
            header.forEach((h, i) => (obj[h.trim()] = (r[i] || "").trim()));
            return obj;
        });

        console.log("ğŸ“Œ Google Sheet å·²è¼‰å…¥ï¼š", SHEET_DATA);
    } catch (e) {
        console.error("Google Sheet è¼‰å…¥éŒ¯èª¤ï¼š", e);
    }
}

// ä¸€é–‹å§‹å°±è¼‰å…¥
loadSheet();


/***************************************************
 * Step 2 â€” Autocompleteï¼šä¾ã€Œåç¨±ã€æ¨¡ç³Šæœå°‹
 ***************************************************/
function searchMaterial(keyword) {
    if (!keyword) return [];

    keyword = keyword.trim();

    return SHEET_DATA.filter((row) =>
        row["åç¨±"]?.includes(keyword)
    );
}


/***************************************************
 * Step 3 â€” Autocomplete ä¸‹æ‹‰é¸å–®å…ƒä»¶
 ***************************************************/
function Autocomplete({ value, onSelect, onChange }) {
    const [list, setList] = React.useState([]);

    return (
        <div className="relative">
            {/* ä½¿ç”¨è€…è¼¸å…¥ */}
            <input
                value={value}
                onChange={(e) => {
                    const v = e.target.value;
                    onChange(v);
                    setList(searchMaterial(v));
                }}
                className="w-full border p-2 rounded"
                placeholder="è¼¸å…¥å“åé—œéµå­—â€¦"
            />

            {/* ä¸‹æ‹‰æ¸…å–® */}
            {list.length > 0 && (
                <div className="absolute left-0 right-0 bg-white border rounded shadow max-h-40 overflow-y-auto z-50">
                    {list.map((item, idx) => (
                        <div
                            key={idx}
                            className="p-2 hover:bg-blue-100 cursor-pointer text-sm"
                            onClick={() => {
                                onSelect(item);
                                setList([]);
                            }}
                        >
                            <div className="font-bold">{item["åç¨±"]}</div>
                            <div className="text-gray-500 text-xs">
                                {item["è¦æ ¼"]}
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}
/***************************************************
 * D5 â€” QuoteItemï¼ˆå¤§é …ç·¨è¼¯å€ï¼‰
 * å·²æ•´åˆï¼š
 * âœ” Autocompleteï¼ˆè‡ªå‹•æœå°‹å“åï¼‰
 * âœ” é¸æ“‡å“åå¾Œè‡ªå‹•å¸¶å‡ºï¼š
 *    â†’ è¦æ ¼ï¼ˆspecMainï¼‰
 *    â†’ å–®ä½ï¼ˆunitï¼‰
 *    â†’ å”®åƒ¹ï¼ˆpriceï¼‰
 *    â†’ ç”¨æ–™1ï½3ï¼ˆåŠ åˆ° remarks ä¸‹æ–¹é¡¯ç¤ºï¼‰
 ***************************************************/
function QuoteItem({ item, index, updateItem, deleteItem }) {

    // ç•¶ä½¿ç”¨è€…å¾ autocomplete é¸æ“‡å“å
    const handleSelectMaterial = (m) => {
        updateItem(item.id, {
            name: m["åç¨±"] || "",
            specMain: m["è¦æ ¼"] || "",
            unit: m["å–®ä½"] || "",
            price: Number(m["å”®åƒ¹"] || 0),
            material1: m["ç”¨æ–™1"] || "",
            material2: m["ç”¨æ–™2"] || "",
            material3: m["ç”¨æ–™3"] || "",
        });
    };

    return (
        <div className="bg-white p-4 rounded shadow border">

            {/* ===== å¤§é …æ¨™é¡Œåˆ— ===== */}
            <div className="flex justify-between items-center mb-3">
                <div className="font-bold text-lg">é …ç›® {index}</div>
                <button
                    className="text-red-600 hover:text-red-800"
                    onClick={() => deleteItem(item.id)}
                >
                    åˆªé™¤
                </button>
            </div>

            {/* ====== Autocomplete + å“å ====== */}
            <label className="font-semibold block mb-1">å“åï¼š</label>
            <Autocomplete
                value={item.name}
                onChange={(v) => updateItem(item.id, { name: v })}
                onSelect={(m) => handleSelectMaterial(m)}
            />

            {/* è‹¥è¦æ ¼å­˜åœ¨ï¼Œé¡¯ç¤ºæ–¼ä¸‹ä¸€è¡Œ */}
            {item.specMain && (
                <div className="mt-1 text-sm text-gray-600">
                    <strong>è¦æ ¼ï¼š</strong> {item.specMain}
                </div>
            )}

            {/* è‹¥ç”¨æ–™å­˜åœ¨ï¼Œé¡¯ç¤ºæ–¼ä¸‹ä¸€è¡Œ */}
            {(item.material1 || item.material2 || item.material3) && (
                <div className="mt-1 text-sm text-gray-600">
                    <strong>ç”¨æ–™æ˜ç´°ï¼š</strong>
                    {[item.material1, item.material2, item.material3]
                        .filter(Boolean)
                        .join("ã€")}
                </div>
            )}

            {/* ===== æ•¸é‡ / å–®ä½ / å–®åƒ¹ ===== */}
            <div className="grid grid-cols-3 gap-3 mt-4">

                <div>
                    <label className="font-semibold block mb-1">æ•¸é‡ï¼š</label>
                    <input
                        type="number"
                        value={item.qty}
                        onChange={(e) =>
                            updateItem(item.id, { qty: Number(e.target.value) })
                        }
                        className="w-full border p-2 rounded"
                    />
                </div>

                <div>
                    <label className="font-semibold block mb-1">å–®ä½ï¼š</label>
                    <input
                        value={item.unit}
                        onChange={(e) =>
                            updateItem(item.id, { unit: e.target.value })
                        }
                        className="w-full border p-2 rounded"
                    />
                </div>

                <div>
                    <label className="font-semibold block mb-1">å–®åƒ¹ï¼š</label>
                    <input
                        type="number"
                        value={item.price}
                        onChange={(e) =>
                            updateItem(item.id, { price: Number(e.target.value) })
                        }
                        className="w-full border p-2 rounded"
                    />
                </div>
            </div>

            {/* ===== å‚™è¨» ===== */}
            <div className="mt-4">
                <label className="font-semibold block mb-1">å‚™è¨»ï¼š</label>
                <textarea
                    rows="2"
                    value={item.remarks}
                    onChange={(e) =>
                        updateItem(item.id, { remarks: e.target.value })
                    }
                    className="w-full border p-2 rounded"
                />
            </div>

            {/* ===== å°è¨ˆ ===== */}
            <div className="mt-3 text-right font-bold text-blue-700">
                å°è¨ˆï¼šNT$ {formatMoney(item.qty * item.price)}
            </div>
        </div>
    );
}
/***************************************************
 * D6 â€” åˆ—å° PrintButtonï¼ˆä½¿ç”¨ ReactDOMServerï¼‰
 ***************************************************/
function PrintButton({ quote }) {

    const handlePrint = () => {
        if (!quote) {
            alert("å°šæœªé¸æ“‡å ±åƒ¹å–®");
            return;
        }

        // ä»¥ ReactDOMServer ç”¢ç”Ÿ HTML
        const html = ReactDOMServer.renderToString(
            <PrintLayout
                quote={quote}
                totalAmount={calcTotal(quote.items)}
                negotiatedAmount={calcNegotiated(
                    calcTotal(quote.items),
                    quote.discountPercent,
                    quote.negotiatedPrice
                )}
            />
        );

        // æ–°è¦–çª—è¼‰å…¥æ’ç‰ˆç”¨ CSS + å ±åƒ¹å–® HTML
        const win = window.open("", "_blank");
        win.document.write(`
            <html>
            <head>
                <title>åˆ—å°å ±åƒ¹å–®</title>
                <style>
                    body { font-family: "Microsoft JhengHei"; padding: 20px; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid black; padding: 6px; }
                    .stamp { width: 140px; margin-top: 10px; }
                </style>
            </head>
            <body>${html}</body>
            </html>
        `);

        win.document.close();
        win.focus();
        win.print();
    };

    return (
        <button
            onClick={handlePrint}
            className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        >
            ğŸ–¨ åˆ—å°å ±åƒ¹å–®
        </button>
    );
}

/***************************************************
 * D6 â€” ç”¢ç”Ÿ PDF çš„æŒ‰éˆ•ï¼ˆä½¿ç”¨ html2canvas + jsPDFï¼‰
 * æŒ‰éˆ•ï¼šğŸ“„ è½‰ PDF
 ***************************************************/
function ExportPDFButton({ quote }) {

    const generatePDF = async () => {
        if (!quote) {
            alert("å°šæœªé¸æ“‡å ±åƒ¹å–®");
            return;
        }

        const element = document.createElement("div");

        // ä½¿ç”¨ PrintLayout ç”Ÿæˆå ±åƒ¹å…§å®¹
        const html = ReactDOMServer.renderToString(
            <PrintLayout
                quote={quote}
                totalAmount={calcTotal(quote.items)}
                negotiatedAmount={calcNegotiated(
                    calcTotal(quote.items),
                    quote.discountPercent,
                    quote.negotiatedPrice
                )}
            />
        );

        element.innerHTML = html;
        document.body.appendChild(element);

        const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
        });

        const imgData = canvas.toDataURL("image/png");

        const pdf = new jspdf.jsPDF("p", "mm", "a4");
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

        pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
        pdf.save(`å ±åƒ¹å–®_${quote.quoteNo}.pdf`);

        document.body.removeChild(element);
    };

    return (
        <button
            onClick={generatePDF}
            className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 ml-3"
        >
            ğŸ“„ è½‰ PDF
        </button>
    );
}
/***************************************************
 * D7 â€” PrintLayoutï¼ˆA4 åˆ—å°æ¨¡æ¿ + å°ç«  + ç”¨æ–™ + å­é …ç›®ï¼‰
 ***************************************************/
function PrintLayout({ quote, totalAmount, negotiatedAmount }) {

    if (!quote) return null;

    const company = COMPANY_DATA[quote.company] || COMPANY_DATA.herhsin;

    return (
        <div style={{
            width: "794px",   // A4 å¯¬ px
            padding: "20px",
            fontFamily: "Microsoft JhengHei",
            color: "#000"
        }}>

            {/* ======== å…¬å¸æŠ¬é ­ ======== */}
            <h1 style={{ fontSize: "28px", fontWeight: "bold", textAlign: "center" }}>
                {company.name}
            </h1>

            <div style={{ textAlign: "center", marginBottom: "10px" }}>
                çµ±ç·¨ï¼šæœªå¡« â€¢ é›»è©±ï¼š{company.tel} â€¢ å‚³çœŸï¼š{company.fax}<br />
                åœ°å€ï¼š{company.address}
            </div>

            <h2 style={{
                fontSize: "24px",
                fontWeight: "bold",
                textAlign: "center",
                margin: "20px 0"
            }}>
                å ±â€ƒåƒ¹â€ƒå–®
            </h2>

            {/* ======== å®¢æˆ¶è³‡æ–™ ======== */}
            <table style={{ width: "100%", fontSize: "15px", marginBottom: "15px" }}>
                <tbody>
                    <tr>
                        <td>å®¢æˆ¶åç¨±ï¼š</td>
                        <td>{quote.customerName || ""}</td>
                        <td>è¯çµ¡äººï¼š</td>
                        <td>{quote.contact || ""}</td>
                    </tr>
                    <tr>
                        <td>é›»è©±ï¼š</td>
                        <td>{quote.phone || ""}</td>
                        <td>å ±åƒ¹æ—¥æœŸï¼š</td>
                        <td>{quote.date || ""}</td>
                    </tr>
                    <tr>
                        <td>å·¥ç¨‹åœ°é»ï¼š</td>
                        <td colSpan="3">{quote.location || ""}</td>
                    </tr>
                    <tr>
                        <td>å ±åƒ¹å–®ç·¨è™Ÿï¼š</td>
                        <td colSpan="3">{quote.quoteNo}</td>
                    </tr>
                </tbody>
            </table>

            {/* =================== å ±åƒ¹é …ç›®è¡¨ =================== */}
            <table style={{ width: "100%", borderCollapse: "collapse", fontSize: "14px" }}>
                <thead>
                    <tr>
                        <th style={th}>é …æ¬¡</th>
                        <th style={th}>å“å</th>
                        <th style={th}>è¦æ ¼</th>
                        <th style={th}>å–®ä½</th>
                        <th style={th}>æ•¸é‡</th>
                        <th style={th}>å–®åƒ¹</th>
                        <th style={th}>å°è¨ˆ</th>
                    </tr>
                </thead>

                <tbody>

                    {quote.items.map((item, idx) => {

                        const subtotal = item.qty * item.price;

                        return (
                            <React.Fragment key={item.id}>

                                {/* ======== ä¸»é …ç›® ======== */}
                                <tr>
                                    <td style={tdCenter}>{idx + 1}</td>
                                    <td style={tdLeft}>{item.name}</td>

                                    {/* è¦æ ¼ + ç”¨æ–™ */}
                                    <td style={tdLeft}>
                                        {item.specMain}

                                        {/* ç”¨æ–™æœ‰å¡«æ‰é¡¯ç¤º */}
                                        {item.specMaterial && (
                                            <div style={{ fontSize: "12px", color: "#444" }}>
                                                ç”¨æ–™ï¼š{item.specMaterial}
                                            </div>
                                        )}
                                        {item.specMaterial2 && (
                                            <div style={{ fontSize: "12px", color: "#444" }}>
                                                ç”¨æ–™2ï¼š{item.specMaterial2}
                                            </div>
                                        )}
                                        {item.specMaterial3 && (
                                            <div style={{ fontSize: "12px", color: "#444" }}>
                                                ç”¨æ–™3ï¼š{item.specMaterial3}
                                            </div>
                                        )}
                                    </td>

                                    <td style={tdCenter}>{item.unit}</td>
                                    <td style={tdRight}>{item.qty}</td>
                                    <td style={tdRight}>{formatMoney(item.price)}</td>
                                    <td style={tdRight}>{formatMoney(subtotal)}</td>
                                </tr>

                                {/* ======== å­é …ç›®ï¼šå‚™è¨» ======== */}
                                {item.subItems?.map((sub) => {

                                    if (sub.type === "note") {
                                        return (
                                            <tr key={sub.id + "-note"}>
                                                <td colSpan="7" style={tdNote}>
                                                    å‚™è¨»ï¼š{sub.text}
                                                </td>
                                            </tr>
                                        );
                                    }

                                    /* ======== å­é …ç›®ï¼šè£œå……åœ–ç‰‡ ======== */
                                    if (sub.type === "image" && sub.url) {
                                        return (
                                            <tr key={sub.id + "-img"}>
                                                <td colSpan="7" style={tdNote}>
                                                    <strong>è£œå……åœ–ç‰‡ï¼š</strong><br />
                                                    <img
                                                        src={sub.url}
                                                        style={{
                                                            maxWidth: "350px",
                                                            marginTop: "6px",
                                                            border: "1px solid #999"
                                                        }}
                                                    />
                                                </td>
                                            </tr>
                                        );
                                    }
                                })}

                            </React.Fragment>
                        );
                    })}

                    {/* ç¸½è¨ˆ */}
                    <tr>
                        <td colSpan="6" style={tdRightBold}>ç¸½è¨ˆï¼ˆæœªç¨…ï¼‰</td>
                        <td style={tdRightBold}>{formatMoney(totalAmount)}</td>
                    </tr>

                    <tr>
                        <td colSpan="6" style={tdRightBold}>è­°åƒ¹å¾Œç¸½åƒ¹ï¼ˆæœªç¨…ï¼‰</td>
                        <td style={tdRightBold}>{formatMoney(negotiatedAmount)}</td>
                    </tr>

                </tbody>
            </table>

            {/* ======== å‚™è¨» + å°ç«  ======== */}
            <div style={{ marginTop: "30px", fontSize: "14px" }}>
                <strong>å‚™è¨»ï¼š</strong><br />
                <pre style={{ whiteSpace: "pre-wrap", fontSize: "13px" }}>
                    {quote.notes}
                </pre>
            </div>

            <div style={{ marginTop: "20px", textAlign: "right" }}>
                <img
                    src={company.stamp}
                    style={{ width: "180px", opacity: 0.95 }}
                />
            </div>
        </div>
    );
}

/************** ä½¿ç”¨çš„è¡¨æ ¼æ¨£å¼ **************/
const th = {
    border: "1px solid black",
    padding: "6px",
    background: "#eee",
    textAlign: "center"
};

const tdLeft = {
    border: "1px solid black",
    padding: "6px",
    textAlign: "left"
};

const tdCenter = {
    border: "1px solid black",
    padding: "6px",
    textAlign: "center"
};

const tdRight = {
    border: "1px solid black",
    padding: "6px",
    textAlign: "right"
};

const tdRightBold = {
    border: "1px solid black",
    padding: "6px",
    fontWeight: "bold",
    textAlign: "right"
};

const tdNote = {
    border: "1px solid black",
    padding: "6px",
    background: "#fafafa",
    fontSize: "13px"
};
/***************************************************
 * D8 â€” QuoteItemï¼ˆå«ï¼šAutocompleteã€è‡ªå‹•å¸¶è³‡æ–™ã€ç”¨æ–™1~3ã€å­é …ç›®å‚™è¨»ï¼‹åœ–ç‰‡ï¼‰
 ***************************************************/
function QuoteItem({ item, index, updateItem, deleteItem }) {

    const { sheetData } = React.useContext(AppContext);

    const [nameInput, setNameInput] = React.useState(item.name || "");
    const [showList, setShowList] = React.useState(false);

    const matchList = React.useMemo(() => {
        if (!nameInput) return [];
        return sheetData.filter(row =>
            row.å“å && row.å“å.includes(nameInput)
        );
    }, [nameInput, sheetData]);

    /* é¸æ“‡ autocomplete å“å â†’ è‡ªå‹•å¸¶å…¥æ‰€æœ‰æ¬„ä½ */
    const selectItem = (row) => {
        updateItem(item.id, {
            name: row.å“å,
            specMain: row.è¦æ ¼ || "",
            unit: row.å–®ä½ || "",
            price: Number(row.å–®åƒ¹ || 0),
            specMaterial: row.ç”¨æ–™1 || "",
            specMaterial2: row.ç”¨æ–™2 || "",
            specMaterial3: row.ç”¨æ–™3 || "",
        });
        setNameInput(row.å“å);
        setShowList(false);
    };

    /* æ–°å¢å­é …ç›® */
    const addSubItem = (type) => {
        const newSub = {
            id: uuid(),
            type,
            text: "",
            url: "",
        };
        updateItem(item.id, {
            subItems: [...(item.subItems || []), newSub]
        });
    };

    /* æ›´æ–°å­é …ç›® */
    const updateSubItem = (subId, value) => {
        const newList = item.subItems.map(s =>
            s.id === subId ? { ...s, ...value } : s
        );
        updateItem(item.id, { subItems: newList });
    };

    /* åˆªé™¤å­é … */
    const deleteSubItem = (subId) => {
        const list = item.subItems.filter(s => s.id !== subId);
        updateItem(item.id, { subItems: list });
    };

    return (
        <div className="p-4 bg-white rounded shadow">

            {/* ====== æ¨™é¡Œè¡Œ ====== */}
            <div className="flex justify-between items-center mb-2">
                <h3 className="font-bold text-lg">é …ç›® {index}</h3>
                <button
                    className="text-red-600 font-bold"
                    onClick={() => deleteItem(item.id)}
                >
                    âœ• åˆªé™¤æ­¤é …
                </button>
            </div>

            {/* ====== å“å + è‡ªå‹•å®Œæˆ ====== */}
            <div className="relative mb-3">
                <label className="font-semibold">å“åï¼š</label>
                <input
                    value={nameInput}
                    onChange={(e) => {
                        setNameInput(e.target.value);
                        setShowList(true);
                        updateItem(item.id, { name: e.target.value });
                    }}
                    className="border w-full p-2 rounded"
                    placeholder="è¼¸å…¥å“åï¼ˆè‡ªå‹•å¸¶å‡º Google Sheet è³‡æ–™ï¼‰"
                />

                {/* Autocomplete ä¸‹æ‹‰ */}
                {showList && matchList.length > 0 && (
                    <div className="absolute bg-white border w-full max-h-48 overflow-y-auto z-20">
                        {matchList.map((row, idx) => (
                            <div
                                key={idx}
                                className="p-2 hover:bg-blue-100 cursor-pointer"
                                onClick={() => selectItem(row)}
                            >
                                {row.å“å}ï¼ˆ{row.è¦æ ¼}ï¼‰
                            </div>
                        ))}
                    </div>
                )}
            </div>

            {/* ====== è¦æ ¼ ====== */}
            <div className="mb-2">
                <label className="font-semibold">è¦æ ¼ï¼š</label>
                <input
                    className="border p-2 rounded w-full"
                    value={item.specMain}
                    onChange={(e) => updateItem(item.id, { specMain: e.target.value })}
                />
            </div>

            {/* ====== ç”¨æ–™ 1~3 ====== */}
            <div className="grid grid-cols-3 gap-3 mb-3">
                <div>
                    <label className="font-semibold">ç”¨æ–™ 1ï¼š</label>
                    <input
                        value={item.specMaterial}
                        onChange={(e) => updateItem(item.id, { specMaterial: e.target.value })}
                        className="border p-2 rounded w-full"
                    />
                </div>

                <div>
                    <label className="font-semibold">ç”¨æ–™ 2ï¼š</label>
                    <input
                        value={item.specMaterial2}
                        onChange={(e) => updateItem(item.id, { specMaterial2: e.target.value })}
                        className="border p-2 rounded w-full"
                    />
                </div>

                <div>
                    <label className="font-semibold">ç”¨æ–™ 3ï¼š</label>
                    <input
                        value={item.specMaterial3}
                        onChange={(e) => updateItem(item.id, { specMaterial3: e.target.value })}
                        className="border p-2 rounded w-full"
                    />
                </div>
            </div>

            {/* ====== å–®ä½ / æ•¸é‡ / å–®åƒ¹ ====== */}
            <div className="grid grid-cols-3 gap-3 mb-3">
                <div>
                    <label className="font-semibold">å–®ä½ï¼š</label>
                    <input
                        className="border p-2 rounded w-full"
                        value={item.unit}
                        onChange={(e) => updateItem(item.id, { unit: e.target.value })}
                    />
                </div>

                <div>
                    <label className="font-semibold">æ•¸é‡ï¼š</label>
                    <input
                        type="number"
                        className="border p-2 rounded w-full"
                        value={item.qty}
                        onChange={(e) => updateItem(item.id, { qty: Number(e.target.value) })}
                    />
                </div>

                <div>
                    <label className="font-semibold">å–®åƒ¹ï¼š</label>
                    <input
                        type="number"
                        className="border p-2 rounded w-full"
                        value={item.price}
                        onChange={(e) => updateItem(item.id, { price: Number(e.target.value) })}
                    />
                </div>
            </div>

            {/* ====== å‚™è¨» ====== */}
            <div className="mb-3">
                <label className="font-semibold">å‚™è¨»ï¼š</label>
                <textarea
                    className="border w-full p-2 rounded"
                    value={item.remarks}
                    onChange={(e) => updateItem(item.id, { remarks: e.target.value })}
                />
            </div>

            {/* ====== å­é …ç›®åˆ—è¡¨ ====== */}
            <div className="mt-4 space-y-3">
                {item.subItems?.map((sub) => (
                    <div key={sub.id} className="p-3 border rounded bg-gray-50">

                        {/* --- å‚™è¨»å­é … --- */}
                        {sub.type === "note" && (
                            <div>
                                <label className="font-semibold">è£œå……æ–‡å­—ï¼š</label>
                                <textarea
                                    className="border p-2 rounded w-full"
                                    value={sub.text}
                                    onChange={(e) =>
                                        updateSubItem(sub.id, { text: e.target.value })
                                    }
                                />
                            </div>
                        )}

                        {/* --- åœ–ç‰‡å­é … --- */}
                        {sub.type === "image" && (
                            <div>
                                <label className="font-semibold">è£œå……åœ–ç‰‡ï¼š</label>
                                <input
                                    type="file"
                                    accept="image/*"
                                    onChange={(e) => {
                                        const file = e.target.files[0];
                                        if (file) {
                                            const url = URL.createObjectURL(file);
                                            updateSubItem(sub.id, { url });
                                        }
                                    }}
                                />

                                {sub.url && (
                                    <img
                                        src={sub.url}
                                        className="mt-2"
                                        style={{ maxWidth: "250px" }}
                                    />
                                )}
                            </div>
                        )}

                        <button
                            className="text-red-600 mt-2"
                            onClick={() => deleteSubItem(sub.id)}
                        >
                            åˆªé™¤å­é …
                        </button>
                    </div>
                ))}
            </div>

            {/* ====== æ–°å¢å­é …ç›®æŒ‰éˆ• ====== */}
            <div className="mt-3 flex gap-4">
                <button
                    className="px-3 py-1 bg-blue-600 text-white rounded"
                    onClick={() => addSubItem("note")}
                >
                    ï¼‹ è£œå……æ–‡å­—
                </button>

                <button
                    className="px-3 py-1 bg-green-600 text-white rounded"
                    onClick={() => addSubItem("image")}
                >
                    ï¼‹ è£œå……åœ–ç‰‡
                </button>
            </div>

        </div>
    );
}
/***********************************************
 * D9 â€” ä¸» Appï¼ˆæ¸²æŸ“è‡³ #rootï¼‰
 ***********************************************/
ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</script>

</body>
</html>
