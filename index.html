<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆä½•é‘« / è–ªæ˜Œï¼‰- Final V1</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- XLSX for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: "Microsoft JhengHei", sans-serif;
            background: #f6f7f9;
        }

        @media print {
            .no-print { display: none !important; }

            body {
                margin: 0;
                padding: 0;
                background: white;
            }

            #printArea {
                display: block !important;
                width: 210mm;
                min-height: 297mm;
                padding: 10mm 12mm;
                margin: auto;
                background: white;
                font-size: 12px;
            }

            table {
                border-collapse: collapse;
            }
            th, td {
                border: 1px solid black;
                padding: 4px;
                vertical-align: top;
            }
        }

        #printArea {
            display: none;
        }
    </style>
</head>

<body class="text-gray-900">
    <div id="root"></div>
    <div id="printArea"></div>
/***********************************************************
 * å…¨åŸŸè³‡æ–™ä¸­å¿ƒ AppContext
 ***********************************************************/
const AppContext = React.createContext();

/* å…©é–“å…¬å¸è³‡æ–™ */
const COMPANY_DATA = {
    herhsin: {
        name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
        prefix: "QH",
        tel: "07-6521927",
        fax: "07-6517994",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "https://amy262631-ui.github.io/Quotation/herhsin_stamp.JPG"
    },
    sinchang: {
        name: "è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸",
        prefix: "QS",
        tel: "07-6521927",
        fax: "07-6517994",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "https://amy262631-ui.github.io/Quotation/sinchang_stamp.JPG"
    }
};

/* Google Sheet CSV ä¾†æº */
const SPEC_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?output=csv";

/* è¼”åŠ©å‡½å¼ */
function uuid() {
    return "xxxx-4xxx-yxxx-xxxx".replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        const v = c === "x" ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

function today() {
    const d = new Date();
    return d.toISOString().slice(0, 10);
}

function generateQuoteNo(companyKey) {
    const prefix = COMPANY_DATA[companyKey].prefix;
    const t = new Date();
    const stamp =
        t.getFullYear().toString() +
        (t.getMonth() + 1).toString().padStart(2, "0") +
        t.getDate().toString().padStart(2, "0") +
        t.getHours().toString().padStart(2, "0") +
        t.getMinutes().toString().padStart(2, "0");
    return `${prefix}${stamp}-${Math.floor(Math.random() * 900 + 100)}`;
}

/* è§£æ Google CSV */
async function loadCSV(url) {
    const res = await fetch(url);
    const txt = await res.text();
    const rows = txt.split("\n").map(r => r.trim());
    const header = rows[0].split(",");

    return rows.slice(1).map(row => {
        const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
        const get = i => (cols[i] || "").replace(/"/g, "").trim();

        return {
            name: get(0),
            unit: get(1),
            price: Number(get(2)) || 0,
            originalSpec: get(3),
            mat1: get(4),
            mat2: get(5),
            mat3: get(6)
        };
    });
}

/***********************************************************
 * AppProviderï¼šç®¡ç†æ‰€æœ‰å ±åƒ¹å–®è³‡æ–™
 ***********************************************************/
function AppProvider({ children }) {
    const [company, setCompany] = React.useState("herhsin");
    const [quotes, setQuotes] = React.useState([]);
    const [activeId, setActiveId] = React.useState(null);
    const [specList, setSpecList] = React.useState([]);

    /* åˆå§‹åŒ–è¼‰å…¥ localStorage */
    React.useEffect(() => {
        const saved = localStorage.getItem("HERHSIN_QUOTES_V1");
        if (saved) {
            const arr = JSON.parse(saved);
            setQuotes(arr);
            if (arr.length > 0) setActiveId(arr[0].id);
        }
    }, []);

    /* åŒæ­¥ localStorage */
    React.useEffect(() => {
        localStorage.setItem("HERHSIN_QUOTES_V1", JSON.stringify(quotes));
    }, [quotes]);

    /* è¼‰å…¥ GoogleSheet å…§å®¹ */
    React.useEffect(() => {
        loadCSV(SPEC_CSV_URL).then(setSpecList);
    }, []);

    /* å»ºç«‹æ–°å ±åƒ¹å–® */
    const createQuote = () => {
        const q = {
            id: uuid(),
            company,
            quoteNo: generateQuoteNo(company),
            title: "æœªå‘½åå·¥ç¨‹",
            customer: "",
            contact: "",
            phone: "",
            location: "",
            date: today(),
            items: [],
            notes: `æœ¬å ±åƒ¹å–®æœªå«åŠ å€¼ç¨…ã€‚\nå®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ç’°å¢ƒã€‚\nå ±åƒ¹æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚\nææ–™é ˆç”±æœ¬å…¬å¸ä¾›æ‡‰èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚`,
            payment: `è¨‚é‡‘ï¼š40%\nè£½ä½œå®Œæˆï¼š30%\nå®‰è£å®Œæˆï¼š20%\nå®Œå·¥é©—æ”¶ï¼š10%`
        };

        setQuotes(prev => [q, ...prev]);
        setActiveId(q.id);
    };

    /* åˆªé™¤å ±åƒ¹å–® */
    const deleteQuote = (id) => {
        const list = quotes.filter(q => q.id !== id);
        setQuotes(list);
        if (list.length > 0) setActiveId(list[0].id);
    };

    /* è¤‡è£½å ±åƒ¹å–® */
    const copyQuote = (id) => {
        const q = quotes.find(x => x.id === id);
        if (!q) return;
        const newQ = {
            ...structuredClone(q),
            id: uuid(),
            quoteNo: generateQuoteNo(q.company),
            date: today()
        };
        setQuotes(prev => [newQ, ...prev]);
        setActiveId(newQ.id);
    };

    /* æ›´æ–°å ±åƒ¹å–®ï¼ˆéƒ¨åˆ†æ¬„ä½ï¼‰ */
    const updateQuote = (id, data) => {
        setQuotes(prev =>
            prev.map(q => q.id === id ? { ...q, ...data } : q)
        );
    };

    const activeQuote = quotes.find(q => q.id === activeId);

    /* Context */
    const ctx = {
        company,
        setCompany,
        quotes,
        activeQuote,
        activeId,
        setActiveId,
        createQuote,
        deleteQuote,
        copyQuote,
        updateQuote,
        specList
    };

    return (
        <AppContext.Provider value={ctx}>
            {children}
        </AppContext.Provider>
    );
}
/***********************************************************
 * å·¥å…·å‡½å¼ï¼ˆè¨ˆç®—é‡‘é¡ã€æ ¼å¼åŒ–ã€ç”¨æ–™åˆä½µï¼‰
 ***********************************************************/

/* è¨ˆç®—å°è¨ˆ */
function calcAmount(item) {
    const qty = Number(item.qty || 0);
    const price = Number(item.price || 0);
    return qty * price;
}

/* è¨ˆç®—æ•´å¼µå ±åƒ¹å–®é‡‘é¡ */
function calcTotal(items) {
    return items.reduce((sum, it) => sum + calcAmount(it), 0);
}

/* æœ€çµ‚é‡‘é¡ï¼ˆè‹¥æœ‰è¼¸å…¥ negotiatedPrice å°±ç›´æ¥æ¡ç”¨ï¼‰ */
function calcFinal(total, discountPercent, customPrice) {
    const cp = Number(customPrice || 0);
    const dp = Number(discountPercent || 0);

    if (cp > 0) return cp;

    if (dp > 0) {
        return Math.round(total * (1 - dp / 100));
    }
    return total;
}

/* æ•¸å­—æ ¼å¼åŒ–ï¼ˆåƒåˆ†ä½ï¼‰ */
function formatMoney(num) {
    if (!num) return "0";
    return Number(num).toLocaleString("zh-TW");
}

/* åˆä½µç”¨æ–™ï¼ˆä½ æŒ‡å®šä½¿ç”¨ Q1=A â†’ ä¸€è¡Œå‘ˆç¾ï¼‰ */
function mergeMaterials(mat1, mat2, mat3) {
    const arr = [];
    if (mat1) arr.push(mat1);
    if (mat2) arr.push(mat2);
    if (mat3) arr.push(mat3);

    if (arr.length === 0) return "";
    return `ç”¨æ–™æ˜ç´°ï¼š${arr.join("ã€")}`;
}
/***********************************************************
 * å·¦å´ UIï¼ˆå…¬å¸åˆ‡æ› + å ±åƒ¹å–®åˆ—è¡¨ï¼‰
 ***********************************************************/

/* å…¬å¸åˆ‡æ› */
function CompanySelector() {
    const { company, setCompany } = React.useContext(AppContext);

    return (
        <div className="mb-6">
            <h2 className="font-bold mb-2">é¸æ“‡å…¬å¸</h2>

            <div className="flex gap-2">
                <button
                    className={`px-3 py-1 rounded ${
                        company === "herhsin"
                            ? "bg-blue-600 text-white"
                            : "bg-gray-300 hover:bg-gray-400"
                    }`}
                    onClick={() => setCompany("herhsin")}
                >
                    ä½•é‘«
                </button>

                <button
                    className={`px-3 py-1 rounded ${
                        company === "sinchang"
                            ? "bg-blue-600 text-white"
                            : "bg-gray-300 hover:bg-gray-400"
                    }`}
                    onClick={() => setCompany("sinchang")}
                >
                    è–ªæ˜Œ
                </button>
            </div>
        </div>
    );
}


/* å ±åƒ¹å–®åˆ—è¡¨ */
function QuoteList() {
    const {
        quotes,
        activeId,
        setActiveId,
        createQuote,
        copyQuote,
        deleteQuote
    } = React.useContext(AppContext);

    return (
        <div className="mt-6">
            <div className="flex justify-between mb-2">
                <h2 className="font-bold">å ±åƒ¹å–®åˆ—è¡¨</h2>
                <button
                    className="text-xs bg-green-600 text-white px-2 py-1 rounded"
                    onClick={createQuote}
                >
                    + æ–°å¢
                </button>
            </div>

            <div className="space-y-2 max-h-[500px] overflow-y-auto pr-1">
                {quotes.length === 0 && (
                    <div className="text-gray-400 text-sm">å°šç„¡å ±åƒ¹å–®</div>
                )}

                {quotes.map(q => (
                    <div
                        key={q.id}
                        className={`p-2 border rounded cursor-pointer flex justify-between items-center ${
                            q.id === activeId
                                ? "bg-blue-50 border-blue-500"
                                : "bg-white hover:bg-gray-50"
                        }`}
                        onClick={() => setActiveId(q.id)}
                    >
                        <div className="text-sm">
                            <div className="font-bold">{q.title}</div>
                            <div className="text-gray-500 text-xs">{q.quoteNo}</div>
                        </div>

                        <div className="flex gap-2">
                            <button
                                className="text-xs text-blue-600 hover:underline"
                                onClick={e => {
                                    e.stopPropagation();
                                    copyQuote(q.id);
                                }}
                            >
                                è¤‡è£½
                            </button>

                            <button
                                className="text-xs text-red-600 hover:underline"
                                onClick={e => {
                                    e.stopPropagation();
                                    if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) deleteQuote(q.id);
                                }}
                            >
                                åˆªé™¤
                            </button>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
}
/***********************************************************
 * å ±åƒ¹é …ç›®ç·¨è¼¯å™¨ï¼ˆå« GoogleSheet è‡ªå‹•å¸¶è³‡æ–™ + åœ–ç‰‡ï¼‰
 ***********************************************************/

function QuoteItem({ item, index, updateItem, deleteItem, specList }) {
    const [show, setShow] = React.useState(true);
    const [query, setQuery] = React.useState(item.name || "");
    const [filtered, setFiltered] = React.useState([]);
    const [showDropdown, setShowDropdown] = React.useState(false);

    /* é—œéµå­—æœå°‹ Google Sheet */
    React.useEffect(() => {
        if (!query || query.trim() === "") {
            setFiltered([]);
            return;
        }
        const q = query.trim().toLowerCase();

        const f = specList.filter(x =>
            x.name.toLowerCase().includes(q)
        );

        setFiltered(f.slice(0, 20)); // æœ€å¤šé¡¯ç¤º 20 ç­†
    }, [query, specList]);

    /* é»æ“Šæœå°‹çµæœï¼ˆè‡ªå‹•å¸¶è³‡æ–™ï¼‰ */
    const applySpec = (sp) => {
        const mergedMat = mergeMaterials(sp.mat1, sp.mat2, sp.mat3);

        updateItem({
            name: sp.name,
            unit: sp.unit,
            price: sp.price,
            originalSpec: sp.originalSpec,
            specMain: sp.originalSpec, // å¯è¢«è¦†è“‹
            specMaterial: mergedMat,   // ç”¨æ–™æ˜ç´°åˆä½µå¾Œ
        });

        setQuery(sp.name);
        setShowDropdown(false);
    };

    /* æ–°å¢è£œå……åœ–ç‰‡ */
    const addPicture = () => {
        const pics = item.pictures || [];
        const newList = [...pics, { id: uuid(), url: "" }];
        updateItem({ pictures: newList });
    };

    /* æ›´æ–°åœ–ç‰‡ç¶²å€ */
    const updatePicture = (id, url) => {
        const pics = item.pictures || [];
        const newList = pics.map(p => p.id === id ? { ...p, url } : p);
        updateItem({ pictures: newList });
    };

    /* åˆªé™¤åœ–ç‰‡ */
    const deletePicture = (id) => {
        const pics = item.pictures || [];
        const newList = pics.filter(p => p.id !== id);
        updateItem({ pictures: newList });
    };

    return (
        <div className="mb-4 border p-3 rounded bg-white shadow-sm">

            {/* é …æ¬¡ + åˆªé™¤æŒ‰éˆ• */}
            <div className="flex justify-between items-center mb-2">
                <div className="font-bold text-lg">é …æ¬¡ {index + 1}</div>

                <div className="flex gap-2">
                    <button
                        className="text-xs border px-2 py-1 rounded"
                        onClick={() => setShow(!show)}
                    >
                        {show ? "æ”¶åˆ" : "å±•é–‹"}
                    </button>

                    <button
                        className="text-xs bg-red-500 text-white px-2 py-1 rounded"
                        onClick={() => deleteItem(item.id)}
                    >
                        åˆªé™¤
                    </button>
                </div>
            </div>

            {/* å…§å®¹å€ */}
            {show && (
                <div className="space-y-4">

                    {/* å“å + è‡ªå‹•å®Œæˆ */}
                    <div className="relative">
                        <label className="text-sm font-semibold">å“åï¼ˆè‡ªå‹•å¸¶è³‡æ–™ï¼‰</label>
                        <input
                            type="text"
                            value={query}
                            onChange={e => {
                                setQuery(e.target.value);
                                updateItem({ name: e.target.value });
                                setShowDropdown(true);
                            }}
                            onFocus={() => setShowDropdown(true)}
                            className="w-full border p-2 rounded"
                        />

                        {showDropdown && filtered.length > 0 && (
                            <div className="absolute z-20 bg-white border w-full max-h-60 overflow-y-auto rounded shadow">
                                {filtered.map((sp, i) => (
                                    <div
                                        key={i}
                                        className="px-3 py-2 hover:bg-blue-100 cursor-pointer text-sm"
                                        onClick={() => applySpec(sp)}
                                    >
                                        {sp.name}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* åœ–ç‰‡å€ */}
                    <div>
                        <div className="flex justify-between items-center mb-1">
                            <label className="text-sm font-semibold">å“ååœ–ç‰‡</label>
                            <button
                                onClick={addPicture}
                                className="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300"
                            >
                                + æ–°å¢åœ–ç‰‡
                            </button>
                        </div>

                        <div className="space-y-2">
                            {(item.pictures || []).map(pic => (
                                <div key={pic.id} className="flex items-center gap-2">
                                    <input
                                        type="text"
                                        className="flex-grow border p-1 rounded"
                                        placeholder="åœ–ç‰‡ç¶²å€"
                                        value={pic.url}
                                        onChange={e => updatePicture(pic.id, e.target.value)}
                                    />
                                    <button
                                        onClick={() => deletePicture(pic.id)}
                                        className="text-red-500 text-xs"
                                    >
                                        ç§»é™¤
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* è¦æ ¼ */}
                    <div>
                        <label className="text-sm font-semibold">è¦æ ¼ï¼ˆå¯è¦†è“‹ï¼‰</label>
                        <textarea
                            className="w-full border p-2 rounded"
                            rows={2}
                            value={item.specMain || ""}
                            onChange={e => updateItem({ specMain: e.target.value })}
                        />
                        <div className="text-xs text-gray-500 mt-1">
                            åŸå§‹è¦æ ¼ï¼š{item.originalSpec || "ï¼ˆç„¡ï¼‰"}
                        </div>
                    </div>

                    {/* ç”¨æ–™ï¼ˆå·²åˆä½µï¼‰ */}
                    <div>
                        <label className="text-sm font-semibold">ç”¨æ–™æ˜ç´°ï¼ˆå¯ç·¨è¼¯ï¼‰</label>
                        <textarea
                            className="w-full border p-2 rounded"
                            rows={2}
                            value={item.specMaterial || ""}
                            onChange={e => updateItem({ specMaterial: e.target.value })}
                        />
                    </div>

                    {/* å–®ä½ã€æ•¸é‡ã€å–®åƒ¹ã€å°è¨ˆ */}
                    <div className="grid grid-cols-4 gap-4">
                        <div>
                            <label className="text-sm">å–®ä½</label>
                            <input
                                className="w-full border p-2 rounded"
                                value={item.unit || ""}
                                onChange={e => updateItem({ unit: e.target.value })}
                            />
                        </div>

                        <div>
                            <label className="text-sm">æ•¸é‡</label>
                            <input
                                type="number"
                                className="w-full border p-2 rounded"
                                value={item.qty || 0}
                                onChange={e => updateItem({ qty: Number(e.target.value) })}
                            />
                        </div>

                        <div>
                            <label className="text-sm">å–®åƒ¹</label>
                            <input
                                type="number"
                                className="w-full border p-2 rounded"
                                value={item.price || 0}
                                onChange={e => updateItem({ price: Number(e.target.value) })}
                            />
                        </div>

                        <div>
                            <label className="text-sm">å°è¨ˆ</label>
                            <div className="w-full border p-2 rounded bg-gray-100 text-right">
                                {formatMoney(calcAmount(item))}
                            </div>
                        </div>
                    </div>

                    {/* å‚™è¨» */}
                    <div>
                        <label className="text-sm font-semibold">å‚™è¨»</label>
                        <textarea
                            className="w-full border p-2 rounded"
                            rows={2}
                            value={item.remarks || ""}
                            onChange={e => updateItem({ remarks: e.target.value })}
                        />
                    </div>
                </div>
            )}
        </div>
    );
}
/***********************************************************
 * åˆ—å°ç‰ˆ PrintLayoutï¼ˆA4 ç‰ˆé¢ + åœ–ç‰‡ï¼‰
 ***********************************************************/

function PrintLayout({ quote }) {

    if (!quote) return null;

    const companyData = COMPANY_DATA[quote.company];
    const total = calcTotal(quote.items);

    return (
        <div className="p-6 text-black text-[12px] leading-relaxed">

            {/* =============== æ¨™é¡Œå€ =============== */}
            <div className="text-center mb-4">
                <div className="text-2xl font-bold">{companyData.name}</div>
                <div className="text-xl font-bold mt-1">å·¥ç¨‹å ±åƒ¹å–®</div>
            </div>

            {/* =============== å®¢æˆ¶è³‡è¨Šå€å¡Š =============== */}
            <div className="grid grid-cols-2 gap-4 mb-4 text-sm">
                <div>
                    <div>å®¢æˆ¶åç¨±ï¼š{quote.customer}</div>
                    <div>é€£çµ¡äººï¼š{quote.contact}</div>
                    <div>é€£çµ¡é›»è©±ï¼š{quote.phone}</div>
                </div>
                <div>
                    <div>å·¥ç¨‹åç¨±ï¼š{quote.title}</div>
                    <div>å®‰è£åœ°é»ï¼š{quote.location}</div>
                    <div>å ±åƒ¹æ—¥æœŸï¼š{quote.date}</div>
                    <div>å ±åƒ¹å–®è™Ÿï¼š{quote.quoteNo}</div>
                </div>
            </div>

            {/* =============== è¡¨æ ¼ =============== */}
            <table className="w-full text-sm mb-4">
                <thead>
                    <tr className="font-bold text-center">
                        <th className="w-10">é …æ¬¡</th>
                        <th className="w-52">å“åï¼ˆå«åœ–ç‰‡ï¼‰</th>
                        <th className="w-64">è¦æ ¼ / ç”¨æ–™æ˜ç´°</th>
                        <th className="w-10">å–®ä½</th>
                        <th className="w-10">æ•¸é‡</th>
                        <th className="w-16">å–®åƒ¹</th>
                        <th className="w-20">å°è¨ˆ</th>
                        <th className="w-32">å‚™è¨»</th>
                    </tr>
                </thead>

                <tbody>
                    {quote.items.map((it, idx) => (
                        <tr key={it.id} className="align-top">
                            {/* é …æ¬¡ */}
                            <td className="text-center">{idx + 1}</td>

                            {/* å“å + åœ–ç‰‡ */}
                            <td>
                                <div className="font-bold mb-1">{it.name}</div>

                                {(it.pictures || []).map((pic) =>
                                    pic.url ? (
                                        <img
                                            key={pic.id}
                                            src={pic.url}
                                            alt="pic"
                                            style={{
                                                width: "120px",
                                                marginBottom: "4px"
                                            }}
                                        />
                                    ) : null
                                )}
                            </td>

                            {/* è¦æ ¼ + ç”¨æ–™æ˜ç´° */}
                            <td>
                                {it.specMain}
                                <br />
                                {it.specMaterial && (
                                    <span className="text-gray-700">
                                        {it.specMaterial}
                                    </span>
                                )}
                            </td>

                            {/* å–®ä½ / æ•¸é‡ / å–®åƒ¹ / å°è¨ˆ */}
                            <td className="text-center">{it.unit}</td>
                            <td className="text-center">{it.qty}</td>
                            <td className="text-right">{formatMoney(it.price)}</td>
                            <td className="text-right">{formatMoney(calcAmount(it))}</td>

                            {/* å‚™è¨» */}
                            <td>{it.remarks}</td>
                        </tr>
                    ))}

                    {/* =============== åˆè¨ˆ =============== */}
                    <tr className="font-bold">
                        <td colSpan="6" className="text-right pr-2">ç¸½è¨ˆï¼š</td>
                        <td className="text-right">{formatMoney(total)}</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>

            {/* =============== å‚™è¨» + ä»˜æ¬¾æ¢ä»¶ =============== */}
            <div className="grid grid-cols-2 gap-6 mb-6">
                <div>
                    <div className="font-bold mb-1">å‚™è¨»ï¼š</div>
                    <div className="whitespace-pre-line">{quote.notes}</div>
                </div>

                <div>
                    <div className="font-bold mb-1">ä»˜æ¬¾æ¢ä»¶ï¼š</div>
                    <div className="whitespace-pre-line">{quote.payment}</div>
                </div>
            </div>

            {/* =============== è“‹ç«  & ç°½åå€ =============== */}
            <div className="grid grid-cols-2 mt-8">
                <div className="text-center">
                    <div className="font-bold mb-2">å…¬å¸è“‹ç« </div>
                    <img
                        src={companyData.stamp}
                        alt="stamp"
                        style={{ width: "140px", opacity: 0.95 }}
                    />
                </div>

                <div className="text-center">
                    <div className="font-bold mb-2">å®¢æˆ¶ç°½å</div>
                    <div style={{
                        width: "200px",
                        height: "100px",
                        border: "1px solid black",
                        margin: "0 auto"
                    }}></div>
                </div>
            </div>
        </div>
    );
}
/***********************************************************
 * åŒ¯å‡º Excel
 ***********************************************************/
function exportExcel(quote) {
    if (!quote) {
        alert("å°šæœªé¸æ“‡å ±åƒ¹å–®");
        return;
    }

    const wb = XLSX.utils.book_new();

    // è¡¨æ ¼è³‡æ–™
    const wsData = [
        ["é …æ¬¡", "å“å", "è¦æ ¼", "ç”¨æ–™æ˜ç´°", "å–®ä½", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ", "å‚™è¨»"]
    ];

    quote.items.forEach((it, idx) => {
        wsData.push([
            idx + 1,
            it.name || "",
            it.specMain || "",
            it.specMaterial || "",
            it.unit || "",
            it.qty || 0,
            it.price || 0,
            calcAmount(it),
            it.remarks || ""
        ]);
    });

    wsData.push([]);
    wsData.push(["", "", "", "", "", "", "ç¸½è¨ˆ", calcTotal(quote.items)]);

    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹æ˜ç´°");

    XLSX.writeFile(wb, `${quote.quoteNo}.xlsx`);
}

/***********************************************************
 * åˆ—å°åŠŸèƒ½
 ***********************************************************/
function printQuote(quote) {
    if (!quote) {
        alert("å°šæœªé¸æ“‡å ±åƒ¹å–®");
        return;
    }

    const printArea = document.getElementById("printArea");
    ReactDOM.render(<PrintLayout quote={quote} />, printArea);

    setTimeout(() => {
        window.print();
    }, 200);
}

/***********************************************************
 * ä¸»ç•«é¢ï¼šå³å´ç·¨è¼¯å™¨
 ***********************************************************/
function QuoteEditor() {
    const { activeQuote, updateQuote, specList } = React.useContext(AppContext);

    if (!activeQuote) {
        return (
            <div className="text-gray-400 text-lg">
                è«‹å…ˆæ–°å¢æˆ–é¸æ“‡å·¦å´çš„å ±åƒ¹å–®
            </div>
        );
    }

    const update = (data) => updateQuote(activeQuote.id, data);

    /* æ–°å¢é …ç›® */
    const addItem = () => {
        const newItem = {
            id: uuid(),
            name: "",
            unit: "",
            qty: 1,
            price: 0,
            specMain: "",
            originalSpec: "",
            specMaterial: "",
            remarks: "",
            pictures: []
        };

        update({
            items: [...activeQuote.items, newItem]
        });
    };

    /* ä¿®æ”¹å–®ä¸€é …ç›® */
    const updateItem = (id, data) => {
        const newList = activeQuote.items.map(it =>
            it.id === id ? { ...it, ...data } : it
        );
        update({ items: newList });
    };

    /* åˆªé™¤é …ç›® */
    const deleteItem = (id) => {
        const list = activeQuote.items.filter(it => it.id !== id);
        update({ items: list });
    };

    const total = calcTotal(activeQuote.items);

    return (
        <div className="space-y-4">

            {/* =============== åŸºæœ¬è³‡æ–™ =============== */}
            <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="text-sm">å·¥ç¨‹åç¨±</label>
                    <input
                        className="w-full border p-2 rounded"
                        value={activeQuote.title}
                        onChange={e => update({ title: e.target.value })}
                    />
                </div>

                <div>
                    <label className="text-sm">å®¢æˆ¶åç¨±</label>
                    <input
                        className="w-full border p-2 rounded"
                        value={activeQuote.customer}
                        onChange={e => update({ customer: e.target.value })}
                    />
                </div>

                <div>
                    <label className="text-sm">è¯çµ¡äºº</label>
                    <input
                        className="w-full border p-2 rounded"
                        value={activeQuote.contact}
                        onChange={e => update({ contact: e.target.value })}
                    />
                </div>

                <div>
                    <label className="text-sm">è¯çµ¡é›»è©±</label>
                    <input
                        className="w-full border p-2 rounded"
                        value={activeQuote.phone}
                        onChange={e => update({ phone: e.target.value })}
                    />
                </div>

                <div>
                    <label className="text-sm">å®‰è£åœ°é»</label>
                    <input
                        className="w-full border p-2 rounded"
                        value={activeQuote.location}
                        onChange={e => update({ location: e.target.value })}
                    />
                </div>
            </div>

            {/* =============== æ§åˆ¶æŒ‰éˆ• =============== */}
            <div className="flex gap-3 my-2">
                <button
                    className="bg-blue-600 text-white px-4 py-2 rounded"
                    onClick={() => printQuote(activeQuote)}
                >
                    åˆ—å° / PDF
                </button>

                <button
                    className="bg-green-600 text-white px-4 py-2 rounded"
                    onClick={() => exportExcel(activeQuote)}
                >
                    åŒ¯å‡º Excel
                </button>

                <button
                    className="bg-gray-700 text-white px-4 py-2 rounded"
                    onClick={addItem}
                >
                    + æ–°å¢é …ç›®
                </button>
            </div>

            {/* =============== é …ç›®ç·¨è¼¯å™¨ =============== */}
            <div>
                {activeQuote.items.map((it, idx) => (
                    <QuoteItem
                        key={it.id}
                        item={it}
                        index={idx}
                        specList={specList}
                        updateItem={(data) => updateItem(it.id, data)}
                        deleteItem={deleteItem}
                    />
                ))}
            </div>

            {/* =============== åˆè¨ˆ =============== */}
            <div className="text-right text-lg font-bold">
                åˆè¨ˆï¼š{formatMoney(total)}
            </div>

            {/* =============== å‚™è¨» & ä»˜æ¬¾æ¢ä»¶ =============== */}
            <div className="grid grid-cols-2 gap-6 mt-4">
                <div>
                    <label className="text-sm font-semibold">å‚™è¨»</label>
                    <textarea
                        className="w-full border p-2 rounded h-32"
                        value={activeQuote.notes}
                        onChange={e => update({ notes: e.target.value })}
                    />
                </div>

                <div>
                    <label className="text-sm font-semibold">ä»˜æ¬¾æ¢ä»¶</label>
                    <textarea
                        className="w-full border p-2 rounded h-32"
                        value={activeQuote.payment}
                        onChange={e => update({ payment: e.target.value })}
                    />
                </div>
            </div>
        </div>
    );
}


/***********************************************************
 * ä¸» App
 ***********************************************************/
function App() {
    return (
        <AppProvider>
            <div className="flex h-screen">
                {/* å·¦å´ Panel */}
                <div className="w-72 border-r p-4 bg-gray-50 overflow-y-auto">
                    <CompanySelector />
                    <QuoteList />
                </div>

                {/* å³å´ ç·¨è¼¯å™¨ */}
                <div className="flex-1 p-6 overflow-y-auto">
                    <QuoteEditor />
                </div>
            </div>
        </AppProvider>
    );
}

/***********************************************************
 * ReactDOM Render
 ***********************************************************/
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
<!-- ğŸ”¹ åˆ—å°å°ˆç”¨éš±è—å€å¡Š -->
<div id="printArea" style="display:none;"></div>

</script>

</body>
</html>
