<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰- V10</title>

    <script src="https://unpkg.com/react-dom@18/umd/react-dom-server.browser.development.js"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
    body {
        background: #f3ff6;
        font-family: "Microsoft JhengHei", sans-serif;
    }
    
    /* ä¿®æ­£åˆ—å°å•é¡Œï¼šæŒ‡å®šåˆ—å°å€åŸŸçš„ ID */
    @media print {

        /* éš±è—éåˆ—å°å…ƒç´  */
        .no-print {
            display: none !important;
        }
        
        /* éš±è—ä¸»ç·¨è¼¯å€ï¼Œåªé¡¯ç¤ºé è¦½å€ */
        #root {
            display: none !important; 
        }

        /* åˆ—å°é è¦½å€åŸŸï¼šç¢ºä¿å…§å®¹æ­£ç¢ºå‘ˆç¾ */
        #quotePreviewArea {
            display: block !important;
            margin: 0;
            padding: 12mm;
            font-size: 13px; /* åˆ—å°å­—é«”ç•¥å° */
            color: black;
            width: 210mm; /* A4 å¯¬åº¦ */
            box-sizing: border-box;
            background: white; /* ç¢ºä¿èƒŒæ™¯æ˜¯ç™½è‰² */
            min-height: 297mm; /* ç¢ºä¿è‡³å°‘ä¸€é é«˜åº¦ */
        }
        
        /* æ¨™é¡Œ - å…¬å¸åç¨±ç½®ä¸­ */
        .print-header h1 {
            font-size: 24px;
            font-weight: bold;
            text-align: center; 
        }

        /* å®¢æˆ¶/å…¬å¸è³‡è¨Šè¡¨æ ¼ */
        .print-info-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid black;
            margin-bottom: 10px;
        }
        .print-info-table td {
            border: 1px solid black;
            padding: 4px 8px;
            vertical-align: middle;
        }
        .print-info-label {
            width: 15%;
            background: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }

        /* å ±åƒ¹é …ç›®è¡¨æ ¼ */
        table.print-items-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 13px;
            table-layout: fixed; /* å›ºå®šåˆ—å¯¬ */
            border: 2px solid black;
        }

        .print-items-table th, .print-items-table td {
            border: 1px solid black;
            padding: 4px 6px;
            vertical-align: top;
            line-height: 1.4;
            height: auto; 
            white-space: normal; /* ç¢ºä¿æ–‡å­—æ›è¡Œ */
        }

        .print-items-table th {
            background-color: #e0e0e0;
            text-align: center;
        }
        
        /* æ•¸é‡, å–®åƒ¹, é‡‘é¡ é å³å°é½Š */
        .print-items-table td:nth-child(4), /* æ•¸é‡ */
        .print-items-table td:nth-child(5), /* å–®åƒ¹ */
        .print-items-table td:nth-child(7) { /* é‡‘é¡ */
            text-align: right;
        }
        
        /* è¡¨æ ¼åˆ†é æ§åˆ¶ */
        thead {
            display: table-header-group; 
        }
        
        tr {
            page-break-inside: avoid; /* é˜²æ­¢è¡Œè¢«æˆªæ–· */
        }
        
        /* ç¸½è¨ˆå€å¡Š */
        .print-total-box {
            border: 1px solid black;
            padding: 10px;
            font-size: 14px;
            margin-top: 10px;
        }

        /* åœ–ç‰‡åˆ—å°æ¨£å¼ */
        .print-image {
            max-width: 150px; /* é™åˆ¶åˆ—å°åœ–ç‰‡å¤§å° */
            height: auto;
            margin-top: 5px;
            display: block;
        }

        /* å‚™è¨»/ä»˜æ¬¾æ¢ä»¶å€å¡Š */
        .print-notes-box {
            margin-top: 15px;
            border: 1px solid black;
            padding: 10px;
            white-space: pre-wrap; /* ä¿æŒæ›è¡Œ */
        }
    }
    </style>
</head>

<body class="text-gray-900">

    <div id="root"></div>
    
    <div id="quotePreviewArea" class="hidden">
        {/* PrintLayout Component å°‡æœƒåœ¨é€™è£¡è¢«æ¸²æŸ“ï¼Œç„¶å¾Œåˆ—å° */}
    </div>

<script type="text/babel">
// P1 â€” å…¬å¸è³‡æ–™ / ä»˜æ¬¾æ¢ä»¶ / å‚™è¨» / æ¨¡å¼æ¨¡æ¿
const COMPANY_DATA = {
    // å…¬å¸åœ°å€
    herhsin: {
        name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
        tel: "07-6517476",
        fax: "07-6517994",
        email: "admin@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "herhsin_stamp_placeholder.png", 
        prefix: "QH" 
    },
    sinchang: {
        name: "è–ªæ˜Œæœ‰é™å…¬å¸",
        tel: "07-6521927",
        fax: "07-6517994",
        email: "affairs@herhsin.com",
        address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
        stamp: "sinchang_stamp_placeholder.png", 
        prefix: "QS" 
    }
};

// é è¨­å‚™è¨»
const DEFAULT_NOTES = `1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚`;

// é è¨­ä»˜æ¬¾æ¢ä»¶
const DEFAULT_PAYMENT = `è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%`;

// å ±åƒ¹æ¨¡å¼æ¨¡æ¿
const QUOTE_MODES = [
    {
        id: "modeA",
        name: "æ‹Œåˆæ©Ÿæ¼æ¼¿æ›´æ›",
        description: "é©ç”¨æ‹Œåˆæ©Ÿç¶­ä¿®ã€æ¼æ¼¿è™•ç†ç­‰ã€‚",
        defaultItems: [],
        defaultNotes: DEFAULT_NOTES,
        defaultPayment: DEFAULT_PAYMENT
    },
    {
        id: "modeB",
        name: "è¨­å‚™éŠ·å”®",
        description: "é©ç”¨å‚™å“ã€å–®æ©ŸéŠ·å”®èˆ‡å®‰è£ã€‚",
        defaultItems: [],
        defaultNotes: DEFAULT_NOTES,
        defaultPayment: DEFAULT_PAYMENT
    },
    {
        id: "modeC",
        name: "è¨­å‚™æ›´æ›å·¥ç¨‹",
        description: "é©ç”¨æ•´æ©Ÿæ›´æ–°ã€æ–™ä»¶æ›´æ›å·¥ç¨‹ã€‚",
        defaultItems: [],
        defaultNotes: DEFAULT_NOTES,
        defaultPayment: DEFAULT_PAYMENT
    }
];

// P2 â€” å·¥å…·å‡½å¼ï¼ˆå®Œæ•´ï¼‰
function uuid() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}

function formatDate(dateStr = new Date()) {
    const d = dateStr instanceof Date ? dateStr : new Date(dateStr);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`; // æ”¹ç‚º ISO æ ¼å¼ä»¥åˆ© input type="date"
}

function formatMoney(num) {
    // è™•ç†ç©ºå€¼å’Œéæ•¸å­—ï¼Œä½†å…è¨±æ•¸å­— 0
    if (num === "" || num === null || num === undefined || isNaN(Number(num))) return "";
    return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 });
}

function calcAmount(item) {
    // ç¢ºä¿ qty å’Œ price è½‰ç‚ºæ•¸å­—ï¼Œå¦å‰‡ç‚º 0
    const qty = Number(item.qty || 0);
    const price = Number(item.price || 0);
    return qty * price;
}

function calcTotal(items) {
    return items.reduce((sum, it) => {
        let mainAmt = calcAmount(it);
        let subs = 0;

        if (it.subItems && it.subItems.length > 0) {
            // è¨ˆç®—æ‰€æœ‰ item é¡å‹çš„ subItem çš„é‡‘é¡
            subs = it.subItems.reduce((s, sub) => (sub.type === 'item' ? s + calcAmount(sub) : s), 0);
        }

        return sum + mainAmt + subs;
    }, 0);
}

function calcNegotiated(total, discountPercent, customPrice) {
    const cp = Number(customPrice || 0);
    const dp = Number(discountPercent || 0);
    
    if (cp > 0) return cp;
    
    if (dp > 0 && dp < 100) {
        return Math.round(total * (1 - dp / 100));
    }
    return total;
}

// å ±åƒ¹å–®ç·¨è™Ÿ
function generateQuoteNo(companyKey) {
    const prefix = COMPANY_DATA[companyKey]?.prefix || "Q"; 
    
    // ä½¿ç”¨ YYYYMMDDHHMM + 4ä½äº‚æ•¸
    const d = new Date();
    const parts = [
        d.getFullYear(),
        String(d.getMonth() + 1).padStart(2, "0"),
        String(d.getDate()).padStart(2, "0"),
        String(d.getHours()).padStart(2, "0"),
        String(d.getMinutes()).padStart(2, "0"),
    ].join('');
    
    const random = Math.floor(1000 + Math.random() * 9000);
    
    return `${prefix}${parts}-${random}`; 
}

// è¼‰å…¥ Google Sheet CSV (éåŒæ­¥å‡½å¼)
async function loadCSV(url) {
    try {
        const res = await fetch(url);
        const text = await res.text();
        
        // å‡è¨­ç¬¬ä¸€è¡Œç‚ºæ¨™é ­
        const rows = text.split("\n").map(r => r.trim()).filter(r => r.length > 0);
        if (rows.length < 2) return [];
        
        // ç¢ºä¿æ¨™é ­ä¸åŒ…å«é›™å¼•è™Ÿ
        const header = rows[0].split(",").map(h => h.trim().replace(/"/g, ''));

        return rows.slice(1).map(row => {
            // ä½¿ç”¨æ­£è¦è¡¨é”å¼è™•ç† CSV å…§åµŒé€—è™Ÿå’Œå¼•è™Ÿ
            const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
            const obj = {};

            header.forEach((h, i) => {
                let value = cols[i] ? cols[i].trim() : "";
                // ç§»é™¤å‰å¾Œå¼•è™Ÿ
                if (value.startsWith('"') && value.endsWith('"')) {
                    value = value.substring(1, value.length - 1);
                }
                obj[h] = value;
            });
            return obj;
        });
    } catch (error) {
        console.error("è¼‰å…¥æˆ–è§£æ Google Sheet CSV å¤±æ•—:", error);
        return [];
    }
}


// P3 â€” AppContextï¼ˆæ ¸å¿ƒè³‡æ–™ä¸­å¿ƒï¼‰
const AppContext = React.createContext();

function AppProvider({ children }) {
    // å…¬å¸ herhsin / sinchang
    const [company, setCompany] = React.useState("herhsin");

    // å ±åƒ¹å–®åˆ—è¡¨
    const [quotes, setQuotes] = React.useState([]);

    // æ­£åœ¨ç·¨è¼¯çš„å ±åƒ¹å–® ID
    const [activeQuoteId, setActiveQuoteId] = React.useState(null);

    // è¦æ ¼å“ï¼ˆä¾†è‡ª Google Sheetï¼‰
    const [specItems, setSpecItems] = React.useState([]);

    // Google Sheet è·¯å¾‘ (è«‹å‹™å¿…å°‡æ­¤æ›¿æ›ç‚ºæ‚¨çš„å…¬é–‹ CSV é€£çµ)
    const SPEC_CSV_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=0&single=true&output=csv"; 
        

    //************* åˆå§‹åŒ–ï¼šå¾ localStorage è¼‰å…¥ *************/
    React.useEffect(() => {
        const saved = localStorage.getItem("HERHSIN_QUOTES");

        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                // ç¢ºä¿è¼‰å…¥çš„æ˜¯é™£åˆ—
                if (Array.isArray(parsed)) {
                    setQuotes(parsed);
                    if (parsed.length > 0) setActiveQuoteId(parsed[0].id);
                }
            } catch (e) {
                console.error("è§£æ localStorage æ•¸æ“šå¤±æ•—:", e);
                setQuotes([]);
                setActiveQuoteId(null);
            }
        }
    }, []);

    //************* è‡ªå‹•å­˜å› localStorage *************/
    React.useEffect(() => {
        try {
            localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
        } catch (e) {
            console.error("å¯«å…¥ localStorage å¤±æ•—:", e);
        }
    }, [quotes]);


    //************* è¼‰å…¥ Google Sheet è¦æ ¼å“ *************/
    const loadSpecItems = React.useCallback(() => {
        loadCSV(SPEC_CSV_URL).then(data => setSpecItems(data));
    }, [SPEC_CSV_URL]);

    React.useEffect(() => {
        // ç¶²é ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚åŸ·è¡Œ
        loadSpecItems();
    }, [loadSpecItems]);


    // å»ºç«‹æ–°å ±åƒ¹å–®ï¼ˆå¯å¥—ç”¨æ¨¡å¼ï¼‰
    const createQuote = React.useCallback((modeId = null) => {
        const mode = QUOTE_MODES.find(m => m.id === modeId);

        // åœ¨å»ºç«‹å ±åƒ¹å–®æ™‚ï¼Œæ ¹æ“šç•¶å‰é¸å®šçš„ company ç”¢ç”Ÿç·¨è™Ÿ
        const newQuote = {
            id: uuid(),
            quoteNo: generateQuoteNo(company), 
            title: mode ? mode.name : "æœªå‘½åå·¥ç¨‹",
            customerName: "",
            contact: "",
            phone: "",
            location: "",
            date: formatDate(), 
            items: mode && Array.isArray(mode.defaultItems) ? mode.defaultItems.map(item => ({
                ...item, 
                id: uuid(), 
                subItems: [],
                // é …ç›®è¦æ ¼æ¬„ä½
                specMain: "", // è¦æ ¼ (ä¸»æè¿°)
                specMaterial: "", // ç”¨æ–™æ˜ç´° (ç”¨æ–™1/2/3 åˆä½µ)
                remarks: "" // å‚™è¨»
            })) : [],
            notes: mode ? mode.defaultNotes : DEFAULT_NOTES,
            payment: mode ? mode.defaultPayment : DEFAULT_PAYMENT,
            discountPercent: 0,
            negotiatedPrice: 0
        };

        setQuotes(prev => {
            const newList = [newQuote, ...prev]; // æ–°å ±åƒ¹å–®æ”¾åœ¨æœ€å‰é¢
            setActiveQuoteId(newQuote.id);
            return newList;
        });
    }, [company]);


    // åˆªé™¤å ±åƒ¹å–®
    const deleteQuote = React.useCallback((id) => {
        setQuotes(prev => {
            const newList = prev.filter(q => q.id !== id);
            
            if (id === activeQuoteId) {
                setActiveQuoteId(newList.length > 0 ? newList[0].id : null);
            }
            return newList;
        });
    }, [activeQuoteId]);


    // æ›´æ–°å ±åƒ¹å–®æ¬„ä½
    const updateQuote = React.useCallback((id, data) => {
        setQuotes(prev =>
            prev.map(q => (q.id === id ? { ...q, ...data } : q))
        );
    }, []);


    // å¥—ç”¨æ¨¡å¼ï¼ˆè¦†è“‹ï¼šæ¨™é¡Œã€å‚™è¨»ã€ä»˜æ¬¾ã€é è¨­é …ç›®ï¼‰
    const applyMode = React.useCallback((modeId) => {
        const mode = QUOTE_MODES.find(m => m.id === modeId);
        if (!mode || !activeQuoteId) return;

        // ç¢ºä¿ defaultItems ä¸­çš„æ¯å€‹ item éƒ½æœ‰å”¯ä¸€çš„ id
        const itemsWithIds = mode.defaultItems.map(item => ({
            ...item, 
            id: uuid(), 
            subItems: [],
            // åˆå§‹åŒ–è¦æ ¼æ¬„ä½
            specMain: "", 
            specMaterial: "", 
            remarks: ""
        }));

        updateQuote(activeQuoteId, {
            title: mode.name,
            items: itemsWithIds, 
            notes: mode.defaultNotes,
            payment: mode.defaultPayment,
        });
    }, [activeQuoteId, updateQuote]);


    // Context æä¾›çµ¦å…¨ App
    const activeQuote = quotes.find(q => q.id === activeQuoteId);
    
    const value = {
        company,
        setCompany,

        quotes,
        createQuote,
        deleteQuote,
        updateQuote,
        activeQuote, 
        activeQuoteId,
        setActiveQuoteId,

        specItems,
        loadSpecItems, 
        applyMode
    };

    // è®“åˆ—å°å’Œ Excel åŒ¯å‡ºåŠŸèƒ½å¯ä»¥å…¨åŸŸæŠ“åˆ° Context
    window.__APP_CONTEXT__ = value;

    return (
        <AppContext.Provider value={value}>
            {children}
        </AppContext.Provider>
    );
}
// P4-1 â€” å·¦å´å…ƒä»¶ï¼šå…¬å¸åˆ‡æ› / æ¨¡å¼é¸æ“‡ / å ±åƒ¹å–®åˆ—è¡¨


// --------------------------------------------------
// å…¬å¸åˆ‡æ›ï¼ˆä½•é‘« / è–ªæ˜Œï¼‰
// --------------------------------------------------
function CompanySelector() {
    const { company, setCompany } = React.useContext(AppContext);

    return (
        <div className="mb-6 no-print">
            <div className="font-bold mb-2">é¸æ“‡å…¬å¸</div>

            <div className="flex gap-2">
                <button
                    className={`px-3 py-1 rounded ${
                        company === "herhsin"
                            ? "bg-blue-600 text-white"
                            : "bg-gray-300 hover:bg-gray-400"
                    }`}
                    onClick={() => setCompany("herhsin")}
                >
                    ä½•é‘«å¯¦æ¥­
                </button>

                <button
                    className={`px-3 py-1 rounded ${
                        company === "sinchang"
                            ? "bg-blue-600 text-white"
                            : "bg-gray-300 hover:bg-gray-400"
                    }`}
                    onClick={() => setCompany("sinchang")}
                >
                    è–ªæ˜Œæœ‰é™å…¬å¸
                </button>
            </div>
        </div>
    );
}


// --------------------------------------------------
// å ±åƒ¹æ¨¡å¼é¸æ“‡å™¨
// --------------------------------------------------
function ModeSelector() {
    const { createQuote } = React.useContext(AppContext);

    return (
        <div className="mb-6 no-print">
            <div className="font-bold mb-2">å»ºç«‹å ±åƒ¹å–®ï¼ˆå¥—ç”¨æ¨¡å¼ï¼‰</div>

            <div className="flex flex-col gap-2">

                {QUOTE_MODES.map(mode => (
                    <button
                        key={mode.id}
                        className="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-left"
                        onClick={() => createQuote(mode.id)}
                    >
                        â¤ {mode.name}
                    </button>
                ))}

                {/* ç„¡æ¨¡å¼ï¼šç©ºç™½å ±åƒ¹å–® */}
                <button
                    className="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                    onClick={() => createQuote(null)}
                >
                    ï¼‹ ç©ºç™½å ±åƒ¹å–®
                </button>
            </div>
        </div>
    );
}


// --------------------------------------------------
// å ±åƒ¹å–®ç®¡ç†ï¼šåˆ—è¡¨ã€åˆ‡æ›ã€åˆªé™¤
// --------------------------------------------------
function QuoteManager() {
    const {
        quotes,
        activeQuoteId,
        setActiveQuoteId,
        deleteQuote,
        createQuote, 
    } = React.useContext(AppContext);

    // æ ¹æ“šæ—¥æœŸæ’åºï¼Œè®“æœ€æ–°çš„æ’åœ¨æœ€ä¸Šé¢
    const sortedQuotes = React.useMemo(() => {
        return [...(quotes || [])].sort((a, b) => {
            if (!a.date || !b.date) return 0;
            // æ ¹æ“šæ—¥æœŸæ’åºï¼Œæœ€æ–°æ—¥æœŸæ’å‰é¢
            if (a.date > b.date) return -1;
            if (a.date < b.date) return 1;
            return b.id.localeCompare(a.id); // æ—¥æœŸç›¸åŒå‰‡ç”¨ ID
        });
    }, [quotes]);


    return (
        <div className="mt-4 border-t pt-4"> 
            <h3 className="font-bold text-lg mb-2 text-gray-700">å ±åƒ¹å–®åˆ—è¡¨</h3>

            {/* æ–°å¢å ±åƒ¹å–®æŒ‰éˆ• (å°å‘å»ºç«‹ç©ºç™½å ±åƒ¹å–®) */}
            <button
                className="w-full px-3 py-2 bg-purple-600 text-white rounded mb-4 hover:bg-purple-700 transition"
                onClick={() => createQuote(null)} 
            >
                ï¼‹ å»ºç«‹æ–°å ±åƒ¹å–®
            </button>

            <div className="max-h-80 overflow-y-auto">
            {sortedQuotes.length === 0 && ( 
                <div className="text-gray-500 text-sm text-center">
                    å°šç„¡è³‡æ–™ï¼Œè«‹å…ˆå»ºç«‹å ±åƒ¹å–®
                </div>
            )}

            <div className="flex flex-col gap-1">
                {sortedQuotes.map(q => ( 
                    <div
                        key={q.id}
                        className={`flex items-center justify-between px-3 py-2 rounded cursor-pointer transition
                            ${
                                q.id === activeQuoteId
                                    ? "bg-blue-600 text-white shadow-md"
                                    : "bg-gray-100 hover:bg-gray-200 text-gray-800"
                            }
                        `}
                        onClick={() => setActiveQuoteId(q.id)}
                    >
                        {/* æ–‡å­—å€å¡Šï¼šåŠ å…¥ min-w-0 å…è¨±å£“ç¸®/æˆªæ–· */}
                        <div className="flex flex-col flex-1 min-w-0 mr-2"> 
                            {/* æ¨™é¡Œï¼šç¢ºä¿æˆªæ–· */}
                            <span className="font-semibold truncate text-sm">{q.title || "ç„¡æ¨™é¡Œ"}</span>
                            {/* è³‡è¨Šï¼šè¼ƒå°çš„å­—é«”ï¼Œå…è¨±æ›è¡Œ */}
                            <span className="text-xs opacity-80 whitespace-normal">
                                {q.date || "N/A"} - {q.customerName || "ç„¡å®¢æˆ¶"}
                            </span>
                        </div>

                        {/* æŒ‰éˆ•å€å¡Šï¼šåŠ å…¥ flex-shrink-0 ç¢ºä¿å¯¬åº¦å›ºå®šï¼Œä¸æ“ å£“æ–‡å­— */}
                        <button
                            className={`text-red-600 text-xs ml-2 p-1 font-bold transition flex-shrink-0 
                            ${q.id === activeQuoteId ? "bg-red-500 hover:bg-red-600 text-white" : "hover:text-red-800"}
                            `}
                            onClick={(e) => {
                                e.stopPropagation(); // é¿å…é»åˆ°çˆ¶å±¤
                                if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ä»½å ±åƒ¹å–®ï¼Ÿ")) {
                                    deleteQuote(q.id);
                                }
                            }}
                        >
                            åˆªé™¤
                        </button>
                    </div>
                ))}
            </div>
            </div>
        </div>
    );
}
// P4-2 â€” å ±åƒ¹å–®æŠ¬é ­ï¼šå…¬å¸è³‡è¨Š + å®¢æˆ¶è³‡è¨Šè¼¸å…¥å€
function QuoteEditor() {
    const {
        company,
        activeQuote, 
        updateQuote
    } = React.useContext(AppContext);

    const quote = activeQuote;

    // -------------------------------
    // æ›´æ–°æ¬„ä½
    // -------------------------------
    const update = React.useCallback((field, value) => {
        if (quote) {
            updateQuote(quote.id, { [field]: value });
        }
    }, [quote, updateQuote]); 

    if (!quote) return null;

    const info = COMPANY_DATA[company];

    return (
        <div className="bg-white p-6 shadow rounded mb-6 no-print">

            {/* ---------------- å…¬å¸åç¨± ---------------- */}
            <div className="text-2xl font-bold mb-4 text-blue-800">
                {info.name}
            </div>

            {/* ---------------- å…¬å¸è³‡æ–™ ---------------- */}
            <div className="text-sm text-gray-600 mb-6 border-b pb-4">
                <div>åœ°å€ï¼š{info.address}</div>
                <div>é›»è©±ï¼š{info.tel} | å‚³çœŸï¼š{info.fax}</div>
            </div>

            {/* ---------------- å ±åƒ¹å–®æ¨™é¡Œ & ç·¨è™Ÿ ---------------- */}
            <div className="flex items-end gap-4 mb-6">
                <div className="flex-1">
                    <label className="block text-sm text-gray-600 mb-1">å·¥ç¨‹åç¨±</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.title || ""}
                        onChange={(e) => update("title", e.target.value)}
                    />
                    
                </div>

                <div className="w-48">
                    <label className="block text-sm text-gray-600 mb-1">å ±åƒ¹å–®ç·¨è™Ÿ</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 bg-gray-100"
                        value={quote.quoteNo || ""}
                        readOnly
                    />
                </div>
            </div>

            {/* ---------------- å®¢æˆ¶è³‡è¨Š ---------------- */}
            <div className="grid grid-cols-2 gap-4 mb-6">

                <div>
                    <label className="block text-sm text-gray-600 mb-1">å®¢æˆ¶åç¨±</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.customerName || ""}
                        onChange={(e) => update("customerName", e.target.value)}
                    />
                </div>

                <div>
                    <label className="block text-sm text-gray-600 mb-1">è¯çµ¡äºº</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.contact || ""}
                        onChange={(e) => update("contact", e.target.value)}
                    />
                </div>

                <div>
                    <label className="block text-sm text-gray-600 mb-1">é›»è©±</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.phone || ""}
                        onChange={(e) => update("phone", e.target.value)}
                    />
                </div>

                <div>
                    <label className="block text-sm text-gray-600 mb-1">å ±åƒ¹æ—¥æœŸ</label>
                    <input
                        type="date"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.date || formatDate()}
                        onChange={(e) => update("date", e.target.value)}
                    />
                </div>

                <div className="col-span-2">
                    <label className="block text-sm text-gray-600 mb-1">å·¥ç¨‹åœ°é»</label>
                    <input
                        type="text"
                        className="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
                        value={quote.location || ""}
                        onChange={(e) => update("location", e.target.value)}
                    />
                </div>
            </div>
        </div>
    );
}

// P4-3ï¼ˆAï¼‰NoteSubItemBlock â€” è£œå……æ–‡å­—
function NoteSubItemBlock({ sub, updateField, deleteSubItem }) {
  return (
    <div className="border rounded p-3 bg-gray-50 mb-2">
      {/* æ¨™é¡Œ + åˆªé™¤ */}
      <div className="flex justify-between items-center mb-2">
        <span className="text-sm font-bold text-gray-700">ğŸ“„ è£œå……æ–‡å­—</span>
        <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>
          åˆªé™¤
        </button>
      </div>

      <textarea
        className="w-full border rounded p-2 text-sm focus:ring focus:ring-yellow-100"
        rows="2"
        value={sub.text || ""}
        onChange={(e) => updateField("text", e.target.value)}
        placeholder="è¼¸å…¥è£œå……èªªæ˜â€¦"
      />
    </div>
  );
}

// P4-3ï¼ˆXï¼‰SpecItemSuggest â€” è¦æ ¼å“è‡ªå‹•å»ºè­°å…ƒä»¶
function SpecItemSuggest({ currentInput, specItems, onSelect, onHide }) {
    
    // è¦æ ¼å“æ¬„ä½çµæ§‹ - **V10 ä¿®æ­£: çµ±ä¸€ä½¿ç”¨ Google Sheet æ¬„ä½åç¨±**
    const FIELD_MAIN_SPEC = 'å“é …èªªæ˜'; // ğŸ¯ ä¿®æ­£: 'è¦æ ¼' -> 'å“é …èªªæ˜'
    const FIELD_MATERIAL_1 = 'è¦æ ¼1';   // ğŸ¯ ä¿®æ­£: 'ç”¨æ–™1' -> 'è¦æ ¼1'
    const FIELD_MATERIAL_2 = 'è¦æ ¼2';   // ğŸ¯ ä¿®æ­£: 'ç”¨æ–™2' -> 'è¦æ ¼2'
    const FIELD_MATERIAL_3 = 'è¦æ ¼3';   // ğŸ¯ ä¿®æ­£: 'ç”¨æ–™3' -> 'è¦æ ¼3'
    const FIELD_REMARKS = 'å‚™è¨»';       // å‚™è¨»æ¬„ä½

    // æœå°‹çµæœ
    const filteredItems = React.useMemo(() => {
        const input = (currentInput || "").toLowerCase().trim();

        // è¼¸å…¥ 1 å€‹å­—å…ƒå³é–‹å§‹ç¯©é¸
        if (input.length < 1) return []; 

        return specItems
            .filter(item => 
                // ç¢ºä¿ 'å“å' æ¬„ä½å­˜åœ¨ï¼Œä¸”åŒ…å«è¼¸å…¥çš„é—œéµå­—
                (item['å“å'] && item['å“å'].toLowerCase().includes(input)) ||
                // æ“´å¤§ç¯©é¸ï¼š'å“é …èªªæ˜' (ä¸»æè¿°) ä¹ŸåŒ…å«é—œéµå­—
                (item[FIELD_MAIN_SPEC] && item[FIELD_MAIN_SPEC].toLowerCase().includes(input))
            );
    }, [currentInput, specItems, FIELD_MAIN_SPEC]);

    // å¦‚æœåˆ—è¡¨æ˜¯ç©ºçš„ï¼Œç›´æ¥è¿”å› null
    if (filteredItems.length === 0) return null;

    // è™•ç†é»é¸ï¼šé¸å®Œå¾Œå‘¼å« onSelect è™•ç†æ•¸æ“šï¼Œä¸¦å‘¼å« onHide éš±è—åˆ—è¡¨
    const handleSelect = (item) => {
        onSelect(item);
        onHide(); // é¸å®Œå¾Œå¼·åˆ¶éš±è—åˆ—è¡¨
    };

    return (
        <div className="absolute z-10 top-full left-0 w-full bg-white border border-gray-300 rounded shadow-lg mt-1 max-h-48 overflow-y-auto">
            {filteredItems.map((item, index) => (
                <div
                    key={index}
                    className="p-2 cursor-pointer hover:bg-blue-100 text-sm border-b last:border-b-0"
                    onMouseDown={(e) => { 
                        e.preventDefault(); // é˜²æ­¢ input å¤±å»ç„¦é»
                        handleSelect(item); 
                    }}
                >
                    {/* é¡¯ç¤º å“å, è¦æ ¼, å–®åƒ¹ï¼Œä»¥åˆ©ä½¿ç”¨è€…å€åˆ† */}
                    <div className="font-semibold text-gray-800">{item['å“å']}</div>
                    <div className="text-xs text-gray-600 truncate">
                        è¦æ ¼: {item[FIELD_MAIN_SPEC] || 'ç„¡ä¸»æè¿°'} | è¦æ ¼1: {item[FIELD_MATERIAL_1] || 'ç„¡ç”¨æ–™'} | å–®åƒ¹: {formatMoney(item['å–®åƒ¹'])}
                    </div>
                </div>
            ))}
        </div>
    );
}


// P4-3ï¼ˆBï¼‰ItemSubItemBlock â€” å­é …ç›®ï¼ˆå«æ•¸é‡/å–®åƒ¹ï¼‰
function ItemSubItemBlock({ sub, updateField, deleteSubItem }) {
    const { specItems } = React.useContext(AppContext); 
    
    // è¦æ ¼å“æ¬„ä½çµæ§‹ - **V10 ä¿®æ­£: çµ±ä¸€ä½¿ç”¨ Google Sheet æ¬„ä½åç¨±**
    const FIELD_MAIN_SPEC = 'å“é …èªªæ˜'; // ğŸ¯ ä¿®æ­£: 'è¦æ ¼' -> 'å“é …èªªæ˜'
    const FIELD_MATERIAL_1 = 'è¦æ ¼1';   // ğŸ¯ ä¿®æ­£: 'ç”¨æ–™1' -> 'è¦æ ¼1'
    const FIELD_MATERIAL_2 = 'è¦æ ¼2';   // ğŸ¯ ä¿®æ­£: 'ç”¨æ–™2' -> 'è¦æ ¼2'
    const FIELD_MATERIAL_3 = 'è¦æ ¼3';   // ğŸ¯ ä¿®æ­£: 'ç”¨æ–™3' -> 'è¦æ ¼3'
    const FIELD_REMARKS = 'å‚™è¨»';       // å‚™è¨»æ¬„ä½

    const [showSuggest, setShowSuggest] = React.useState(false); 

    // è¨ˆç®—ä¸¦æ ¼å¼åŒ–å°è¨ˆ
    const subtotal = formatMoney(calcAmount(sub));

    // è™•ç†æ•¸å­—è¼¸å…¥
    const handleNumberChange = React.useCallback((field, value) => {
        // åªå…è¨±æ•¸å­—æˆ–ç©ºå­—ä¸²
        if (value === "" || !isNaN(Number(value))) {
            updateField(field, value);
        }
    }, [updateField]);
    
    // ğŸ¯ è™•ç†è¦æ ¼å“é¸æ“‡ (ä¿®æ­£å‚™è¨»/ç”¨æ–™æ˜ç´°æ··æ·†å•é¡Œ)
    const handleSelectSpecItem = React.useCallback((spec) => {
        
        // ğŸ¯ ä¿®æ­£é» 1: ç”¨æ–™æ˜ç´° - ç¢ºä¿åªåˆä½µ 'è¦æ ¼1', 'è¦æ ¼2', 'è¦æ ¼3' ä¸”æ¿¾é™¤ç©ºå€¼
        const materialParts = [
            spec[FIELD_MATERIAL_1] || '',
            spec[FIELD_MATERIAL_2] || '',
            spec[FIELD_MATERIAL_3] || ''
        ].filter(p => p.trim() !== ''); 

        const materialSpec = materialParts.join(' / ').trim(); 

        // å¾è¦æ ¼å“æ•¸æ“šè‡ªå‹•å¡«å…¥è¦æ ¼ã€å–®ä½ã€å–®åƒ¹
        updateField("name", spec['å“å'] || sub.name);
        
        // è³‡æ–™æ‹†åˆ†ç²¾ç¢ºå°æ‡‰æ¬„ä½
        updateField("specMain", spec[FIELD_MAIN_SPEC] || ""); // ä¸»è¦æ ¼ (å“é …èªªæ˜)
        updateField("specMaterial", materialSpec); // ç”¨æ–™ 1 2 3 åˆä½µ (ç”¨æ–¼é¡¯ç¤º)
        
        // ğŸ¯ ä¿®æ­£é» 2: å‚™è¨» - ç¢ºä¿ä½¿ç”¨è¦æ ¼å“è¡¨æ ¼ä¸­çš„ 'å‚™è¨»' æ¬„ä½
        updateField("remarks", spec[FIELD_REMARKS] || ""); // å‚™è¨» (å›æ­¸å ±åƒ¹å–®å‚™è¨»æ¬„)
        
        updateField("unit", spec['å–®ä½'] || sub.unit);
        updateField("price", spec['å–®åƒ¹'] || ""); 
        setShowSuggest(false); // é¸å®Œå¾Œéš±è—åˆ—è¡¨
    }, [updateField, sub.name, sub.unit, FIELD_MAIN_SPEC, FIELD_MATERIAL_1, FIELD_MATERIAL_2, FIELD_MATERIAL_3, FIELD_REMARKS]);

    return (
        <div className="border rounded p-3 bg-gray-50 mb-2">

            {/* æ¨™é¡Œ + åˆªé™¤ */}
            <div className="flex justify-between items-center mb-2">
                <span className="text-sm font-bold text-gray-700">ğŸ“¦ å­é …ç›®</span>
                <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>
                    åˆªé™¤
                </button>
                
            </div>

            {/* ç·¨è¼¯å™¨æ¬„ä½æ’ç‰ˆ */}
            <div className="grid grid-cols-12 gap-2 text-sm items-center relative">

                {/* åç¨± (col-span-3) - **ä½¿ç”¨ SpecItemSuggest** */}
                <div className="col-span-3 relative">
                    <input
                        className="border p-1 rounded w-full focus:ring focus:ring-blue-100"
                        value={sub.name || ""}
                        placeholder="åç¨±"
                        onChange={(e) => {
                            updateField("name", e.target.value);
                            setShowSuggest(true); 
                        }}
                        onBlur={() => setTimeout(() => setShowSuggest(false), 200)} 
                        onFocus={() => (sub.name || "").length >= 1 && setShowSuggest(true)} 
                    />
                    
                    {/* åªæœ‰åœ¨ showSuggest ç‚º true ä¸”è¼¸å…¥å­—æ•¸æ»¿è¶³æ¢ä»¶æ™‚æ‰æ¸²æŸ“ */}
                    {(sub.name || "").length >= 1 && showSuggest && (
                        <SpecItemSuggest 
                            currentInput={sub.name} 
                            specItems={specItems} 
                            onSelect={handleSelectSpecItem}
                            onHide={() => setShowSuggest(false)} 
                        />
                    )}
                </div>

                {/* è¦æ ¼ (col-span-2) */}
                <input
                    className="border p-1 rounded col-span-2 focus:ring focus:ring-blue-100" 
                    value={sub.specMain || ""}
                    placeholder="è¦æ ¼ (ä¸»æè¿°)"
                    onChange={(e) => updateField("specMain", e.target.value)}
                />

                {/* å–®ä½ (col-span-1) */}
                <input
                    className="border p-1 rounded col-span-1 text-center focus:ring focus:ring-blue-100"
                    value={sub.unit || ""}
                    placeholder="å–®ä½"
                    onChange={(e) => updateField("unit", e.target.value)}
                />

                {/* æ•¸é‡ (col-span-1) */}
                <input
                    className="border p-1 rounded col-span-1 text-right focus:ring focus:ring-blue-100"
                    value={sub.qty || ""}
                    placeholder="æ•¸é‡"
                    type="number"
                    min="0"
                    onChange={(e) => handleNumberChange("qty", e.target.value)}
                />

                {/* å–®åƒ¹ (col-span-1) */}
                <input
                    className="border p-1 rounded col-span-1 text-right focus:ring focus:ring-blue-100" 
                    value={sub.price || ""}
                    placeholder="å–®åƒ¹"
                    type="number"
                    min="0"
                    onChange={(e) => handleNumberChange("price", e.target.value)}
                />

                {/* å‚™è¨» (col-span-2) - NEW */}
                <input
                    className="border p-1 rounded col-span-2 focus:ring focus:ring-blue-100"
                    value={sub.remarks || ""}
                    placeholder="å‚™è¨»"
                    onChange={(e) => updateField("remarks", e.target.value)}
                />

                {/* å°è¨ˆ (col-span-1) */}
                <div className="col-span-1 text-right font-bold text-blue-600">
                    {subtotal}
                </div>
            </div>

            {/* ğŸ¯ ç”¨æ–™æ˜ç´°å°ˆå±¬é¡¯ç¤ºå€ */}
            {(sub.specMaterial || "").length > 0 && (
                <div className="mt-1 ml-4 text-xs text-gray-500 italic border-t pt-1">
                    **ç”¨æ–™æ˜ç´°**: {sub.specMaterial}
                </div>
            )}
        </div>
    );
}


// P4-3ï¼ˆCï¼‰ImageSubItemBlock â€” åœ–ç‰‡å°é …
function ImageSubItemBlock({ sub, updateField, deleteSubItem }) {
    // åœ–ç‰‡ä¸Šå‚³è™•ç†
    function handleUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => updateField("src", reader.result);
        reader.readAsDataURL(file);
        e.target.value = ''; // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥ï¼Œä»¥ä¾¿é‡æ–°é¸æ“‡åŒä¸€æª”æ¡ˆ
    }

    return (
        <div className="border rounded p-3 bg-gray-50 mb-2">

            <div className="flex justify-between items-center mb-2">
                <span className="text-sm font-bold text-gray-700">ğŸ“· åœ–ç‰‡è£œå……</span>
                <button className="text-red-600 text-sm hover:text-red-800" onClick={deleteSubItem}>åˆªé™¤</button>
            </div>

            {/*åœ–ç‰‡é è¦½*/}
            {sub.src ? (
                <img src={sub.src} className="max-w-xs mb-2 border rounded shadow" alt="é è¦½åœ–" />
            ) : (
                <div className="text-gray-500 text-sm mb-2 p-2 border border-dashed rounded bg-white">å°šæœªä¸Šå‚³åœ–ç‰‡</div>
            )}

            {/* ä¸Šå‚³æŒ‰éˆ• */}
            <label className="cursor-pointer text-blue-700 underline text-sm hover:text-blue-900">
                {sub.src ? "æ›´æ›åœ–ç‰‡" : "ä¸Šå‚³åœ–ç‰‡"}
                <input type="file" accept="image/*" className="hidden" onChange={handleUpload} />
            </label>
        </div>
    );
}


// P4-3ï¼ˆDï¼‰UploadImageButton â€” åœ¨åº•éƒ¨æ–°å¢åœ–ç‰‡ç”¨
function UploadImageButton({ onUpload }) {
    // åœ–ç‰‡ä¸Šå‚³è™•ç† 
    function handleSelect(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => onUpload(reader.result);
        reader.readAsDataURL(file);
        e.target.value = ''; // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥ï¼Œä»¥ä¾¿é‡æ–°é¸æ“‡åŒä¸€æª”æ¡ˆ
    }

    return (
        <label className="cursor-pointer text-blue-600 hover:text-blue-800 transition">
            ï¼‹è£œå……åœ–ç‰‡
            <input type="file" accept="image/*" className="hidden" onChange={handleSelect} />
        </label>
    );
}


// P4-3ï¼ˆEï¼‰SubItemWrapper â€” è‡ªå‹•åˆ†æµå°é …é¡å‹
function SubItemWrapper({ subItem, parentItem, quote, updateQuote }) {

    // æ›´æ–°æŸå€‹ subItem çš„ç‰¹å®šæ¬„ä½ 
    const updateField = React.useCallback((field, value) => {
        const newItems = quote.items.map(m =>
            m.id === parentItem.id
                ? {
                    ...m,
                    // ç¢ºä¿ subItems å­˜åœ¨
                    subItems: (m.subItems || []).map(s =>
                        s.id === subItem.id ? { ...s, [field]: value } : s
                    )
                }
                : m
        );
        updateQuote(quote.id, { items: newItems });
    }, [quote.id, parentItem.id, subItem.id, quote.items, updateQuote]);

    // åˆªé™¤ subItem 
    const deleteSubItem = React.useCallback(() => {
        const newItems = quote.items.map(m =>
            m.id === parentItem.id
                ? { ...m, subItems: (m.subItems || []).filter(s => s.id !== subItem.id) }
                : m
        );
        updateQuote(quote.id, { items: newItems });
    }, [quote.id, parentItem.id, subItem.id, quote.items, updateQuote]);

    const props = { sub: subItem, updateField, deleteSubItem };

    if (subItem.type === "note") return <NoteSubItemBlock {...props} />;
    if (subItem.type === "item") return <ItemSubItemBlock {...props} />;
    if (subItem.type === "image") return <ImageSubItemBlock {...props} />;

    return null;
}


// P4-3ï¼ˆFï¼‰MainItemBlock â€” å¤§é …ç·¨è¼¯ 
function MainItemBlock({ item, quote, updateQuote, index }) { // æ¥æ”¶ index å±¬æ€§
    const { specItems } = React.useContext(AppContext);
    
    // è¦æ ¼å“æ¬„ä½çµæ§‹ - **V10 ä¿®æ­£: çµ±ä¸€ä½¿ç”¨ Google Sheet æ¬„ä½åç¨±**
    const FIELD_MAIN_SPEC = 'å“é …èªªæ˜'; // ğŸ¯ ä¿®æ­£: 'è¦æ ¼' -> 'å“é …èªªæ˜'
    const FIELD_MATERIAL_1 = 'è¦æ ¼1';   // ğŸ¯ ä¿®æ­£: 'ç”¨æ–™1' -> 'è¦æ ¼1'
    const FIELD_MATERIAL_2 = 'è¦æ ¼2';   // ğŸ¯ ä¿®æ­£: 'ç”¨æ–™2' -> 'è¦æ ¼2'
    const FIELD_MATERIAL_3 = 'è¦æ ¼3';   // ğŸ¯ ä¿®æ­£: 'ç”¨æ–™3' -> 'è¦æ ¼3'
    const FIELD_REMARKS = 'å‚™è¨»';       // å‚™è¨»æ¬„ä½

    const [showSuggest, setShowSuggest] = React.useState(false); 

    // 1. æ›´æ–°å¤§é …è³‡æ–™ 
    const update = React.useCallback((data) => {
        const newItems = quote.items.map(m =>
            m.id === item.id ? { ...m, ...data } : m
        );
        updateQuote(quote.id, { items: newItems });
    }, [quote.id, item.id, quote.items, updateQuote]);

    // 2. è™•ç†æ•¸å­—è¼¸å…¥ 
    const handleNumberChange = React.useCallback((field, value) => {
        if (value === "" || !isNaN(Number(value))) {
            update({ [field]: value });
        }
    }, [update]);

    // 3. åˆªé™¤å¤§é … 
    const deleteMain = React.useCallback(() => {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å¤§é …ï¼Ÿ")) return;
        updateQuote(quote.id, { items: quote.items.filter(m => m.id !== item.id) });
    }, [quote.id, item.id, quote.items, updateQuote]);

    // 4. æ–°å¢å°é … 
    const addSub = React.useCallback((type, src = "") => {
        const newSub = {
            id: uuid(),
            type,
            text: "",
            name: "",
            // å­é …ç›®è¦æ ¼æ¬„ä½
            specMain: "", 
            specMaterial: "",
            remarks: "",
            unit: "",
            qty: "",
            price: "",
            src
        };

        const newItems = quote.items.map(m =>
            m.id === item.id ? { ...m, subItems: [...(m.subItems || []), newSub] } : m
        );

        updateQuote(quote.id, { items: newItems });
    }, [quote.id, item.id, quote.items, updateQuote]);

    // ğŸ¯ è™•ç†è¦æ ¼å“é¸æ“‡ (ä¿®æ­£å‚™è¨»/ç”¨æ–™æ˜ç´°æ··æ·†å•é¡Œ)
    const handleSelectSpecItem = React.useCallback((spec) => {
        
        // ğŸ¯ ä¿®æ­£é» 1: ç”¨æ–™æ˜ç´° - ç¢ºä¿åªåˆä½µ 'è¦æ ¼1', 'è¦æ ¼2', 'è¦æ ¼3' ä¸”æ¿¾é™¤ç©ºå€¼
        const materialParts = [
            spec[FIELD_MATERIAL_1] || '',
            spec[FIELD_MATERIAL_2] || '',
            spec[FIELD_MATERIAL_3] || ''
        ].filter(p => p.trim() !== ''); 

        const materialSpec = materialParts.join(' / ').trim(); 

        // å¾è¦æ ¼å“æ•¸æ“šè‡ªå‹•å¡«å…¥è¦æ ¼ã€å–®ä½ã€å–®åƒ¹
        update({
            name: spec['å“å'] || item.name,
            
            // è³‡æ–™æ‹†åˆ†ç²¾ç¢ºå°æ‡‰æ¬„ä½
            specMain: spec[FIELD_MAIN_SPEC] || "", // ä¸»è¦æ ¼ (å“é …èªªæ˜)
            specMaterial: materialSpec, // ç”¨æ–™ 1 2 3 åˆä½µ (ç”¨æ–¼é¡¯ç¤º)
            
            // ğŸ¯ ä¿®æ­£é» 2: å‚™è¨» - ç¢ºä¿ä½¿ç”¨è¦æ ¼å“è¡¨æ ¼ä¸­çš„ 'å‚™è¨»' æ¬„ä½
            remarks: spec[FIELD_REMARKS] || "", // å‚™è¨» (å›æ­¸å ±åƒ¹å–®å‚™è¨»æ¬„)
            
            unit: spec['å–®ä½'] || item.unit,
            price: spec['å–®åƒ¹'] || "", 
        });
        setShowSuggest(false);
    }, [update, item.name, item.unit, FIELD_MAIN_SPEC, FIELD_MATERIAL_1, FIELD_MATERIAL_2, FIELD_MATERIAL_3, FIELD_REMARKS]);

    const mainTotal = formatMoney(calcAmount(item));

    return (
        <div className="border rounded p-4 bg-white shadow mb-4">

            {/* VVVV æ¨™é¡Œè¡Œ VVVV */}
            {/* 3 (å“å) | 2 (è¦æ ¼) | 1 (å–®ä½) | 1 (æ•¸é‡) | 1 (å–®åƒ¹) | 2 (å‚™è¨») | 1 (å°è¨ˆ) | 1 (åˆªé™¤) = 12 columns */}
            <div className="grid grid-cols-12 gap-2 text-sm font-bold text-gray-600 mb-2 border-b pb-1">
                <div className="col-span-3 text-left flex items-center">
                    <span className="mr-1 text-red-500">({index})</span> å“å
                </div>
                <div className="col-span-2 text-left">è¦æ ¼ (ä¸»æè¿°)</div> 
                <div className="col-span-1 text-center">å–®ä½</div>
                <div className="col-span-1 text-right">æ•¸é‡</div>
                <div className="col-span-1 text-right">å–®åƒ¹</div> 
                <div className="col-span-2 text-left">å‚™è¨»</div> 
                <div className="col-span-1 text-right">å°è¨ˆ</div> 
                <div className="col-span-1"></div>
            </div>

            {/* å¤§é …è³‡æ–™åˆ— */}
            <div className="grid grid-cols-12 gap-2 items-center">
                {/* å“å (col-span-3) - **ä½¿ç”¨ SpecItemSuggest** */}
                <div className="col-span-3 relative">
                    <input className="border p-1 rounded w-full focus:ring focus:ring-red-100 text-left"
                        value={item.name || ""} placeholder="å“å"
                        onChange={(e) => {
                            update({ name: e.target.value });
                            setShowSuggest(true);
                        }} 
                        onBlur={() => {
                            // å»¶é²éš±è—ï¼Œçµ¦äºˆæ™‚é–“é»æ“Šå»ºè­°åˆ—è¡¨
                            setTimeout(() => setShowSuggest(false), 200); 
                        }}
                        onFocus={() => {
                            if ((item.name || "").length >= 1) { 
                                setShowSuggest(true);
                            }
                        }}
                    />
                    
                    {(item.name || "").length >= 1 && showSuggest && (
                        <SpecItemSuggest 
                            currentInput={item.name} 
                            specItems={specItems} 
                            onSelect={handleSelectSpecItem}
                            onHide={() => setShowSuggest(false)} 
                        />
                    )}
                </div>
                {/* è¦æ ¼ (col-span-2) - ä½¿ç”¨ item.specMain */}
                <input className="border p-1 rounded col-span-2 focus:ring focus:ring-red-100 text-left"
                    value={item.specMain || ""} placeholder="è¦æ ¼ (ä¸»æè¿°)"
                    onChange={(e) => update({ specMain: e.target.value })} />
                {/* å–®ä½ (col-span-1) */}
                <input className="border p-1 rounded col-span-1 text-center focus:ring focus:ring-red-100"
                    value={item.unit || ""} placeholder="å–®ä½"
                    onChange={(e) => update({ unit: e.target.value })} />
                {/* æ•¸é‡ (col-span-1) */}
                <input className="border p-1 rounded col-span-1 text-right focus:ring focus:ring-red-100"
                    value={item.qty || ""} placeholder="æ•¸é‡"
                    type="number" min="0"
                    onChange={(e) => handleNumberChange("qty", e.target.value)} />
                {/* å–®åƒ¹ (col-span-1) */}
                <input className="border p-1 rounded col-span-1 text-right focus:ring focus:ring-red-100"
                    value={item.price || ""} placeholder="å–®åƒ¹"
                    type="number" min="0"
                    onChange={(e) => handleNumberChange("price", e.target.value)} />
                
                {/* å‚™è¨» (col-span-2) - ğŸ¯ ä½¿ç”¨ item.remarks */}
                <input className="border p-1 rounded col-span-2 focus:ring focus:ring-red-100 text-left"
                    value={item.remarks || ""} placeholder="å‚™è¨»"
                    onChange={(e) => update({ remarks: e.target.value })} />

                {/* å°è¨ˆ (col-span-1) */}
                <div className="text-right font-bold col-span-1 text-red-700">
                    {mainTotal}
                </div>
                {/* åˆªé™¤æŒ‰éˆ• (col-span-1) */}
                <button className="text-red-600 col-span-1 text-sm hover:text-red-800" onClick={deleteMain}>
                    âœ•
                </button>
            </div>
            
            {/* ğŸ¯ ç”¨æ–™æ˜ç´°å°ˆå±¬é¡¯ç¤ºå€ */}
            {(item.specMaterial || "").length > 0 && (
                <div className="mt-1 ml-4 text-xs text-gray-500 italic border-t pt-1">
                    **ç”¨æ–™æ˜ç´°**: {item.specMaterial}
                </div>
            )}

            {/* å°é …åˆ—è¡¨ */}
            <div className="mt-3 border-t pt-3">
                {(item.subItems || []).map(sub => (
                    <SubItemWrapper
                        key={sub.id} 
                        subItem={sub}
                        parentItem={item}
                        quote={quote}
                        updateQuote={updateQuote}
                    />
                ))}
            </div>

            {/* æ“ä½œåˆ— */}
            <div className="flex gap-4 mt-3 text-blue-600 text-sm border-t pt-3">
                <button className="hover:text-blue-800 transition" onClick={() => addSub("item")}>ï¼‹ å­é …ç›®</button>
                <button className="hover:text-blue-800 transition" onClick={() => addSub("note")}>ï¼‹ è£œå……æ–‡å­—</button>
                <UploadImageButton onUpload={(src) => addSub("image", src)} />
            </div>
        </div>
    );
}
// P4-3ï¼ˆGï¼‰ItemsEditor â€” æ•´é«”å“é …ç®¡ç†
function ItemsEditor({ quote, updateQuote }) {
    // 1. æ–°å¢å¤§é … 
    const addMain = React.useCallback(() => {
        const newMain = {
            id: uuid(),
            type: "main",
            name: "", 
            // åˆå§‹åŒ–è¦æ ¼æ¬„ä½
            specMain: "", 
            specMaterial: "",
            remarks: "",
            unit: "",
            qty: "",
            price: "",
            subItems: []
        };
        updateQuote(quote.id, { items: [...(quote.items || []), newMain] });
    }, [quote.id, quote.items, updateQuote]);

    // ç¯©é¸å‡ºæ‰€æœ‰å¤§é …
    const mainItems = (quote.items || []).filter(item => item.type === "main");

    return (
        <div className="mb-6 no-print">
            <h2 className="font-bold text-lg mb-2">å ±åƒ¹é …ç›®åˆ—è¡¨</h2>
            
            <button
                className="px-4 py-2 bg-blue-600 text-white rounded mb-4 hover:bg-blue-700 transition"
                onClick={addMain}
            >
                ï¼‹ æ–°å¢å·¥ç¨‹å¤§é …
            </button>
            
            {/* æ¸²æŸ“æ‰€æœ‰å¤§é …ï¼Œä¸¦å‚³é index */}
            {mainItems.map((item, index) => (
                <MainItemBlock
                    key={item.id}
                    item={item}
                    quote={quote}
                    updateQuote={updateQuote}
                    index={index + 1} // å‚³éå¾ 1 é–‹å§‹çš„ç·¨è™Ÿ
                />
            ))}

            {mainItems.length === 0 && (
                <div className="text-gray-500 text-sm text-center p-4 border border-dashed rounded">
                    é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ–°å¢å ±åƒ¹é …ç›®
                </div>
            )}
        </div>
    );
}

// P5-1 â€” NotesEditorï¼ˆå‚™è¨»èªªæ˜ï¼‰
function NotesEditor({ quote, update }) {
    return (
        <div className="bg-white p-4 shadow rounded h-full flex flex-col">
            <h3 className="font-bold mb-2">å‚™è¨»èªªæ˜ (ä¸å«ç¨…)</h3>
            <textarea
                className="w-full border rounded p-2 text-sm flex-1 whitespace-pre-wrap"
                rows="10"
                value={quote.notes || ""}
                onChange={(e) => update("notes", e.target.value)}
                placeholder="è¼¸å…¥å‚™è¨»èªªæ˜..."
            />
        </div>
    );
}

// P5-2 â€” PaymentEditorï¼ˆä»˜æ¬¾æ¢ä»¶ï¼‰
function PaymentEditor({ quote, update }) {
    return (
        <div className="bg-white p-4 shadow rounded h-full flex flex-col">
            <h3 className="font-bold mb-2">ä»˜æ¬¾æ¢ä»¶ (æœªå«ç¨…)</h3>
            <textarea
                className="w-full border rounded p-2 text-sm flex-1 whitespace-pre-wrap"
                rows="10"
                value={quote.payment || ""}
                onChange={(e) => update("payment", e.target.value)}
                placeholder="è¼¸å…¥ä»˜æ¬¾æ¢ä»¶..."
            />
        </div>
    );
}

// P5-3 â€” PriceSummaryï¼ˆç¸½åƒ¹æ‘˜è¦ï¼‰
function PriceSummary({ quote, update }) {
    // è¨ˆç®—ç¸½é‡‘é¡
    const total = calcTotal(quote.items || []);
    // è¨ˆç®—è­°å®šå¾Œåƒ¹æ ¼
    const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

    // è™•ç†æ•¸å­—è¼¸å…¥
    const handleNumberChange = React.useCallback((field, value) => {
        if (value === "" || !isNaN(Number(value))) {
            update(quote.id, { [field]: value });
        }
    }, [quote.id, update]);

    return (
        <div className="bg-white p-4 shadow rounded">
            <h3 className="font-bold mb-3">ç¸½åƒ¹æ‘˜è¦</h3>

            {/* ç¸½é¡ (æœªç¨…) */}
            <div className="flex justify-between items-center mb-2 p-2 border-b">
                <span className="text-gray-600">ç¸½é‡‘é¡ (æœªç¨…)</span>
                <span className="font-bold text-lg text-green-700">
                    {formatMoney(total)}
                </span>
                
            </div>

            {/* æŠ˜æ‰£ç™¾åˆ†æ¯” */}
            <div className="flex items-center mb-2">
                <label className="text-gray-600 w-24">æŠ˜æ‰£ (%)</label>
                <input
                    type="number"
                    className="w-20 border rounded px-2 py-1 text-right focus:ring-2 focus:ring-blue-300"
                    min="0"
                    max="100"
                    value={quote.discountPercent || ""}
                    onChange={(e) => handleNumberChange("discountPercent", e.target.value)}
                />
                <span className="ml-2 text-sm text-gray-500"> (è¼¸å…¥ 10 å³æ‰“ä¹æŠ˜)</span>
            </div>
            
            {/* è­°å®šåƒ¹æ ¼ (å¯è¦†è“‹æŠ˜æ‰£) */}
            <div className="flex items-center mb-4">
                <label className="text-gray-600 w-24">è­°å®šåƒ¹æ ¼</label>
                <input
                    type="number"
                    className="flex-1 border rounded px-2 py-1 text-right focus:ring-2 focus:ring-blue-300"
                    min="0"
                    value={quote.negotiatedPrice || ""}
                    onChange={(e) => handleNumberChange("negotiatedPrice", e.target.value)}
                />
            </div>

            {/* æœ€çµ‚åƒ¹æ ¼ (æœªç¨…) */}
            <div className="flex justify-between items-center p-3 rounded bg-blue-50 border border-blue-200">
                <span className="text-blue-800 font-semibold">æœ€çµ‚å ±åƒ¹ (æœªç¨…)</span>
                <span className="font-extrabold text-xl text-blue-800">
                    {formatMoney(negotiated)}
                </span>
            </div>
        </div>
    );
}

// P6 â€” Excel åŒ¯å‡ºåŠŸèƒ½
function exportToExcel(quote, companyInfo) {
    
    if (!quote) {
        alert("è«‹å…ˆé¸æ“‡æˆ–å»ºç«‹ä¸€ä»½å ±åƒ¹å–®ã€‚");
        return;
    }

    const total = calcTotal(quote.items || []);
    const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

    // Excel è¡¨é ­
    const header = [
        "é …æ¬¡", "å“å", "è¦æ ¼ (ä¸»æè¿°)", "ç”¨æ–™æ˜ç´°", "å–®ä½", "æ•¸é‡", "å–®åƒ¹", "é‡‘é¡", "å‚™è¨»" 
    ];

    const data = [];
    let itemIndex = 1;

    (quote.items || []).forEach(item => {
        // è™•ç†å¤§é …
        data.push([
            itemIndex++,
            item.name || "",
            item.specMain || "", // ä¸»è¦æ ¼
            item.specMaterial || "", // ç”¨æ–™æ˜ç´° (åˆä½µ 1, 2, 3)
            item.unit || "",
            Number(item.qty) || "",
            Number(item.price) || "",
            calcAmount(item),
            item.remarks || "" // å‚™è¨»
        ]);

        // è™•ç†å­é …
        (item.subItems || []).forEach(sub => {
            if (sub.type === 'item') {
                data.push([
                    "", 
                    ` â†³ ${sub.name || ""}`, 
                    sub.specMain || "", // ä¸»è¦æ ¼
                    sub.specMaterial || "", // ç”¨æ–™æ˜ç´°
                    sub.unit || "",
                    Number(sub.qty) || "",
                    Number(sub.price) || "",
                    calcAmount(sub),
                    sub.remarks || "" // å‚™è¨»
                ]);
            } else if (sub.type === 'note' && sub.text) {
                // èª¿æ•´ note çš„æ¬„ä½æ•¸é‡ç‚º 9
                data.push([
                    "",
                    `å‚™è¨»ï¼š${sub.text}`, 
                    "", "", "", "", "", "", "", 
                ]);
            }
        });
    });


    // æ§‹é€ æœ€çµ‚å·¥ä½œè¡¨æ•¸æ“š
    const sheetData = [
        [companyInfo.name, "å·¥ç¨‹å ±åƒ¹å–®"],
        ["å·¥ç¨‹åç¨±:", quote.title || ""],
        ["å®¢æˆ¶åç¨±:", quote.customerName || ""],
        ["è¯çµ¡äºº:", quote.contact || ""],
        ["é›»è©±:", quote.phone || ""],
        ["å ±åƒ¹æ—¥æœŸ:", quote.date || ""],
        ["å·¥ç¨‹åœ°é»:", quote.location || ""],
        [],
        header, // é …ç›®è¡¨æ ¼è¡¨é ­
        ...data, // é …ç›®è¡¨æ ¼å…§å®¹
        [],
        ["ç¸½é‡‘é¡ (æœªç¨…)", "", "", "", "", "", "", total], 
        ["æŠ˜æ‰£ (%)", quote.discountPercent || 0, "", "è­°å®šåƒ¹æ ¼ (æœªç¨…)", negotiated],
        ["æœ€çµ‚å ±åƒ¹ (æœªç¨…)", negotiated],
        [],
        ["å‚™è¨»èªªæ˜", quote.notes || ""],
        ["ä»˜æ¬¾æ¢ä»¶", quote.payment || ""]
    ];

    const ws = XLSX.utils.aoa_to_sheet(sheetData);

    // --- è¨­ç½®æ¬„ä½å¯¬åº¦ (å¯é¸) ---
    const wscols = [
        { wch: 6 }, { wch: 30 }, { wch: 20 }, { wch: 30 }, { wch: 8 }, 
        { wch: 8 }, { wch: 12 }, { wch: 15 }, { wch: 15 } // 9 columns
    ];
    ws['!cols'] = wscols;

    // --- è¨­ç½®å–®å…ƒæ ¼æ ¼å¼ (å¯é¸) ---
    for (let i = 0; i < data.length; i++) {
        const rowIndex = i + 10; 
        const cellAddress = 'H' + rowIndex; // é‡‘é¡æ¬„ä½æ˜¯ç¬¬ 8 æ¬„
        const cell = ws[cellAddress];
        
        if (cell && cell.v !== "") {
            cell.t = 'n'; 
            cell.z = "#,##0"; 
        }
    }

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å–®å…§å®¹");

    const fileName = `${quote.quoteNo}_${quote.customerName || 'å®¢æˆ¶'}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    console.log(`Excel åŒ¯å‡ºæˆåŠŸ: ${fileName}`);
}

// Excel åŒ¯å‡ºæŒ‰éˆ•å…ƒä»¶
function ExcelExporter() {
    const { activeQuote, company } = React.useContext(AppContext);
    const companyInfo = COMPANY_DATA[company];
    
    const handleExport = React.useCallback(() => {
        exportToExcel(activeQuote, companyInfo);
    }, [activeQuote, companyInfo]);


    return (
        <button 
            className="w-full px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition shadow-md no-print"
            onClick={handleExport}
            disabled={!activeQuote}
        >
            â¬‡ï¸ åŒ¯å‡º Excel (XLSX)
        </button>
    );
}

// P7 â€” åˆ—å°åŠŸèƒ½ (ä¿®æ­£)
function PrintButton() {
    const { activeQuote } = React.useContext(AppContext);
    
    // åˆ—å°æ™‚ç›´æ¥é‡å° #quotePreviewArea é€²è¡Œåˆ—å°
    const handlePrint = React.useCallback(() => {
        if (!activeQuote) {
            alert("è«‹å…ˆé¸æ“‡æˆ–å»ºç«‹ä¸€ä»½å ±åƒ¹å–®ã€‚");
            return;
        }
        
        const previewArea = document.getElementById('quotePreviewArea');
        // ğŸ¯ é—œéµä¿®æ­£ 2: æª¢æŸ¥é è¦½å€æ˜¯å¦å·²è¢«éœæ…‹æ¸²æŸ“ï¼Œé˜²æ­¢ç©ºç™½åˆ—å°
        if (!previewArea || previewArea.innerHTML.includes('PrintLayout Component')) {
             alert("å ±åƒ¹å–®é è¦½å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å€™å¹¾ç§’å†è©¦ä¸€æ¬¡ã€‚");
             // å¯ä»¥é¸æ“‡åœ¨é€™é‚Šå†æ¬¡å˜—è©¦æ¸²æŸ“ (éåŒæ­¥)
             if (typeof ReactDOMServer !== 'undefined' && typeof ReactDOMServer.renderToString === 'function') {
                const html = ReactDOMServer.renderToString(<PrintLayout quote={activeQuote} />);
                previewArea.innerHTML = html;
                setTimeout(() => window.print(), 100); // å»¶é²åˆ—å°
             }
             return;
        }
        
        window.print();
        
    }, [activeQuote]);


    return (
        <button 
            className="w-full px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition shadow-md no-print mb-4"
            onClick={handlePrint}
            disabled={!activeQuote}
        >
            ğŸ–¨ï¸ åˆ—å°å ±åƒ¹å–®
        </button>
    );
}

// å ±åƒ¹å–®é …ç›®åˆ—å°å…ƒä»¶ (ç”¨æ–¼ PrintLayout)
function PrintItemRow({ item, index, isSub = false }) {
    
    const amount = calcAmount(item);
    
    // è™•ç† Note/Image å­é …
    if (item.type === 'note' && item.text) {
        // è£œå……æ–‡å­—
        return (
            <tr className="page-break-inside-avoid">
                <td colSpan="7" style={{ borderTop: 'none', padding: '0 6px 4px 6px', fontWeight: 'normal', color: '#333' }}>
                    <span style={{ fontWeight: 'bold' }}>è£œå……èªªæ˜:</span> <span style={{ whiteSpace: 'pre-wrap' }}>{item.text}</span>
                </td>
            </tr>
        );
    } else if (item.type === 'image' && item.src) {
        // åœ–ç‰‡
        return (
            <tr className="page-break-inside-avoid">
                <td colSpan="7" style={{ borderTop: 'none', padding: '4px 6px 0 6px' }}>
                    <img src={item.src} alt="å·¥ç¨‹åœ–ç‰‡" className="print-image" />
                </td>
            </tr>
        );
    }
    
    // æ¨™æº–å¤§é …æˆ–å­é …ç›®
    const namePrefix = isSub ? ' â†³ ' : '';
    
    const itemContent = item.name || '';
    const mainSpecContent = (item.specMain && item.specMain.trim() !== '') 
                            ? ` (${item.specMain})` : '';
    // ğŸ¯ ç”¨æ–™æ˜ç´°å°ˆé–€ç”¨æ–¼å­è¡Œé¡¯ç¤º (åœ¨ä¸‹ä¸€è¡Œ tr é¡¯ç¤º)
    const materialSpecContent = (item.specMaterial && item.specMaterial.trim() !== '') 
                                ? item.specMaterial : '';
    
    return (
        <React.Fragment>
            {/* ä¸»è¦è¡Œï¼šå“å, è¦æ ¼, å–®ä½, æ•¸é‡, å–®åƒ¹, å‚™è¨», é‡‘é¡ */}
            <tr className={!isSub ? "font-bold page-break-inside-avoid" : "page-break-inside-avoid"}>
                <td style={{ width: '5%', textAlign: 'center' }}>{isSub ? '' : index}</td>
                {/* ğŸ¯ ç¬¬äºŒæ¬„ï¼šåªé¡¯ç¤º å“å + è¦æ ¼ (ä¸»æè¿°) */}
                <td style={{ width: '45%' }}> 
                    {namePrefix}{itemContent}{mainSpecContent}
                </td>
                
                <td style={{ width: '8%', textAlign: 'center' }}>{item.unit || ''}</td>
                <td style={{ width: '8%', textAlign: 'right' }}>{item.qty || ''}</td>
                <td style={{ width: '10%', textAlign: 'right' }}>{formatMoney(item.price)}</td> 
                
                {/* ğŸ¯ å‚™è¨»æ¬„ä½ - é¡¯ç¤º item.remarks */}
                <td style={{ width: '10%' }}>{item.remarks || ''}</td> 

                <td style={{ width: '14%', textAlign: 'right' }}>{formatMoney(amount)}</td> 
            </tr>
            
            {/* ğŸ¯ å¦‚æœæœ‰ç”¨æ–™æ˜ç´°ï¼Œåœ¨ä¸‹ä¸€è¡Œä»¥å­è¡Œæ–¹å¼é¡¯ç¤ºï¼Œä¸¦åˆä½µå„²å­˜æ ¼ */}
            {materialSpecContent && (
                <tr className="page-break-inside-avoid">
                    <td style={{ borderTop: 'none' }}></td> {/* é …æ¬¡ç•™ç©º */}
                    {/* ç”¨æ–™æ˜ç´°åˆä½µå„²å­˜æ ¼ (å¾ç¬¬äºŒæ¬„åˆ°å€’æ•¸ç¬¬äºŒæ¬„ï¼Œå…± 5 æ¬„) */}
                    <td colSpan="5" style={{ fontSize: '12px', fontWeight: 'normal', color: '#555', padding: '0 6px 4px 10px', borderTop: 'none' }}>
                         **ç”¨æ–™æ˜ç´°**: {materialSpecContent}
                    </td>
                    <td style={{ borderTop: 'none' }}></td> {/* å‚™è¨»ç•™ç©º */}
                    <td style={{ borderTop: 'none' }}></td> {/* é‡‘é¡ç•™ç©º */}
                </tr>
            )}
            
            {/* éæ­¸è™•ç† item é¡å‹çš„å­é …ç›® */}
            {!isSub && (item.subItems || []).filter(s => s.type === 'item').map((sub, subIndex) => (
                <PrintItemRow key={sub.id} item={sub} index={subIndex} isSub={true} />
            ))}
            
            {/* è™•ç†é item é¡å‹çš„å­é …ç›® (æ–‡å­—/åœ–ç‰‡) */}
            {!isSub && (item.subItems || []).filter(s => s.type !== 'item').map((sub, subIndex) => (
                <PrintItemRow key={sub.id} item={sub} index={subIndex} isSub={true} />
            ))}
            
        </React.Fragment>
    );
}

// å®Œæ•´åˆ—å°ç‰ˆé¢ (React Component)
const PrintLayout = ({ quote }) => {
    // ç¢ºä¿ window.__APP_CONTEXT__ å­˜åœ¨ï¼Œç”¨æ–¼åˆ—å°æ™‚ç²å– company
    const context = window.__APP_CONTEXT__ || {};
    const company = context.company || 'herhsin';
    const info = COMPANY_DATA[company]; 

    const total = calcTotal(quote.items || []);
    const negotiated = calcNegotiated(total, quote.discountPercent, quote.negotiatedPrice);

    let mainItemIndex = 1;

    return (
        <div className="print-page">
            {/* æ¨™é¡Œå€ */}
            <div className="print-header mb-4">
                <h1 className="mb-2">{info.name} - å·¥ç¨‹å ±åƒ¹å–®</h1>
            </div>

            {/* å…¬å¸/å®¢æˆ¶è³‡è¨Šè¡¨æ ¼ */}
            <table className="print-info-table">
                <tbody>
                    <tr>
                        <td className="print-info-label">å®¢æˆ¶åç¨±</td>
                        <td>{quote.customerName || 'N/A'}</td>
                        <td className="print-info-label">è¯çµ¡äºº</td>
                        <td>{quote.contact || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td className="print-info-label">å·¥ç¨‹åç¨±</td>
                        <td colSpan="3">{quote.title || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td className="print-info-label">å·¥ç¨‹åœ°é»</td>
                        <td colSpan="3">{quote.location || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td className="print-info-label">å ±åƒ¹æ—¥æœŸ</td>
                        <td>{quote.date || formatDate()}</td>
                        <td className="print-info-label">å ±åƒ¹ç·¨è™Ÿ</td>
                        <td>{quote.quoteNo || 'N/A'}</td>
                    </tr>
                </tbody>
            </table>

            {/* å ±åƒ¹é …ç›®è¡¨æ ¼ */}
            <table className="print-items-table">
                <thead>
                    <tr>
                        <th style={{ width: '5%' }}>é …æ¬¡</th>
                        {/* ğŸ¯ ç¬¬äºŒæ¬„åŒ…å«å“å/è¦æ ¼/ç”¨æ–™ */}
                        <th style={{ width: '45%' }}>å“å / è¦æ ¼ (ä¸»æè¿°)</th> 
                        <th style={{ width: '8%' }}>å–®ä½</th>
                        <th style={{ width: '8%' }}>æ•¸é‡</th>
                        <th style={{ width: '10%' }}>å–®åƒ¹</th>
                        {/* ğŸ¯ å‚™è¨»ç¨ç«‹ä¸€æ¬„ */}
                        <th style={{ width: '10%' }}>å‚™è¨»</th>
                        <th style={{ width: '14%' }}>é‡‘é¡</th>
                    </tr>
                </thead>
                <tbody>
                    {/* æ¸²æŸ“æ‰€æœ‰å¤§é …å’Œå­é … */}
                    {(quote.items || []).filter(i => i.type === 'main').map(item => (
                        <PrintItemRow key={item.id} item={item} index={mainItemIndex++} isSub={false} />
                    ))}
                </tbody>
            </table>

            {/* ç¸½è¨ˆå€å¡Š */}
            <div className="print-total-box flex justify-between">
                <div style={{ width: '40%' }}>
                    <p className="font-bold mb-1">ç¸½è¨ˆï¼š(æ­¤å ±åƒ¹æœªå«ç¨…)</p>
                    <p>è¨ˆç®—ç¸½é¡: ${formatMoney(total)}</p>
                    {quote.discountPercent > 0 && <p>æŠ˜æ‰£: {quote.discountPercent}%</p>}
                </div>
                <div style={{ width: '60%', textAlign: 'right', borderLeft: '1px solid black', paddingLeft: '10px' }}>
                    <h2 style={{ fontSize: '18px', fontWeight: 'bold', color: '#0056b3' }}>
                        æœ€çµ‚å ±åƒ¹ (æœªç¨…)ï¼šNT$ {formatMoney(negotiated)}
                    </h2>
                </div>
            </div>
            
            {/* å‚™è¨»åŠä»˜æ¬¾æ¢ä»¶ */}
            <div style={{ display: 'flex', marginTop: '15px' }}>
                <div className="print-notes-box" style={{ flex: '1 1 50%', marginRight: '10px' }}>
                    <p className="font-bold mb-1 border-b pb-1">å‚™è¨»èªªæ˜</p>
                    <pre style={{ whiteSpace: 'pre-wrap', fontFamily: 'inherit', margin: 0 }}>
                        {quote.notes || 'ç„¡å‚™è¨»'}
                    </pre>
                </div>
                <div className="print-notes-box" style={{ flex: '1 1 50%' }}>
                    <p className="font-bold mb-1 border-b pb-1">ä»˜æ¬¾æ¢ä»¶</p>
                    <pre style={{ whiteSpace: 'pre-wrap', fontFamily: 'inherit', margin: 0 }}>
                        {quote.payment || 'ç„¡ä»˜æ¬¾æ¢ä»¶'}
                    </pre>
                </div>
            </div>

            {/* ç°½ç« å€ */}
            <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '30px', borderTop: '1px dashed #ccc', paddingTop: '10px', fontSize: '12px' }}>
                <div style={{ width: '45%' }}>
                    **å ±åƒ¹å…¬å¸ (è“‹ç« å€)**
                    <p>{info.name}</p>
                </div>
                <div style={{ width: '45%', borderLeft: '1px dashed #ccc', paddingLeft: '10px' }}>
                    **å®¢æˆ¶ç¢ºèªç°½ç« **
                    <p>æ—¥æœŸ: ________</p>
                </div>
            </div>
        </div>
    );
};

// P8.1 â€” å ±åƒ¹å–®é è¦½å…ƒä»¶ (æ–°å¢)
function QuotePreview() {
    const { activeQuote } = React.useContext(AppContext);

    if (!activeQuote) return null;

    return (
        <div className="mt-8 border-t pt-4 bg-gray-100 p-6 no-print">
            <h2 className="text-xl font-bold mb-4 text-gray-700">ğŸ“„ å³æ™‚å ±åƒ¹å–®é è¦½ (åˆ—å°ç‰ˆé¢)</h2>
            <div id="previewContainer" className="bg-white shadow-xl p-8 max-w-4xl mx-auto border border-gray-300">
                {/* é€™è£¡ç”¨æ–¼å³æ™‚é è¦½ */}
                <PrintLayout quote={activeQuote} />
            </div>
        </div>
    );
}


// P8 â€” Appï¼ˆä¸»è¦ä½ˆå±€ï¼‰
function App() {
    const { activeQuote, updateQuote, activeQuoteId, loadSpecItems } = React.useContext(AppContext);
    
    // ğŸ¯ é—œéµä¿®æ­£ 2: éœæ…‹æ¸²æŸ“ PrintLayout åˆ° #quotePreviewArea
    React.useEffect(() => {
        // ç¢ºä¿ activeQuote å­˜åœ¨
        if (!activeQuote) return; 

        // ç¢ºä¿ ReactDOMServer å·²ç¶“è¼‰å…¥
        if (typeof window.ReactDOMServer !== 'undefined' && typeof window.ReactDOMServer.renderToString === 'function') {
            const html = window.ReactDOMServer.renderToString(<PrintLayout quote={activeQuote} />);
            const previewArea = document.getElementById('quotePreviewArea');
            if (previewArea) {
                // å°‡éœæ…‹ HTML å¯«å…¥ï¼Œç¢ºä¿åˆ—å°æ™‚æ˜¯å®Œæ•´çš„å ±åƒ¹å–®çµæ§‹
                previewArea.innerHTML = html; 
            }
        } else {
            console.warn("ReactDOMServer å°šæœªè¼‰å…¥ï¼Œç„¡æ³•é æ¸²æŸ“åˆ—å°å…§å®¹ã€‚");
        }
        
    }, [activeQuote]);


    // å¦‚æœæ²’æœ‰å ±åƒ¹å–®ï¼Œé¡¯ç¤ºæç¤º
    if (!activeQuoteId) {
        return (
            <div className="flex p-8 max-w-7xl mx-auto">
                <div className="w-80 pr-8">
                    <CompanySelector />
                    <ModeSelector />
                    <QuoteManager />
                </div>
                <div className="flex-1 bg-white p-6 shadow rounded text-center text-gray-500">
                    è«‹å…ˆåœ¨å·¦å´å»ºç«‹æˆ–é¸æ“‡ä¸€ä»½å ±åƒ¹å–®ã€‚
                </div>
            </div>
        );
    }

    return (
        <div className="flex p-8 max-w-7xl mx-auto min-h-screen">
            
            {/* 1. å·¦å´æ¬„ï¼šå ±åƒ¹å–®ç®¡ç† + å·¥å…·æŒ‰éˆ• */}
            <div className="w-80 pr-8 no-print flex-shrink-0">
                <CompanySelector />
                <ModeSelector />

                {/* æ‰‹å‹•æ›´æ–°è¦æ ¼å“æŒ‰éˆ• (æ–°å¢) */}
                <button
                    className="w-full px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition shadow-md no-print mb-4 text-sm"
                    onClick={loadSpecItems}
                >
                    ğŸ”„ é‡æ–°è¼‰å…¥è¦æ ¼å“è³‡æ–™
                </button>


                {/* æ–°å¢ åˆ—å° æŒ‰éˆ• */}
                <PrintButton /> 

                {/* æ–°å¢ Excel åŒ¯å‡ºæŒ‰éˆ• */}
                <div className="mb-4">
                    <ExcelExporter />
                </div>
                
                <QuoteManager />
            </div>

            {/* 2. å³å´æ¬„ï¼šç·¨è¼¯å€ */}
            <div className="flex-1">
                <QuoteEditor />
                <ItemsEditor quote={activeQuote} updateQuote={updateQuote} />

                {/* å‚™è¨»/ä»˜æ¬¾/ç¸½åƒ¹ - ä¿®æ­£ç‚ºç”±ä¸Šå¾€ä¸‹å †ç–Š */}
                <div className="flex flex-col gap-6 no-print">
                    <div className="flex-1">
                        <NotesEditor quote={activeQuote} update={(field, value) => updateQuote(activeQuote.id, { [field]: value })} />
                    </div>
                    <div className="flex-1">
                        <PaymentEditor quote={activeQuote} update={(field, value) => updateQuote(activeQuote.id, { [field]: value })} />
                    </div>
                    <div className="flex-1">
                        <PriceSummary quote={activeQuote} update={updateQuote} />
                    </div>
                </div>
                
                {/* åº•éƒ¨å³æ™‚å ±åƒ¹å–®é è¦½å€ */}
                <QuotePreview />

            </div>
        </div>
    );
}

// P9 â€” Root Render
// å•Ÿå‹•æ¸²æŸ“
function renderApp() {
    const rootElement = document.getElementById("root");
    if (!rootElement) return;

    ReactDOM.createRoot(rootElement).render(
        <AppProvider>
            <App />
        </AppProvider>
    );
}

// å•Ÿå‹•æ¸²æŸ“
renderApp();
</script>

</body>
</html>
